import{r as a,e as U,j as v,s as F}from"./vendor.BL40-5vE.js";import{a as p}from"./index.CFGX7lSC.js";import{c as _}from"./client.DDakgimh.js";const g=a.createContext({user:null,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),b=()=>a.useContext(g),k=(t,l=!0)=>{t?(l&&localStorage.setItem("token",t),_.defaults.headers.common.Authorization=`Bearer ${t}`):(l&&localStorage.removeItem("token"),delete _.defaults.headers.common.Authorization)},z=({children:t})=>{const[l,o]=a.useState(null),[y,h]=a.useState(localStorage.getItem("token")),[r,u]=a.useState(!0),{run:A}=U(async()=>{const s=localStorage.getItem("token");return s?(k(s,!1),p.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:s=>{o(s)},onError:s=>{console.error("Failed to get current user:",s),x()},onFinally:()=>{u(!1)}});a.useEffect(()=>{A()},[]);const T=async s=>{try{const e=await p.authorization.login(s),{token:i,user:n,needs_mfa:f,password_expired:c,mfa_token:m,mfa_type:d}=e;if(f)throw{needsMFA:!0,mfaToken:m,mfaType:d,user:n};if(c)throw{password_expired:!0,user:n,token:i};return k(i),h(i),o(n),n}catch(e){throw e&&e.needsMFA||e&&e.password_expired||F.error("Login failed, please check your username and password"),e}},C=a.useCallback(async s=>{try{const e=await p.oauth.handleCallback(s);let i="",n=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:f,user:c,needs_mfa:m,mfa_token:d,mfa_type:w}=e.data;if(m)throw{needsMFA:!0,mfaToken:d,mfaType:w,user:c};i=f,n=c}else{const{token:f,user:c,needs_mfa:m,mfa_token:d,mfa_type:w}=e;if(m)throw{needsMFA:!0,mfaToken:d,mfaType:w,user:c};i=f,n=c}return k(i),h(i),o(n),n}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),x=()=>{p.authorization.logout(),k(null),h(null),o(null)},P=s=>{o(s)};return v.jsx(g.Provider,{value:{user:l,token:y,loading:r,login:T,oauthLogin:C,logout:x,updateUser:P},children:t})},I=()=>{const t=a.useContext(g);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t},j=()=>{const{user:t}=a.useContext(g),l=()=>!t||!t.roles?!1:t.roles.some(r=>r.name==="admin"),o=r=>!t||!t.roles?!1:l()?!0:t.roles.some(u=>u.permissions?u.permissions.some(A=>A.code===r):!1);return{hasPermission:o,hasAllPermissions:r=>r.every(u=>o(u)),hasAnyPermission:r=>r.some(u=>o(u)),isAdmin:l(),loading:!t}};export{z as A,j as a,b,I as u};
