import{aC as re,aL as ae,b6 as se,u as oe,r as o,q as d,j as e,R as ne,C as ie,V as le,G as B,s as g,b7 as de,aF as ue,b8 as ce,t as q,h as me,K as fe,A as ge,b9 as he,v as C,ba as pe}from"./vendor.MZTBlccq.js";import{u as xe,b as we}from"./contexts.CshjRDVB.js";import{a as $}from"./index.BrPIgwYR.js";import{A as U}from"./client.Dg5rJVxZ.js";import{L as M,a as je,e as ye}from"./components.DQxsXjkm.js";import{m as be,g as _e}from"./base.De0_vyxt.js";import"./vite.BF1G3H_w.js";import"./ai.BF2dfzH9.js";import"./authorization.CzBsDemo.js";import"./system.BIGnZ09Q.js";import"./oauth.B6uu0z-z.js";const{Title:Ve}=le,Oe=({transformLangConfig:D})=>{const f=re(),N=ae(),[n]=se(),{login:V,oauthLogin:L,user:A}=xe(),{t:s,i18n:w}=oe(),[I,i]=o.useState(null),[j,S]=o.useState({}),[u,h]=o.useState("login"),[z,G]=o.useState(null),[y,K]=o.useState(null),[c,W]=o.useState(null),[p]=d.useForm(),k=o.useRef(!1),[X,v]=o.useState(!1),[T,F]=o.useState([]),[b,_]=o.useState(0),{siteConfig:a,loading:Y,error:x}=we(),[H,P]=o.useState("Loading..."),E=async r=>{const l=async t=>"username"in t?await V({username:t.username,password:t.password}):"mfa_token"in t?await V({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await L({code:t.code,state:t.state,provider:t.provider});try{v(!0);const t=await l(r);if(he(),await new Promise(m=>setTimeout(m,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&N.pathname!=="/profile")f("/profile#mfa");else{const m=n.get("redirect");m?window.location.href=m:a!=null&&a.home_page?window.location.href=a.home_page:f("/")}}catch(t){if(t.password_expired)h("password_expired"),G(t.token),i(null);else if(t.needsMFA)i(null),h("mfa"),f("/login",{replace:!0}),K(t.mfaType),W(t.user),p.setFieldValue("mfa_token",t.mfaToken);else if("username"in r||"mfa_token"in r)if(t instanceof U?i(s("login.error",{defaultValue:"Login failed: {{error}}",error:s(`login.${t}`,{defaultValue:t.message})})):i(typeof t=="string"?t:s("login.error",{defaultValue:"Login failed"})),"mfa_token"in r){_(30);const m=setInterval(()=>{_(O=>O>=1?O-1:0)},1e3);setTimeout(()=>{clearInterval(m),_(0)},3e4)}else"username"in r&&h("login");else t instanceof U?i(s("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:s(`login.${t.code}`,{defaultValue:t.message})})):i(typeof t=="string"?t:s("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),f("/login",{replace:!0}),R()}finally{v(!1)}},R=async()=>{try{F(await $.oauth.getProviders()||[])}catch(r){C.error(s("login.fetchOAuthProvidersError",{defaultValue:"Failed to fetch OAuth providers: {{error}}",error:r.message||r.toString()})),F([])}};o.useEffect(()=>{if(!k.current){k.current=!0;const r=n.get("code"),l=n.get("state"),t=n.get("provider");r&&l&&t?E({code:r,state:l,provider:t}):R()}},[n,L]),o.useEffect(()=>{w.language&&P((a==null?void 0:a.name_i18n[w.language])||(a==null?void 0:a.name)||"")},[a,w.language]);const J=async r=>{try{S({...j,[r]:!0});const{url:l}=await $.oauth.getLoginUrl({provider:r},{headers:{"X-Base-Path":_e()}});window.location.href=l}catch(l){C.error(s("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",l)}finally{S({...j,[r]:!1})}},Q=r=>{switch(r.toLowerCase()){case"github":return e.jsx(pe,{});default:return null}},Z=n.get("code"),ee=n.get("state"),te=n.get("provider");if(o.useEffect(()=>{var r;a&&(P(a.name),window.document.title=a.name,(r=document.getElementById("site-icon"))==null||r.setAttribute("href",a.logo||""))},[a]),!a)return e.jsx(ne,{status:"500",title:"500",subTitle:s("login.fetchSiteConfigError",{defaultValue:"Failed to fetch site config: {{error}}",error:(x==null?void 0:x.message)||x})});if(Z&&ee&&te)return e.jsx(M,{});if(Y)return e.jsx(M,{});if(A&&A.status==="active"){const r=n.get("redirect");r?window.location.href=r:a!=null&&a.home_page?window.location.href=a.home_page:f("/")}return e.jsx("div",{children:e.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxs(ie,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsx(je,{transformLangConfig:D})}),e.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsx(Ve,{level:2,children:H}),e.jsx("p",{children:s("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),I&&e.jsx(B,{message:I,type:"error",showIcon:!0,style:{marginBottom:20}}),y&&e.jsx(B,{message:s(`login.mfaTips.${y}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxs(d,{name:"login",initialValues:{remember:!0},onFinish:E,size:"large",form:p,hidden:u==="password_expired",children:[u==="mfa"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{hidden:!(c!=null&&c.email)||y!=="email",children:e.jsx(g,{value:be(c==null?void 0:c.email)})}),e.jsx(d.Item,{name:"mfa_token",hidden:!0,children:e.jsx(g,{})}),e.jsx(d.Item,{name:"mfa_code",hidden:u!=="mfa",children:e.jsx(g,{placeholder:s("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsx(de,{})})})]}),u==="login"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{name:"username",rules:[{required:!0,message:s("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsx(g,{prefix:e.jsx(ue,{}),placeholder:s("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsx(d.Item,{name:"password",rules:[{required:!0,message:s("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsx(g.Password,{prefix:e.jsx(ce,{}),placeholder:s("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsx(d.Item,{children:e.jsx(q,{disabled:b>0,type:"primary",htmlType:"submit",loading:X,block:!0,children:b>0?e.jsxs("span",{style:{marginLeft:8},children:[b,"s"]}):s("login.login",{defaultValue:"Login"})})})]}),T.length>0&&u!=="password_expired"&&e.jsxs(e.Fragment,{children:[e.jsx(me,{children:s("login.or",{defaultValue:"Or"})}),e.jsx(fe,{direction:"vertical",style:{width:"100%"},children:T.map(r=>e.jsx(q,{icon:Q(r.name),onClick:()=>J(r.name),loading:j[r.name],block:!0,children:r.icon_url?e.jsx(ge,{src:r.icon_url}):s("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:r.display_name})},r.name))})]}),u==="password_expired"&&e.jsx(ye,{onSuccess:()=>{h("login"),p.setFieldValue("password",""),p.setFieldValue("mfa_code","")},token:z||void 0})]})})})};export{Oe as default};
