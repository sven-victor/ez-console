import{r as s,e as v,j as z,t as P}from"./vendor.CPU8FhsP.js";import{a as C}from"./index.ULKTm726.js";import{c as _}from"./client.pILTFIdq.js";const x=s.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),T=()=>s.useContext(x),w=(n,t=!0)=>{n?(t&&localStorage.setItem("token",n),_.defaults.headers.common.Authorization=`Bearer ${n}`):(t&&localStorage.removeItem("token"),delete _.defaults.headers.common.Authorization)},F=({children:n})=>{const[t,r]=s.useState(void 0),[p,u]=s.useState(localStorage.getItem("token")),[f,m]=s.useState(!0),{run:l}=v(async()=>{const a=localStorage.getItem("token");return a?(w(a,!1),C.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:a=>{r(a)},onError:a=>{console.error("Failed to get current user:",a),g()},onFinally:()=>{m(!1)}});s.useEffect(()=>{l()},[]);const o=async a=>{try{const e=await C.authorization.login(a),{token:d,user:c,needs_mfa:k,password_expired:h,mfa_token:y,mfa_type:A}=e;if(k)throw{needsMFA:!0,mfaToken:y,mfaType:A,user:c};if(h)throw{password_expired:!0,user:c,token:d};return w(d),u(d),r(c),c}catch(e){throw e&&e.needsMFA||e&&e.password_expired||P.error("Login failed, please check your username and password"),e}},i=s.useCallback(async a=>{try{const e=await C.oauth.handleCallback(a);let d="",c=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:k,user:h,needs_mfa:y,mfa_token:A,mfa_type:S}=e.data;if(y)throw{needsMFA:!0,mfaToken:A,mfaType:S,user:h};d=k,c=h}else{const{token:k,user:h,needs_mfa:y,mfa_token:A,mfa_type:S}=e;if(y)throw{needsMFA:!0,mfaToken:A,mfaType:S,user:h};d=k,c=h}return w(d),u(d),r(c),c}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),g=()=>{C.authorization.logout(),w(null),u(null),r(null)},I=a=>{r(a)};return z.jsx(x.Provider,{value:{user:t,token:p,loading:f,login:o,oauthLogin:i,logout:g,updateUser:I},children:n})},j=()=>{const n=s.useContext(x);if(n===void 0)throw new Error("useAuth must be used within an AuthProvider");return n},O=s.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),E=()=>s.useContext(O),D=({children:n})=>{const{user:t}=T(),{data:r=null,loading:p,runAsync:u}=v(async()=>C.system.getSiteConfig(),{manual:!0});s.useEffect(()=>{t!==void 0&&u()},[t]);const[f,m]=s.useState(null);return s.useEffect(()=>{f?localStorage.setItem("orgID",f):localStorage.removeItem("orgID")},[f]),s.useEffect(()=>{var o,i,g;let l=localStorage.getItem("orgID");if(l){const I=(o=t==null?void 0:t.organizations)==null?void 0:o.find(a=>a.id===l);if(I){m(I.id);return}}m(((g=(i=t==null?void 0:t.organizations)==null?void 0:i[0])==null?void 0:g.id)??null)},[r,t==null?void 0:t.organizations]),z.jsx(O.Provider,{value:{siteConfig:r,loading:p,enableMultiOrg:(r==null?void 0:r.enable_multi_org)??!1,fetchSiteConfig:u,currentOrgId:f,setCurrentOrgId:l=>{m(l)},clearCurrentOrgId:()=>{m(null)}},children:n})},L=()=>{var l;const{user:n}=s.useContext(x),{currentOrgId:t}=E(),r=(l=n==null?void 0:n.roles)==null?void 0:l.filter(o=>!o.organization_id||o.organization_id===t),p=()=>r?r.some(o=>o.name==="admin"&&!o.organization_id):!1,u=o=>r?p()?!0:r.some(i=>i.permissions?i.permissions.some(g=>g.code===o):!1):!1;return{hasPermission:u,hasAllPermissions:o=>o.every(i=>u(i)),hasAnyPermission:o=>o.some(i=>u(i)),isAdmin:p(),loading:!n}};export{F as A,D as S,L as a,E as b,T as c,j as u};
