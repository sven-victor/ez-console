import{u as $,aJ as l,r as p,a as _,j as e,S as he,b2 as le,g as q,ao as x,aN as Pe,a6 as ze,f as Z,B as w,dp as we,d as ce,s as o,b3 as ge,M as G,aF as Xe,dm as de,aM as Qe,U as Ye,dq as et,T as se,aX as ke,i as Ce,dr as Te,d7 as $e,p as tt,ds as st,dh as Be,dt as lt,da as ve,e as xe,aq as te,aY as Ee,aZ as Se,b as _e,du as at,dv as Oe,bf as it,bJ as nt,b5 as Fe,dw as ot,aP as He,aA as rt,aC as Le,bj as dt,db as Me,dx as ut,dy as Ke,de as ct,bh as mt,dz as We,dA as ft,dB as pt,bH as gt,aw as ht,dC as Ue}from"./vendor.B6JBhCAY.js";import{a as C}from"./index.DDV53gBS.js";import{g as qe,a as xt,s as yt}from"./base.BXKr0a0H.js";import{f as ee,g as Vt,h as Ie,i as Ge,M as Ze,L as jt}from"./components.AJXUxw-E.js";import{l as bt,c as St,u as kt,d as vt,a as _t,g as Ft,b as Ct,e as wt,r as It}from"./system.BGeF3M7c.js";import{c as Tt,b as At}from"./contexts.B8ZCWCcl.js";import{l as Et,b as zt}from"./authorization.B5peLd2a.js";const be=/^(https?:\/\/)(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])(:[0-9]+)?(\/[\w\-._~:/?#[\]@!$&'()*+,;=]*)*$/,Mt={github:{email_field:"email",username_field:"login",full_name_field:"name",avatar_field:"avatar_url",role_field:"",icon_url:"https://github.githubassets.com/favicons/favicon.svg",display_name:"GitHub",endpoints:{auth_endpoint:"https://github.com/login/oauth/authorize",token_endpoint:"https://github.com/login/oauth/access_token",userinfo_endpoint:"https://api.github.com/user"},scope:"user:email"},google:{email_field:"email",username_field:"email",full_name_field:"name",avatar_field:"picture",role_field:"",icon_url:"https://www.google.com/favicon.ico",display_name:"Google",endpoints:{auth_endpoint:"https://accounts.google.com/o/oauth2/v2/auth",token_endpoint:"https://oauth2.googleapis.com/token",userinfo_endpoint:"https://openidconnect.googleapis.com/v1/userinfo"},scope:"profile email"},dingtalk:{email_field:"email",username_field:"nick",full_name_field:"name",avatar_field:"avatar",role_field:"",icon_url:"https://img.alicdn.com/tfs/TB1pTD.XQT2gK0jSZFkXXcIQFXa-160-160.png",display_name:"DingTalk",endpoints:{auth_endpoint:"https://oapi.dingtalk.com/connect/qrconnect",token_endpoint:"https://oapi.dingtalk.com/gettoken",userinfo_endpoint:"https://oapi.dingtalk.com/topapi/user/get"},scope:"snsapi_login"},wechat:{email_field:"",username_field:"openid",full_name_field:"nickname",avatar_field:"headimgurl",role_field:"",icon_url:"https://res.wx.qq.com/a/wx_fed/assets/res/NTI4MWU5.ico",display_name:"WeChat",endpoints:{auth_endpoint:"https://open.weixin.qq.com/connect/qrconnect",token_endpoint:"https://api.weixin.qq.com/sns/oauth2/access_token",userinfo_endpoint:"https://api.weixin.qq.com/sns/userinfo"},scope:"snsapi_login"},custom:{email_field:"",username_field:"",full_name_field:"",avatar_field:"",role_field:"",icon_url:"",display_name:"",endpoints:{auth_endpoint:"",token_endpoint:"",userinfo_endpoint:""},scope:""}},Rt=({initialData:t,onRefresh:i})=>{const{t:s}=$("system"),{t:m}=$("common"),[g]=l.useForm(),[f,S]=p.useState((t==null?void 0:t.provider)||"custom"),[v,j]=p.useState((t==null?void 0:t.provider)==="custom"||(t==null?void 0:t.provider)==="autoDiscover"),[n,u]=p.useState((t==null?void 0:t.enabled)||!1),[y,L]=p.useState((t==null?void 0:t.auto_create_user)||!1),{loading:R,data:A,refresh:b}=_(C.system.getOauthSettings,{manual:!!t,onSuccess:F=>{g.setFieldsValue(F),S(F.provider),j(F.provider==="custom"||F.provider==="autoDiscover"),u(F.enabled),L(F.auto_create_user)},onError:F=>{o.error(s("settings.fetchFailed",{defaultValue:"Failed to fetch settings"})),console.error("Failed to get OAuth settings",F)}});p.useEffect(()=>{t&&(g.setFieldsValue(t),S(t.provider),j(t.provider==="custom"||t.provider==="autoDiscover"),u(t.enabled),L(t.auto_create_user))},[t,g]);const I=F=>{S(F),j(F==="custom"||F==="autoDiscover");const r=Mt[F];r&&g.setFieldsValue({auth_endpoint:r.endpoints.auth_endpoint,token_endpoint:r.endpoints.token_endpoint,userinfo_endpoint:r.endpoints.userinfo_endpoint,scope:r.scope,email_field:r.email_field,username_field:r.username_field,full_name_field:r.full_name_field,avatar_field:r.avatar_field,role_field:r.role_field,icon_url:r.icon_url,display_name:r.display_name})},M=F=>{u(F)},E=F=>{L(F)},{loading:T,run:K}=_(C.system.updateOauthSettings,{manual:!0,onSuccess:()=>{o.success(s("settings.updateSuccess",{defaultValue:"Settings updated successfully"})),i?i():b()},onError:F=>{o.error(s("settings.updateFailed",{defaultValue:"Failed to update settings"})),console.error("Failed to update OAuth settings",F)}}),N=F=>{K(F)},H=()=>{i?i():b()},{loading:J,run:z}=_(async({redirect_uri:F,...r})=>{let P;return F?P=new URL(F):P=new URL(window.location.origin),P.pathname=qe("/system/settings/oauth/test-callback"),P.searchParams.set("provider",f),C.system.testOauthConnection({redirect_uri:P.toString(),...r})},{manual:!0,onSuccess:({url:F})=>{window.open(F,"_blank")},onError:F=>{o.error(s("settings.oauth.testConnection.failed",{defaultValue:"Failed to test connection: {{error}}",error:F.message})),console.error("Failed to test OAuth connection",F)}}),B=()=>f==="custom";return e.jsx(he,{spinning:R,children:e.jsxs(l,{form:g,layout:"vertical",onFinish:N,initialValues:t||A,children:[e.jsx(l.Item,{name:"enabled",label:s("settings.oauth.enabled.label",{defaultValue:"Enable OAuth"}),valuePropName:"checked",tooltip:s("settings.oauth.enabled.tooltip",{defaultValue:"Enable or disable OAuth login for the system."}),children:e.jsx(le,{onChange:M})}),e.jsx(l.Item,{name:"provider",label:s("settings.oauth.provider.label",{defaultValue:"OAuth Provider"}),tooltip:s("settings.oauth.provider.tooltip",{defaultValue:"Select an OAuth provider or configure a custom one."}),rules:[{required:n,message:s("settings.oauth.provider.required",{defaultValue:"Please select an OAuth provider."})}],children:e.jsxs(q,{onChange:I,disabled:!n,children:[e.jsx(q.Option,{value:"github",children:s("settings.oauth.provider.options.github",{defaultValue:"GitHub"})}),e.jsx(q.Option,{value:"google",children:s("settings.oauth.provider.options.google",{defaultValue:"Google"})}),e.jsx(q.Option,{value:"dingtalk",children:s("settings.oauth.provider.options.dingtalk",{defaultValue:"DingTalk"})}),e.jsx(q.Option,{value:"wechat",children:s("settings.oauth.provider.options.wechat",{defaultValue:"WeChat"})}),e.jsx(q.Option,{value:"autoDiscover",children:s("settings.oauth.provider.options.autoDiscover",{defaultValue:"Auto Discover"})}),e.jsx(q.Option,{value:"custom",children:s("settings.oauth.provider.options.custom",{defaultValue:"Custom"})})]})}),e.jsx(l.Item,{name:"display_name",label:s("settings.oauth.displayName.label",{defaultValue:"Display Name"}),tooltip:s("settings.oauth.displayName.tooltip",{defaultValue:"The name displayed on the login button for this provider."}),children:e.jsx(x,{disabled:!n,placeholder:f!=="custom"?s(`settings.oauth.provider.options.${f}`,{defaultValue:f}):""})}),e.jsx(l.Item,{name:"icon_url",label:s("settings.oauth.iconUrl.label",{defaultValue:"Icon URL"}),tooltip:s("settings.oauth.iconUrl.tooltip",{defaultValue:"URL of the icon for this provider. Displayed on the login button."}),rules:[{pattern:be,message:s("settings.oauth.iconUrl.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(x,{disabled:!n,placeholder:"https://example.com/icon.png"})}),e.jsx(l.Item,{name:"client_id",label:s("settings.oauth.clientId.label",{defaultValue:"Client ID"}),tooltip:s("settings.oauth.clientId.tooltip",{defaultValue:"The Client ID provided by the OAuth provider."}),rules:[{required:n,message:s("settings.oauth.clientId.required",{defaultValue:"Client ID is required."})}],children:e.jsx(x,{disabled:!n})}),e.jsx(l.Item,{name:"client_secret",label:s("settings.oauth.clientSecret.label",{defaultValue:"Client Secret"}),tooltip:s("settings.oauth.clientSecret.tooltip",{defaultValue:"The Client Secret provided by the OAuth provider. This will be stored encrypted."}),rules:[{required:n,message:s("settings.oauth.clientSecret.required",{defaultValue:"Client Secret is required."})}],children:e.jsx(x.Password,{disabled:!n,autoComplete:"new-password",visibilityToggle:!1,placeholder:s("settings.oauth.clientSecret.unchanged",{defaultValue:"Leave blank to keep unchanged"})})}),B()&&e.jsx(l.Item,{name:"auth_endpoint",label:s("settings.oauth.authEndpoint.label",{defaultValue:"Authorization Endpoint"}),tooltip:s("settings.oauth.authEndpoint.tooltip",{defaultValue:"The authorization endpoint URL of the OAuth provider."}),rules:[{required:n&&f==="custom",message:s("settings.oauth.authEndpoint.required",{defaultValue:"Authorization Endpoint is required."})},{pattern:be,message:s("settings.oauth.authEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(x,{disabled:!n})}),e.jsx(l.Item,{name:"wellknown_endpoint",hidden:f!=="autoDiscover",label:s("settings.oauth.wellknownEndpoint.label",{defaultValue:"Wellknown Endpoint"}),tooltip:s("settings.oauth.wellknownEndpoint.tooltip",{defaultValue:"The wellknown endpoint URL of the OAuth provider."}),rules:[{pattern:be,message:s("settings.oauth.wellknownEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})},{required:n&&f==="autoDiscover",message:s("settings.oauth.wellknownEndpoint.required",{defaultValue:"Wellknown Endpoint is required."})}],children:e.jsx(x,{disabled:!n})}),B()&&e.jsx(l.Item,{name:"token_endpoint",label:s("settings.oauth.tokenEndpoint.label",{defaultValue:"Token Endpoint"}),tooltip:s("settings.oauth.tokenEndpoint.tooltip",{defaultValue:"The token endpoint URL of the OAuth provider."}),rules:[{required:n&&f==="custom",message:s("settings.oauth.tokenEndpoint.required",{defaultValue:"Token Endpoint is required."})},{pattern:be,message:s("settings.oauth.tokenEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(x,{disabled:!n})}),B()&&e.jsx(l.Item,{name:"userinfo_endpoint",label:s("settings.oauth.userInfoEndpoint.label",{defaultValue:"User Info Endpoint"}),tooltip:s("settings.oauth.userInfoEndpoint.tooltip",{defaultValue:"The user information endpoint URL of the OAuth provider."}),rules:[{required:n&&f==="custom",message:s("settings.oauth.userInfoEndpoint.required",{defaultValue:"User Info Endpoint is required."})},{pattern:be,message:s("settings.oauth.userInfoEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(x,{disabled:!n})}),e.jsx(l.Item,{name:"scope",label:s("settings.oauth.scope.label",{defaultValue:"Authorization Scope"}),tooltip:s("settings.oauth.scope.tooltip",{defaultValue:"The scopes to request from the OAuth provider, separated by spaces."}),rules:[{required:n,message:s("settings.oauth.scope.required",{defaultValue:"Scope is required."})}],children:e.jsx(x,{disabled:!n})}),e.jsx(l.Item,{name:"redirect_uri",label:s("settings.oauth.redirectUri.label",{defaultValue:"Redirect URI"}),tooltip:s("settings.oauth.redirectUri.tooltip",{defaultValue:"The Redirect URI registered with the OAuth provider. This should match the one configured in your application."}),rules:[F=>F.getFieldValue("redirect_uri")!==""?{pattern:be,message:s("settings.oauth.redirectUri.invalidUrl",{defaultValue:"Please enter a valid URL."})}:{required:!1}],children:e.jsx(x,{disabled:!n,placeholder:`http://${window.location.host}${qe(`/login?provider=settings.${f}`)}`})}),e.jsx(l.Item,{name:"auto_create_user",label:s("settings.oauth.autoCreateUser.label",{defaultValue:"Auto Create User"}),valuePropName:"checked",tooltip:s("settings.oauth.autoCreateUser.tooltip",{defaultValue:"Automatically create a new user if one does not exist with the OAuth email."}),children:e.jsx(le,{onChange:E,disabled:!n})}),e.jsx(l.Item,{name:"default_role",label:s("settings.oauth.defaultRole.label",{defaultValue:"Default Role"}),tooltip:s("settings.oauth.defaultRole.tooltip",{defaultValue:"The default role to assign to new users created via OAuth. Enter role ID."}),rules:[{required:n&&y,message:s("settings.oauth.defaultRole.required",{defaultValue:"Default Role is required when auto create user is enabled."})}],children:e.jsx(x,{disabled:!n||!y})}),e.jsx(l.Item,{name:"role_mapping_mode",label:s("settings.oauth.roleMappingMode.label",{defaultValue:"Role Mapping Mode"}),tooltip:s("settings.oauth.roleMappingMode.tooltip",{defaultValue:"Controls how user roles are synchronized from OAuth2 provider."}),initialValue:"auto",children:e.jsxs(q,{disabled:!n,children:[e.jsx(q.Option,{value:"disabled",children:s("settings.oauth.roleMappingMode.options.disabled.label",{defaultValue:"Disabled"})}),e.jsx(q.Option,{value:"auto",children:s("settings.oauth.roleMappingMode.options.auto.label",{defaultValue:"Auto"})}),e.jsx(q.Option,{value:"enforce",children:s("settings.oauth.roleMappingMode.options.enforce.label",{defaultValue:"Enforce"})})]})}),e.jsx(Pe,{style:{marginBottom:16},type:"info",showIcon:!0,message:s("settings.oauth.roleMappingMode.infoTitle",{defaultValue:"Role Mapping Mode Information"}),description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[s("settings.oauth.roleMappingMode.options.disabled.label",{defaultValue:"Disabled"}),":"]})," ",s("settings.oauth.roleMappingMode.options.disabled.description",{defaultValue:"Ignores role information from OAuth2 provider. New users get the default role."})]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[s("settings.oauth.roleMappingMode.options.auto.label",{defaultValue:"Auto"}),":"]})," ",s("settings.oauth.roleMappingMode.options.auto.description",{defaultValue:"Uses OAuth2 roles for new users or users without roles, but preserves existing role assignments."})]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[s("settings.oauth.roleMappingMode.options.enforce.label",{defaultValue:"Enforce"}),":"]})," ",s("settings.oauth.roleMappingMode.options.enforce.description",{defaultValue:"Always overwrites user roles with OAuth2 roles when available."})]})]})}),e.jsx(l.Item,{name:"mfa_enabled",label:s("settings.oauth.mfaEnabled.label",{defaultValue:"MFA Enabled"}),valuePropName:"checked",tooltip:s("settings.oauth.mfaEnabled.tooltip",{defaultValue:"Enable MFA for OAuth login(Only valid when MFA is enabled by the user)."}),children:e.jsx(le,{disabled:!n})}),e.jsx(ze,{children:s("settings.oauth.fieldMapping.title",{defaultValue:"Field Mapping"})}),e.jsx(Pe,{style:{marginBottom:16},type:"info",showIcon:!0,message:s("settings.oauth.fieldMapping.autoDetectHint",{defaultValue:"For preset providers, fields are typically auto-detected. Customize if needed."}),description:v?"":s("settings.oauth.fieldMapping.presetDescription",{defaultValue:'These fields are pre-filled based on the selected provider. You can switch to "Custom" provider to edit them directly.'})}),e.jsx(l.Item,{name:"email_field",label:s("settings.oauth.fieldMapping.emailField.label",{defaultValue:"Email Field"}),tooltip:s("settings.oauth.fieldMapping.emailField.tooltip",{defaultValue:"The field name in the user info response that contains the user email. (e.g., email)"}),children:e.jsx(x,{placeholder:"email",disabled:!n||!v})}),e.jsx(l.Item,{name:"username_field",label:s("settings.oauth.fieldMapping.usernameField.label",{defaultValue:"Username Field"}),tooltip:s("settings.oauth.fieldMapping.usernameField.tooltip",{defaultValue:"The field name in the user info response that contains the username. (e.g., login, sub)"}),children:e.jsx(x,{placeholder:"login",autoComplete:"off",disabled:!n||!v})}),e.jsx(l.Item,{name:"full_name_field",label:s("settings.oauth.fieldMapping.fullNameField.label",{defaultValue:"Full Name Field"}),tooltip:s("settings.oauth.fieldMapping.fullNameField.tooltip",{defaultValue:"The field name in the user info response that contains the user's full name. (e.g., name)"}),children:e.jsx(x,{placeholder:"name",disabled:!n||!v})}),e.jsx(l.Item,{name:"avatar_field",label:s("settings.oauth.fieldMapping.avatarField.label",{defaultValue:"Avatar URL Field"}),tooltip:s("settings.oauth.fieldMapping.avatarField.tooltip",{defaultValue:"The field name in the user info response that contains the URL to the user's avatar. (e.g., picture, avatar_url)"}),children:e.jsx(x,{placeholder:"avatar_url",disabled:!n||!v})}),e.jsx(l.Item,{name:"role_field",label:s("settings.oauth.fieldMapping.roleField.label",{defaultValue:"Role Field"}),tooltip:s("settings.oauth.fieldMapping.roleField.tooltip",{defaultValue:"The field name in the user info response that contains the user's role. (Optional)"}),children:e.jsx(x,{placeholder:"role",disabled:!n||!v})}),e.jsx(l.Item,{children:e.jsxs(Z,{children:[e.jsx(w,{type:"primary",htmlType:"submit",loading:T,icon:e.jsx(we,{}),children:m("save",{defaultValue:"Save"})}),e.jsx(w,{loading:J,onClick:async()=>{const F=g.getFieldsValue();z(F)},children:s("settings.oauth.testConnection.button",{defaultValue:"Test Connection"})}),e.jsx(w,{onClick:H,icon:e.jsx(ce,{}),children:m("refresh",{defaultValue:"Refresh"})})]})})]})})},Pt=()=>{const{t}=$("system"),{t:i}=$("common"),[s]=l.useForm(),{loading:m,data:g,refresh:f}=_(C.system.getSecuritySettings,{onSuccess:n=>{s.setFieldsValue(n)},onError:n=>{o.error(t("settings.fetchFailed",{defaultValue:"Failed to fetch settings"})),console.error("Failed to get system settings",n)}}),{loading:S,run:v}=_(C.system.updateSecuritySettings,{manual:!0,onSuccess:()=>{o.success(t("settings.updateSuccess",{defaultValue:"Settings updated successfully"})),f()},onError:n=>{o.error(t("settings.updateFailed",{defaultValue:"Failed to update settings"})),console.error("Failed to update system settings",n)}}),j=n=>{v(n)};return e.jsx(he,{spinning:m,children:e.jsxs(l,{form:s,layout:"vertical",onFinish:j,initialValues:g,children:[e.jsx(l.Item,{name:"mfa_enforced",label:t("settings.security.mfa.label",{defaultValue:"Enforce Multi-Factor Authentication (MFA)"}),valuePropName:"checked",tooltip:t("settings.security.mfa.tooltip",{defaultValue:"If enabled, all users will be required to set up MFA."}),children:e.jsx(le,{})}),e.jsx(l.Item,{name:"password_complexity",label:t("settings.security.passwordComplexity.label",{defaultValue:"Password Complexity"}),tooltip:t("settings.security.passwordComplexity.tooltip",{defaultValue:"Define the complexity requirements for user passwords."}),children:e.jsxs(q,{children:[e.jsx(q.Option,{value:"low",children:t("settings.security.passwordComplexity.options.low",{defaultValue:"Low"})}),e.jsx(q.Option,{value:"medium",children:t("settings.security.passwordComplexity.options.medium",{defaultValue:"Medium"})}),e.jsx(q.Option,{value:"high",children:t("settings.security.passwordComplexity.options.high",{defaultValue:"High"})}),e.jsx(q.Option,{value:"very_high",children:t("settings.security.passwordComplexity.options.veryHigh",{defaultValue:"Very High"})})]})}),e.jsx(l.Item,{name:"password_min_length",label:t("settings.security.passwordMinLength.label",{defaultValue:"Minimum Password Length"}),tooltip:t("settings.security.passwordMinLength.tooltip",{defaultValue:"The minimum number of characters required for a password."}),rules:[{type:"number",min:6,max:32}],children:e.jsx(ge,{min:6,max:32,style:{width:"100%"}})}),e.jsx(l.Item,{name:"password_expiry_days",label:t("settings.security.passwordExpiry.label",{defaultValue:"Password Expiry (Days)"}),tooltip:t("settings.security.passwordExpiry.tooltip",{defaultValue:"Number of days after which passwords expire. Set to 0 to disable expiry."}),children:e.jsx(ge,{min:0,style:{width:"100%"},addonAfter:t("settings.days",{defaultValue:"Days"})})}),e.jsx(l.Item,{name:"login_failure_lock",label:t("settings.security.loginFailureLock.label",{defaultValue:"Lock Account on Login Failure"}),valuePropName:"checked",tooltip:t("settings.security.loginFailureLock.tooltip",{defaultValue:"Lock user accounts after a specified number of failed login attempts."}),children:e.jsx(le,{})}),e.jsx(l.Item,{noStyle:!0,shouldUpdate:(n,u)=>n.login_failure_lock!==u.login_failure_lock,children:({getFieldValue:n})=>n("login_failure_lock")?e.jsx(l.Item,{name:"login_failure_attempts",label:t("settings.security.loginFailureAttempts.label",{defaultValue:"Login Failure Attempts"}),tooltip:t("settings.security.loginFailureAttempts.tooltip",{defaultValue:"Number of failed login attempts before locking the account."}),children:e.jsx(ge,{min:1,max:10,style:{width:"100%"}})}):null}),e.jsx(l.Item,{noStyle:!0,shouldUpdate:(n,u)=>n.login_failure_lock!==u.login_failure_lock,children:({getFieldValue:n})=>n("login_failure_lock")?e.jsx(l.Item,{name:"login_failure_lockout_minutes",label:t("settings.security.loginFailureLockoutMinutes.label",{defaultValue:"Login Failure Lockout (Minutes)"}),tooltip:t("settings.security.loginFailureLockoutMinutes.tooltip",{defaultValue:"Number of minutes to lock the account after a specified number of failed login attempts."}),children:e.jsx(ge,{min:1,max:10,style:{width:"100%"},addonAfter:t("settings.minutes",{defaultValue:"Minutes"})})}):null}),e.jsx(l.Item,{name:"history_password_check",label:t("settings.security.historyPasswordCheck.label",{defaultValue:"Enforce Password History Policy"}),valuePropName:"checked",tooltip:t("settings.security.historyPasswordCheck.tooltip",{defaultValue:"Prevent users from reusing recent passwords."}),children:e.jsx(le,{})}),e.jsx(l.Item,{noStyle:!0,shouldUpdate:(n,u)=>n.history_password_check!==u.history_password_check,children:({getFieldValue:n})=>n("history_password_check")?e.jsx(l.Item,{name:"history_password_count",label:t("settings.security.historyPasswordCount.label",{defaultValue:"Password History Count"}),tooltip:t("settings.security.historyPasswordCount.tooltip",{defaultValue:"Number of previous passwords to remember and prevent reuse."}),children:e.jsx(ge,{min:1,max:10,style:{width:"100%"}})}):null}),e.jsx(l.Item,{name:"inactive_account_lock_days",label:t("settings.security.inactiveAccountLock.label",{defaultValue:"Auto-lock Inactive Accounts (Days)"}),tooltip:t("settings.security.inactiveAccountLock.tooltip",{defaultValue:"Number of days of inactivity after which user accounts are automatically locked. Set to 0 to disable."}),children:e.jsx(ge,{min:0,style:{width:"100%"},addonAfter:t("settings.days",{defaultValue:"Days"})})}),e.jsx(l.Item,{name:"session_timeout_minutes",label:t("settings.security.sessionTimeout.label",{defaultValue:"Session Timeout (Minutes)"}),tooltip:t("settings.security.sessionTimeout.tooltip",{defaultValue:"Automatically log out users after a period of inactivity."}),children:e.jsx(ge,{min:5,style:{width:"100%"},addonAfter:t("settings.minutes",{defaultValue:"Minutes"})})}),e.jsx(l.Item,{name:"session_idle_timeout_minutes",label:t("settings.security.sessionIdleTimeout.label",{defaultValue:"Session Idle Timeout (Minutes)"}),tooltip:t("settings.security.sessionIdleTimeout.tooltip",{defaultValue:"Automatically log out users after a period of inactivity."}),children:e.jsx(ge,{min:5,style:{width:"100%"},addonAfter:t("settings.minutes",{defaultValue:"Minutes"})})}),e.jsx(l.Item,{children:e.jsxs(Z,{children:[e.jsx(w,{type:"primary",htmlType:"submit",loading:S,icon:e.jsx(we,{}),children:i("save",{defaultValue:"Save"})}),e.jsx(w,{onClick:()=>f(),icon:e.jsx(ce,{}),children:i("refresh",{defaultValue:"Refresh"})})]})})]})})},Ot=({fetchItems:t,importItems:i,columns:s,...m})=>{const{t:g}=$("system"),[f,S]=p.useState([]),[v,j]=p.useState([]),{run:n,loading:u}=_(t,{onError:R=>{o.error(g("settings.ldap.importError",{error:`${R.message}`}))},onSuccess:R=>{S(R)},manual:!0}),{run:y,loading:L}=_(async()=>{for(const R of v.filter(A=>{const b=f.find(I=>I.ldap_dn===A);return!(!b||b.status==="imported")})){const A=await i([R]);S(b=>[...b].map(M=>{for(const E of A)if(M.ldap_dn===E.ldap_dn)return{...E,status:"imported"};return M}))}},{manual:!0});return p.useEffect(()=>{m.visible&&(S([]),n(),j([]))},[m.visible]),e.jsx(G,{title:g("settings.ldap.importTitle"),...m,onOk:()=>{y()},width:900,confirmLoading:L,loading:u,children:e.jsx(ke,{rowKey:"ldap_dn",rowSelection:{onChange:R=>{j(R)},getCheckboxProps:R=>({disabled:R.status==="imported"})},columns:s.map(({render:R,...A})=>R?{...A,render:(b,I,M)=>{const E=v.includes(I.ldap_dn)&&L&&I.status!=="imported";return R(b,I,M,E)}}:A),dataSource:f,pagination:!1,scroll:{y:400,x:"max-content"}})})},Lt=()=>{var I,M,E;const{t}=$("system"),[i]=l.useForm(),[s,m]=p.useState(!1),[g,f]=p.useState(null),[S,v]=p.useState(!1),[j,n]=p.useState(!1),[u]=l.useForm(),[y,L]=p.useState(!1);_(C.system.getLdapSettings,{onSuccess:T=>{i.setFieldsValue(T),L(T.enabled)},onError:T=>{o.error(t("settings.ldap.loadError",{defaultValue:"Failed to load LDAP settings: {{error}}",error:`${T.message}`}))}}),p.useEffect(()=>{f(null)},[S]);const R=async T=>{m(!0);try{await C.system.updateLdapSettings(T),o.success(t("settings.ldap.saveSuccess",{defaultValue:"LDAP settings saved successfully."}))}catch{o.error(t("settings.ldap.saveError",{defaultValue:"Failed to save LDAP settings."}))}finally{m(!1)}},{run:A,loading:b}=_(async T=>{const K=await i.validateFields();return await C.system.testLdapConnection({...T,...K})},{onSuccess:T=>{f(T)},onError:T=>{o.error(t("settings.ldap.testError",{defaultValue:"LDAP connection test failed: {{error}}",error:`${T.message}`}))},manual:!0});return e.jsxs(e.Fragment,{children:[e.jsxs(l,{form:i,layout:"vertical",onFinish:R,initialValues:{user_attr:"uid",email_attr:"mail",display_name_attr:"displayName",default_role:"user"},children:[e.jsx(l.Item,{label:t("settings.ldap.enabled",{defaultValue:"Enable LDAP Authentication"}),name:"enabled",valuePropName:"checked",children:e.jsx(le,{onChange:T=>L(T)})}),e.jsx(l.Item,{label:t("settings.ldap.serverUrl",{defaultValue:"LDAP Server URL"}),name:"server_url",rules:[{required:y,message:t("settings.ldap.serverUrlRequired",{defaultValue:"LDAP Server URL is required."})}],children:e.jsx(x,{disabled:!y,placeholder:"ldap://ldap.example.com:389"})}),e.jsx(l.Item,{label:t("settings.ldap.bindDn",{defaultValue:"Bind DN"}),name:"bind_dn",rules:[{required:y,message:t("settings.ldap.bindDnRequired",{defaultValue:"Bind DN is required."})}],children:e.jsx(x,{disabled:!y,placeholder:"cn=admin,dc=example,dc=com"})}),e.jsx(l.Item,{label:t("settings.ldap.bindPassword",{defaultValue:"Bind Password"}),name:"bind_password",rules:[{required:y,message:t("settings.ldap.bindPasswordRequired",{defaultValue:"Bind Password is required."})}],children:e.jsx(x.Password,{hidden:!0,autoComplete:"new-password"})}),e.jsx(l.Item,{label:t("settings.ldap.baseDn",{defaultValue:"Base DN"}),name:"base_dn",rules:[{required:y,message:t("settings.ldap.baseDnRequired",{defaultValue:"Base DN is required."})}],children:e.jsx(x,{disabled:!y,placeholder:"dc=example,dc=com"})}),e.jsx(l.Item,{label:t("settings.ldap.userFilter",{defaultValue:"User Filter"}),name:"user_filter",children:e.jsx(x,{disabled:!y,hidden:!0,autoComplete:"off",placeholder:"(objectClass=person)"})}),e.jsx(l.Item,{label:t("settings.ldap.userAttr",{defaultValue:"User Attribute"}),name:"user_attr",rules:[{required:y,message:t("settings.ldap.userAttrRequired",{defaultValue:"User Attribute is required."})}],children:e.jsx(x,{disabled:!y})}),e.jsx(l.Item,{label:t("settings.ldap.emailAttr",{defaultValue:"Email Attribute"}),name:"email_attr",rules:[{required:y,message:t("settings.ldap.emailAttrRequired",{defaultValue:"Email Attribute is required."})}],children:e.jsx(x,{disabled:!y})}),e.jsx(l.Item,{label:t("settings.ldap.displayNameAttr",{defaultValue:"Display Name Attribute"}),name:"display_name_attr",rules:[{required:y,message:t("settings.ldap.displayNameAttrRequired",{defaultValue:"Display Name Attribute is required."})}],children:e.jsx(x,{disabled:!y})}),e.jsx(l.Item,{label:t("settings.ldap.defaultRole",{defaultValue:"Default Role"}),name:"default_role",rules:[{required:y,message:t("settings.ldap.defaultRoleRequired",{defaultValue:"Default Role is required."})}],children:e.jsx(x,{disabled:!y})}),e.jsx(l.Item,{name:"timeout",label:t("settings.ldap.timeout",{defaultValue:"Timeout"}),tooltip:t("settings.ldap.timeoutTooltip",{defaultValue:"Timeout for LDAP connection in seconds"}),children:e.jsx(x,{type:"number",defaultValue:15,disabled:!y})}),e.jsx(ze,{children:t("settings.ldap.tlsDivider",{defaultValue:"TLS Configuration"})}),e.jsx(l.Item,{label:t("settings.ldap.startTls",{defaultValue:"Use StartTLS"}),name:"start_tls",valuePropName:"checked",children:e.jsx(le,{disabled:!y})}),e.jsx(l.Item,{label:t("settings.ldap.insecure",{defaultValue:"Skip TLS Verification (Insecure)"}),name:"insecure",valuePropName:"checked",children:e.jsx(le,{disabled:!y})}),e.jsx(l.Item,{label:t("settings.ldap.caCert",{defaultValue:"CA Certificate"}),name:"ca_cert",children:e.jsx(x.TextArea,{placeholder:t("settings.ldap.caCertPlaceholder",{defaultValue:`-----BEGIN CERTIFICATE-----
...`}),disabled:!y})}),e.jsx(l.Item,{label:t("settings.ldap.clientCert",{defaultValue:"Client Certificate"}),name:"client_cert",children:e.jsx(x.TextArea,{placeholder:t("settings.ldap.clientCertPlaceholder",{defaultValue:`-----BEGIN CERTIFICATE-----
...`}),disabled:!y})}),e.jsx(l.Item,{label:t("settings.ldap.clientKey",{defaultValue:"Client Key"}),name:"client_key",children:e.jsx(x.TextArea,{placeholder:t("settings.ldap.clientKeyPlaceholder",{defaultValue:`-----BEGIN PRIVATE KEY-----
...`}),disabled:!y})}),e.jsxs(l.Item,{children:[e.jsx(ee,{permissions:["system:settings:update"],children:e.jsx(w,{type:"primary",htmlType:"submit",loading:s,children:t("settings.ldap.save",{defaultValue:"Save Settings"})})}),e.jsx(ee,{permissions:["system:settings:update"],children:e.jsx(w,{disabled:!y,style:{marginLeft:8},onClick:()=>v(!0),children:t("settings.ldap.testConnection",{defaultValue:"Test Connection"})})}),e.jsx(ee,{permissions:["authorization:user:create"],children:e.jsx(w,{disabled:!y,style:{marginLeft:8},onClick:()=>{n(!0)},children:t("settings.ldap.import",{defaultValue:"Import Users"})})})]})]}),e.jsxs(G,{title:t("settings.ldap.test.title",{defaultValue:"Test LDAP Connection"}),open:S,onCancel:()=>v(!1),footer:null,children:[e.jsxs(l,{form:u,layout:"vertical",onFinish:A,children:[e.jsx(l.Item,{label:t("settings.ldap.test.username",{defaultValue:"LDAP Username"}),name:"username",rules:[{required:!0,message:t("settings.ldap.test.usernameRequired",{defaultValue:"Please enter LDAP username for testing."})}],children:e.jsx(x,{disabled:!y})}),e.jsx(l.Item,{label:t("settings.ldap.test.password",{defaultValue:"LDAP Password"}),name:"password",rules:[{required:!0,message:t("settings.ldap.test.passwordRequired",{defaultValue:"Please enter LDAP password for testing."})}],children:e.jsx(x.Password,{disabled:!y})}),e.jsxs(l.Item,{children:[e.jsx(ee,{permissions:["system:settings:update"],children:e.jsx(w,{disabled:!y,type:"primary",htmlType:"submit",children:t("settings.ldap.test.test",{defaultValue:"Test"})})}),e.jsx(w,{style:{marginLeft:8},onClick:()=>v(!1),children:t("settings.ldap.test.cancel",{defaultValue:"Cancel"})})]})]}),e.jsx(he,{spinning:b,children:e.jsx(Xe,{active:b,loading:b,children:g&&(g.user?e.jsxs(de,{bordered:!0,children:[e.jsx(de.Item,{label:"Username",span:3,children:g.user.username}),e.jsx(de.Item,{label:"Email",span:3,children:g.user.email}),e.jsx(de.Item,{label:"FullName",span:3,children:g.user.full_name}),e.jsx(de.Item,{label:"CreatedAt",span:3,children:g.user.created_at}),e.jsx(de.Item,{label:"UpdatedAt",span:3,children:g.user.updated_at})]}):e.jsx(Qe,{direction:"vertical",current:(I=g.message)==null?void 0:I.findIndex(T=>!T.success),status:(M=g.message)!=null&&M.find(T=>!T.success)?"error":"finish",items:(E=g.message)==null?void 0:E.map(T=>({status:T.success?"finish":"error",title:T.message}))}))})})]}),e.jsx(Ot,{visible:j,onCancel:()=>n(!1),fetchItems:()=>C.system.importLdapUsers({}),importItems:T=>C.system.importLdapUsers({user_dn:T}),columns:[{title:t("settings.ldap.username",{defaultValue:"Username"}),dataIndex:"username"},{title:t("settings.ldap.email",{defaultValue:"Email"}),dataIndex:"email"},{title:t("settings.ldap.fullName",{defaultValue:"Full Name"}),dataIndex:"full_name"},{title:t("settings.ldap.importStatus",{defaultValue:"Import Status"}),dataIndex:"imported",fixed:"right",render:(T,K,N,H)=>H?e.jsx(he,{indicator:e.jsx(Ye,{spin:!0})}):T?e.jsx(et,{twoToneColor:"#52c41a"}):K.id?e.jsx(se,{color:"blue",children:t("settings.ldap.importTypeBound",{defaultValue:"Bound"})}):e.jsx(se,{color:"green",children:t("settings.ldap.importTypeNew",{defaultValue:"New"})})}]})]})},Ut=()=>{const{t}=$("system"),{t:i}=$("common"),[s]=l.useForm(),[m,g]=p.useState(null),[f,S]=p.useState(!1),[v]=l.useForm(),[j,n]=p.useState(!1),{loading:u}=_(C.system.getSmtpSettings,{onSuccess:b=>{s.setFieldsValue(b),n(b.enabled)},onError:b=>{o.error(t("settings.smtp.loadError",{defaultValue:"Failed to load SMTP settings: {{error}}",error:`${b.message}`}))}});p.useEffect(()=>{g(null)},[f]);const{run:y,loading:L}=_(({port:b,...I})=>C.system.updateSmtpSettings({...I,port:Number(b)}),{manual:!0,onSuccess:()=>{o.success(t("settings.smtp.saveSuccess",{defaultValue:"SMTP settings saved successfully."}))},onError:b=>{o.error(t("settings.smtp.saveError",{defaultValue:"Failed to save SMTP settings: {{error}}",error:`${b.message}`}))}}),{run:R,loading:A}=_(async b=>{const{port:I,...M}=await s.validateFields();return await C.system.testSmtpConnection({...b,...M,port:Number(I)})},{onSuccess:b=>{g(b)},onError:b=>{o.error(t("settings.smtp.testError",{defaultValue:"SMTP connection test failed: {{error}}",error:`${b.message}`}))},manual:!0});return e.jsxs(e.Fragment,{children:[e.jsx(he,{spinning:u,children:e.jsxs(l,{form:s,layout:"vertical",onFinish:y,initialValues:{port:587,encryption:"STARTTLS"},children:[e.jsx(l.Item,{label:t("settings.smtp.enabled",{defaultValue:"Enable SMTP"}),name:"enabled",valuePropName:"checked",children:e.jsx(le,{onChange:b=>n(b)})}),e.jsx(l.Item,{label:t("settings.smtp.host",{defaultValue:"SMTP Host"}),name:"host",rules:[{required:j,message:t("settings.smtp.hostRequired",{defaultValue:"SMTP Host is required."})}],children:e.jsx(x,{disabled:!j,placeholder:"smtp.example.com"})}),e.jsx(l.Item,{label:t("settings.smtp.port",{defaultValue:"SMTP Port"}),name:"port",rules:[{required:j,message:t("settings.smtp.portRequired",{defaultValue:"SMTP Port is required."})}],children:e.jsx(x,{type:"number",disabled:!j,placeholder:"587"})}),e.jsx(l.Item,{label:t("settings.smtp.username",{defaultValue:"Username"}),name:"username",rules:[{required:j,message:t("settings.smtp.usernameRequired",{defaultValue:"Username is required."})}],children:e.jsx(x,{disabled:!j,placeholder:"user@example.com"})}),e.jsx(l.Item,{label:t("settings.smtp.password",{defaultValue:"Password"}),name:"password",children:e.jsx(x.Password,{disabled:!j,autoComplete:"new-password"})}),e.jsx(l.Item,{label:t("settings.smtp.encryption",{defaultValue:"Encryption"}),name:"encryption",rules:[{required:j,message:t("settings.smtp.encryptionRequired",{defaultValue:"Encryption is required."})}],children:e.jsxs(Ce.Group,{disabled:!j,children:[e.jsx(Ce.Button,{value:"None",children:t("settings.smtp.encryptionNone",{defaultValue:"None"})}),e.jsx(Ce.Button,{value:"SSL/TLS",children:t("settings.smtp.encryptionSslTls",{defaultValue:"SSL/TLS"})}),e.jsx(Ce.Button,{value:"STARTTLS",children:t("settings.smtp.encryptionStartTls",{defaultValue:"STARTTLS"})})]})}),e.jsx(l.Item,{label:t("settings.smtp.fromAddress",{defaultValue:"From Address"}),name:"from_address",rules:[{required:j,message:t("settings.smtp.fromAddressRequired",{defaultValue:"From Address is required."})},{type:"email",message:t("settings.smtp.fromAddressInvalid",{defaultValue:"Invalid email address."})}],children:e.jsx(x,{disabled:!j,placeholder:"noreply@example.com"})}),e.jsx(l.Item,{label:t("settings.smtp.fromName",{defaultValue:"From Name"}),name:"from_name",children:e.jsx(x,{disabled:!j,placeholder:t("settings.smtp.fromNamePlaceholder",{defaultValue:"System Notifications"})})}),e.jsx(ze,{children:t("settings.smtp.templateDivider",{defaultValue:"Template Configuration"})}),e.jsx(l.Item,{label:t("settings.smtp.resetPasswordTemplate",{defaultValue:"Reset Password Template"}),name:"reset_password_template",children:e.jsx(Te,{theme:"snow"})}),e.jsx(l.Item,{label:t("settings.smtp.userLockedTemplate",{defaultValue:"User Locked Template"}),name:"user_locked_template",children:e.jsx(Te,{theme:"snow"})}),e.jsx(l.Item,{label:t("settings.smtp.mfaCodeTemplate",{defaultValue:"MFA Code Template"}),name:"mfa_code_template",children:e.jsx(Te,{theme:"snow"})}),e.jsxs(l.Item,{children:[e.jsx(ee,{permission:"system:setting:update",children:e.jsx(w,{type:"primary",htmlType:"submit",loading:L,style:{marginRight:8},children:i("save",{defaultValue:"Save"})})}),e.jsx(w,{onClick:()=>S(!0),disabled:!j||A,loading:A,children:t("settings.smtp.testConnection",{defaultValue:"Test Connection"})})]})]})}),e.jsx(G,{title:t("settings.smtp.testConnectionTitle",{defaultValue:"Test SMTP Connection"}),open:f,onCancel:()=>S(!1),footer:[e.jsx(w,{onClick:()=>S(!1),children:i("cancel",{defaultValue:"Cancel"})},"back"),e.jsx(w,{type:"primary",loading:A,onClick:()=>v.submit(),children:t("settings.smtp.sendTestEmail",{defaultValue:"Send Test Email"})},"submit")],children:e.jsxs(l,{form:v,layout:"vertical",onFinish:b=>R(b),children:[e.jsx(l.Item,{label:t("settings.smtp.testEmailRecipient",{defaultValue:"Recipient Email Address"}),name:"to",rules:[{required:!0,message:t("settings.smtp.testEmailRecipientRequired",{defaultValue:"Recipient email address is required."})},{type:"email",message:t("settings.smtp.testEmailRecipientInvalid",{defaultValue:"Invalid email address."})}],children:e.jsx(x,{placeholder:"test@example.com"})}),m&&e.jsx(l.Item,{label:t("settings.smtp.testResult",{defaultValue:"Test Result"}),children:m.success?e.jsx("span",{style:{color:"green"},children:t("settings.smtp.testSuccess",{defaultValue:"Connection successful!"})}):e.jsx("span",{style:{color:"red"},children:t("settings.smtp.testFailed",{defaultValue:"Connection failed: {{error}}",error:m.message})})})]})})]})},qt=()=>{const{t,i18n:i}=$("system"),{t:s}=$("common"),[m]=l.useForm(),{loading:g,data:f,refresh:S}=_(C.system.getSystemBaseSettings,{onSuccess:u=>{m.setFieldsValue(u)},onError:u=>{o.error(t("settings.fetchFailed",{defaultValue:"Failed to fetch settings"})),console.error("Failed to get system settings",u)}}),{loading:v,run:j}=_(C.system.updateSystemBaseSettings,{manual:!0,onSuccess:()=>{o.success(t("settings.updateSuccess",{defaultValue:"Settings updated successfully"})),S()},onError:u=>{o.error(t("settings.updateFailed",{defaultValue:"Failed to update settings"})),console.error("Failed to update system settings",u)}}),n=u=>{j(u)};return e.jsx(he,{spinning:g,children:e.jsxs(l,{form:m,layout:"vertical",onFinish:n,initialValues:f,children:[e.jsx(l.Item,{label:t("settings.base.name",{defaultValue:"Name"}),children:e.jsx($e,{items:[{key:"default",label:s("language.default",{defaultValue:"Default"}),forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(l.Item,{name:"name",children:e.jsx(x,{})})})},...Vt.map(u=>({key:u.lang,label:i.language!==u.lang?s(`language.${u.lang}`,{defaultValue:u.label,lang:u.label}):u.label,forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(l.Item,{name:["name_i18n",u.lang],children:e.jsx(x,{})})})}))]})}),e.jsx(l.Item,{label:t("settings.base.logo",{defaultValue:"Logo"}),name:"logo",children:e.jsx(x,{})}),e.jsx(l.Item,{label:t("settings.base.homePage",{defaultValue:"Home Page"}),name:"home_page",children:e.jsx(x,{})}),e.jsx(l.Item,{label:t("settings.base.disableLocalUserLogin",{defaultValue:"Disable Local User Login"}),name:"disable_local_user_login",tooltip:t("settings.base.disableLocalUserLoginTooltip",{defaultValue:"Disable local user login, It is only valid when other authentication methods are enabled."}),children:e.jsx(le,{})}),e.jsx(l.Item,{label:t("settings.base.enableMultiOrg",{defaultValue:"Enable Multi-Organization"}),name:"enable_multi_org",tooltip:t("settings.base.enableMultiOrgTooltip",{defaultValue:"Enable multi-organization feature. When enabled, organizations can be managed in the Organization Management tab."}),children:e.jsx(le,{})}),e.jsx(l.Item,{children:e.jsxs(Z,{children:[e.jsx(w,{type:"primary",htmlType:"submit",loading:v,icon:e.jsx(we,{}),children:s("save",{defaultValue:"Save"})}),e.jsx(w,{onClick:()=>S(),icon:e.jsx(ce,{}),children:s("refresh",{defaultValue:"Refresh"})})]})})]})})},{TextArea:Nt}=x,Dt=()=>{var X;const{t}=$("ai"),{t:i}=$("common"),[s]=l.useForm(),[m,g]=p.useState(!1),[f,S]=p.useState(null),[v,j]=p.useState(""),[n,u]=p.useState(""),[y,L]=p.useState({}),{loading:R,data:A}=_(()=>C.ai.getAiTypeDefinitions(),{refreshDeps:[],onError:c=>{o.error(t("models.fetchTypeDefinitionsFailed",{defaultValue:"Failed to fetch AI type definitions"})),console.error("Failed to fetch AI type definitions:",c)}}),b=p.useMemo(()=>A==null?void 0:A.find(c=>c.provider===n),[A,n]),{loading:I,data:M,refresh:E}=_(()=>C.ai.listAiModels({current:1,page_size:100,search:v}),{refreshDeps:[v],onError:c=>{o.error(t("models.fetchFailed",{defaultValue:"Failed to fetch AI models"})),console.error("Failed to fetch AI models:",c)}}),{loading:T,run:K}=_(({config:c,...d})=>C.ai.createAiModel({config:c??{},...d}),{manual:!0,onSuccess:()=>{o.success(t("models.createSuccess",{defaultValue:"AI model created successfully"})),g(!1),s.resetFields(),E()},onError:c=>{o.error(t("models.createFailed",{defaultValue:"Failed to create AI model"})),console.error("Failed to create AI model:",c)}}),{loading:N,run:H}=_(({id:c,data:d})=>C.ai.updateAiModel({id:c},d),{manual:!0,onSuccess:()=>{o.success(t("models.updateSuccess",{defaultValue:"AI model updated successfully"})),g(!1),s.resetFields(),S(null),E()},onError:c=>{o.error(t("models.updateFailed",{defaultValue:"Failed to update AI model"})),console.error("Failed to update AI model:",c)}}),{runAsync:J}=_(c=>C.ai.deleteAiModel({id:c}),{manual:!0,onSuccess:()=>{o.success(t("models.deleteSuccess",{defaultValue:"AI model deleted successfully"})),E()},onError:c=>{o.error(t("models.deleteFailed",{defaultValue:"Failed to delete AI model"})),console.error("Failed to delete AI model:",c)}}),{runAsync:z}=_(c=>C.ai.testAiModel({id:c}),{manual:!0,onSuccess:()=>{o.success(t("models.testSuccess",{defaultValue:"AI model connection test successful"}))},onError:c=>{o.error(t("models.testFailed",{defaultValue:"AI model connection test failed"})),console.error("Failed to test AI model:",c)}}),{runAsync:B}=_(c=>C.ai.setDefaultAiModel({id:c}),{manual:!0,onSuccess:()=>{o.success(t("models.setDefaultSuccess",{defaultValue:"Default AI model set successfully"})),E()},onError:c=>{o.error(t("models.setDefaultFailed",{defaultValue:"Failed to set default AI model"})),console.error("Failed to set default AI model:",c)}}),F=()=>{S(null),u(""),L({}),s.resetFields(),g(!0)},r=c=>{S(c),u(c.provider);const d=c.config||{},D={name:c.name,description:c.description,provider:c.provider,is_default:c.is_default,config:d,status:c.status};console.log(D),L(D),s.setFieldsValue(D),g(!0)},P=c=>{u(c),b!=null&&b.config_fields&&b.config_fields.forEach(d=>{s.setFieldValue(d.name,void 0)})},ae=c=>{const d={};b!=null&&b.config_fields&&b.config_fields.forEach(Q=>{var oe;const ne=(oe=c.config)==null?void 0:oe[Q.name];ne!=null&&ne!==""&&(d[Q.name]=ne)});const D={name:c.name,description:c.description,provider:c.provider,config:d,is_default:c.is_default,status:c.status};f?H({id:f.id,data:D}):K(D)},ie=c=>{var D;if(!((D=c.data_source)!=null&&D.depends_on))return{};const d={};return c.data_source.depends_on.forEach(Q=>{d[Q]=y[Q]}),d},ue=[{title:t("models.name",{defaultValue:"Name"}),dataIndex:"name",key:"name",render:(c,d)=>e.jsxs(Z,{children:[e.jsx("span",{children:c}),d.is_default&&e.jsx(tt,{title:t("models.defaultModel",{defaultValue:"Default Model"}),children:e.jsx(st,{style:{color:"#faad14"}})})]})},{title:t("models.provider",{defaultValue:"Provider"}),dataIndex:"provider",key:"provider",render:c=>e.jsx(se,{color:"blue",children:c.toUpperCase()})},{title:t("models.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:c=>e.jsx(se,{color:c==="enabled"?"green":"red",children:c==="enabled"?t("common.enabled",{defaultValue:"Enabled"}):t("common.disabled",{defaultValue:"Disabled"})})},{title:i("actions",{defaultValue:"Actions"}),key:"actions",width:200,render:(c,d)=>e.jsx(Ie,{actions:[{key:"test",permission:"ai:models:test",icon:e.jsx(Be,{}),tooltip:t("models.test",{defaultValue:"Test Connection"}),onClick:async()=>z(d.id)},{key:"setDefault",permission:"ai:models:setDefault",icon:e.jsx(lt,{}),tooltip:t("models.setDefault",{defaultValue:"Set as Default"}),onClick:async()=>B(d.id)},{key:"update",permission:"ai:models:update",icon:e.jsx(ve,{}),tooltip:i("edit",{defaultValue:"Edit"}),onClick:async()=>r(d)},{key:"delete",permission:"ai:models:delete",icon:e.jsx(xe,{}),tooltip:i("delete",{defaultValue:"Delete"}),onClick:async()=>J(d.id),danger:!0}]},"actions")}];return e.jsxs("div",{children:[e.jsx(te,{style:{marginBottom:16},children:e.jsxs(Ee,{justify:"space-between",align:"middle",children:[e.jsx(Se,{children:e.jsx(x.Search,{placeholder:t("models.searchPlaceholder",{defaultValue:"Search AI models..."}),style:{width:300},value:v,onChange:c=>j(c.target.value),allowClear:!0})}),e.jsx(Se,{children:e.jsxs(Z,{children:[e.jsx(w,{type:"primary",icon:e.jsx(ce,{}),onClick:E,loading:I,children:i("refresh",{defaultValue:"Refresh"})}),e.jsx(ee,{permission:"ai:models:create",children:e.jsx(w,{type:"primary",icon:e.jsx(_e,{}),onClick:F,children:t("models.create",{defaultValue:"Create AI Model"})})})]})})]})}),e.jsx(te,{children:e.jsx(ke,{columns:ue,dataSource:(M==null?void 0:M.data)||[],loading:I,rowKey:"id",pagination:{total:(M==null?void 0:M.total)||0,current:(M==null?void 0:M.current)||1,pageSize:(M==null?void 0:M.page_size)||10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(c,d)=>t("common.pagination.total",{defaultValue:`${d[0]}-${d[1]} of ${c} items`,start:d[0],end:d[1],total:c})}})}),e.jsx(G,{title:f?t("models.edit",{defaultValue:"Edit AI Model"}):t("models.create",{defaultValue:"Create AI Model"}),open:m,onCancel:()=>{g(!1),s.resetFields(),S(null)},footer:null,width:600,children:e.jsxs(l,{form:s,layout:"vertical",onFinish:ae,onValuesChange:(c,d)=>L(d),children:[e.jsx(l.Item,{name:"name",label:t("models.name",{defaultValue:"Name"}),rules:[{required:!0,message:t("models.nameRequired",{defaultValue:"Please enter model name"})}],children:e.jsx(x,{placeholder:t("models.namePlaceholder",{defaultValue:"Enter model name"})})}),e.jsx(l.Item,{name:"description",label:t("models.description",{defaultValue:"Description"}),children:e.jsx(Nt,{rows:3,placeholder:t("models.descriptionPlaceholder",{defaultValue:"Enter model description"})})}),e.jsx(l.Item,{name:"provider",label:t("models.provider",{defaultValue:"Provider"}),rules:[{required:!0,message:t("models.providerRequired",{defaultValue:"Please select provider"})}],children:e.jsx(q,{loading:R,placeholder:t("models.providerPlaceholder",{defaultValue:"Select provider"}),onChange:P,value:n,options:A==null?void 0:A.map(c=>({label:c.name,value:c.provider}))})}),(X=b==null?void 0:b.config_fields)==null?void 0:X.map(c=>e.jsx(Ge,{field:c,selectedType:n,dependentValues:ie(c),formValues:y},c.name)),e.jsxs(l.Item,{name:"is_default",valuePropName:"checked",children:[e.jsx(le,{})," ",e.jsx("span",{style:{marginLeft:8},children:t("models.setAsDefault",{defaultValue:"Set as default model"})})]}),e.jsx(l.Item,{hidden:!0,name:"status",label:t("models.status",{defaultValue:"Status"}),children:e.jsx(x,{})}),e.jsx(l.Item,{children:e.jsxs(Z,{children:[e.jsx(w,{type:"primary",htmlType:"submit",loading:T||N,children:f?i("update",{defaultValue:"Update"}):i("create",{defaultValue:"Create"})}),e.jsx(w,{onClick:()=>{g(!1),s.resetFields(),S(null),u(""),L({})},children:i("cancel",{defaultValue:"Cancel"})})]})})]})})]})},{TextArea:$t}=x,Bt=()=>{var k;const{t}=$("system"),{t:i}=$("common"),[s]=l.useForm(),[m,g]=p.useState(!1),[f,S]=p.useState(null),[v,j]=p.useState(""),[n,u]=p.useState(!1),[y,L]=p.useState(null),[R,A]=p.useState(""),[b,I]=p.useState(!1),[M,E]=p.useState([]),[T,K]=p.useState({}),[N,H]=p.useState(),{loading:J,data:z,refresh:B}=_(()=>C.system.listToolSets({current:1,page_size:100,search:v,type:N}),{refreshDeps:[v,N],onError:a=>{o.error(t("settings.toolsets.fetchFailed",{defaultValue:"Failed to fetch toolsets"})),console.error("Failed to fetch toolsets:",a)}}),{loading:F,data:r}=_(()=>C.system.getToolSetTypeDefinitions(),{refreshDeps:[],onError:a=>{o.error(t("settings.toolsets.fetchTypeDefinitionsFailed",{defaultValue:"Failed to fetch toolset type definitions"})),console.error("Failed to fetch toolset type definitions:",a)}}),P=p.useMemo(()=>r==null?void 0:r.find(a=>a.tool_set_type===R),[r,R]),{loading:ae,run:ie}=_(a=>C.system.createToolSet({...a,type:a.type}),{manual:!0,onSuccess:()=>{o.success(t("settings.toolsets.createSuccess",{defaultValue:"toolset created successfully"})),g(!1),s.resetFields(),B()},onError:a=>{o.error(t("settings.toolsets.createFailed",{defaultValue:"Failed to create toolset"})),console.error("Failed to create toolset:",a)}}),{loading:ue,run:X}=_(({id:a,data:h})=>C.system.updateToolSet({id:a},{...h,type:h.type}),{manual:!0,onSuccess:()=>{o.success(t("settings.toolsets.updateSuccess",{defaultValue:"toolset updated successfully"})),g(!1),s.resetFields(),S(null),B()},onError:a=>{o.error(t("settings.toolsets.updateFailed",{defaultValue:"Failed to update toolset"})),console.error("Failed to update toolset:",a)}}),{run:c}=_(a=>C.system.deleteToolSet({id:a}),{manual:!0,onSuccess:()=>{o.success(t("settings.toolsets.deleteSuccess",{defaultValue:"toolset deleted successfully"})),B()},onError:a=>{o.error(t("settings.toolsets.deleteFailed",{defaultValue:"Failed to delete toolset"})),console.error("Failed to delete toolset:",a)}}),{runAsync:d}=_(a=>C.system.testToolSet({id:a}),{manual:!0,onSuccess:()=>{o.success(t("settings.toolsets.testSuccess",{defaultValue:"toolset connection test successful"}))},onError:a=>{o.error(t("settings.toolsets.testFailed",{defaultValue:"toolset connection test failed"})),console.error("Failed to test toolset:",a)}}),{loading:D,runAsync:Q}=_(a=>C.system.getToolSetTools({id:a}),{manual:!0,onSuccess:a=>{E(a||[]),I(!0)},onError:a=>{o.error(t("settings.toolsets.fetchToolsFailed",{defaultValue:"Failed to fetch tools"})),console.error("Failed to fetch tools:",a)}}),{runAsync:ne}=_(({id:a,status:h})=>C.system.updateToolSetStatus({id:a},{status:h}),{manual:!0,onSuccess:()=>{o.success(t("settings.toolsets.statusUpdateSuccess",{defaultValue:"Status updated successfully"})),B()},onError:a=>{o.error(t("settings.toolsets.statusUpdateFailed",{defaultValue:"Failed to update status"})),console.error("Failed to update status:",a)}}),oe=()=>{S(null),s.resetFields(),A(""),g(!0)},me=a=>{S(a),A(a.type);const h={...a};if(h.config){const O=r==null?void 0:r.find(U=>U.tool_set_type===a.type);if(O){const U={};O.config_fields.forEach(Y=>{var je,Re;Y.type==="object"&&((je=h.config)!=null&&je[Y.name])?U[Y.name]=JSON.stringify(h.config[Y.name],null,2):((Re=h.config)==null?void 0:Re[Y.name])!==void 0&&(U[Y.name]=h.config[Y.name])}),h.config=U}}s.setFieldsValue(h),g(!0)};console.log(R,r);const fe=a=>{A(a);const h=r==null?void 0:r.find(O=>O.tool_set_type===a);if(h){const O={};h.config_fields.forEach(U=>{if(U.default)switch(U.type){case"number":O[U.name]=Number(U.default);break;case"boolean":O[U.name]=U.default==="true";break;case"array":O[U.name]=U.default.split(",");break;default:O[U.name]=U.default}}),s.setFieldValue("config",O)}else s.setFieldValue("config",void 0)},ye=a=>{if(a.config&&P){const h={};P.config_fields.forEach(O=>{var Y;const U=(Y=a.config)==null?void 0:Y[O.name];if(U!==void 0)if(O.type==="object")try{h[O.name]=typeof U=="string"?JSON.parse(U):U}catch{h[O.name]=U}else h[O.name]=U}),a.config=h}f?X({id:f.id,data:a}):ie(a)},pe=a=>{c(a)},V=a=>{L(a),u(!0)},W=a=>{console.log(new Date,"handleToggleStatus");const h=a.status==="enabled"?"disabled":"enabled";return ne({id:a.id,status:h}).then(()=>{console.log(new Date,"handleToggleStatus1")})},re=a=>{var O;if(!((O=a.data_source)!=null&&O.depends_on)||a.data_source.depends_on.length===0)return{};const h={};return a.data_source.depends_on.forEach(U=>{var je;const Y=(je=T.config)==null?void 0:je[U];Y!==void 0&&(h[U]=Y)}),h};console.log(z);const Ve=[{title:t("settings.toolsets.name",{defaultValue:"Name"}),dataIndex:"name",key:"name"},{title:t("settings.toolsets.type",{defaultValue:"Type"}),dataIndex:"type",key:"type",render:a=>e.jsx(se,{color:"blue",children:a.toUpperCase()})},{title:t("settings.toolsets.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:a=>e.jsx(se,{color:a==="enabled"?"green":"red",children:a==="enabled"?t("common.enabled",{defaultValue:"Enabled"}):t("common.disabled",{defaultValue:"Disabled"})})},{title:i("actions",{defaultValue:"Actions"}),key:"actions",width:200,render:(a,h)=>e.jsx(Ie,{actions:[{key:"test",permission:"system:toolsets:test",tooltip:t("settings.toolsets.test",{defaultValue:"Test Connection"}),icon:e.jsx(at,{}),disabled:h.status!=="enabled",onClick:async()=>d(h.id)},{key:"viewTools",icon:e.jsx(Oe,{}),permission:"system:toolsets:view",disabled:h.status!=="enabled",tooltip:t("settings.toolsets.viewTools",{defaultValue:"View Tools"}),onClick:async()=>Q(h.id)},{key:"viewConfig",icon:e.jsx(it,{}),permission:"system:toolsets:view",tooltip:t("settings.toolsets.viewConfig",{defaultValue:"View Configuration"}),onClick:async()=>V(h.config),disabled:!h.config},{key:"edit",permission:"system:toolsets:update",tooltip:t("settings.toolsets.edit",{defaultValue:"Edit"}),icon:e.jsx(ve,{}),onClick:async()=>me(h)},{key:"toggleStatus",icon:h.status==="enabled"?e.jsx(nt,{}):e.jsx(Be,{}),onClick:async()=>W(h),permission:"system:toolsets:update",tooltip:h.status==="enabled"?i("disable",{defaultValue:"Disable"}):i("enable",{defaultValue:"Enable"})},{key:"delete",icon:e.jsx(xe,{}),permission:"system:toolsets:delete",tooltip:i("delete",{defaultValue:"Delete"}),onClick:async()=>pe(h.id),danger:!0,confirm:{title:t("settings.toolsets.deleteConfirm",{defaultValue:"Are you sure you want to delete this toolset?"}),onConfirm:async()=>pe(h.id),okText:i("confirm",{defaultValue:"Confirm"}),cancelText:i("cancel",{defaultValue:"Cancel"})}}]},"actions")}];return e.jsxs("div",{children:[e.jsx(te,{style:{marginBottom:16},children:e.jsxs(Ee,{justify:"space-between",align:"middle",children:[e.jsx(Se,{children:e.jsxs(Z,{children:[e.jsx(x.Search,{placeholder:t("settings.toolsets.searchPlaceholder",{defaultValue:"Search toolsets..."}),style:{width:300},value:v,onChange:a=>j(a.target.value),allowClear:!0}),e.jsxs(q,{placeholder:t("settings.toolsets.typePlaceholder",{defaultValue:"Select type"}),value:N,onChange:a=>H(a),options:r==null?void 0:r.map(a=>({label:a.name,value:a.tool_set_type})),style:{minWidth:110},allowClear:!0,children:[e.jsx(q.Option,{value:"",children:"All"}),r==null?void 0:r.map(a=>e.jsx(q.Option,{value:a.tool_set_type,children:a.name},a.tool_set_type))]})]})}),e.jsx(Se,{children:e.jsxs(Z,{children:[e.jsx(w,{type:"primary",icon:e.jsx(ce,{}),onClick:B,loading:J,children:i("refresh",{defaultValue:"Refresh"})}),e.jsx(ee,{permission:"system:toolsets:create",children:e.jsx(w,{type:"primary",icon:e.jsx(_e,{}),onClick:oe,children:t("settings.toolsets.create",{defaultValue:"Create Toolset"})})})]})})]})}),e.jsx(te,{children:e.jsx(ke,{columns:Ve,dataSource:(z==null?void 0:z.data)||[],loading:J,rowKey:"id",pagination:{total:(z==null?void 0:z.total)||0,current:(z==null?void 0:z.current)||1,pageSize:(z==null?void 0:z.page_size)||10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(a,h)=>t("common.pagination.total",{defaultValue:`${h[0]}-${h[1]} of ${a} items`,start:h[0],end:h[1],total:a})}})}),e.jsx(G,{title:f?t("settings.toolsets.edit",{defaultValue:"Edit Toolset"}):t("settings.toolsets.create",{defaultValue:"Create Toolset"}),open:m,onCancel:()=>{g(!1),s.resetFields(),S(null),A("")},footer:null,width:600,children:e.jsxs(l,{form:s,layout:"vertical",onFinish:ye,onValuesChange:(a,h)=>K(h),children:[e.jsx(l.Item,{name:"name",label:t("settings.toolsets.name",{defaultValue:"Name"}),rules:[{required:!0,message:t("settings.toolsets.nameRequired",{defaultValue:"Please enter toolset name"})}],children:e.jsx(x,{placeholder:t("settings.toolsets.namePlaceholder",{defaultValue:"Enter toolset name"})})}),e.jsx(l.Item,{name:"description",label:t("settings.toolsets.description",{defaultValue:"Description"}),children:e.jsx($t,{rows:3,placeholder:t("settings.toolsets.descriptionPlaceholder",{defaultValue:"Enter toolset description"})})}),e.jsx(l.Item,{name:"type",label:t("settings.toolsets.type",{defaultValue:"Type"}),rules:[{required:!0,message:t("settings.toolsets.typeRequired",{defaultValue:"Please select type"})}],children:e.jsx(q,{loading:F,placeholder:t("settings.toolsets.typePlaceholder",{defaultValue:"Select type"}),onChange:fe,value:R,options:r==null?void 0:r.map(a=>({label:a.name,value:a.tool_set_type}))})}),(k=P==null?void 0:P.config_fields)==null?void 0:k.map(a=>e.jsx(Ge,{field:a,selectedType:R,dependentValues:re(a),formValues:T},a.name)),e.jsx(l.Item,{hidden:!0,name:"status",label:t("settings.toolsets.status",{defaultValue:"Status"}),children:e.jsx(x,{})}),e.jsx(l.Item,{children:e.jsxs(Z,{children:[e.jsx(w,{type:"primary",htmlType:"submit",loading:ae||ue,children:f?i("update",{defaultValue:"Update"}):i("create",{defaultValue:"Create"})}),e.jsx(w,{onClick:()=>{g(!1),s.resetFields(),S(null),A("")},children:i("cancel",{defaultValue:"Cancel"})})]})})]})}),e.jsx(G,{title:t("settings.toolsets.configuration",{defaultValue:"Configuration"}),open:n,onCancel:()=>u(!1),footer:[e.jsx(w,{onClick:()=>u(!1),children:i("close",{defaultValue:"Close"})},"close")],width:600,children:e.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4,overflow:"auto"},children:JSON.stringify(y,null,2)})}),e.jsx(G,{title:t("settings.toolsets.tools",{defaultValue:"Tools"}),open:b,onCancel:()=>I(!1),footer:[e.jsx(w,{onClick:()=>I(!1),children:i("close",{defaultValue:"Close"})},"close")],width:800,children:e.jsx("div",{style:{maxHeight:"600px",overflow:"auto"},children:D?e.jsx("div",{style:{textAlign:"center",padding:40},children:e.jsx(ce,{style:{fontSize:24},spin:!0})}):M.length===0?e.jsx("div",{style:{textAlign:"center",padding:40,color:"#999"},children:t("settings.toolsets.noTools",{defaultValue:"No tools available"})}):M.map((a,h)=>{var O,U,Y;return e.jsx(te,{style:{marginBottom:16},title:e.jsxs(Z,{children:[e.jsx(Oe,{}),e.jsx("strong",{children:((O=a.function)==null?void 0:O.name)||"Unknown"})]}),children:e.jsxs(Ee,{gutter:16,children:[e.jsxs(Se,{span:24,children:[e.jsx("p",{children:e.jsxs("strong",{children:[t("settings.toolsets.description",{defaultValue:"Description"}),":"]})}),e.jsx("p",{style:{marginBottom:16},children:((U=a.function)==null?void 0:U.description)||"-"})]}),((Y=a.function)==null?void 0:Y.parameters)&&e.jsxs(Se,{span:24,children:[e.jsx("p",{children:e.jsxs("strong",{children:[t("settings.toolsets.parameters",{defaultValue:"Parameters"}),":"]})}),e.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4,overflow:"auto",fontSize:12},children:JSON.stringify(a.function.parameters,null,2)})]})]})},h)})})})]})},{TextArea:Ne}=x,Ht=()=>{const{t}=$("system"),{t:i}=$("common"),s=Fe(),[m]=l.useForm(),[g,f]=p.useState(""),[S,v]=p.useState(),[j,n]=p.useState(!1),[u,y]=p.useState(null),[L,R]=p.useState(!1),[A]=l.useForm(),{loading:b,data:I,refresh:M}=_(()=>C.system.listSkills({current:1,page_size:100,search:g||void 0,domain:S}),{refreshDeps:[g,S],onError:()=>{o.error(t("settings.skills.fetchFailed",{defaultValue:"Failed to fetch skills"}))}}),{data:E}=_(()=>C.system.listSkillDomains()),T=E??[],K=(I==null?void 0:I.data)??[],N=(I==null?void 0:I.total)??0,{loading:H,run:J}=_(d=>C.system.createSkill(d),{manual:!0,onSuccess:()=>{o.success(t("settings.skills.createSuccess",{defaultValue:"Skill created"})),n(!1),m.resetFields(),M()},onError:()=>{o.error(t("settings.skills.createFailed",{defaultValue:"Failed to create skill"}))}}),{loading:z,run:B}=_(({id:d,body:D})=>C.system.updateSkill({id:d},D),{manual:!0,onSuccess:()=>{o.success(t("settings.skills.updateSuccess",{defaultValue:"Skill updated"})),n(!1),y(null),m.resetFields(),M()},onError:()=>{o.error(t("settings.skills.updateFailed",{defaultValue:"Failed to update skill"}))}}),{run:F}=_(d=>C.system.deleteSkill({id:d}),{manual:!0,onSuccess:()=>{o.success(t("settings.skills.deleteSuccess",{defaultValue:"Skill deleted"})),M()},onError:()=>{o.error(t("settings.skills.deleteFailed",{defaultValue:"Failed to delete skill"}))}}),{loading:r,run:P}=_(d=>C.system.uploadSkill(d.body,d.file),{manual:!0,onSuccess:()=>{o.success(t("settings.skills.uploadSuccess",{defaultValue:"Skill uploaded"})),R(!1),A.resetFields(),M()},onError:()=>{o.error(t("settings.skills.uploadFailed",{defaultValue:"Upload failed"}))}}),ae=()=>{y(null),m.resetFields(),n(!0)},ie=d=>{y(d),m.setFieldsValue({name:d.name,description:d.description,category:d.category,domain:d.domain}),n(!0)},ue=()=>{m.validateFields().then(d=>{u?B({id:u.id,body:{name:d.name,description:d.description??"",category:d.category??"",domain:d.domain??""}}):J({name:d.name,description:d.description??"",category:d.category??"",domain:d.domain??"",content:d.content??""})})},X=()=>{var oe,me;const d=(oe=A.getFieldValue("file"))==null?void 0:oe.fileList,D=((me=d==null?void 0:d[0])==null?void 0:me.originFileObj)??(d==null?void 0:d[0]);if(!D){o.error(t("settings.skills.selectFile",{defaultValue:"Please select a file"}));return}const Q=A.getFieldValue("category"),ne=A.getFieldValue("domain");P({body:{category:Q,domain:ne},file:D})},c=[{title:t("settings.skills.name",{defaultValue:"Name"}),dataIndex:"name",key:"name"},{title:t("settings.skills.description",{defaultValue:"Description"}),dataIndex:"description",key:"description",ellipsis:!0},{title:t("settings.skills.category",{defaultValue:"Category"}),dataIndex:"category",key:"category",render:d=>d?e.jsx(se,{children:d}):"-"},{title:t("settings.skills.domain",{defaultValue:"Domain"}),dataIndex:"domain",key:"domain",render:d=>d?e.jsx(se,{color:"blue",children:d}):"-"},{title:i("actions",{defaultValue:"Actions"}),key:"actions",render:(d,D)=>e.jsxs(Z,{children:[e.jsx(ee,{permission:"system:skills:edit_files",children:e.jsx(w,{type:"link",size:"small",icon:e.jsx(ot,{}),onClick:()=>s(`/system/settings/skills/${D.id}/edit`),children:t("settings.skills.editFiles",{defaultValue:"Edit files"})})}),e.jsx(ee,{permission:"system:skills:view",children:e.jsx(w,{type:"link",size:"small",icon:e.jsx(He,{}),onClick:()=>s(`/system/settings/skills/${D.id}/preview`),children:i("preview",{defaultValue:"Preview"})})}),e.jsx(ee,{permission:"system:skills:update",children:e.jsx(w,{type:"link",size:"small",icon:e.jsx(ve,{}),onClick:()=>ie(D),children:i("edit",{defaultValue:"Edit"})})}),e.jsx(ee,{permission:"system:skills:delete",children:e.jsx(w,{type:"link",size:"small",danger:!0,icon:e.jsx(xe,{}),onClick:()=>G.confirm({title:i("confirmDelete",{defaultValue:"Confirm delete?"}),onOk:()=>F(D.id)}),children:i("delete",{defaultValue:"Delete"})})})]})}];return e.jsxs(te,{title:t("settings.skills.title",{defaultValue:"AI Agent Skills"}),extra:e.jsxs(Z,{children:[e.jsx(x.Search,{placeholder:i("search",{defaultValue:"Search"}),allowClear:!0,onSearch:f,style:{width:200}}),e.jsx(q,{placeholder:t("settings.skills.domain",{defaultValue:"Domain"}),allowClear:!0,style:{width:120},value:S,onChange:v,options:T.map(d=>({value:d,label:d}))}),e.jsx(w,{icon:e.jsx(ce,{}),onClick:()=>M(),children:i("refresh",{defaultValue:"Refresh"})}),e.jsx(ee,{permission:"system:skills:create",children:e.jsx(w,{type:"primary",icon:e.jsx(_e,{}),onClick:ae,children:t("settings.skills.create",{defaultValue:"Create skill"})})}),e.jsx(ee,{permission:"system:skills:create",children:e.jsx(w,{icon:e.jsx(Le,{}),onClick:()=>R(!0),children:t("settings.skills.upload",{defaultValue:"Upload"})})})]}),children:[e.jsx(ke,{rowKey:"id",loading:b,columns:c,dataSource:K,pagination:{total:N,pageSize:10,showSizeChanger:!0}}),e.jsx(G,{title:u?t("settings.skills.editSkill",{defaultValue:"Edit skill"}):t("settings.skills.createSkill",{defaultValue:"Create skill"}),open:j,onOk:ue,onCancel:()=>{n(!1),y(null)},confirmLoading:H||z,width:560,children:e.jsxs(l,{form:m,layout:"vertical",children:[e.jsx(l.Item,{name:"name",label:t("settings.skills.name",{defaultValue:"Name"}),rules:[{required:!0}],children:e.jsx(x,{})}),e.jsx(l.Item,{name:"description",label:t("settings.skills.description",{defaultValue:"Description"}),children:e.jsx(Ne,{rows:2})}),e.jsx(l.Item,{name:"category",label:t("settings.skills.category",{defaultValue:"Category"}),children:e.jsx(x,{})}),e.jsx(l.Item,{name:"domain",label:t("settings.skills.domain",{defaultValue:"Domain"}),children:e.jsx(q,{allowClear:!0,placeholder:i("optional",{defaultValue:"Optional"}),options:T.map(d=>({value:d,label:d}))})}),!u&&e.jsx(l.Item,{name:"content",label:t("settings.skills.initialContent",{defaultValue:"Initial SKILL.md content (optional)"}),children:e.jsx(Ne,{rows:6,placeholder:`---
name: my-skill
description: ...
---

# My Skill`})})]})}),e.jsx(G,{title:t("settings.skills.upload",{defaultValue:"Upload skill"}),open:L,onOk:X,onCancel:()=>R(!1),confirmLoading:r,children:e.jsxs(l,{form:A,layout:"vertical",children:[e.jsx(l.Item,{name:"file",label:t("settings.skills.file",{defaultValue:"File (.md or .zip)"}),rules:[{required:!0}],children:e.jsx(rt,{maxCount:1,beforeUpload:()=>!1,accept:".md,.zip",children:e.jsx(w,{icon:e.jsx(Le,{}),children:i("selectFile",{defaultValue:"Select file"})})})}),e.jsx(l.Item,{name:"category",label:t("settings.skills.category",{defaultValue:"Category"}),children:e.jsx(x,{})}),e.jsx(l.Item,{name:"domain",label:t("settings.skills.domain",{defaultValue:"Domain"}),children:e.jsx(q,{allowClear:!0,placeholder:i("optional",{defaultValue:"Optional"}),options:T.map(d=>({value:d,label:d}))})})]})})]})},{TextArea:Kt}=x,Wt=()=>{const t=Fe(),{t:i}=$("system"),{t:s}=$("common"),[m]=l.useForm(),[g,f]=p.useState(!1),[S,v]=p.useState(null),[j,n]=p.useState(""),[u,y]=p.useState(1),[L,R]=p.useState(10),{loading:A,data:b,refresh:I}=_(()=>bt({current:u,page_size:L,search:j}),{refreshDeps:[u,L,j],onError:r=>{o.error(i("settings.organizations.fetchFailed",{defaultValue:"Failed to fetch organizations"})),console.error("Failed to fetch organizations:",r)}}),{loading:M,run:E}=_(r=>St(r),{manual:!0,onSuccess:()=>{o.success(i("settings.organizations.createSuccess",{defaultValue:"Organization created successfully"})),f(!1),m.resetFields(),v(null),I()},onError:r=>{o.error((r==null?void 0:r.err)||i("settings.organizations.createFailed",{defaultValue:"Failed to create organization"}))}}),{loading:T,run:K}=_(({id:r,...P})=>kt({id:r},P),{manual:!0,onSuccess:()=>{o.success(i("settings.organizations.updateSuccess",{defaultValue:"Organization updated successfully"})),f(!1),m.resetFields(),v(null),I()},onError:r=>{o.error((r==null?void 0:r.err)||i("settings.organizations.updateFailed",{defaultValue:"Failed to update organization"}))}}),{run:N}=_(r=>vt({id:r}),{manual:!0,onSuccess:()=>{o.success(i("settings.organizations.deleteSuccess",{defaultValue:"Organization deleted successfully"})),I()},onError:r=>{o.error((r==null?void 0:r.err)||i("settings.organizations.deleteFailed",{defaultValue:"Failed to delete organization"}))}}),H=()=>{v(null),m.resetFields(),m.setFieldsValue({status:"active"}),f(!0)},J=r=>{v(r),m.setFieldsValue({name:r.name,description:r.description,status:r.status}),f(!0)},z=r=>{G.confirm({title:i("settings.organizations.deleteConfirm",{defaultValue:"Delete Organization"}),content:i("settings.organizations.deleteConfirmContent",{defaultValue:`Are you sure you want to delete organization "${r.name}"? This action cannot be undone.`}),onOk:()=>N(r.id)})},B=()=>{m.validateFields().then(r=>{S?K({id:S.id,...r}):E(r)})},F=[{title:i("settings.organizations.name",{defaultValue:"Name"}),dataIndex:"name",key:"name"},{title:i("settings.organizations.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:i("settings.organizations.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:r=>e.jsx(se,{color:r==="active"?"green":"default",children:r==="active"?i("settings.organizations.active",{defaultValue:"Active"}):i("settings.organizations.disabled",{defaultValue:"Disabled"})})},{title:s("actions",{defaultValue:"Actions"}),key:"actions",render:(r,P)=>e.jsx(Ie,{actions:[{key:"view",label:s("view",{defaultValue:"View"}),icon:e.jsx(He,{}),onClick:async()=>t(`/system/settings/organizations/${P.id}`),permission:"system:organization:view"},{key:"edit",label:s("edit",{defaultValue:"Edit"}),icon:e.jsx(ve,{}),onClick:async()=>J(P),permission:"system:organization:update"},{key:"delete",label:s("delete",{defaultValue:"Delete"}),icon:e.jsx(xe,{}),danger:!0,onClick:async()=>z(P),permission:"system:organization:delete"}]})}];return e.jsxs(te,{title:i("settings.organizations.title",{defaultValue:"Organization Management"}),extra:e.jsxs(Z,{children:[e.jsx(w,{icon:e.jsx(ce,{}),onClick:I,children:s("refresh",{defaultValue:"Refresh"})}),e.jsx(ee,{permission:"system:organization:create",children:e.jsx(w,{type:"primary",icon:e.jsx(_e,{}),onClick:H,children:i("settings.organizations.create",{defaultValue:"Create Organization"})})})]}),children:[e.jsxs(Z,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsx(x.Search,{placeholder:i("settings.organizations.searchPlaceholder",{defaultValue:"Search organizations..."}),allowClear:!0,onSearch:r=>{n(r),y(1)},style:{width:300}}),e.jsx(ke,{columns:F,dataSource:(b==null?void 0:b.data)||[],loading:A,rowKey:"id",pagination:{current:u,pageSize:L,total:(b==null?void 0:b.total)||0,showSizeChanger:!0,showTotal:(r,P)=>i("common.pagination.total",{defaultValue:`${P[0]}-${P[1]} of ${r} items`,start:P[0],end:P[1],total:r}),onChange:(r,P)=>{y(r),R(P)}}})]}),e.jsx(G,{title:S?i("settings.organizations.edit",{defaultValue:"Edit Organization"}):i("settings.organizations.create",{defaultValue:"Create Organization"}),open:g,onOk:B,onCancel:()=>{f(!1),m.resetFields(),v(null)},confirmLoading:M||T,width:600,children:e.jsxs(l,{form:m,layout:"vertical",children:[e.jsx(l.Item,{name:"name",label:i("settings.organizations.name",{defaultValue:"Name"}),rules:[{required:!0,message:i("settings.organizations.nameRequired",{defaultValue:"Please enter organization name"})}],children:e.jsx(x,{})}),e.jsx(l.Item,{name:"description",label:i("settings.organizations.description",{defaultValue:"Description"}),children:e.jsx(Kt,{rows:3})}),e.jsx(l.Item,{name:"status",label:i("settings.organizations.status",{defaultValue:"Status"}),rules:[{required:!0}],children:e.jsxs(q,{children:[e.jsx(q.Option,{value:"active",children:i("settings.organizations.active",{defaultValue:"Active"})}),e.jsx(q.Option,{value:"disabled",children:i("settings.organizations.disabled",{defaultValue:"Disabled"})})]})})]})})]})},Gt=({transformItems:t=i=>i})=>{const{t:i}=$("system"),s=Fe(),m=dt(),S=m.hash.replace("#","")||"base",{enableMultiOrg:v}=Tt(),{hasPermission:j}=At(),n=[{key:"base",label:i("settings.tabs.base",{defaultValue:"Base Settings"}),children:e.jsx(qt,{}),hidden:!j("system:settings:update")},{key:"security",label:i("settings.tabs.security",{defaultValue:"Security Settings"}),children:e.jsx(Pt,{}),hidden:!j("system:security:update")},{key:"oauth",label:i("settings.tabs.oauth",{defaultValue:"OAuth Settings"}),children:e.jsx(Rt,{}),hidden:!j("system:settings:update")},{key:"ldap",label:i("settings.tabs.ldap",{defaultValue:"LDAP Settings"}),children:e.jsx(Lt,{}),hidden:!j("system:settings:update")},{key:"smtp",label:i("settings.tabs.smtp",{defaultValue:"SMTP Settings"}),children:e.jsx(Ut,{}),hidden:!j("system:settings:update")},{key:"ai-models",label:i("settings.tabs.aiModels",{defaultValue:"AI Models"}),children:e.jsx(Dt,{}),hidden:!j("ai:models:view")},{key:"ai-toolsets",label:i("settings.tabs.toolSets",{defaultValue:"Tool Sets"}),children:e.jsx(Bt,{}),hidden:!j("system:toolsets:view")},{key:"skills",label:i("settings.tabs.skills",{defaultValue:"Skills"}),children:e.jsx(Ht,{}),hidden:!j("system:skills:view")},...v?[{key:"organizations",label:i("settings.tabs.organizations",{defaultValue:"Organizations"}),children:e.jsx(Wt,{}),hidden:!j("system:organization:view")}]:[]];return e.jsx(te,{title:i("settings.title",{defaultValue:"System Settings"}),children:e.jsx($e,{defaultActiveKey:S,onChange:u=>{s(`${m.pathname}#${u}`)},items:t(n.filter(u=>!u.hidden),i)})})},os=Object.freeze(Object.defineProperty({__proto__:null,default:Gt},Symbol.toStringTag,{value:"Module"})),Zt=()=>{var fe,ye,pe;const t=Fe(),{id:i}=Me(),{t:s}=$("system"),{t:m}=$("common"),[g]=l.useForm(),[f]=l.useForm(),[S,v]=p.useState(!1),[j,n]=p.useState(!1),[u,y]=p.useState(null),[L,R]=p.useState(""),[A,b]=p.useState(1),[I,M]=p.useState(10),{data:E,loading:T,refresh:K}=_(()=>Ft({id:i}),{ready:!!i,onError:V=>{o.error(s("settings.organizations.fetchFailed",{defaultValue:"Failed to fetch organization"})),console.error("Failed to fetch organization:",V)}}),{data:N,loading:H,refresh:J}=_(()=>_t({id:i,current:A,page_size:I,search:L}),{ready:!!i,refreshDeps:[i,A,I,L],onError:V=>{o.error(s("settings.organizations.users.fetchFailed",{defaultValue:"Failed to fetch organization users"})),console.error("Failed to fetch organization users:",V)}}),{data:z,loading:B}=_(()=>Et({current:1,page_size:1e3}),{ready:S}),{data:F,loading:r}=_(()=>zt({organization_id:i,current:1,page_size:1e3}),{ready:!!i}),{loading:P,run:ae}=_(V=>Ct({id:i},V),{manual:!0,onSuccess:()=>{o.success(s("settings.organizations.users.addSuccess",{defaultValue:"User added to organization successfully"})),v(!1),g.resetFields(),J()},onError:V=>{o.error((V==null?void 0:V.err)||s("settings.organizations.users.addFailed",{defaultValue:"Failed to add user to organization"}))}}),{loading:ie,run:ue}=_(V=>wt({id:i,user_id:u==null?void 0:u.id},V),{manual:!0,onSuccess:()=>{o.success(s("settings.organizations.users.updateRolesSuccess",{defaultValue:"User roles updated successfully"})),n(!1),f.resetFields(),y(null),J()},onError:V=>{o.error((V==null?void 0:V.err)||s("settings.organizations.users.updateRolesFailed",{defaultValue:"Failed to update user roles"}))}}),{run:X}=_(V=>It({id:i,user_id:V}),{manual:!0,onSuccess:()=>{o.success(s("settings.organizations.users.removeSuccess",{defaultValue:"User removed from organization successfully"})),J()},onError:V=>{o.error((V==null?void 0:V.err)||s("settings.organizations.users.removeFailed",{defaultValue:"Failed to remove user from organization"}))}}),c=()=>{v(!0),g.resetFields()},d=V=>{var W;y(V),f.setFieldsValue({role_ids:((W=V.organization_roles)==null?void 0:W.map(re=>re.id))||[]}),n(!0)},D=V=>{G.confirm({title:s("settings.organizations.users.removeConfirm",{defaultValue:"Remove User"}),content:s("settings.organizations.users.removeConfirmContent",{defaultValue:`Are you sure you want to remove user "${V.full_name||V.username}" from this organization? This will also remove all their roles in this organization.`}),onOk:()=>X(V.id)})},Q=()=>{g.validateFields().then(V=>{ae(V)})},ne=()=>{f.validateFields().then(V=>{ue(V)})},oe=((fe=z==null?void 0:z.data)==null?void 0:fe.filter(V=>{var W;return!((W=N==null?void 0:N.data)!=null&&W.some(re=>re.id===V.id))}))||[],me=[{title:s("settings.organizations.users.username",{defaultValue:"Username"}),dataIndex:"username",key:"username"},{title:s("settings.organizations.users.email",{defaultValue:"Email"}),dataIndex:"email",key:"email"},{title:s("settings.organizations.users.fullName",{defaultValue:"Full Name"}),dataIndex:"full_name",key:"full_name"},{title:s("settings.organizations.users.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:V=>e.jsx(se,{color:V==="active"?"green":"default",children:V==="active"?s("settings.organizations.active",{defaultValue:"Active"}):V})},{title:s("settings.organizations.users.roles",{defaultValue:"Roles"}),key:"roles",render:(V,W)=>{var re;return e.jsx(Z,{wrap:!0,children:((re=W.organization_roles)==null?void 0:re.map(Ve=>e.jsx(se,{children:Ve.name},Ve.id)))||e.jsx(se,{children:"No roles"})})}},{title:m("actions",{defaultValue:"Actions"}),key:"actions",render:(V,W)=>e.jsx(Ie,{actions:[{key:"edit",label:s("settings.organizations.users.editRoles",{defaultValue:"Edit Roles"}),icon:e.jsx(ve,{}),onClick:async()=>d(W)},{key:"delete",label:s("settings.organizations.users.remove",{defaultValue:"Remove"}),icon:e.jsx(xe,{}),danger:!0,onClick:async()=>D(W)}]})}];return e.jsxs("div",{children:[e.jsx(te,{title:e.jsxs(Z,{children:[e.jsx(w,{icon:e.jsx(ut,{}),onClick:()=>t("/system/settings#organizations"),children:m("back",{defaultValue:"Back"})}),e.jsxs("span",{children:[s("settings.organizations.detail",{defaultValue:"Organization Detail"}),": ",E==null?void 0:E.name]})]}),extra:e.jsx(w,{icon:e.jsx(ce,{}),onClick:()=>{K(),J()},children:m("refresh",{defaultValue:"Refresh"})}),loading:T,children:e.jsxs(de,{column:2,bordered:!0,children:[e.jsx(de.Item,{label:s("settings.organizations.name",{defaultValue:"Name"}),children:E==null?void 0:E.name}),e.jsx(de.Item,{label:s("settings.organizations.status",{defaultValue:"Status"}),children:e.jsx(se,{color:(E==null?void 0:E.status)==="active"?"green":"default",children:(E==null?void 0:E.status)==="active"?s("settings.organizations.active",{defaultValue:"Active"}):s("settings.organizations.disabled",{defaultValue:"Disabled"})})}),e.jsx(de.Item,{label:s("settings.organizations.description",{defaultValue:"Description"}),span:2,children:(E==null?void 0:E.description)||"-"})]})}),e.jsx(te,{title:s("settings.organizations.users.title",{defaultValue:"Organization Users"}),extra:e.jsx(w,{type:"primary",icon:e.jsx(_e,{}),onClick:c,children:s("settings.organizations.users.add",{defaultValue:"Add User"})}),style:{marginTop:16},children:e.jsxs(Z,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsx(x.Search,{placeholder:s("settings.organizations.users.searchPlaceholder",{defaultValue:"Search users..."}),allowClear:!0,onSearch:V=>{R(V),b(1)},style:{width:300}}),e.jsx(ke,{columns:me,dataSource:(N==null?void 0:N.data)||[],loading:H,rowKey:"id",pagination:{current:A,pageSize:I,total:(N==null?void 0:N.total)||0,showSizeChanger:!0,showTotal:V=>m("pagination.total",{defaultValue:`Total ${V} items`}),onChange:(V,W)=>{b(V),M(W)}}})]})}),e.jsx(G,{title:s("settings.organizations.users.add",{defaultValue:"Add User"}),open:S,onOk:Q,onCancel:()=>{v(!1),g.resetFields()},confirmLoading:P,width:600,children:e.jsxs(l,{form:g,layout:"vertical",children:[e.jsx(l.Item,{name:"user_id",label:s("settings.organizations.users.user",{defaultValue:"User"}),rules:[{required:!0,message:s("settings.organizations.users.userRequired",{defaultValue:"Please select a user"})}],children:e.jsx(q,{showSearch:!0,placeholder:s("settings.organizations.users.selectUser",{defaultValue:"Select a user"}),loading:B,filterOption:(V,W)=>((W==null?void 0:W.label)??"").toLowerCase().includes(V.toLowerCase()),options:oe.map(V=>({label:`${V.full_name||V.username} (${V.email})`,value:V.id}))})}),e.jsx(l.Item,{name:"role_ids",label:s("settings.organizations.users.roles",{defaultValue:"Roles"}),children:e.jsx(q,{mode:"multiple",placeholder:s("settings.organizations.users.selectRoles",{defaultValue:"Select roles (optional)"}),loading:r,options:((ye=F==null?void 0:F.data)==null?void 0:ye.map(V=>({label:V.name,value:V.id})))||[]})})]})}),e.jsx(G,{title:s("settings.organizations.users.editRoles",{defaultValue:"Edit Roles"}),open:j,onOk:ne,onCancel:()=>{n(!1),f.resetFields(),y(null)},confirmLoading:ie,width:600,children:e.jsxs(l,{form:f,layout:"vertical",children:[e.jsx(l.Item,{label:s("settings.organizations.users.user",{defaultValue:"User"}),children:e.jsx(x,{value:(u==null?void 0:u.full_name)||(u==null?void 0:u.username),disabled:!0})}),e.jsx(l.Item,{name:"role_ids",label:s("settings.organizations.users.roles",{defaultValue:"Roles"}),children:e.jsx(q,{mode:"multiple",placeholder:s("settings.organizations.users.selectRoles",{defaultValue:"Select roles"}),loading:r,options:((pe=F==null?void 0:F.data)==null?void 0:pe.map(V=>({label:V.name,value:V.id})))||[]})})]})})]})},rs=Object.freeze(Object.defineProperty({__proto__:null,default:Zt},Symbol.toStringTag,{value:"Module"})),{TextArea:De}=x,Jt=t=>t.toLowerCase().endsWith(".md");function Je(t){return t.map(i=>{var s;return{key:i.path,title:i.name,isLeaf:!i.is_dir,icon:i.is_dir?e.jsx(Ke,{}):e.jsx(We,{}),children:(s=i.children)!=null&&s.length?Je(i.children):void 0}})}function Ae(t){return t.includes("/")?t.replace(/\/[^/]+$/,""):""}const Xt=()=>{const{id:t}=Me(),i=Fe(),{t:s}=$("system"),[m,g]=p.useState(null),[f,S]=p.useState(null),[v,j]=p.useState(!1),[n,u]=p.useState(""),[y,L]=p.useState(!1),[R,A]=p.useState([]),[b,I]=p.useState(!1),[M,E]=p.useState(!1),[T,K]=p.useState(""),[N]=l.useForm(),[H,J]=p.useState(null),[z,B]=p.useState(null),[F,r]=p.useState(""),[P]=l.useForm(),{data:ae}=_(()=>t?C.system.getSkill({id:t}):Promise.reject(new Error("No id")),{refreshDeps:[t],ready:!!t}),{data:ie,loading:ue,refresh:X}=_(()=>t?C.system.listSkillFilesTree({id:t}):Promise.reject(new Error("No id")),{refreshDeps:[t],ready:!!t,onSuccess:k=>{if(!m){for(const a of k)if(!a.is_dir&&a.name==="SKILL.md"){S(a.path),g(a.path),j(!1);return}for(const a of k)if(!a.is_dir&&a.name==="SKILLS.md"){S(a.path),g(a.path),j(!1);return}}}}),c=(ae==null?void 0:ae.data)??ae,d=(ie==null?void 0:ie.data)??ie??[],D=p.useMemo(()=>Je(d),[d]),Q=v&&f?f:m?Ae(m):"";p.useEffect(()=>{m&&t?(C.system.getSkillFile({id:t,path:m}).then(k=>u((k==null?void 0:k.data)??k??"")).catch(()=>o.error(s("settings.skills.editor.failedToLoadFile",{defaultValue:"Failed to load file"}))),L(!1)):(u(""),L(!1))},[t,m,s]);const ne=()=>{!t||!m||C.system.putSkillFile({id:t,path:m},n).then(()=>{o.success(s("settings.skills.editor.saved",{defaultValue:"Saved"})),L(!1)}).catch(()=>o.error(s("settings.skills.editor.failedToSave",{defaultValue:"Failed to save"})))},oe=(k,a)=>{const h=String(a.node.key),O=!a.node.isLeaf;S(h),j(O),a.node.isLeaf?g(h):g(null)},me=k=>{k.event.preventDefault(),J({path:String(k.node.key),isDir:!k.node.isLeaf,x:k.event.clientX,y:k.event.clientY})},fe=p.useCallback(()=>J(null),[]),ye=p.useCallback(k=>{if(!t||!H)return;const{path:a,isDir:h}=H;switch(fe(),k){case"open":g(a),S(a),j(!1);break;case"rename":{const O=a.includes("/")?a.split("/").pop():a;B({path:a,isDir:h}),r(O),setTimeout(()=>P.setFieldsValue({name:O}),0);break}case"delete":G.confirm({title:s("settings.skills.editor.deleteConfirm",{defaultValue:"Delete?"}),content:h?s("settings.skills.editor.deleteConfirmContentDir",{path:a,defaultValue:`Delete ${a}? This will remove the folder and all its contents.`}):s("settings.skills.editor.deleteConfirmContent",{path:a,defaultValue:`Delete ${a}?`}),onOk:()=>C.system.deleteSkillPath({id:t,path:a}).then(()=>{o.success(s("settings.skills.editor.deleted",{defaultValue:"Deleted"})),m===a&&(g(null),u("")),f===a&&(S(null),j(!1)),X()}).catch(()=>o.error(s("settings.skills.editor.failedToDelete",{defaultValue:"Failed to delete"})))});break;case"newFile":S(a),j(h),I(!0);break;case"newDir":S(a),j(h),E(!0);break}},[t,H,fe,X,m,f,P,s]),pe=()=>{if(!t||!z)return;const k=(P.getFieldValue("name")??F).trim();if(!k){o.error(s("settings.skills.editor.nameRequired",{defaultValue:"Name is required"}));return}if(!z.isDir&&!/\.(md|txt)$/i.test(k)){o.error(s("settings.skills.editor.fileNameExtension",{defaultValue:"File name must end with .md or .txt"}));return}const a=Ae(z.path),h=a?`${a}/${k}`:k;if(h===z.path){B(null);return}C.system.moveSkillPath({id:t},{from_path:z.path,to_path:h}).then(()=>{o.success(s("settings.skills.editor.renamed",{defaultValue:"Renamed"})),m===z.path&&g(h),f===z.path&&S(h),B(null),X()}).catch(()=>o.error(s("settings.skills.editor.failedToRename",{defaultValue:"Failed to rename"})))},V=k=>{if(!t)return;const a=String(k.dragNode.key),h=String(k.dragNode.title);let O;if(k.dropToGap){const U=Ae(String(k.node.key));O=U?`${U}/${h}`:h}else O=`${k.node.key}/${h}`;O!==a&&C.system.moveSkillPath({id:t},{from_path:a,to_path:O}).then(()=>{o.success(s("settings.skills.editor.moved",{defaultValue:"Moved"})),m===a&&g(O),f===a&&S(O),X()}).catch(()=>o.error(s("settings.skills.editor.failedToMove",{defaultValue:"Failed to move"})))},W=()=>{const k=T.trim();if(!k||!t)return;const a=Q?`${Q}/${k}`:k;if(!/\.(md|txt)$/i.test(k)){o.error(s("settings.skills.editor.onlyMdTxtAllowed",{defaultValue:"Only .md and .txt files are allowed"}));return}C.system.putSkillFile({id:t,path:a},"").then(()=>{o.success(s("settings.skills.editor.fileCreated",{defaultValue:"File created"})),I(!1),K(""),X(),g(a),u("")}).catch(()=>o.error(s("settings.skills.editor.failedToCreateFile",{defaultValue:"Failed to create file"})))},re=()=>{var h;const k=(h=N.getFieldValue("name"))==null?void 0:h.trim();if(!k||!t)return;const a=Q?`${Q}/${k}`:k;C.system.createSkillDir({id:t},{path:a}).then(()=>{o.success(s("settings.skills.editor.folderCreated",{defaultValue:"Folder created"})),E(!1),N.resetFields(),X()}).catch(()=>o.error(s("settings.skills.editor.failedToCreateFolder",{defaultValue:"Failed to create folder"})))},Ve=()=>{const k=f||m;!t||!k||G.confirm({title:s("settings.skills.editor.deleteConfirm",{defaultValue:"Delete?"}),content:s("settings.skills.editor.deleteConfirmContent",{path:k,defaultValue:`Delete ${k}?`}),onOk:()=>C.system.deleteSkillPath({id:t,path:k}).then(()=>{o.success(s("settings.skills.editor.deleted",{defaultValue:"Deleted"})),m===k&&(g(null),u("")),f===k&&(S(null),j(!1)),X()}).catch(()=>o.error(s("settings.skills.editor.failedToDelete",{defaultValue:"Failed to delete"})))})};return t?e.jsxs(te,{title:(c==null?void 0:c.name)??s("settings.skills.editor.skill",{defaultValue:"Skill"}),extra:e.jsx(w,{type:"link",onClick:()=>i("/system/settings#skills"),children:s("settings.skills.editor.backToSkills",{defaultValue:"Back to Skills"})}),style:{height:"100%",display:"flex",flexDirection:"column",minHeight:"calc(100vh - 160px)"},bodyStyle:{flex:1,minHeight:0,display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{display:"flex",gap:16,flex:1,minHeight:0},children:[e.jsxs("div",{style:{width:260,border:"1px solid #d9d9d9",borderRadius:8,padding:8,display:"flex",flexDirection:"column",minHeight:0},children:[e.jsxs(Z,{style:{marginBottom:8,flexShrink:0},children:[e.jsx(w,{size:"small",icon:e.jsx(_e,{}),onClick:()=>I(!0),children:s("settings.skills.editor.file",{defaultValue:"File"})}),e.jsx(w,{size:"small",icon:e.jsx(Ke,{}),onClick:()=>E(!0),children:s("settings.skills.editor.folder",{defaultValue:"Folder"})})]}),ue?e.jsx("div",{children:s("settings.skills.editor.loading",{defaultValue:"Loading..."})}):e.jsx("div",{style:{flex:1,minHeight:0,overflow:"auto"},children:e.jsx(ct,{showIcon:!0,blockNode:!0,draggable:!0,expandedKeys:R,onExpand:k=>A(k),selectedKeys:f?[f]:[],onSelect:oe,onRightClick:me,onDrop:V,treeData:D})})]}),e.jsxs("div",{style:{flex:1,minWidth:0,display:"flex",flexDirection:"column",minHeight:0},children:[m&&e.jsxs(e.Fragment,{children:[e.jsxs(Z,{style:{marginBottom:8,flexShrink:0},children:[e.jsx("span",{children:m}),e.jsx(w,{type:"primary",icon:e.jsx(we,{}),disabled:!y,onClick:ne,children:s("settings.skills.editor.save",{defaultValue:"Save"})}),e.jsx(w,{danger:!0,icon:e.jsx(xe,{}),onClick:Ve,children:s("settings.skills.editor.delete",{defaultValue:"Delete"})})]}),Jt(m)?e.jsxs("div",{style:{flex:1,minHeight:0,minWidth:0,display:"flex",gap:16},children:[e.jsx("div",{style:{flex:1,minHeight:0,minWidth:0,display:"flex",flexDirection:"column"},children:e.jsx(De,{value:n,onChange:k=>{u(k.target.value),L(!0)},style:{flex:1,minHeight:0,fontFamily:"monospace",resize:"none"},spellCheck:!1})}),e.jsx("div",{style:{flex:1,minHeight:0,minWidth:0,overflow:"auto",border:"1px solid #d9d9d9",borderRadius:8,padding:12},children:e.jsx(Ze,{content:xt(n)})})]}):e.jsx(De,{value:n,onChange:k=>{u(k.target.value),L(!0)},style:{flex:1,minHeight:0,fontFamily:"monospace",resize:"none"},spellCheck:!1})]}),!m&&e.jsx("div",{style:{color:"#999"},children:s("settings.skills.editor.selectFileToEdit",{defaultValue:"Select a file to edit"})})]})]}),H&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"fixed",inset:0,zIndex:999},onClick:fe,onContextMenu:k=>k.preventDefault(),"aria-hidden":!0}),e.jsx("div",{style:{position:"fixed",left:H.x,top:H.y,zIndex:1e3},children:e.jsx(mt,{selectable:!1,items:[...H.isDir?[]:[{key:"open",icon:e.jsx(We,{}),label:s("settings.skills.editor.open",{defaultValue:"Open"})}],{key:"rename",icon:e.jsx(ve,{}),label:s("settings.skills.editor.rename",{defaultValue:"Rename"})},{key:"delete",icon:e.jsx(xe,{}),label:s("settings.skills.editor.delete",{defaultValue:"Delete"}),danger:!0},{key:"newFile",icon:e.jsx(ft,{}),label:s("settings.skills.editor.newFile",{defaultValue:"New file"})},{key:"newDir",icon:e.jsx(pt,{}),label:s("settings.skills.editor.newFolder",{defaultValue:"New folder"})}],onClick:({key:k})=>ye(k)})})]}),e.jsx(G,{title:s("settings.skills.editor.newFileTitle",{defaultValue:"New file"}),open:b,onOk:W,onCancel:()=>{I(!1),K("")},okText:s("settings.skills.editor.create",{defaultValue:"Create"}),children:e.jsx(x,{placeholder:s("settings.skills.editor.placeholderNewFile",{defaultValue:"filename.md or filename.txt"}),value:T,onChange:k=>K(k.target.value)})}),e.jsx(G,{title:s("settings.skills.editor.newFolderTitle",{defaultValue:"New folder"}),open:M,onOk:()=>N.validateFields().then(re),onCancel:()=>E(!1),okText:s("settings.skills.editor.create",{defaultValue:"Create"}),children:e.jsx(l,{form:N,layout:"vertical",children:e.jsx(l.Item,{name:"name",label:s("settings.skills.editor.folderName",{defaultValue:"Folder name"}),rules:[{required:!0}],children:e.jsx(x,{placeholder:s("settings.skills.editor.placeholderFolder",{defaultValue:"folder-name"})})})})}),e.jsx(G,{title:s("settings.skills.editor.renameTitle",{defaultValue:"Rename"}),open:!!z,onOk:pe,onCancel:()=>B(null),okText:s("settings.skills.editor.rename",{defaultValue:"Rename"}),destroyOnClose:!0,children:e.jsx(l,{form:P,layout:"vertical",onValuesChange:(k,a)=>r(a.name??""),children:e.jsx(l.Item,{name:"name",label:z!=null&&z.isDir?s("settings.skills.editor.folderName",{defaultValue:"Folder name"}):s("settings.skills.editor.fileName",{defaultValue:"File name"}),rules:[{required:!0}],children:e.jsx(x,{placeholder:z!=null&&z.isDir?s("settings.skills.editor.placeholderFolder",{defaultValue:"folder-name"}):s("settings.skills.editor.placeholderFileName",{defaultValue:"name.md"}),onPressEnter:()=>pe()})})})})]}):null},ds=Object.freeze(Object.defineProperty({__proto__:null,default:Xt},Symbol.toStringTag,{value:"Module"})),Qt=()=>{var y;const{id:t}=Me(),i=Fe(),{t:s}=$("system"),{data:m,loading:g}=_(()=>t?C.system.getSkill({id:t}):Promise.reject(new Error("No id")),{refreshDeps:[t],ready:!!t}),{data:f,loading:S}=_(()=>t?C.system.previewSkill({id:t}):Promise.reject(new Error("No id")),{refreshDeps:[t],ready:!!t,onError:()=>o.error(s("settings.skills.previewFailed",{defaultValue:"Failed to load preview"}))}),v=(m==null?void 0:m.data)??m,j=((y=f==null?void 0:f.data)==null?void 0:y.content)??(f==null?void 0:f.content)??"",n=yt(j);if(!t)return null;const u=g||S;return e.jsx(te,{title:(v==null?void 0:v.name)??s("settings.skills.editor.previewTitle",{defaultValue:"Skill Preview"}),extra:e.jsx(w,{type:"link",onClick:()=>i("/system/settings#skills"),children:s("settings.skills.editor.backToSkills",{defaultValue:"Back to Skills"})}),children:e.jsx(he,{spinning:u,children:e.jsx("div",{style:{minHeight:200},children:!u&&e.jsx(Ze,{content:n})})})})},us=Object.freeze(Object.defineProperty({__proto__:null,default:Qt},Symbol.toStringTag,{value:"Module"})),Yt=()=>{const{t}=$("system"),[i]=gt(),s=i.get("provider"),m=i.get("code"),g=i.get("state"),[f,S]=p.useState(null),[v,j]=p.useState(null),[n,u]=p.useState(null);return _(async()=>{if(!m||!g||!s)throw new Error(t("settings.oauth.testConnection.missingRequiredParameters",{defaultValue:"Missing required parameters"}));const y=await C.system.testOauthCallback({code:m,state:g,provider:s});if(!y.user_info)throw new Error(t("settings.oauth.testConnection.responseUserInfoIsNull",{defaultValue:"response user_info is null"}));if(!y.user)throw new Error(t("settings.oauth.testConnection.responseUserIsNull",{defaultValue:"response user is null"}));S(y.user),j(y.user_info)},{onSuccess:()=>{u({status:"success",message:t("settings.oauth.testConnection.success",{defaultValue:"Successfully tested connection"})})},onError:y=>{u({status:"error",message:t("settings.oauth.testConnection.callbackFailed",{defaultValue:"Failed to test connection"}),error:y.message})}}),n?e.jsx("div",{children:e.jsx(ht,{status:n.status,title:n.message,subTitle:n.error,extra:e.jsxs(Z,{style:{display:!v||!f?"none":"inline-block",textAlign:"left"},direction:"vertical",children:[e.jsx(te,{title:t("settings.oauth.testConnection.oauthUserInfo",{defaultValue:"OAuth User Info"}),children:e.jsx(Ue,{src:v||{}})}),e.jsx(te,{title:t("settings.oauth.testConnection.loginUserInfo",{defaultValue:"Login User Info"}),style:{marginTop:16},children:e.jsx(Ue,{src:f||{}})})]})})}):e.jsx(jt,{})},cs=Object.freeze(Object.defineProperty({__proto__:null,default:Yt},Symbol.toStringTag,{value:"Module"}));export{rs as O,ds as S,us as a,cs as b,os as i};
