import{ac as Y,al as G,aI as H,u as Q,r,F as d,j as e,S as X,C as Z,T as ee,x as P,m as f,aJ as te,af as ae,aK as se,n as R,g as re,E as ne,A as oe,s as ie,aL as le}from"./vendor.Bo5zsZF4.js";import{u as de}from"./contexts.CZ9vuarb.js";import{w as ue,x as ce,A as v,y as me,z as fe}from"./base.C1oMHUIk.js";import{a as ge,b as he}from"./components.CK8RYgUg.js";import"./vite.BF1G3H_w.js";const{Title:pe}=ee,be=()=>{const g=Y(),O=G(),[i]=H(),{login:b,oauthLogin:S}=de(),{t:s,i18n:x}=Q(),[V,l]=r.useState(null),[w,I]=r.useState({}),[u,h]=r.useState("login"),[j,B]=r.useState(null),[c,$]=r.useState(null),[p]=d.useForm(),A=r.useRef(!1),[q,L]=r.useState(!1),[T,C]=r.useState([]),[y,_]=r.useState(0),[M,k]=r.useState("Loading..."),[n,U]=r.useState(null),E=async a=>{const o=async t=>"username"in t?await b({username:t.username,password:t.password}):"mfa_token"in t?await b({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await S({code:t.code,state:t.state,provider:t.provider});try{L(!0);const t=await o(a);if(await new Promise(m=>setTimeout(m,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&O.pathname!=="/profile")g("/profile#mfa");else{const m=i.get("redirect");m?window.location.href=m:n!=null&&n.home_page?window.location.href=n.home_page:g("/")}}catch(t){if(t.password_expired)h("password_expired"),l(null);else if(t.needsMFA)l(null),h("mfa"),g("/login",{replace:!0}),B(t.mfaType),$(t.user),p.setFieldValue("mfa_token",t.mfaToken);else if("username"in a||"mfa_token"in a)if(t instanceof v?l(s("login.error",{defaultValue:"Login failed: {{error}}",error:s(`login.${t}`,{defaultValue:t.message})})):l(typeof t=="string"?t:s("login.error",{defaultValue:"Login failed"})),"mfa_token"in a){_(30);const m=setInterval(()=>{_(F=>F>=1?F-1:0)},1e3);setTimeout(()=>{clearInterval(m),_(0)},3e4)}else"username"in a&&h("login");else t instanceof v?l(s("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:s(`login.${t.code}`,{defaultValue:t.message})})):l(typeof t=="string"?t:s("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),g("/login",{replace:!0})}finally{L(!1)}},D=async()=>{C(await me()||[])};r.useEffect(()=>{if(!A.current){A.current=!0;const a=i.get("code"),o=i.get("state"),t=i.get("provider");a&&o&&t?E({code:a,state:o,provider:t}):D()}},[i,S]),r.useEffect(()=>{ue().then(a=>{var o;k(a.name),U(a),window.document.title=a.name,(o=document.getElementById("site-icon"))==null||o.setAttribute("href",a.logo)})},[]),r.useEffect(()=>{x.language&&k((n==null?void 0:n.name_i18n[x.language])||(n==null?void 0:n.name)||"")},[n,x.language]);const N=async a=>{try{I({...w,[a]:!0});const{url:o}=await fe(a);window.location.href=o}catch(o){ie.error(s("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",o)}finally{I({...w,[a]:!1})}},z=a=>{switch(a.toLowerCase()){case"github":return e.jsx(le,{});default:return null}},J=i.get("code"),K=i.get("state"),W=i.get("provider");return J&&K&&W?e.jsx(X,{}):e.jsxs("div",{children:[e.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsx(ge,{})}),e.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxs(Z,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsx(pe,{level:2,children:M}),e.jsx("p",{children:s("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),V&&e.jsx(P,{message:V,type:"error",showIcon:!0,style:{marginBottom:20}}),j&&e.jsx(P,{message:s(`login.mfaTips.${j}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxs(d,{name:"login",initialValues:{remember:!0},onFinish:E,size:"large",form:p,hidden:u==="password_expired",children:[u==="mfa"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{hidden:!(c!=null&&c.email)||j!=="email",children:e.jsx(f,{value:ce(c==null?void 0:c.email)})}),e.jsx(d.Item,{name:"mfa_token",hidden:!0,children:e.jsx(f,{})}),e.jsx(d.Item,{name:"mfa_code",hidden:u!=="mfa",children:e.jsx(f,{placeholder:s("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsx(te,{})})})]}),u==="login"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{name:"username",rules:[{required:!0,message:s("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsx(f,{prefix:e.jsx(ae,{}),placeholder:s("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsx(d.Item,{name:"password",rules:[{required:!0,message:s("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsx(f.Password,{prefix:e.jsx(se,{}),placeholder:s("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsx(d.Item,{children:e.jsx(R,{disabled:y>0,type:"primary",htmlType:"submit",loading:q,block:!0,children:y>0?e.jsxs("span",{style:{marginLeft:8},children:[y,"s"]}):s("login.login",{defaultValue:"Login"})})})]}),T.length>0&&u!=="password_expired"&&e.jsxs(e.Fragment,{children:[e.jsx(re,{children:s("login.or",{defaultValue:"Or"})}),e.jsx(ne,{direction:"vertical",style:{width:"100%"},children:T.map(a=>e.jsx(R,{icon:z(a.name),onClick:()=>N(a.name),loading:w[a.name],block:!0,children:a.icon_url?e.jsx(oe,{src:a.icon_url}):s("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:a.display_name})},a.name))})]}),u==="password_expired"&&e.jsx(he,{onSuccess:()=>{h("login"),p.setFieldValue("password",""),p.setFieldValue("mfa_code","")}})]})})]})};export{be as default};
