import{u as $,aM as i,r as h,a as _,j as e,S as pe,b5 as se,g as O,ao as V,aQ as Pe,a6 as ze,f as H,B as C,dr as Fe,d as ue,s as d,b6 as ce,M as W,aF as Qe,dp as de,aP as Xe,U as Ye,ds as et,T as te,a_ as Se,i as we,dt as Te,d9 as $e,p as tt,du as st,dj as Be,dv as lt,dc as ke,e as he,aq as Y,a$ as Ee,b0 as be,b as ve,dw as at,dx as Le,bh as it,bL as nt,aI as _e,dy as ot,aS as He,aA as rt,aC as Oe,bl as dt,dd as Me,dz as ut,c as ct,dA as Ke,dg as mt,bj as ft,dB as We,dC as pt,dD as gt,bJ as ht,aw as xt,dE as Ue}from"./vendor.CyaXoMFn.js";import{a as F}from"./index.Dwpr26wG.js";import{g as qe,a as yt,s as Vt}from"./base.CIILqgsu.js";import{f as X,h as jt,i as Ie,j as Ge,M as Ze,L as bt}from"./components.BXKFJ6ns.js";import{l as St,c as kt,u as vt,d as _t,a as Ft,g as Ct,b as wt,e as It,r as Tt}from"./system.D28L4Wa8.js";import{c as At,b as Et}from"./contexts.DcBdfNkE.js";import{l as zt,b as Mt}from"./authorization.BwAKdzUH.js";const je=/^(https?:\/\/)(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])(:[0-9]+)?(\/[\w\-._~:/?#[\]@!$&'()*+,;=]*)*$/,Rt={github:{email_field:"email",username_field:"login",full_name_field:"name",avatar_field:"avatar_url",role_field:"",icon_url:"https://github.githubassets.com/favicons/favicon.svg",display_name:"GitHub",endpoints:{auth_endpoint:"https://github.com/login/oauth/authorize",token_endpoint:"https://github.com/login/oauth/access_token",userinfo_endpoint:"https://api.github.com/user"},scope:"user:email"},google:{email_field:"email",username_field:"email",full_name_field:"name",avatar_field:"picture",role_field:"",icon_url:"https://www.google.com/favicon.ico",display_name:"Google",endpoints:{auth_endpoint:"https://accounts.google.com/o/oauth2/v2/auth",token_endpoint:"https://oauth2.googleapis.com/token",userinfo_endpoint:"https://openidconnect.googleapis.com/v1/userinfo"},scope:"profile email"},dingtalk:{email_field:"email",username_field:"nick",full_name_field:"name",avatar_field:"avatar",role_field:"",icon_url:"https://img.alicdn.com/tfs/TB1pTD.XQT2gK0jSZFkXXcIQFXa-160-160.png",display_name:"DingTalk",endpoints:{auth_endpoint:"https://oapi.dingtalk.com/connect/qrconnect",token_endpoint:"https://oapi.dingtalk.com/gettoken",userinfo_endpoint:"https://oapi.dingtalk.com/topapi/user/get"},scope:"snsapi_login"},wechat:{email_field:"",username_field:"openid",full_name_field:"nickname",avatar_field:"headimgurl",role_field:"",icon_url:"https://res.wx.qq.com/a/wx_fed/assets/res/NTI4MWU5.ico",display_name:"WeChat",endpoints:{auth_endpoint:"https://open.weixin.qq.com/connect/qrconnect",token_endpoint:"https://api.weixin.qq.com/sns/oauth2/access_token",userinfo_endpoint:"https://api.weixin.qq.com/sns/userinfo"},scope:"snsapi_login"},custom:{email_field:"",username_field:"",full_name_field:"",avatar_field:"",role_field:"",icon_url:"",display_name:"",endpoints:{auth_endpoint:"",token_endpoint:"",userinfo_endpoint:""},scope:""}},Pt=({initialData:t,onRefresh:l})=>{const{t:s}=$("system"),{t:n}=$("common"),[f]=i.useForm(),[g,b]=h.useState((t==null?void 0:t.provider)||"custom"),[j,k]=h.useState((t==null?void 0:t.provider)==="custom"||(t==null?void 0:t.provider)==="autoDiscover"),[o,p]=h.useState((t==null?void 0:t.enabled)||!1),[x,U]=h.useState((t==null?void 0:t.auto_create_user)||!1),{loading:z,data:I,refresh:S}=_(F.system.getOauthSettings,{manual:!!t,onSuccess:v=>{f.setFieldsValue(v),b(v.provider),k(v.provider==="custom"||v.provider==="autoDiscover"),p(v.enabled),U(v.auto_create_user)},onError:v=>{d.error(s("settings.fetchFailed",{defaultValue:"Failed to fetch settings"})),console.error("Failed to get OAuth settings",v)}});h.useEffect(()=>{t&&(f.setFieldsValue(t),b(t.provider),k(t.provider==="custom"||t.provider==="autoDiscover"),p(t.enabled),U(t.auto_create_user))},[t,f]);const M=v=>{b(v),k(v==="custom"||v==="autoDiscover");const u=Rt[v];u&&f.setFieldsValue({auth_endpoint:u.endpoints.auth_endpoint,token_endpoint:u.endpoints.token_endpoint,userinfo_endpoint:u.endpoints.userinfo_endpoint,scope:u.scope,email_field:u.email_field,username_field:u.username_field,full_name_field:u.full_name_field,avatar_field:u.avatar_field,role_field:u.role_field,icon_url:u.icon_url,display_name:u.display_name})},T=v=>{p(v)},R=v=>{U(v)},{loading:w,run:G}=_(F.system.updateOauthSettings,{manual:!0,onSuccess:()=>{d.success(s("settings.updateSuccess",{defaultValue:"Settings updated successfully"})),l?l():S()},onError:v=>{d.error(s("settings.updateFailed",{defaultValue:"Failed to update settings"})),console.error("Failed to update OAuth settings",v)}}),N=v=>{G(v)},J=()=>{l?l():S()},{loading:B,run:q}=_(async({redirect_uri:v,...u})=>{let P;return v?P=new URL(v):P=new URL(window.location.origin),P.pathname=qe("/system/settings/oauth/test-callback"),P.searchParams.set("provider",g),F.system.testOauthConnection({redirect_uri:P.toString(),...u})},{manual:!0,onSuccess:({url:v})=>{window.open(v,"_blank")},onError:v=>{d.error(s("settings.oauth.testConnection.failed",{defaultValue:"Failed to test connection: {{error}}",error:v.message})),console.error("Failed to test OAuth connection",v)}}),L=()=>g==="custom";return e.jsx(pe,{spinning:z,children:e.jsxs(i,{form:f,layout:"vertical",onFinish:N,initialValues:t||I,children:[e.jsx(i.Item,{name:"enabled",label:s("settings.oauth.enabled.label",{defaultValue:"Enable OAuth"}),valuePropName:"checked",tooltip:s("settings.oauth.enabled.tooltip",{defaultValue:"Enable or disable OAuth login for the system."}),children:e.jsx(se,{onChange:T})}),e.jsx(i.Item,{name:"provider",label:s("settings.oauth.provider.label",{defaultValue:"OAuth Provider"}),tooltip:s("settings.oauth.provider.tooltip",{defaultValue:"Select an OAuth provider or configure a custom one."}),rules:[{required:o,message:s("settings.oauth.provider.required",{defaultValue:"Please select an OAuth provider."})}],children:e.jsxs(O,{onChange:M,disabled:!o,children:[e.jsx(O.Option,{value:"github",children:s("settings.oauth.provider.options.github",{defaultValue:"GitHub"})}),e.jsx(O.Option,{value:"google",children:s("settings.oauth.provider.options.google",{defaultValue:"Google"})}),e.jsx(O.Option,{value:"dingtalk",children:s("settings.oauth.provider.options.dingtalk",{defaultValue:"DingTalk"})}),e.jsx(O.Option,{value:"wechat",children:s("settings.oauth.provider.options.wechat",{defaultValue:"WeChat"})}),e.jsx(O.Option,{value:"autoDiscover",children:s("settings.oauth.provider.options.autoDiscover",{defaultValue:"Auto Discover"})}),e.jsx(O.Option,{value:"custom",children:s("settings.oauth.provider.options.custom",{defaultValue:"Custom"})})]})}),e.jsx(i.Item,{name:"display_name",label:s("settings.oauth.displayName.label",{defaultValue:"Display Name"}),tooltip:s("settings.oauth.displayName.tooltip",{defaultValue:"The name displayed on the login button for this provider."}),children:e.jsx(V,{disabled:!o,placeholder:g!=="custom"?s(`settings.oauth.provider.options.${g}`,{defaultValue:g}):""})}),e.jsx(i.Item,{name:"icon_url",label:s("settings.oauth.iconUrl.label",{defaultValue:"Icon URL"}),tooltip:s("settings.oauth.iconUrl.tooltip",{defaultValue:"URL of the icon for this provider. Displayed on the login button."}),rules:[{pattern:je,message:s("settings.oauth.iconUrl.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(V,{disabled:!o,placeholder:"https://example.com/icon.png"})}),e.jsx(i.Item,{name:"client_id",label:s("settings.oauth.clientId.label",{defaultValue:"Client ID"}),tooltip:s("settings.oauth.clientId.tooltip",{defaultValue:"The Client ID provided by the OAuth provider."}),rules:[{required:o,message:s("settings.oauth.clientId.required",{defaultValue:"Client ID is required."})}],children:e.jsx(V,{disabled:!o})}),e.jsx(i.Item,{name:"client_secret",label:s("settings.oauth.clientSecret.label",{defaultValue:"Client Secret"}),tooltip:s("settings.oauth.clientSecret.tooltip",{defaultValue:"The Client Secret provided by the OAuth provider. This will be stored encrypted."}),rules:[{required:o,message:s("settings.oauth.clientSecret.required",{defaultValue:"Client Secret is required."})}],children:e.jsx(V.Password,{disabled:!o,autoComplete:"new-password",visibilityToggle:!1,placeholder:s("settings.oauth.clientSecret.unchanged",{defaultValue:"Leave blank to keep unchanged"})})}),L()&&e.jsx(i.Item,{name:"auth_endpoint",label:s("settings.oauth.authEndpoint.label",{defaultValue:"Authorization Endpoint"}),tooltip:s("settings.oauth.authEndpoint.tooltip",{defaultValue:"The authorization endpoint URL of the OAuth provider."}),rules:[{required:o&&g==="custom",message:s("settings.oauth.authEndpoint.required",{defaultValue:"Authorization Endpoint is required."})},{pattern:je,message:s("settings.oauth.authEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(V,{disabled:!o})}),e.jsx(i.Item,{name:"wellknown_endpoint",hidden:g!=="autoDiscover",label:s("settings.oauth.wellknownEndpoint.label",{defaultValue:"Wellknown Endpoint"}),tooltip:s("settings.oauth.wellknownEndpoint.tooltip",{defaultValue:"The wellknown endpoint URL of the OAuth provider."}),rules:[{pattern:je,message:s("settings.oauth.wellknownEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})},{required:o&&g==="autoDiscover",message:s("settings.oauth.wellknownEndpoint.required",{defaultValue:"Wellknown Endpoint is required."})}],children:e.jsx(V,{disabled:!o})}),L()&&e.jsx(i.Item,{name:"token_endpoint",label:s("settings.oauth.tokenEndpoint.label",{defaultValue:"Token Endpoint"}),tooltip:s("settings.oauth.tokenEndpoint.tooltip",{defaultValue:"The token endpoint URL of the OAuth provider."}),rules:[{required:o&&g==="custom",message:s("settings.oauth.tokenEndpoint.required",{defaultValue:"Token Endpoint is required."})},{pattern:je,message:s("settings.oauth.tokenEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(V,{disabled:!o})}),L()&&e.jsx(i.Item,{name:"userinfo_endpoint",label:s("settings.oauth.userInfoEndpoint.label",{defaultValue:"User Info Endpoint"}),tooltip:s("settings.oauth.userInfoEndpoint.tooltip",{defaultValue:"The user information endpoint URL of the OAuth provider."}),rules:[{required:o&&g==="custom",message:s("settings.oauth.userInfoEndpoint.required",{defaultValue:"User Info Endpoint is required."})},{pattern:je,message:s("settings.oauth.userInfoEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(V,{disabled:!o})}),e.jsx(i.Item,{name:"scope",label:s("settings.oauth.scope.label",{defaultValue:"Authorization Scope"}),tooltip:s("settings.oauth.scope.tooltip",{defaultValue:"The scopes to request from the OAuth provider, separated by spaces."}),rules:[{required:o,message:s("settings.oauth.scope.required",{defaultValue:"Scope is required."})}],children:e.jsx(V,{disabled:!o})}),e.jsx(i.Item,{name:"redirect_uri",label:s("settings.oauth.redirectUri.label",{defaultValue:"Redirect URI"}),tooltip:s("settings.oauth.redirectUri.tooltip",{defaultValue:"The Redirect URI registered with the OAuth provider. This should match the one configured in your application."}),rules:[v=>v.getFieldValue("redirect_uri")!==""?{pattern:je,message:s("settings.oauth.redirectUri.invalidUrl",{defaultValue:"Please enter a valid URL."})}:{required:!1}],children:e.jsx(V,{disabled:!o,placeholder:`http://${window.location.host}${qe(`/login?provider=settings.${g}`)}`})}),e.jsx(i.Item,{name:"auto_create_user",label:s("settings.oauth.autoCreateUser.label",{defaultValue:"Auto Create User"}),valuePropName:"checked",tooltip:s("settings.oauth.autoCreateUser.tooltip",{defaultValue:"Automatically create a new user if one does not exist with the OAuth email."}),children:e.jsx(se,{onChange:R,disabled:!o})}),e.jsx(i.Item,{name:"default_role",label:s("settings.oauth.defaultRole.label",{defaultValue:"Default Role"}),tooltip:s("settings.oauth.defaultRole.tooltip",{defaultValue:"The default role to assign to new users created via OAuth. Enter role ID."}),rules:[{required:o&&x,message:s("settings.oauth.defaultRole.required",{defaultValue:"Default Role is required when auto create user is enabled."})}],children:e.jsx(V,{disabled:!o||!x})}),e.jsx(i.Item,{name:"role_mapping_mode",label:s("settings.oauth.roleMappingMode.label",{defaultValue:"Role Mapping Mode"}),tooltip:s("settings.oauth.roleMappingMode.tooltip",{defaultValue:"Controls how user roles are synchronized from OAuth2 provider."}),initialValue:"auto",children:e.jsxs(O,{disabled:!o,children:[e.jsx(O.Option,{value:"disabled",children:s("settings.oauth.roleMappingMode.options.disabled.label",{defaultValue:"Disabled"})}),e.jsx(O.Option,{value:"auto",children:s("settings.oauth.roleMappingMode.options.auto.label",{defaultValue:"Auto"})}),e.jsx(O.Option,{value:"enforce",children:s("settings.oauth.roleMappingMode.options.enforce.label",{defaultValue:"Enforce"})})]})}),e.jsx(Pe,{style:{marginBottom:16},type:"info",showIcon:!0,message:s("settings.oauth.roleMappingMode.infoTitle",{defaultValue:"Role Mapping Mode Information"}),description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[s("settings.oauth.roleMappingMode.options.disabled.label",{defaultValue:"Disabled"}),":"]})," ",s("settings.oauth.roleMappingMode.options.disabled.description",{defaultValue:"Ignores role information from OAuth2 provider. New users get the default role."})]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[s("settings.oauth.roleMappingMode.options.auto.label",{defaultValue:"Auto"}),":"]})," ",s("settings.oauth.roleMappingMode.options.auto.description",{defaultValue:"Uses OAuth2 roles for new users or users without roles, but preserves existing role assignments."})]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[s("settings.oauth.roleMappingMode.options.enforce.label",{defaultValue:"Enforce"}),":"]})," ",s("settings.oauth.roleMappingMode.options.enforce.description",{defaultValue:"Always overwrites user roles with OAuth2 roles when available."})]})]})}),e.jsx(i.Item,{name:"mfa_enabled",label:s("settings.oauth.mfaEnabled.label",{defaultValue:"MFA Enabled"}),valuePropName:"checked",tooltip:s("settings.oauth.mfaEnabled.tooltip",{defaultValue:"Enable MFA for OAuth login(Only valid when MFA is enabled by the user)."}),children:e.jsx(se,{disabled:!o})}),e.jsx(ze,{children:s("settings.oauth.fieldMapping.title",{defaultValue:"Field Mapping"})}),e.jsx(Pe,{style:{marginBottom:16},type:"info",showIcon:!0,message:s("settings.oauth.fieldMapping.autoDetectHint",{defaultValue:"For preset providers, fields are typically auto-detected. Customize if needed."}),description:j?"":s("settings.oauth.fieldMapping.presetDescription",{defaultValue:'These fields are pre-filled based on the selected provider. You can switch to "Custom" provider to edit them directly.'})}),e.jsx(i.Item,{name:"email_field",label:s("settings.oauth.fieldMapping.emailField.label",{defaultValue:"Email Field"}),tooltip:s("settings.oauth.fieldMapping.emailField.tooltip",{defaultValue:"The field name in the user info response that contains the user email. (e.g., email)"}),children:e.jsx(V,{placeholder:"email",disabled:!o||!j})}),e.jsx(i.Item,{name:"username_field",label:s("settings.oauth.fieldMapping.usernameField.label",{defaultValue:"Username Field"}),tooltip:s("settings.oauth.fieldMapping.usernameField.tooltip",{defaultValue:"The field name in the user info response that contains the username. (e.g., login, sub)"}),children:e.jsx(V,{placeholder:"login",autoComplete:"off",disabled:!o||!j})}),e.jsx(i.Item,{name:"full_name_field",label:s("settings.oauth.fieldMapping.fullNameField.label",{defaultValue:"Full Name Field"}),tooltip:s("settings.oauth.fieldMapping.fullNameField.tooltip",{defaultValue:"The field name in the user info response that contains the user's full name. (e.g., name)"}),children:e.jsx(V,{placeholder:"name",disabled:!o||!j})}),e.jsx(i.Item,{name:"avatar_field",label:s("settings.oauth.fieldMapping.avatarField.label",{defaultValue:"Avatar URL Field"}),tooltip:s("settings.oauth.fieldMapping.avatarField.tooltip",{defaultValue:"The field name in the user info response that contains the URL to the user's avatar. (e.g., picture, avatar_url)"}),children:e.jsx(V,{placeholder:"avatar_url",disabled:!o||!j})}),e.jsx(i.Item,{name:"role_field",label:s("settings.oauth.fieldMapping.roleField.label",{defaultValue:"Role Field"}),tooltip:s("settings.oauth.fieldMapping.roleField.tooltip",{defaultValue:"The field name in the user info response that contains the user's role. (Optional)"}),children:e.jsx(V,{placeholder:"role",disabled:!o||!j})}),e.jsx(i.Item,{children:e.jsxs(H,{children:[e.jsx(C,{type:"primary",htmlType:"submit",loading:w,icon:e.jsx(Fe,{}),children:n("save",{defaultValue:"Save"})}),e.jsx(C,{loading:B,onClick:async()=>{const v=f.getFieldsValue();q(v)},children:s("settings.oauth.testConnection.button",{defaultValue:"Test Connection"})}),e.jsx(C,{onClick:J,icon:e.jsx(ue,{}),children:n("refresh",{defaultValue:"Refresh"})})]})})]})})},Lt=()=>{const{t}=$("system"),{t:l}=$("common"),[s]=i.useForm(),{loading:n,data:f,refresh:g}=_(F.system.getSecuritySettings,{onSuccess:o=>{s.setFieldsValue(o)},onError:o=>{d.error(t("settings.fetchFailed",{defaultValue:"Failed to fetch settings"})),console.error("Failed to get system settings",o)}}),{loading:b,run:j}=_(F.system.updateSecuritySettings,{manual:!0,onSuccess:()=>{d.success(t("settings.updateSuccess",{defaultValue:"Settings updated successfully"})),g()},onError:o=>{d.error(t("settings.updateFailed",{defaultValue:"Failed to update settings"})),console.error("Failed to update system settings",o)}}),k=o=>{j(o)};return e.jsx(pe,{spinning:n,children:e.jsxs(i,{form:s,layout:"vertical",onFinish:k,initialValues:f,children:[e.jsx(i.Item,{name:"mfa_enforced",label:t("settings.security.mfa.label",{defaultValue:"Enforce Multi-Factor Authentication (MFA)"}),valuePropName:"checked",tooltip:t("settings.security.mfa.tooltip",{defaultValue:"If enabled, all users will be required to set up MFA."}),children:e.jsx(se,{})}),e.jsx(i.Item,{name:"password_complexity",label:t("settings.security.passwordComplexity.label",{defaultValue:"Password Complexity"}),tooltip:t("settings.security.passwordComplexity.tooltip",{defaultValue:"Define the complexity requirements for user passwords."}),children:e.jsxs(O,{children:[e.jsx(O.Option,{value:"low",children:t("settings.security.passwordComplexity.options.low",{defaultValue:"Low"})}),e.jsx(O.Option,{value:"medium",children:t("settings.security.passwordComplexity.options.medium",{defaultValue:"Medium"})}),e.jsx(O.Option,{value:"high",children:t("settings.security.passwordComplexity.options.high",{defaultValue:"High"})}),e.jsx(O.Option,{value:"very_high",children:t("settings.security.passwordComplexity.options.veryHigh",{defaultValue:"Very High"})})]})}),e.jsx(i.Item,{name:"password_min_length",label:t("settings.security.passwordMinLength.label",{defaultValue:"Minimum Password Length"}),tooltip:t("settings.security.passwordMinLength.tooltip",{defaultValue:"The minimum number of characters required for a password."}),rules:[{type:"number",min:6,max:32}],children:e.jsx(ce,{min:6,max:32,style:{width:"100%"}})}),e.jsx(i.Item,{name:"password_expiry_days",label:t("settings.security.passwordExpiry.label",{defaultValue:"Password Expiry (Days)"}),tooltip:t("settings.security.passwordExpiry.tooltip",{defaultValue:"Number of days after which passwords expire. Set to 0 to disable expiry."}),children:e.jsx(ce,{min:0,style:{width:"100%"},addonAfter:t("settings.days",{defaultValue:"Days"})})}),e.jsx(i.Item,{name:"login_failure_lock",label:t("settings.security.loginFailureLock.label",{defaultValue:"Lock Account on Login Failure"}),valuePropName:"checked",tooltip:t("settings.security.loginFailureLock.tooltip",{defaultValue:"Lock user accounts after a specified number of failed login attempts."}),children:e.jsx(se,{})}),e.jsx(i.Item,{noStyle:!0,shouldUpdate:(o,p)=>o.login_failure_lock!==p.login_failure_lock,children:({getFieldValue:o})=>o("login_failure_lock")?e.jsx(i.Item,{name:"login_failure_attempts",label:t("settings.security.loginFailureAttempts.label",{defaultValue:"Login Failure Attempts"}),tooltip:t("settings.security.loginFailureAttempts.tooltip",{defaultValue:"Number of failed login attempts before locking the account."}),children:e.jsx(ce,{min:1,max:10,style:{width:"100%"}})}):null}),e.jsx(i.Item,{noStyle:!0,shouldUpdate:(o,p)=>o.login_failure_lock!==p.login_failure_lock,children:({getFieldValue:o})=>o("login_failure_lock")?e.jsx(i.Item,{name:"login_failure_lockout_minutes",label:t("settings.security.loginFailureLockoutMinutes.label",{defaultValue:"Login Failure Lockout (Minutes)"}),tooltip:t("settings.security.loginFailureLockoutMinutes.tooltip",{defaultValue:"Number of minutes to lock the account after a specified number of failed login attempts."}),children:e.jsx(ce,{min:1,max:10,style:{width:"100%"},addonAfter:t("settings.minutes",{defaultValue:"Minutes"})})}):null}),e.jsx(i.Item,{name:"history_password_check",label:t("settings.security.historyPasswordCheck.label",{defaultValue:"Enforce Password History Policy"}),valuePropName:"checked",tooltip:t("settings.security.historyPasswordCheck.tooltip",{defaultValue:"Prevent users from reusing recent passwords."}),children:e.jsx(se,{})}),e.jsx(i.Item,{noStyle:!0,shouldUpdate:(o,p)=>o.history_password_check!==p.history_password_check,children:({getFieldValue:o})=>o("history_password_check")?e.jsx(i.Item,{name:"history_password_count",label:t("settings.security.historyPasswordCount.label",{defaultValue:"Password History Count"}),tooltip:t("settings.security.historyPasswordCount.tooltip",{defaultValue:"Number of previous passwords to remember and prevent reuse."}),children:e.jsx(ce,{min:1,max:10,style:{width:"100%"}})}):null}),e.jsx(i.Item,{name:"inactive_account_lock_days",label:t("settings.security.inactiveAccountLock.label",{defaultValue:"Auto-lock Inactive Accounts (Days)"}),tooltip:t("settings.security.inactiveAccountLock.tooltip",{defaultValue:"Number of days of inactivity after which user accounts are automatically locked. Set to 0 to disable."}),children:e.jsx(ce,{min:0,style:{width:"100%"},addonAfter:t("settings.days",{defaultValue:"Days"})})}),e.jsx(i.Item,{name:"session_timeout_minutes",label:t("settings.security.sessionTimeout.label",{defaultValue:"Session Timeout (Minutes)"}),tooltip:t("settings.security.sessionTimeout.tooltip",{defaultValue:"Automatically log out users after a period of inactivity."}),children:e.jsx(ce,{min:5,style:{width:"100%"},addonAfter:t("settings.minutes",{defaultValue:"Minutes"})})}),e.jsx(i.Item,{name:"session_idle_timeout_minutes",label:t("settings.security.sessionIdleTimeout.label",{defaultValue:"Session Idle Timeout (Minutes)"}),tooltip:t("settings.security.sessionIdleTimeout.tooltip",{defaultValue:"Automatically log out users after a period of inactivity."}),children:e.jsx(ce,{min:5,style:{width:"100%"},addonAfter:t("settings.minutes",{defaultValue:"Minutes"})})}),e.jsx(i.Item,{children:e.jsxs(H,{children:[e.jsx(C,{type:"primary",htmlType:"submit",loading:b,icon:e.jsx(Fe,{}),children:l("save",{defaultValue:"Save"})}),e.jsx(C,{onClick:()=>g(),icon:e.jsx(ue,{}),children:l("refresh",{defaultValue:"Refresh"})})]})})]})})},Ot=({fetchItems:t,importItems:l,columns:s,...n})=>{const{t:f}=$("system"),[g,b]=h.useState([]),[j,k]=h.useState([]),{run:o,loading:p}=_(t,{onError:z=>{d.error(f("settings.ldap.importError",{error:`${z.message}`}))},onSuccess:z=>{b(z)},manual:!0}),{run:x,loading:U}=_(async()=>{for(const z of j.filter(I=>{const S=g.find(M=>M.ldap_dn===I);return!(!S||S.status==="imported")})){const I=await l([z]);b(S=>[...S].map(T=>{for(const R of I)if(T.ldap_dn===R.ldap_dn)return{...R,status:"imported"};return T}))}},{manual:!0});return h.useEffect(()=>{n.visible&&(b([]),o(),k([]))},[n.visible]),e.jsx(W,{title:f("settings.ldap.importTitle"),...n,onOk:()=>{x()},width:900,confirmLoading:U,loading:p,children:e.jsx(Se,{rowKey:"ldap_dn",rowSelection:{onChange:z=>{k(z)},getCheckboxProps:z=>({disabled:z.status==="imported"})},columns:s.map(({render:z,...I})=>z?{...I,render:(S,M,T)=>{const R=j.includes(M.ldap_dn)&&U&&M.status!=="imported";return z(S,M,T,R)}}:I),dataSource:g,pagination:!1,scroll:{y:400,x:"max-content"}})})},Ut=()=>{var M,T,R;const{t}=$("system"),[l]=i.useForm(),[s,n]=h.useState(!1),[f,g]=h.useState(null),[b,j]=h.useState(!1),[k,o]=h.useState(!1),[p]=i.useForm(),[x,U]=h.useState(!1);_(F.system.getLdapSettings,{onSuccess:w=>{l.setFieldsValue(w),U(w.enabled)},onError:w=>{d.error(t("settings.ldap.loadError",{defaultValue:"Failed to load LDAP settings: {{error}}",error:`${w.message}`}))}}),h.useEffect(()=>{g(null)},[b]);const z=async w=>{n(!0);try{await F.system.updateLdapSettings(w),d.success(t("settings.ldap.saveSuccess",{defaultValue:"LDAP settings saved successfully."}))}catch{d.error(t("settings.ldap.saveError",{defaultValue:"Failed to save LDAP settings."}))}finally{n(!1)}},{run:I,loading:S}=_(async w=>{const G=await l.validateFields();return await F.system.testLdapConnection({...w,...G})},{onSuccess:w=>{g(w)},onError:w=>{d.error(t("settings.ldap.testError",{defaultValue:"LDAP connection test failed: {{error}}",error:`${w.message}`}))},manual:!0});return e.jsxs(e.Fragment,{children:[e.jsxs(i,{form:l,layout:"vertical",onFinish:z,initialValues:{user_attr:"uid",email_attr:"mail",display_name_attr:"displayName",default_role:"user"},children:[e.jsx(i.Item,{label:t("settings.ldap.enabled",{defaultValue:"Enable LDAP Authentication"}),name:"enabled",valuePropName:"checked",children:e.jsx(se,{onChange:w=>U(w)})}),e.jsx(i.Item,{label:t("settings.ldap.serverUrl",{defaultValue:"LDAP Server URL"}),name:"server_url",rules:[{required:x,message:t("settings.ldap.serverUrlRequired",{defaultValue:"LDAP Server URL is required."})}],children:e.jsx(V,{disabled:!x,placeholder:"ldap://ldap.example.com:389"})}),e.jsx(i.Item,{label:t("settings.ldap.bindDn",{defaultValue:"Bind DN"}),name:"bind_dn",rules:[{required:x,message:t("settings.ldap.bindDnRequired",{defaultValue:"Bind DN is required."})}],children:e.jsx(V,{disabled:!x,placeholder:"cn=admin,dc=example,dc=com"})}),e.jsx(i.Item,{label:t("settings.ldap.bindPassword",{defaultValue:"Bind Password"}),name:"bind_password",rules:[{required:x,message:t("settings.ldap.bindPasswordRequired",{defaultValue:"Bind Password is required."})}],children:e.jsx(V.Password,{hidden:!0,autoComplete:"new-password"})}),e.jsx(i.Item,{label:t("settings.ldap.baseDn",{defaultValue:"Base DN"}),name:"base_dn",rules:[{required:x,message:t("settings.ldap.baseDnRequired",{defaultValue:"Base DN is required."})}],children:e.jsx(V,{disabled:!x,placeholder:"dc=example,dc=com"})}),e.jsx(i.Item,{label:t("settings.ldap.userFilter",{defaultValue:"User Filter"}),name:"user_filter",children:e.jsx(V,{disabled:!x,hidden:!0,autoComplete:"off",placeholder:"(objectClass=person)"})}),e.jsx(i.Item,{label:t("settings.ldap.userAttr",{defaultValue:"User Attribute"}),name:"user_attr",rules:[{required:x,message:t("settings.ldap.userAttrRequired",{defaultValue:"User Attribute is required."})}],children:e.jsx(V,{disabled:!x})}),e.jsx(i.Item,{label:t("settings.ldap.emailAttr",{defaultValue:"Email Attribute"}),name:"email_attr",rules:[{required:x,message:t("settings.ldap.emailAttrRequired",{defaultValue:"Email Attribute is required."})}],children:e.jsx(V,{disabled:!x})}),e.jsx(i.Item,{label:t("settings.ldap.displayNameAttr",{defaultValue:"Display Name Attribute"}),name:"display_name_attr",rules:[{required:x,message:t("settings.ldap.displayNameAttrRequired",{defaultValue:"Display Name Attribute is required."})}],children:e.jsx(V,{disabled:!x})}),e.jsx(i.Item,{label:t("settings.ldap.defaultRole",{defaultValue:"Default Role"}),name:"default_role",rules:[{required:x,message:t("settings.ldap.defaultRoleRequired",{defaultValue:"Default Role is required."})}],children:e.jsx(V,{disabled:!x})}),e.jsx(i.Item,{name:"timeout",label:t("settings.ldap.timeout",{defaultValue:"Timeout"}),tooltip:t("settings.ldap.timeoutTooltip",{defaultValue:"Timeout for LDAP connection in seconds"}),children:e.jsx(V,{type:"number",defaultValue:15,disabled:!x})}),e.jsx(ze,{children:t("settings.ldap.tlsDivider",{defaultValue:"TLS Configuration"})}),e.jsx(i.Item,{label:t("settings.ldap.startTls",{defaultValue:"Use StartTLS"}),name:"start_tls",valuePropName:"checked",children:e.jsx(se,{disabled:!x})}),e.jsx(i.Item,{label:t("settings.ldap.insecure",{defaultValue:"Skip TLS Verification (Insecure)"}),name:"insecure",valuePropName:"checked",children:e.jsx(se,{disabled:!x})}),e.jsx(i.Item,{label:t("settings.ldap.caCert",{defaultValue:"CA Certificate"}),name:"ca_cert",children:e.jsx(V.TextArea,{placeholder:t("settings.ldap.caCertPlaceholder",{defaultValue:`-----BEGIN CERTIFICATE-----
...`}),disabled:!x})}),e.jsx(i.Item,{label:t("settings.ldap.clientCert",{defaultValue:"Client Certificate"}),name:"client_cert",children:e.jsx(V.TextArea,{placeholder:t("settings.ldap.clientCertPlaceholder",{defaultValue:`-----BEGIN CERTIFICATE-----
...`}),disabled:!x})}),e.jsx(i.Item,{label:t("settings.ldap.clientKey",{defaultValue:"Client Key"}),name:"client_key",children:e.jsx(V.TextArea,{placeholder:t("settings.ldap.clientKeyPlaceholder",{defaultValue:`-----BEGIN PRIVATE KEY-----
...`}),disabled:!x})}),e.jsxs(i.Item,{children:[e.jsx(X,{permissions:["system:settings:update"],children:e.jsx(C,{type:"primary",htmlType:"submit",loading:s,children:t("settings.ldap.save",{defaultValue:"Save Settings"})})}),e.jsx(X,{permissions:["system:settings:update"],children:e.jsx(C,{disabled:!x,style:{marginLeft:8},onClick:()=>j(!0),children:t("settings.ldap.testConnection",{defaultValue:"Test Connection"})})}),e.jsx(X,{permissions:["authorization:user:create"],children:e.jsx(C,{disabled:!x,style:{marginLeft:8},onClick:()=>{o(!0)},children:t("settings.ldap.import",{defaultValue:"Import Users"})})})]})]}),e.jsxs(W,{title:t("settings.ldap.test.title",{defaultValue:"Test LDAP Connection"}),open:b,onCancel:()=>j(!1),footer:null,children:[e.jsxs(i,{form:p,layout:"vertical",onFinish:I,children:[e.jsx(i.Item,{label:t("settings.ldap.test.username",{defaultValue:"LDAP Username"}),name:"username",rules:[{required:!0,message:t("settings.ldap.test.usernameRequired",{defaultValue:"Please enter LDAP username for testing."})}],children:e.jsx(V,{disabled:!x})}),e.jsx(i.Item,{label:t("settings.ldap.test.password",{defaultValue:"LDAP Password"}),name:"password",rules:[{required:!0,message:t("settings.ldap.test.passwordRequired",{defaultValue:"Please enter LDAP password for testing."})}],children:e.jsx(V.Password,{disabled:!x})}),e.jsxs(i.Item,{children:[e.jsx(X,{permissions:["system:settings:update"],children:e.jsx(C,{disabled:!x,type:"primary",htmlType:"submit",children:t("settings.ldap.test.test",{defaultValue:"Test"})})}),e.jsx(C,{style:{marginLeft:8},onClick:()=>j(!1),children:t("settings.ldap.test.cancel",{defaultValue:"Cancel"})})]})]}),e.jsx(pe,{spinning:S,children:e.jsx(Qe,{active:S,loading:S,children:f&&(f.user?e.jsxs(de,{bordered:!0,children:[e.jsx(de.Item,{label:"Username",span:3,children:f.user.username}),e.jsx(de.Item,{label:"Email",span:3,children:f.user.email}),e.jsx(de.Item,{label:"FullName",span:3,children:f.user.full_name}),e.jsx(de.Item,{label:"CreatedAt",span:3,children:f.user.created_at}),e.jsx(de.Item,{label:"UpdatedAt",span:3,children:f.user.updated_at})]}):e.jsx(Xe,{direction:"vertical",current:(M=f.message)==null?void 0:M.findIndex(w=>!w.success),status:(T=f.message)!=null&&T.find(w=>!w.success)?"error":"finish",items:(R=f.message)==null?void 0:R.map(w=>({status:w.success?"finish":"error",title:w.message}))}))})})]}),e.jsx(Ot,{visible:k,onCancel:()=>o(!1),fetchItems:()=>F.system.importLdapUsers({}),importItems:w=>F.system.importLdapUsers({user_dn:w}),columns:[{title:t("settings.ldap.username",{defaultValue:"Username"}),dataIndex:"username"},{title:t("settings.ldap.email",{defaultValue:"Email"}),dataIndex:"email"},{title:t("settings.ldap.fullName",{defaultValue:"Full Name"}),dataIndex:"full_name"},{title:t("settings.ldap.importStatus",{defaultValue:"Import Status"}),dataIndex:"imported",fixed:"right",render:(w,G,N,J)=>J?e.jsx(pe,{indicator:e.jsx(Ye,{spin:!0})}):w?e.jsx(et,{twoToneColor:"#52c41a"}):G.id?e.jsx(te,{color:"blue",children:t("settings.ldap.importTypeBound",{defaultValue:"Bound"})}):e.jsx(te,{color:"green",children:t("settings.ldap.importTypeNew",{defaultValue:"New"})})}]})]})},qt=()=>{const{t}=$("system"),{t:l}=$("common"),[s]=i.useForm(),[n,f]=h.useState(null),[g,b]=h.useState(!1),[j]=i.useForm(),[k,o]=h.useState(!1),{loading:p}=_(F.system.getSmtpSettings,{onSuccess:S=>{s.setFieldsValue(S),o(S.enabled)},onError:S=>{d.error(t("settings.smtp.loadError",{defaultValue:"Failed to load SMTP settings: {{error}}",error:`${S.message}`}))}});h.useEffect(()=>{f(null)},[g]);const{run:x,loading:U}=_(({port:S,...M})=>F.system.updateSmtpSettings({...M,port:Number(S)}),{manual:!0,onSuccess:()=>{d.success(t("settings.smtp.saveSuccess",{defaultValue:"SMTP settings saved successfully."}))},onError:S=>{d.error(t("settings.smtp.saveError",{defaultValue:"Failed to save SMTP settings: {{error}}",error:`${S.message}`}))}}),{run:z,loading:I}=_(async S=>{const{port:M,...T}=await s.validateFields();return await F.system.testSmtpConnection({...S,...T,port:Number(M)})},{onSuccess:S=>{f(S)},onError:S=>{d.error(t("settings.smtp.testError",{defaultValue:"SMTP connection test failed: {{error}}",error:`${S.message}`}))},manual:!0});return e.jsxs(e.Fragment,{children:[e.jsx(pe,{spinning:p,children:e.jsxs(i,{form:s,layout:"vertical",onFinish:x,initialValues:{port:587,encryption:"STARTTLS"},children:[e.jsx(i.Item,{label:t("settings.smtp.enabled",{defaultValue:"Enable SMTP"}),name:"enabled",valuePropName:"checked",children:e.jsx(se,{onChange:S=>o(S)})}),e.jsx(i.Item,{label:t("settings.smtp.host",{defaultValue:"SMTP Host"}),name:"host",rules:[{required:k,message:t("settings.smtp.hostRequired",{defaultValue:"SMTP Host is required."})}],children:e.jsx(V,{disabled:!k,placeholder:"smtp.example.com"})}),e.jsx(i.Item,{label:t("settings.smtp.port",{defaultValue:"SMTP Port"}),name:"port",rules:[{required:k,message:t("settings.smtp.portRequired",{defaultValue:"SMTP Port is required."})}],children:e.jsx(V,{type:"number",disabled:!k,placeholder:"587"})}),e.jsx(i.Item,{label:t("settings.smtp.username",{defaultValue:"Username"}),name:"username",rules:[{required:k,message:t("settings.smtp.usernameRequired",{defaultValue:"Username is required."})}],children:e.jsx(V,{disabled:!k,placeholder:"user@example.com"})}),e.jsx(i.Item,{label:t("settings.smtp.password",{defaultValue:"Password"}),name:"password",children:e.jsx(V.Password,{disabled:!k,autoComplete:"new-password"})}),e.jsx(i.Item,{label:t("settings.smtp.encryption",{defaultValue:"Encryption"}),name:"encryption",rules:[{required:k,message:t("settings.smtp.encryptionRequired",{defaultValue:"Encryption is required."})}],children:e.jsxs(we.Group,{disabled:!k,children:[e.jsx(we.Button,{value:"None",children:t("settings.smtp.encryptionNone",{defaultValue:"None"})}),e.jsx(we.Button,{value:"SSL/TLS",children:t("settings.smtp.encryptionSslTls",{defaultValue:"SSL/TLS"})}),e.jsx(we.Button,{value:"STARTTLS",children:t("settings.smtp.encryptionStartTls",{defaultValue:"STARTTLS"})})]})}),e.jsx(i.Item,{label:t("settings.smtp.fromAddress",{defaultValue:"From Address"}),name:"from_address",rules:[{required:k,message:t("settings.smtp.fromAddressRequired",{defaultValue:"From Address is required."})},{type:"email",message:t("settings.smtp.fromAddressInvalid",{defaultValue:"Invalid email address."})}],children:e.jsx(V,{disabled:!k,placeholder:"noreply@example.com"})}),e.jsx(i.Item,{label:t("settings.smtp.fromName",{defaultValue:"From Name"}),name:"from_name",children:e.jsx(V,{disabled:!k,placeholder:t("settings.smtp.fromNamePlaceholder",{defaultValue:"System Notifications"})})}),e.jsx(ze,{children:t("settings.smtp.templateDivider",{defaultValue:"Template Configuration"})}),e.jsx(i.Item,{label:t("settings.smtp.resetPasswordTemplate",{defaultValue:"Reset Password Template"}),name:"reset_password_template",children:e.jsx(Te,{theme:"snow"})}),e.jsx(i.Item,{label:t("settings.smtp.userLockedTemplate",{defaultValue:"User Locked Template"}),name:"user_locked_template",children:e.jsx(Te,{theme:"snow"})}),e.jsx(i.Item,{label:t("settings.smtp.mfaCodeTemplate",{defaultValue:"MFA Code Template"}),name:"mfa_code_template",children:e.jsx(Te,{theme:"snow"})}),e.jsxs(i.Item,{children:[e.jsx(X,{permission:"system:setting:update",children:e.jsx(C,{type:"primary",htmlType:"submit",loading:U,style:{marginRight:8},children:l("save",{defaultValue:"Save"})})}),e.jsx(C,{onClick:()=>b(!0),disabled:!k||I,loading:I,children:t("settings.smtp.testConnection",{defaultValue:"Test Connection"})})]})]})}),e.jsx(W,{title:t("settings.smtp.testConnectionTitle",{defaultValue:"Test SMTP Connection"}),open:g,onCancel:()=>b(!1),footer:[e.jsx(C,{onClick:()=>b(!1),children:l("cancel",{defaultValue:"Cancel"})},"back"),e.jsx(C,{type:"primary",loading:I,onClick:()=>j.submit(),children:t("settings.smtp.sendTestEmail",{defaultValue:"Send Test Email"})},"submit")],children:e.jsxs(i,{form:j,layout:"vertical",onFinish:S=>z(S),children:[e.jsx(i.Item,{label:t("settings.smtp.testEmailRecipient",{defaultValue:"Recipient Email Address"}),name:"to",rules:[{required:!0,message:t("settings.smtp.testEmailRecipientRequired",{defaultValue:"Recipient email address is required."})},{type:"email",message:t("settings.smtp.testEmailRecipientInvalid",{defaultValue:"Invalid email address."})}],children:e.jsx(V,{placeholder:"test@example.com"})}),n&&e.jsx(i.Item,{label:t("settings.smtp.testResult",{defaultValue:"Test Result"}),children:n.success?e.jsx("span",{style:{color:"green"},children:t("settings.smtp.testSuccess",{defaultValue:"Connection successful!"})}):e.jsx("span",{style:{color:"red"},children:t("settings.smtp.testFailed",{defaultValue:"Connection failed: {{error}}",error:n.message})})})]})})]})},Nt=()=>{const{t,i18n:l}=$("system"),{t:s}=$("common"),[n]=i.useForm(),{loading:f,data:g,refresh:b}=_(F.system.getSystemBaseSettings,{onSuccess:p=>{n.setFieldsValue(p)},onError:p=>{d.error(t("settings.fetchFailed",{defaultValue:"Failed to fetch settings"})),console.error("Failed to get system settings",p)}}),{loading:j,run:k}=_(F.system.updateSystemBaseSettings,{manual:!0,onSuccess:()=>{d.success(t("settings.updateSuccess",{defaultValue:"Settings updated successfully"})),b()},onError:p=>{d.error(t("settings.updateFailed",{defaultValue:"Failed to update settings"})),console.error("Failed to update system settings",p)}}),o=p=>{k(p)};return e.jsx(pe,{spinning:f,children:e.jsxs(i,{form:n,layout:"vertical",onFinish:o,initialValues:g,children:[e.jsx(i.Item,{label:t("settings.base.name",{defaultValue:"Name"}),children:e.jsx($e,{items:[{key:"default",label:s("language.default",{defaultValue:"Default"}),forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(i.Item,{name:"name",children:e.jsx(V,{})})})},...jt.map(p=>({key:p.lang,label:l.language!==p.lang?s(`language.${p.lang}`,{defaultValue:p.label,lang:p.label}):p.label,forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(i.Item,{name:["name_i18n",p.lang],children:e.jsx(V,{})})})}))]})}),e.jsx(i.Item,{label:t("settings.base.logo",{defaultValue:"Logo"}),name:"logo",children:e.jsx(V,{})}),e.jsx(i.Item,{label:t("settings.base.homePage",{defaultValue:"Home Page"}),name:"home_page",children:e.jsx(V,{})}),e.jsx(i.Item,{label:t("settings.base.disableLocalUserLogin",{defaultValue:"Disable Local User Login"}),name:"disable_local_user_login",tooltip:t("settings.base.disableLocalUserLoginTooltip",{defaultValue:"Disable local user login, It is only valid when other authentication methods are enabled."}),children:e.jsx(se,{})}),e.jsx(i.Item,{label:t("settings.base.enableMultiOrg",{defaultValue:"Enable Multi-Organization"}),name:"enable_multi_org",tooltip:t("settings.base.enableMultiOrgTooltip",{defaultValue:"Enable multi-organization feature. When enabled, organizations can be managed in the Organization Management tab."}),children:e.jsx(se,{})}),e.jsx(i.Item,{children:e.jsxs(H,{children:[e.jsx(C,{type:"primary",htmlType:"submit",loading:j,icon:e.jsx(Fe,{}),children:s("save",{defaultValue:"Save"})}),e.jsx(C,{onClick:()=>b(),icon:e.jsx(ue,{}),children:s("refresh",{defaultValue:"Refresh"})})]})})]})})},{TextArea:Dt}=V,$t=()=>{var oe;const{t}=$("ai"),{t:l}=$("common"),[s]=i.useForm(),[n,f]=h.useState(!1),[g,b]=h.useState(null),[j,k]=h.useState(""),[o,p]=h.useState(""),[x,U]=h.useState({}),{loading:z,data:I}=_(()=>F.ai.getAiTypeDefinitions(),{refreshDeps:[],onError:m=>{d.error(t("models.fetchTypeDefinitionsFailed",{defaultValue:"Failed to fetch AI type definitions"})),console.error("Failed to fetch AI type definitions:",m)}}),S=h.useMemo(()=>I==null?void 0:I.find(m=>m.provider===o),[I,o]),{loading:M,data:T,refresh:R}=_(()=>F.ai.listAiModels({current:1,page_size:100,search:j}),{refreshDeps:[j],onError:m=>{d.error(t("models.fetchFailed",{defaultValue:"Failed to fetch AI models"})),console.error("Failed to fetch AI models:",m)}}),{loading:w,run:G}=_(({config:m,...c})=>F.ai.createAiModel({config:m??{},...c}),{manual:!0,onSuccess:()=>{d.success(t("models.createSuccess",{defaultValue:"AI model created successfully"})),f(!1),s.resetFields(),R()},onError:m=>{d.error(t("models.createFailed",{defaultValue:"Failed to create AI model"})),console.error("Failed to create AI model:",m)}}),{loading:N,run:J}=_(({id:m,data:c})=>F.ai.updateAiModel({id:m},c),{manual:!0,onSuccess:()=>{d.success(t("models.updateSuccess",{defaultValue:"AI model updated successfully"})),f(!1),s.resetFields(),b(null),R()},onError:m=>{d.error(t("models.updateFailed",{defaultValue:"Failed to update AI model"})),console.error("Failed to update AI model:",m)}}),{runAsync:B}=_(m=>F.ai.deleteAiModel({id:m}),{manual:!0,onSuccess:()=>{d.success(t("models.deleteSuccess",{defaultValue:"AI model deleted successfully"})),R()},onError:m=>{d.error(t("models.deleteFailed",{defaultValue:"Failed to delete AI model"})),console.error("Failed to delete AI model:",m)}}),{runAsync:q}=_(m=>F.ai.testAiModel({id:m}),{manual:!0,onSuccess:()=>{d.success(t("models.testSuccess",{defaultValue:"AI model connection test successful"}))},onError:m=>{d.error(t("models.testFailed",{defaultValue:"AI model connection test failed"})),console.error("Failed to test AI model:",m)}}),{runAsync:L}=_(m=>F.ai.setDefaultAiModel({id:m}),{manual:!0,onSuccess:()=>{d.success(t("models.setDefaultSuccess",{defaultValue:"Default AI model set successfully"})),R()},onError:m=>{d.error(t("models.setDefaultFailed",{defaultValue:"Failed to set default AI model"})),console.error("Failed to set default AI model:",m)}}),v=()=>{b(null),p(""),U({}),s.resetFields(),f(!0)},u=m=>{b(m),p(m.provider);const c=m.config||{},D={name:m.name,description:m.description,provider:m.provider,is_default:m.is_default,config:c,status:m.status};console.log(D),U(D),s.setFieldsValue(D),f(!0)},P=m=>{p(m),S!=null&&S.config_fields&&S.config_fields.forEach(c=>{s.setFieldValue(c.name,void 0)})},le=m=>{const c={};S!=null&&S.config_fields&&S.config_fields.forEach(ee=>{var ne;const Q=(ne=m.config)==null?void 0:ne[ee.name];Q!=null&&Q!==""&&(c[ee.name]=Q)});const D={name:m.name,description:m.description,provider:m.provider,config:c,is_default:m.is_default,status:m.status};g?J({id:g.id,data:D}):G(D)},ae=m=>{var D;if(!((D=m.data_source)!=null&&D.depends_on))return{};const c={};return m.data_source.depends_on.forEach(ee=>{c[ee]=x[ee]}),c},ie=[{title:t("models.name",{defaultValue:"Name"}),dataIndex:"name",key:"name",render:(m,c)=>e.jsxs(H,{children:[e.jsx("span",{children:m}),c.is_default&&e.jsx(tt,{title:t("models.defaultModel",{defaultValue:"Default Model"}),children:e.jsx(st,{style:{color:"#faad14"}})})]})},{title:t("models.provider",{defaultValue:"Provider"}),dataIndex:"provider",key:"provider",render:m=>e.jsx(te,{color:"blue",children:m.toUpperCase()})},{title:t("models.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:m=>e.jsx(te,{color:m==="enabled"?"green":"red",children:m==="enabled"?t("common.enabled",{defaultValue:"Enabled"}):t("common.disabled",{defaultValue:"Disabled"})})},{title:l("actions",{defaultValue:"Actions"}),key:"actions",width:200,render:(m,c)=>e.jsx(Ie,{actions:[{key:"test",permission:"ai:models:test",icon:e.jsx(Be,{}),tooltip:t("models.test",{defaultValue:"Test Connection"}),onClick:async()=>q(c.id)},{key:"setDefault",permission:"ai:models:setDefault",icon:e.jsx(lt,{}),tooltip:t("models.setDefault",{defaultValue:"Set as Default"}),onClick:async()=>L(c.id)},{key:"update",permission:"ai:models:update",icon:e.jsx(ke,{}),tooltip:l("edit",{defaultValue:"Edit"}),onClick:async()=>u(c)},{key:"delete",permission:"ai:models:delete",icon:e.jsx(he,{}),tooltip:l("delete",{defaultValue:"Delete"}),onClick:async()=>B(c.id),danger:!0}]},"actions")}];return e.jsxs("div",{children:[e.jsx(Y,{style:{marginBottom:16},children:e.jsxs(Ee,{justify:"space-between",align:"middle",children:[e.jsx(be,{children:e.jsx(V.Search,{placeholder:t("models.searchPlaceholder",{defaultValue:"Search AI models..."}),style:{width:300},value:j,onChange:m=>k(m.target.value),allowClear:!0})}),e.jsx(be,{children:e.jsxs(H,{children:[e.jsx(C,{type:"primary",icon:e.jsx(ue,{}),onClick:R,loading:M,children:l("refresh",{defaultValue:"Refresh"})}),e.jsx(X,{permission:"ai:models:create",children:e.jsx(C,{type:"primary",icon:e.jsx(ve,{}),onClick:v,children:t("models.create",{defaultValue:"Create AI Model"})})})]})})]})}),e.jsx(Y,{children:e.jsx(Se,{columns:ie,dataSource:(T==null?void 0:T.data)||[],loading:M,rowKey:"id",pagination:{total:(T==null?void 0:T.total)||0,current:(T==null?void 0:T.current)||1,pageSize:(T==null?void 0:T.page_size)||10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(m,c)=>t("common.pagination.total",{defaultValue:`${c[0]}-${c[1]} of ${m} items`,start:c[0],end:c[1],total:m})}})}),e.jsx(W,{title:g?t("models.edit",{defaultValue:"Edit AI Model"}):t("models.create",{defaultValue:"Create AI Model"}),open:n,onCancel:()=>{f(!1),s.resetFields(),b(null)},footer:null,width:600,children:e.jsxs(i,{form:s,layout:"vertical",onFinish:le,onValuesChange:(m,c)=>U(c),children:[e.jsx(i.Item,{name:"name",label:t("models.name",{defaultValue:"Name"}),rules:[{required:!0,message:t("models.nameRequired",{defaultValue:"Please enter model name"})}],children:e.jsx(V,{placeholder:t("models.namePlaceholder",{defaultValue:"Enter model name"})})}),e.jsx(i.Item,{name:"description",label:t("models.description",{defaultValue:"Description"}),children:e.jsx(Dt,{rows:3,placeholder:t("models.descriptionPlaceholder",{defaultValue:"Enter model description"})})}),e.jsx(i.Item,{name:"provider",label:t("models.provider",{defaultValue:"Provider"}),rules:[{required:!0,message:t("models.providerRequired",{defaultValue:"Please select provider"})}],children:e.jsx(O,{loading:z,placeholder:t("models.providerPlaceholder",{defaultValue:"Select provider"}),onChange:P,value:o,options:I==null?void 0:I.map(m=>({label:m.name,value:m.provider}))})}),(oe=S==null?void 0:S.config_fields)==null?void 0:oe.map(m=>e.jsx(Ge,{field:m,selectedType:o,dependentValues:ae(m),formValues:x},m.name)),e.jsxs(i.Item,{name:"is_default",valuePropName:"checked",children:[e.jsx(se,{})," ",e.jsx("span",{style:{marginLeft:8},children:t("models.setAsDefault",{defaultValue:"Set as default model"})})]}),e.jsx(i.Item,{hidden:!0,name:"status",label:t("models.status",{defaultValue:"Status"}),children:e.jsx(V,{})}),e.jsx(i.Item,{children:e.jsxs(H,{children:[e.jsx(C,{type:"primary",htmlType:"submit",loading:w||N,children:g?l("update",{defaultValue:"Update"}):l("create",{defaultValue:"Create"})}),e.jsx(C,{onClick:()=>{f(!1),s.resetFields(),b(null),p(""),U({})},children:l("cancel",{defaultValue:"Cancel"})})]})})]})})]})},{TextArea:Bt}=V,Ht=()=>{var Ce;const{t}=$("system"),{t:l}=$("common"),[s]=i.useForm(),[n,f]=h.useState(!1),[g,b]=h.useState(null),[j,k]=h.useState(""),[o,p]=h.useState(!1),[x,U]=h.useState(null),[z,I]=h.useState(""),[S,M]=h.useState(!1),[T,R]=h.useState([]),[w,G]=h.useState({}),[N,J]=h.useState(),{loading:B,data:q,refresh:L}=_(()=>F.system.listToolSets({current:1,page_size:100,search:j,type:N}),{refreshDeps:[j,N],onError:a=>{d.error(t("settings.toolsets.fetchFailed",{defaultValue:"Failed to fetch toolsets"})),console.error("Failed to fetch toolsets:",a)}}),{loading:v,data:u}=_(()=>F.system.getToolSetTypeDefinitions(),{refreshDeps:[],onError:a=>{d.error(t("settings.toolsets.fetchTypeDefinitionsFailed",{defaultValue:"Failed to fetch toolset type definitions"})),console.error("Failed to fetch toolset type definitions:",a)}}),P=h.useMemo(()=>u==null?void 0:u.find(a=>a.tool_set_type===z),[u,z]),{loading:le,run:ae}=_(a=>F.system.createToolSet({...a,type:a.type}),{manual:!0,onSuccess:()=>{d.success(t("settings.toolsets.createSuccess",{defaultValue:"toolset created successfully"})),f(!1),s.resetFields(),L()},onError:a=>{d.error(t("settings.toolsets.createFailed",{defaultValue:"Failed to create toolset"})),console.error("Failed to create toolset:",a)}}),{loading:ie,run:oe}=_(({id:a,data:r})=>F.system.updateToolSet({id:a},{...r,type:r.type}),{manual:!0,onSuccess:()=>{d.success(t("settings.toolsets.updateSuccess",{defaultValue:"toolset updated successfully"})),f(!1),s.resetFields(),b(null),L()},onError:a=>{d.error(t("settings.toolsets.updateFailed",{defaultValue:"Failed to update toolset"})),console.error("Failed to update toolset:",a)}}),{run:m}=_(a=>F.system.deleteToolSet({id:a}),{manual:!0,onSuccess:()=>{d.success(t("settings.toolsets.deleteSuccess",{defaultValue:"toolset deleted successfully"})),L()},onError:a=>{d.error(t("settings.toolsets.deleteFailed",{defaultValue:"Failed to delete toolset"})),console.error("Failed to delete toolset:",a)}}),{runAsync:c}=_(a=>F.system.testToolSet({id:a}),{manual:!0,onSuccess:()=>{d.success(t("settings.toolsets.testSuccess",{defaultValue:"toolset connection test successful"}))},onError:a=>{d.error(t("settings.toolsets.testFailed",{defaultValue:"toolset connection test failed"})),console.error("Failed to test toolset:",a)}}),{loading:D,runAsync:ee}=_(a=>F.system.getToolSetTools({id:a}),{manual:!0,onSuccess:a=>{R(a||[]),M(!0)},onError:a=>{d.error(t("settings.toolsets.fetchToolsFailed",{defaultValue:"Failed to fetch tools"})),console.error("Failed to fetch tools:",a)}}),{runAsync:Q}=_(({id:a,status:r})=>F.system.updateToolSetStatus({id:a},{status:r}),{manual:!0,onSuccess:()=>{d.success(t("settings.toolsets.statusUpdateSuccess",{defaultValue:"Status updated successfully"})),L()},onError:a=>{d.error(t("settings.toolsets.statusUpdateFailed",{defaultValue:"Failed to update status"})),console.error("Failed to update status:",a)}}),ne=()=>{b(null),s.resetFields(),I(""),f(!0)},me=a=>{b(a),I(a.type);const r={...a};if(r.config){const A=u==null?void 0:u.find(E=>E.tool_set_type===a.type);if(A){const E={};A.config_fields.forEach(Z=>{var Ve,Re;Z.type==="object"&&((Ve=r.config)!=null&&Ve[Z.name])?E[Z.name]=JSON.stringify(r.config[Z.name],null,2):((Re=r.config)==null?void 0:Re[Z.name])!==void 0&&(E[Z.name]=r.config[Z.name])}),r.config=E}}s.setFieldsValue(r),f(!0)};console.log(z,u);const xe=a=>{I(a);const r=u==null?void 0:u.find(A=>A.tool_set_type===a);if(r){const A={};r.config_fields.forEach(E=>{if(E.default)switch(E.type){case"number":A[E.name]=Number(E.default);break;case"boolean":A[E.name]=E.default==="true";break;case"array":A[E.name]=E.default.split(",");break;default:A[E.name]=E.default}}),s.setFieldValue("config",A)}else s.setFieldValue("config",void 0)},fe=a=>{if(a.config&&P){const r={};P.config_fields.forEach(A=>{var Z;const E=(Z=a.config)==null?void 0:Z[A.name];if(E!==void 0)if(A.type==="object")try{r[A.name]=typeof E=="string"?JSON.parse(E):E}catch{r[A.name]=E}else r[A.name]=E}),a.config=r}g?oe({id:g.id,data:a}):ae(a)},ge=a=>{m(a)},y=a=>{U(a),p(!0)},K=a=>{console.log(new Date,"handleToggleStatus");const r=a.status==="enabled"?"disabled":"enabled";return Q({id:a.id,status:r}).then(()=>{console.log(new Date,"handleToggleStatus1")})},re=a=>{var A;if(!((A=a.data_source)!=null&&A.depends_on)||a.data_source.depends_on.length===0)return{};const r={};return a.data_source.depends_on.forEach(E=>{var Ve;const Z=(Ve=w.config)==null?void 0:Ve[E];Z!==void 0&&(r[E]=Z)}),r};console.log(q);const ye=[{title:t("settings.toolsets.name",{defaultValue:"Name"}),dataIndex:"name",key:"name"},{title:t("settings.toolsets.type",{defaultValue:"Type"}),dataIndex:"type",key:"type",render:a=>e.jsx(te,{color:"blue",children:a.toUpperCase()})},{title:t("settings.toolsets.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:a=>e.jsx(te,{color:a==="enabled"?"green":"red",children:a==="enabled"?t("common.enabled",{defaultValue:"Enabled"}):t("common.disabled",{defaultValue:"Disabled"})})},{title:l("actions",{defaultValue:"Actions"}),key:"actions",width:200,render:(a,r)=>e.jsx(Ie,{actions:[{key:"test",permission:"system:toolsets:test",tooltip:t("settings.toolsets.test",{defaultValue:"Test Connection"}),icon:e.jsx(at,{}),disabled:r.status!=="enabled",onClick:async()=>c(r.id)},{key:"viewTools",icon:e.jsx(Le,{}),permission:"system:toolsets:view",disabled:r.status!=="enabled",tooltip:t("settings.toolsets.viewTools",{defaultValue:"View Tools"}),onClick:async()=>ee(r.id)},{key:"viewConfig",icon:e.jsx(it,{}),permission:"system:toolsets:view",tooltip:t("settings.toolsets.viewConfig",{defaultValue:"View Configuration"}),onClick:async()=>y(r.config),disabled:!r.config},{key:"edit",permission:"system:toolsets:update",tooltip:t("settings.toolsets.edit",{defaultValue:"Edit"}),icon:e.jsx(ke,{}),onClick:async()=>me(r)},{key:"toggleStatus",icon:r.status==="enabled"?e.jsx(nt,{}):e.jsx(Be,{}),onClick:async()=>K(r),permission:"system:toolsets:update",tooltip:r.status==="enabled"?l("disable",{defaultValue:"Disable"}):l("enable",{defaultValue:"Enable"})},{key:"delete",icon:e.jsx(he,{}),permission:"system:toolsets:delete",tooltip:l("delete",{defaultValue:"Delete"}),onClick:async()=>ge(r.id),danger:!0,confirm:{title:t("settings.toolsets.deleteConfirm",{defaultValue:"Are you sure you want to delete this toolset?"}),onConfirm:async()=>ge(r.id),okText:l("confirm",{defaultValue:"Confirm"}),cancelText:l("cancel",{defaultValue:"Cancel"})}}]},"actions")}];return e.jsxs("div",{children:[e.jsx(Y,{style:{marginBottom:16},children:e.jsxs(Ee,{justify:"space-between",align:"middle",children:[e.jsx(be,{children:e.jsxs(H,{children:[e.jsx(V.Search,{placeholder:t("settings.toolsets.searchPlaceholder",{defaultValue:"Search toolsets..."}),style:{width:300},value:j,onChange:a=>k(a.target.value),allowClear:!0}),e.jsxs(O,{placeholder:t("settings.toolsets.typePlaceholder",{defaultValue:"Select type"}),value:N,onChange:a=>J(a),options:u==null?void 0:u.map(a=>({label:a.name,value:a.tool_set_type})),style:{minWidth:110},allowClear:!0,children:[e.jsx(O.Option,{value:"",children:"All"}),u==null?void 0:u.map(a=>e.jsx(O.Option,{value:a.tool_set_type,children:a.name},a.tool_set_type))]})]})}),e.jsx(be,{children:e.jsxs(H,{children:[e.jsx(C,{type:"primary",icon:e.jsx(ue,{}),onClick:L,loading:B,children:l("refresh",{defaultValue:"Refresh"})}),e.jsx(X,{permission:"system:toolsets:create",children:e.jsx(C,{type:"primary",icon:e.jsx(ve,{}),onClick:ne,children:t("settings.toolsets.create",{defaultValue:"Create Toolset"})})})]})})]})}),e.jsx(Y,{children:e.jsx(Se,{columns:ye,dataSource:(q==null?void 0:q.data)||[],loading:B,rowKey:"id",pagination:{total:(q==null?void 0:q.total)||0,current:(q==null?void 0:q.current)||1,pageSize:(q==null?void 0:q.page_size)||10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(a,r)=>t("common.pagination.total",{defaultValue:`${r[0]}-${r[1]} of ${a} items`,start:r[0],end:r[1],total:a})}})}),e.jsx(W,{title:g?t("settings.toolsets.edit",{defaultValue:"Edit Toolset"}):t("settings.toolsets.create",{defaultValue:"Create Toolset"}),open:n,onCancel:()=>{f(!1),s.resetFields(),b(null),I("")},footer:null,width:600,children:e.jsxs(i,{form:s,layout:"vertical",onFinish:fe,onValuesChange:(a,r)=>G(r),children:[e.jsx(i.Item,{name:"name",label:t("settings.toolsets.name",{defaultValue:"Name"}),rules:[{required:!0,message:t("settings.toolsets.nameRequired",{defaultValue:"Please enter toolset name"})}],children:e.jsx(V,{placeholder:t("settings.toolsets.namePlaceholder",{defaultValue:"Enter toolset name"})})}),e.jsx(i.Item,{name:"description",label:t("settings.toolsets.description",{defaultValue:"Description"}),children:e.jsx(Bt,{rows:3,placeholder:t("settings.toolsets.descriptionPlaceholder",{defaultValue:"Enter toolset description"})})}),e.jsx(i.Item,{name:"type",label:t("settings.toolsets.type",{defaultValue:"Type"}),rules:[{required:!0,message:t("settings.toolsets.typeRequired",{defaultValue:"Please select type"})}],children:e.jsx(O,{loading:v,placeholder:t("settings.toolsets.typePlaceholder",{defaultValue:"Select type"}),onChange:xe,value:z,options:u==null?void 0:u.map(a=>({label:a.name,value:a.tool_set_type}))})}),(Ce=P==null?void 0:P.config_fields)==null?void 0:Ce.map(a=>e.jsx(Ge,{field:a,selectedType:z,dependentValues:re(a),formValues:w},a.name)),e.jsx(i.Item,{hidden:!0,name:"status",label:t("settings.toolsets.status",{defaultValue:"Status"}),children:e.jsx(V,{})}),e.jsx(i.Item,{children:e.jsxs(H,{children:[e.jsx(C,{type:"primary",htmlType:"submit",loading:le||ie,children:g?l("update",{defaultValue:"Update"}):l("create",{defaultValue:"Create"})}),e.jsx(C,{onClick:()=>{f(!1),s.resetFields(),b(null),I("")},children:l("cancel",{defaultValue:"Cancel"})})]})})]})}),e.jsx(W,{title:t("settings.toolsets.configuration",{defaultValue:"Configuration"}),open:o,onCancel:()=>p(!1),footer:[e.jsx(C,{onClick:()=>p(!1),children:l("close",{defaultValue:"Close"})},"close")],width:600,children:e.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4,overflow:"auto"},children:JSON.stringify(x,null,2)})}),e.jsx(W,{title:t("settings.toolsets.tools",{defaultValue:"Tools"}),open:S,onCancel:()=>M(!1),footer:[e.jsx(C,{onClick:()=>M(!1),children:l("close",{defaultValue:"Close"})},"close")],width:800,children:e.jsx("div",{style:{maxHeight:"600px",overflow:"auto"},children:D?e.jsx("div",{style:{textAlign:"center",padding:40},children:e.jsx(ue,{style:{fontSize:24},spin:!0})}):T.length===0?e.jsx("div",{style:{textAlign:"center",padding:40,color:"#999"},children:t("settings.toolsets.noTools",{defaultValue:"No tools available"})}):T.map((a,r)=>{var A,E,Z;return e.jsx(Y,{style:{marginBottom:16},title:e.jsxs(H,{children:[e.jsx(Le,{}),e.jsx("strong",{children:((A=a.function)==null?void 0:A.name)||"Unknown"})]}),children:e.jsxs(Ee,{gutter:16,children:[e.jsxs(be,{span:24,children:[e.jsx("p",{children:e.jsxs("strong",{children:[t("settings.toolsets.description",{defaultValue:"Description"}),":"]})}),e.jsx("p",{style:{marginBottom:16},children:((E=a.function)==null?void 0:E.description)||"-"})]}),((Z=a.function)==null?void 0:Z.parameters)&&e.jsxs(be,{span:24,children:[e.jsx("p",{children:e.jsxs("strong",{children:[t("settings.toolsets.parameters",{defaultValue:"Parameters"}),":"]})}),e.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4,overflow:"auto",fontSize:12},children:JSON.stringify(a.function.parameters,null,2)})]})]})},r)})})})]})},{TextArea:Ne}=V,Kt=()=>{const{t}=$("system"),{t:l}=$("common"),s=_e(),[n]=i.useForm(),[f,g]=h.useState(""),[b,j]=h.useState(),[k,o]=h.useState(!1),[p,x]=h.useState(null),[U,z]=h.useState(!1),[I]=i.useForm(),{loading:S,data:M,refresh:T}=_(()=>F.system.listSkills({current:1,page_size:100,search:f||void 0,domain:b}),{refreshDeps:[f,b],onError:()=>{d.error(t("settings.skills.fetchFailed",{defaultValue:"Failed to fetch skills"}))}}),{data:R}=_(()=>F.system.listSkillDomains()),w=R??[],G=(M==null?void 0:M.data)??[],N=(M==null?void 0:M.total)??0,{loading:J,run:B}=_(c=>F.system.createSkill(c),{manual:!0,onSuccess:()=>{d.success(t("settings.skills.createSuccess",{defaultValue:"Skill created"})),o(!1),n.resetFields(),T()},onError:()=>{d.error(t("settings.skills.createFailed",{defaultValue:"Failed to create skill"}))}}),{loading:q,run:L}=_(({id:c,body:D})=>F.system.updateSkill({id:c},D),{manual:!0,onSuccess:()=>{d.success(t("settings.skills.updateSuccess",{defaultValue:"Skill updated"})),o(!1),x(null),n.resetFields(),T()},onError:()=>{d.error(t("settings.skills.updateFailed",{defaultValue:"Failed to update skill"}))}}),{run:v}=_(c=>F.system.deleteSkill({id:c}),{manual:!0,onSuccess:()=>{d.success(t("settings.skills.deleteSuccess",{defaultValue:"Skill deleted"})),T()},onError:()=>{d.error(t("settings.skills.deleteFailed",{defaultValue:"Failed to delete skill"}))}}),{loading:u,run:P}=_(c=>F.system.uploadSkill(c.body,c.file),{manual:!0,onSuccess:()=>{d.success(t("settings.skills.uploadSuccess",{defaultValue:"Skill uploaded"})),z(!1),I.resetFields(),T()},onError:()=>{d.error(t("settings.skills.uploadFailed",{defaultValue:"Upload failed"}))}}),le=()=>{x(null),n.resetFields(),o(!0)},ae=c=>{x(c),n.setFieldsValue({name:c.name,description:c.description,category:c.category,domain:c.domain}),o(!0)},ie=()=>{n.validateFields().then(c=>{p?L({id:p.id,body:{name:c.name,description:c.description??"",category:c.category??"",domain:c.domain??""}}):B({name:c.name,description:c.description??"",category:c.category??"",domain:c.domain??"",content:c.content??""})})},oe=()=>{var ne,me;const c=(ne=I.getFieldValue("file"))==null?void 0:ne.fileList,D=((me=c==null?void 0:c[0])==null?void 0:me.originFileObj)??(c==null?void 0:c[0]);if(!D){d.error(t("settings.skills.selectFile",{defaultValue:"Please select a file"}));return}const ee=I.getFieldValue("category"),Q=I.getFieldValue("domain");P({body:{category:ee,domain:Q},file:D})},m=[{title:t("settings.skills.name",{defaultValue:"Name"}),dataIndex:"name",key:"name"},{title:t("settings.skills.description",{defaultValue:"Description"}),dataIndex:"description",key:"description",ellipsis:!0},{title:t("settings.skills.category",{defaultValue:"Category"}),dataIndex:"category",key:"category",render:c=>c?e.jsx(te,{children:c}):"-"},{title:t("settings.skills.domain",{defaultValue:"Domain"}),dataIndex:"domain",key:"domain",render:c=>c?e.jsx(te,{color:"blue",children:c}):"-"},{title:l("actions",{defaultValue:"Actions"}),key:"actions",render:(c,D)=>e.jsxs(H,{children:[e.jsx(X,{permission:"system:skills:edit_files",children:e.jsx(C,{type:"link",size:"small",icon:e.jsx(ot,{}),onClick:()=>s(`/system/settings/skills/${D.id}/edit`),children:t("settings.skills.editFiles",{defaultValue:"Edit files"})})}),e.jsx(X,{permission:"system:skills:view",children:e.jsx(C,{type:"link",size:"small",icon:e.jsx(He,{}),onClick:()=>s(`/system/settings/skills/${D.id}/preview`),children:l("preview",{defaultValue:"Preview"})})}),e.jsx(X,{permission:"system:skills:update",children:e.jsx(C,{type:"link",size:"small",icon:e.jsx(ke,{}),onClick:()=>ae(D),children:l("edit",{defaultValue:"Edit"})})}),e.jsx(X,{permission:"system:skills:delete",children:e.jsx(C,{type:"link",size:"small",danger:!0,icon:e.jsx(he,{}),onClick:()=>W.confirm({title:l("confirmDelete",{defaultValue:"Confirm delete?"}),onOk:()=>v(D.id)}),children:l("delete",{defaultValue:"Delete"})})})]})}];return e.jsxs(Y,{title:t("settings.skills.title",{defaultValue:"AI Agent Skills"}),extra:e.jsxs(H,{children:[e.jsx(V.Search,{placeholder:l("search",{defaultValue:"Search"}),allowClear:!0,onSearch:g,style:{width:200}}),e.jsx(O,{placeholder:t("settings.skills.domain",{defaultValue:"Domain"}),allowClear:!0,style:{width:120},value:b,onChange:j,options:w.map(c=>({value:c,label:c}))}),e.jsx(C,{icon:e.jsx(ue,{}),onClick:()=>T(),children:l("refresh",{defaultValue:"Refresh"})}),e.jsx(X,{permission:"system:skills:create",children:e.jsx(C,{type:"primary",icon:e.jsx(ve,{}),onClick:le,children:t("settings.skills.create",{defaultValue:"Create skill"})})}),e.jsx(X,{permission:"system:skills:create",children:e.jsx(C,{icon:e.jsx(Oe,{}),onClick:()=>z(!0),children:t("settings.skills.upload",{defaultValue:"Upload"})})})]}),children:[e.jsx(Se,{rowKey:"id",loading:S,columns:m,dataSource:G,pagination:{total:N,pageSize:10,showSizeChanger:!0}}),e.jsx(W,{title:p?t("settings.skills.editSkill",{defaultValue:"Edit skill"}):t("settings.skills.createSkill",{defaultValue:"Create skill"}),open:k,onOk:ie,onCancel:()=>{o(!1),x(null)},confirmLoading:J||q,width:560,children:e.jsxs(i,{form:n,layout:"vertical",children:[e.jsx(i.Item,{name:"name",label:t("settings.skills.name",{defaultValue:"Name"}),rules:[{required:!0}],children:e.jsx(V,{})}),e.jsx(i.Item,{name:"description",label:t("settings.skills.description",{defaultValue:"Description"}),children:e.jsx(Ne,{rows:2})}),e.jsx(i.Item,{name:"category",label:t("settings.skills.category",{defaultValue:"Category"}),children:e.jsx(V,{})}),e.jsx(i.Item,{name:"domain",label:t("settings.skills.domain",{defaultValue:"Domain"}),children:e.jsx(O,{allowClear:!0,placeholder:l("optional",{defaultValue:"Optional"}),options:w.map(c=>({value:c,label:c}))})}),!p&&e.jsx(i.Item,{name:"content",label:t("settings.skills.initialContent",{defaultValue:"Initial SKILL.md content (optional)"}),children:e.jsx(Ne,{rows:6,placeholder:`---
name: my-skill
description: ...
---

# My Skill`})})]})}),e.jsx(W,{title:t("settings.skills.upload",{defaultValue:"Upload skill"}),open:U,onOk:oe,onCancel:()=>z(!1),confirmLoading:u,children:e.jsxs(i,{form:I,layout:"vertical",children:[e.jsx(i.Item,{name:"file",label:t("settings.skills.file",{defaultValue:"File (.md or .zip)"}),rules:[{required:!0}],children:e.jsx(rt,{maxCount:1,beforeUpload:()=>!1,accept:".md,.zip",children:e.jsx(C,{icon:e.jsx(Oe,{}),children:l("selectFile",{defaultValue:"Select file"})})})}),e.jsx(i.Item,{name:"category",label:t("settings.skills.category",{defaultValue:"Category"}),children:e.jsx(V,{})}),e.jsx(i.Item,{name:"domain",label:t("settings.skills.domain",{defaultValue:"Domain"}),children:e.jsx(O,{allowClear:!0,placeholder:l("optional",{defaultValue:"Optional"}),options:w.map(c=>({value:c,label:c}))})})]})})]})},Wt=()=>{const{t}=$("system"),{t:l}=$("common"),[s]=i.useForm(),{loading:n,refresh:f}=_(F.system.getTaskSettings,{onSuccess:k=>{k&&s.setFieldsValue({max_concurrent:k.max_concurrent})},onError:()=>{d.error(t("settings.fetchFailed",{defaultValue:"Failed to fetch settings"}))}}),{loading:g,run:b}=_(F.system.updateTaskSettings,{manual:!0,onSuccess:()=>{d.success(t("settings.updateSuccess",{defaultValue:"Settings updated successfully"})),f()},onError:()=>{d.error(t("settings.updateFailed",{defaultValue:"Failed to update settings"}))}}),j=k=>{b(k)};return e.jsx(pe,{spinning:n,children:e.jsxs(i,{form:s,layout:"vertical",onFinish:j,initialValues:{max_concurrent:10},children:[e.jsx(i.Item,{name:"max_concurrent",label:t("settings.task.maxConcurrent",{defaultValue:"Max concurrent tasks"}),tooltip:t("settings.task.maxConcurrentTooltip",{defaultValue:"Maximum number of tasks that can run at the same time."}),rules:[{type:"number",min:1,max:100}],children:e.jsx(ce,{min:1,max:100,style:{width:"100%"}})}),e.jsx(i.Item,{children:e.jsxs(H,{children:[e.jsx(C,{type:"primary",htmlType:"submit",loading:g,icon:e.jsx(Fe,{}),children:l("save",{defaultValue:"Save"})}),e.jsx(C,{onClick:()=>f(),icon:e.jsx(ue,{}),children:l("refresh",{defaultValue:"Refresh"})})]})})]})})},{TextArea:Gt}=V,Zt=()=>{const t=_e(),{t:l}=$("system"),{t:s}=$("common"),[n]=i.useForm(),[f,g]=h.useState(!1),[b,j]=h.useState(null),[k,o]=h.useState(""),[p,x]=h.useState(1),[U,z]=h.useState(10),{loading:I,data:S,refresh:M}=_(()=>St({current:p,page_size:U,search:k}),{refreshDeps:[p,U,k],onError:u=>{d.error(l("settings.organizations.fetchFailed",{defaultValue:"Failed to fetch organizations"})),console.error("Failed to fetch organizations:",u)}}),{loading:T,run:R}=_(u=>kt(u),{manual:!0,onSuccess:()=>{d.success(l("settings.organizations.createSuccess",{defaultValue:"Organization created successfully"})),g(!1),n.resetFields(),j(null),M()},onError:u=>{d.error((u==null?void 0:u.err)||l("settings.organizations.createFailed",{defaultValue:"Failed to create organization"}))}}),{loading:w,run:G}=_(({id:u,...P})=>vt({id:u},P),{manual:!0,onSuccess:()=>{d.success(l("settings.organizations.updateSuccess",{defaultValue:"Organization updated successfully"})),g(!1),n.resetFields(),j(null),M()},onError:u=>{d.error((u==null?void 0:u.err)||l("settings.organizations.updateFailed",{defaultValue:"Failed to update organization"}))}}),{run:N}=_(u=>_t({id:u}),{manual:!0,onSuccess:()=>{d.success(l("settings.organizations.deleteSuccess",{defaultValue:"Organization deleted successfully"})),M()},onError:u=>{d.error((u==null?void 0:u.err)||l("settings.organizations.deleteFailed",{defaultValue:"Failed to delete organization"}))}}),J=()=>{j(null),n.resetFields(),n.setFieldsValue({status:"active"}),g(!0)},B=u=>{j(u),n.setFieldsValue({name:u.name,description:u.description,status:u.status}),g(!0)},q=u=>{W.confirm({title:l("settings.organizations.deleteConfirm",{defaultValue:"Delete Organization"}),content:l("settings.organizations.deleteConfirmContent",{defaultValue:`Are you sure you want to delete organization "${u.name}"? This action cannot be undone.`}),onOk:()=>N(u.id)})},L=()=>{n.validateFields().then(u=>{b?G({id:b.id,...u}):R(u)})},v=[{title:l("settings.organizations.name",{defaultValue:"Name"}),dataIndex:"name",key:"name"},{title:l("settings.organizations.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:l("settings.organizations.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:u=>e.jsx(te,{color:u==="active"?"green":"default",children:u==="active"?l("settings.organizations.active",{defaultValue:"Active"}):l("settings.organizations.disabled",{defaultValue:"Disabled"})})},{title:s("actions",{defaultValue:"Actions"}),key:"actions",render:(u,P)=>e.jsx(Ie,{actions:[{key:"view",label:s("view",{defaultValue:"View"}),icon:e.jsx(He,{}),onClick:async()=>t(`/system/settings/organizations/${P.id}`),permission:"system:organization:view"},{key:"edit",label:s("edit",{defaultValue:"Edit"}),icon:e.jsx(ke,{}),onClick:async()=>B(P),permission:"system:organization:update"},{key:"delete",label:s("delete",{defaultValue:"Delete"}),icon:e.jsx(he,{}),danger:!0,onClick:async()=>q(P),permission:"system:organization:delete"}]})}];return e.jsxs(Y,{title:l("settings.organizations.title",{defaultValue:"Organization Management"}),extra:e.jsxs(H,{children:[e.jsx(C,{icon:e.jsx(ue,{}),onClick:M,children:s("refresh",{defaultValue:"Refresh"})}),e.jsx(X,{permission:"system:organization:create",children:e.jsx(C,{type:"primary",icon:e.jsx(ve,{}),onClick:J,children:l("settings.organizations.create",{defaultValue:"Create Organization"})})})]}),children:[e.jsxs(H,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsx(V.Search,{placeholder:l("settings.organizations.searchPlaceholder",{defaultValue:"Search organizations..."}),allowClear:!0,onSearch:u=>{o(u),x(1)},style:{width:300}}),e.jsx(Se,{columns:v,dataSource:(S==null?void 0:S.data)||[],loading:I,rowKey:"id",pagination:{current:p,pageSize:U,total:(S==null?void 0:S.total)||0,showSizeChanger:!0,showTotal:(u,P)=>l("common.pagination.total",{defaultValue:`${P[0]}-${P[1]} of ${u} items`,start:P[0],end:P[1],total:u}),onChange:(u,P)=>{x(u),z(P)}}})]}),e.jsx(W,{title:b?l("settings.organizations.edit",{defaultValue:"Edit Organization"}):l("settings.organizations.create",{defaultValue:"Create Organization"}),open:f,onOk:L,onCancel:()=>{g(!1),n.resetFields(),j(null)},confirmLoading:T||w,width:600,children:e.jsxs(i,{form:n,layout:"vertical",children:[e.jsx(i.Item,{name:"name",label:l("settings.organizations.name",{defaultValue:"Name"}),rules:[{required:!0,message:l("settings.organizations.nameRequired",{defaultValue:"Please enter organization name"})}],children:e.jsx(V,{})}),e.jsx(i.Item,{name:"description",label:l("settings.organizations.description",{defaultValue:"Description"}),children:e.jsx(Gt,{rows:3})}),e.jsx(i.Item,{name:"status",label:l("settings.organizations.status",{defaultValue:"Status"}),rules:[{required:!0}],children:e.jsxs(O,{children:[e.jsx(O.Option,{value:"active",children:l("settings.organizations.active",{defaultValue:"Active"})}),e.jsx(O.Option,{value:"disabled",children:l("settings.organizations.disabled",{defaultValue:"Disabled"})})]})})]})})]})},Jt=({transformItems:t=l=>l})=>{const{t:l}=$("system"),s=_e(),n=dt(),b=n.hash.replace("#","")||"base",{enableMultiOrg:j}=At(),{hasPermission:k}=Et(),o=[{key:"base",label:l("settings.tabs.base",{defaultValue:"Base Settings"}),children:e.jsx(Nt,{}),hidden:!k("system:settings:update")},{key:"security",label:l("settings.tabs.security",{defaultValue:"Security Settings"}),children:e.jsx(Lt,{}),hidden:!k("system:security:update")},{key:"oauth",label:l("settings.tabs.oauth",{defaultValue:"OAuth Settings"}),children:e.jsx(Pt,{}),hidden:!k("system:settings:update")},{key:"ldap",label:l("settings.tabs.ldap",{defaultValue:"LDAP Settings"}),children:e.jsx(Ut,{}),hidden:!k("system:settings:update")},{key:"smtp",label:l("settings.tabs.smtp",{defaultValue:"SMTP Settings"}),children:e.jsx(qt,{}),hidden:!k("system:settings:update")},{key:"ai-models",label:l("settings.tabs.aiModels",{defaultValue:"AI Models"}),children:e.jsx($t,{}),hidden:!k("ai:models:view")},{key:"ai-toolsets",label:l("settings.tabs.toolSets",{defaultValue:"Tool Sets"}),children:e.jsx(Ht,{}),hidden:!k("system:toolsets:view")},{key:"skills",label:l("settings.tabs.skills",{defaultValue:"Skills"}),children:e.jsx(Kt,{}),hidden:!k("system:skills:view")},{key:"task",label:l("settings.tabs.task",{defaultValue:"Task Settings"}),children:e.jsx(Wt,{}),hidden:!k("system:settings:update")},...j?[{key:"organizations",label:l("settings.tabs.organizations",{defaultValue:"Organizations"}),children:e.jsx(Zt,{}),hidden:!k("system:organization:view")}]:[]];return e.jsx(Y,{title:l("settings.title",{defaultValue:"System Settings"}),children:e.jsx($e,{defaultActiveKey:b,onChange:p=>{s(`${n.pathname}#${p}`)},items:t(o.filter(p=>!p.hidden),l)})})},us=Object.freeze(Object.defineProperty({__proto__:null,default:Jt},Symbol.toStringTag,{value:"Module"})),Qt=()=>{var xe,fe,ge;const t=_e(),{id:l}=Me(),{t:s}=$("system"),{t:n}=$("common"),[f]=i.useForm(),[g]=i.useForm(),[b,j]=h.useState(!1),[k,o]=h.useState(!1),[p,x]=h.useState(null),[U,z]=h.useState(""),[I,S]=h.useState(1),[M,T]=h.useState(10),{data:R,loading:w,refresh:G}=_(()=>Ct({id:l}),{ready:!!l,onError:y=>{d.error(s("settings.organizations.fetchFailed",{defaultValue:"Failed to fetch organization"})),console.error("Failed to fetch organization:",y)}}),{data:N,loading:J,refresh:B}=_(()=>Ft({id:l,current:I,page_size:M,search:U}),{ready:!!l,refreshDeps:[l,I,M,U],onError:y=>{d.error(s("settings.organizations.users.fetchFailed",{defaultValue:"Failed to fetch organization users"})),console.error("Failed to fetch organization users:",y)}}),{data:q,loading:L}=_(()=>zt({current:1,page_size:1e3}),{ready:b}),{data:v,loading:u}=_(()=>Mt({organization_id:l,current:1,page_size:1e3}),{ready:!!l}),{loading:P,run:le}=_(y=>wt({id:l},y),{manual:!0,onSuccess:()=>{d.success(s("settings.organizations.users.addSuccess",{defaultValue:"User added to organization successfully"})),j(!1),f.resetFields(),B()},onError:y=>{d.error((y==null?void 0:y.err)||s("settings.organizations.users.addFailed",{defaultValue:"Failed to add user to organization"}))}}),{loading:ae,run:ie}=_(y=>It({id:l,user_id:p==null?void 0:p.id},y),{manual:!0,onSuccess:()=>{d.success(s("settings.organizations.users.updateRolesSuccess",{defaultValue:"User roles updated successfully"})),o(!1),g.resetFields(),x(null),B()},onError:y=>{d.error((y==null?void 0:y.err)||s("settings.organizations.users.updateRolesFailed",{defaultValue:"Failed to update user roles"}))}}),{run:oe}=_(y=>Tt({id:l,user_id:y}),{manual:!0,onSuccess:()=>{d.success(s("settings.organizations.users.removeSuccess",{defaultValue:"User removed from organization successfully"})),B()},onError:y=>{d.error((y==null?void 0:y.err)||s("settings.organizations.users.removeFailed",{defaultValue:"Failed to remove user from organization"}))}}),m=()=>{j(!0),f.resetFields()},c=y=>{var K;x(y),g.setFieldsValue({role_ids:((K=y.organization_roles)==null?void 0:K.map(re=>re.id))||[]}),o(!0)},D=y=>{W.confirm({title:s("settings.organizations.users.removeConfirm",{defaultValue:"Remove User"}),content:s("settings.organizations.users.removeConfirmContent",{defaultValue:`Are you sure you want to remove user "${y.full_name||y.username}" from this organization? This will also remove all their roles in this organization.`}),onOk:()=>oe(y.id)})},ee=()=>{f.validateFields().then(y=>{le(y)})},Q=()=>{g.validateFields().then(y=>{ie(y)})},ne=((xe=q==null?void 0:q.data)==null?void 0:xe.filter(y=>{var K;return!((K=N==null?void 0:N.data)!=null&&K.some(re=>re.id===y.id))}))||[],me=[{title:s("settings.organizations.users.username",{defaultValue:"Username"}),dataIndex:"username",key:"username"},{title:s("settings.organizations.users.email",{defaultValue:"Email"}),dataIndex:"email",key:"email"},{title:s("settings.organizations.users.fullName",{defaultValue:"Full Name"}),dataIndex:"full_name",key:"full_name"},{title:s("settings.organizations.users.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:y=>e.jsx(te,{color:y==="active"?"green":"default",children:y==="active"?s("settings.organizations.active",{defaultValue:"Active"}):y})},{title:s("settings.organizations.users.roles",{defaultValue:"Roles"}),key:"roles",render:(y,K)=>{var re;return e.jsx(H,{wrap:!0,children:((re=K.organization_roles)==null?void 0:re.map(ye=>e.jsx(te,{children:ye.name},ye.id)))||e.jsx(te,{children:"No roles"})})}},{title:n("actions",{defaultValue:"Actions"}),key:"actions",render:(y,K)=>e.jsx(Ie,{actions:[{key:"edit",label:s("settings.organizations.users.editRoles",{defaultValue:"Edit Roles"}),icon:e.jsx(ke,{}),onClick:async()=>c(K)},{key:"delete",label:s("settings.organizations.users.remove",{defaultValue:"Remove"}),icon:e.jsx(he,{}),danger:!0,onClick:async()=>D(K)}]})}];return e.jsxs("div",{children:[e.jsx(Y,{title:e.jsxs(H,{children:[e.jsx(C,{icon:e.jsx(ut,{}),onClick:()=>t("/system/settings#organizations"),children:n("back",{defaultValue:"Back"})}),e.jsxs("span",{children:[s("settings.organizations.detail",{defaultValue:"Organization Detail"}),": ",R==null?void 0:R.name]})]}),extra:e.jsx(C,{icon:e.jsx(ue,{}),onClick:()=>{G(),B()},children:n("refresh",{defaultValue:"Refresh"})}),loading:w,children:e.jsxs(de,{column:2,bordered:!0,children:[e.jsx(de.Item,{label:s("settings.organizations.name",{defaultValue:"Name"}),children:R==null?void 0:R.name}),e.jsx(de.Item,{label:s("settings.organizations.status",{defaultValue:"Status"}),children:e.jsx(te,{color:(R==null?void 0:R.status)==="active"?"green":"default",children:(R==null?void 0:R.status)==="active"?s("settings.organizations.active",{defaultValue:"Active"}):s("settings.organizations.disabled",{defaultValue:"Disabled"})})}),e.jsx(de.Item,{label:s("settings.organizations.description",{defaultValue:"Description"}),span:2,children:(R==null?void 0:R.description)||"-"})]})}),e.jsx(Y,{title:s("settings.organizations.users.title",{defaultValue:"Organization Users"}),extra:e.jsx(C,{type:"primary",icon:e.jsx(ve,{}),onClick:m,children:s("settings.organizations.users.add",{defaultValue:"Add User"})}),style:{marginTop:16},children:e.jsxs(H,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsx(V.Search,{placeholder:s("settings.organizations.users.searchPlaceholder",{defaultValue:"Search users..."}),allowClear:!0,onSearch:y=>{z(y),S(1)},style:{width:300}}),e.jsx(Se,{columns:me,dataSource:(N==null?void 0:N.data)||[],loading:J,rowKey:"id",pagination:{current:I,pageSize:M,total:(N==null?void 0:N.total)||0,showSizeChanger:!0,showTotal:y=>n("pagination.total",{defaultValue:`Total ${y} items`}),onChange:(y,K)=>{S(y),T(K)}}})]})}),e.jsx(W,{title:s("settings.organizations.users.add",{defaultValue:"Add User"}),open:b,onOk:ee,onCancel:()=>{j(!1),f.resetFields()},confirmLoading:P,width:600,children:e.jsxs(i,{form:f,layout:"vertical",children:[e.jsx(i.Item,{name:"user_id",label:s("settings.organizations.users.user",{defaultValue:"User"}),rules:[{required:!0,message:s("settings.organizations.users.userRequired",{defaultValue:"Please select a user"})}],children:e.jsx(O,{showSearch:!0,placeholder:s("settings.organizations.users.selectUser",{defaultValue:"Select a user"}),loading:L,filterOption:(y,K)=>((K==null?void 0:K.label)??"").toLowerCase().includes(y.toLowerCase()),options:ne.map(y=>({label:`${y.full_name||y.username} (${y.email})`,value:y.id}))})}),e.jsx(i.Item,{name:"role_ids",label:s("settings.organizations.users.roles",{defaultValue:"Roles"}),children:e.jsx(O,{mode:"multiple",placeholder:s("settings.organizations.users.selectRoles",{defaultValue:"Select roles (optional)"}),loading:u,options:((fe=v==null?void 0:v.data)==null?void 0:fe.map(y=>({label:y.name,value:y.id})))||[]})})]})}),e.jsx(W,{title:s("settings.organizations.users.editRoles",{defaultValue:"Edit Roles"}),open:k,onOk:Q,onCancel:()=>{o(!1),g.resetFields(),x(null)},confirmLoading:ae,width:600,children:e.jsxs(i,{form:g,layout:"vertical",children:[e.jsx(i.Item,{label:s("settings.organizations.users.user",{defaultValue:"User"}),children:e.jsx(V,{value:(p==null?void 0:p.full_name)||(p==null?void 0:p.username),disabled:!0})}),e.jsx(i.Item,{name:"role_ids",label:s("settings.organizations.users.roles",{defaultValue:"Roles"}),children:e.jsx(O,{mode:"multiple",placeholder:s("settings.organizations.users.selectRoles",{defaultValue:"Select roles"}),loading:u,options:((ge=v==null?void 0:v.data)==null?void 0:ge.map(y=>({label:y.name,value:y.id})))||[]})})]})})]})},cs=Object.freeze(Object.defineProperty({__proto__:null,default:Qt},Symbol.toStringTag,{value:"Module"})),Xt=ct(({css:t})=>({fileTree:t`
    .ant-tree-node-content-wrapper{
      padding-inline: 0px;
    }
    .ant-tree-draggable-icon{
      display: none;
    }
    `})),{TextArea:De}=V,Yt=t=>t.toLowerCase().endsWith(".md");function Je(t){return t.map(l=>{var s;return{key:l.path,title:l.name,isLeaf:!l.is_dir,icon:l.is_dir?e.jsx(Ke,{}):e.jsx(We,{}),children:(s=l.children)!=null&&s.length?Je(l.children):void 0}})}function Ae(t){return t.includes("/")?t.replace(/\/[^/]+$/,""):""}const es=()=>{const{styles:t}=Xt(),{id:l}=Me(),s=_e(),{t:n}=$("system"),[f,g]=h.useState(null),[b,j]=h.useState(null),[k,o]=h.useState(!1),[p,x]=h.useState(""),[U,z]=h.useState(!1),[I,S]=h.useState([]),[M,T]=h.useState(!1),[R,w]=h.useState(!1),[G,N]=h.useState(""),[J]=i.useForm(),[B,q]=h.useState(null),[L,v]=h.useState(null),[u,P]=h.useState(""),[le]=i.useForm(),{data:ae}=_(()=>l?F.system.getSkill({id:l}):Promise.reject(new Error("No id")),{refreshDeps:[l],ready:!!l}),{data:ie,loading:oe,refresh:m}=_(()=>l?F.system.listSkillFilesTree({id:l}):Promise.reject(new Error("No id")),{refreshDeps:[l],ready:!!l,onSuccess:a=>{if(!f){for(const r of a)if(!r.is_dir&&r.name==="SKILL.md"){j(r.path),g(r.path),o(!1);return}for(const r of a)if(!r.is_dir&&r.name==="SKILLS.md"){j(r.path),g(r.path),o(!1);return}}}}),c=(ae==null?void 0:ae.data)??ae,D=(ie==null?void 0:ie.data)??ie??[],ee=h.useMemo(()=>Je(D),[D]),Q=k&&b?b:f?Ae(f):"";h.useEffect(()=>{f&&l?(F.system.getSkillFile({id:l,path:f}).then(a=>x((a==null?void 0:a.data)??a??"")).catch(()=>d.error(n("settings.skills.editor.failedToLoadFile",{defaultValue:"Failed to load file"}))),z(!1)):(x(""),z(!1))},[l,f,n]);const ne=()=>{!l||!f||F.system.putSkillFile({id:l,path:f},p).then(()=>{d.success(n("settings.skills.editor.saved",{defaultValue:"Saved"})),z(!1)}).catch(()=>d.error(n("settings.skills.editor.failedToSave",{defaultValue:"Failed to save"})))},me=(a,r)=>{const A=String(r.node.key),E=!r.node.isLeaf;j(A),o(E),r.node.isLeaf?g(A):g(null)},xe=a=>{a.event.preventDefault(),q({path:String(a.node.key),isDir:!a.node.isLeaf,x:a.event.clientX,y:a.event.clientY})},fe=h.useCallback(()=>q(null),[]),ge=h.useCallback(a=>{if(!l||!B)return;const{path:r,isDir:A}=B;switch(fe(),a){case"open":g(r),j(r),o(!1);break;case"rename":{const E=r.includes("/")?r.split("/").pop():r;v({path:r,isDir:A}),P(E),setTimeout(()=>le.setFieldsValue({name:E}),0);break}case"delete":W.confirm({title:n("settings.skills.editor.deleteConfirm",{defaultValue:"Delete?"}),content:A?n("settings.skills.editor.deleteConfirmContentDir",{path:r,defaultValue:`Delete ${r}? This will remove the folder and all its contents.`}):n("settings.skills.editor.deleteConfirmContent",{path:r,defaultValue:`Delete ${r}?`}),onOk:()=>F.system.deleteSkillPath({id:l,path:r}).then(()=>{d.success(n("settings.skills.editor.deleted",{defaultValue:"Deleted"})),f===r&&(g(null),x("")),b===r&&(j(null),o(!1)),m()}).catch(()=>d.error(n("settings.skills.editor.failedToDelete",{defaultValue:"Failed to delete"})))});break;case"newFile":j(r),o(A),T(!0);break;case"newDir":j(r),o(A),w(!0);break}},[l,B,fe,m,f,b,le,n]),y=()=>{if(!l||!L)return;const a=(le.getFieldValue("name")??u).trim();if(!a){d.error(n("settings.skills.editor.nameRequired",{defaultValue:"Name is required"}));return}if(!L.isDir&&!/\.(md|txt)$/i.test(a)){d.error(n("settings.skills.editor.fileNameExtension",{defaultValue:"File name must end with .md or .txt"}));return}const r=Ae(L.path),A=r?`${r}/${a}`:a;if(A===L.path){v(null);return}F.system.moveSkillPath({id:l},{from_path:L.path,to_path:A}).then(()=>{d.success(n("settings.skills.editor.renamed",{defaultValue:"Renamed"})),f===L.path&&g(A),b===L.path&&j(A),v(null),m()}).catch(()=>d.error(n("settings.skills.editor.failedToRename",{defaultValue:"Failed to rename"})))},K=a=>{if(!l)return;const r=String(a.dragNode.key),A=String(a.dragNode.title);let E;if(a.dropToGap){const Z=Ae(String(a.node.key));E=Z?`${Z}/${A}`:A}else E=`${a.node.key}/${A}`;E!==r&&F.system.moveSkillPath({id:l},{from_path:r,to_path:E}).then(()=>{d.success(n("settings.skills.editor.moved",{defaultValue:"Moved"})),f===r&&g(E),b===r&&j(E),m()}).catch(()=>d.error(n("settings.skills.editor.failedToMove",{defaultValue:"Failed to move"})))},re=()=>{const a=G.trim();if(!a||!l)return;const r=Q?`${Q}/${a}`:a;if(!/\.(md|txt)$/i.test(a)){d.error(n("settings.skills.editor.onlyMdTxtAllowed",{defaultValue:"Only .md and .txt files are allowed"}));return}F.system.putSkillFile({id:l,path:r},"").then(()=>{d.success(n("settings.skills.editor.fileCreated",{defaultValue:"File created"})),T(!1),N(""),m(),g(r),x("")}).catch(()=>d.error(n("settings.skills.editor.failedToCreateFile",{defaultValue:"Failed to create file"})))},ye=()=>{var A;const a=(A=J.getFieldValue("name"))==null?void 0:A.trim();if(!a||!l)return;const r=Q?`${Q}/${a}`:a;F.system.createSkillDir({id:l},{path:r}).then(()=>{d.success(n("settings.skills.editor.folderCreated",{defaultValue:"Folder created"})),w(!1),J.resetFields(),m()}).catch(()=>d.error(n("settings.skills.editor.failedToCreateFolder",{defaultValue:"Failed to create folder"})))},Ce=()=>{const a=b||f;!l||!a||W.confirm({title:n("settings.skills.editor.deleteConfirm",{defaultValue:"Delete?"}),content:n("settings.skills.editor.deleteConfirmContent",{path:a,defaultValue:`Delete ${a}?`}),onOk:()=>F.system.deleteSkillPath({id:l,path:a}).then(()=>{d.success(n("settings.skills.editor.deleted",{defaultValue:"Deleted"})),f===a&&(g(null),x("")),b===a&&(j(null),o(!1)),m()}).catch(()=>d.error(n("settings.skills.editor.failedToDelete",{defaultValue:"Failed to delete"})))})};return l?e.jsxs(Y,{title:(c==null?void 0:c.name)??n("settings.skills.editor.skill",{defaultValue:"Skill"}),extra:e.jsx(C,{type:"link",onClick:()=>s("/system/settings#skills"),children:n("settings.skills.editor.backToSkills",{defaultValue:"Back to Skills"})}),style:{height:"100%",display:"flex",flexDirection:"column",minHeight:"calc(100vh - 160px)"},styles:{body:{flex:1,minHeight:0,display:"flex",flexDirection:"column"}},children:[e.jsxs("div",{style:{display:"flex",gap:16,flex:1,minHeight:0},children:[e.jsxs("div",{style:{width:260,border:"1px solid #d9d9d9",borderRadius:8,padding:8,display:"flex",flexDirection:"column",minHeight:0},children:[e.jsxs(H,{style:{marginBottom:8,flexShrink:0},children:[e.jsx(C,{size:"small",icon:e.jsx(ve,{}),onClick:()=>T(!0),children:n("settings.skills.editor.file",{defaultValue:"File"})}),e.jsx(C,{size:"small",icon:e.jsx(Ke,{}),onClick:()=>w(!0),children:n("settings.skills.editor.folder",{defaultValue:"Folder"})})]}),oe?e.jsx("div",{children:n("settings.skills.editor.loading",{defaultValue:"Loading..."})}):e.jsx("div",{style:{flex:1,minHeight:0,overflow:"auto"},children:e.jsx(mt,{showIcon:!0,blockNode:!0,draggable:!0,expandedKeys:I,onExpand:a=>S(a),selectedKeys:b?[b]:[],onSelect:me,onRightClick:xe,onDrop:K,className:t.fileTree,treeData:ee})})]}),e.jsxs("div",{style:{flex:1,minWidth:0,display:"flex",flexDirection:"column",minHeight:0},children:[f&&e.jsxs(e.Fragment,{children:[e.jsxs(H,{style:{marginBottom:8,flexShrink:0},children:[e.jsx("span",{children:f}),e.jsx(C,{type:"primary",icon:e.jsx(Fe,{}),disabled:!U,onClick:ne,children:n("settings.skills.editor.save",{defaultValue:"Save"})}),e.jsx(C,{danger:!0,icon:e.jsx(he,{}),onClick:Ce,children:n("settings.skills.editor.delete",{defaultValue:"Delete"})})]}),Yt(f)?e.jsxs("div",{style:{flex:1,minHeight:0,minWidth:0,display:"flex",gap:16},children:[e.jsx("div",{style:{flex:1,minHeight:0,minWidth:0,display:"flex",flexDirection:"column"},children:e.jsx(De,{value:p,onChange:a=>{x(a.target.value),z(!0)},style:{flex:1,minHeight:0,fontFamily:"monospace",resize:"none"},spellCheck:!1})}),e.jsx("div",{style:{flex:1,minHeight:0,minWidth:0,overflow:"auto",border:"1px solid #d9d9d9",borderRadius:8,padding:12},children:e.jsx(Ze,{content:yt(p)})})]}):e.jsx(De,{value:p,onChange:a=>{x(a.target.value),z(!0)},style:{flex:1,minHeight:0,fontFamily:"monospace",resize:"none"},spellCheck:!1})]}),!f&&e.jsx("div",{style:{color:"#999"},children:n("settings.skills.editor.selectFileToEdit",{defaultValue:"Select a file to edit"})})]})]}),B&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{position:"fixed",inset:0,zIndex:999},onClick:fe,onContextMenu:a=>a.preventDefault(),"aria-hidden":!0}),e.jsx("div",{style:{position:"fixed",left:B.x,top:B.y,zIndex:1e3},children:e.jsx(ft,{selectable:!1,items:[...B.isDir?[]:[{key:"open",icon:e.jsx(We,{}),label:n("settings.skills.editor.open",{defaultValue:"Open"})}],{key:"rename",icon:e.jsx(ke,{}),label:n("settings.skills.editor.rename",{defaultValue:"Rename"})},{key:"delete",icon:e.jsx(he,{}),label:n("settings.skills.editor.delete",{defaultValue:"Delete"}),danger:!0},{key:"newFile",icon:e.jsx(pt,{}),label:n("settings.skills.editor.newFile",{defaultValue:"New file"})},{key:"newDir",icon:e.jsx(gt,{}),label:n("settings.skills.editor.newFolder",{defaultValue:"New folder"})}],onClick:({key:a})=>ge(a)})})]}),e.jsx(W,{title:n("settings.skills.editor.newFileTitle",{defaultValue:"New file"}),open:M,onOk:re,onCancel:()=>{T(!1),N("")},okText:n("settings.skills.editor.create",{defaultValue:"Create"}),children:e.jsx(V,{placeholder:n("settings.skills.editor.placeholderNewFile",{defaultValue:"filename.md or filename.txt"}),value:G,onChange:a=>N(a.target.value)})}),e.jsx(W,{title:n("settings.skills.editor.newFolderTitle",{defaultValue:"New folder"}),open:R,onOk:()=>J.validateFields().then(ye),onCancel:()=>w(!1),okText:n("settings.skills.editor.create",{defaultValue:"Create"}),children:e.jsx(i,{form:J,layout:"vertical",children:e.jsx(i.Item,{name:"name",label:n("settings.skills.editor.folderName",{defaultValue:"Folder name"}),rules:[{required:!0}],children:e.jsx(V,{placeholder:n("settings.skills.editor.placeholderFolder",{defaultValue:"folder-name"})})})})}),e.jsx(W,{title:n("settings.skills.editor.renameTitle",{defaultValue:"Rename"}),open:!!L,onOk:y,onCancel:()=>v(null),okText:n("settings.skills.editor.rename",{defaultValue:"Rename"}),destroyOnClose:!0,children:e.jsx(i,{form:le,layout:"vertical",onValuesChange:(a,r)=>P(r.name??""),children:e.jsx(i.Item,{name:"name",label:L!=null&&L.isDir?n("settings.skills.editor.folderName",{defaultValue:"Folder name"}):n("settings.skills.editor.fileName",{defaultValue:"File name"}),rules:[{required:!0}],children:e.jsx(V,{placeholder:L!=null&&L.isDir?n("settings.skills.editor.placeholderFolder",{defaultValue:"folder-name"}):n("settings.skills.editor.placeholderFileName",{defaultValue:"name.md"}),onPressEnter:()=>y()})})})})]}):null},ms=Object.freeze(Object.defineProperty({__proto__:null,default:es},Symbol.toStringTag,{value:"Module"})),ts=()=>{var x;const{id:t}=Me(),l=_e(),{t:s}=$("system"),{data:n,loading:f}=_(()=>t?F.system.getSkill({id:t}):Promise.reject(new Error("No id")),{refreshDeps:[t],ready:!!t}),{data:g,loading:b}=_(()=>t?F.system.previewSkill({id:t}):Promise.reject(new Error("No id")),{refreshDeps:[t],ready:!!t,onError:()=>d.error(s("settings.skills.previewFailed",{defaultValue:"Failed to load preview"}))}),j=(n==null?void 0:n.data)??n,k=((x=g==null?void 0:g.data)==null?void 0:x.content)??(g==null?void 0:g.content)??"",o=Vt(k);if(!t)return null;const p=f||b;return e.jsx(Y,{title:(j==null?void 0:j.name)??s("settings.skills.editor.previewTitle",{defaultValue:"Skill Preview"}),extra:e.jsx(C,{type:"link",onClick:()=>l("/system/settings#skills"),children:s("settings.skills.editor.backToSkills",{defaultValue:"Back to Skills"})}),children:e.jsx(pe,{spinning:p,children:e.jsx("div",{style:{minHeight:200},children:!p&&e.jsx(Ze,{content:o})})})})},fs=Object.freeze(Object.defineProperty({__proto__:null,default:ts},Symbol.toStringTag,{value:"Module"})),ss=()=>{const{t}=$("system"),[l]=ht(),s=l.get("provider"),n=l.get("code"),f=l.get("state"),[g,b]=h.useState(null),[j,k]=h.useState(null),[o,p]=h.useState(null);return _(async()=>{if(!n||!f||!s)throw new Error(t("settings.oauth.testConnection.missingRequiredParameters",{defaultValue:"Missing required parameters"}));const x=await F.system.testOauthCallback({code:n,state:f,provider:s});if(!x.user_info)throw new Error(t("settings.oauth.testConnection.responseUserInfoIsNull",{defaultValue:"response user_info is null"}));if(!x.user)throw new Error(t("settings.oauth.testConnection.responseUserIsNull",{defaultValue:"response user is null"}));b(x.user),k(x.user_info)},{onSuccess:()=>{p({status:"success",message:t("settings.oauth.testConnection.success",{defaultValue:"Successfully tested connection"})})},onError:x=>{p({status:"error",message:t("settings.oauth.testConnection.callbackFailed",{defaultValue:"Failed to test connection"}),error:x.message})}}),o?e.jsx("div",{children:e.jsx(xt,{status:o.status,title:o.message,subTitle:o.error,extra:e.jsxs(H,{style:{display:!j||!g?"none":"inline-block",textAlign:"left"},direction:"vertical",children:[e.jsx(Y,{title:t("settings.oauth.testConnection.oauthUserInfo",{defaultValue:"OAuth User Info"}),children:e.jsx(Ue,{src:j||{}})}),e.jsx(Y,{title:t("settings.oauth.testConnection.loginUserInfo",{defaultValue:"Login User Info"}),style:{marginTop:16},children:e.jsx(Ue,{src:g||{}})})]})})}):e.jsx(bt,{})},ps=Object.freeze(Object.defineProperty({__proto__:null,default:ss},Symbol.toStringTag,{value:"Module"}));export{cs as O,ms as S,fs as a,ps as b,us as i};
