import{u as N,aH as a,r as x,a as v,j as e,S as me,b2 as J,aZ as P,ai as p,aL as Re,a0 as Te,i as B,B as E,dp as ke,d as oe,s as c,b3 as le,M as W,aD as Ne,dm as ee,aK as $e,J as De,dq as Be,aT as X,aW as xe,f as je,dr as Ce,d7 as Le,T as He,ds as Ke,dh as Oe,dt as Ge,da as Se,e as _e,ao as Y,aX as Fe,aY as ce,b as ve,du as Ze,dv as Me,bf as Je,bJ as We,b5 as Ae,aN as Qe,bj as Xe,db as Ye,dw as et,bH as tt,au as st,dx as Pe}from"./vendor.B4UNC6a-.js";import{a as A}from"./index.Cy1JO93W.js";import{g as Ue}from"./base.BitSj1X2.js";import{f as ne,g as at,h as Ie,i as qe,L as lt}from"./components.BbXPg4FP.js";import{l as nt,c as ot,u as it,d as rt,a as dt,g as ut,b as ct,e as mt,r as pt}from"./system.DL6bykak.js";import{c as gt,b as ft}from"./contexts.B1iwwl_4.js";import{l as ht,b as xt}from"./authorization.CidYPuil.js";const ue=/^(https?:\/\/)(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])(:[0-9]+)?(\/[\w\-._~:/?#[\]@!$&'()*+,;=]*)*$/,bt={github:{email_field:"email",username_field:"login",full_name_field:"name",avatar_field:"avatar_url",role_field:"",icon_url:"https://github.githubassets.com/favicons/favicon.svg",display_name:"GitHub",endpoints:{auth_endpoint:"https://github.com/login/oauth/authorize",token_endpoint:"https://github.com/login/oauth/access_token",userinfo_endpoint:"https://api.github.com/user"},scope:"user:email"},google:{email_field:"email",username_field:"email",full_name_field:"name",avatar_field:"picture",role_field:"",icon_url:"https://www.google.com/favicon.ico",display_name:"Google",endpoints:{auth_endpoint:"https://accounts.google.com/o/oauth2/v2/auth",token_endpoint:"https://oauth2.googleapis.com/token",userinfo_endpoint:"https://openidconnect.googleapis.com/v1/userinfo"},scope:"profile email"},dingtalk:{email_field:"email",username_field:"nick",full_name_field:"name",avatar_field:"avatar",role_field:"",icon_url:"https://img.alicdn.com/tfs/TB1pTD.XQT2gK0jSZFkXXcIQFXa-160-160.png",display_name:"DingTalk",endpoints:{auth_endpoint:"https://oapi.dingtalk.com/connect/qrconnect",token_endpoint:"https://oapi.dingtalk.com/gettoken",userinfo_endpoint:"https://oapi.dingtalk.com/topapi/user/get"},scope:"snsapi_login"},wechat:{email_field:"",username_field:"openid",full_name_field:"nickname",avatar_field:"headimgurl",role_field:"",icon_url:"https://res.wx.qq.com/a/wx_fed/assets/res/NTI4MWU5.ico",display_name:"WeChat",endpoints:{auth_endpoint:"https://open.weixin.qq.com/connect/qrconnect",token_endpoint:"https://api.weixin.qq.com/sns/oauth2/access_token",userinfo_endpoint:"https://api.weixin.qq.com/sns/userinfo"},scope:"snsapi_login"},custom:{email_field:"",username_field:"",full_name_field:"",avatar_field:"",role_field:"",icon_url:"",display_name:"",endpoints:{auth_endpoint:"",token_endpoint:"",userinfo_endpoint:""},scope:""}},Vt=({initialData:t,onRefresh:l})=>{const{t:s}=N("system"),{t:S}=N("common"),[g]=a.useForm(),[h,_]=x.useState((t==null?void 0:t.provider)||"custom"),[j,b]=x.useState((t==null?void 0:t.provider)==="custom"||(t==null?void 0:t.provider)==="autoDiscover"),[i,d]=x.useState((t==null?void 0:t.enabled)||!1),[f,U]=x.useState((t==null?void 0:t.auto_create_user)||!1),{loading:z,data:C,refresh:m}=v(A.system.getOauthSettings,{manual:!!t,onSuccess:y=>{g.setFieldsValue(y),_(y.provider),b(y.provider==="custom"||y.provider==="autoDiscover"),d(y.enabled),U(y.auto_create_user)},onError:y=>{c.error(s("settings.fetchFailed",{defaultValue:"Failed to fetch settings"})),console.error("Failed to get OAuth settings",y)}});x.useEffect(()=>{t&&(g.setFieldsValue(t),_(t.provider),b(t.provider==="custom"||t.provider==="autoDiscover"),d(t.enabled),U(t.auto_create_user))},[t,g]);const F=y=>{_(y),b(y==="custom"||y==="autoDiscover");const o=bt[y];o&&g.setFieldsValue({auth_endpoint:o.endpoints.auth_endpoint,token_endpoint:o.endpoints.token_endpoint,userinfo_endpoint:o.endpoints.userinfo_endpoint,scope:o.scope,email_field:o.email_field,username_field:o.username_field,full_name_field:o.full_name_field,avatar_field:o.avatar_field,role_field:o.role_field,icon_url:o.icon_url,display_name:o.display_name})},T=y=>{d(y)},w=y=>{U(y)},{loading:I,run:K}=v(A.system.updateOauthSettings,{manual:!0,onSuccess:()=>{c.success(s("settings.updateSuccess",{defaultValue:"Settings updated successfully"})),l?l():m()},onError:y=>{c.error(s("settings.updateFailed",{defaultValue:"Failed to update settings"})),console.error("Failed to update OAuth settings",y)}}),q=y=>{K(y)},Q=()=>{l?l():m()},{loading:G,run:L}=v(async({redirect_uri:y,...o})=>{let M;return y?M=new URL(y):M=new URL(window.location.origin),M.pathname=Ue("/system/settings/oauth/test-callback"),M.searchParams.set("provider",h),A.system.testOauthConnection({redirect_uri:M.toString(),...o})},{manual:!0,onSuccess:({url:y})=>{window.open(y,"_blank")},onError:y=>{c.error(s("settings.oauth.testConnection.failed",{defaultValue:"Failed to test connection: {{error}}",error:y.message})),console.error("Failed to test OAuth connection",y)}}),H=()=>h==="custom";return e.jsx(me,{spinning:z,children:e.jsxs(a,{form:g,layout:"vertical",onFinish:q,initialValues:t||C,children:[e.jsx(a.Item,{name:"enabled",label:s("settings.oauth.enabled.label",{defaultValue:"Enable OAuth"}),valuePropName:"checked",tooltip:s("settings.oauth.enabled.tooltip",{defaultValue:"Enable or disable OAuth login for the system."}),children:e.jsx(J,{onChange:T})}),e.jsx(a.Item,{name:"provider",label:s("settings.oauth.provider.label",{defaultValue:"OAuth Provider"}),tooltip:s("settings.oauth.provider.tooltip",{defaultValue:"Select an OAuth provider or configure a custom one."}),rules:[{required:i,message:s("settings.oauth.provider.required",{defaultValue:"Please select an OAuth provider."})}],children:e.jsxs(P,{onChange:F,disabled:!i,children:[e.jsx(P.Option,{value:"github",children:s("settings.oauth.provider.options.github",{defaultValue:"GitHub"})}),e.jsx(P.Option,{value:"google",children:s("settings.oauth.provider.options.google",{defaultValue:"Google"})}),e.jsx(P.Option,{value:"dingtalk",children:s("settings.oauth.provider.options.dingtalk",{defaultValue:"DingTalk"})}),e.jsx(P.Option,{value:"wechat",children:s("settings.oauth.provider.options.wechat",{defaultValue:"WeChat"})}),e.jsx(P.Option,{value:"autoDiscover",children:s("settings.oauth.provider.options.autoDiscover",{defaultValue:"Auto Discover"})}),e.jsx(P.Option,{value:"custom",children:s("settings.oauth.provider.options.custom",{defaultValue:"Custom"})})]})}),e.jsx(a.Item,{name:"display_name",label:s("settings.oauth.displayName.label",{defaultValue:"Display Name"}),tooltip:s("settings.oauth.displayName.tooltip",{defaultValue:"The name displayed on the login button for this provider."}),children:e.jsx(p,{disabled:!i,placeholder:h!=="custom"?s(`settings.oauth.provider.options.${h}`,{defaultValue:h}):""})}),e.jsx(a.Item,{name:"icon_url",label:s("settings.oauth.iconUrl.label",{defaultValue:"Icon URL"}),tooltip:s("settings.oauth.iconUrl.tooltip",{defaultValue:"URL of the icon for this provider. Displayed on the login button."}),rules:[{pattern:ue,message:s("settings.oauth.iconUrl.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(p,{disabled:!i,placeholder:"https://example.com/icon.png"})}),e.jsx(a.Item,{name:"client_id",label:s("settings.oauth.clientId.label",{defaultValue:"Client ID"}),tooltip:s("settings.oauth.clientId.tooltip",{defaultValue:"The Client ID provided by the OAuth provider."}),rules:[{required:i,message:s("settings.oauth.clientId.required",{defaultValue:"Client ID is required."})}],children:e.jsx(p,{disabled:!i})}),e.jsx(a.Item,{name:"client_secret",label:s("settings.oauth.clientSecret.label",{defaultValue:"Client Secret"}),tooltip:s("settings.oauth.clientSecret.tooltip",{defaultValue:"The Client Secret provided by the OAuth provider. This will be stored encrypted."}),rules:[{required:i,message:s("settings.oauth.clientSecret.required",{defaultValue:"Client Secret is required."})}],children:e.jsx(p.Password,{disabled:!i,autoComplete:"new-password",visibilityToggle:!1,placeholder:s("settings.oauth.clientSecret.unchanged",{defaultValue:"Leave blank to keep unchanged"})})}),H()&&e.jsx(a.Item,{name:"auth_endpoint",label:s("settings.oauth.authEndpoint.label",{defaultValue:"Authorization Endpoint"}),tooltip:s("settings.oauth.authEndpoint.tooltip",{defaultValue:"The authorization endpoint URL of the OAuth provider."}),rules:[{required:i&&h==="custom",message:s("settings.oauth.authEndpoint.required",{defaultValue:"Authorization Endpoint is required."})},{pattern:ue,message:s("settings.oauth.authEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(p,{disabled:!i})}),e.jsx(a.Item,{name:"wellknown_endpoint",hidden:h!=="autoDiscover",label:s("settings.oauth.wellknownEndpoint.label",{defaultValue:"Wellknown Endpoint"}),tooltip:s("settings.oauth.wellknownEndpoint.tooltip",{defaultValue:"The wellknown endpoint URL of the OAuth provider."}),rules:[{pattern:ue,message:s("settings.oauth.wellknownEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})},{required:i&&h==="autoDiscover",message:s("settings.oauth.wellknownEndpoint.required",{defaultValue:"Wellknown Endpoint is required."})}],children:e.jsx(p,{disabled:!i})}),H()&&e.jsx(a.Item,{name:"token_endpoint",label:s("settings.oauth.tokenEndpoint.label",{defaultValue:"Token Endpoint"}),tooltip:s("settings.oauth.tokenEndpoint.tooltip",{defaultValue:"The token endpoint URL of the OAuth provider."}),rules:[{required:i&&h==="custom",message:s("settings.oauth.tokenEndpoint.required",{defaultValue:"Token Endpoint is required."})},{pattern:ue,message:s("settings.oauth.tokenEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(p,{disabled:!i})}),H()&&e.jsx(a.Item,{name:"userinfo_endpoint",label:s("settings.oauth.userInfoEndpoint.label",{defaultValue:"User Info Endpoint"}),tooltip:s("settings.oauth.userInfoEndpoint.tooltip",{defaultValue:"The user information endpoint URL of the OAuth provider."}),rules:[{required:i&&h==="custom",message:s("settings.oauth.userInfoEndpoint.required",{defaultValue:"User Info Endpoint is required."})},{pattern:ue,message:s("settings.oauth.userInfoEndpoint.invalidUrl",{defaultValue:"Please enter a valid URL."})}],children:e.jsx(p,{disabled:!i})}),e.jsx(a.Item,{name:"scope",label:s("settings.oauth.scope.label",{defaultValue:"Authorization Scope"}),tooltip:s("settings.oauth.scope.tooltip",{defaultValue:"The scopes to request from the OAuth provider, separated by spaces."}),rules:[{required:i,message:s("settings.oauth.scope.required",{defaultValue:"Scope is required."})}],children:e.jsx(p,{disabled:!i})}),e.jsx(a.Item,{name:"redirect_uri",label:s("settings.oauth.redirectUri.label",{defaultValue:"Redirect URI"}),tooltip:s("settings.oauth.redirectUri.tooltip",{defaultValue:"The Redirect URI registered with the OAuth provider. This should match the one configured in your application."}),rules:[y=>y.getFieldValue("redirect_uri")!==""?{pattern:ue,message:s("settings.oauth.redirectUri.invalidUrl",{defaultValue:"Please enter a valid URL."})}:{required:!1}],children:e.jsx(p,{disabled:!i,placeholder:`http://${window.location.host}${Ue(`/login?provider=settings.${h}`)}`})}),e.jsx(a.Item,{name:"auto_create_user",label:s("settings.oauth.autoCreateUser.label",{defaultValue:"Auto Create User"}),valuePropName:"checked",tooltip:s("settings.oauth.autoCreateUser.tooltip",{defaultValue:"Automatically create a new user if one does not exist with the OAuth email."}),children:e.jsx(J,{onChange:w,disabled:!i})}),e.jsx(a.Item,{name:"default_role",label:s("settings.oauth.defaultRole.label",{defaultValue:"Default Role"}),tooltip:s("settings.oauth.defaultRole.tooltip",{defaultValue:"The default role to assign to new users created via OAuth. Enter role ID."}),rules:[{required:i&&f,message:s("settings.oauth.defaultRole.required",{defaultValue:"Default Role is required when auto create user is enabled."})}],children:e.jsx(p,{disabled:!i||!f})}),e.jsx(a.Item,{name:"role_mapping_mode",label:s("settings.oauth.roleMappingMode.label",{defaultValue:"Role Mapping Mode"}),tooltip:s("settings.oauth.roleMappingMode.tooltip",{defaultValue:"Controls how user roles are synchronized from OAuth2 provider."}),initialValue:"auto",children:e.jsxs(P,{disabled:!i,children:[e.jsx(P.Option,{value:"disabled",children:s("settings.oauth.roleMappingMode.options.disabled.label",{defaultValue:"Disabled"})}),e.jsx(P.Option,{value:"auto",children:s("settings.oauth.roleMappingMode.options.auto.label",{defaultValue:"Auto"})}),e.jsx(P.Option,{value:"enforce",children:s("settings.oauth.roleMappingMode.options.enforce.label",{defaultValue:"Enforce"})})]})}),e.jsx(Re,{style:{marginBottom:16},type:"info",showIcon:!0,message:s("settings.oauth.roleMappingMode.infoTitle",{defaultValue:"Role Mapping Mode Information"}),description:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[s("settings.oauth.roleMappingMode.options.disabled.label",{defaultValue:"Disabled"}),":"]})," ",s("settings.oauth.roleMappingMode.options.disabled.description",{defaultValue:"Ignores role information from OAuth2 provider. New users get the default role."})]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[s("settings.oauth.roleMappingMode.options.auto.label",{defaultValue:"Auto"}),":"]})," ",s("settings.oauth.roleMappingMode.options.auto.description",{defaultValue:"Uses OAuth2 roles for new users or users without roles, but preserves existing role assignments."})]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[s("settings.oauth.roleMappingMode.options.enforce.label",{defaultValue:"Enforce"}),":"]})," ",s("settings.oauth.roleMappingMode.options.enforce.description",{defaultValue:"Always overwrites user roles with OAuth2 roles when available."})]})]})}),e.jsx(a.Item,{name:"mfa_enabled",label:s("settings.oauth.mfaEnabled.label",{defaultValue:"MFA Enabled"}),valuePropName:"checked",tooltip:s("settings.oauth.mfaEnabled.tooltip",{defaultValue:"Enable MFA for OAuth login(Only valid when MFA is enabled by the user)."}),children:e.jsx(J,{disabled:!i})}),e.jsx(Te,{children:s("settings.oauth.fieldMapping.title",{defaultValue:"Field Mapping"})}),e.jsx(Re,{style:{marginBottom:16},type:"info",showIcon:!0,message:s("settings.oauth.fieldMapping.autoDetectHint",{defaultValue:"For preset providers, fields are typically auto-detected. Customize if needed."}),description:j?"":s("settings.oauth.fieldMapping.presetDescription",{defaultValue:'These fields are pre-filled based on the selected provider. You can switch to "Custom" provider to edit them directly.'})}),e.jsx(a.Item,{name:"email_field",label:s("settings.oauth.fieldMapping.emailField.label",{defaultValue:"Email Field"}),tooltip:s("settings.oauth.fieldMapping.emailField.tooltip",{defaultValue:"The field name in the user info response that contains the user email. (e.g., email)"}),children:e.jsx(p,{placeholder:"email",disabled:!i||!j})}),e.jsx(a.Item,{name:"username_field",label:s("settings.oauth.fieldMapping.usernameField.label",{defaultValue:"Username Field"}),tooltip:s("settings.oauth.fieldMapping.usernameField.tooltip",{defaultValue:"The field name in the user info response that contains the username. (e.g., login, sub)"}),children:e.jsx(p,{placeholder:"login",autoComplete:"off",disabled:!i||!j})}),e.jsx(a.Item,{name:"full_name_field",label:s("settings.oauth.fieldMapping.fullNameField.label",{defaultValue:"Full Name Field"}),tooltip:s("settings.oauth.fieldMapping.fullNameField.tooltip",{defaultValue:"The field name in the user info response that contains the user's full name. (e.g., name)"}),children:e.jsx(p,{placeholder:"name",disabled:!i||!j})}),e.jsx(a.Item,{name:"avatar_field",label:s("settings.oauth.fieldMapping.avatarField.label",{defaultValue:"Avatar URL Field"}),tooltip:s("settings.oauth.fieldMapping.avatarField.tooltip",{defaultValue:"The field name in the user info response that contains the URL to the user's avatar. (e.g., picture, avatar_url)"}),children:e.jsx(p,{placeholder:"avatar_url",disabled:!i||!j})}),e.jsx(a.Item,{name:"role_field",label:s("settings.oauth.fieldMapping.roleField.label",{defaultValue:"Role Field"}),tooltip:s("settings.oauth.fieldMapping.roleField.tooltip",{defaultValue:"The field name in the user info response that contains the user's role. (Optional)"}),children:e.jsx(p,{placeholder:"role",disabled:!i||!j})}),e.jsx(a.Item,{children:e.jsxs(B,{children:[e.jsx(E,{type:"primary",htmlType:"submit",loading:I,icon:e.jsx(ke,{}),children:S("save",{defaultValue:"Save"})}),e.jsx(E,{loading:G,onClick:async()=>{const y=g.getFieldsValue();L(y)},children:s("settings.oauth.testConnection.button",{defaultValue:"Test Connection"})}),e.jsx(E,{onClick:Q,icon:e.jsx(oe,{}),children:S("refresh",{defaultValue:"Refresh"})})]})})]})})},yt=()=>{const{t}=N("system"),{t:l}=N("common"),[s]=a.useForm(),{loading:S,data:g,refresh:h}=v(A.system.getSecuritySettings,{onSuccess:i=>{s.setFieldsValue(i)},onError:i=>{c.error(t("settings.fetchFailed",{defaultValue:"Failed to fetch settings"})),console.error("Failed to get system settings",i)}}),{loading:_,run:j}=v(A.system.updateSecuritySettings,{manual:!0,onSuccess:()=>{c.success(t("settings.updateSuccess",{defaultValue:"Settings updated successfully"})),h()},onError:i=>{c.error(t("settings.updateFailed",{defaultValue:"Failed to update settings"})),console.error("Failed to update system settings",i)}}),b=i=>{j(i)};return e.jsx(me,{spinning:S,children:e.jsxs(a,{form:s,layout:"vertical",onFinish:b,initialValues:g,children:[e.jsx(a.Item,{name:"mfa_enforced",label:t("settings.security.mfa.label",{defaultValue:"Enforce Multi-Factor Authentication (MFA)"}),valuePropName:"checked",tooltip:t("settings.security.mfa.tooltip",{defaultValue:"If enabled, all users will be required to set up MFA."}),children:e.jsx(J,{})}),e.jsx(a.Item,{name:"password_complexity",label:t("settings.security.passwordComplexity.label",{defaultValue:"Password Complexity"}),tooltip:t("settings.security.passwordComplexity.tooltip",{defaultValue:"Define the complexity requirements for user passwords."}),children:e.jsxs(P,{children:[e.jsx(P.Option,{value:"low",children:t("settings.security.passwordComplexity.options.low",{defaultValue:"Low"})}),e.jsx(P.Option,{value:"medium",children:t("settings.security.passwordComplexity.options.medium",{defaultValue:"Medium"})}),e.jsx(P.Option,{value:"high",children:t("settings.security.passwordComplexity.options.high",{defaultValue:"High"})}),e.jsx(P.Option,{value:"very_high",children:t("settings.security.passwordComplexity.options.veryHigh",{defaultValue:"Very High"})})]})}),e.jsx(a.Item,{name:"password_min_length",label:t("settings.security.passwordMinLength.label",{defaultValue:"Minimum Password Length"}),tooltip:t("settings.security.passwordMinLength.tooltip",{defaultValue:"The minimum number of characters required for a password."}),rules:[{type:"number",min:6,max:32}],children:e.jsx(le,{min:6,max:32,style:{width:"100%"}})}),e.jsx(a.Item,{name:"password_expiry_days",label:t("settings.security.passwordExpiry.label",{defaultValue:"Password Expiry (Days)"}),tooltip:t("settings.security.passwordExpiry.tooltip",{defaultValue:"Number of days after which passwords expire. Set to 0 to disable expiry."}),children:e.jsx(le,{min:0,style:{width:"100%"},addonAfter:t("settings.days",{defaultValue:"Days"})})}),e.jsx(a.Item,{name:"login_failure_lock",label:t("settings.security.loginFailureLock.label",{defaultValue:"Lock Account on Login Failure"}),valuePropName:"checked",tooltip:t("settings.security.loginFailureLock.tooltip",{defaultValue:"Lock user accounts after a specified number of failed login attempts."}),children:e.jsx(J,{})}),e.jsx(a.Item,{noStyle:!0,shouldUpdate:(i,d)=>i.login_failure_lock!==d.login_failure_lock,children:({getFieldValue:i})=>i("login_failure_lock")?e.jsx(a.Item,{name:"login_failure_attempts",label:t("settings.security.loginFailureAttempts.label",{defaultValue:"Login Failure Attempts"}),tooltip:t("settings.security.loginFailureAttempts.tooltip",{defaultValue:"Number of failed login attempts before locking the account."}),children:e.jsx(le,{min:1,max:10,style:{width:"100%"}})}):null}),e.jsx(a.Item,{noStyle:!0,shouldUpdate:(i,d)=>i.login_failure_lock!==d.login_failure_lock,children:({getFieldValue:i})=>i("login_failure_lock")?e.jsx(a.Item,{name:"login_failure_lockout_minutes",label:t("settings.security.loginFailureLockoutMinutes.label",{defaultValue:"Login Failure Lockout (Minutes)"}),tooltip:t("settings.security.loginFailureLockoutMinutes.tooltip",{defaultValue:"Number of minutes to lock the account after a specified number of failed login attempts."}),children:e.jsx(le,{min:1,max:10,style:{width:"100%"},addonAfter:t("settings.minutes",{defaultValue:"Minutes"})})}):null}),e.jsx(a.Item,{name:"history_password_check",label:t("settings.security.historyPasswordCheck.label",{defaultValue:"Enforce Password History Policy"}),valuePropName:"checked",tooltip:t("settings.security.historyPasswordCheck.tooltip",{defaultValue:"Prevent users from reusing recent passwords."}),children:e.jsx(J,{})}),e.jsx(a.Item,{noStyle:!0,shouldUpdate:(i,d)=>i.history_password_check!==d.history_password_check,children:({getFieldValue:i})=>i("history_password_check")?e.jsx(a.Item,{name:"history_password_count",label:t("settings.security.historyPasswordCount.label",{defaultValue:"Password History Count"}),tooltip:t("settings.security.historyPasswordCount.tooltip",{defaultValue:"Number of previous passwords to remember and prevent reuse."}),children:e.jsx(le,{min:1,max:10,style:{width:"100%"}})}):null}),e.jsx(a.Item,{name:"inactive_account_lock_days",label:t("settings.security.inactiveAccountLock.label",{defaultValue:"Auto-lock Inactive Accounts (Days)"}),tooltip:t("settings.security.inactiveAccountLock.tooltip",{defaultValue:"Number of days of inactivity after which user accounts are automatically locked. Set to 0 to disable."}),children:e.jsx(le,{min:0,style:{width:"100%"},addonAfter:t("settings.days",{defaultValue:"Days"})})}),e.jsx(a.Item,{name:"session_timeout_minutes",label:t("settings.security.sessionTimeout.label",{defaultValue:"Session Timeout (Minutes)"}),tooltip:t("settings.security.sessionTimeout.tooltip",{defaultValue:"Automatically log out users after a period of inactivity."}),children:e.jsx(le,{min:5,style:{width:"100%"},addonAfter:t("settings.minutes",{defaultValue:"Minutes"})})}),e.jsx(a.Item,{name:"session_idle_timeout_minutes",label:t("settings.security.sessionIdleTimeout.label",{defaultValue:"Session Idle Timeout (Minutes)"}),tooltip:t("settings.security.sessionIdleTimeout.tooltip",{defaultValue:"Automatically log out users after a period of inactivity."}),children:e.jsx(le,{min:5,style:{width:"100%"},addonAfter:t("settings.minutes",{defaultValue:"Minutes"})})}),e.jsx(a.Item,{children:e.jsxs(B,{children:[e.jsx(E,{type:"primary",htmlType:"submit",loading:_,icon:e.jsx(ke,{}),children:l("save",{defaultValue:"Save"})}),e.jsx(E,{onClick:()=>h(),icon:e.jsx(oe,{}),children:l("refresh",{defaultValue:"Refresh"})})]})})]})})},jt=({fetchItems:t,importItems:l,columns:s,...S})=>{const{t:g}=N("system"),[h,_]=x.useState([]),[j,b]=x.useState([]),{run:i,loading:d}=v(t,{onError:z=>{c.error(g("settings.ldap.importError",{error:`${z.message}`}))},onSuccess:z=>{_(z)},manual:!0}),{run:f,loading:U}=v(async()=>{for(const z of j.filter(C=>{const m=h.find(F=>F.ldap_dn===C);return!(!m||m.status==="imported")})){const C=await l([z]);_(m=>[...m].map(T=>{for(const w of C)if(T.ldap_dn===w.ldap_dn)return{...w,status:"imported"};return T}))}},{manual:!0});return x.useEffect(()=>{S.visible&&(_([]),i(),b([]))},[S.visible]),e.jsx(W,{title:g("settings.ldap.importTitle"),...S,onOk:()=>{f()},width:900,confirmLoading:U,loading:d,children:e.jsx(xe,{rowKey:"ldap_dn",rowSelection:{onChange:z=>{b(z)},getCheckboxProps:z=>({disabled:z.status==="imported"})},columns:s.map(({render:z,...C})=>z?{...C,render:(m,F,T)=>{const w=j.includes(F.ldap_dn)&&U&&F.status!=="imported";return z(m,F,T,w)}}:C),dataSource:h,pagination:!1,scroll:{y:400,x:"max-content"}})})},St=()=>{var F,T,w;const{t}=N("system"),[l]=a.useForm(),[s,S]=x.useState(!1),[g,h]=x.useState(null),[_,j]=x.useState(!1),[b,i]=x.useState(!1),[d]=a.useForm(),[f,U]=x.useState(!1);v(A.system.getLdapSettings,{onSuccess:I=>{l.setFieldsValue(I),U(I.enabled)},onError:I=>{c.error(t("settings.ldap.loadError",{defaultValue:"Failed to load LDAP settings: {{error}}",error:`${I.message}`}))}}),x.useEffect(()=>{h(null)},[_]);const z=async I=>{S(!0);try{await A.system.updateLdapSettings(I),c.success(t("settings.ldap.saveSuccess",{defaultValue:"LDAP settings saved successfully."}))}catch{c.error(t("settings.ldap.saveError",{defaultValue:"Failed to save LDAP settings."}))}finally{S(!1)}},{run:C,loading:m}=v(async I=>{const K=await l.validateFields();return await A.system.testLdapConnection({...I,...K})},{onSuccess:I=>{h(I)},onError:I=>{c.error(t("settings.ldap.testError",{defaultValue:"LDAP connection test failed: {{error}}",error:`${I.message}`}))},manual:!0});return e.jsxs(e.Fragment,{children:[e.jsxs(a,{form:l,layout:"vertical",onFinish:z,initialValues:{user_attr:"uid",email_attr:"mail",display_name_attr:"displayName",default_role:"user"},children:[e.jsx(a.Item,{label:t("settings.ldap.enabled",{defaultValue:"Enable LDAP Authentication"}),name:"enabled",valuePropName:"checked",children:e.jsx(J,{onChange:I=>U(I)})}),e.jsx(a.Item,{label:t("settings.ldap.serverUrl",{defaultValue:"LDAP Server URL"}),name:"server_url",rules:[{required:f,message:t("settings.ldap.serverUrlRequired",{defaultValue:"LDAP Server URL is required."})}],children:e.jsx(p,{disabled:!f,placeholder:"ldap://ldap.example.com:389"})}),e.jsx(a.Item,{label:t("settings.ldap.bindDn",{defaultValue:"Bind DN"}),name:"bind_dn",rules:[{required:f,message:t("settings.ldap.bindDnRequired",{defaultValue:"Bind DN is required."})}],children:e.jsx(p,{disabled:!f,placeholder:"cn=admin,dc=example,dc=com"})}),e.jsx(a.Item,{label:t("settings.ldap.bindPassword",{defaultValue:"Bind Password"}),name:"bind_password",rules:[{required:f,message:t("settings.ldap.bindPasswordRequired",{defaultValue:"Bind Password is required."})}],children:e.jsx(p.Password,{hidden:!0,autoComplete:"new-password"})}),e.jsx(a.Item,{label:t("settings.ldap.baseDn",{defaultValue:"Base DN"}),name:"base_dn",rules:[{required:f,message:t("settings.ldap.baseDnRequired",{defaultValue:"Base DN is required."})}],children:e.jsx(p,{disabled:!f,placeholder:"dc=example,dc=com"})}),e.jsx(a.Item,{label:t("settings.ldap.userFilter",{defaultValue:"User Filter"}),name:"user_filter",children:e.jsx(p,{disabled:!f,hidden:!0,autoComplete:"off",placeholder:"(objectClass=person)"})}),e.jsx(a.Item,{label:t("settings.ldap.userAttr",{defaultValue:"User Attribute"}),name:"user_attr",rules:[{required:f,message:t("settings.ldap.userAttrRequired",{defaultValue:"User Attribute is required."})}],children:e.jsx(p,{disabled:!f})}),e.jsx(a.Item,{label:t("settings.ldap.emailAttr",{defaultValue:"Email Attribute"}),name:"email_attr",rules:[{required:f,message:t("settings.ldap.emailAttrRequired",{defaultValue:"Email Attribute is required."})}],children:e.jsx(p,{disabled:!f})}),e.jsx(a.Item,{label:t("settings.ldap.displayNameAttr",{defaultValue:"Display Name Attribute"}),name:"display_name_attr",rules:[{required:f,message:t("settings.ldap.displayNameAttrRequired",{defaultValue:"Display Name Attribute is required."})}],children:e.jsx(p,{disabled:!f})}),e.jsx(a.Item,{label:t("settings.ldap.defaultRole",{defaultValue:"Default Role"}),name:"default_role",rules:[{required:f,message:t("settings.ldap.defaultRoleRequired",{defaultValue:"Default Role is required."})}],children:e.jsx(p,{disabled:!f})}),e.jsx(a.Item,{name:"timeout",label:t("settings.ldap.timeout",{defaultValue:"Timeout"}),tooltip:t("settings.ldap.timeoutTooltip",{defaultValue:"Timeout for LDAP connection in seconds"}),children:e.jsx(p,{type:"number",defaultValue:15,disabled:!f})}),e.jsx(Te,{children:t("settings.ldap.tlsDivider",{defaultValue:"TLS Configuration"})}),e.jsx(a.Item,{label:t("settings.ldap.startTls",{defaultValue:"Use StartTLS"}),name:"start_tls",valuePropName:"checked",children:e.jsx(J,{disabled:!f})}),e.jsx(a.Item,{label:t("settings.ldap.insecure",{defaultValue:"Skip TLS Verification (Insecure)"}),name:"insecure",valuePropName:"checked",children:e.jsx(J,{disabled:!f})}),e.jsx(a.Item,{label:t("settings.ldap.caCert",{defaultValue:"CA Certificate"}),name:"ca_cert",children:e.jsx(p.TextArea,{placeholder:t("settings.ldap.caCertPlaceholder",{defaultValue:`-----BEGIN CERTIFICATE-----
...`}),disabled:!f})}),e.jsx(a.Item,{label:t("settings.ldap.clientCert",{defaultValue:"Client Certificate"}),name:"client_cert",children:e.jsx(p.TextArea,{placeholder:t("settings.ldap.clientCertPlaceholder",{defaultValue:`-----BEGIN CERTIFICATE-----
...`}),disabled:!f})}),e.jsx(a.Item,{label:t("settings.ldap.clientKey",{defaultValue:"Client Key"}),name:"client_key",children:e.jsx(p.TextArea,{placeholder:t("settings.ldap.clientKeyPlaceholder",{defaultValue:`-----BEGIN PRIVATE KEY-----
...`}),disabled:!f})}),e.jsxs(a.Item,{children:[e.jsx(ne,{permissions:["system:settings:update"],children:e.jsx(E,{type:"primary",htmlType:"submit",loading:s,children:t("settings.ldap.save",{defaultValue:"Save Settings"})})}),e.jsx(ne,{permissions:["system:settings:update"],children:e.jsx(E,{disabled:!f,style:{marginLeft:8},onClick:()=>j(!0),children:t("settings.ldap.testConnection",{defaultValue:"Test Connection"})})}),e.jsx(ne,{permissions:["authorization:user:create"],children:e.jsx(E,{disabled:!f,style:{marginLeft:8},onClick:()=>{i(!0)},children:t("settings.ldap.import",{defaultValue:"Import Users"})})})]})]}),e.jsxs(W,{title:t("settings.ldap.test.title",{defaultValue:"Test LDAP Connection"}),open:_,onCancel:()=>j(!1),footer:null,children:[e.jsxs(a,{form:d,layout:"vertical",onFinish:C,children:[e.jsx(a.Item,{label:t("settings.ldap.test.username",{defaultValue:"LDAP Username"}),name:"username",rules:[{required:!0,message:t("settings.ldap.test.usernameRequired",{defaultValue:"Please enter LDAP username for testing."})}],children:e.jsx(p,{disabled:!f})}),e.jsx(a.Item,{label:t("settings.ldap.test.password",{defaultValue:"LDAP Password"}),name:"password",rules:[{required:!0,message:t("settings.ldap.test.passwordRequired",{defaultValue:"Please enter LDAP password for testing."})}],children:e.jsx(p.Password,{disabled:!f})}),e.jsxs(a.Item,{children:[e.jsx(ne,{permissions:["system:settings:update"],children:e.jsx(E,{disabled:!f,type:"primary",htmlType:"submit",children:t("settings.ldap.test.test",{defaultValue:"Test"})})}),e.jsx(E,{style:{marginLeft:8},onClick:()=>j(!1),children:t("settings.ldap.test.cancel",{defaultValue:"Cancel"})})]})]}),e.jsx(me,{spinning:m,children:e.jsx(Ne,{active:m,loading:m,children:g&&(g.user?e.jsxs(ee,{bordered:!0,children:[e.jsx(ee.Item,{label:"Username",span:3,children:g.user.username}),e.jsx(ee.Item,{label:"Email",span:3,children:g.user.email}),e.jsx(ee.Item,{label:"FullName",span:3,children:g.user.full_name}),e.jsx(ee.Item,{label:"CreatedAt",span:3,children:g.user.created_at}),e.jsx(ee.Item,{label:"UpdatedAt",span:3,children:g.user.updated_at})]}):e.jsx($e,{direction:"vertical",current:(F=g.message)==null?void 0:F.findIndex(I=>!I.success),status:(T=g.message)!=null&&T.find(I=>!I.success)?"error":"finish",items:(w=g.message)==null?void 0:w.map(I=>({status:I.success?"finish":"error",title:I.message}))}))})})]}),e.jsx(jt,{visible:b,onCancel:()=>i(!1),fetchItems:()=>A.system.importLdapUsers({}),importItems:I=>A.system.importLdapUsers({user_dn:I}),columns:[{title:t("settings.ldap.username",{defaultValue:"Username"}),dataIndex:"username"},{title:t("settings.ldap.email",{defaultValue:"Email"}),dataIndex:"email"},{title:t("settings.ldap.fullName",{defaultValue:"Full Name"}),dataIndex:"full_name"},{title:t("settings.ldap.importStatus",{defaultValue:"Import Status"}),dataIndex:"imported",fixed:"right",render:(I,K,q,Q)=>Q?e.jsx(me,{indicator:e.jsx(De,{spin:!0})}):I?e.jsx(Be,{twoToneColor:"#52c41a"}):K.id?e.jsx(X,{color:"blue",children:t("settings.ldap.importTypeBound",{defaultValue:"Bound"})}):e.jsx(X,{color:"green",children:t("settings.ldap.importTypeNew",{defaultValue:"New"})})}]})]})},_t=()=>{const{t}=N("system"),{t:l}=N("common"),[s]=a.useForm(),[S,g]=x.useState(null),[h,_]=x.useState(!1),[j]=a.useForm(),[b,i]=x.useState(!1),{loading:d}=v(A.system.getSmtpSettings,{onSuccess:m=>{s.setFieldsValue(m),i(m.enabled)},onError:m=>{c.error(t("settings.smtp.loadError",{defaultValue:"Failed to load SMTP settings: {{error}}",error:`${m.message}`}))}});x.useEffect(()=>{g(null)},[h]);const{run:f,loading:U}=v(({port:m,...F})=>A.system.updateSmtpSettings({...F,port:Number(m)}),{manual:!0,onSuccess:()=>{c.success(t("settings.smtp.saveSuccess",{defaultValue:"SMTP settings saved successfully."}))},onError:m=>{c.error(t("settings.smtp.saveError",{defaultValue:"Failed to save SMTP settings: {{error}}",error:`${m.message}`}))}}),{run:z,loading:C}=v(async m=>{const{port:F,...T}=await s.validateFields();return await A.system.testSmtpConnection({...m,...T,port:Number(F)})},{onSuccess:m=>{g(m)},onError:m=>{c.error(t("settings.smtp.testError",{defaultValue:"SMTP connection test failed: {{error}}",error:`${m.message}`}))},manual:!0});return e.jsxs(e.Fragment,{children:[e.jsx(me,{spinning:d,children:e.jsxs(a,{form:s,layout:"vertical",onFinish:f,initialValues:{port:587,encryption:"STARTTLS"},children:[e.jsx(a.Item,{label:t("settings.smtp.enabled",{defaultValue:"Enable SMTP"}),name:"enabled",valuePropName:"checked",children:e.jsx(J,{onChange:m=>i(m)})}),e.jsx(a.Item,{label:t("settings.smtp.host",{defaultValue:"SMTP Host"}),name:"host",rules:[{required:b,message:t("settings.smtp.hostRequired",{defaultValue:"SMTP Host is required."})}],children:e.jsx(p,{disabled:!b,placeholder:"smtp.example.com"})}),e.jsx(a.Item,{label:t("settings.smtp.port",{defaultValue:"SMTP Port"}),name:"port",rules:[{required:b,message:t("settings.smtp.portRequired",{defaultValue:"SMTP Port is required."})}],children:e.jsx(p,{type:"number",disabled:!b,placeholder:"587"})}),e.jsx(a.Item,{label:t("settings.smtp.username",{defaultValue:"Username"}),name:"username",rules:[{required:b,message:t("settings.smtp.usernameRequired",{defaultValue:"Username is required."})}],children:e.jsx(p,{disabled:!b,placeholder:"user@example.com"})}),e.jsx(a.Item,{label:t("settings.smtp.password",{defaultValue:"Password"}),name:"password",children:e.jsx(p.Password,{disabled:!b,autoComplete:"new-password"})}),e.jsx(a.Item,{label:t("settings.smtp.encryption",{defaultValue:"Encryption"}),name:"encryption",rules:[{required:b,message:t("settings.smtp.encryptionRequired",{defaultValue:"Encryption is required."})}],children:e.jsxs(je.Group,{disabled:!b,children:[e.jsx(je.Button,{value:"None",children:t("settings.smtp.encryptionNone",{defaultValue:"None"})}),e.jsx(je.Button,{value:"SSL/TLS",children:t("settings.smtp.encryptionSslTls",{defaultValue:"SSL/TLS"})}),e.jsx(je.Button,{value:"STARTTLS",children:t("settings.smtp.encryptionStartTls",{defaultValue:"STARTTLS"})})]})}),e.jsx(a.Item,{label:t("settings.smtp.fromAddress",{defaultValue:"From Address"}),name:"from_address",rules:[{required:b,message:t("settings.smtp.fromAddressRequired",{defaultValue:"From Address is required."})},{type:"email",message:t("settings.smtp.fromAddressInvalid",{defaultValue:"Invalid email address."})}],children:e.jsx(p,{disabled:!b,placeholder:"noreply@example.com"})}),e.jsx(a.Item,{label:t("settings.smtp.fromName",{defaultValue:"From Name"}),name:"from_name",children:e.jsx(p,{disabled:!b,placeholder:t("settings.smtp.fromNamePlaceholder",{defaultValue:"System Notifications"})})}),e.jsx(Te,{children:t("settings.smtp.templateDivider",{defaultValue:"Template Configuration"})}),e.jsx(a.Item,{label:t("settings.smtp.resetPasswordTemplate",{defaultValue:"Reset Password Template"}),name:"reset_password_template",children:e.jsx(Ce,{theme:"snow"})}),e.jsx(a.Item,{label:t("settings.smtp.userLockedTemplate",{defaultValue:"User Locked Template"}),name:"user_locked_template",children:e.jsx(Ce,{theme:"snow"})}),e.jsx(a.Item,{label:t("settings.smtp.mfaCodeTemplate",{defaultValue:"MFA Code Template"}),name:"mfa_code_template",children:e.jsx(Ce,{theme:"snow"})}),e.jsxs(a.Item,{children:[e.jsx(ne,{permission:"system:setting:update",children:e.jsx(E,{type:"primary",htmlType:"submit",loading:U,style:{marginRight:8},children:l("save",{defaultValue:"Save"})})}),e.jsx(E,{onClick:()=>_(!0),disabled:!b||C,loading:C,children:t("settings.smtp.testConnection",{defaultValue:"Test Connection"})})]})]})}),e.jsx(W,{title:t("settings.smtp.testConnectionTitle",{defaultValue:"Test SMTP Connection"}),open:h,onCancel:()=>_(!1),footer:[e.jsx(E,{onClick:()=>_(!1),children:l("cancel",{defaultValue:"Cancel"})},"back"),e.jsx(E,{type:"primary",loading:C,onClick:()=>j.submit(),children:t("settings.smtp.sendTestEmail",{defaultValue:"Send Test Email"})},"submit")],children:e.jsxs(a,{form:j,layout:"vertical",onFinish:m=>z(m),children:[e.jsx(a.Item,{label:t("settings.smtp.testEmailRecipient",{defaultValue:"Recipient Email Address"}),name:"to",rules:[{required:!0,message:t("settings.smtp.testEmailRecipientRequired",{defaultValue:"Recipient email address is required."})},{type:"email",message:t("settings.smtp.testEmailRecipientInvalid",{defaultValue:"Invalid email address."})}],children:e.jsx(p,{placeholder:"test@example.com"})}),S&&e.jsx(a.Item,{label:t("settings.smtp.testResult",{defaultValue:"Test Result"}),children:S.success?e.jsx("span",{style:{color:"green"},children:t("settings.smtp.testSuccess",{defaultValue:"Connection successful!"})}):e.jsx("span",{style:{color:"red"},children:t("settings.smtp.testFailed",{defaultValue:"Connection failed: {{error}}",error:S.message})})})]})})]})},vt=()=>{const{t,i18n:l}=N("system"),{t:s}=N("common"),[S]=a.useForm(),{loading:g,data:h,refresh:_}=v(A.system.getSystemBaseSettings,{onSuccess:d=>{S.setFieldsValue(d)},onError:d=>{c.error(t("settings.fetchFailed",{defaultValue:"Failed to fetch settings"})),console.error("Failed to get system settings",d)}}),{loading:j,run:b}=v(A.system.updateSystemBaseSettings,{manual:!0,onSuccess:()=>{c.success(t("settings.updateSuccess",{defaultValue:"Settings updated successfully"})),_()},onError:d=>{c.error(t("settings.updateFailed",{defaultValue:"Failed to update settings"})),console.error("Failed to update system settings",d)}}),i=d=>{b(d)};return e.jsx(me,{spinning:g,children:e.jsxs(a,{form:S,layout:"vertical",onFinish:i,initialValues:h,children:[e.jsx(a.Item,{label:t("settings.base.name",{defaultValue:"Name"}),children:e.jsx(Le,{items:[{key:"default",label:s("language.default",{defaultValue:"Default"}),forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(a.Item,{name:"name",children:e.jsx(p,{})})})},...at.map(d=>({key:d.lang,label:l.language!==d.lang?s(`language.${d.lang}`,{defaultValue:d.label,lang:d.label}):d.label,forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(a.Item,{name:["name_i18n",d.lang],children:e.jsx(p,{})})})}))]})}),e.jsx(a.Item,{label:t("settings.base.logo",{defaultValue:"Logo"}),name:"logo",children:e.jsx(p,{})}),e.jsx(a.Item,{label:t("settings.base.homePage",{defaultValue:"Home Page"}),name:"home_page",children:e.jsx(p,{})}),e.jsx(a.Item,{label:t("settings.base.disableLocalUserLogin",{defaultValue:"Disable Local User Login"}),name:"disable_local_user_login",tooltip:t("settings.base.disableLocalUserLoginTooltip",{defaultValue:"Disable local user login, It is only valid when other authentication methods are enabled."}),children:e.jsx(J,{})}),e.jsx(a.Item,{label:t("settings.base.enableMultiOrg",{defaultValue:"Enable Multi-Organization"}),name:"enable_multi_org",tooltip:t("settings.base.enableMultiOrgTooltip",{defaultValue:"Enable multi-organization feature. When enabled, organizations can be managed in the Organization Management tab."}),children:e.jsx(J,{})}),e.jsx(a.Item,{children:e.jsxs(B,{children:[e.jsx(E,{type:"primary",htmlType:"submit",loading:j,icon:e.jsx(ke,{}),children:s("save",{defaultValue:"Save"})}),e.jsx(E,{onClick:()=>_(),icon:e.jsx(oe,{}),children:s("refresh",{defaultValue:"Refresh"})})]})})]})})},{TextArea:It}=p,wt=()=>{var ie;const{t}=N("ai"),{t:l}=N("common"),[s]=a.useForm(),[S,g]=x.useState(!1),[h,_]=x.useState(null),[j,b]=x.useState(""),[i,d]=x.useState(""),[f,U]=x.useState({}),{loading:z,data:C}=v(()=>A.ai.getAiTypeDefinitions(),{refreshDeps:[],onError:r=>{c.error(t("models.fetchTypeDefinitionsFailed",{defaultValue:"Failed to fetch AI type definitions"})),console.error("Failed to fetch AI type definitions:",r)}}),m=x.useMemo(()=>C==null?void 0:C.find(r=>r.provider===i),[C,i]),{loading:F,data:T,refresh:w}=v(()=>A.ai.listAiModels({current:1,page_size:100,search:j}),{refreshDeps:[j],onError:r=>{c.error(t("models.fetchFailed",{defaultValue:"Failed to fetch AI models"})),console.error("Failed to fetch AI models:",r)}}),{loading:I,run:K}=v(({config:r,...k})=>A.ai.createAiModel({config:r??{},...k}),{manual:!0,onSuccess:()=>{c.success(t("models.createSuccess",{defaultValue:"AI model created successfully"})),g(!1),s.resetFields(),w()},onError:r=>{c.error(t("models.createFailed",{defaultValue:"Failed to create AI model"})),console.error("Failed to create AI model:",r)}}),{loading:q,run:Q}=v(({id:r,data:k})=>A.ai.updateAiModel({id:r},k),{manual:!0,onSuccess:()=>{c.success(t("models.updateSuccess",{defaultValue:"AI model updated successfully"})),g(!1),s.resetFields(),_(null),w()},onError:r=>{c.error(t("models.updateFailed",{defaultValue:"Failed to update AI model"})),console.error("Failed to update AI model:",r)}}),{runAsync:G}=v(r=>A.ai.deleteAiModel({id:r}),{manual:!0,onSuccess:()=>{c.success(t("models.deleteSuccess",{defaultValue:"AI model deleted successfully"})),w()},onError:r=>{c.error(t("models.deleteFailed",{defaultValue:"Failed to delete AI model"})),console.error("Failed to delete AI model:",r)}}),{runAsync:L}=v(r=>A.ai.testAiModel({id:r}),{manual:!0,onSuccess:()=>{c.success(t("models.testSuccess",{defaultValue:"AI model connection test successful"}))},onError:r=>{c.error(t("models.testFailed",{defaultValue:"AI model connection test failed"})),console.error("Failed to test AI model:",r)}}),{runAsync:H}=v(r=>A.ai.setDefaultAiModel({id:r}),{manual:!0,onSuccess:()=>{c.success(t("models.setDefaultSuccess",{defaultValue:"Default AI model set successfully"})),w()},onError:r=>{c.error(t("models.setDefaultFailed",{defaultValue:"Failed to set default AI model"})),console.error("Failed to set default AI model:",r)}}),y=()=>{_(null),d(""),U({}),s.resetFields(),g(!0)},o=r=>{_(r),d(r.provider);const k=r.config||{},Z={name:r.name,description:r.description,provider:r.provider,is_default:r.is_default,config:k,status:r.status};console.log(Z),U(Z),s.setFieldsValue(Z),g(!0)},M=r=>{d(r),m!=null&&m.config_fields&&m.config_fields.forEach(k=>{s.setFieldValue(k.name,void 0)})},pe=r=>{const k={};m!=null&&m.config_fields&&m.config_fields.forEach(te=>{var re;const se=(re=r.config)==null?void 0:re[te.name];se!=null&&se!==""&&(k[te.name]=se)});const Z={name:r.name,description:r.description,provider:r.provider,config:k,is_default:r.is_default,status:r.status};h?Q({id:h.id,data:Z}):K(Z)},ge=r=>{var Z;if(!((Z=r.data_source)!=null&&Z.depends_on))return{};const k={};return r.data_source.depends_on.forEach(te=>{k[te]=f[te]}),k},fe=[{title:t("models.name",{defaultValue:"Name"}),dataIndex:"name",key:"name",render:(r,k)=>e.jsxs(B,{children:[e.jsx("span",{children:r}),k.is_default&&e.jsx(He,{title:t("models.defaultModel",{defaultValue:"Default Model"}),children:e.jsx(Ke,{style:{color:"#faad14"}})})]})},{title:t("models.provider",{defaultValue:"Provider"}),dataIndex:"provider",key:"provider",render:r=>e.jsx(X,{color:"blue",children:r.toUpperCase()})},{title:t("models.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:r=>e.jsx(X,{color:r==="enabled"?"green":"red",children:r==="enabled"?t("common.enabled",{defaultValue:"Enabled"}):t("common.disabled",{defaultValue:"Disabled"})})},{title:l("actions",{defaultValue:"Actions"}),key:"actions",width:200,render:(r,k)=>e.jsx(Ie,{actions:[{key:"test",permission:"ai:models:test",icon:e.jsx(Oe,{}),tooltip:t("models.test",{defaultValue:"Test Connection"}),onClick:async()=>L(k.id)},{key:"setDefault",permission:"ai:models:setDefault",icon:e.jsx(Ge,{}),tooltip:t("models.setDefault",{defaultValue:"Set as Default"}),onClick:async()=>H(k.id)},{key:"update",permission:"ai:models:update",icon:e.jsx(Se,{}),tooltip:l("edit",{defaultValue:"Edit"}),onClick:async()=>o(k)},{key:"delete",permission:"ai:models:delete",icon:e.jsx(_e,{}),tooltip:l("delete",{defaultValue:"Delete"}),onClick:async()=>G(k.id),danger:!0}]},"actions")}];return e.jsxs("div",{children:[e.jsx(Y,{style:{marginBottom:16},children:e.jsxs(Fe,{justify:"space-between",align:"middle",children:[e.jsx(ce,{children:e.jsx(p.Search,{placeholder:t("models.searchPlaceholder",{defaultValue:"Search AI models..."}),style:{width:300},value:j,onChange:r=>b(r.target.value),allowClear:!0})}),e.jsx(ce,{children:e.jsxs(B,{children:[e.jsx(E,{type:"primary",icon:e.jsx(oe,{}),onClick:w,loading:F,children:l("refresh",{defaultValue:"Refresh"})}),e.jsx(ne,{permission:"ai:models:create",children:e.jsx(E,{type:"primary",icon:e.jsx(ve,{}),onClick:y,children:t("models.create",{defaultValue:"Create AI Model"})})})]})})]})}),e.jsx(Y,{children:e.jsx(xe,{columns:fe,dataSource:(T==null?void 0:T.data)||[],loading:F,rowKey:"id",pagination:{total:(T==null?void 0:T.total)||0,current:(T==null?void 0:T.current)||1,pageSize:(T==null?void 0:T.page_size)||10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(r,k)=>t("common.pagination.total",{defaultValue:`${k[0]}-${k[1]} of ${r} items`,start:k[0],end:k[1],total:r})}})}),e.jsx(W,{title:h?t("models.edit",{defaultValue:"Edit AI Model"}):t("models.create",{defaultValue:"Create AI Model"}),open:S,onCancel:()=>{g(!1),s.resetFields(),_(null)},footer:null,width:600,children:e.jsxs(a,{form:s,layout:"vertical",onFinish:pe,onValuesChange:(r,k)=>U(k),children:[e.jsx(a.Item,{name:"name",label:t("models.name",{defaultValue:"Name"}),rules:[{required:!0,message:t("models.nameRequired",{defaultValue:"Please enter model name"})}],children:e.jsx(p,{placeholder:t("models.namePlaceholder",{defaultValue:"Enter model name"})})}),e.jsx(a.Item,{name:"description",label:t("models.description",{defaultValue:"Description"}),children:e.jsx(It,{rows:3,placeholder:t("models.descriptionPlaceholder",{defaultValue:"Enter model description"})})}),e.jsx(a.Item,{name:"provider",label:t("models.provider",{defaultValue:"Provider"}),rules:[{required:!0,message:t("models.providerRequired",{defaultValue:"Please select provider"})}],children:e.jsx(P,{loading:z,placeholder:t("models.providerPlaceholder",{defaultValue:"Select provider"}),onChange:M,value:i,options:C==null?void 0:C.map(r=>({label:r.name,value:r.provider}))})}),(ie=m==null?void 0:m.config_fields)==null?void 0:ie.map(r=>e.jsx(qe,{field:r,selectedType:i,dependentValues:ge(r),formValues:f},r.name)),e.jsxs(a.Item,{name:"is_default",valuePropName:"checked",children:[e.jsx(J,{})," ",e.jsx("span",{style:{marginLeft:8},children:t("models.setAsDefault",{defaultValue:"Set as default model"})})]}),e.jsx(a.Item,{hidden:!0,name:"status",label:t("models.status",{defaultValue:"Status"}),children:e.jsx(p,{})}),e.jsx(a.Item,{children:e.jsxs(B,{children:[e.jsx(E,{type:"primary",htmlType:"submit",loading:I||q,children:h?l("update",{defaultValue:"Update"}):l("create",{defaultValue:"Create"})}),e.jsx(E,{onClick:()=>{g(!1),s.resetFields(),_(null),d(""),U({})},children:l("cancel",{defaultValue:"Cancel"})})]})})]})})]})},{TextArea:Ct}=p,Ft=()=>{var Ee;const{t}=N("system"),{t:l}=N("common"),[s]=a.useForm(),[S,g]=x.useState(!1),[h,_]=x.useState(null),[j,b]=x.useState(""),[i,d]=x.useState(!1),[f,U]=x.useState(null),[z,C]=x.useState(""),[m,F]=x.useState(!1),[T,w]=x.useState([]),[I,K]=x.useState({}),[q,Q]=x.useState(),{loading:G,data:L,refresh:H}=v(()=>A.system.listToolSets({current:1,page_size:100,search:j,type:q}),{refreshDeps:[j,q],onError:n=>{c.error(t("settings.toolsets.fetchFailed",{defaultValue:"Failed to fetch toolsets"})),console.error("Failed to fetch toolsets:",n)}}),{loading:y,data:o}=v(()=>A.system.getToolSetTypeDefinitions(),{refreshDeps:[],onError:n=>{c.error(t("settings.toolsets.fetchTypeDefinitionsFailed",{defaultValue:"Failed to fetch toolset type definitions"})),console.error("Failed to fetch toolset type definitions:",n)}}),M=x.useMemo(()=>o==null?void 0:o.find(n=>n.tool_set_type===z),[o,z]),{loading:pe,run:ge}=v(n=>A.system.createToolSet({...n,type:n.type}),{manual:!0,onSuccess:()=>{c.success(t("settings.toolsets.createSuccess",{defaultValue:"toolset created successfully"})),g(!1),s.resetFields(),H()},onError:n=>{c.error(t("settings.toolsets.createFailed",{defaultValue:"Failed to create toolset"})),console.error("Failed to create toolset:",n)}}),{loading:fe,run:ie}=v(({id:n,data:V})=>A.system.updateToolSet({id:n},{...V,type:V.type}),{manual:!0,onSuccess:()=>{c.success(t("settings.toolsets.updateSuccess",{defaultValue:"toolset updated successfully"})),g(!1),s.resetFields(),_(null),H()},onError:n=>{c.error(t("settings.toolsets.updateFailed",{defaultValue:"Failed to update toolset"})),console.error("Failed to update toolset:",n)}}),{run:r}=v(n=>A.system.deleteToolSet({id:n}),{manual:!0,onSuccess:()=>{c.success(t("settings.toolsets.deleteSuccess",{defaultValue:"toolset deleted successfully"})),H()},onError:n=>{c.error(t("settings.toolsets.deleteFailed",{defaultValue:"Failed to delete toolset"})),console.error("Failed to delete toolset:",n)}}),{runAsync:k}=v(n=>A.system.testToolSet({id:n}),{manual:!0,onSuccess:()=>{c.success(t("settings.toolsets.testSuccess",{defaultValue:"toolset connection test successful"}))},onError:n=>{c.error(t("settings.toolsets.testFailed",{defaultValue:"toolset connection test failed"})),console.error("Failed to test toolset:",n)}}),{loading:Z,runAsync:te}=v(n=>A.system.getToolSetTools({id:n}),{manual:!0,onSuccess:n=>{w(n||[]),F(!0)},onError:n=>{c.error(t("settings.toolsets.fetchToolsFailed",{defaultValue:"Failed to fetch tools"})),console.error("Failed to fetch tools:",n)}}),{runAsync:se}=v(({id:n,status:V})=>A.system.updateToolSetStatus({id:n},{status:V}),{manual:!0,onSuccess:()=>{c.success(t("settings.toolsets.statusUpdateSuccess",{defaultValue:"Status updated successfully"})),H()},onError:n=>{c.error(t("settings.toolsets.statusUpdateFailed",{defaultValue:"Failed to update status"})),console.error("Failed to update status:",n)}}),re=()=>{_(null),s.resetFields(),C(""),g(!0)},we=n=>{_(n),C(n.type);const V={...n};if(V.config){const O=o==null?void 0:o.find(R=>R.tool_set_type===n.type);if(O){const R={};O.config_fields.forEach(D=>{var de,ze;D.type==="object"&&((de=V.config)!=null&&de[D.name])?R[D.name]=JSON.stringify(V.config[D.name],null,2):((ze=V.config)==null?void 0:ze[D.name])!==void 0&&(R[D.name]=V.config[D.name])}),V.config=R}}s.setFieldsValue(V),g(!0)};console.log(z,o);const be=n=>{C(n);const V=o==null?void 0:o.find(O=>O.tool_set_type===n);if(V){const O={};V.config_fields.forEach(R=>{if(R.default)switch(R.type){case"number":O[R.name]=Number(R.default);break;case"boolean":O[R.name]=R.default==="true";break;case"array":O[R.name]=R.default.split(",");break;default:O[R.name]=R.default}}),s.setFieldValue("config",O)}else s.setFieldValue("config",void 0)},Ve=n=>{if(n.config&&M){const V={};M.config_fields.forEach(O=>{var D;const R=(D=n.config)==null?void 0:D[O.name];if(R!==void 0)if(O.type==="object")try{V[O.name]=typeof R=="string"?JSON.parse(R):R}catch{V[O.name]=R}else V[O.name]=R}),n.config=V}h?ie({id:h.id,data:n}):ge(n)},he=n=>{r(n)},u=n=>{U(n),d(!0)},$=n=>{console.log(new Date,"handleToggleStatus");const V=n.status==="enabled"?"disabled":"enabled";return se({id:n.id,status:V}).then(()=>{console.log(new Date,"handleToggleStatus1")})},ae=n=>{var O;if(!((O=n.data_source)!=null&&O.depends_on)||n.data_source.depends_on.length===0)return{};const V={};return n.data_source.depends_on.forEach(R=>{var de;const D=(de=I.config)==null?void 0:de[R];D!==void 0&&(V[R]=D)}),V};console.log(L);const ye=[{title:t("settings.toolsets.name",{defaultValue:"Name"}),dataIndex:"name",key:"name"},{title:t("settings.toolsets.type",{defaultValue:"Type"}),dataIndex:"type",key:"type",render:n=>e.jsx(X,{color:"blue",children:n.toUpperCase()})},{title:t("settings.toolsets.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:n=>e.jsx(X,{color:n==="enabled"?"green":"red",children:n==="enabled"?t("common.enabled",{defaultValue:"Enabled"}):t("common.disabled",{defaultValue:"Disabled"})})},{title:l("actions",{defaultValue:"Actions"}),key:"actions",width:200,render:(n,V)=>e.jsx(Ie,{actions:[{key:"test",permission:"system:toolsets:test",tooltip:t("settings.toolsets.test",{defaultValue:"Test Connection"}),icon:e.jsx(Ze,{}),disabled:V.status!=="enabled",onClick:async()=>k(V.id)},{key:"viewTools",icon:e.jsx(Me,{}),permission:"system:toolsets:view",disabled:V.status!=="enabled",tooltip:t("settings.toolsets.viewTools",{defaultValue:"View Tools"}),onClick:async()=>te(V.id)},{key:"viewConfig",icon:e.jsx(Je,{}),permission:"system:toolsets:view",tooltip:t("settings.toolsets.viewConfig",{defaultValue:"View Configuration"}),onClick:async()=>u(V.config),disabled:!V.config},{key:"edit",permission:"system:toolsets:update",tooltip:t("settings.toolsets.edit",{defaultValue:"Edit"}),icon:e.jsx(Se,{}),onClick:async()=>we(V)},{key:"toggleStatus",icon:V.status==="enabled"?e.jsx(We,{}):e.jsx(Oe,{}),onClick:async()=>$(V),permission:"system:toolsets:update",tooltip:V.status==="enabled"?l("disable",{defaultValue:"Disable"}):l("enable",{defaultValue:"Enable"})},{key:"delete",icon:e.jsx(_e,{}),permission:"system:toolsets:delete",tooltip:l("delete",{defaultValue:"Delete"}),onClick:async()=>he(V.id),danger:!0,confirm:{title:t("settings.toolsets.deleteConfirm",{defaultValue:"Are you sure you want to delete this toolset?"}),onConfirm:async()=>he(V.id),okText:l("confirm",{defaultValue:"Confirm"}),cancelText:l("cancel",{defaultValue:"Cancel"})}}]},"actions")}];return e.jsxs("div",{children:[e.jsx(Y,{style:{marginBottom:16},children:e.jsxs(Fe,{justify:"space-between",align:"middle",children:[e.jsx(ce,{children:e.jsxs(B,{children:[e.jsx(p.Search,{placeholder:t("settings.toolsets.searchPlaceholder",{defaultValue:"Search toolsets..."}),style:{width:300},value:j,onChange:n=>b(n.target.value),allowClear:!0}),e.jsxs(P,{placeholder:t("settings.toolsets.typePlaceholder",{defaultValue:"Select type"}),value:q,onChange:n=>Q(n),options:o==null?void 0:o.map(n=>({label:n.name,value:n.tool_set_type})),style:{minWidth:110},allowClear:!0,children:[e.jsx(P.Option,{value:"",children:"All"}),o==null?void 0:o.map(n=>e.jsx(P.Option,{value:n.tool_set_type,children:n.name},n.tool_set_type))]})]})}),e.jsx(ce,{children:e.jsxs(B,{children:[e.jsx(E,{type:"primary",icon:e.jsx(oe,{}),onClick:H,loading:G,children:l("refresh",{defaultValue:"Refresh"})}),e.jsx(ne,{permission:"system:toolsets:create",children:e.jsx(E,{type:"primary",icon:e.jsx(ve,{}),onClick:re,children:t("settings.toolsets.create",{defaultValue:"Create Toolset"})})})]})})]})}),e.jsx(Y,{children:e.jsx(xe,{columns:ye,dataSource:(L==null?void 0:L.data)||[],loading:G,rowKey:"id",pagination:{total:(L==null?void 0:L.total)||0,current:(L==null?void 0:L.current)||1,pageSize:(L==null?void 0:L.page_size)||10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(n,V)=>t("common.pagination.total",{defaultValue:`${V[0]}-${V[1]} of ${n} items`,start:V[0],end:V[1],total:n})}})}),e.jsx(W,{title:h?t("settings.toolsets.edit",{defaultValue:"Edit Toolset"}):t("settings.toolsets.create",{defaultValue:"Create Toolset"}),open:S,onCancel:()=>{g(!1),s.resetFields(),_(null),C("")},footer:null,width:600,children:e.jsxs(a,{form:s,layout:"vertical",onFinish:Ve,onValuesChange:(n,V)=>K(V),children:[e.jsx(a.Item,{name:"name",label:t("settings.toolsets.name",{defaultValue:"Name"}),rules:[{required:!0,message:t("settings.toolsets.nameRequired",{defaultValue:"Please enter toolset name"})}],children:e.jsx(p,{placeholder:t("settings.toolsets.namePlaceholder",{defaultValue:"Enter toolset name"})})}),e.jsx(a.Item,{name:"description",label:t("settings.toolsets.description",{defaultValue:"Description"}),children:e.jsx(Ct,{rows:3,placeholder:t("settings.toolsets.descriptionPlaceholder",{defaultValue:"Enter toolset description"})})}),e.jsx(a.Item,{name:"type",label:t("settings.toolsets.type",{defaultValue:"Type"}),rules:[{required:!0,message:t("settings.toolsets.typeRequired",{defaultValue:"Please select type"})}],children:e.jsx(P,{loading:y,placeholder:t("settings.toolsets.typePlaceholder",{defaultValue:"Select type"}),onChange:be,value:z,options:o==null?void 0:o.map(n=>({label:n.name,value:n.tool_set_type}))})}),(Ee=M==null?void 0:M.config_fields)==null?void 0:Ee.map(n=>e.jsx(qe,{field:n,selectedType:z,dependentValues:ae(n),formValues:I},n.name)),e.jsx(a.Item,{hidden:!0,name:"status",label:t("settings.toolsets.status",{defaultValue:"Status"}),children:e.jsx(p,{})}),e.jsx(a.Item,{children:e.jsxs(B,{children:[e.jsx(E,{type:"primary",htmlType:"submit",loading:pe||fe,children:h?l("update",{defaultValue:"Update"}):l("create",{defaultValue:"Create"})}),e.jsx(E,{onClick:()=>{g(!1),s.resetFields(),_(null),C("")},children:l("cancel",{defaultValue:"Cancel"})})]})})]})}),e.jsx(W,{title:t("settings.toolsets.configuration",{defaultValue:"Configuration"}),open:i,onCancel:()=>d(!1),footer:[e.jsx(E,{onClick:()=>d(!1),children:l("close",{defaultValue:"Close"})},"close")],width:600,children:e.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4,overflow:"auto"},children:JSON.stringify(f,null,2)})}),e.jsx(W,{title:t("settings.toolsets.tools",{defaultValue:"Tools"}),open:m,onCancel:()=>F(!1),footer:[e.jsx(E,{onClick:()=>F(!1),children:l("close",{defaultValue:"Close"})},"close")],width:800,children:e.jsx("div",{style:{maxHeight:"600px",overflow:"auto"},children:Z?e.jsx("div",{style:{textAlign:"center",padding:40},children:e.jsx(oe,{style:{fontSize:24},spin:!0})}):T.length===0?e.jsx("div",{style:{textAlign:"center",padding:40,color:"#999"},children:t("settings.toolsets.noTools",{defaultValue:"No tools available"})}):T.map((n,V)=>{var O,R,D;return e.jsx(Y,{style:{marginBottom:16},title:e.jsxs(B,{children:[e.jsx(Me,{}),e.jsx("strong",{children:((O=n.function)==null?void 0:O.name)||"Unknown"})]}),children:e.jsxs(Fe,{gutter:16,children:[e.jsxs(ce,{span:24,children:[e.jsx("p",{children:e.jsxs("strong",{children:[t("settings.toolsets.description",{defaultValue:"Description"}),":"]})}),e.jsx("p",{style:{marginBottom:16},children:((R=n.function)==null?void 0:R.description)||"-"})]}),((D=n.function)==null?void 0:D.parameters)&&e.jsxs(ce,{span:24,children:[e.jsx("p",{children:e.jsxs("strong",{children:[t("settings.toolsets.parameters",{defaultValue:"Parameters"}),":"]})}),e.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4,overflow:"auto",fontSize:12},children:JSON.stringify(n.function.parameters,null,2)})]})]})},V)})})})]})},{TextArea:Tt}=p,kt=()=>{const t=Ae(),{t:l}=N("system"),{t:s}=N("common"),[S]=a.useForm(),[g,h]=x.useState(!1),[_,j]=x.useState(null),[b,i]=x.useState(""),[d,f]=x.useState(1),[U,z]=x.useState(10),{loading:C,data:m,refresh:F}=v(()=>nt({current:d,page_size:U,search:b}),{refreshDeps:[d,U,b],onError:o=>{c.error(l("settings.organizations.fetchFailed",{defaultValue:"Failed to fetch organizations"})),console.error("Failed to fetch organizations:",o)}}),{loading:T,run:w}=v(o=>ot(o),{manual:!0,onSuccess:()=>{c.success(l("settings.organizations.createSuccess",{defaultValue:"Organization created successfully"})),h(!1),S.resetFields(),j(null),F()},onError:o=>{c.error((o==null?void 0:o.err)||l("settings.organizations.createFailed",{defaultValue:"Failed to create organization"}))}}),{loading:I,run:K}=v(({id:o,...M})=>it({id:o},M),{manual:!0,onSuccess:()=>{c.success(l("settings.organizations.updateSuccess",{defaultValue:"Organization updated successfully"})),h(!1),S.resetFields(),j(null),F()},onError:o=>{c.error((o==null?void 0:o.err)||l("settings.organizations.updateFailed",{defaultValue:"Failed to update organization"}))}}),{run:q}=v(o=>rt({id:o}),{manual:!0,onSuccess:()=>{c.success(l("settings.organizations.deleteSuccess",{defaultValue:"Organization deleted successfully"})),F()},onError:o=>{c.error((o==null?void 0:o.err)||l("settings.organizations.deleteFailed",{defaultValue:"Failed to delete organization"}))}}),Q=()=>{j(null),S.resetFields(),S.setFieldsValue({status:"active"}),h(!0)},G=o=>{j(o),S.setFieldsValue({name:o.name,description:o.description,status:o.status}),h(!0)},L=o=>{W.confirm({title:l("settings.organizations.deleteConfirm",{defaultValue:"Delete Organization"}),content:l("settings.organizations.deleteConfirmContent",{defaultValue:`Are you sure you want to delete organization "${o.name}"? This action cannot be undone.`}),onOk:()=>q(o.id)})},H=()=>{S.validateFields().then(o=>{_?K({id:_.id,...o}):w(o)})},y=[{title:l("settings.organizations.name",{defaultValue:"Name"}),dataIndex:"name",key:"name"},{title:l("settings.organizations.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:l("settings.organizations.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:o=>e.jsx(X,{color:o==="active"?"green":"default",children:o==="active"?l("settings.organizations.active",{defaultValue:"Active"}):l("settings.organizations.disabled",{defaultValue:"Disabled"})})},{title:s("actions",{defaultValue:"Actions"}),key:"actions",render:(o,M)=>e.jsx(Ie,{actions:[{key:"view",label:s("view",{defaultValue:"View"}),icon:e.jsx(Qe,{}),onClick:async()=>t(`/system/settings/organizations/${M.id}`),permission:"system:organization:view"},{key:"edit",label:s("edit",{defaultValue:"Edit"}),icon:e.jsx(Se,{}),onClick:async()=>G(M),permission:"system:organization:update"},{key:"delete",label:s("delete",{defaultValue:"Delete"}),icon:e.jsx(_e,{}),danger:!0,onClick:async()=>L(M),permission:"system:organization:delete"}]})}];return e.jsxs(Y,{title:l("settings.organizations.title",{defaultValue:"Organization Management"}),extra:e.jsxs(B,{children:[e.jsx(E,{icon:e.jsx(oe,{}),onClick:F,children:s("refresh",{defaultValue:"Refresh"})}),e.jsx(ne,{permission:"system:organization:create",children:e.jsx(E,{type:"primary",icon:e.jsx(ve,{}),onClick:Q,children:l("settings.organizations.create",{defaultValue:"Create Organization"})})})]}),children:[e.jsxs(B,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsx(p.Search,{placeholder:l("settings.organizations.searchPlaceholder",{defaultValue:"Search organizations..."}),allowClear:!0,onSearch:o=>{i(o),f(1)},style:{width:300}}),e.jsx(xe,{columns:y,dataSource:(m==null?void 0:m.data)||[],loading:C,rowKey:"id",pagination:{current:d,pageSize:U,total:(m==null?void 0:m.total)||0,showSizeChanger:!0,showTotal:(o,M)=>l("common.pagination.total",{defaultValue:`${M[0]}-${M[1]} of ${o} items`,start:M[0],end:M[1],total:o}),onChange:(o,M)=>{f(o),z(M)}}})]}),e.jsx(W,{title:_?l("settings.organizations.edit",{defaultValue:"Edit Organization"}):l("settings.organizations.create",{defaultValue:"Create Organization"}),open:g,onOk:H,onCancel:()=>{h(!1),S.resetFields(),j(null)},confirmLoading:T||I,width:600,children:e.jsxs(a,{form:S,layout:"vertical",children:[e.jsx(a.Item,{name:"name",label:l("settings.organizations.name",{defaultValue:"Name"}),rules:[{required:!0,message:l("settings.organizations.nameRequired",{defaultValue:"Please enter organization name"})}],children:e.jsx(p,{})}),e.jsx(a.Item,{name:"description",label:l("settings.organizations.description",{defaultValue:"Description"}),children:e.jsx(Tt,{rows:3})}),e.jsx(a.Item,{name:"status",label:l("settings.organizations.status",{defaultValue:"Status"}),rules:[{required:!0}],children:e.jsxs(P,{children:[e.jsx(P.Option,{value:"active",children:l("settings.organizations.active",{defaultValue:"Active"})}),e.jsx(P.Option,{value:"disabled",children:l("settings.organizations.disabled",{defaultValue:"Disabled"})})]})})]})})]})},At=({transformItems:t=l=>l})=>{const{t:l}=N("system"),s=Ae(),S=Xe(),_=S.hash.replace("#","")||"base",{enableMultiOrg:j}=gt(),{hasPermission:b}=ft(),i=[{key:"base",label:l("settings.tabs.base",{defaultValue:"Base Settings"}),children:e.jsx(vt,{}),hidden:!b("system:settings:update")},{key:"security",label:l("settings.tabs.security",{defaultValue:"Security Settings"}),children:e.jsx(yt,{}),hidden:!b("system:security:update")},{key:"oauth",label:l("settings.tabs.oauth",{defaultValue:"OAuth Settings"}),children:e.jsx(Vt,{}),hidden:!b("system:settings:update")},{key:"ldap",label:l("settings.tabs.ldap",{defaultValue:"LDAP Settings"}),children:e.jsx(St,{}),hidden:!b("system:settings:update")},{key:"smtp",label:l("settings.tabs.smtp",{defaultValue:"SMTP Settings"}),children:e.jsx(_t,{}),hidden:!b("system:settings:update")},{key:"ai-models",label:l("settings.tabs.aiModels",{defaultValue:"AI Models"}),children:e.jsx(wt,{}),hidden:!b("ai:models:view")},{key:"ai-toolsets",label:l("settings.tabs.toolSets",{defaultValue:"Tool Sets"}),children:e.jsx(Ft,{}),hidden:!b("system:toolsets:view")},...j?[{key:"organizations",label:l("settings.tabs.organizations",{defaultValue:"Organizations"}),children:e.jsx(kt,{}),hidden:!b("system:organization:view")}]:[]];return console.log(i,b("system:settings:update")),e.jsx(Y,{title:l("settings.title",{defaultValue:"System Settings"}),children:e.jsx(Le,{defaultActiveKey:_,onChange:d=>{s(`${S.pathname}#${d}`)},items:t(i.filter(d=>!d.hidden),l)})})},Nt=Object.freeze(Object.defineProperty({__proto__:null,default:At},Symbol.toStringTag,{value:"Module"})),Et=()=>{var be,Ve,he;const t=Ae(),{id:l}=Ye(),{t:s}=N("system"),{t:S}=N("common"),[g]=a.useForm(),[h]=a.useForm(),[_,j]=x.useState(!1),[b,i]=x.useState(!1),[d,f]=x.useState(null),[U,z]=x.useState(""),[C,m]=x.useState(1),[F,T]=x.useState(10),{data:w,loading:I,refresh:K}=v(()=>ut({id:l}),{ready:!!l,onError:u=>{c.error(s("settings.organizations.fetchFailed",{defaultValue:"Failed to fetch organization"})),console.error("Failed to fetch organization:",u)}}),{data:q,loading:Q,refresh:G}=v(()=>dt({id:l,current:C,page_size:F,search:U}),{ready:!!l,refreshDeps:[l,C,F,U],onError:u=>{c.error(s("settings.organizations.users.fetchFailed",{defaultValue:"Failed to fetch organization users"})),console.error("Failed to fetch organization users:",u)}}),{data:L,loading:H}=v(()=>ht({current:1,page_size:1e3}),{ready:_}),{data:y,loading:o}=v(()=>xt({organization_id:l,current:1,page_size:1e3}),{ready:!!l}),{loading:M,run:pe}=v(u=>ct({id:l},u),{manual:!0,onSuccess:()=>{c.success(s("settings.organizations.users.addSuccess",{defaultValue:"User added to organization successfully"})),j(!1),g.resetFields(),G()},onError:u=>{c.error((u==null?void 0:u.err)||s("settings.organizations.users.addFailed",{defaultValue:"Failed to add user to organization"}))}}),{loading:ge,run:fe}=v(u=>mt({id:l,user_id:d==null?void 0:d.id},u),{manual:!0,onSuccess:()=>{c.success(s("settings.organizations.users.updateRolesSuccess",{defaultValue:"User roles updated successfully"})),i(!1),h.resetFields(),f(null),G()},onError:u=>{c.error((u==null?void 0:u.err)||s("settings.organizations.users.updateRolesFailed",{defaultValue:"Failed to update user roles"}))}}),{run:ie}=v(u=>pt({id:l,user_id:u}),{manual:!0,onSuccess:()=>{c.success(s("settings.organizations.users.removeSuccess",{defaultValue:"User removed from organization successfully"})),G()},onError:u=>{c.error((u==null?void 0:u.err)||s("settings.organizations.users.removeFailed",{defaultValue:"Failed to remove user from organization"}))}}),r=()=>{j(!0),g.resetFields()},k=u=>{var $;f(u),h.setFieldsValue({role_ids:(($=u.organization_roles)==null?void 0:$.map(ae=>ae.id))||[]}),i(!0)},Z=u=>{W.confirm({title:s("settings.organizations.users.removeConfirm",{defaultValue:"Remove User"}),content:s("settings.organizations.users.removeConfirmContent",{defaultValue:`Are you sure you want to remove user "${u.full_name||u.username}" from this organization? This will also remove all their roles in this organization.`}),onOk:()=>ie(u.id)})},te=()=>{g.validateFields().then(u=>{pe(u)})},se=()=>{h.validateFields().then(u=>{fe(u)})},re=((be=L==null?void 0:L.data)==null?void 0:be.filter(u=>{var $;return!(($=q==null?void 0:q.data)!=null&&$.some(ae=>ae.id===u.id))}))||[],we=[{title:s("settings.organizations.users.username",{defaultValue:"Username"}),dataIndex:"username",key:"username"},{title:s("settings.organizations.users.email",{defaultValue:"Email"}),dataIndex:"email",key:"email"},{title:s("settings.organizations.users.fullName",{defaultValue:"Full Name"}),dataIndex:"full_name",key:"full_name"},{title:s("settings.organizations.users.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:u=>e.jsx(X,{color:u==="active"?"green":"default",children:u==="active"?s("settings.organizations.active",{defaultValue:"Active"}):u})},{title:s("settings.organizations.users.roles",{defaultValue:"Roles"}),key:"roles",render:(u,$)=>{var ae;return e.jsx(B,{wrap:!0,children:((ae=$.organization_roles)==null?void 0:ae.map(ye=>e.jsx(X,{children:ye.name},ye.id)))||e.jsx(X,{children:"No roles"})})}},{title:S("actions",{defaultValue:"Actions"}),key:"actions",render:(u,$)=>e.jsx(Ie,{actions:[{key:"edit",label:s("settings.organizations.users.editRoles",{defaultValue:"Edit Roles"}),icon:e.jsx(Se,{}),onClick:async()=>k($)},{key:"delete",label:s("settings.organizations.users.remove",{defaultValue:"Remove"}),icon:e.jsx(_e,{}),danger:!0,onClick:async()=>Z($)}]})}];return e.jsxs("div",{children:[e.jsx(Y,{title:e.jsxs(B,{children:[e.jsx(E,{icon:e.jsx(et,{}),onClick:()=>t("/system/settings#organizations"),children:S("back",{defaultValue:"Back"})}),e.jsxs("span",{children:[s("settings.organizations.detail",{defaultValue:"Organization Detail"}),": ",w==null?void 0:w.name]})]}),extra:e.jsx(E,{icon:e.jsx(oe,{}),onClick:()=>{K(),G()},children:S("refresh",{defaultValue:"Refresh"})}),loading:I,children:e.jsxs(ee,{column:2,bordered:!0,children:[e.jsx(ee.Item,{label:s("settings.organizations.name",{defaultValue:"Name"}),children:w==null?void 0:w.name}),e.jsx(ee.Item,{label:s("settings.organizations.status",{defaultValue:"Status"}),children:e.jsx(X,{color:(w==null?void 0:w.status)==="active"?"green":"default",children:(w==null?void 0:w.status)==="active"?s("settings.organizations.active",{defaultValue:"Active"}):s("settings.organizations.disabled",{defaultValue:"Disabled"})})}),e.jsx(ee.Item,{label:s("settings.organizations.description",{defaultValue:"Description"}),span:2,children:(w==null?void 0:w.description)||"-"})]})}),e.jsx(Y,{title:s("settings.organizations.users.title",{defaultValue:"Organization Users"}),extra:e.jsx(E,{type:"primary",icon:e.jsx(ve,{}),onClick:r,children:s("settings.organizations.users.add",{defaultValue:"Add User"})}),style:{marginTop:16},children:e.jsxs(B,{direction:"vertical",style:{width:"100%"},size:"middle",children:[e.jsx(p.Search,{placeholder:s("settings.organizations.users.searchPlaceholder",{defaultValue:"Search users..."}),allowClear:!0,onSearch:u=>{z(u),m(1)},style:{width:300}}),e.jsx(xe,{columns:we,dataSource:(q==null?void 0:q.data)||[],loading:Q,rowKey:"id",pagination:{current:C,pageSize:F,total:(q==null?void 0:q.total)||0,showSizeChanger:!0,showTotal:u=>S("pagination.total",{defaultValue:`Total ${u} items`}),onChange:(u,$)=>{m(u),T($)}}})]})}),e.jsx(W,{title:s("settings.organizations.users.add",{defaultValue:"Add User"}),open:_,onOk:te,onCancel:()=>{j(!1),g.resetFields()},confirmLoading:M,width:600,children:e.jsxs(a,{form:g,layout:"vertical",children:[e.jsx(a.Item,{name:"user_id",label:s("settings.organizations.users.user",{defaultValue:"User"}),rules:[{required:!0,message:s("settings.organizations.users.userRequired",{defaultValue:"Please select a user"})}],children:e.jsx(P,{showSearch:!0,placeholder:s("settings.organizations.users.selectUser",{defaultValue:"Select a user"}),loading:H,filterOption:(u,$)=>(($==null?void 0:$.label)??"").toLowerCase().includes(u.toLowerCase()),options:re.map(u=>({label:`${u.full_name||u.username} (${u.email})`,value:u.id}))})}),e.jsx(a.Item,{name:"role_ids",label:s("settings.organizations.users.roles",{defaultValue:"Roles"}),children:e.jsx(P,{mode:"multiple",placeholder:s("settings.organizations.users.selectRoles",{defaultValue:"Select roles (optional)"}),loading:o,options:((Ve=y==null?void 0:y.data)==null?void 0:Ve.map(u=>({label:u.name,value:u.id})))||[]})})]})}),e.jsx(W,{title:s("settings.organizations.users.editRoles",{defaultValue:"Edit Roles"}),open:b,onOk:se,onCancel:()=>{i(!1),h.resetFields(),f(null)},confirmLoading:ge,width:600,children:e.jsxs(a,{form:h,layout:"vertical",children:[e.jsx(a.Item,{label:s("settings.organizations.users.user",{defaultValue:"User"}),children:e.jsx(p,{value:(d==null?void 0:d.full_name)||(d==null?void 0:d.username),disabled:!0})}),e.jsx(a.Item,{name:"role_ids",label:s("settings.organizations.users.roles",{defaultValue:"Roles"}),children:e.jsx(P,{mode:"multiple",placeholder:s("settings.organizations.users.selectRoles",{defaultValue:"Select roles"}),loading:o,options:((he=y==null?void 0:y.data)==null?void 0:he.map(u=>({label:u.name,value:u.id})))||[]})})]})})]})},$t=Object.freeze(Object.defineProperty({__proto__:null,default:Et},Symbol.toStringTag,{value:"Module"})),zt=()=>{const{t}=N("system"),[l]=tt(),s=l.get("provider"),S=l.get("code"),g=l.get("state"),[h,_]=x.useState(null),[j,b]=x.useState(null),[i,d]=x.useState(null);return v(async()=>{if(!S||!g||!s)throw new Error(t("settings.oauth.testConnection.missingRequiredParameters",{defaultValue:"Missing required parameters"}));const f=await A.system.testOauthCallback({code:S,state:g,provider:s});if(!f.user_info)throw new Error(t("settings.oauth.testConnection.responseUserInfoIsNull",{defaultValue:"response user_info is null"}));if(!f.user)throw new Error(t("settings.oauth.testConnection.responseUserIsNull",{defaultValue:"response user is null"}));_(f.user),b(f.user_info)},{onSuccess:()=>{d({status:"success",message:t("settings.oauth.testConnection.success",{defaultValue:"Successfully tested connection"})})},onError:f=>{d({status:"error",message:t("settings.oauth.testConnection.callbackFailed",{defaultValue:"Failed to test connection"}),error:f.message})}}),i?e.jsx("div",{children:e.jsx(st,{status:i.status,title:i.message,subTitle:i.error,extra:e.jsxs(B,{style:{display:!j||!h?"none":"inline-block",textAlign:"left"},direction:"vertical",children:[e.jsx(Y,{title:t("settings.oauth.testConnection.oauthUserInfo",{defaultValue:"OAuth User Info"}),children:e.jsx(Pe,{src:j||{}})}),e.jsx(Y,{title:t("settings.oauth.testConnection.loginUserInfo",{defaultValue:"Login User Info"}),style:{marginTop:16},children:e.jsx(Pe,{src:h||{}})})]})})}):e.jsx(lt,{})},Dt=Object.freeze(Object.defineProperty({__proto__:null,default:zt},Symbol.toStringTag,{value:"Module"}));export{$t as O,Dt as a,Nt as i};
