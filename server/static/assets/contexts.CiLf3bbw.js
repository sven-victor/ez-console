import{r,e as P,j as v,t as b}from"./vendor.CPU8FhsP.js";import{a as p}from"./index.DWU4wfu6.js";import{c as S}from"./client.BCH7Jt5A.js";const w=r.createContext({user:null,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),M=()=>r.useContext(w),A=(t,u=!0)=>{t?(u&&localStorage.setItem("token",t),S.defaults.headers.common.Authorization=`Bearer ${t}`):(u&&localStorage.removeItem("token"),delete S.defaults.headers.common.Authorization)},I=({children:t})=>{const[u,s]=r.useState(null),[d,a]=r.useState(localStorage.getItem("token")),[_,C]=r.useState(!0),{run:k}=P(async()=>{const n=localStorage.getItem("token");return n?(A(n,!1),p.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:n=>{s(n)},onError:n=>{console.error("Failed to get current user:",n),y()},onFinally:()=>{C(!1)}});r.useEffect(()=>{k()},[]);const o=async n=>{try{const e=await p.authorization.login(n),{token:c,user:i,needs_mfa:m,password_expired:f,mfa_token:h,mfa_type:g}=e;if(m)throw{needsMFA:!0,mfaToken:h,mfaType:g,user:i};if(f)throw{password_expired:!0,user:i,token:c};return A(c),a(c),s(i),i}catch(e){throw e&&e.needsMFA||e&&e.password_expired||b.error("Login failed, please check your username and password"),e}},l=r.useCallback(async n=>{try{const e=await p.oauth.handleCallback(n);let c="",i=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:m,user:f,needs_mfa:h,mfa_token:g,mfa_type:x}=e.data;if(h)throw{needsMFA:!0,mfaToken:g,mfaType:x,user:f};c=m,i=f}else{const{token:m,user:f,needs_mfa:h,mfa_token:g,mfa_type:x}=e;if(h)throw{needsMFA:!0,mfaToken:g,mfaType:x,user:f};c=m,i=f}return A(c),a(c),s(i),i}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),y=()=>{p.authorization.logout(),A(null),a(null),s(null)},T=n=>{s(n)};return v.jsx(w.Provider,{value:{user:u,token:d,loading:_,login:o,oauthLogin:l,logout:y,updateUser:T},children:t})},j=()=>{const t=r.useContext(w);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t},L=()=>{var k;const{user:t}=r.useContext(w),u=localStorage.getItem("organization_id"),s=(k=t==null?void 0:t.roles)==null?void 0:k.filter(o=>!o.organization_id||o.organization_id===u),d=()=>s?s.some(o=>o.name==="admin"&&!o.organization_id):!1,a=o=>s?d()?!0:s.some(l=>l.permissions?l.permissions.some(y=>y.code===o):!1):!1;return{hasPermission:a,hasAllPermissions:o=>o.every(l=>a(l)),hasAnyPermission:o=>o.some(l=>a(l)),isAdmin:d(),loading:!t}},z=r.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null}),B=()=>r.useContext(z),D=({children:t})=>{const{user:u}=M(),{data:s=null,loading:d,runAsync:a}=P(async()=>p.system.getSiteConfig(),{manual:!0});return r.useEffect(()=>{a()},[u]),v.jsx(z.Provider,{value:{siteConfig:s,loading:d,enableMultiOrg:(s==null?void 0:s.enable_multi_org)??!1,fetchSiteConfig:a},children:t})};export{I as A,D as S,L as a,B as b,M as c,j as u};
