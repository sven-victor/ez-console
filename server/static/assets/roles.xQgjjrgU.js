import{u as O,aB as ae,r as n,j as e,K as P,aE as Re,Z as G,n as Ee,b7 as ve,T as Q,t as _,bb as Ae,_ as Pe,af as we,C as W,a1 as Te,a2 as ee,a6 as Ie,ad as Ce,v as b,c as ke,bc as Oe,q as x,ba as Ne,s as ie,ak as J,a3 as k,bd as Fe,be as De,bf as qe,aM as te,S as Me,a7 as B,$ as A}from"./vendor.7Q0EOQ7i.js";import{i as U,T as $e}from"./components.Sunzw3jj.js";import{a as S}from"./index.mxsXiNPK.js";import{b as ne,u as Le}from"./contexts.D8qyRq-I.js";const Ge=()=>{const{t:u}=O("authorization"),{t:o}=O("common"),{siteConfig:f}=ne(),V=ae(),h=n.useRef(null),p=r=>{V(`/authorization/roles/${r}/edit`)},R=async r=>{var i,s;try{await S.authorization.deleteRole({id:r}),b.success(u("role.deleteSuccess",{defaultValue:"Role deleted successfully."})),(s=(i=h.current)==null?void 0:i.reload)==null||s.call(i)}catch(E){b.error(u("role.deleteError",{defaultValue:"Failed to delete role: {{error}}",error:E}))}},N=[{title:u("role.name",{defaultValue:"Role Name"}),dataIndex:"name",key:"name",render:r=>e.jsxs(P,{children:[e.jsx(Re,{}),r]})},{title:u("role.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:u("role.organization",{defaultValue:"Organization"}),key:"organization",hidden:!(f!=null&&f.enable_multi_org),render:(r,i)=>{var s;return i.organization_id?e.jsx(G,{icon:e.jsx(Ee,{}),color:"blue",children:((s=i.organization)==null?void 0:s.name)||i.organization_id}):e.jsx(G,{color:"default",children:u("role.global",{defaultValue:"Global"})})}},{title:u("role.permissionCount",{defaultValue:"Permissions"}),key:"permission_count",render:(r,i)=>{var s;return e.jsxs(G,{color:"blue",children:[e.jsx(ve,{})," ",((s=i.permissions)==null?void 0:s.length)||0]})}},{title:u("role.createdAt",{defaultValue:"Created At"}),dataIndex:"created_at",key:"created_at",render:r=>new Date(r).toLocaleString()},{title:o("actions",{defaultValue:"Actions"}),key:"action",render:(r,i)=>e.jsxs(P,{size:"small",children:[e.jsx(U,{permission:"authorization:role:update",children:e.jsx(Q,{title:u("role.edit",{defaultValue:"Edit Role"}),children:e.jsx(_,{type:"text",size:"small",icon:e.jsx(Ae,{}),onClick:()=>p(i.id)})})}),e.jsx(U,{permission:"authorization:role:delete",children:e.jsx(Q,{title:u("role.delete",{defaultValue:"Delete Role"}),children:e.jsx(Pe,{title:u("role.deleteConfirm",{defaultValue:"Are you sure you want to delete this role?"}),onConfirm:()=>R(i.id),okText:o("confirm",{defaultValue:"Confirm"}),cancelText:o("cancel",{defaultValue:"Cancel"}),children:e.jsx(_,{type:"text",size:"small",danger:!0,icon:e.jsx(we,{})})})})})]})}];return e.jsx("div",{children:e.jsxs(W,{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:16},children:e.jsxs(Te,{justify:"space-between",align:"middle",gutter:16,children:[e.jsx(ee,{children:e.jsx(P,{children:e.jsx(_,{type:"primary",onClick:()=>{var r,i;(i=(r=h.current)==null?void 0:r.reload)==null||i.call(r)},icon:e.jsx(Ie,{}),children:o("refresh",{defaultValue:"Refresh"})})})}),e.jsx(ee,{children:e.jsx(U,{permission:"authorization:role:create",children:e.jsx(_,{type:"primary",icon:e.jsx(Ce,{}),onClick:()=>V("/authorization/roles/create"),children:u("role.create",{defaultValue:"Create Role"})})})})]})}),e.jsx($e,{request:async({page_size:r,current:i})=>S.authorization.listRoles({current:i,page_size:r}),columns:N,actionRef:h})]})})},Ye=Object.freeze(Object.defineProperty({__proto__:null,default:Ge},Symbol.toStringTag,{value:"Module"})),{TextArea:le}=ie,Je=ke(({css:u})=>({rolePermissionExtra:u`
      float: right;
      z-index: 1001;
      position: sticky;
    `,rolePolicyExtra:u`
      position: absolute;
      right: 5px;
      top: 5px;
    `})),Be={allow_all:{policy:{Statement:[{Effect:"Allow",Action:["*"]}]}},deny_all:{Statement:[{Effect:"Deny",Action:["*"]}]},allow_with_action:{Statement:[{Effect:"Allow",Action:["authorization:user:view"]}]},allow_with_condition:{Statement:[{Effect:"Allow",Action:["authorization:user:update"],Condition:{StringEquals:{"id:":"abcdef"}}},{Effect:"Deny",Action:["*"]}]},allow_with_uri:{Statement:[{Effect:"Allow",Action:["authorization:user:view"],Condition:{StringEquals:{"http.uri":"/api/users/abcdef","http.method":"GET"}}},{Effect:"Deny",Action:["*"]}]}},oe=JSON.stringify({Statement:[]},null,2),Ue=()=>{const{styles:u}=Je(),{t:o}=O("authorization"),{t:f}=O("common"),V=ae(),{id:h}=Oe(),p=!!h,{enableMultiOrg:R,currentOrgId:N}=ne(),{user:r}=Le(),i=(r==null?void 0:r.organizations)||[],[s]=x.useForm(),[E,w]=n.useState([]),[I,se]=n.useState([]),[re,F]=n.useState([]),[de,D]=n.useState(!0),[C,j]=n.useState([]),[T,g]=n.useState({}),q=n.useRef({}),[ce,H]=n.useState(!1),[y,M]=n.useState("global"),[$,ue]=n.useState(void 0),[me,K]=n.useState(!1),[fe,X]=n.useState(!1);n.useEffect(()=>{q.current=T},[T]),n.useEffect(()=>{ue(N||void 0)},[]);const Y=n.useCallback(async()=>{try{const l=await S.authorization.listPermissions();se(l.map((t,a)=>{const c=(t.permissions||[]).map(d=>({key:d.id,code:d.code.replace(/:/g,"."),title:d.name,orgPermission:d.org_permission||!1}));return{key:`[group]-${a}`,title:t.name,code:t.name.replace(/ /g,"_"),children:c}}))}catch{b.error(o("role.loadError",{defaultValue:"Failed to load role list"}))}},[o]);n.useEffect(()=>{Y()},[Y]);const v=n.useCallback(async(l,t)=>{if(!l){j([]),g(t||{});return}H(!0);try{const c=((await S.system.listToolSets({page_size:1e3,include_tools:!0},{headers:{"X-Scope-OrgID":l}})).data||[]).filter(z=>z.status==="enabled");j(c);const d=t||q.current||{},m={};c.forEach(z=>{const L=d[z.id]||[];m[z.id]=L.filter(ze=>(z.tools||[]).some(Se=>Se.name===ze))}),g(m)}catch{b.error(o("role.loadAiToolsetsError",{defaultValue:"Failed to load AI toolsets."})),j([]),g(t||{})}finally{H(!1)}},[o]),he=l=>l?l.reduce((t,a)=>(!a.toolset_id||!a.tool_name||(t[a.toolset_id]||(t[a.toolset_id]=[]),t[a.toolset_id].includes(a.tool_name)||t[a.toolset_id].push(a.tool_name)),t),{}):{},Z=n.useCallback(async l=>{var t;K(!0);try{const a=await S.authorization.getRole({id:l}),c=((t=a.permissions)==null?void 0:t.map(L=>L.id))||[];w(c),s.setFieldsValue({permissions:c});const d=a.organization_id||"",m=d?"organization":"global";M(m);const z=he(a.ai_tool_permissions);m==="organization"&&d?await v(d,z):(j([]),g({})),s.setFieldsValue({name:a.name,description:a.description,role_type:m,organization_id:d||void 0,policy_document:JSON.stringify(a.policy_document||{Statement:[]},null,2)})}catch{b.error(o("role.detailLoadError",{defaultValue:"Failed to load role details"})),V("/authorization/roles")}finally{K(!1)}},[v,s,V,o]);n.useEffect(()=>{if(p&&h){Z(h);return}const l=$||(i.length>0?i[0].id:""),t=R&&l?"organization":"global";M(t),s.setFieldsValue({role_type:t,organization_id:t==="organization"?l:void 0,policy_document:oe,permissions:[]}),w([]),g({}),t==="organization"&&l?v(l,{}):j([])},[v,s,h,p,i,$,R,Z]);const pe=n.useMemo(()=>y==="global"?I:I.map(t=>{const a=(t.children||[]).filter(c=>c.orgPermission===!0);return{...t,children:a}}).filter(t=>t.children&&t.children.length>0),[I,y]),ge=l=>{F(l),D(!1)},ye=()=>{const l=I.map(t=>t.key);F(l),D(!0)},xe=()=>{F([]),D(!1)},je=n.useCallback((l,t)=>{g(a=>({...a,[l]:t}))},[]),be=n.useCallback((l,t)=>{const a=C.find(d=>d.id===l);if(!a)return;const c=(a.tools||[]).map(d=>d.name);g(d=>({...d,[l]:t?c:[]}))},[C]),_e=(l,t)=>{if(y==="organization")return Promise.resolve();if(!t||t.trim()===""||t==="{}"||t==='{"Statement":[]}')return E.length===0?Promise.reject(new Error(o("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."}))):Promise.resolve();try{return JSON.parse(t),Promise.resolve()}catch{return Promise.reject(new Error(o("role.invalidJsonFormat",{defaultValue:"Invalid JSON format."})))}},Ve=async l=>{const t={...l};try{y==="global"?t.policy_document=JSON.parse(l.policy_document??"{}"):t.policy_document={Statement:[]},t.role_type==="organization"?t.organization_id=t.organization_id||void 0:t.organization_id=void 0,delete t.role_type;const a=y==="organization"?Object.entries(T).map(([c,d])=>({toolset_id:c,tools:Array.from(new Set(d))})).filter(c=>c.tools.length>0):[];t.ai_tool_permissions=a,t.permissions=E.filter(c=>!c.startsWith("[group]-")),X(!0),p&&h?(await S.authorization.updateRole({id:h},t),b.success(o("role.updateSuccess",{defaultValue:"Role updated successfully."}))):(await S.authorization.createRole(t),b.success(o("role.createSuccess",{defaultValue:"Role created successfully."}))),V("/authorization/roles")}catch{b.error(o("role.saveError",{defaultValue:"Failed to save role.",action:p?f("update",{defaultValue:"Update"}):f("create",{defaultValue:"Create"})}))}finally{X(!1)}};return e.jsx(W,{title:p?o("role.editTitle",{defaultValue:"Edit Role"}):o("role.createTitle",{defaultValue:"Create Role"}),loading:me,children:e.jsxs(x,{form:s,layout:"vertical",initialValues:{policy_document:oe,permissions:[]},onFinish:Ve,children:[e.jsx(Ne,{items:[{key:"basic",label:o("role.basicInfo",{defaultValue:"Basic Information"}),children:e.jsxs(e.Fragment,{children:[e.jsx(x.Item,{label:o("role.name",{defaultValue:"Role Name"}),name:"name",rules:[{required:!0,message:o("role.nameRequired",{defaultValue:"Please enter the role name."})}],children:e.jsx(ie,{placeholder:o("role.namePlaceholder",{defaultValue:"Enter role name"})})}),e.jsx(x.Item,{label:o("role.description",{defaultValue:"Description"}),name:"description",children:e.jsx(le,{rows:4,placeholder:o("role.descriptionPlaceholder",{defaultValue:"Enter role description"})})}),e.jsx(x.Item,{label:o("role.roleType",{defaultValue:"Role Type"}),name:"role_type",hidden:!R,rules:[{required:!0,message:o("role.roleTypeRequired",{defaultValue:"Please select role type."})}],extra:p?o("role.roleTypeCannotChange",{defaultValue:"Role type cannot be changed after creation."}):"",children:e.jsxs(J.Group,{disabled:p,onChange:l=>{const t=l.target.value;if(M(t),t==="global")s.setFieldsValue({organization_id:void 0}),j([]),g({});else{const a=$||(i.length>0?i[0].id:"");s.setFieldsValue({organization_id:a}),a?v(a,q.current):(j([]),g({}))}w([]),s.setFieldsValue({permissions:[]})},children:[e.jsx(J,{value:"global",children:o("role.globalRole",{defaultValue:"Global Role"})}),e.jsx(J,{value:"organization",children:o("role.organizationRole",{defaultValue:"Organization Role"})})]})}),y==="organization"&&e.jsx(x.Item,{hidden:!R,label:o("role.organization",{defaultValue:"Organization"}),name:"organization_id",rules:[{required:!0,message:o("role.organizationRequired",{defaultValue:"Please select an organization."})}],extra:i.length>0?o("role.organizationHelp",{defaultValue:"Select the organization this role belongs to"}):o("role.noOrganizationsAvailable",{defaultValue:"No organizations available. Please contact your administrator."}),children:i.length>0?e.jsx(k,{placeholder:o("role.selectOrganization",{defaultValue:"Select Organization"}),onChange:l=>{w([]),s.setFieldsValue({permissions:[]});const t=l||"";t?v(t,{}):(j([]),g({}))},children:i.map(l=>e.jsx(k.Option,{value:l.id,children:l.name},l.id))}):e.jsx(k,{disabled:!0,placeholder:o("role.noOrganizationsAvailable",{defaultValue:"No organizations available"})})})]})},{key:"permissions",label:o("role.permissions",{defaultValue:"Permissions"}),children:e.jsx(x.Item,{name:"permissions",rules:[{validator(){if(E.length===0)if(y==="global"){const l=s.getFieldValue("policy_document");if(!l||l.trim()===""||l==="{}"||l==='{"Statement":[]}')return Promise.reject(new Error(o("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."})))}else return Promise.reject(new Error(o("role.permissionRequired",{defaultValue:"Please select at least one permission."})));return Promise.resolve()}}],children:e.jsx("div",{children:e.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",border:"1px solid #d9d9d9",borderRadius:"4px"},children:[e.jsxs("span",{className:u.rolePermissionExtra,children:[e.jsx(_,{type:"link",onClick:ye,icon:e.jsx(Fe,{}),children:f("expandAll",{defaultValue:"Expand All"})}),e.jsx(_,{type:"link",onClick:xe,icon:e.jsx(De,{}),children:f("collapseAll",{defaultValue:"Collapse All"})})]}),e.jsx(qe,{treeData:pe,titleRender:l=>{const t=l,a=typeof t.title=="string"?t.title:String(t.title??"");return e.jsx("span",{children:o(`permission.title.${t.code}`,{defaultValue:a})})},checkable:!0,expandedKeys:re,autoExpandParent:de,onExpand:ge,checkedKeys:E,onCheck:l=>{let t=[];te.isArray(l)?t=l:te.has(l,"checked")&&(t=l.checked),w(t),s.setFieldsValue({permissions:t})}})]})})})},{key:"ai-tools",label:o("role.aiPermissions",{defaultValue:"AI Tool Permissions"}),disabled:y==="global",children:e.jsx(Me,{spinning:ce,children:y==="organization"?C.length>0?e.jsx(P,{direction:"vertical",size:"middle",style:{width:"100%"},children:C.map(l=>{const t=(l.tools||[]).map(m=>m.name),a=T[l.id]||[],c=t.length>0&&a.length===t.length,d=a.length>0&&a.length<t.length;return e.jsx(W,{size:"small",title:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx(B,{checked:c,indeterminate:d,onChange:m=>be(l.id,m.target.checked)}),e.jsx("span",{children:l.name})]}),extra:l.description?e.jsx("span",{children:l.description}):void 0,children:(l.tools||[]).length>0?e.jsx(B.Group,{style:{width:"100%"},value:T[l.id]||[],onChange:m=>je(l.id,m),children:e.jsx(P,{direction:"vertical",style:{width:"100%"},children:(l.tools||[]).map(m=>e.jsx(B,{value:m.name,children:e.jsxs("div",{children:[e.jsx("div",{children:m.name}),m.description&&e.jsx("div",{style:{color:"rgba(0,0,0,0.45)",fontSize:12},children:m.description})]})},m.name))})}):e.jsx(A,{image:A.PRESENTED_IMAGE_SIMPLE,description:o("role.aiToolsetNoTools",{defaultValue:"No tools available in this toolset."})})},l.id)})}):e.jsx(A,{image:A.PRESENTED_IMAGE_SIMPLE,description:o("role.aiToolsetsEmpty",{defaultValue:"No AI toolsets available for this organization."})}):e.jsx(A,{image:A.PRESENTED_IMAGE_SIMPLE,description:o("role.aiPermissionsGlobalInfo",{defaultValue:"AI tool permissions are only available for organization roles."})})})},{key:"policy",label:o("role.policyDocument",{defaultValue:"Policy Document"}),disabled:y==="organization",children:e.jsx(x.Item,{name:"policy_document",rules:[{validator:_e}],extra:e.jsx("span",{className:u.rolePolicyExtra,children:e.jsx(k,{style:{width:160},placeholder:o("role.insertTemplate",{defaultValue:"Insert Template"}),options:[{label:o("role.allowAll",{defaultValue:"Allow All"}),value:"allow_all"},{label:o("role.denyAll",{defaultValue:"Deny All"}),value:"deny_all"},{label:o("role.allowWithAction",{defaultValue:"Allow with Action"}),value:"allow_with_action"},{label:o("role.denyWithCondition",{defaultValue:"Allow with Condition"}),value:"allow_with_condition"},{label:o("role.allowWithUri",{defaultValue:"Allow with URI"}),value:"allow_with_uri"}],onChange:l=>{if(typeof l=="string"){const t=Be[l];t&&s.setFieldValue("policy_document",JSON.stringify(t,null,2))}}})}),children:e.jsx(le,{rows:15,style:{fontFamily:"monospace"},placeholder:`{
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "account:EnableRegion",
                "account:DisableRegion"
            ],
            "Condition": {
                "StringEquals": {"id:": "abcdef"}
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "*"
            ]
        }
    ]
}`})})}]}),e.jsx(x.Item,{children:e.jsxs(P,{children:[e.jsx(_,{type:"primary",htmlType:"submit",loading:fe,children:p?f("update",{defaultValue:"Update"}):f("create",{defaultValue:"Create"})}),e.jsx(_,{onClick:()=>V("/authorization/roles"),children:f("cancel",{defaultValue:"Cancel"})})]})})]})})},Ze=Object.freeze(Object.defineProperty({__proto__:null,default:Ue},Symbol.toStringTag,{value:"Module"}));export{Ye as R,Ze as a};
