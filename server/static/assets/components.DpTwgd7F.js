var qe=Object.defineProperty;var He=(t,a,s)=>a in t?qe(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s;var ne=(t,a,s)=>He(t,typeof a!="symbol"?a+"":a,s);import{j as e,S as B,N as re,c as V,D as he,d as pe,u as I,A as Oe,r as g,I as Ue,U as We,M as W,l as Xe,e as P,P as Ge,R as Je,f as Ke,L as Ye,g as ge,h as Qe,k as Ze,m as et,T as xe,F as tt,n as st,o as at,p as y,q as _,s as w,t as S,v as H,C as O,w as oe,x as nt,y as rt,z as ot,E as it,G as ie,Q as lt,H as fe,J as ct,K as $,O as dt,V as ut,W as mt,X as ht,Y as pt,Z as U,_ as Z,$ as gt,a0 as ee,a1 as le,a2 as D,a3 as M,a4 as xt,a5 as ft,a6 as ye,a7 as ce,a8 as yt,a9 as jt,aa as vt,ab as bt,ac as St,ad as wt,ae as Ct,af as It,ag as kt,ah as de,ai as Lt,aj as Ft,ak as At,al as Rt,am as ue,an as _t,ao as zt,ap as Pt,aq as G,ar as Tt}from"./vendor.XZpclBr-.js";import{u as je,a as ve,b as $t,c as X,d as Mt}from"./contexts.DfU85HX9.js";import{g as Et,f as Dt,c as Vt}from"./base.BZ5t96GY.js";import{_ as Nt}from"./vite.BF1G3H_w.js";import{a as C,w as be}from"./index.bU_rPqdB.js";import{b as J,A as Bt}from"./client.CQPv28OP.js";const qt=()=>e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",width:"100%"},children:e.jsx(B,{size:"large"})}),vs=({element:t,requiredPermission:a,requiredPermissions:s})=>{const{user:n,loading:r}=je(),{hasPermission:o,hasAllPermissions:m}=ve();return r?e.jsx(qt,{}):n?a&&!o(a)?e.jsx(re,{to:"/forbidden",replace:!0}):s&&!m(s)?e.jsx(re,{to:"/forbidden",replace:!0}):t:(window.location.href=Et("/login?redirect="+encodeURIComponent(window.location.href)),null)},Ht=V(({token:t,css:a})=>({container:a`
      ${a`
        @media screen and (max-width: ${t.screenXS}px) {
          width: 100% !important;
          > * {
            border-radius: 0 !important;
          }
        }
      `}
    > *{
      background-color: ${t.colorBgElevated};
      border-radius: 4px;
      box-shadow: ${t.boxShadowTertiary};
    }
    `,iconStyle:{cursor:"pointer",padding:"12px",display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:18,verticalAlign:"middle","&:hover":{color:t.colorPrimaryTextHover}}})),Se=({overlayClassName:t,overlay:a,hidden:s,children:n,...r})=>{if(s)return e.jsx(e.Fragment,{});const{styles:o}=Ht();return e.jsx(he,{dropdownRender:a,overlayClassName:pe(o.container,t),...r,children:e.jsx("span",{className:o.iconStyle,children:n})})},Ot=()=>e.jsxs("svg",{viewBox:"0 0 24 24",focusable:"false",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true",children:[e.jsx("path",{d:"M0 0h24v24H0z",fill:"none"}),e.jsx("path",{d:"M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z ",className:"css-c4d79v"})]}),Ut=V(()=>({menuItemStyle:{minWidth:"160px"},menuItemIconStyle:{marginRight:"8px"}})),Wt=[{lang:"en-US",label:"English",icon:"ðŸ‡ºðŸ‡¸"},{lang:"sv-SE",label:"Svenska",icon:"ðŸ‡¸ðŸ‡ª"},{lang:"ar-AE",label:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",icon:"ðŸ‡¦ðŸ‡ª"},{lang:"de-DE",label:"Deutsch",icon:"ðŸ‡©ðŸ‡ª"},{lang:"es-ES",label:"EspaÃ±ol",icon:"ðŸ‡ªðŸ‡¸"},{lang:"fr-FR",label:"FranÃ§ais",icon:"ðŸ‡«ðŸ‡·"},{lang:"zh-CN",label:"ä¸­æ–‡",icon:"ðŸ‡¨ðŸ‡³"}],bs=({transformLangConfig:t=a=>a})=>{const{i18n:a}=I(),{styles:s}=Ut(),n=o=>{a.changeLanguage(o)},r={selectedKeys:[a.language],onClick:o=>{n(o.key)},items:t(Wt).map(o=>({key:o.lang,className:s.menuItemStyle,label:e.jsxs(e.Fragment,{children:[e.jsx("span",{role:"img","aria-label":(o==null?void 0:o.label)||"en-US",className:s.menuItemIconStyle,children:(o==null?void 0:o.icon)||"ðŸŒ"}),(o==null?void 0:o.label)||"en-US"]})}))};return e.jsx(Se,{menu:r,children:e.jsx(Ot,{})})},Xt=V(({css:t})=>({avatarItem:t`
    :hover {
      background: rgba(0, 0, 0, 0.12);
    }
    padding: 5px;
  `})),we=t=>Xe.isString(t)&&t.match(/^[-_a-zA-Z0-9]+$/)?J.endsWith("/")?J+`files/${t}`:J+`/files/${t}`:t,Gt=({src:t,...a})=>e.jsx(Oe,{src:we(t),...a}),Jt=({onChange:t,shape:a="square"})=>{const[s,n]=g.useState([]),{styles:r}=Xt(),[o,m]=g.useState(!1),[c,u]=g.useState(!0),[d,j]=g.useState(0),{run:h,loading:p}=P(()=>C.base.listFiles({current:d+1,page_size:40,file_type:"avatar",access:"public",search:""}),{manual:!0,onSuccess:({data:l})=>{n([...s,...l]),u(l.length===40),j(d+1)}}),v=()=>{u(!0),j(0),n([])};return e.jsx(Ge,{style:{zIndex:1e3},onOpenChange:l=>{m(l),l?h():v()},open:o,content:e.jsx("div",{style:{width:360,height:200},children:e.jsx("div",{id:"iconsScrollableDiv",style:{height:"100%",overflow:"auto"},children:e.jsx(Ke,{dataLength:s.length,next:()=>{h()},hasMore:c,loader:e.jsx(Qe,{avatar:!0,paragraph:{rows:1},active:!0}),endMessage:e.jsx(ge,{plain:!0,children:"End"}),scrollableTarget:"iconsScrollableDiv",children:e.jsx(Ye,{grid:{gutter:16,column:8},dataSource:s,style:{margin:"0 8px"},loading:p,renderItem:({id:l})=>e.jsx("div",{className:r.avatarItem,onClick:x=>{x.stopPropagation(),t==null||t(l),m(!1),v()},children:e.jsx(Gt,{shape:a,src:l})})})})})}),placement:"bottom",trigger:"hover",children:e.jsx(Je,{shape:a,style:{width:112,height:112,placeContent:"center"}})})},Kt=({value:t,onChange:a,shape:s,...n})=>{const[r,o]=g.useState(void 0),[m,c]=g.useState(!1),[u,d]=g.useState(void 0),j=async h=>{c(!0),d(h.url??h.preview)};return g.useEffect(()=>{o(t?{uid:t,name:t,url:we(t)}:void 0)},[t]),e.jsxs(e.Fragment,{children:[e.jsx(Ue,{beforeCrop:async h=>{if(h.type==="image/svg+xml"){const p=await C.base.uploadFile({type:"avatar"},h);return p.length>0&&(a==null||a(p[0].id)),!1}return!0},children:e.jsx(We,{customRequest:async h=>{var v,l;const p=await C.base.uploadFile({type:"avatar",access:"public"},h.file);p.length>0?((v=h.onSuccess)==null||v.call(h,p[0].id),a==null||a(p[0].id)):(l=h.onError)==null||l.call(h,new Error("Upload file failed"))},listType:"picture-card",onPreview:j,maxCount:1,onChange:({file:h})=>{switch(h.status){case"removed":a==null||a(void 0);break;case"done":break;default:o(h);break}},fileList:r?[r]:[],...n,children:r?void 0:e.jsx(Jt,{shape:s,onChange:a})})}),e.jsx(W,{open:m,footer:null,onCancel:()=>c(!1),children:e.jsx("img",{style:{width:"100%"},src:u})})]})},Ss=()=>{const{t}=I("common"),{user:a}=je(),{currentOrgId:s,setCurrentOrgId:n}=$t(),r=(a==null?void 0:a.organizations)||[],o=d=>{n(d),window.location.reload()};if(r.length===0)return null;const m=r.find(d=>d.id===s),c=m?m.name:t("organization.global",{defaultValue:"Global"}),u=[...r.map(d=>({key:d.id,label:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:d.name}),s===d.id&&e.jsx(Ze,{})]}),onClick:()=>o(d.id)}))];return e.jsxs(Se,{menu:{items:u,selectedKeys:s?[s]:[""]},children:[e.jsx(et,{style:{marginRight:4}}),e.jsx("span",{style:{height:"1em",lineHeight:"1em",marginLeft:"5px"},children:c})]})},Yt=({onResize:t,minWidth:a=300,maxWidth:s=window.innerWidth*.5})=>{const[n,r]=g.useState(!1),[o,m]=g.useState(!1),c=g.useCallback(j=>{j.preventDefault(),r(!0)},[]),u=g.useCallback(j=>{if(!n)return;const h=window.innerWidth-j.clientX,p=Math.max(a,Math.min(s,h));t(p)},[n,a,s,t]),d=g.useCallback(()=>{r(!1)},[]);return g.useEffect(()=>{if(n)return document.addEventListener("mousemove",u),document.addEventListener("mouseup",d),document.body.style.cursor="col-resize",document.body.style.userSelect="none",()=>{document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",d),document.body.style.cursor="",document.body.style.userSelect=""}},[n,u,d]),e.jsx("div",{onMouseDown:c,onMouseEnter:()=>m(!0),onMouseLeave:()=>m(!1),style:{width:"8px",height:"100vh",cursor:"col-resize",position:"relative",flexShrink:0,transition:n?"none":"background-color 0.2s ease",backgroundColor:n?"#1890ff":o?"#bfbfbf":"#e8e8e8",zIndex:100,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("div",{style:{width:"3px",height:"40px",borderRadius:"2px",backgroundColor:n||o?"#fff":"#999",opacity:n||o?1:.5,transition:"opacity 0.2s ease",pointerEvents:"none"}})})},Ce=g.lazy(()=>Nt(()=>Promise.resolve().then(()=>ms),void 0)),Qt=V(({token:t,css:a})=>({siderLayout:a`
      position: relative;
      height: 100vh;
    `,floatSiderLayout:a`
      position: fixed;
      right: 16px;
      top: 16px;
      height: calc(100vh - 32px);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08);
      z-index: 1000;
      overflow: hidden;
      backdrop-filter: blur(8px);
      border: 1px solid ${t.colorBorderSecondary};
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      
      &:hover {
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15), 0 6px 12px rgba(0, 0, 0, 0.1);
      }
    `})),ws=()=>{const{visible:t,setVisible:a}=X();return e.jsx(W,{width:1200,open:t,closable:!1,onCancel:()=>a(!1),footer:null,children:be(Ce)})},Cs=()=>{const{styles:t}=Qt(),{layout:a}=X(),[s,n]=g.useState(()=>{const o=localStorage.getItem("ai-sidebar-width");return o?parseInt(o,10):400});g.useEffect(()=>{localStorage.setItem("ai-sidebar-width",s.toString())},[s]);const r=o=>{n(o)};return e.jsx(e.Fragment,{children:e.jsxs("div",{style:{width:`${s}px`,display:"flex",overflow:"hidden",flexShrink:0},className:pe("ai-sidebar-layout",a==="float-sidebar"?t.floatSiderLayout:t.siderLayout),children:[e.jsx(Yt,{onResize:r,minWidth:300,maxWidth:window.innerWidth*.5}),e.jsx("div",{style:{width:"100%",height:"100%",backgroundColor:"#ffffff",overflow:"hidden",borderRadius:a==="float-sidebar"?"12px":"0"},children:e.jsx("div",{children:be(Ce)})})]})})},Is=()=>{const{setVisible:t,visible:a}=X(),{t:s}=I("ai");return e.jsx(e.Fragment,{children:e.jsx(xe,{title:s("chat.openAssistant",{defaultValue:"Open AI Assistant"}),placement:"left",style:{display:a?"none":"block"},children:e.jsx(tt,{icon:e.jsx(st,{}),type:"primary",onClick:()=>t(!0),style:{right:24,bottom:24,display:a?"none":"block"}})})})},Zt=at,es=t=>Zt[t],ks=({iconName:t})=>{if(!t)return null;const a=es(t);return a?e.jsx(g.Suspense,{fallback:null,children:e.jsx(a,{})}):null},Ls=({onSuccess:t,token:a})=>{const{t:s}=I("authorization"),{t:n}=I("common"),[r]=y.useForm(),{run:o,loading:m}=P(async c=>C.authorization.changePassword(c,a?{headers:{Authorization:`Bearer ${a}`}}:{}),{manual:!0,onSuccess:()=>{S.success(s("user.passwordChanged")),r.resetFields(),t==null||t()},onError:c=>{if(c instanceof Bt){const u=c.code??"normal";S.error(s(`user.passwordChangeFailed.${u}`,{error:c.message,defaultValue:"Password change failed: {{error}}"}))}else S.error(s("user.passwordChangeFailed.normal",{error:c.message,defaultValue:"Password change failed: {{error}}"}));console.error("Failed to change password:",c)}});return e.jsxs(y,{form:r,layout:"vertical",onFinish:o,style:{maxWidth:500,margin:"0 auto"},children:[e.jsx(y.Item,{name:"old_password",label:s("user.oldPassword"),rules:[{required:!0,message:s("validation.oldPasswordRequired")}],children:e.jsx(_.Password,{})}),e.jsx(y.Item,{name:"new_password",label:s("user.newPassword"),rules:[{required:!0,message:s("validation.newPasswordRequired")},{min:8,message:s("validation.passwordMinLength")}],children:e.jsx(_.Password,{})}),e.jsx(y.Item,{name:"confirm_password",label:s("user.confirmPassword"),rules:[{required:!0,message:s("validation.confirmPasswordRequired")},({getFieldValue:c})=>({validator(u,d){return!d||c("new_password")===d?Promise.resolve():Promise.reject(new Error(s("validation.passwordMismatch")))}})],children:e.jsx(_.Password,{})}),e.jsx(y.Item,{children:e.jsx(w,{type:"primary",htmlType:"submit",loading:m,children:n("save")})})]})},Fs=({user:t,onSuccess:a})=>{const{t:s}=I("authorization"),{t:n}=I("common"),[r]=y.useForm(),[o,m]=g.useState(!1);H.useEffect(()=>{t&&r.setFieldsValue({username:t.username,email:t.email,full_name:t.full_name,phone:t.phone||"",avatar:t.avatar})},[t,r]);const c=async u=>{try{m(!0),await C.authorization.updateCurrentUser(u),S.success(n("updateSuccess")),a()}catch(d){S.error(n("updateFailed")),console.error("Failed to update user information:",d)}finally{m(!1)}};return e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs("div",{style:{marginBottom:24,textAlign:"center"},children:[e.jsx("h2",{children:(t==null?void 0:t.full_name)||(t==null?void 0:t.username)}),(t==null?void 0:t.roles)&&t.roles.length>0&&e.jsxs("div",{children:[s("user.roles"),": ",t.roles.map(u=>u.name).join(", ")]})]}),e.jsxs(y,{form:r,layout:"vertical",onFinish:c,style:{width:"100%",maxWidth:500},children:[e.jsx(y.Item,{style:{marginBottom:24,textAlign:"center",justifyItems:"center"},name:"avatar",children:e.jsx(Kt,{})}),e.jsx(y.Item,{name:"username",label:s("user.username"),children:e.jsx(_,{disabled:!0})}),e.jsx(y.Item,{name:"email",label:s("user.email"),rules:[{required:!0,message:s("validation.emailRequired")},{type:"email",message:s("validation.emailInvalid")}],children:e.jsx(_,{})}),e.jsx(y.Item,{name:"full_name",label:s("user.fullName"),rules:[{required:!0,message:s("validation.fullNameRequired")}],children:e.jsx(_,{})}),e.jsx(y.Item,{name:"phone",label:s("user.phone"),children:e.jsx(_,{})}),e.jsx(y.Item,{children:e.jsx(w,{type:"primary",htmlType:"submit",loading:o,children:n("save")})})]})]})},As=({user:t,onSuccess:a})=>{const{t:s}=I("authorization"),{t:n}=I("common"),[r,o]=g.useState(0),[m,c]=g.useState(!1),[u,d]=g.useState(!0),[j,h]=g.useState(""),[p,v]=g.useState("totp"),{run:l,data:x={secret:"",qr_code:"",token:void 0}}=P(()=>C.authorization.enableMfa(p),{manual:!0,onSuccess:()=>{o(1)},onBefore:()=>{c(!0)},onFinally:()=>{c(!1)}}),F=async()=>{if(!j){S.warning(s("mfa.enterVerificationCode"));return}const k={code:j,mfa_type:p};"token"in x&&(k.token=x.token);try{c(!0),await C.authorization.verifyAndActivateMfa(k),S.success(s("mfa.enableSuccess")),o(2),a()}catch(R){S.error(s("mfa.verificationFailed")),console.error("Failed to verify MFA:",R)}finally{c(!1)}},f=async()=>{try{c(!0),await C.authorization.disableMfa(),S.success(s("mfa.disableSuccess")),a()}catch(k){S.error(n("operationFailed")),console.error("Failed to disable MFA:",k)}finally{c(!1)}},A=()=>{if(!t)return null;if(t.mfa_enabled)return e.jsx(oe,{status:"success",title:s("mfa.enabled"),subTitle:s("mfa.enabledDescription"),extra:e.jsx(w,{danger:!0,onClick:()=>{W.confirm({title:s("mfa.confirmDisable"),content:s("mfa.disableWarning"),onOk:f,okButtonProps:{danger:!0}})},children:s("mfa.disable")})});const k=()=>{var R;switch(r){case 0:return e.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsx(ie,{message:e.jsxs("div",{children:[e.jsx("p",{children:s("mfa.setupInfo")}),e.jsx("p",{children:s(p==="totp"?"mfa.totpDescription":"mfa.emailDescription")})]}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsx(w,{type:"primary",onClick:l,loading:m,children:s("mfa.startSetup")})]});case 1:return e.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsx(ie,{message:s("mfa.scanQrCode"),type:"info",showIcon:!0,style:{marginBottom:20,display:p==="totp"?"block":"none"}}),e.jsx("div",{style:{display:p==="totp"?"flex":"none",justifyContent:"center",marginBottom:24},children:e.jsx(lt,{value:x.qr_code??"",size:200})}),e.jsx("div",{style:{marginBottom:16,display:p==="email"?"block":"none"},children:e.jsxs("p",{children:[s("user.email"),": ",e.jsx("strong",{children:t==null?void 0:t.email})]})}),e.jsx("div",{style:{marginBottom:16,display:p==="totp"?"block":"none"},children:e.jsxs("p",{children:[s("mfa.secretKey"),": ",e.jsx("strong",{children:u?"*".repeat(((R=x.secret)==null?void 0:R.length)??0):x.secret}),e.jsx(w,{type:"link",onClick:()=>d(!u),icon:u?e.jsx(fe,{}):e.jsx(ct,{})})]})}),e.jsx("div",{style:{marginBottom:24},children:e.jsx(_,{placeholder:s("mfa.enterCode"),style:{width:200},maxLength:6,value:j,onChange:z=>h(z.target.value)})}),e.jsxs($,{children:[e.jsx(w,{onClick:()=>o(0),children:n("previous")}),e.jsx(w,{type:"primary",onClick:F,loading:m,children:n("verify")})]})]});case 2:return e.jsx(oe,{status:"success",title:s("mfa.setupSuccess"),subTitle:s("mfa.setupSuccessDescription"),extra:e.jsx(w,{type:"primary",onClick:()=>o(0),children:n("done")})});default:return null}};return e.jsxs("div",{children:[e.jsxs("div",{style:{display:r===2?"none":"unset"},children:[e.jsx(nt,{defaultValue:"totp",onChange:R=>{v(R),o(0)},value:p,options:[{value:"totp",icon:e.jsx(rt,{}),label:s("mfa.totp",{defaultValue:"TOTP"})},{value:"email",icon:e.jsx(ot,{}),label:s("mfa.email",{defaultValue:"E-Mail"})}]}),e.jsx(ge,{})]}),e.jsx(it,{current:r,items:[{title:s(p==="totp"?"mfa.totpStep1":"mfa.emailStep1"),description:s(p==="totp"?"mfa.totpStep1Description":"mfa.emailStep1Description")},{title:s(p==="totp"?"mfa.totpStep2":"mfa.emailStep2"),description:s(p==="totp"?"mfa.totpStep2Description":"mfa.emailStep2Description")},{title:s(p==="totp"?"mfa.totpStep3":"mfa.emailStep3"),description:s(p==="totp"?"mfa.totpStep3Description":"mfa.emailStep3Description")}],style:{marginBottom:30}}),k()]})};return e.jsx(O,{title:s("mfa.title"),children:A()})},{Text:K}=ut,Rs=()=>{const{t}=I("authorization"),{t:a}=I("common"),[s,n]=g.useState([]),[r,o]=g.useState(!1),[m,c]=g.useState(null),[u,d]=g.useState(!1),j=async()=>{try{o(!0);const l=await C.authorization.getUserSessions({});n(l)}catch(l){S.error(t("session.getSessionsFailed",{error:l,defaultValue:"Failed to get session list: {{error}}"}))}finally{o(!1)}};g.useEffect(()=>{j()},[]);const h=async l=>{try{c(l),await C.authorization.terminateSession({id:l}),n(s.filter(x=>x.id!==l)),S.success(t("session.terminateSuccess",{defaultValue:"Session terminated successfully"}))}catch(x){S.error(t("session.terminateFailed",{error:x,defaultValue:"Failed to terminate session: {{error}}"}))}finally{c(null)}},p=async()=>{try{d(!0),await C.authorization.terminateOtherSessions(),n(s.filter(l=>l.is_current)),S.success(t("session.terminateAllSuccess",{defaultValue:"All other sessions terminated successfully"}))}catch(l){S.error(t("session.terminateAllFailed",{error:l,defaultValue:"Failed to terminate all other sessions: {{error}}"}))}finally{d(!1)}},v=[{title:t("session.device"),dataIndex:"user_agent",key:"device",render:(l,x)=>e.jsxs($,{direction:"vertical",size:0,children:[e.jsxs($,{children:[e.jsx(dt,{}),e.jsx(K,{strong:!0,children:l})]}),e.jsxs($,{children:[e.jsx(mt,{}),e.jsx(K,{type:"secondary",children:x.location})]})]})},{title:t("session.ipAddress"),dataIndex:"ip_address",key:"ip_address",render:l=>e.jsxs($,{children:[e.jsx(ht,{}),e.jsx("span",{children:l})]})},{title:t("session.lastActive"),dataIndex:"last_active_at",key:"last_active",render:l=>e.jsxs($,{children:[e.jsx(pt,{}),e.jsx("span",{children:new Date(l).toLocaleString()})]})},{title:t("session.status"),key:"status",render:l=>l.is_current?e.jsx(U,{color:"green",children:t("session.current")}):e.jsx(U,{color:"blue",children:t("session.active")})},{title:a("actions"),key:"action",render:l=>l.is_current?e.jsx(K,{type:"secondary",children:t("session.currentSession")}):e.jsx(Z,{title:t("session.confirmTerminate"),onConfirm:()=>h(l.id),okText:a("confirm"),cancelText:a("cancel"),children:e.jsx(w,{type:"link",danger:!0,loading:m===l.id,children:t("session.terminate")})})}];return e.jsx(O,{title:t("session.title"),extra:s.length>1&&e.jsx(Z,{title:t("session.confirmTerminateAll"),onConfirm:p,okText:a("confirm"),cancelText:a("cancel"),children:e.jsx(w,{danger:!0,loading:u,children:t("session.terminateOthers")})}),children:s.length===0?e.jsx(gt,{description:t("session.noSessions")}):e.jsx(ee,{columns:v,dataSource:s,rowKey:"id",loading:r,pagination:!1})})},{RangePicker:ts}=xt,{Option:E}=M,ss=t=>t||"N/A",as=(t,a)=>t==="success"?e.jsx(U,{color:"success",children:a("statuses.success")}):e.jsx(U,{color:"error",children:a("statuses.failed")}),_s=({userId:t,request:a=n=>t?C.authorization.getUserLogs({id:t,...n}):C.authorization.getCurrentUserLogs(n),columnsFilter:s=n=>n})=>{const{t:n}=I("authorization"),{t:r}=I("common"),[o,m]=g.useState({current:1,pageSize:10,total:0}),[c,u]=g.useState({}),[d]=y.useForm(),{loading:j,run:h,data:{data:p}={}}=P(async(f=c,A=1,k=10)=>a({...f,current:A??1,page_size:k??10}),{onError(f){S.error(n("auditLog.fetchFailed",{error:f}))},onSuccess({total:f}){m({...o,total:f})}});g.useEffect(()=>{h(c,1,o.pageSize)},[]);const v=f=>{m({...o,current:f.current,pageSize:f.pageSize}),h({},f.current,f.pageSize)},l=f=>{var A,k,R,z;h({...f,start_time:(k=(A=f.dateRange)==null?void 0:A[0])==null?void 0:k.toISOString(),end_time:(z=(R=f.dateRange)==null?void 0:R[1])==null?void 0:z.toISOString()},1,o.pageSize)},x=()=>{d.resetFields(),u({}),m({...o,current:1}),h({},1,o.pageSize)},F=[{title:n("auditLog.timestamp"),dataIndex:"timestamp",key:"timestamp",render:f=>Dt(f)},{title:n("auditLog.action"),dataIndex:"action",key:"action",render:(f,A)=>f?n(`action.${f.replace(":",".")}`,{defaultValue:A.action_name}):A.action_name??A.action},{title:n("auditLog.user_agent"),dataIndex:"user_agent",key:"user_agent"},{title:n("auditLog.ip"),dataIndex:"ip",key:"ip",render:f=>ss(f)},{title:n("auditLog.status"),dataIndex:"status",key:"status",render:f=>as(f,n)},{title:n("auditLog.details"),dataIndex:"details",key:"details",render:f=>e.jsx(w,{type:"link",icon:e.jsx(fe,{}),onClick:()=>{W.info({title:n("auditLog.details"),content:JSON.stringify(f)})}})}];return e.jsxs("div",{children:[e.jsx(O,{style:{marginBottom:16},children:e.jsxs(y,{form:d,layout:"horizontal",onFinish:l,initialValues:c,children:[e.jsxs(le,{gutter:24,children:[e.jsx(D,{span:6,children:e.jsx(y.Item,{name:"search",label:n("auditLog.search"),children:e.jsx(_,{placeholder:n("auditLog.searchPlaceholder")})})}),e.jsx(D,{span:6,children:e.jsx(y.Item,{name:"action",label:n("auditLog.action"),children:e.jsxs(M,{allowClear:!0,placeholder:n("auditLog.selectAction"),children:[e.jsx(E,{value:"login",children:n("actions.login")}),e.jsx(E,{value:"logout",children:n("actions.logout")}),e.jsx(E,{value:"password_reset",children:n("actions.passwordReset")}),e.jsx(E,{value:"mfa_change",children:n("actions.mfaChange")})]})})}),e.jsx(D,{span:6,children:e.jsx(y.Item,{name:"status",label:n("auditLog.status"),children:e.jsxs(M,{allowClear:!0,placeholder:n("auditLog.selectStatus"),children:[e.jsx(E,{value:"success",children:n("statuses.success")}),e.jsx(E,{value:"failed",children:n("statuses.failed")})]})})}),e.jsx(D,{span:6,children:e.jsx(y.Item,{name:"dateRange",label:n("auditLog.dateRange"),children:e.jsx(ts,{style:{width:"100%"}})})})]}),e.jsx(le,{children:e.jsx(D,{span:24,style:{textAlign:"right"},children:e.jsxs($,{children:[e.jsx(w,{onClick:x,children:r("reset")}),e.jsx(w,{type:"primary",htmlType:"submit",icon:e.jsx(ft,{}),children:r("search")})]})})})]})}),e.jsxs(O,{children:[e.jsx("div",{style:{marginBottom:16},children:e.jsx(w,{type:"primary",icon:e.jsx(ye,{}),onClick:x,style:{marginRight:8},children:r("refresh")})}),e.jsx(ee,{rowKey:"id",columns:s(F),dataSource:p,pagination:{...o,showSizeChanger:!0,showTotal:f=>r("totalItems",{total:f})},loading:j,onChange:v,scroll:{x:"max-content"}})]})]})},ns=({permission:t,permissions:a=[],checkAll:s=!1,fallback:n=null,children:r})=>{const{hasPermission:o,hasAnyPermission:m,hasAllPermissions:c,isAdmin:u,loading:d}=ve();return d?null:u?e.jsx(e.Fragment,{children:r}):t?o(t)?e.jsx(e.Fragment,{children:r}):e.jsx(e.Fragment,{children:n}):a.length>0?(s?c(a):m(a))?e.jsx(e.Fragment,{children:r}):e.jsx(e.Fragment,{children:n}):e.jsx(e.Fragment,{children:r})},q=t=>{const[a,s]=g.useState(!1),{permission:n,icon:r,tooltip:o,onClick:m,confirm:c,label:u,...d}=t;if(n)return e.jsx(ns,{permission:n,children:q({icon:r,tooltip:o,onClick:m,confirm:c,label:u,...d})},t.key);if(c)return e.jsx(Z,{title:c.title,onConfirm:c.onConfirm||m,okText:c.okText,cancelText:c.cancelText,children:q({icon:r,tooltip:o,label:u,...d})},t.key);if(o)return e.jsx(xe,{title:o,children:q({icon:r,onClick:m,label:u,...d})},t.key);const j=m?async()=>{console.log(new Date,"handleClick"),s(!0);try{await m()}finally{s(!1),console.log(new Date,"handleClick1")}}:void 0;return g.createElement(w,{type:"text",size:"small",loading:a,icon:r,onClick:j,...d,key:t.key},u&&e.jsx("span",{style:{position:"inherit",top:"-2px"},children:u}))},zs=({actions:t})=>t.filter(a=>!a.hidden).map(a=>q(a)),rs=({request:t,tableRef:a,...s},n)=>{const[r,o]=g.useState({current:1,pageSize:10}),[m,c]=g.useState(0),{data:u,loading:d,refresh:j}=P(async()=>{const h=await t({current:r.current,page_size:r.pageSize});return c(h.total),h.data},{refreshDeps:[r]});return g.useImperativeHandle(n,()=>({reload:()=>{j()}})),e.jsx(ee,{rowKey:"id",loading:d,dataSource:u??[],pagination:{...r,total:m,onChange:(h,p)=>{o({current:h,pageSize:p})}},...s,ref:a})},Ps=({actionRef:t,...a})=>{const[s,n]=g.useState();return g.useEffect(()=>{n(g.forwardRef(rs))},[]),s?e.jsx(s,{...a,ref:t}):null},{TextArea:me}=_,{Option:Y}=M,Ts=({field:t,selectedType:a,dependentValues:s,formValues:n={}})=>{const{t:r}=I("system"),{t:o}=I("common"),m=g.useMemo(()=>Vt(t.visible_when,n),[t.visible_when,n]),{options:c,loading:u}=Mt(t.data_source,t.options,s),d=g.useMemo(()=>t.data_source&&t.data_source.type!=="static"?c:t.options||[],[t.data_source,t.options,c]),j=d&&d.length>0;if(!m)return null;const h=[{required:t.required,message:r("settings.toolsets.fieldRequired",{defaultValue:`Please enter ${t.name}`,field:t.name})}],p=()=>r(`settings.toolsets.${a}.${t.name}`,{defaultValue:t.display_name||t.name}),v=()=>r(`settings.toolsets.${a}.${t.name}Placeholder`,{defaultValue:t.placeholder||`${o("enter",{defaultValue:"Enter"})} ${t.name}`}),l=()=>{if(t.description)return r(`settings.toolsets.${a}.${t.name}Tooltip`,{defaultValue:t.description})};if(!m)return null;if(t.type==="select"||t.data_source)return e.jsx(y.Item,{name:["config",t.name],label:p(),rules:h,tooltip:l(),children:e.jsx(M,{loading:u,allowClear:!0,placeholder:v(),showSearch:!0,filterOption:(x,F)=>{var f;return(f=F==null?void 0:F.children)==null?void 0:f.toLowerCase().includes(x.toLowerCase())},children:d.map(x=>e.jsx(Y,{value:x.value,children:x.label},x.value))})},t.name);switch(t.type){case"text":return e.jsx(y.Item,{name:["config",t.name],label:p(),rules:h,children:e.jsx(me,{placeholder:v(),rows:4})},t.name);case"string":return j?e.jsx(y.Item,{name:["config",t.name],label:p(),rules:h,tooltip:l(),children:e.jsx(M,{allowClear:!0,placeholder:v(),children:d.map(x=>e.jsx(Y,{value:x.value,children:x.label},x.value))})},t.name):e.jsx(y.Item,{name:["config",t.name],label:p(),rules:h,tooltip:l(),children:e.jsx(_,{placeholder:v()})},t.name);case"password":return e.jsx(y.Item,{name:["config",t.name],label:p(),rules:h,tooltip:l(),children:e.jsx(_.Password,{placeholder:v(),autoComplete:"new-password"})},t.name);case"number":return j?e.jsx(y.Item,{name:["config",t.name],label:p(),rules:h,tooltip:l(),children:e.jsx(M,{allowClear:!0,placeholder:v(),children:d.map(x=>e.jsx(Y,{value:x.value,children:x.label},x.value))})},t.name):e.jsx(y.Item,{name:["config",t.name],label:p(),rules:h,tooltip:l(),children:e.jsx(jt,{style:{width:"100%"},placeholder:v()})},t.name);case"boolean":return e.jsx(y.Item,{name:["config",t.name],label:p(),valuePropName:"checked",tooltip:l(),children:e.jsx(yt,{})},t.name);case"array":return j?e.jsx(y.Item,{name:["config",t.name],label:p(),rules:h,tooltip:l(),children:e.jsx(ce.Group,{style:{width:"100%"},children:e.jsx($,{direction:"vertical",children:d.map(x=>e.jsx(ce,{value:x.value,children:x.label},x.value))})})},t.name):e.jsx(y.Item,{name:["config",t.name],label:p(),rules:h,tooltip:l(),children:e.jsx(M,{mode:"tags",style:{width:"100%"},placeholder:v(),tokenSeparators:[","]})},t.name);case"object":return e.jsx(y.Item,{name:["config",t.name],label:p(),rules:[...h,{validator:(x,F)=>{if(!F)return Promise.resolve();try{return JSON.parse(F),Promise.resolve()}catch{return Promise.reject(new Error(r("settings.toolsets.invalidJSON",{defaultValue:"Invalid JSON format"})))}}}],tooltip:l(),children:e.jsx(me,{rows:4,placeholder:v()})},t.name);default:return null}},os=V(({token:t,css:a})=>({siderLayout:a`
      width: 100%;
      height: calc(100vh - 100px);
      display: flex;
      background: ${t.colorBgContainer};
      font-family: AlibabaPuHuiTi, ${t.fontFamily}, sans-serif;
    `,classicLayout:a`
      width: 100%;
      height: 70vh;
      display: flex;
      background: ${t.colorBgContainer};
      font-family: AlibabaPuHuiTi, ${t.fontFamily}, sans-serif;
    `,sider:a`
      background: ${t.colorBgLayout}80;
      width: 280px;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 0 12px;
      box-sizing: border-box;
    `,logo:a`
      display: flex;
      align-items: center;
      justify-content: start;
      padding: 0 24px;
      box-sizing: border-box;
      gap: 8px;
      margin: 24px 0;

      span {
        font-weight: bold;
        color: ${t.colorText};
        font-size: 16px;
      }
    `,addBtn:a`
      background: #1677ff0f;
      border: 1px solid #1677ff34;
      height: 40px;
    `,conversationsSpin:a`
      height: 100%;
      overflow-y: auto;
    `,conversations:a`
      flex: 1;
      overflow-y: auto;
      margin-top: 12px;
      padding: 0;

      .ant-conversations-list {
        padding-inline-start: 0;
      }
    `,siderFooter:a`
      border-top: 1px solid ${t.colorBorderSecondary};
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    `,chat:a`
      height: 100%;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      padding-block: ${t.paddingLG}px;
      gap: 16px;
    `,chatPrompt:a`
      .ant-prompts-label {
        color: #000000e0 !important;
      }
      .ant-prompts-desc {
        color: #000000a6 !important;
        width: 100%;
      }
      .ant-prompts-icon {
        color: #000000a6 !important;
      }
    `,chatList:a`
      flex: 1;
      overflow: auto;
      .ant-spin-nested-loading{
        height: 100%;
        .ant-spin-container{
          height: 100%;
        }
      }
    `,loadingMessage:a`
      background-image: linear-gradient(90deg, #ff6b23 0%, #af3cb8 31%, #53b6ff 89%);
      background-size: 100% 2px;
      background-repeat: no-repeat;
      background-position: bottom;
    `,placeholder:a`
      padding-top: 32px;
    `,sender:a`
      width: 100%;
      max-width: min(90%, 700px);
      margin: 0 auto;
    `,speechButton:a`
      font-size: 18px;
      color: ${t.colorText} !important;
    `,senderPrompt:a`
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      color: ${t.colorText};
    `}));class is extends Error{constructor(s,n){super(s);ne(this,"buffer");this.buffer=n}}class ls extends Tt{transformParams(a,s){if(typeof a!="object")throw new Error("requestParams must be an object");return{...(s==null?void 0:s.params)||{},...a||{}}}transformLocalMessage({content:a}){return{content:a,role:"user"}}transformMessage(a){const{originMessage:s,chunk:n}=a||{};if(!n)return{content:(s==null?void 0:s.content)||"",role:"assistant"};const r=JSON.parse(n.data);return console.log(r),{content:`${(s==null?void 0:s.content)||""||""}${r.content||""}`,role:"assistant"}}}const Q=new Map,cs=t=>(console.log(t),Q.get(t)||Q.set(t,new ls({request:Pt(`/api/ai/chat/sessions/${t}`,{manual:!0,middlewares:{onRequest:async(a,s)=>{const n=localStorage.getItem("orgID"),{sessionId:r}=s.params,o={...s.headers,"Accept-Language":localStorage.getItem("i18nextLng")||"en-US",Authorization:`Bearer ${localStorage.getItem("token")}`,...n?{"X-Scope-OrgID":n}:{}};return[r?`/api/ai/chat/sessions/${r}`:a,{...s,headers:o}]}}})})),Q.get(t)),Ie=()=>{const t=vt.useToken(),a=H.useMemo(()=>{var n;return((n=t==null?void 0:t.theme)==null?void 0:n.id)===0},[t]);return[H.useMemo(()=>a?"x-markdown-light":"x-markdown-dark",[a])]},ds=H.createContext({}),us=()=>{const{layout:t,setVisible:a,setLayout:s,onCallAI:n}=X(),{t:r}=I("ai"),{t:o}=I("common"),{styles:m}=os(),{conversations:c,activeConversationKey:u,setActiveConversationKey:d,addConversation:j,setConversations:h,getConversation:p,setConversation:v,removeConversation:l,getMessages:x}=bt({}),[F]=Ie(),[f,A]=S.useMessage(),[k,R]=g.useState(""),[z,te]=g.useState(),{onRequest:se,messages:T,isRequesting:ke,abort:Le,onReload:Fe,setMessages:Ae,setMessage:Re}=St({provider:cs(u),conversationKey:u,defaultMessages:[],requestPlaceholder:()=>({content:o("loading"),role:"assistant"}),requestFallback:(i,{messageInfo:b,error:L})=>(console.log(b,L),L instanceof is?{content:L.buffer.join(""),role:"assistant",error:L.message}:{content:`${L}`,role:"assistant"})}),_e=i=>{if(i){if(!u){N(i);return}se({content:i})}},ae=i=>({key:i.id,label:i.title,group:G(i.start_time).isSame(G(),"day")?r("chat.today"):G(i.start_time).format("YYYY-MM-DD")}),{loading:ze}=P(async()=>{const i=await C.ai.listChatSessions({current:1,page_size:20});h(i.data.map(ae)),i.data.length>0&&d(i.data[0].id)},{onError:()=>{S.error(r("chat.fetchConversationsFailed",{defaultValue:"Failed to fetch conversations"}))}}),{run:Pe,loading:Te}=P(async i=>await C.ai.getChatSession({sessionId:i}),{manual:!0,onError:()=>{S.error(r("chat.fetchConversationFailed",{defaultValue:"Failed to fetch conversation"}))},onSuccess:i=>{T&&T.length>0&&(T[T.length-1].status==="loading"||T.length>i.messages.length)||Ae(i.messages.filter(b=>b.role!=="tool").map(b=>({id:b.id,message:{content:b.content,role:b.role},status:"success"})))}}),{run:N,loading:$e}=P(async(i,b)=>await C.ai.createChatSession({title:r("chat.defaultConversationTitle"),model_id:"",messages:b||[]}),{manual:!0,onError:()=>{S.error(r("chat.createConversationFailed",{defaultValue:"Failed to create conversation"}))},onSuccess:(i,[b])=>{j(ae(i),"prepend"),b&&te({message:b,sessionId:i.id}),d(i.id)}}),{run:Me}=P(async i=>await C.ai.deleteChatSession({sessionId:i}),{manual:!0,onError(i,[b]){f.error(r("chat.deleteConversationFailed",{defaultValue:"Failed to delete conversation"}));const L=p(b);L&&v(b,{...L,loading:!1})},onSuccess(i,[b]){l(b)}}),{run:Ee}=P(async i=>C.ai.generateChatSessionTitle({sessionId:i},{title:""}),{manual:!0,onSuccess:({title:i},[b])=>{const L=p(b);L&&v(b,{...L,title:i,loading:!1})},onError:(i,[b])=>{f.error(r("chat.titleGenerationFailed",{defaultValue:"Failed to generate title"})),console.log(i);const L=p(b);L&&v(b,{...L,loading:!1})}});g.useEffect(()=>{console.log(u,z),u&&(z==null?void 0:z.sessionId)===u&&(se({content:z.message}),te(void 0))},[u,z]),g.useEffect(()=>{if(u){const i=x(u);if(i&&i.length>0)return;Pe(u)}},[u]),g.useEffect(()=>{n((i,b)=>{N(i,b)})},[N]);const De=e.jsxs("div",{className:m.sider,children:[e.jsx(w,{onClick:()=>{N()},type:"link",className:m.addBtn,icon:e.jsx(wt,{}),loading:$e,children:r("chat.newConversation",{defaultValue:"New Conversation"})}),e.jsx(B,{spinning:ze,wrapperClassName:m.conversationsSpin,children:e.jsx(Ct,{items:c,activeKey:u,onActiveChange:async i=>{i&&d(i)},className:m.conversations,groupable:!0,styles:{item:{padding:"0 8px"}},menu:i=>({items:[{label:r("chat.regenerateTitle"),key:"regenerateTitle",icon:e.jsx(ye,{}),onClick:()=>{v(i.key,{...i,loading:!0}),Ee(i.key)}},{label:o("delete"),key:"delete",icon:e.jsx(It,{}),danger:!0,onClick:()=>{v(i.key,{...i,loading:!0}),Me(i.key)}}]})})})]}),Ve=({message:i})=>{if(i.error)return e.jsx("div",{children:e.jsx(de,{content:i.error})})};console.log(T);const Ne=e.jsx("div",{className:m.chatList,children:e.jsx(B,{spinning:Te,children:e.jsx(kt.List,{items:T==null?void 0:T.map(i=>({...i.message,key:i.id,messageRender:b=>e.jsx(de,{paragraphTag:"div",content:b,className:F}),footer:Ve(i)})),style:{height:"100%",paddingInline:t==="classic"?"calc(calc(100% - 700px) /2)":"20px"},roles:{assistant:{placement:"start",loadingRender:()=>e.jsx(B,{size:"small"})},user:{placement:"end"}}})})}),Be=e.jsx(e.Fragment,{children:e.jsx(Lt,{value:k,onSubmit:async()=>{_e(k.trim()),R("")},onChange:R,onCancel:()=>{Le()},loading:ke,className:m.sender,placeholder:r("chat.inputPlaceholder")})});return e.jsx(Ft,{children:e.jsxs(ds.Provider,{value:{onReload:Fe,setMessage:Re},children:[A,e.jsxs("div",{style:{height:"50px",width:"100%",position:"relative"},children:[e.jsx(At.Group,{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)"},options:[{label:e.jsx(Rt,{}),value:"classic"},{label:e.jsx(ue,{}),value:"sidebar"},{label:e.jsx(ue,{}),value:"float-sidebar"}],optionType:"button",onChange:i=>s(i.target.value),value:t}),e.jsxs($,{style:{float:"right",marginTop:10},children:[e.jsx(he,{menu:{items:c.map(i=>({label:i.label,key:i.key})),onClick:({key:i})=>{d(i)}},placement:"bottomRight",children:e.jsx(w,{icon:e.jsx(_t,{}),style:{display:t==="classic"?"none":"block"}})}),e.jsx(w,{type:"text",onClick:()=>a(!1),children:e.jsx(zt,{})})]})]}),e.jsxs("div",{className:t==="classic"?m.classicLayout:m.siderLayout,style:{minWidth:t==="classic"?"500px":"400px"},children:[t==="classic"?De:null,e.jsxs("div",{className:m.chat,children:[Ne,Be]})]})]})})},ms=Object.freeze(Object.defineProperty({__proto__:null,default:us,useMarkdownTheme:Ie},Symbol.toStringTag,{value:"Module"}));export{Gt as A,ks as D,Se as H,qt as L,Ss as O,vs as P,Ps as T,_s as U,bs as a,Is as b,ws as c,Cs as d,Ls as e,Fs as f,As as g,Rs as h,ns as i,Wt as j,zs as k,Ts as l,Kt as m};
