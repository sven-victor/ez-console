import{ac as Q,al as X,aI as Z,u as ee,r as o,F as d,j as e,C as te,T as ae,x as R,m as g,aJ as se,af as ne,aK as oe,n as C,g as re,E as ie,A as le,s as de,aL as ce}from"./vendor.JHmizRYD.js";import{u as ue}from"./contexts.BmmqIIgB.js";import{x as fe,A as O,y as me,w as ge,z as he}from"./base.C-POyhJq.js";import{L as pe,a as xe,b as we}from"./components.CNDiCsnG.js";import"./vite.BF1G3H_w.js";const{Title:je}=ae,Ve=()=>{const m=Q(),B=X(),[i]=Z(),{login:b,oauthLogin:S,user:L}=ue(),{t:s,i18n:x}=ee(),[V,l]=o.useState(null),[w,I]=o.useState({}),[c,h]=o.useState("login"),[$,q]=o.useState(null),[j,M]=o.useState(null),[u,U]=o.useState(null),[p]=d.useForm(),A=o.useRef(!1),[D,k]=o.useState(!1),[T,N]=o.useState([]),[y,_]=o.useState(0),[z,E]=o.useState("Loading..."),[n,J]=o.useState(null),F=async a=>{const r=async t=>"username"in t?await b({username:t.username,password:t.password}):"mfa_token"in t?await b({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await S({code:t.code,state:t.state,provider:t.provider});try{k(!0);const t=await r(a);if(await new Promise(f=>setTimeout(f,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&B.pathname!=="/profile")m("/profile#mfa");else{const f=i.get("redirect");f?window.location.href=f:n!=null&&n.home_page?window.location.href=n.home_page:m("/")}}catch(t){if(t.password_expired)h("password_expired"),q(t.token),l(null);else if(t.needsMFA)l(null),h("mfa"),m("/login",{replace:!0}),M(t.mfaType),U(t.user),p.setFieldValue("mfa_token",t.mfaToken);else if("username"in a||"mfa_token"in a)if(t instanceof O?l(s("login.error",{defaultValue:"Login failed: {{error}}",error:s(`login.${t}`,{defaultValue:t.message})})):l(typeof t=="string"?t:s("login.error",{defaultValue:"Login failed"})),"mfa_token"in a){_(30);const f=setInterval(()=>{_(v=>v>=1?v-1:0)},1e3);setTimeout(()=>{clearInterval(f),_(0)},3e4)}else"username"in a&&h("login");else t instanceof O?l(s("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:s(`login.${t.code}`,{defaultValue:t.message})})):l(typeof t=="string"?t:s("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),m("/login",{replace:!0}),P()}finally{k(!1)}},P=async()=>{N(await me()||[])};o.useEffect(()=>{if(!A.current){A.current=!0;const a=i.get("code"),r=i.get("state"),t=i.get("provider");a&&r&&t?F({code:a,state:r,provider:t}):P()}},[i,S]),o.useEffect(()=>{x.language&&E((n==null?void 0:n.name_i18n[x.language])||(n==null?void 0:n.name)||"")},[n,x.language]);const K=async a=>{try{I({...w,[a]:!0});const{url:r}=await he(a);window.location.href=r}catch(r){de.error(s("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",r)}finally{I({...w,[a]:!1})}},W=a=>{switch(a.toLowerCase()){case"github":return e.jsx(ce,{});default:return null}},Y=i.get("code"),G=i.get("state"),H=i.get("provider");if(o.useEffect(()=>{(async()=>{var t;const r=await ge();E(r.name),J(r),window.document.title=r.name,(t=document.getElementById("site-icon"))==null||t.setAttribute("href",r.logo)})()},[]),Y&&G&&H||!n)return e.jsx(pe,{});if(L&&L.status==="active"){const a=i.get("redirect");a?window.location.href=a:n!=null&&n.home_page?window.location.href=n.home_page:m("/")}return e.jsxs("div",{children:[e.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsx(xe,{})}),e.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxs(te,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsx(je,{level:2,children:z}),e.jsx("p",{children:s("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),V&&e.jsx(R,{message:V,type:"error",showIcon:!0,style:{marginBottom:20}}),j&&e.jsx(R,{message:s(`login.mfaTips.${j}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxs(d,{name:"login",initialValues:{remember:!0},onFinish:F,size:"large",form:p,hidden:c==="password_expired",children:[c==="mfa"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{hidden:!(u!=null&&u.email)||j!=="email",children:e.jsx(g,{value:fe(u==null?void 0:u.email)})}),e.jsx(d.Item,{name:"mfa_token",hidden:!0,children:e.jsx(g,{})}),e.jsx(d.Item,{name:"mfa_code",hidden:c!=="mfa",children:e.jsx(g,{placeholder:s("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsx(se,{})})})]}),c==="login"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{name:"username",rules:[{required:!0,message:s("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsx(g,{prefix:e.jsx(ne,{}),placeholder:s("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsx(d.Item,{name:"password",rules:[{required:!0,message:s("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsx(g.Password,{prefix:e.jsx(oe,{}),placeholder:s("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsx(d.Item,{children:e.jsx(C,{disabled:y>0,type:"primary",htmlType:"submit",loading:D,block:!0,children:y>0?e.jsxs("span",{style:{marginLeft:8},children:[y,"s"]}):s("login.login",{defaultValue:"Login"})})})]}),T.length>0&&c!=="password_expired"&&e.jsxs(e.Fragment,{children:[e.jsx(re,{children:s("login.or",{defaultValue:"Or"})}),e.jsx(ie,{direction:"vertical",style:{width:"100%"},children:T.map(a=>e.jsx(C,{icon:W(a.name),onClick:()=>K(a.name),loading:w[a.name],block:!0,children:a.icon_url?e.jsx(le,{src:a.icon_url}):s("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:a.display_name})},a.name))})]}),c==="password_expired"&&e.jsx(we,{onSuccess:()=>{h("login"),p.setFieldValue("password",""),p.setFieldValue("mfa_code","")},token:$||void 0})]})})]})};export{Ve as default};
