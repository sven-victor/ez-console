import{ac as X,al as Z,aI as ee,u as te,r,F as d,j as e,C as ae,T as se,x as C,m as g,aJ as oe,af as re,aK as ne,n as B,g as ie,E as le,A as de,s as ce,aL as ue}from"./vendor.5VlR7AZZ.js";import{u as me}from"./contexts.B2_ihE-j.js";import{a as b}from"./index.Cq3ia0Rf.js";import{A as O}from"./client.Bxbi3rzc.js";import{L as fe,a as ge,b as he}from"./components.Hu8o1XqG.js";import{m as pe}from"./base.BCJy1ny5.js";import"./vite.BF1G3H_w.js";import"./authorization.BtxSOE4l.js";import"./system.BY_RKaj3.js";import"./oauth.CNxiEEVf.js";const{Title:xe}=se,Ae=()=>{const f=X(),$=Z(),[i]=ee(),{login:S,oauthLogin:V,user:I}=me(),{t:s,i18n:x}=te(),[L,l]=r.useState(null),[w,k]=r.useState({}),[c,h]=r.useState("login"),[q,M]=r.useState(null),[j,U]=r.useState(null),[u,D]=r.useState(null),[p]=d.useForm(),A=r.useRef(!1),[N,T]=r.useState(!1),[E,z]=r.useState([]),[y,_]=r.useState(0),[J,v]=r.useState("Loading..."),[o,K]=r.useState(null),F=async a=>{const n=async t=>"username"in t?await S({username:t.username,password:t.password}):"mfa_token"in t?await S({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await V({code:t.code,state:t.state,provider:t.provider});try{T(!0);const t=await n(a);if(await new Promise(m=>setTimeout(m,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&$.pathname!=="/profile")f("/profile#mfa");else{const m=i.get("redirect");m?window.location.href=m:o!=null&&o.home_page?window.location.href=o.home_page:f("/")}}catch(t){if(t.password_expired)h("password_expired"),M(t.token),l(null);else if(t.needsMFA)l(null),h("mfa"),f("/login",{replace:!0}),U(t.mfaType),D(t.user),p.setFieldValue("mfa_token",t.mfaToken);else if("username"in a||"mfa_token"in a)if(t instanceof O?l(s("login.error",{defaultValue:"Login failed: {{error}}",error:s(`login.${t}`,{defaultValue:t.message})})):l(typeof t=="string"?t:s("login.error",{defaultValue:"Login failed"})),"mfa_token"in a){_(30);const m=setInterval(()=>{_(R=>R>=1?R-1:0)},1e3);setTimeout(()=>{clearInterval(m),_(0)},3e4)}else"username"in a&&h("login");else t instanceof O?l(s("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:s(`login.${t.code}`,{defaultValue:t.message})})):l(typeof t=="string"?t:s("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),f("/login",{replace:!0}),P()}finally{T(!1)}},P=async()=>{z(await b.oauth.getProviders()||[])};r.useEffect(()=>{if(!A.current){A.current=!0;const a=i.get("code"),n=i.get("state"),t=i.get("provider");a&&n&&t?F({code:a,state:n,provider:t}):P()}},[i,V]),r.useEffect(()=>{x.language&&v((o==null?void 0:o.name_i18n[x.language])||(o==null?void 0:o.name)||"")},[o,x.language]);const W=async a=>{try{k({...w,[a]:!0});const{url:n}=await b.oauth.getLoginUrl({provider:a});window.location.href=n}catch(n){ce.error(s("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",n)}finally{k({...w,[a]:!1})}},Y=a=>{switch(a.toLowerCase()){case"github":return e.jsx(ue,{});default:return null}},G=i.get("code"),H=i.get("state"),Q=i.get("provider");if(r.useEffect(()=>{(async()=>{var t;const n=await b.system.getSiteConfig();v(n.name),K(n),window.document.title=n.name,(t=document.getElementById("site-icon"))==null||t.setAttribute("href",n.logo)})()},[]),G&&H&&Q||!o)return e.jsx(fe,{});if(I&&I.status==="active"){const a=i.get("redirect");a?window.location.href=a:o!=null&&o.home_page?window.location.href=o.home_page:f("/")}return e.jsxs("div",{children:[e.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsx(ge,{})}),e.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxs(ae,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsx(xe,{level:2,children:J}),e.jsx("p",{children:s("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),L&&e.jsx(C,{message:L,type:"error",showIcon:!0,style:{marginBottom:20}}),j&&e.jsx(C,{message:s(`login.mfaTips.${j}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxs(d,{name:"login",initialValues:{remember:!0},onFinish:F,size:"large",form:p,hidden:c==="password_expired",children:[c==="mfa"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{hidden:!(u!=null&&u.email)||j!=="email",children:e.jsx(g,{value:pe(u==null?void 0:u.email)})}),e.jsx(d.Item,{name:"mfa_token",hidden:!0,children:e.jsx(g,{})}),e.jsx(d.Item,{name:"mfa_code",hidden:c!=="mfa",children:e.jsx(g,{placeholder:s("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsx(oe,{})})})]}),c==="login"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{name:"username",rules:[{required:!0,message:s("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsx(g,{prefix:e.jsx(re,{}),placeholder:s("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsx(d.Item,{name:"password",rules:[{required:!0,message:s("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsx(g.Password,{prefix:e.jsx(ne,{}),placeholder:s("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsx(d.Item,{children:e.jsx(B,{disabled:y>0,type:"primary",htmlType:"submit",loading:N,block:!0,children:y>0?e.jsxs("span",{style:{marginLeft:8},children:[y,"s"]}):s("login.login",{defaultValue:"Login"})})})]}),E.length>0&&c!=="password_expired"&&e.jsxs(e.Fragment,{children:[e.jsx(ie,{children:s("login.or",{defaultValue:"Or"})}),e.jsx(le,{direction:"vertical",style:{width:"100%"},children:E.map(a=>e.jsx(B,{icon:Y(a.name),onClick:()=>W(a.name),loading:w[a.name],block:!0,children:a.icon_url?e.jsx(de,{src:a.icon_url}):s("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:a.display_name})},a.name))})]}),c==="password_expired"&&e.jsx(he,{onSuccess:()=>{h("login"),p.setFieldValue("password",""),p.setFieldValue("mfa_code","")},token:q||void 0})]})})]})};export{Ae as default};
