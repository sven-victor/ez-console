var we=Object.defineProperty;var Ie=(t,n,s)=>n in t?we(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s;var ae=(t,n,s)=>Ie(t,typeof n!="symbol"?n+"":n,s);import{j as e,S as q,N as re,c as O,D as Ce,d as ke,u as _,A as _e,r as u,I as Fe,U as Le,M as W,l as Ae,e as R,P as ze,R as Te,f as Re,L as Pe,g as de,h as De,k as $e,m as Me,T as ue,F as Ee,n as Be,o as Ve,p as S,q as P,s as C,t as w,v as Ne,C as U,w as ie,x as qe,y as He,z as Ue,E as Ke,G as oe,Q as Oe,H as me,J as We,K as $,O as Xe,V as Ye,W as Ge,X as Je,Y as Qe,Z as K,_ as ee,$ as Ze,a0 as se,a1 as le,a2 as N,a3 as te,a4 as et,a5 as tt,a6 as st,a7 as nt,a8 as at,a9 as rt,aa as it,ab as ot,ac as lt,ad as ct,ae as G,af as dt,ag as ut,ah as mt,ai as ht}from"./vendor.CPU8FhsP.js";import{u as he,a as fe}from"./contexts.CiLf3bbw.js";import{g as ft,f as pt}from"./base.CSbpsOj9.js";import{_ as gt}from"./vite.BF1G3H_w.js";import{a as I,w as xt}from"./index.DWU4wfu6.js";import{b as J,A as yt}from"./client.BCH7Jt5A.js";const jt=()=>e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",width:"100%"},children:e.jsx(q,{size:"large"})}),Ot=({element:t,requiredPermission:n,requiredPermissions:s})=>{const{user:a,loading:i}=he(),{hasPermission:r,hasAllPermissions:h}=fe();return i?e.jsx(jt,{}):a?n&&!r(n)?e.jsx(re,{to:"/forbidden",replace:!0}):s&&!h(s)?e.jsx(re,{to:"/forbidden",replace:!0}):t:(window.location.href=ft("/login?redirect="+encodeURIComponent(window.location.href)),null)},St=O(({token:t,css:n})=>({container:n`
      ${n`
        @media screen and (max-width: ${t.screenXS}px) {
          width: 100% !important;
          > * {
            border-radius: 0 !important;
          }
        }
      `}
    > *{
      background-color: ${t.colorBgElevated};
      border-radius: 4px;
      box-shadow: ${t.boxShadowTertiary};
    }
    `,iconStyle:{cursor:"pointer",padding:"12px",display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:18,verticalAlign:"middle","&:hover":{color:t.colorPrimaryTextHover}}})),pe=({overlayClassName:t,overlay:n,hidden:s,children:a,...i})=>{if(s)return e.jsx(e.Fragment,{});const{styles:r}=St();return e.jsx(Ce,{dropdownRender:n,overlayClassName:ke(r.container,t),...i,children:e.jsx("span",{className:r.iconStyle,children:a})})},vt=()=>e.jsxs("svg",{viewBox:"0 0 24 24",focusable:"false",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true",children:[e.jsx("path",{d:"M0 0h24v24H0z",fill:"none"}),e.jsx("path",{d:"M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z ",className:"css-c4d79v"})]}),bt=O(()=>({menuItemStyle:{minWidth:"160px"},menuItemIconStyle:{marginRight:"8px"}})),wt=[{lang:"en-US",label:"English",icon:"ðŸ‡ºðŸ‡¸"},{lang:"sv-SE",label:"Svenska",icon:"ðŸ‡¸ðŸ‡ª"},{lang:"ar-AE",label:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",icon:"ðŸ‡¦ðŸ‡ª"},{lang:"de-DE",label:"Deutsch",icon:"ðŸ‡©ðŸ‡ª"},{lang:"es-ES",label:"EspaÃ±ol",icon:"ðŸ‡ªðŸ‡¸"},{lang:"fr-FR",label:"FranÃ§ais",icon:"ðŸ‡«ðŸ‡·"},{lang:"zh-CN",label:"ä¸­æ–‡",icon:"ðŸ‡¨ðŸ‡³"}],Wt=({transformLangConfig:t=n=>n})=>{const{i18n:n}=_(),{styles:s}=bt(),a=r=>{n.changeLanguage(r)},i={selectedKeys:[n.language],onClick:r=>{a(r.key)},items:t(wt).map(r=>({key:r.lang,className:s.menuItemStyle,label:e.jsxs(e.Fragment,{children:[e.jsx("span",{role:"img","aria-label":(r==null?void 0:r.label)||"en-US",className:s.menuItemIconStyle,children:(r==null?void 0:r.icon)||"ðŸŒ"}),(r==null?void 0:r.label)||"en-US"]})}))};return e.jsx(pe,{menu:i,children:e.jsx(vt,{})})},It=O(({css:t})=>({avatarItem:t`
    :hover {
      background: rgba(0, 0, 0, 0.12);
    }
    padding: 5px;
  `})),ge=t=>Ae.isString(t)&&t.match(/^[-_a-zA-Z0-9]+$/)?J.endsWith("/")?J+`files/${t}`:J+`/files/${t}`:t,Ct=({src:t,...n})=>e.jsx(_e,{src:ge(t),...n}),kt=({onChange:t,shape:n="square"})=>{const[s,a]=u.useState([]),{styles:i}=It(),[r,h]=u.useState(!1),[o,m]=u.useState(!0),[c,j]=u.useState(0),{run:f,loading:g}=R(()=>I.base.listFiles({current:c+1,page_size:40,file_type:"avatar",access:"public",search:""}),{manual:!0,onSuccess:({data:d})=>{a([...s,...d]),m(d.length===40),j(c+1)}}),k=()=>{m(!0),j(0),a([])};return e.jsx(ze,{style:{zIndex:1e3},onOpenChange:d=>{h(d),d?f():k()},open:r,content:e.jsx("div",{style:{width:360,height:200},children:e.jsx("div",{id:"iconsScrollableDiv",style:{height:"100%",overflow:"auto"},children:e.jsx(Re,{dataLength:s.length,next:()=>{f()},hasMore:o,loader:e.jsx(De,{avatar:!0,paragraph:{rows:1},active:!0}),endMessage:e.jsx(de,{plain:!0,children:"End"}),scrollableTarget:"iconsScrollableDiv",children:e.jsx(Pe,{grid:{gutter:16,column:8},dataSource:s,style:{margin:"0 8px"},loading:g,renderItem:({id:d})=>e.jsx("div",{className:i.avatarItem,onClick:v=>{v.stopPropagation(),t==null||t(d),h(!1),k()},children:e.jsx(Ct,{shape:n,src:d})})})})})}),placement:"bottom",trigger:"hover",children:e.jsx(Te,{shape:n,style:{width:112,height:112,placeContent:"center"}})})},_t=({value:t,onChange:n,shape:s,...a})=>{const[i,r]=u.useState(void 0),[h,o]=u.useState(!1),[m,c]=u.useState(void 0),j=async f=>{o(!0),c(f.url??f.preview)};return u.useEffect(()=>{r(t?{uid:t,name:t,url:ge(t)}:void 0)},[t]),e.jsxs(e.Fragment,{children:[e.jsx(Fe,{beforeCrop:async f=>{if(f.type==="image/svg+xml"){const g=await I.base.uploadFile({type:"avatar"},f);return g.length>0&&(n==null||n(g[0].id)),!1}return!0},children:e.jsx(Le,{customRequest:async f=>{var k,d;const g=await I.base.uploadFile({type:"avatar",access:"public"},f.file);g.length>0?((k=f.onSuccess)==null||k.call(f,g[0].id),n==null||n(g[0].id)):(d=f.onError)==null||d.call(f,new Error("Upload file failed"))},listType:"picture-card",onPreview:j,maxCount:1,onChange:({file:f})=>{switch(f.status){case"removed":n==null||n(void 0);break;case"done":break;default:r(f);break}},fileList:i?[i]:[],...a,children:i?void 0:e.jsx(kt,{shape:s,onChange:n})})}),e.jsx(W,{open:h,footer:null,onCancel:()=>o(!1),children:e.jsx("img",{style:{width:"100%"},src:m})})]})},Xt=()=>{const{t}=_("common"),{user:n}=he(),s=(n==null?void 0:n.organizations)||[],[a,i]=u.useState(localStorage.getItem("orgID")),r=c=>{c?(localStorage.setItem("orgID",c),i(c),window.location.reload()):(localStorage.removeItem("orgID"),i(null),window.location.reload())};if(u.useEffect(()=>{s.length>0&&!a&&r(s[0].id)},[s,a]),s.length===0)return null;const h=s.find(c=>c.id===a),o=h?h.name:t("organization.global",{defaultValue:"Global"}),m=[...s.map(c=>({key:c.id,label:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:c.name}),a===c.id&&e.jsx($e,{})]}),onClick:()=>r(c.id)}))];return e.jsxs(pe,{menu:{items:m,selectedKeys:a?[a]:[""]},children:[e.jsx(Me,{style:{marginRight:4}}),e.jsx("span",{style:{height:"1em",lineHeight:"1em",marginLeft:"5px"},children:o})]})},Ft=u.lazy(()=>gt(()=>Promise.resolve().then(()=>Et),void 0)),Yt=()=>{const{t}=_("ai"),[n,s]=u.useState(!1),a=()=>{s(!0)},i=()=>{s(!1)};return console.log(n),e.jsxs(e.Fragment,{children:[e.jsx(ue,{title:t("chat.openAssistant",{defaultValue:"Open AI Assistant"}),placement:"left",children:e.jsx(Ee,{icon:e.jsx(Be,{}),type:"primary",onClick:a,style:{right:24,bottom:24}})}),e.jsx(W,{width:1200,open:n,onCancel:i,footer:null,children:xt(Ft)})]})},Lt=Ve,At=t=>Lt[t],Gt=({iconName:t})=>{if(!t)return null;const n=At(t);return n?e.jsx(u.Suspense,{fallback:null,children:e.jsx(n,{})}):null},Jt=({onSuccess:t,token:n})=>{const{t:s}=_("authorization"),{t:a}=_("common"),[i]=S.useForm(),{run:r,loading:h}=R(async o=>I.authorization.changePassword(o,n?{headers:{Authorization:`Bearer ${n}`}}:{}),{manual:!0,onSuccess:()=>{w.success(s("user.passwordChanged")),i.resetFields(),t==null||t()},onError:o=>{if(o instanceof yt){const m=o.code??"normal";w.error(s(`user.passwordChangeFailed.${m}`,{error:o.message,defaultValue:"Password change failed: {{error}}"}))}else w.error(s("user.passwordChangeFailed.normal",{error:o.message,defaultValue:"Password change failed: {{error}}"}));console.error("Failed to change password:",o)}});return e.jsxs(S,{form:i,layout:"vertical",onFinish:r,style:{maxWidth:500,margin:"0 auto"},children:[e.jsx(S.Item,{name:"old_password",label:s("user.oldPassword"),rules:[{required:!0,message:s("validation.oldPasswordRequired")}],children:e.jsx(P.Password,{})}),e.jsx(S.Item,{name:"new_password",label:s("user.newPassword"),rules:[{required:!0,message:s("validation.newPasswordRequired")},{min:8,message:s("validation.passwordMinLength")}],children:e.jsx(P.Password,{})}),e.jsx(S.Item,{name:"confirm_password",label:s("user.confirmPassword"),rules:[{required:!0,message:s("validation.confirmPasswordRequired")},({getFieldValue:o})=>({validator(m,c){return!c||o("new_password")===c?Promise.resolve():Promise.reject(new Error(s("validation.passwordMismatch")))}})],children:e.jsx(P.Password,{})}),e.jsx(S.Item,{children:e.jsx(C,{type:"primary",htmlType:"submit",loading:h,children:a("save")})})]})},Qt=({user:t,onSuccess:n})=>{const{t:s}=_("authorization"),{t:a}=_("common"),[i]=S.useForm(),[r,h]=u.useState(!1);Ne.useEffect(()=>{t&&i.setFieldsValue({username:t.username,email:t.email,full_name:t.full_name,phone:t.phone||"",avatar:t.avatar})},[t,i]);const o=async m=>{try{h(!0),await I.authorization.updateCurrentUser(m),w.success(a("updateSuccess")),n()}catch(c){w.error(a("updateFailed")),console.error("Failed to update user information:",c)}finally{h(!1)}};return e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs("div",{style:{marginBottom:24,textAlign:"center"},children:[e.jsx("h2",{children:(t==null?void 0:t.full_name)||(t==null?void 0:t.username)}),(t==null?void 0:t.roles)&&t.roles.length>0&&e.jsxs("div",{children:[s("user.roles"),": ",t.roles.map(m=>m.name).join(", ")]})]}),e.jsxs(S,{form:i,layout:"vertical",onFinish:o,style:{width:"100%",maxWidth:500},children:[e.jsx(S.Item,{style:{marginBottom:24,textAlign:"center",justifyItems:"center"},name:"avatar",children:e.jsx(_t,{})}),e.jsx(S.Item,{name:"username",label:s("user.username"),children:e.jsx(P,{disabled:!0})}),e.jsx(S.Item,{name:"email",label:s("user.email"),rules:[{required:!0,message:s("validation.emailRequired")},{type:"email",message:s("validation.emailInvalid")}],children:e.jsx(P,{})}),e.jsx(S.Item,{name:"full_name",label:s("user.fullName"),rules:[{required:!0,message:s("validation.fullNameRequired")}],children:e.jsx(P,{})}),e.jsx(S.Item,{name:"phone",label:s("user.phone"),children:e.jsx(P,{})}),e.jsx(S.Item,{children:e.jsx(C,{type:"primary",htmlType:"submit",loading:r,children:a("save")})})]})]})},Zt=({user:t,onSuccess:n})=>{const{t:s}=_("authorization"),{t:a}=_("common"),[i,r]=u.useState(0),[h,o]=u.useState(!1),[m,c]=u.useState(!0),[j,f]=u.useState(""),[g,k]=u.useState("totp"),{run:d,data:v={secret:"",qr_code:"",token:void 0}}=R(()=>I.authorization.enableMfa(g),{manual:!0,onSuccess:()=>{r(1)},onBefore:()=>{o(!0)},onFinally:()=>{o(!1)}}),E=async()=>{if(!j){w.warning(s("mfa.enterVerificationCode"));return}const F={code:j,mfa_type:g};"token"in v&&(F.token=v.token);try{o(!0),await I.authorization.verifyAndActivateMfa(F),w.success(s("mfa.enableSuccess")),r(2),n()}catch(A){w.error(s("mfa.verificationFailed")),console.error("Failed to verify MFA:",A)}finally{o(!1)}},x=async()=>{try{o(!0),await I.authorization.disableMfa(),w.success(s("mfa.disableSuccess")),n()}catch(F){w.error(a("operationFailed")),console.error("Failed to disable MFA:",F)}finally{o(!1)}},L=()=>{if(!t)return null;if(t.mfa_enabled)return e.jsx(ie,{status:"success",title:s("mfa.enabled"),subTitle:s("mfa.enabledDescription"),extra:e.jsx(C,{danger:!0,onClick:()=>{W.confirm({title:s("mfa.confirmDisable"),content:s("mfa.disableWarning"),onOk:x,okButtonProps:{danger:!0}})},children:s("mfa.disable")})});const F=()=>{var A;switch(i){case 0:return e.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsx(oe,{message:e.jsxs("div",{children:[e.jsx("p",{children:s("mfa.setupInfo")}),e.jsx("p",{children:s(g==="totp"?"mfa.totpDescription":"mfa.emailDescription")})]}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsx(C,{type:"primary",onClick:d,loading:h,children:s("mfa.startSetup")})]});case 1:return e.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsx(oe,{message:s("mfa.scanQrCode"),type:"info",showIcon:!0,style:{marginBottom:20,display:g==="totp"?"block":"none"}}),e.jsx("div",{style:{display:g==="totp"?"flex":"none",justifyContent:"center",marginBottom:24},children:e.jsx(Oe,{value:v.qr_code??"",size:200})}),e.jsx("div",{style:{marginBottom:16,display:g==="email"?"block":"none"},children:e.jsxs("p",{children:[s("user.email"),": ",e.jsx("strong",{children:t==null?void 0:t.email})]})}),e.jsx("div",{style:{marginBottom:16,display:g==="totp"?"block":"none"},children:e.jsxs("p",{children:[s("mfa.secretKey"),": ",e.jsx("strong",{children:m?"*".repeat(((A=v.secret)==null?void 0:A.length)??0):v.secret}),e.jsx(C,{type:"link",onClick:()=>c(!m),icon:m?e.jsx(me,{}):e.jsx(We,{})})]})}),e.jsx("div",{style:{marginBottom:24},children:e.jsx(P,{placeholder:s("mfa.enterCode"),style:{width:200},maxLength:6,value:j,onChange:z=>f(z.target.value)})}),e.jsxs($,{children:[e.jsx(C,{onClick:()=>r(0),children:a("previous")}),e.jsx(C,{type:"primary",onClick:E,loading:h,children:a("verify")})]})]});case 2:return e.jsx(ie,{status:"success",title:s("mfa.setupSuccess"),subTitle:s("mfa.setupSuccessDescription"),extra:e.jsx(C,{type:"primary",onClick:()=>r(0),children:a("done")})});default:return null}};return e.jsxs("div",{children:[e.jsxs("div",{style:{display:i===2?"none":"unset"},children:[e.jsx(qe,{defaultValue:"totp",onChange:A=>{k(A),r(0)},value:g,options:[{value:"totp",icon:e.jsx(He,{}),label:s("mfa.totp",{defaultValue:"TOTP"})},{value:"email",icon:e.jsx(Ue,{}),label:s("mfa.email",{defaultValue:"E-Mail"})}]}),e.jsx(de,{})]}),e.jsx(Ke,{current:i,items:[{title:s(g==="totp"?"mfa.totpStep1":"mfa.emailStep1"),description:s(g==="totp"?"mfa.totpStep1Description":"mfa.emailStep1Description")},{title:s(g==="totp"?"mfa.totpStep2":"mfa.emailStep2"),description:s(g==="totp"?"mfa.totpStep2Description":"mfa.emailStep2Description")},{title:s(g==="totp"?"mfa.totpStep3":"mfa.emailStep3"),description:s(g==="totp"?"mfa.totpStep3Description":"mfa.emailStep3Description")}],style:{marginBottom:30}}),F()]})};return e.jsx(U,{title:s("mfa.title"),children:L()})},{Text:Q}=Ye,es=()=>{const{t}=_("authorization"),{t:n}=_("common"),[s,a]=u.useState([]),[i,r]=u.useState(!1),[h,o]=u.useState(null),[m,c]=u.useState(!1),j=async()=>{try{r(!0);const d=await I.authorization.getUserSessions({});a(d)}catch(d){w.error(t("session.getSessionsFailed",{error:d,defaultValue:"Failed to get session list: {{error}}"}))}finally{r(!1)}};u.useEffect(()=>{j()},[]);const f=async d=>{try{o(d),await I.authorization.terminateSession({id:d}),a(s.filter(v=>v.id!==d)),w.success(t("session.terminateSuccess",{defaultValue:"Session terminated successfully"}))}catch(v){w.error(t("session.terminateFailed",{error:v,defaultValue:"Failed to terminate session: {{error}}"}))}finally{o(null)}},g=async()=>{try{c(!0),await I.authorization.terminateOtherSessions(),a(s.filter(d=>d.is_current)),w.success(t("session.terminateAllSuccess",{defaultValue:"All other sessions terminated successfully"}))}catch(d){w.error(t("session.terminateAllFailed",{error:d,defaultValue:"Failed to terminate all other sessions: {{error}}"}))}finally{c(!1)}},k=[{title:t("session.device"),dataIndex:"user_agent",key:"device",render:(d,v)=>e.jsxs($,{direction:"vertical",size:0,children:[e.jsxs($,{children:[e.jsx(Xe,{}),e.jsx(Q,{strong:!0,children:d})]}),e.jsxs($,{children:[e.jsx(Ge,{}),e.jsx(Q,{type:"secondary",children:v.location})]})]})},{title:t("session.ipAddress"),dataIndex:"ip_address",key:"ip_address",render:d=>e.jsxs($,{children:[e.jsx(Je,{}),e.jsx("span",{children:d})]})},{title:t("session.lastActive"),dataIndex:"last_active_at",key:"last_active",render:d=>e.jsxs($,{children:[e.jsx(Qe,{}),e.jsx("span",{children:new Date(d).toLocaleString()})]})},{title:t("session.status"),key:"status",render:d=>d.is_current?e.jsx(K,{color:"green",children:t("session.current")}):e.jsx(K,{color:"blue",children:t("session.active")})},{title:n("actions"),key:"action",render:d=>d.is_current?e.jsx(Q,{type:"secondary",children:t("session.currentSession")}):e.jsx(ee,{title:t("session.confirmTerminate"),onConfirm:()=>f(d.id),okText:n("confirm"),cancelText:n("cancel"),children:e.jsx(C,{type:"link",danger:!0,loading:h===d.id,children:t("session.terminate")})})}];return e.jsx(U,{title:t("session.title"),extra:s.length>1&&e.jsx(ee,{title:t("session.confirmTerminateAll"),onConfirm:g,okText:n("confirm"),cancelText:n("cancel"),children:e.jsx(C,{danger:!0,loading:m,children:t("session.terminateOthers")})}),children:s.length===0?e.jsx(Ze,{description:t("session.noSessions")}):e.jsx(se,{columns:k,dataSource:s,rowKey:"id",loading:i,pagination:!1})})},{RangePicker:zt}=et,{Option:M}=te,Tt=t=>t||"N/A",Rt=(t,n)=>t==="success"?e.jsx(K,{color:"success",children:n("statuses.success")}):e.jsx(K,{color:"error",children:n("statuses.failed")}),ts=({userId:t,request:n=a=>t?I.authorization.getUserLogs({id:t,...a}):I.authorization.getCurrentUserLogs(a),columnsFilter:s=a=>a})=>{const{t:a}=_("authorization"),{t:i}=_("common"),[r,h]=u.useState({current:1,pageSize:10,total:0}),[o,m]=u.useState({}),[c]=S.useForm(),{loading:j,run:f,data:{data:g}={}}=R(async(x=o,L=1,F=10)=>n({...x,current:L??1,page_size:F??10}),{onError(x){w.error(a("auditLog.fetchFailed",{error:x}))},onSuccess({total:x}){h({...r,total:x})}});u.useEffect(()=>{f(o,1,r.pageSize)},[]);const k=x=>{h({...r,current:x.current,pageSize:x.pageSize}),f({},x.current,x.pageSize)},d=x=>{var L,F,A,z;f({...x,start_time:(F=(L=x.dateRange)==null?void 0:L[0])==null?void 0:F.toISOString(),end_time:(z=(A=x.dateRange)==null?void 0:A[1])==null?void 0:z.toISOString()},1,r.pageSize)},v=()=>{c.resetFields(),m({}),h({...r,current:1}),f({},1,r.pageSize)},E=[{title:a("auditLog.timestamp"),dataIndex:"timestamp",key:"timestamp",render:x=>pt(x)},{title:a("auditLog.action"),dataIndex:"action",key:"action",render:(x,L)=>x?a(`action.${x.replace(":",".")}`,{defaultValue:L.action_name}):L.action_name??L.action},{title:a("auditLog.user_agent"),dataIndex:"user_agent",key:"user_agent"},{title:a("auditLog.ip"),dataIndex:"ip",key:"ip",render:x=>Tt(x)},{title:a("auditLog.status"),dataIndex:"status",key:"status",render:x=>Rt(x,a)},{title:a("auditLog.details"),dataIndex:"details",key:"details",render:x=>e.jsx(C,{type:"link",icon:e.jsx(me,{}),onClick:()=>{W.info({title:a("auditLog.details"),content:JSON.stringify(x)})}})}];return e.jsxs("div",{children:[e.jsx(U,{style:{marginBottom:16},children:e.jsxs(S,{form:c,layout:"horizontal",onFinish:d,initialValues:o,children:[e.jsxs(le,{gutter:24,children:[e.jsx(N,{span:6,children:e.jsx(S.Item,{name:"search",label:a("auditLog.search"),children:e.jsx(P,{placeholder:a("auditLog.searchPlaceholder")})})}),e.jsx(N,{span:6,children:e.jsx(S.Item,{name:"action",label:a("auditLog.action"),children:e.jsxs(te,{allowClear:!0,placeholder:a("auditLog.selectAction"),children:[e.jsx(M,{value:"login",children:a("actions.login")}),e.jsx(M,{value:"logout",children:a("actions.logout")}),e.jsx(M,{value:"password_reset",children:a("actions.passwordReset")}),e.jsx(M,{value:"mfa_change",children:a("actions.mfaChange")})]})})}),e.jsx(N,{span:6,children:e.jsx(S.Item,{name:"status",label:a("auditLog.status"),children:e.jsxs(te,{allowClear:!0,placeholder:a("auditLog.selectStatus"),children:[e.jsx(M,{value:"success",children:a("statuses.success")}),e.jsx(M,{value:"failed",children:a("statuses.failed")})]})})}),e.jsx(N,{span:6,children:e.jsx(S.Item,{name:"dateRange",label:a("auditLog.dateRange"),children:e.jsx(zt,{style:{width:"100%"}})})})]}),e.jsx(le,{children:e.jsx(N,{span:24,style:{textAlign:"right"},children:e.jsxs($,{children:[e.jsx(C,{onClick:v,children:i("reset")}),e.jsx(C,{type:"primary",htmlType:"submit",icon:e.jsx(tt,{}),children:i("search")})]})})})]})}),e.jsxs(U,{children:[e.jsx("div",{style:{marginBottom:16},children:e.jsx(C,{type:"primary",icon:e.jsx(st,{}),onClick:v,style:{marginRight:8},children:i("refresh")})}),e.jsx(se,{rowKey:"id",columns:s(E),dataSource:g,pagination:{...r,showSizeChanger:!0,showTotal:x=>i("totalItems",{total:x})},loading:j,onChange:k,scroll:{x:"max-content"}})]})]})},Pt=({permission:t,permissions:n=[],checkAll:s=!1,fallback:a=null,children:i})=>{const{hasPermission:r,hasAnyPermission:h,hasAllPermissions:o,isAdmin:m,loading:c}=fe();return c?null:m?e.jsx(e.Fragment,{children:i}):t?r(t)?e.jsx(e.Fragment,{children:i}):e.jsx(e.Fragment,{children:a}):n.length>0?(s?o(n):h(n))?e.jsx(e.Fragment,{children:i}):e.jsx(e.Fragment,{children:a}):e.jsx(e.Fragment,{children:i})},H=t=>{const[n,s]=u.useState(!1),{permission:a,icon:i,tooltip:r,onClick:h,confirm:o,label:m,...c}=t;if(a)return e.jsx(Pt,{permission:a,children:H({icon:i,tooltip:r,onClick:h,confirm:o,label:m,...c})},t.key);if(o)return e.jsx(ee,{title:o.title,onConfirm:o.onConfirm||h,okText:o.okText,cancelText:o.cancelText,children:H({icon:i,tooltip:r,label:m,...c})},t.key);if(r)return e.jsx(ue,{title:r,children:H({icon:i,onClick:h,label:m,...c})},t.key);const j=h?async()=>{console.log(new Date,"handleClick"),s(!0);try{await h()}finally{s(!1),console.log(new Date,"handleClick1")}}:void 0;return u.createElement(C,{type:"text",size:"small",loading:n,icon:i,onClick:j,...c,key:t.key},m&&e.jsx("span",{style:{position:"inherit",top:"-2px"},children:m}))},ss=({actions:t})=>t.filter(n=>!n.hidden).map(n=>H(n)),Dt=({request:t,tableRef:n,...s},a)=>{const[i,r]=u.useState({current:1,pageSize:10}),[h,o]=u.useState(0),{data:m,loading:c,refresh:j}=R(async()=>{const f=await t({current:i.current,page_size:i.pageSize});return o(f.total),f.data},{refreshDeps:[i]});return u.useImperativeHandle(a,()=>({reload:()=>{j()}})),e.jsx(se,{rowKey:"id",loading:c,dataSource:m??[],pagination:{...i,total:h,onChange:(f,g)=>{r({current:f,pageSize:g})}},...s,ref:n})},ns=({actionRef:t,...n})=>{const[s,a]=u.useState();return u.useEffect(()=>{a(u.forwardRef(Dt))},[]),s?e.jsx(s,{...n,ref:t}):null},ce=ut({html:!0,breaks:!0}),$t=O(({token:t,css:n})=>({layout:n`
      width: 100%;
      min-width: 500px;
      height: 70vh;
      display: flex;
      background: ${t.colorBgContainer};
      font-family: AlibabaPuHuiTi, ${t.fontFamily}, sans-serif;
    `,sider:n`
      background: ${t.colorBgLayout}80;
      width: 280px;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 0 12px;
      box-sizing: border-box;
    `,logo:n`
      display: flex;
      align-items: center;
      justify-content: start;
      padding: 0 24px;
      box-sizing: border-box;
      gap: 8px;
      margin: 24px 0;

      span {
        font-weight: bold;
        color: ${t.colorText};
        font-size: 16px;
      }
    `,addBtn:n`
      background: #1677ff0f;
      border: 1px solid #1677ff34;
      height: 40px;
    `,conversationsSpin:n`
      height: 100%;
      overflow-y: auto;
    `,conversations:n`
      flex: 1;
      overflow-y: auto;
      margin-top: 12px;
      padding: 0;

      .ant-conversations-list {
        padding-inline-start: 0;
      }
    `,siderFooter:n`
      border-top: 1px solid ${t.colorBorderSecondary};
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    `,chat:n`
      height: 100%;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      padding-block: ${t.paddingLG}px;
      gap: 16px;
    `,chatPrompt:n`
      .ant-prompts-label {
        color: #000000e0 !important;
      }
      .ant-prompts-desc {
        color: #000000a6 !important;
        width: 100%;
      }
      .ant-prompts-icon {
        color: #000000a6 !important;
      }
    `,chatList:n`
      flex: 1;
      overflow: auto;
    `,loadingMessage:n`
      background-image: linear-gradient(90deg, #ff6b23 0%, #af3cb8 31%, #53b6ff 89%);
      background-size: 100% 2px;
      background-repeat: no-repeat;
      background-position: bottom;
    `,placeholder:n`
      padding-top: 32px;
    `,sender:n`
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
    `,speechButton:n`
      font-size: 18px;
      color: ${t.colorText} !important;
    `,senderPrompt:n`
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      color: ${t.colorText};
    `}));class Z extends Error{constructor(s,a){super(s);ae(this,"buffer");this.buffer=a}}const Mt=()=>{const{t}=_("ai"),{t:n}=_("common"),{styles:s}=$t(),a=u.useRef(null),[i,r]=u.useState({}),[h,o]=u.useState([]),[m,c]=u.useState(),[j,f]=u.useState(""),[g]=nt({request:async({message:l,sessionId:p},{onSuccess:y,onUpdate:b,onError:B,onStream:V})=>{if(!p)return;const X=new AbortController,D={buffer:[],messageID:""};try{V==null||V(X);const Y=await I.ai.streamChat({sessionId:p},{content:l.content},{signal:X.signal,requestType:"sse"});for await(const be of at({readableStream:Y})){const T=JSON.parse(be.data);if(T.event_type,T.event_type==="error"){B(new Z(T.content,D.buffer));return}T.event_type==="content"&&(D.messageID===""&&(D.messageID=T.message_id),D.messageID!==T.message_id&&(D.messageID=T.message_id),D.buffer.push(T.content),b(T.content))}y(D.buffer)}catch(Y){B(new Z(`${Y}`,D.buffer)),X.abort()}}}),k=g.isRequesting(),{loading:d}=R(async()=>{const l=await I.ai.listChatSessions({current:1,page_size:20});o(l.data)}),{run:v,loading:E}=R(async l=>await I.ai.createChatSession({title:t("chat.defaultConversationTitle"),model_id:""}),{manual:!0,onSuccess:(l,[p])=>{o(y=>[{...l,loading:!1},...y]),c(l.id),ne([]),p&&A({stream:!0,message:{role:"user",content:p},sessionId:l.id})}}),{run:x}=R(async l=>await I.ai.deleteChatSession({sessionId:l}),{manual:!0,onError(l,p){w.error(t("chat.deleteConversationFailed")),o(y=>y.map(b=>b.id===p[0]?{...b,loading:!1}:b))},onSuccess(l,p){var B;const y=h.filter(V=>V.id!==p[0]),b=(B=y==null?void 0:y[0])==null?void 0:B.id;o(y),p[0]===m&&c(b)}}),{run:L,loading:F}=R(async l=>await I.ai.getChatSession({sessionId:l}),{manual:!0,onSuccess:(l,[p])=>{r(y=>({...y,[p]:l.messages.filter(b=>b.role!=="tool").map(b=>({id:b.id,message:{content:b.content,role:b.role},status:"loading"}))}))}}),{onRequest:A,messages:z,setMessages:ne}=rt({agent:g,requestPlaceholder:()=>({content:n("loading"),role:"assistant"}),requestFallback:(l,{error:p})=>(console.log(p),p instanceof Z?{content:p.buffer.join(""),role:"assistant",error:p.message}:{content:`${p}`,role:"assistant"}),resolveAbortController:l=>{a.current=l},transformMessage:l=>{const{originMessage:p,chunk:y}=l||{};return y?{role:"assistant",content:((p==null?void 0:p.content)||"")+y}:{role:"assistant",content:(p==null?void 0:p.content)||""}}});u.useEffect(()=>{if(!m)return;const l=i[m];l?ne(l):L(m)},[i,m]);const xe=l=>{if(l){if(k){w.error(t("chat.requestInProgress"));return}if(!m){v(l);return}A({stream:!0,message:{role:"user",content:l},sessionId:m})}},ye=e.jsxs("div",{className:s.sider,children:[e.jsx(C,{onClick:()=>{v()},type:"link",className:s.addBtn,icon:e.jsx(it,{}),loading:E,children:t("chat.newConversation")}),e.jsx(q,{spinning:d,wrapperClassName:s.conversationsSpin,children:e.jsx(ot,{items:h.map(l=>({key:l.id,label:l.title,group:G(l.start_time).isSame(G(),"day")?t("chat.today"):G(l.start_time).format("YYYY-MM-DD")})),activeKey:m,onActiveChange:async l=>{var p;l&&((p=a.current)==null||p.abort(),c(y=>(y&&r(b=>({...b,[y]:z})),l)))},className:s.conversations,groupable:!0,styles:{item:{padding:"0 8px"}},menu:l=>({items:[{label:t("chat.renameConversation"),key:"rename",icon:e.jsx(lt,{})},{label:n("delete"),key:"delete",icon:e.jsx(ct,{}),danger:!0,onClick:()=>{o(p=>p.map(y=>y.id===l.key?{...y,loading:!0}:y)),x(l.key)}}]})})})]}),je=({message:l})=>{if(l.error)return e.jsx("div",{children:e.jsx("div",{dangerouslySetInnerHTML:{__html:ce.render(l.error)}})})},Se=e.jsx("div",{className:s.chatList,children:e.jsx(q,{spinning:F,children:e.jsx(dt.List,{items:z==null?void 0:z.map(l=>({...l.message,messageRender:p=>e.jsx("div",{dangerouslySetInnerHTML:{__html:ce.render(p)}}),footer:je(l)})),style:{height:"100%",paddingInline:"calc(calc(100% - 700px) /2)"},roles:{assistant:{placement:"start",loadingRender:()=>e.jsx(q,{size:"small"})},user:{placement:"end"}}})})}),ve=e.jsx(e.Fragment,{children:e.jsx(mt,{value:j,onSubmit:()=>{xe(j.trim()),f("")},onChange:f,onCancel:()=>{var l;(l=a.current)==null||l.abort()},loading:k,className:s.sender,allowSpeech:!0,actions:(l,p)=>{const{SendButton:y,LoadingButton:b}=p.components;return e.jsx(ht,{gap:4,children:k?e.jsx(b,{type:"default"}):e.jsx(y,{type:"primary"})})},placeholder:t("chat.inputPlaceholder")})});return e.jsxs("div",{className:s.layout,children:[ye,e.jsxs("div",{className:s.chat,children:[Se,ve]})]})},Et=Object.freeze(Object.defineProperty({__proto__:null,default:Mt},Symbol.toStringTag,{value:"Module"}));export{Ct as A,Gt as D,pe as H,jt as L,Xt as O,Ot as P,ns as T,ts as U,Wt as a,Yt as b,Jt as c,Qt as d,Zt as e,es as f,Pt as g,wt as h,ss as i,_t as j};
