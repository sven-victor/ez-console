import{r as a,e as v,j as z,t as P}from"./vendor.CPU8FhsP.js";import{a as A}from"./index.CL1ax4BB.js";import{c as _}from"./client.pILTFIdq.js";const I=a.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),T=()=>a.useContext(I),x=(n,t=!0)=>{n?(t&&localStorage.setItem("token",n),_.defaults.headers.common.Authorization=`Bearer ${n}`):(t&&localStorage.removeItem("token"),delete _.defaults.headers.common.Authorization)},F=({children:n})=>{const[t,r]=a.useState(void 0),[h,u]=a.useState(localStorage.getItem("token")),[C,f]=a.useState(!0),{run:l}=v(async()=>{const s=localStorage.getItem("token");return s?(x(s,!1),A.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:s=>{r(s)},onError:s=>{console.error("Failed to get current user:",s),m()},onFinally:()=>{f(!1)}});a.useEffect(()=>{l()},[]);const o=async s=>{try{const e=await A.authorization.login(s),{token:d,user:c,needs_mfa:p,password_expired:g,mfa_token:k,mfa_type:y}=e;if(p)throw{needsMFA:!0,mfaToken:k,mfaType:y,user:c};if(g)throw{password_expired:!0,user:c,token:d};return x(d),u(d),r(c),c}catch(e){throw e&&e.needsMFA||e&&e.password_expired||P.error("Login failed, please check your username and password"),e}},i=a.useCallback(async s=>{try{const e=await A.oauth.handleCallback(s);let d="",c=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:p,user:g,needs_mfa:k,mfa_token:y,mfa_type:S}=e.data;if(k)throw{needsMFA:!0,mfaToken:y,mfaType:S,user:g};d=p,c=g}else{const{token:p,user:g,needs_mfa:k,mfa_token:y,mfa_type:S}=e;if(k)throw{needsMFA:!0,mfaToken:y,mfaType:S,user:g};d=p,c=g}return x(d),u(d),r(c),c}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),m=()=>{A.authorization.logout(),x(null),u(null),r(null)},w=s=>{r(s)};return z.jsx(I.Provider,{value:{user:t,token:h,loading:C,login:o,oauthLogin:i,logout:m,updateUser:w},children:n})},j=()=>{const n=a.useContext(I);if(n===void 0)throw new Error("useAuth must be used within an AuthProvider");return n},O=a.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),b=()=>a.useContext(O),D=({children:n})=>{const{user:t}=T(),{data:r=null,loading:h,runAsync:u}=v(async()=>A.system.getSiteConfig(),{manual:!0});a.useEffect(()=>{t!==void 0&&u()},[t]);const[C,f]=a.useState(null);return a.useEffect(()=>{var o,i,m;let l=localStorage.getItem("orgID");if(l){const w=(o=t==null?void 0:t.organizations)==null?void 0:o.find(s=>s.id===l);if(w){f(w.id);return}}f(((m=(i=t==null?void 0:t.organizations)==null?void 0:i[0])==null?void 0:m.id)??null)},[r,t==null?void 0:t.organizations]),z.jsx(O.Provider,{value:{siteConfig:r,loading:h,enableMultiOrg:(r==null?void 0:r.enable_multi_org)??!1,fetchSiteConfig:u,currentOrgId:C,setCurrentOrgId:l=>{f(l),localStorage.setItem("orgID",l)},clearCurrentOrgId:()=>{f(null),localStorage.removeItem("orgID")}},children:n})},L=()=>{var l;const{user:n}=a.useContext(I),{currentOrgId:t}=b(),r=(l=n==null?void 0:n.roles)==null?void 0:l.filter(o=>!o.organization_id||o.organization_id===t),h=()=>r?r.some(o=>o.name==="admin"&&!o.organization_id):!1,u=o=>r?h()?!0:r.some(i=>i.permissions?i.permissions.some(m=>m.code===o):!1):!1;return{hasPermission:u,hasAllPermissions:o=>o.every(i=>u(i)),hasAnyPermission:o=>o.some(i=>u(i)),isAdmin:h(),loading:!n}};export{F as A,D as S,L as a,b,T as c,j as u};
