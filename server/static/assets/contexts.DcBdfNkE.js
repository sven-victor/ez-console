import{r as o,a as x,j as E,s as K,u as M}from"./vendor.CyaXoMFn.js";import{a as w}from"./index.Dwpr26wG.js";import{c as P,a as S}from"./client.CicVKWRR.js";import{g as U}from"./base.CIILqgsu.js";const T=o.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{},error:void 0}),F=()=>o.useContext(T),_=(e,s=!0)=>{e?(s&&localStorage.setItem("token",e),P.defaults.headers.common.Authorization=`Bearer ${e}`):(s&&localStorage.removeItem("token"),delete P.defaults.headers.common.Authorization)},X=({children:e})=>{const[s,r]=o.useState(void 0),[C,f]=o.useState(localStorage.getItem("token")),[A,v]=o.useState(!0),{run:k,error:g}=x(async()=>{const a=localStorage.getItem("token");return a?(_(a,!1),w.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{r(void 0)},onSuccess:a=>{r(a)},onError:a=>{console.log([a]),console.error("Failed to get current user:",a),h()},onFinally:()=>{v(!1)}});o.useEffect(()=>{k()},[]);const i=async a=>{try{const t=await w.authorization.login(a),{token:u,user:c,needs_mfa:d,password_expired:n,mfa_token:m,mfa_type:p}=t;if(d)throw{needsMFA:!0,mfaToken:m,mfaType:p,user:c};if(n)throw{password_expired:!0,user:c,token:u};return _(u),f(u),r(c),c}catch(t){throw t&&t.needsMFA||t&&t.password_expired||K.error("Login failed, please check your username and password"),t}},l=o.useCallback(async a=>{try{const t=await w.oauth.handleCallback(a,{headers:{"X-Base-Path":U()}});let u="",c=null;if(t&&typeof t=="object")if("code"in t&&t.code==="0"&&"data"in t){const{token:d,user:n,needs_mfa:m,mfa_token:p,mfa_type:I}=t.data;if(m)throw{needsMFA:!0,mfaToken:p,mfaType:I,user:n};u=d,c=n}else{const{token:d,user:n,needs_mfa:m,mfa_token:p,mfa_type:I}=t;if(m)throw{needsMFA:!0,mfaToken:p,mfaType:I,user:n};u=d,c=n}return _(u),f(u),r(c),c}catch(t){throw r(void 0),t&&t.needsMFA||t&&t.passwordExpired,t}},[]),h=()=>{w.authorization.logout(),_(null),f(null),r(null)},y=a=>{r(a)};return E.jsx(T.Provider,{value:{user:s,token:C,loading:A,login:i,oauthLogin:l,logout:h,updateUser:y,error:g},children:e})},H=()=>{const e=o.useContext(T);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},z=o.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{},error:void 0,tasks:void 0,addTask:()=>{},tasksDropdownOpen:!1,setTasksDropdownOpen:()=>{}}),j=()=>o.useContext(z),Q=({children:e})=>{const{user:s}=F(),{data:r=null,loading:C,runAsync:f,error:A}=x(async()=>w.system.getSiteConfig(),{manual:!0});o.useEffect(()=>{s!==void 0&&f()},[s]);const[v,k]=o.useState(localStorage.getItem("orgID"));o.useEffect(()=>{v?localStorage.setItem("orgID",v):localStorage.removeItem("orgID")},[v]),o.useEffect(()=>{var a,t,u;if(s){let c=localStorage.getItem("orgID");if(c){const d=(a=s==null?void 0:s.organizations)==null?void 0:a.find(n=>n.id===c);if(d){k(d.id);return}}k(((u=(t=s==null?void 0:s.organizations)==null?void 0:t[0])==null?void 0:u.id)??null)}},[r,s==null?void 0:s.organizations]);const[g,i]=o.useState(!1),[l,h]=o.useState([]),{run:y}=x(async()=>w.userTasks.listUserTasks({}),{onSuccess:a=>{h(a)},refreshDeps:[s],pollingInterval:g?3e3:6e4});return o.useEffect(()=>{g&&y()},[g]),E.jsx(z.Provider,{value:{siteConfig:r,loading:C,enableMultiOrg:(r==null?void 0:r.enable_multi_org)??!1,fetchSiteConfig:f,currentOrgId:v,setCurrentOrgId:a=>{k(a)},clearCurrentOrgId:()=>{k(null)},error:A,tasks:l,setTasksDropdownOpen:a=>{i(a)},tasksDropdownOpen:g,addTask:a=>{h(t=>[a,...t]),i(!0)}},children:e})},W=()=>{var g;const{user:e}=o.useContext(T),{currentOrgId:s}=j(),r=(g=e==null?void 0:e.roles)==null?void 0:g.filter(i=>!i.organization_id||i.organization_id===s),C=()=>r?r.some(i=>i.name==="admin"&&!i.organization_id):!1,f=i=>r?C()?!0:r.some(l=>l.permissions?l.permissions.some(h=>h.code===i):!1):!1;return{hasPermission:f,hasAllPermissions:i=>i.every(l=>f(l)),hasAnyPermission:i=>i.some(l=>f(l)),hasGlobalPermission:i=>r?C()?!0:r.some(l=>l.organization_id||!l.permissions?!1:l.permissions.some(h=>h.code===i)):!1,isAdmin:C(),loading:!e}},L=o.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{},callAI:()=>{},onCallAI:e=>{},loaded:!1,setLoaded:()=>{},fetchConversations:()=>Promise.resolve([]),fetchConversationsLoading:!1,conversations:void 0,activeConversationKey:void 0,setActiveConversationKey:()=>{}}),Y=()=>o.useContext(L),Z=({children:e})=>{const{t:s}=M("ai"),[r,C]=o.useState("sidebar"),[f,A]=o.useState(!1),[v,k]=o.useState(!1),[g,i]=o.useState(void 0),[l,h]=o.useState(),[y,a]=o.useState(null);o.useEffect(()=>{const n=localStorage.getItem("activeConversationKey");n&&i(n)},[]);const t=o.useCallback((n,m)=>{A(!0),y?y(n,m):h([n,m])},[y,A]);o.useEffect(()=>{y&&l&&(y(l[0],l[1]),h(void 0))},[y,l]);const{loading:u,runAsync:c,data:d}=x(async()=>(await w.ai.listChatSessions({current:1,page_size:20})).data,{ready:f,onError:n=>{K.error(s("chat.fetchConversationsFailed",{defaultValue:"Failed to fetch conversations: {{errmsg}}",errmsg:n.message??n}))}});return E.jsx(L.Provider,{value:{layout:r,setLayout:n=>{C(n)},visible:f,setVisible:n=>{A(n)},callAI:t,onCallAI:o.useCallback(n=>{a(()=>n)},[a]),loaded:v,setLoaded:n=>{k(n)},fetchConversations:c,fetchConversationsLoading:u,conversations:d,activeConversationKey:g,setActiveConversationKey:n=>{i(n),localStorage.setItem("activeConversationKey",n)}},children:e})},O=new Map,G=(e,s)=>JSON.stringify({dataSource:e,dependentValues:s}),R=(e,s)=>{const r=O.get(e);return r?s&&s>0&&Date.now()-r.timestamp>s*1e3?(O.delete(e),null):r.data:null},B=(e,s)=>{O.set(e,{data:s,timestamp:Date.now()})},V=(e,s,r)=>{const[C,f]=o.useState(s||[]),[A,v]=o.useState(!1),[k,g]=o.useState(null),[i,l]=o.useState(0),h=()=>l(a=>a+1),y=o.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(a=>r&&r[a]!==void 0&&r[a]!==null):!0,[e,r]);return o.useEffect(()=>{if(!y){f(s||[]);return}(async()=>{try{v(!0),g(null);const t=G(e,r);if(e.cache){const c=R(t,e.cache_ttl);if(c){f(c),v(!1);return}}let u=[];switch(e.type){case"api":{const c=e.url||"",d=e.method||"GET",n={...r,...e.params};let m;d.toUpperCase()==="GET"?m=await S(c,{params:n}):m=await S(c,{params:n});const p=Array.isArray(m)?m:m.data||[],I=e.label_key||"label",D=e.value_key||"value";u=p.map(b=>({label:b[I]||b.name||b.id,value:b[D]||b.id}));break}case"toolsets":{let d=(await w.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(d=d.filter(p=>Object.entries(e.filter).every(([I,D])=>p[I]===D)));const n=e.label_key||"name",m=e.value_key||"id";u=d.map(p=>({label:p[n]||p.name,value:p[m]||p.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),u=[];break}default:u=s||[]}e.cache&&B(t,u),f(u)}catch(t){console.error("Failed to load options from data source:",t),g(t),f(s||[])}finally{v(!1)}})()},[e,s,r,y,i]),{options:C,loading:A,error:k,refresh:h}};export{X as A,Q as S,H as a,W as b,j as c,V as d,Z as e,F as f,Y as u};
