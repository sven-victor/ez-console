import{b5 as re,bi as ae,bD as oe,u as se,r as s,aH as d,j as e,au as ne,ao as ie,N as le,aL as O,ai as g,bE as de,bc as ue,bF as ce,B as $,a0 as me,i as fe,aw as ge,bG as he,s as q,bH as pe}from"./vendor.CdlQoPOM.js";import{a as xe,c as we}from"./contexts.tbVYvYth.js";import{a as U}from"./index.gEo8sjVu.js";import{A as C}from"./client.20U86Zur.js";import{L as M,a as je,b as ye}from"./components.DKf2tVvt.js";import{m as be,g as _e}from"./base.CA-bfSJi.js";import"./vite.BF1G3H_w.js";import"./lodash.B3dv3_Tr.js";import"./highlight.BslI14e2.js";import"./ai.N_nt1I4d.js";import"./authorization.BnG7BYaH.js";import"./system.CM06OxEF.js";import"./oauth.-s2V-XVk.js";import"./ai-chat-layout.DJzfOFGW.js";const{Title:Ve}=le,qe=({transformLangConfig:D})=>{const f=re(),N=ae(),[n]=oe(),{login:V,oauthLogin:L,user:I}=xe(),{t:o,i18n:w}=se(),[S,i]=s.useState(null),[j,k]=s.useState({}),[u,h]=s.useState("login"),[H,z]=s.useState(null),[y,G]=s.useState(null),[c,W]=s.useState(null),[p]=d.useForm(),A=s.useRef(!1),[X,T]=s.useState(!1),[v,E]=s.useState([]),[b,_]=s.useState(0),{siteConfig:a,loading:Y,error:x}=we(),[J,F]=s.useState("Loading..."),P=async r=>{const l=async t=>"username"in t?await V({username:t.username,password:t.password}):"mfa_token"in t?await V({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await L({code:t.code,state:t.state,provider:t.provider});try{T(!0);const t=await l(r);if(he(),await new Promise(m=>setTimeout(m,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&N.pathname!=="/profile")f("/profile#mfa");else{const m=n.get("redirect");m?window.location.href=m:a!=null&&a.home_page?window.location.href=a.home_page:f("/")}}catch(t){if(t.password_expired)h("password_expired"),z(t.token),i(null);else if(t.needsMFA)i(null),h("mfa"),f("/login",{replace:!0}),G(t.mfaType),W(t.user),p.setFieldValue("mfa_token",t.mfaToken);else if("username"in r||"mfa_token"in r)if(t instanceof C?i(o("login.error",{defaultValue:"Login failed: {{error}}",error:o(`login.${t}`,{defaultValue:t.message})})):i(typeof t=="string"?t:o("login.error",{defaultValue:"Login failed"})),"mfa_token"in r){_(30);const m=setInterval(()=>{_(B=>B>=1?B-1:0)},1e3);setTimeout(()=>{clearInterval(m),_(0)},3e4)}else"username"in r&&h("login");else t instanceof C?i(o("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:o(`login.${t.code}`,{defaultValue:t.message})})):i(typeof t=="string"?t:o("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),f("/login",{replace:!0}),R()}finally{T(!1)}},R=async()=>{try{E(await U.oauth.getProviders()||[])}catch(r){q.error(o("login.fetchOAuthProvidersError",{defaultValue:"Failed to fetch OAuth providers: {{error}}",error:r.message||r.toString()})),E([])}};s.useEffect(()=>{if(!A.current){A.current=!0;const r=n.get("code"),l=n.get("state"),t=n.get("provider");r&&l&&t?P({code:r,state:l,provider:t}):R()}},[n,L]),s.useEffect(()=>{w.language&&F((a==null?void 0:a.name_i18n[w.language])||(a==null?void 0:a.name)||"")},[a,w.language]);const K=async r=>{try{k({...j,[r]:!0});const{url:l}=await U.oauth.getLoginUrl({provider:r},{headers:{"X-Base-Path":_e()}});window.location.href=l}catch(l){q.error(o("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",l)}finally{k({...j,[r]:!1})}},Q=r=>{switch(r.toLowerCase()){case"github":return e.jsx(pe,{});default:return null}},Z=n.get("code"),ee=n.get("state"),te=n.get("provider");if(s.useEffect(()=>{var r;a&&(F(a.name),window.document.title=a.name,(r=document.getElementById("site-icon"))==null||r.setAttribute("href",a.logo||""))},[a]),Y)return e.jsx(M,{});if(!a)return e.jsx(ne,{status:"500",title:"500",subTitle:o("login.fetchSiteConfigError",{defaultValue:"Failed to fetch site config: {{error}}",error:(x==null?void 0:x.message)||x})});if(Z&&ee&&te)return e.jsx(M,{});if(I&&I.status==="active"){const r=n.get("redirect");r?window.location.href=r:a!=null&&a.home_page?window.location.href=a.home_page:f("/")}return e.jsx("div",{children:e.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxs(ie,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsx(je,{transformLangConfig:D})}),e.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsx(Ve,{level:2,children:J}),e.jsx("p",{children:o("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),S&&e.jsx(O,{message:S,type:"error",showIcon:!0,style:{marginBottom:20}}),y&&e.jsx(O,{message:o(`login.mfaTips.${y}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxs(d,{name:"login",initialValues:{remember:!0},onFinish:P,size:"large",form:p,hidden:u==="password_expired",children:[u==="mfa"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{hidden:!(c!=null&&c.email)||y!=="email",children:e.jsx(g,{value:be(c==null?void 0:c.email)})}),e.jsx(d.Item,{name:"mfa_token",hidden:!0,children:e.jsx(g,{})}),e.jsx(d.Item,{name:"mfa_code",hidden:u!=="mfa",children:e.jsx(g,{placeholder:o("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsx(de,{})})})]}),u==="login"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{name:"username",rules:[{required:!0,message:o("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsx(g,{prefix:e.jsx(ue,{}),placeholder:o("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsx(d.Item,{name:"password",rules:[{required:!0,message:o("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsx(g.Password,{prefix:e.jsx(ce,{}),placeholder:o("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsx(d.Item,{children:e.jsx($,{disabled:b>0,type:"primary",htmlType:"submit",loading:X,block:!0,children:b>0?e.jsxs("span",{style:{marginLeft:8},children:[b,"s"]}):o("login.login",{defaultValue:"Login"})})})]}),v.length>0&&u!=="password_expired"&&e.jsxs(e.Fragment,{children:[e.jsx(me,{children:o("login.or",{defaultValue:"Or"})}),e.jsx(fe,{direction:"vertical",style:{width:"100%"},children:v.map(r=>e.jsx($,{icon:Q(r.name),onClick:()=>K(r.name),loading:j[r.name],block:!0,children:r.icon_url?e.jsx(ge,{src:r.icon_url}):o("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:r.display_name})},r.name))})]}),u==="password_expired"&&e.jsx(ye,{onSuccess:()=>{h("login"),p.setFieldValue("password",""),p.setFieldValue("mfa_code","")},token:H||void 0})]})})})};export{qe as default};
