import{r as o,e as K,j as L,t as S,u as M}from"./vendor.zAayICNw.js";import{a as k}from"./index.BNG293aR.js";import{c as O,a as P}from"./client.CAEUWtEV.js";const _=o.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),F=()=>o.useContext(_),b=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),O.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete O.defaults.headers.common.Authorization)},J=({children:e})=>{const[t,r]=o.useState(void 0),[A,u]=o.useState(localStorage.getItem("token")),[y,v]=o.useState(!0),{run:p}=K(async()=>{const a=localStorage.getItem("token");return a?(b(a,!1),k.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:a=>{r(a)},onError:a=>{console.error("Failed to get current user:",a),h()},onFinally:()=>{v(!1)}});o.useEffect(()=>{p()},[]);const i=async a=>{try{const s=await k.authorization.login(a),{token:c,user:l,needs_mfa:d,password_expired:m,mfa_token:n,mfa_type:g}=s;if(d)throw{needsMFA:!0,mfaToken:n,mfaType:g,user:l};if(m)throw{password_expired:!0,user:l,token:c};return b(c),u(c),r(l),l}catch(s){throw s&&s.needsMFA||s&&s.password_expired||S.error("Login failed, please check your username and password"),s}},f=o.useCallback(async a=>{try{const s=await k.oauth.handleCallback(a);let c="",l=null;if(s&&typeof s=="object")if("code"in s&&s.code==="0"&&"data"in s){const{token:d,user:m,needs_mfa:n,mfa_token:g,mfa_type:C}=s.data;if(n)throw{needsMFA:!0,mfaToken:g,mfaType:C,user:m};c=d,l=m}else{const{token:d,user:m,needs_mfa:n,mfa_token:g,mfa_type:C}=s;if(n)throw{needsMFA:!0,mfaToken:g,mfaType:C,user:m};c=d,l=m}return b(c),u(c),r(l),l}catch(s){throw s&&s.needsMFA||s&&s.passwordExpired,s}},[]),h=()=>{k.authorization.logout(),b(null),u(null),r(null)},I=a=>{r(a)};return L.jsx(_.Provider,{value:{user:t,token:A,loading:y,login:i,oauthLogin:f,logout:h,updateUser:I},children:e})},N=()=>{const e=o.useContext(_);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},T=o.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),U=()=>o.useContext(T),H=({children:e})=>{const{user:t}=F(),{data:r=null,loading:A,runAsync:u}=K(async()=>k.system.getSiteConfig(),{manual:!0});o.useEffect(()=>{t!==void 0&&u()},[t]);const[y,v]=o.useState(localStorage.getItem("orgID"));return o.useEffect(()=>{y?localStorage.setItem("orgID",y):localStorage.removeItem("orgID")},[y]),o.useEffect(()=>{var p,i,f,h,I,a,s;if(t){let c=localStorage.getItem("orgID");if(console.log(t,c),c){const l=(p=t==null?void 0:t.organizations)==null?void 0:p.find(d=>d.id===c);if(l){console.log("set2 ",((f=(i=t==null?void 0:t.organizations)==null?void 0:i[0])==null?void 0:f.id)??null),v(l.id);return}}console.log("set ",((I=(h=t==null?void 0:t.organizations)==null?void 0:h[0])==null?void 0:I.id)??null),v(((s=(a=t==null?void 0:t.organizations)==null?void 0:a[0])==null?void 0:s.id)??null)}},[r,t==null?void 0:t.organizations]),L.jsx(T.Provider,{value:{siteConfig:r,loading:A,enableMultiOrg:(r==null?void 0:r.enable_multi_org)??!1,fetchSiteConfig:u,currentOrgId:y,setCurrentOrgId:p=>{v(p)},clearCurrentOrgId:()=>{v(null)}},children:e})},Q=()=>{var p;const{user:e}=o.useContext(_),{currentOrgId:t}=U(),r=(p=e==null?void 0:e.roles)==null?void 0:p.filter(i=>!i.organization_id||i.organization_id===t),A=()=>r?r.some(i=>i.name==="admin"&&!i.organization_id):!1,u=i=>r?A()?!0:r.some(f=>f.permissions?f.permissions.some(h=>h.code===i):!1):!1;return{hasPermission:u,hasAllPermissions:i=>i.every(f=>u(f)),hasAnyPermission:i=>i.some(f=>u(f)),isAdmin:A(),loading:!e}},D=o.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{},callAI:()=>{},onCallAI:e=>{},loaded:!1,setLoaded:()=>{},fetchConversations:()=>Promise.resolve([]),fetchConversationsLoading:!1,conversations:void 0,activeConversationKey:void 0,setActiveConversationKey:()=>{}}),W=()=>o.useContext(D),X=({children:e})=>{const{t}=M("ai"),[r,A]=o.useState("sidebar"),[u,y]=o.useState(!1),[v,p]=o.useState(!1),[i,f]=o.useState(void 0),[h,I]=o.useState(),[a,s]=o.useState(null);o.useEffect(()=>{const n=localStorage.getItem("activeConversationKey");n&&f(n)},[]);const c=o.useCallback((n,g)=>{y(!0),a?a(n,g):I([n,g])},[a,y]);o.useEffect(()=>{a&&h&&(a(h[0],h[1]),I(void 0))},[a,h]);const{loading:l,runAsync:d,data:m}=K(async()=>(await k.ai.listChatSessions({current:1,page_size:20})).data,{ready:u,onError:n=>{S.error(t("chat.fetchConversationsFailed",{defaultValue:"Failed to fetch conversations: {{errmsg}}",errmsg:n.message??n}))}});return L.jsx(D.Provider,{value:{layout:r,setLayout:n=>{A(n)},visible:u,setVisible:n=>{y(n)},callAI:c,onCallAI:o.useCallback(n=>{s(()=>n)},[s]),loaded:v,setLoaded:n=>{p(n)},fetchConversations:d,fetchConversationsLoading:l,conversations:m,activeConversationKey:i,setActiveConversationKey:n=>{f(n),localStorage.setItem("activeConversationKey",n)}},children:e})},E=new Map,j=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),G=(e,t)=>{const r=E.get(e);return r?t&&t>0&&Date.now()-r.timestamp>t*1e3?(E.delete(e),null):r.data:null},R=(e,t)=>{E.set(e,{data:t,timestamp:Date.now()})},Y=(e,t,r)=>{const[A,u]=o.useState(t||[]),[y,v]=o.useState(!1),[p,i]=o.useState(null),[f,h]=o.useState(0),I=()=>h(s=>s+1),a=o.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(s=>r&&r[s]!==void 0&&r[s]!==null):!0,[e,r]);return o.useEffect(()=>{if(!a){u(t||[]);return}(async()=>{try{v(!0),i(null);const c=j(e,r);if(e.cache){const d=G(c,e.cache_ttl);if(d){u(d),v(!1);return}}let l=[];switch(e.type){case"api":{const d=e.url||"",m=e.method||"GET",n={...r,...e.params};let g;m.toUpperCase()==="GET"?g=await P(d,{params:n}):g=await P(d,{params:n});const C=Array.isArray(g)?g:g.data||[],x=e.label_key||"label",z=e.value_key||"value";l=C.map(w=>({label:w[x]||w.name||w.id,value:w[z]||w.id}));break}case"toolsets":{let m=(await k.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(m=m.filter(C=>Object.entries(e.filter).every(([x,z])=>C[x]===z)));const n=e.label_key||"name",g=e.value_key||"id";l=m.map(C=>({label:C[n]||C.name,value:C[g]||C.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),l=[];break}default:l=t||[]}e.cache&&R(c,l),u(l)}catch(c){console.error("Failed to load options from data source:",c),i(c),u(t||[])}finally{v(!1)}})()},[e,t,r,a,f]),{options:A,loading:y,error:p,refresh:I}};export{J as A,H as S,Q as a,U as b,W as c,Y as d,X as e,F as f,N as u};
