import{u as C,as as oe,r as n,j as e,K as P,av as ze,Z as L,m as Se,a_ as Re,T as Y,s as j,ac as Ee,_ as ve,ad as Ae,C as J,a1 as Pe,a2 as Z,a6 as we,aa as Te,t as b,c as Ie,b2 as ke,p as x,b1 as Ce,q as ae,b3 as G,a3 as k,b4 as Oe,b5 as Fe,b6 as De,aD as Q,S as Ne,b7 as ee,$ as A}from"./vendor.CPU8FhsP.js";import{g as M,T as qe}from"./components.CKk2t6DJ.js";import{a as R}from"./index.DWU4wfu6.js";import{b as ie,u as $e}from"./contexts.CiLf3bbw.js";const Le=()=>{const{t:s}=C("authorization"),{t:o}=C("common"),{siteConfig:f}=ie(),V=oe(),p=n.useRef(null),h=r=>{V(`/authorization/roles/${r}/edit`)},c=async r=>{var i,u;try{await R.authorization.deleteRole({id:r}),b.success(s("role.deleteSuccess",{defaultValue:"Role deleted successfully."})),(u=(i=p.current)==null?void 0:i.reload)==null||u.call(i)}catch(z){b.error(s("role.deleteError",{defaultValue:"Failed to delete role: {{error}}",error:z}))}},w=[{title:s("role.name",{defaultValue:"Role Name"}),dataIndex:"name",key:"name",render:r=>e.jsxs(P,{children:[e.jsx(ze,{}),r]})},{title:s("role.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:s("role.organization",{defaultValue:"Organization"}),key:"organization",hidden:!(f!=null&&f.enable_multi_org),render:(r,i)=>{var u;return i.organization_id?e.jsx(L,{icon:e.jsx(Se,{}),color:"blue",children:((u=i.organization)==null?void 0:u.name)||i.organization_id}):e.jsx(L,{color:"default",children:s("role.global",{defaultValue:"Global"})})}},{title:s("role.permissionCount",{defaultValue:"Permissions"}),key:"permission_count",render:(r,i)=>{var u;return e.jsxs(L,{color:"blue",children:[e.jsx(Re,{})," ",((u=i.permissions)==null?void 0:u.length)||0]})}},{title:s("role.createdAt",{defaultValue:"Created At"}),dataIndex:"created_at",key:"created_at",render:r=>new Date(r).toLocaleString()},{title:o("actions",{defaultValue:"Actions"}),key:"action",render:(r,i)=>e.jsxs(P,{size:"small",children:[e.jsx(M,{permission:"authorization:role:update",children:e.jsx(Y,{title:s("role.edit",{defaultValue:"Edit Role"}),children:e.jsx(j,{type:"text",size:"small",icon:e.jsx(Ee,{}),onClick:()=>h(i.id)})})}),e.jsx(M,{permission:"authorization:role:delete",children:e.jsx(Y,{title:s("role.delete",{defaultValue:"Delete Role"}),children:e.jsx(ve,{title:s("role.deleteConfirm",{defaultValue:"Are you sure you want to delete this role?"}),onConfirm:()=>c(i.id),okText:o("confirm",{defaultValue:"Confirm"}),cancelText:o("cancel",{defaultValue:"Cancel"}),children:e.jsx(j,{type:"text",size:"small",danger:!0,icon:e.jsx(Ae,{})})})})})]})}];return e.jsx("div",{children:e.jsxs(J,{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:16},children:e.jsxs(Pe,{justify:"space-between",align:"middle",gutter:16,children:[e.jsx(Z,{children:e.jsx(P,{children:e.jsx(j,{type:"primary",onClick:()=>{var r,i;(i=(r=p.current)==null?void 0:r.reload)==null||i.call(r)},icon:e.jsx(we,{}),children:o("refresh",{defaultValue:"Refresh"})})})}),e.jsx(Z,{children:e.jsx(M,{permission:"authorization:role:create",children:e.jsx(j,{type:"primary",icon:e.jsx(Te,{}),onClick:()=>V("/authorization/roles/create"),children:s("role.create",{defaultValue:"Create Role"})})})})]})}),e.jsx(qe,{request:async({page_size:r,current:i})=>R.authorization.listRoles({current:i,page_size:r}),columns:w,actionRef:p})]})})},Ke=Object.freeze(Object.defineProperty({__proto__:null,default:Le},Symbol.toStringTag,{value:"Module"})),{TextArea:le}=ae,Ge=Ie(({css:s})=>({rolePermissionExtra:s`
      float: right;
      z-index: 1001;
      position: sticky;
    `,rolePolicyExtra:s`
      position: absolute;
      right: 5px;
      top: 5px;
    `})),Me={allow_all:{policy:{Statement:[{Effect:"Allow",Action:["*"]}]}},deny_all:{Statement:[{Effect:"Deny",Action:["*"]}]},allow_with_action:{Statement:[{Effect:"Allow",Action:["authorization:user:view"]}]},allow_with_condition:{Statement:[{Effect:"Allow",Action:["authorization:user:update"],Condition:{StringEquals:{"id:":"abcdef"}}},{Effect:"Deny",Action:["*"]}]},allow_with_uri:{Statement:[{Effect:"Allow",Action:["authorization:user:view"],Condition:{StringEquals:{"http.uri":"/api/users/abcdef","http.method":"GET"}}},{Effect:"Deny",Action:["*"]}]}},te=JSON.stringify({Statement:[]},null,2),Je=()=>{const{styles:s}=Ge(),{t:o}=C("authorization"),{t:f}=C("common"),V=oe(),{id:p}=ke(),h=!!p,{siteConfig:c}=ie(),{user:w}=$e(),r=(w==null?void 0:w.organizations)||[],[i]=x.useForm(),[u,z]=n.useState([]),[T,re]=n.useState([]),[ne,O]=n.useState([]),[se,F]=n.useState(!0),[B,_]=n.useState([]),[I,y]=n.useState({}),D=n.useRef({}),[de,U]=n.useState(!1),[g,N]=n.useState("global"),[q,ce]=n.useState(void 0),[ue,W]=n.useState(!1),[me,H]=n.useState(!1);n.useEffect(()=>{D.current=I},[I]),n.useEffect(()=>{ce(localStorage.getItem("orgID")||void 0)},[]);const K=n.useCallback(async()=>{try{const t=await R.authorization.listPermissions();re(t.map((l,a)=>{const d=(l.permissions||[]).map(m=>({key:m.id,code:m.code.replace(/:/g,"."),title:m.name,orgPermission:m.org_permission||!1}));return{key:`[group]-${a}`,title:l.name,code:l.name.replace(/ /g,"_"),children:d}}))}catch{b.error(o("role.loadError",{defaultValue:"Failed to load role list"}))}},[o]);n.useEffect(()=>{K()},[K]);const E=n.useCallback(async(t,l)=>{if(!t){_([]),y(l||{});return}U(!0);try{const d=((await R.system.listToolSets({page_size:1e3,include_tools:!0},{headers:{"X-Scope-OrgID":t}})).data||[]).filter(S=>S.status==="enabled");_(d);const m=l||D.current||{},v={};d.forEach(S=>{const $=m[S.id]||[];v[S.id]=$.filter(je=>(S.tools||[]).some(Ve=>Ve.name===je))}),y(v)}catch{b.error(o("role.loadAiToolsetsError",{defaultValue:"Failed to load AI toolsets."})),_([]),y(l||{})}finally{U(!1)}},[o]),fe=t=>t?t.reduce((l,a)=>(!a.toolset_id||!a.tool_name||(l[a.toolset_id]||(l[a.toolset_id]=[]),l[a.toolset_id].includes(a.tool_name)||l[a.toolset_id].push(a.tool_name)),l),{}):{},X=n.useCallback(async t=>{var l;W(!0);try{const a=await R.authorization.getRole({id:t}),d=((l=a.permissions)==null?void 0:l.map($=>$.id))||[];z(d),i.setFieldsValue({permissions:d});const m=a.organization_id||"",v=m?"organization":"global";N(v);const S=fe(a.ai_tool_permissions);v==="organization"&&m?await E(m,S):(_([]),y({})),i.setFieldsValue({name:a.name,description:a.description,role_type:v,organization_id:m||void 0,policy_document:JSON.stringify(a.policy_document||{Statement:[]},null,2)})}catch{b.error(o("role.detailLoadError",{defaultValue:"Failed to load role details"})),V("/authorization/roles")}finally{W(!1)}},[E,i,V,o]);n.useEffect(()=>{if(h&&p){X(p);return}const t=q||(r.length>0?r[0].id:""),l=c!=null&&c.enable_multi_org&&t?"organization":"global";N(l),i.setFieldsValue({role_type:l,organization_id:l==="organization"?t:void 0,policy_document:te,permissions:[]}),z([]),y({}),l==="organization"&&t?E(t,{}):_([])},[E,i,p,h,r,q,c==null?void 0:c.enable_multi_org,X]);const pe=n.useMemo(()=>g==="global"?T:T.map(l=>{const a=(l.children||[]).filter(d=>d.orgPermission===!0);return{...l,children:a}}).filter(l=>l.children&&l.children.length>0),[T,g]),he=t=>{O(t),F(!1)},ge=()=>{const t=T.map(l=>l.key);O(t),F(!0)},ye=()=>{O([]),F(!1)},xe=n.useCallback((t,l)=>{y(a=>({...a,[t]:l}))},[]),_e=(t,l)=>{if(g==="organization")return Promise.resolve();if(!l||l.trim()===""||l==="{}"||l==='{"Statement":[]}')return u.length===0?Promise.reject(new Error(o("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."}))):Promise.resolve();try{return JSON.parse(l),Promise.resolve()}catch{return Promise.reject(new Error(o("role.invalidJsonFormat",{defaultValue:"Invalid JSON format."})))}},be=async t=>{const l={...t};try{g==="global"?l.policy_document=JSON.parse(t.policy_document??"{}"):l.policy_document={Statement:[]},l.role_type==="organization"?l.organization_id=l.organization_id||void 0:l.organization_id=void 0,delete l.role_type;const a=g==="organization"?Object.entries(I).map(([d,m])=>({toolset_id:d,tools:Array.from(new Set(m))})).filter(d=>d.tools.length>0):[];l.ai_tool_permissions=a,l.permissions=u.filter(d=>!d.startsWith("[group]-")),H(!0),h&&p?(await R.authorization.updateRole({id:p},l),b.success(o("role.updateSuccess",{defaultValue:"Role updated successfully."}))):(await R.authorization.createRole(l),b.success(o("role.createSuccess",{defaultValue:"Role created successfully."}))),V("/authorization/roles")}catch{b.error(o("role.saveError",{defaultValue:"Failed to save role.",action:h?f("update",{defaultValue:"Update"}):f("create",{defaultValue:"Create"})}))}finally{H(!1)}};return e.jsx(J,{title:h?o("role.editTitle",{defaultValue:"Edit Role"}):o("role.createTitle",{defaultValue:"Create Role"}),loading:ue,children:e.jsxs(x,{form:i,layout:"vertical",initialValues:{policy_document:te,permissions:[]},onFinish:be,children:[e.jsx(Ce,{items:[{key:"basic",label:o("role.basicInfo",{defaultValue:"Basic Information"}),children:e.jsxs(e.Fragment,{children:[e.jsx(x.Item,{label:o("role.name",{defaultValue:"Role Name"}),name:"name",rules:[{required:!0,message:o("role.nameRequired",{defaultValue:"Please enter the role name."})}],children:e.jsx(ae,{placeholder:o("role.namePlaceholder",{defaultValue:"Enter role name"})})}),e.jsx(x.Item,{label:o("role.description",{defaultValue:"Description"}),name:"description",children:e.jsx(le,{rows:4,placeholder:o("role.descriptionPlaceholder",{defaultValue:"Enter role description"})})}),e.jsx(x.Item,{label:o("role.roleType",{defaultValue:"Role Type"}),name:"role_type",hidden:!(c!=null&&c.enable_multi_org),rules:[{required:!0,message:o("role.roleTypeRequired",{defaultValue:"Please select role type."})}],extra:h?o("role.roleTypeCannotChange",{defaultValue:"Role type cannot be changed after creation."}):"",children:e.jsxs(G.Group,{disabled:h,onChange:t=>{const l=t.target.value;if(N(l),l==="global")i.setFieldsValue({organization_id:void 0}),_([]),y({});else{const a=q||(r.length>0?r[0].id:"");i.setFieldsValue({organization_id:a}),a?E(a,D.current):(_([]),y({}))}z([]),i.setFieldsValue({permissions:[]})},children:[e.jsx(G,{value:"global",children:o("role.globalRole",{defaultValue:"Global Role"})}),e.jsx(G,{value:"organization",children:o("role.organizationRole",{defaultValue:"Organization Role"})})]})}),g==="organization"&&e.jsx(x.Item,{hidden:!(c!=null&&c.enable_multi_org),label:o("role.organization",{defaultValue:"Organization"}),name:"organization_id",rules:[{required:!0,message:o("role.organizationRequired",{defaultValue:"Please select an organization."})}],extra:r.length>0?o("role.organizationHelp",{defaultValue:"Select the organization this role belongs to"}):o("role.noOrganizationsAvailable",{defaultValue:"No organizations available. Please contact your administrator."}),children:r.length>0?e.jsx(k,{placeholder:o("role.selectOrganization",{defaultValue:"Select Organization"}),onChange:t=>{z([]),i.setFieldsValue({permissions:[]});const l=t||"";l?E(l,{}):(_([]),y({}))},children:r.map(t=>e.jsx(k.Option,{value:t.id,children:t.name},t.id))}):e.jsx(k,{disabled:!0,placeholder:o("role.noOrganizationsAvailable",{defaultValue:"No organizations available"})})})]})},{key:"permissions",label:o("role.permissions",{defaultValue:"Permissions"}),children:e.jsx(x.Item,{name:"permissions",rules:[{validator(){if(u.length===0)if(g==="global"){const t=i.getFieldValue("policy_document");if(!t||t.trim()===""||t==="{}"||t==='{"Statement":[]}')return Promise.reject(new Error(o("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."})))}else return Promise.reject(new Error(o("role.permissionRequired",{defaultValue:"Please select at least one permission."})));return Promise.resolve()}}],children:e.jsx("div",{children:e.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",border:"1px solid #d9d9d9",borderRadius:"4px"},children:[e.jsxs("span",{className:s.rolePermissionExtra,children:[e.jsx(j,{type:"link",onClick:ge,icon:e.jsx(Oe,{}),children:f("expandAll",{defaultValue:"Expand All"})}),e.jsx(j,{type:"link",onClick:ye,icon:e.jsx(Fe,{}),children:f("collapseAll",{defaultValue:"Collapse All"})})]}),e.jsx(De,{treeData:pe,titleRender:t=>{const l=t,a=typeof l.title=="string"?l.title:String(l.title??"");return e.jsx("span",{children:o(`permission.title.${l.code}`,{defaultValue:a})})},checkable:!0,expandedKeys:ne,autoExpandParent:se,onExpand:he,checkedKeys:u,onCheck:t=>{let l=[];Q.isArray(t)?l=t:Q.has(t,"checked")&&(l=t.checked),z(l),i.setFieldsValue({permissions:l})}})]})})})},{key:"ai-tools",label:o("role.aiPermissions",{defaultValue:"AI Tool Permissions"}),disabled:g==="global",children:e.jsx(Ne,{spinning:de,children:g==="organization"?B.length>0?e.jsx(P,{direction:"vertical",size:"middle",style:{width:"100%"},children:B.map(t=>e.jsx(J,{size:"small",title:t.name,extra:t.description?e.jsx("span",{children:t.description}):void 0,children:(t.tools||[]).length>0?e.jsx(ee.Group,{style:{width:"100%"},value:I[t.id]||[],onChange:l=>xe(t.id,l),children:e.jsx(P,{direction:"vertical",style:{width:"100%"},children:(t.tools||[]).map(l=>e.jsx(ee,{value:l.name,children:e.jsxs("div",{children:[e.jsx("div",{children:l.name}),l.description&&e.jsx("div",{style:{color:"rgba(0,0,0,0.45)",fontSize:12},children:l.description})]})},l.name))})}):e.jsx(A,{image:A.PRESENTED_IMAGE_SIMPLE,description:o("role.aiToolsetNoTools",{defaultValue:"No tools available in this toolset."})})},t.id))}):e.jsx(A,{image:A.PRESENTED_IMAGE_SIMPLE,description:o("role.aiToolsetsEmpty",{defaultValue:"No AI toolsets available for this organization."})}):e.jsx(A,{image:A.PRESENTED_IMAGE_SIMPLE,description:o("role.aiPermissionsGlobalInfo",{defaultValue:"AI tool permissions are only available for organization roles."})})})},{key:"policy",label:o("role.policyDocument",{defaultValue:"Policy Document"}),disabled:g==="organization",children:e.jsx(x.Item,{name:"policy_document",rules:[{validator:_e}],extra:e.jsx("span",{className:s.rolePolicyExtra,children:e.jsx(k,{style:{width:160},placeholder:o("role.insertTemplate",{defaultValue:"Insert Template"}),options:[{label:o("role.allowAll",{defaultValue:"Allow All"}),value:"allow_all"},{label:o("role.denyAll",{defaultValue:"Deny All"}),value:"deny_all"},{label:o("role.allowWithAction",{defaultValue:"Allow with Action"}),value:"allow_with_action"},{label:o("role.denyWithCondition",{defaultValue:"Allow with Condition"}),value:"allow_with_condition"},{label:o("role.allowWithUri",{defaultValue:"Allow with URI"}),value:"allow_with_uri"}],onChange:t=>{if(typeof t=="string"){const l=Me[t];l&&i.setFieldValue("policy_document",JSON.stringify(l,null,2))}}})}),children:e.jsx(le,{rows:15,style:{fontFamily:"monospace"},placeholder:`{
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "account:EnableRegion",
                "account:DisableRegion"
            ],
            "Condition": {
                "StringEquals": {"id:": "abcdef"}
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "*"
            ]
        }
    ]
}`})})}]}),e.jsx(x.Item,{children:e.jsxs(P,{children:[e.jsx(j,{type:"primary",htmlType:"submit",loading:me,children:h?f("update",{defaultValue:"Update"}):f("create",{defaultValue:"Create"})}),e.jsx(j,{onClick:()=>V("/authorization/roles"),children:f("cancel",{defaultValue:"Cancel"})})]})})]})})},Xe=Object.freeze(Object.defineProperty({__proto__:null,default:Je},Symbol.toStringTag,{value:"Module"}));export{Ke as R,Xe as a};
