import{r as o,e as D,j as E,t as U}from"./vendor.XZpclBr-.js";import{a as v}from"./index.bU_rPqdB.js";import{c as P,a as T}from"./client.CQPv28OP.js";const b=o.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),F=()=>o.useContext(b),_=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),P.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete P.defaults.headers.common.Authorization)},q=({children:e})=>{const[t,n]=o.useState(void 0),[A,a]=o.useState(localStorage.getItem("token")),[g,f]=o.useState(!0),{run:d}=D(async()=>{const i=localStorage.getItem("token");return i?(_(i,!1),v.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:i=>{n(i)},onError:i=>{console.error("Failed to get current user:",i),k()},onFinally:()=>{f(!1)}});o.useEffect(()=>{d()},[]);const r=async i=>{try{const s=await v.authorization.login(i),{token:c,user:l,needs_mfa:y,password_expired:m,mfa_token:C,mfa_type:h}=s;if(y)throw{needsMFA:!0,mfaToken:C,mfaType:h,user:l};if(m)throw{password_expired:!0,user:l,token:c};return _(c),a(c),n(l),l}catch(s){throw s&&s.needsMFA||s&&s.password_expired||U.error("Login failed, please check your username and password"),s}},u=o.useCallback(async i=>{try{const s=await v.oauth.handleCallback(i);let c="",l=null;if(s&&typeof s=="object")if("code"in s&&s.code==="0"&&"data"in s){const{token:y,user:m,needs_mfa:C,mfa_token:h,mfa_type:p}=s.data;if(C)throw{needsMFA:!0,mfaToken:h,mfaType:p,user:m};c=y,l=m}else{const{token:y,user:m,needs_mfa:C,mfa_token:h,mfa_type:p}=s;if(C)throw{needsMFA:!0,mfaToken:h,mfaType:p,user:m};c=y,l=m}return _(c),a(c),n(l),l}catch(s){throw s&&s.needsMFA||s&&s.passwordExpired,s}},[]),k=()=>{v.authorization.logout(),_(null),a(null),n(null)},I=i=>{n(i)};return E.jsx(b.Provider,{value:{user:t,token:A,loading:g,login:r,oauthLogin:u,logout:k,updateUser:I},children:e})},J=()=>{const e=o.useContext(b);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},M=o.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),K=()=>o.useContext(M),N=({children:e})=>{const{user:t}=F(),{data:n=null,loading:A,runAsync:a}=D(async()=>v.system.getSiteConfig(),{manual:!0});o.useEffect(()=>{t!==void 0&&a()},[t]);const[g,f]=o.useState(null);return o.useEffect(()=>{g?localStorage.setItem("orgID",g):localStorage.removeItem("orgID")},[g]),o.useEffect(()=>{var r,u,k;let d=localStorage.getItem("orgID");if(d){const I=(r=t==null?void 0:t.organizations)==null?void 0:r.find(i=>i.id===d);if(I){f(I.id);return}}f(((k=(u=t==null?void 0:t.organizations)==null?void 0:u[0])==null?void 0:k.id)??null)},[n,t==null?void 0:t.organizations]),E.jsx(M.Provider,{value:{siteConfig:n,loading:A,enableMultiOrg:(n==null?void 0:n.enable_multi_org)??!1,fetchSiteConfig:a,currentOrgId:g,setCurrentOrgId:d=>{f(d)},clearCurrentOrgId:()=>{f(null)}},children:e})},H=()=>{var d;const{user:e}=o.useContext(b),{currentOrgId:t}=K(),n=(d=e==null?void 0:e.roles)==null?void 0:d.filter(r=>!r.organization_id||r.organization_id===t),A=()=>n?n.some(r=>r.name==="admin"&&!r.organization_id):!1,a=r=>n?A()?!0:n.some(u=>u.permissions?u.permissions.some(k=>k.code===r):!1):!1;return{hasPermission:a,hasAllPermissions:r=>r.every(u=>a(u)),hasAnyPermission:r=>r.some(u=>a(u)),isAdmin:A(),loading:!e}},L=o.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{},callAI:()=>{},onCallAI:e=>{}}),Q=()=>o.useContext(L),W=({children:e})=>{const[t,n]=o.useState("sidebar"),[A,a]=o.useState(!1),[g,f]=o.useState(null),d=(r,u)=>{g&&g(r,u)};return E.jsx(L.Provider,{value:{layout:t,setLayout:r=>{n(r)},visible:A,setVisible:r=>{a(r)},callAI:d,onCallAI:r=>{f(r)}},children:e})},z=new Map,j=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),S=(e,t)=>{const n=z.get(e);return n?t&&t>0&&Date.now()-n.timestamp>t*1e3?(z.delete(e),null):n.data:null},G=(e,t)=>{z.set(e,{data:t,timestamp:Date.now()})},X=(e,t,n)=>{const[A,a]=o.useState(t||[]),[g,f]=o.useState(!1),[d,r]=o.useState(null),[u,k]=o.useState(0),I=()=>k(s=>s+1),i=o.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(s=>n&&n[s]!==void 0&&n[s]!==null):!0,[e,n]);return o.useEffect(()=>{if(!i){a(t||[]);return}(async()=>{try{f(!0),r(null);const c=j(e,n);if(e.cache){const y=S(c,e.cache_ttl);if(y){a(y),f(!1);return}}let l=[];switch(e.type){case"api":{const y=e.url||"",m=e.method||"GET",C={...n,...e.params};let h;m.toUpperCase()==="GET"?h=await T(y,{params:C}):h=await T(y,{params:C});const p=Array.isArray(h)?h:h.data||[],x=e.label_key||"label",O=e.value_key||"value";l=p.map(w=>({label:w[x]||w.name||w.id,value:w[O]||w.id}));break}case"toolsets":{let m=(await v.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(m=m.filter(p=>Object.entries(e.filter).every(([x,O])=>p[x]===O)));const C=e.label_key||"name",h=e.value_key||"id";l=m.map(p=>({label:p[C]||p.name,value:p[h]||p.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),l=[];break}default:l=t||[]}e.cache&&G(c,l),a(l)}catch(c){console.error("Failed to load options from data source:",c),r(c),a(t||[])}finally{f(!1)}})()},[e,t,n,i,u]),{options:A,loading:g,error:d,refresh:I}};export{q as A,N as S,H as a,K as b,Q as c,X as d,W as e,F as f,J as u};
