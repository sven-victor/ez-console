import{b5 as ae,bj as re,bH as oe,u as se,r as s,aH as d,j as e,au as ne,ao as ie,N as le,aL as O,ai as g,bI as de,bc as ue,bJ as ce,B as $,a0 as me,i as fe,aw as ge,bK as he,s as q,bL as pe}from"./vendor.C3-MmzV0.js";import{a as xe,c as we}from"./contexts.iC19SFuN.js";import{a as U}from"./index.DucLT2Yo.js";import{A as C}from"./client.DfIbwIFN.js";import{L as M,a as je,b as ye}from"./components.CZDl6p1u.js";import{m as be,g as _e}from"./base.CC34Xq3r.js";import"./vite.BF1G3H_w.js";import"./lodash.B3dv3_Tr.js";import"./highlight.BslI14e2.js";import"./ai.BLyTPS8Y.js";import"./authorization.DyRvPRel.js";import"./system.CoBfIEav.js";import"./oauth.C6OXLVAD.js";import"./ai-chat-layout.C86ek0Gp.js";const{Title:Le}=le,qe=({transformLangConfig:N})=>{const f=ae(),D=re(),[n]=oe(),{login:L,oauthLogin:V,user:I}=xe(),{t:o,i18n:w}=se(),[S,i]=s.useState(null),[j,k]=s.useState({}),[u,h]=s.useState("login"),[H,z]=s.useState(null),[y,J]=s.useState(null),[c,K]=s.useState(null),[p]=d.useForm(),A=s.useRef(!1),[W,T]=s.useState(!1),[v,P]=s.useState([]),[b,_]=s.useState(0),{siteConfig:r,loading:X,error:x}=we(),[Y,E]=s.useState("Loading..."),F=async a=>{const l=async t=>"username"in t?await L({username:t.username,password:t.password}):"mfa_token"in t?await L({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await V({code:t.code,state:t.state,provider:t.provider});try{T(!0);const t=await l(a);if(he(),await new Promise(m=>setTimeout(m,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&D.pathname!=="/profile")f("/profile#mfa");else{const m=n.get("redirect");m?window.location.href=m:r!=null&&r.home_page?window.location.href=r.home_page:f("/")}}catch(t){if(t.password_expired)h("password_expired"),z(t.token),i(null);else if(t.needsMFA)i(null),h("mfa"),f("/login",{replace:!0}),J(t.mfaType),K(t.user),p.setFieldValue("mfa_token",t.mfaToken);else if("username"in a||"mfa_token"in a)if(t instanceof C?i(o("login.error",{defaultValue:"Login failed: {{error}}",error:o(`login.${t}`,{defaultValue:t.message})})):i(typeof t=="string"?t:o("login.error",{defaultValue:"Login failed"})),"mfa_token"in a){_(30);const m=setInterval(()=>{_(B=>B>=1?B-1:0)},1e3);setTimeout(()=>{clearInterval(m),_(0)},3e4)}else"username"in a&&h("login");else t instanceof C?i(o("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:o(`login.${t.code}`,{defaultValue:t.message})})):i(typeof t=="string"?t:o("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),f("/login",{replace:!0}),R()}finally{T(!1)}},R=async()=>{try{P(await U.oauth.getProviders()||[])}catch(a){q.error(o("login.fetchOAuthProvidersError",{defaultValue:"Failed to fetch OAuth providers: {{error}}",error:a.message||a.toString()})),P([])}};s.useEffect(()=>{if(!A.current){A.current=!0;const a=n.get("code"),l=n.get("state"),t=n.get("provider");a&&l&&t?F({code:a,state:l,provider:t}):R()}},[n,V]),s.useEffect(()=>{w.language&&E((r==null?void 0:r.name_i18n[w.language])||(r==null?void 0:r.name)||"")},[r,w.language]);const G=async a=>{try{k({...j,[a]:!0});const{url:l}=await U.oauth.getLoginUrl({provider:a},{headers:{"X-Base-Path":_e()}});window.location.href=l}catch(l){q.error(o("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",l)}finally{k({...j,[a]:!1})}},Q=a=>{switch(a.toLowerCase()){case"github":return e.jsx(pe,{});default:return null}},Z=n.get("code"),ee=n.get("state"),te=n.get("provider");if(s.useEffect(()=>{var a;r&&(E(r.name),window.document.title=r.name,(a=document.getElementById("site-icon"))==null||a.setAttribute("href",r.logo||""))},[r]),X)return e.jsx(M,{});if(!r)return e.jsx(ne,{status:"500",title:"500",subTitle:o("login.fetchSiteConfigError",{defaultValue:"Failed to fetch site config: {{error}}",error:(x==null?void 0:x.message)||x})});if(Z&&ee&&te)return e.jsx(M,{});if(I&&I.status==="active"){const a=n.get("redirect");a?window.location.href=a:r!=null&&r.home_page?window.location.href=r.home_page:f("/")}return e.jsx("div",{children:e.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxs(ie,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsx(je,{transformLangConfig:N})}),e.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsx(Le,{level:2,children:Y}),e.jsx("p",{children:o("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),S&&e.jsx(O,{message:S,type:"error",showIcon:!0,style:{marginBottom:20}}),u==="mfa"&&y&&e.jsx(O,{message:o(`login.mfaTips.${y}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxs(d,{name:"login",initialValues:{remember:!0},onFinish:F,size:"large",form:p,hidden:u==="password_expired",children:[u==="mfa"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{hidden:!(c!=null&&c.email)||y!=="email",children:e.jsx(g,{value:be(c==null?void 0:c.email)})}),e.jsx(d.Item,{name:"mfa_token",hidden:!0,children:e.jsx(g,{})}),e.jsx(d.Item,{name:"mfa_code",hidden:u!=="mfa",children:e.jsx(g,{placeholder:o("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsx(de,{})})})]}),u==="login"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{name:"username",rules:[{required:!0,message:o("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsx(g,{prefix:e.jsx(ue,{}),placeholder:o("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsx(d.Item,{name:"password",rules:[{required:!0,message:o("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsx(g.Password,{prefix:e.jsx(ce,{}),placeholder:o("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsx(d.Item,{children:e.jsx($,{disabled:b>0,type:"primary",htmlType:"submit",loading:W,block:!0,children:b>0?e.jsxs("span",{style:{marginLeft:8},children:[b,"s"]}):o("login.login",{defaultValue:"Login"})})})]}),v.length>0&&u!=="password_expired"&&e.jsxs(e.Fragment,{children:[e.jsx(me,{children:o("login.or",{defaultValue:"Or"})}),e.jsx(fe,{direction:"vertical",style:{width:"100%"},children:v.map(a=>e.jsx($,{icon:Q(a.name),onClick:()=>G(a.name),loading:j[a.name],block:!0,children:a.icon_url?e.jsx(ge,{src:a.icon_url}):o("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:a.display_name})},a.name))})]}),u==="password_expired"&&e.jsx(ye,{onSuccess:()=>{h("login"),p.setFieldValue("password",""),p.setFieldValue("mfa_code","")},token:H||void 0})]})})})};export{qe as default};
