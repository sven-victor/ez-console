var ye=Object.defineProperty;var je=(t,s,a)=>s in t?ye(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a;var ae=(t,s,a)=>je(t,typeof s!="symbol"?s+"":s,a);import{j as e,S as q,N as ne,c as W,D as ve,d as Se,u as A,A as be,r as d,I as we,U as Ie,M as X,l as Ce,e as T,P as ke,R as Fe,f as _e,L as Ae,g as le,h as Le,T as ce,F as Re,k as Te,m as ze,n as j,o as z,p as C,s as w,q as Pe,C as U,t as re,v as De,w as $e,x as Me,y as Be,z as ie,Q as Ee,E as de,G as Ne,H as $,J as Ve,K as qe,O as He,V as Ue,W as Ke,X as K,Y as ee,Z as We,_ as se,$ as oe,a0 as V,a1 as te,a2 as Xe,a3 as Ye,a4 as Oe,a5 as Ge,a6 as Je,a7 as Qe,a8 as Ze,a9 as et,aa as tt,ab as st,ac as G,ad as at,ae as nt,af as rt,ag as it}from"./vendor.C8a5MByN.js";import{u as ot,a as ue}from"./contexts.CcPUYWrH.js";import{g as lt,f as ct}from"./base.Cg9ThmJN.js";import{_ as dt}from"./vite.BF1G3H_w.js";import{a as I,w as ut}from"./index.BGMWJ85B.js";import{b as J,A as mt}from"./client.RnZXtcm2.js";const ht=()=>e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",width:"100%"},children:e.jsx(q,{size:"large"})}),qt=({element:t,requiredPermission:s,requiredPermissions:a})=>{const{user:n,loading:o}=ot(),{hasPermission:r,hasAllPermissions:u}=ue();return o?e.jsx(ht,{}):n?s&&!r(s)?e.jsx(ne,{to:"/forbidden",replace:!0}):a&&!u(a)?e.jsx(ne,{to:"/forbidden",replace:!0}):t:(window.location.href=lt("/login?redirect="+encodeURIComponent(window.location.href)),null)},pt=W(({token:t,css:s})=>({container:s`
      ${s`
        @media screen and (max-width: ${t.screenXS}px) {
          width: 100% !important;
          > * {
            border-radius: 0 !important;
          }
        }
      `}
    > *{
      background-color: ${t.colorBgElevated};
      border-radius: 4px;
      box-shadow: ${t.boxShadowTertiary};
    }
    `,iconStyle:{cursor:"pointer",padding:"12px",display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:18,verticalAlign:"middle","&:hover":{color:t.colorPrimaryTextHover}}})),ft=({overlayClassName:t,overlay:s,hidden:a,children:n,...o})=>{if(a)return e.jsx(e.Fragment,{});const{styles:r}=pt();return e.jsx(ve,{dropdownRender:s,overlayClassName:Se(r.container,t),...o,children:e.jsx("span",{className:r.iconStyle,children:n})})},gt=()=>e.jsxs("svg",{viewBox:"0 0 24 24",focusable:"false",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true",children:[e.jsx("path",{d:"M0 0h24v24H0z",fill:"none"}),e.jsx("path",{d:"M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z ",className:"css-c4d79v"})]}),xt=W(()=>({menuItemStyle:{minWidth:"160px"},menuItemIconStyle:{marginRight:"8px"}})),yt=[{lang:"en-US",label:"English",icon:"ðŸ‡ºðŸ‡¸"},{lang:"sv-SE",label:"Svenska",icon:"ðŸ‡¸ðŸ‡ª"},{lang:"ar-AE",label:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",icon:"ðŸ‡¦ðŸ‡ª"},{lang:"de-DE",label:"Deutsch",icon:"ðŸ‡©ðŸ‡ª"},{lang:"es-ES",label:"EspaÃ±ol",icon:"ðŸ‡ªðŸ‡¸"},{lang:"fr-FR",label:"FranÃ§ais",icon:"ðŸ‡«ðŸ‡·"},{lang:"zh-CN",label:"ä¸­æ–‡",icon:"ðŸ‡¨ðŸ‡³"}],Ht=({transformLangConfig:t=s=>s})=>{const{i18n:s}=A(),{styles:a}=xt(),n=r=>{s.changeLanguage(r)},o={selectedKeys:[s.language],onClick:r=>{n(r.key)},items:t(yt).map(r=>({key:r.lang,className:a.menuItemStyle,label:e.jsxs(e.Fragment,{children:[e.jsx("span",{role:"img","aria-label":(r==null?void 0:r.label)||"en-US",className:a.menuItemIconStyle,children:(r==null?void 0:r.icon)||"ðŸŒ"}),(r==null?void 0:r.label)||"en-US"]})}))};return e.jsx(ft,{menu:o,children:e.jsx(gt,{})})},jt=W(({css:t})=>({avatarItem:t`
    :hover {
      background: rgba(0, 0, 0, 0.12);
    }
    padding: 5px;
  `})),me=t=>Ce.isString(t)&&t.match(/^[-_a-zA-Z0-9]+$/)?J.endsWith("/")?J+`files/${t}`:J+`/files/${t}`:t,vt=({src:t,...s})=>e.jsx(be,{src:me(t),...s}),St=({onChange:t,shape:s="square"})=>{const[a,n]=d.useState([]),{styles:o}=jt(),[r,u]=d.useState(!1),[i,f]=d.useState(!0),[x,v]=d.useState(0),{run:m,loading:h}=T(()=>I.base.listFiles({current:x+1,page_size:40,file_type:"avatar",access:"public",search:""}),{manual:!0,onSuccess:({data:c})=>{n([...a,...c]),f(c.length===40),v(x+1)}}),_=()=>{f(!0),v(0),n([])};return e.jsx(ke,{style:{zIndex:1e3},onOpenChange:c=>{u(c),c?m():_()},open:r,content:e.jsx("div",{style:{width:360,height:200},children:e.jsx("div",{id:"iconsScrollableDiv",style:{height:"100%",overflow:"auto"},children:e.jsx(_e,{dataLength:a.length,next:()=>{m()},hasMore:i,loader:e.jsx(Le,{avatar:!0,paragraph:{rows:1},active:!0}),endMessage:e.jsx(le,{plain:!0,children:"End"}),scrollableTarget:"iconsScrollableDiv",children:e.jsx(Ae,{grid:{gutter:16,column:8},dataSource:a,style:{margin:"0 8px"},loading:h,renderItem:({id:c})=>e.jsx("div",{className:o.avatarItem,onClick:S=>{S.stopPropagation(),t==null||t(c),u(!1),_()},children:e.jsx(vt,{shape:s,src:c})})})})})}),placement:"bottom",trigger:"hover",children:e.jsx(Fe,{shape:s,style:{width:112,height:112,placeContent:"center"}})})},bt=({value:t,onChange:s,shape:a,...n})=>{const[o,r]=d.useState(void 0),[u,i]=d.useState(!1),[f,x]=d.useState(void 0),v=async m=>{i(!0),x(m.url??m.preview)};return d.useEffect(()=>{r(t?{uid:t,name:t,url:me(t)}:void 0)},[t]),e.jsxs(e.Fragment,{children:[e.jsx(we,{beforeCrop:async m=>{if(m.type==="image/svg+xml"){const h=await I.base.uploadFile({type:"avatar"},m);return h.length>0&&(s==null||s(h[0].id)),!1}return!0},children:e.jsx(Ie,{customRequest:async m=>{var _,c;const h=await I.base.uploadFile({type:"avatar",access:"public"},m.file);h.length>0?((_=m.onSuccess)==null||_.call(m,h[0].id),s==null||s(h[0].id)):(c=m.onError)==null||c.call(m,new Error("Upload file failed"))},listType:"picture-card",onPreview:v,maxCount:1,onChange:({file:m})=>{switch(m.status){case"removed":s==null||s(void 0);break;case"done":break;default:r(m);break}},fileList:o?[o]:[],...n,children:o?void 0:e.jsx(St,{shape:a,onChange:s})})}),e.jsx(X,{open:u,footer:null,onCancel:()=>i(!1),children:e.jsx("img",{style:{width:"100%"},src:f})})]})},wt=d.lazy(()=>dt(()=>Promise.resolve().then(()=>Pt),void 0)),Ut=()=>{const{t}=A("ai"),[s,a]=d.useState(!1),n=()=>{a(!0)},o=()=>{a(!1)};return console.log(s),e.jsxs(e.Fragment,{children:[e.jsx(ce,{title:t("chat.openAssistant",{defaultValue:"Open AI Assistant"}),placement:"left",children:e.jsx(Re,{icon:e.jsx(Te,{}),type:"primary",onClick:n,style:{right:24,bottom:24}})}),e.jsx(X,{width:1200,open:s,onCancel:o,footer:null,children:ut(wt)})]})},It=ze,Ct=t=>It[t],Kt=({iconName:t})=>{if(!t)return null;const s=Ct(t);return s?e.jsx(d.Suspense,{fallback:null,children:e.jsx(s,{})}):null},Wt=({onSuccess:t,token:s})=>{const{t:a}=A("authorization"),{t:n}=A("common"),[o]=j.useForm(),{run:r,loading:u}=T(async i=>I.authorization.changePassword(i,s?{headers:{Authorization:`Bearer ${s}`}}:{}),{manual:!0,onSuccess:()=>{w.success(a("user.passwordChanged")),o.resetFields(),t==null||t()},onError:i=>{if(i instanceof mt){const f=i.code??"normal";w.error(a(`user.passwordChangeFailed.${f}`,{error:i.message,defaultValue:"Password change failed: {{error}}"}))}else w.error(a("user.passwordChangeFailed.normal",{error:i.message,defaultValue:"Password change failed: {{error}}"}));console.error("Failed to change password:",i)}});return e.jsxs(j,{form:o,layout:"vertical",onFinish:r,style:{maxWidth:500,margin:"0 auto"},children:[e.jsx(j.Item,{name:"old_password",label:a("user.oldPassword"),rules:[{required:!0,message:a("validation.oldPasswordRequired")}],children:e.jsx(z.Password,{})}),e.jsx(j.Item,{name:"new_password",label:a("user.newPassword"),rules:[{required:!0,message:a("validation.newPasswordRequired")},{min:8,message:a("validation.passwordMinLength")}],children:e.jsx(z.Password,{})}),e.jsx(j.Item,{name:"confirm_password",label:a("user.confirmPassword"),rules:[{required:!0,message:a("validation.confirmPasswordRequired")},({getFieldValue:i})=>({validator(f,x){return!x||i("new_password")===x?Promise.resolve():Promise.reject(new Error(a("validation.passwordMismatch")))}})],children:e.jsx(z.Password,{})}),e.jsx(j.Item,{children:e.jsx(C,{type:"primary",htmlType:"submit",loading:u,children:n("save")})})]})},Xt=({user:t,onSuccess:s})=>{const{t:a}=A("authorization"),{t:n}=A("common"),[o]=j.useForm(),[r,u]=d.useState(!1);Pe.useEffect(()=>{t&&o.setFieldsValue({username:t.username,email:t.email,full_name:t.full_name,phone:t.phone||"",avatar:t.avatar})},[t,o]);const i=async f=>{try{u(!0),await I.authorization.updateCurrentUser(f),w.success(n("updateSuccess")),s()}catch(x){w.error(n("updateFailed")),console.error("Failed to update user information:",x)}finally{u(!1)}};return e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs("div",{style:{marginBottom:24,textAlign:"center"},children:[e.jsx("h2",{children:(t==null?void 0:t.full_name)||(t==null?void 0:t.username)}),(t==null?void 0:t.roles)&&t.roles.length>0&&e.jsxs("div",{children:[a("user.roles"),": ",t.roles.map(f=>f.name).join(", ")]})]}),e.jsxs(j,{form:o,layout:"vertical",onFinish:i,style:{width:"100%",maxWidth:500},children:[e.jsx(j.Item,{style:{marginBottom:24,textAlign:"center",justifyItems:"center"},name:"avatar",children:e.jsx(bt,{})}),e.jsx(j.Item,{name:"username",label:a("user.username"),children:e.jsx(z,{disabled:!0})}),e.jsx(j.Item,{name:"email",label:a("user.email"),rules:[{required:!0,message:a("validation.emailRequired")},{type:"email",message:a("validation.emailInvalid")}],children:e.jsx(z,{})}),e.jsx(j.Item,{name:"full_name",label:a("user.fullName"),rules:[{required:!0,message:a("validation.fullNameRequired")}],children:e.jsx(z,{})}),e.jsx(j.Item,{name:"phone",label:a("user.phone"),children:e.jsx(z,{})}),e.jsx(j.Item,{children:e.jsx(C,{type:"primary",htmlType:"submit",loading:r,children:n("save")})})]})]})},Yt=({user:t,onSuccess:s})=>{const{t:a}=A("authorization"),{t:n}=A("common"),[o,r]=d.useState(0),[u,i]=d.useState(!1),[f,x]=d.useState(!0),[v,m]=d.useState(""),[h,_]=d.useState("totp"),{run:c,data:S={secret:"",qr_code:"",token:void 0}}=T(()=>I.authorization.enableMfa(h),{manual:!0,onSuccess:()=>{r(1)},onBefore:()=>{i(!0)},onFinally:()=>{i(!1)}}),B=async()=>{if(!v){w.warning(a("mfa.enterVerificationCode"));return}const k={code:v,mfa_type:h};"token"in S&&(k.token=S.token);try{i(!0),await I.authorization.verifyAndActivateMfa(k),w.success(a("mfa.enableSuccess")),r(2),s()}catch(F){w.error(a("mfa.verificationFailed")),console.error("Failed to verify MFA:",F)}finally{i(!1)}},g=async()=>{try{i(!0),await I.authorization.disableMfa(),w.success(a("mfa.disableSuccess")),s()}catch(k){w.error(n("operationFailed")),console.error("Failed to disable MFA:",k)}finally{i(!1)}},L=()=>{if(!t)return null;if(t.mfa_enabled)return e.jsx(re,{status:"success",title:a("mfa.enabled"),subTitle:a("mfa.enabledDescription"),extra:e.jsx(C,{danger:!0,onClick:()=>{X.confirm({title:a("mfa.confirmDisable"),content:a("mfa.disableWarning"),onOk:g,okButtonProps:{danger:!0}})},children:a("mfa.disable")})});const k=()=>{var F;switch(o){case 0:return e.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsx(ie,{message:e.jsxs("div",{children:[e.jsx("p",{children:a("mfa.setupInfo")}),e.jsx("p",{children:a(h==="totp"?"mfa.totpDescription":"mfa.emailDescription")})]}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsx(C,{type:"primary",onClick:c,loading:u,children:a("mfa.startSetup")})]});case 1:return e.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsx(ie,{message:a("mfa.scanQrCode"),type:"info",showIcon:!0,style:{marginBottom:20,display:h==="totp"?"block":"none"}}),e.jsx("div",{style:{display:h==="totp"?"flex":"none",justifyContent:"center",marginBottom:24},children:e.jsx(Ee,{value:S.qr_code??"",size:200})}),e.jsx("div",{style:{marginBottom:16,display:h==="email"?"block":"none"},children:e.jsxs("p",{children:[a("user.email"),": ",e.jsx("strong",{children:t==null?void 0:t.email})]})}),e.jsx("div",{style:{marginBottom:16,display:h==="totp"?"block":"none"},children:e.jsxs("p",{children:[a("mfa.secretKey"),": ",e.jsx("strong",{children:f?"*".repeat(((F=S.secret)==null?void 0:F.length)??0):S.secret}),e.jsx(C,{type:"link",onClick:()=>x(!f),icon:f?e.jsx(de,{}):e.jsx(Ne,{})})]})}),e.jsx("div",{style:{marginBottom:24},children:e.jsx(z,{placeholder:a("mfa.enterCode"),style:{width:200},maxLength:6,value:v,onChange:D=>m(D.target.value)})}),e.jsxs($,{children:[e.jsx(C,{onClick:()=>r(0),children:n("previous")}),e.jsx(C,{type:"primary",onClick:B,loading:u,children:n("verify")})]})]});case 2:return e.jsx(re,{status:"success",title:a("mfa.setupSuccess"),subTitle:a("mfa.setupSuccessDescription"),extra:e.jsx(C,{type:"primary",onClick:()=>r(0),children:n("done")})});default:return null}};return e.jsxs("div",{children:[e.jsxs("div",{style:{display:o===2?"none":"unset"},children:[e.jsx(De,{defaultValue:"totp",onChange:F=>{_(F),r(0)},value:h,options:[{value:"totp",icon:e.jsx($e,{}),label:a("mfa.totp",{defaultValue:"TOTP"})},{value:"email",icon:e.jsx(Me,{}),label:a("mfa.email",{defaultValue:"E-Mail"})}]}),e.jsx(le,{})]}),e.jsx(Be,{current:o,items:[{title:a(h==="totp"?"mfa.totpStep1":"mfa.emailStep1"),description:a(h==="totp"?"mfa.totpStep1Description":"mfa.emailStep1Description")},{title:a(h==="totp"?"mfa.totpStep2":"mfa.emailStep2"),description:a(h==="totp"?"mfa.totpStep2Description":"mfa.emailStep2Description")},{title:a(h==="totp"?"mfa.totpStep3":"mfa.emailStep3"),description:a(h==="totp"?"mfa.totpStep3Description":"mfa.emailStep3Description")}],style:{marginBottom:30}}),k()]})};return e.jsx(U,{title:a("mfa.title"),children:L()})},{Text:Q}=qe,Ot=()=>{const{t}=A("authorization"),{t:s}=A("common"),[a,n]=d.useState([]),[o,r]=d.useState(!1),[u,i]=d.useState(null),[f,x]=d.useState(!1),v=async()=>{try{r(!0);const c=await I.authorization.getUserSessions({});n(c)}catch(c){w.error(t("session.getSessionsFailed",{error:c,defaultValue:"Failed to get session list: {{error}}"}))}finally{r(!1)}};d.useEffect(()=>{v()},[]);const m=async c=>{try{i(c),await I.authorization.terminateSession({id:c}),n(a.filter(S=>S.id!==c)),w.success(t("session.terminateSuccess",{defaultValue:"Session terminated successfully"}))}catch(S){w.error(t("session.terminateFailed",{error:S,defaultValue:"Failed to terminate session: {{error}}"}))}finally{i(null)}},h=async()=>{try{x(!0),await I.authorization.terminateOtherSessions(),n(a.filter(c=>c.is_current)),w.success(t("session.terminateAllSuccess",{defaultValue:"All other sessions terminated successfully"}))}catch(c){w.error(t("session.terminateAllFailed",{error:c,defaultValue:"Failed to terminate all other sessions: {{error}}"}))}finally{x(!1)}},_=[{title:t("session.device"),dataIndex:"user_agent",key:"device",render:(c,S)=>e.jsxs($,{direction:"vertical",size:0,children:[e.jsxs($,{children:[e.jsx(Ve,{}),e.jsx(Q,{strong:!0,children:c})]}),e.jsxs($,{children:[e.jsx(He,{}),e.jsx(Q,{type:"secondary",children:S.location})]})]})},{title:t("session.ipAddress"),dataIndex:"ip_address",key:"ip_address",render:c=>e.jsxs($,{children:[e.jsx(Ue,{}),e.jsx("span",{children:c})]})},{title:t("session.lastActive"),dataIndex:"last_active_at",key:"last_active",render:c=>e.jsxs($,{children:[e.jsx(Ke,{}),e.jsx("span",{children:new Date(c).toLocaleString()})]})},{title:t("session.status"),key:"status",render:c=>c.is_current?e.jsx(K,{color:"green",children:t("session.current")}):e.jsx(K,{color:"blue",children:t("session.active")})},{title:s("actions"),key:"action",render:c=>c.is_current?e.jsx(Q,{type:"secondary",children:t("session.currentSession")}):e.jsx(ee,{title:t("session.confirmTerminate"),onConfirm:()=>m(c.id),okText:s("confirm"),cancelText:s("cancel"),children:e.jsx(C,{type:"link",danger:!0,loading:u===c.id,children:t("session.terminate")})})}];return e.jsx(U,{title:t("session.title"),extra:a.length>1&&e.jsx(ee,{title:t("session.confirmTerminateAll"),onConfirm:h,okText:s("confirm"),cancelText:s("cancel"),children:e.jsx(C,{danger:!0,loading:f,children:t("session.terminateOthers")})}),children:a.length===0?e.jsx(We,{description:t("session.noSessions")}):e.jsx(se,{columns:_,dataSource:a,rowKey:"id",loading:o,pagination:!1})})},{RangePicker:kt}=Xe,{Option:M}=te,Ft=t=>t||"N/A",_t=(t,s)=>t==="success"?e.jsx(K,{color:"success",children:s("statuses.success")}):e.jsx(K,{color:"error",children:s("statuses.failed")}),Gt=({userId:t,request:s=n=>t?I.authorization.getUserLogs({id:t,...n}):I.authorization.getCurrentUserLogs(n),columnsFilter:a=n=>n})=>{const{t:n}=A("authorization"),{t:o}=A("common"),[r,u]=d.useState({current:1,pageSize:10,total:0}),[i,f]=d.useState({}),[x]=j.useForm(),{loading:v,run:m,data:{data:h}={}}=T(async(g=i,L=1,k=10)=>s({...g,current:L??1,page_size:k??10}),{onError(g){w.error(n("auditLog.fetchFailed",{error:g}))},onSuccess({total:g}){u({...r,total:g})}});d.useEffect(()=>{m(i,1,r.pageSize)},[]);const _=g=>{u({...r,current:g.current,pageSize:g.pageSize}),m({},g.current,g.pageSize)},c=g=>{var L,k,F,D;m({...g,start_time:(k=(L=g.dateRange)==null?void 0:L[0])==null?void 0:k.toISOString(),end_time:(D=(F=g.dateRange)==null?void 0:F[1])==null?void 0:D.toISOString()},1,r.pageSize)},S=()=>{x.resetFields(),f({}),u({...r,current:1}),m({},1,r.pageSize)},B=[{title:n("auditLog.timestamp"),dataIndex:"timestamp",key:"timestamp",render:g=>ct(g)},{title:n("auditLog.action"),dataIndex:"action",key:"action",render:(g,L)=>g?n(`action.${g.replace(":",".")}`,{defaultValue:L.action_name}):L.action_name??L.action},{title:n("auditLog.user_agent"),dataIndex:"user_agent",key:"user_agent"},{title:n("auditLog.ip"),dataIndex:"ip",key:"ip",render:g=>Ft(g)},{title:n("auditLog.status"),dataIndex:"status",key:"status",render:g=>_t(g,n)},{title:n("auditLog.details"),dataIndex:"details",key:"details",render:g=>e.jsx(C,{type:"link",icon:e.jsx(de,{}),onClick:()=>{X.info({title:n("auditLog.details"),content:JSON.stringify(g)})}})}];return e.jsxs("div",{children:[e.jsx(U,{style:{marginBottom:16},children:e.jsxs(j,{form:x,layout:"horizontal",onFinish:c,initialValues:i,children:[e.jsxs(oe,{gutter:24,children:[e.jsx(V,{span:6,children:e.jsx(j.Item,{name:"search",label:n("auditLog.search"),children:e.jsx(z,{placeholder:n("auditLog.searchPlaceholder")})})}),e.jsx(V,{span:6,children:e.jsx(j.Item,{name:"action",label:n("auditLog.action"),children:e.jsxs(te,{allowClear:!0,placeholder:n("auditLog.selectAction"),children:[e.jsx(M,{value:"login",children:n("actions.login")}),e.jsx(M,{value:"logout",children:n("actions.logout")}),e.jsx(M,{value:"password_reset",children:n("actions.passwordReset")}),e.jsx(M,{value:"mfa_change",children:n("actions.mfaChange")})]})})}),e.jsx(V,{span:6,children:e.jsx(j.Item,{name:"status",label:n("auditLog.status"),children:e.jsxs(te,{allowClear:!0,placeholder:n("auditLog.selectStatus"),children:[e.jsx(M,{value:"success",children:n("statuses.success")}),e.jsx(M,{value:"failed",children:n("statuses.failed")})]})})}),e.jsx(V,{span:6,children:e.jsx(j.Item,{name:"dateRange",label:n("auditLog.dateRange"),children:e.jsx(kt,{style:{width:"100%"}})})})]}),e.jsx(oe,{children:e.jsx(V,{span:24,style:{textAlign:"right"},children:e.jsxs($,{children:[e.jsx(C,{onClick:S,children:o("reset")}),e.jsx(C,{type:"primary",htmlType:"submit",icon:e.jsx(Ye,{}),children:o("search")})]})})})]})}),e.jsxs(U,{children:[e.jsx("div",{style:{marginBottom:16},children:e.jsx(C,{type:"primary",icon:e.jsx(Oe,{}),onClick:S,style:{marginRight:8},children:o("refresh")})}),e.jsx(se,{rowKey:"id",columns:a(B),dataSource:h,pagination:{...r,showSizeChanger:!0,showTotal:g=>o("totalItems",{total:g})},loading:v,onChange:_,scroll:{x:"max-content"}})]})]})},At=({permission:t,permissions:s=[],checkAll:a=!1,fallback:n=null,children:o})=>{const{hasPermission:r,hasAnyPermission:u,hasAllPermissions:i,isAdmin:f,loading:x}=ue();return x?null:f?e.jsx(e.Fragment,{children:o}):t?r(t)?e.jsx(e.Fragment,{children:o}):e.jsx(e.Fragment,{children:n}):s.length>0?(a?i(s):u(s))?e.jsx(e.Fragment,{children:o}):e.jsx(e.Fragment,{children:n}):e.jsx(e.Fragment,{children:o})},H=t=>{const[s,a]=d.useState(!1),{permission:n,icon:o,tooltip:r,onClick:u,confirm:i,...f}=t;if(n)return e.jsx(At,{permission:n,children:H({icon:o,tooltip:r,onClick:u,confirm:i,...f})},t.key);if(i)return e.jsx(ee,{title:i.title,onConfirm:i.onConfirm||u,okText:i.okText,cancelText:i.cancelText,children:H({icon:o,tooltip:r,...f})},t.key);if(r)return e.jsx(ce,{title:r,children:H({icon:o,onClick:u,...f})},t.key);const x=u?async()=>{console.log(new Date,"handleClick"),a(!0);try{await u()}finally{a(!1),console.log(new Date,"handleClick1")}}:void 0;return d.createElement(C,{type:"text",size:"small",loading:s,icon:o,onClick:x,...f,key:t.key})},Jt=({actions:t})=>t.filter(s=>!s.hidden).map(s=>H(s)),Lt=({request:t,tableRef:s,...a},n)=>{const[o,r]=d.useState({current:1,pageSize:10}),[u,i]=d.useState(0),{data:f,loading:x,refresh:v}=T(async()=>{const m=await t({current:o.current,page_size:o.pageSize});return i(m.total),m.data},{refreshDeps:[o]});return d.useImperativeHandle(n,()=>({reload:()=>{v()}})),e.jsx(se,{rowKey:"id",loading:x,dataSource:f??[],pagination:{...o,total:u,onChange:(m,h)=>{r({current:m,pageSize:h})}},...a,ref:s})},Qt=({actionRef:t,...s})=>{const[a,n]=d.useState();return d.useEffect(()=>{n(d.forwardRef(Lt))},[]),a?e.jsx(a,{...s,ref:t}):null},Rt=nt({html:!0,breaks:!0}),Tt=W(({token:t,css:s})=>({layout:s`
      width: 100%;
      min-width: 500px;
      height: 70vh;
      display: flex;
      background: ${t.colorBgContainer};
      font-family: AlibabaPuHuiTi, ${t.fontFamily}, sans-serif;
    `,sider:s`
      background: ${t.colorBgLayout}80;
      width: 280px;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 0 12px;
      box-sizing: border-box;
    `,logo:s`
      display: flex;
      align-items: center;
      justify-content: start;
      padding: 0 24px;
      box-sizing: border-box;
      gap: 8px;
      margin: 24px 0;

      span {
        font-weight: bold;
        color: ${t.colorText};
        font-size: 16px;
      }
    `,addBtn:s`
      background: #1677ff0f;
      border: 1px solid #1677ff34;
      height: 40px;
    `,conversationsSpin:s`
      height: 100%;
      overflow-y: auto;
    `,conversations:s`
      flex: 1;
      overflow-y: auto;
      margin-top: 12px;
      padding: 0;

      .ant-conversations-list {
        padding-inline-start: 0;
      }
    `,siderFooter:s`
      border-top: 1px solid ${t.colorBorderSecondary};
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    `,chat:s`
      height: 100%;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      padding-block: ${t.paddingLG}px;
      gap: 16px;
    `,chatPrompt:s`
      .ant-prompts-label {
        color: #000000e0 !important;
      }
      .ant-prompts-desc {
        color: #000000a6 !important;
        width: 100%;
      }
      .ant-prompts-icon {
        color: #000000a6 !important;
      }
    `,chatList:s`
      flex: 1;
      overflow: auto;
    `,loadingMessage:s`
      background-image: linear-gradient(90deg, #ff6b23 0%, #af3cb8 31%, #53b6ff 89%);
      background-size: 100% 2px;
      background-repeat: no-repeat;
      background-position: bottom;
    `,placeholder:s`
      padding-top: 32px;
    `,sender:s`
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
    `,speechButton:s`
      font-size: 18px;
      color: ${t.colorText} !important;
    `,senderPrompt:s`
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      color: ${t.colorText};
    `}));class Z extends Error{constructor(a,n){super(a);ae(this,"buffer");this.buffer=n}}const zt=()=>{const{t}=A(),{styles:s}=Tt(),a=d.useRef(null),[n,o]=d.useState({}),[r,u]=d.useState([]),[i,f]=d.useState(),[x,v]=d.useState(""),[m]=Ge({request:async({message:l,sessionId:p},{onSuccess:y,onUpdate:b,onError:E,onStream:N})=>{if(!p)return;const Y=new AbortController,P={buffer:[],messageID:""};try{N==null||N(Y);const O=await I.ai.streamChat({sessionId:p},{content:l.content},{signal:Y.signal,requestType:"sse"});for await(const xe of Je({readableStream:O})){const R=JSON.parse(xe.data);if(R.event_type,R.event_type==="error"){E(new Z(R.content,P.buffer));return}R.event_type==="content"&&(P.messageID===""&&(P.messageID=R.message_id),P.messageID!==R.message_id&&(P.messageID=R.message_id),P.buffer.push(R.content),b(R.content))}y(P.buffer)}catch(O){E(new Z(`${O}`,P.buffer)),Y.abort()}}}),h=m.isRequesting(),{loading:_}=T(async()=>{const l=await I.ai.listChatSessions({current:1,page_size:20});u(l.data)}),{run:c,loading:S}=T(async l=>(console.log("new chat ",l),await I.ai.createChatSession({title:"New Conversation",model_id:""})),{manual:!0,onSuccess:(l,[p])=>{u(y=>[...y,{...l,loading:!1}]),f(l.id),D([]),p&&k({stream:!0,message:{role:"user",content:p},sessionId:l.id})}}),{run:B}=T(async l=>await I.ai.deleteChatSession({sessionId:l}),{manual:!0,onError(l,p){w.error(t("ai.chat.deleteConversationFailed",{defaultValue:"Failed to delete conversation."})),u(y=>y.map(b=>b.id===p[0]?{...b,loading:!1}:b))},onSuccess(l,p){var E;const y=r.filter(N=>N.id!==p[0]),b=(E=y==null?void 0:y[0])==null?void 0:E.id;u(y),p[0]===i&&f(b)}}),{run:g,loading:L}=T(async l=>await I.ai.getChatSession({sessionId:l}),{manual:!0,onSuccess:(l,[p])=>{o(y=>({...y,[p]:l.messages.filter(b=>b.role!=="tool").map(b=>({id:b.id,message:{content:b.content,role:b.role},status:"loading"}))}))}}),{onRequest:k,messages:F,setMessages:D}=Qe({agent:m,requestPlaceholder:()=>({content:"Loading...",role:"assistant"}),requestFallback:(l,{error:p})=>p instanceof Z?{content:p.buffer.join(""),role:"assistant",error:p.message}:{content:`${p}`,role:"assistant"},resolveAbortController:l=>{a.current=l},transformMessage:l=>{const{originMessage:p,chunk:y}=l||{};return y?{role:"assistant",content:((p==null?void 0:p.content)||"")+y}:{role:"assistant",content:(p==null?void 0:p.content)||""}}});d.useEffect(()=>{if(!i)return;const l=n[i];l?D(l):g(i)},[n,i]);const he=l=>{if(l){if(h){w.error("Request is in progress, please wait for the request to complete.");return}if(!i){c(l);return}k({stream:!0,message:{role:"user",content:l},sessionId:i})}},pe=e.jsxs("div",{className:s.sider,children:[e.jsx(C,{onClick:()=>{c()},type:"link",className:s.addBtn,icon:e.jsx(Ze,{}),loading:S,children:"New Conversation"}),e.jsx(q,{spinning:_,wrapperClassName:s.conversationsSpin,children:e.jsx(et,{items:r.map(l=>({key:l.id,label:l.title,group:G(l.start_time).isSame(G(),"day")?"Today":G(l.start_time).format("YYYY-MM-DD")})),activeKey:i,onActiveChange:async l=>{var p;l&&((p=a.current)==null||p.abort(),f(y=>(y&&o(b=>({...b,[y]:F})),l)))},className:s.conversations,groupable:!0,styles:{item:{padding:"0 8px"}},menu:l=>({items:[{label:"Rename",key:"rename",icon:e.jsx(tt,{})},{label:"Delete",key:"delete",icon:e.jsx(st,{}),danger:!0,onClick:()=>{u(p=>p.map(y=>y.id===l.key?{...y,loading:!0}:y)),B(l.key)}}]})})})]}),fe=e.jsx("div",{className:s.chatList,children:e.jsx(q,{spinning:L,children:e.jsx(at.List,{items:F==null?void 0:F.map(l=>({...l.message,messageRender:p=>e.jsx("div",{dangerouslySetInnerHTML:{__html:Rt.render(p)}})})),style:{height:"100%",paddingInline:"calc(calc(100% - 700px) /2)"},roles:{assistant:{placement:"start",loadingRender:()=>e.jsx(q,{size:"small"})},user:{placement:"end"}}})})}),ge=e.jsx(e.Fragment,{children:e.jsx(rt,{value:x,onSubmit:()=>{he(x.trim()),v("")},onChange:v,onCancel:()=>{var l;(l=a.current)==null||l.abort()},loading:h,className:s.sender,allowSpeech:!0,actions:(l,p)=>{const{SendButton:y,LoadingButton:b}=p.components;return e.jsx(it,{gap:4,children:h?e.jsx(b,{type:"default"}):e.jsx(y,{type:"primary"})})},placeholder:"Please input your message"})});return e.jsxs("div",{className:s.layout,children:[pe,e.jsxs("div",{className:s.chat,children:[fe,ge]})]})},Pt=Object.freeze(Object.defineProperty({__proto__:null,default:zt},Symbol.toStringTag,{value:"Module"}));export{vt as A,Kt as D,ft as H,ht as L,qt as P,Qt as T,Gt as U,Ht as a,Ut as b,Wt as c,Xt as d,Yt as e,Ot as f,At as g,yt as h,Jt as i,bt as j};
