import{aq as Q,az as ee,aW as te,u as ae,r,n as d,j as e,C as se,K as oe,z as C,o as g,aX as re,at as ne,aY as ie,p as B,g as le,H as de,A as ce,s as ue,aZ as me}from"./vendor.2aaXemON.js";import{u as fe}from"./contexts.DYawpXr1.js";import{a as S}from"./index.BlXGBnBm.js";import{A as q}from"./client.Bmt2FeTo.js";import{L as ge,a as he,c as pe}from"./components.BmqVvmt5.js";import{m as xe,g as we}from"./base.zBL7EeCi.js";import"./vite.BF1G3H_w.js";import"./ai.BGenRt8i.js";import"./authorization.BarOdU4N.js";import"./system.BjCXfIZ_.js";import"./oauth.Dwz11D9p.js";import"./toolsets.VecF_3YQ.js";const{Title:je}=oe,Ee=({transformLangConfig:O})=>{const f=Q(),$=ee(),[i]=te(),{login:b,oauthLogin:V,user:L}=fe(),{t:s,i18n:x}=ae(),[I,l]=r.useState(null),[w,k]=r.useState({}),[c,h]=r.useState("login"),[U,M]=r.useState(null),[j,z]=r.useState(null),[u,D]=r.useState(null),[p]=d.useForm(),A=r.useRef(!1),[N,T]=r.useState(!1),[P,W]=r.useState([]),[y,_]=r.useState(0),[X,v]=r.useState("Loading..."),[o,Y]=r.useState(null),E=async a=>{const n=async t=>"username"in t?await b({username:t.username,password:t.password}):"mfa_token"in t?await b({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await V({code:t.code,state:t.state,provider:t.provider});try{T(!0);const t=await n(a);if(await new Promise(m=>setTimeout(m,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&$.pathname!=="/profile")f("/profile#mfa");else{const m=i.get("redirect");m?window.location.href=m:o!=null&&o.home_page?window.location.href=o.home_page:f("/")}}catch(t){if(t.password_expired)h("password_expired"),M(t.token),l(null);else if(t.needsMFA)l(null),h("mfa"),f("/login",{replace:!0}),z(t.mfaType),D(t.user),p.setFieldValue("mfa_token",t.mfaToken);else if("username"in a||"mfa_token"in a)if(t instanceof q?l(s("login.error",{defaultValue:"Login failed: {{error}}",error:s(`login.${t}`,{defaultValue:t.message})})):l(typeof t=="string"?t:s("login.error",{defaultValue:"Login failed"})),"mfa_token"in a){_(30);const m=setInterval(()=>{_(R=>R>=1?R-1:0)},1e3);setTimeout(()=>{clearInterval(m),_(0)},3e4)}else"username"in a&&h("login");else t instanceof q?l(s("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:s(`login.${t.code}`,{defaultValue:t.message})})):l(typeof t=="string"?t:s("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),f("/login",{replace:!0}),F()}finally{T(!1)}},F=async()=>{W(await S.oauth.getProviders()||[])};r.useEffect(()=>{if(!A.current){A.current=!0;const a=i.get("code"),n=i.get("state"),t=i.get("provider");a&&n&&t?E({code:a,state:n,provider:t}):F()}},[i,V]),r.useEffect(()=>{x.language&&v((o==null?void 0:o.name_i18n[x.language])||(o==null?void 0:o.name)||"")},[o,x.language]);const H=async a=>{try{k({...w,[a]:!0});const{url:n}=await S.oauth.getLoginUrl({provider:a},{headers:{"X-Base-Path":we()}});window.location.href=n}catch(n){ue.error(s("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",n)}finally{k({...w,[a]:!1})}},K=a=>{switch(a.toLowerCase()){case"github":return e.jsx(me,{});default:return null}},Z=i.get("code"),G=i.get("state"),J=i.get("provider");if(r.useEffect(()=>{(async()=>{var t;const n=await S.system.getSiteConfig();v(n.name),Y(n),window.document.title=n.name,(t=document.getElementById("site-icon"))==null||t.setAttribute("href",n.logo)})()},[]),Z&&G&&J||!o)return e.jsx(ge,{});if(L&&L.status==="active"){const a=i.get("redirect");a?window.location.href=a:o!=null&&o.home_page?window.location.href=o.home_page:f("/")}return e.jsx("div",{children:e.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxs(se,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsx(he,{transformLangConfig:O})}),e.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsx(je,{level:2,children:X}),e.jsx("p",{children:s("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),I&&e.jsx(C,{message:I,type:"error",showIcon:!0,style:{marginBottom:20}}),j&&e.jsx(C,{message:s(`login.mfaTips.${j}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxs(d,{name:"login",initialValues:{remember:!0},onFinish:E,size:"large",form:p,hidden:c==="password_expired",children:[c==="mfa"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{hidden:!(u!=null&&u.email)||j!=="email",children:e.jsx(g,{value:xe(u==null?void 0:u.email)})}),e.jsx(d.Item,{name:"mfa_token",hidden:!0,children:e.jsx(g,{})}),e.jsx(d.Item,{name:"mfa_code",hidden:c!=="mfa",children:e.jsx(g,{placeholder:s("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsx(re,{})})})]}),c==="login"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{name:"username",rules:[{required:!0,message:s("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsx(g,{prefix:e.jsx(ne,{}),placeholder:s("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsx(d.Item,{name:"password",rules:[{required:!0,message:s("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsx(g.Password,{prefix:e.jsx(ie,{}),placeholder:s("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsx(d.Item,{children:e.jsx(B,{disabled:y>0,type:"primary",htmlType:"submit",loading:N,block:!0,children:y>0?e.jsxs("span",{style:{marginLeft:8},children:[y,"s"]}):s("login.login",{defaultValue:"Login"})})})]}),P.length>0&&c!=="password_expired"&&e.jsxs(e.Fragment,{children:[e.jsx(le,{children:s("login.or",{defaultValue:"Or"})}),e.jsx(de,{direction:"vertical",style:{width:"100%"},children:P.map(a=>e.jsx(B,{icon:K(a.name),onClick:()=>H(a.name),loading:w[a.name],block:!0,children:a.icon_url?e.jsx(ce,{src:a.icon_url}):s("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:a.display_name})},a.name))})]}),c==="password_expired"&&e.jsx(pe,{onSuccess:()=>{h("login"),p.setFieldValue("password",""),p.setFieldValue("mfa_code","")},token:U||void 0})]})})})};export{Ee as default};
