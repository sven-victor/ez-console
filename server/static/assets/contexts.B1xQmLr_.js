import{r as a,e as P,j as U,s as v}from"./vendor.Bo5zsZF4.js";import{m as F,n as S,o as E,p as x,q as M}from"./base.BwF3eh7m.js";const k=a.createContext({user:null,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),j=()=>a.useContext(k),p=(s,l=!0)=>{s?(l&&localStorage.setItem("token",s),x.defaults.headers.common.Authorization=`Bearer ${s}`):(l&&localStorage.removeItem("token"),delete x.defaults.headers.common.Authorization)},L=({children:s})=>{const[l,o]=a.useState(null),[w,h]=a.useState(localStorage.getItem("token")),[r,u]=a.useState(!0),{run:g}=P(async()=>{const t=localStorage.getItem("token");return t?(p(t,!1),F()):null},{manual:!0,onBefore:()=>{},onSuccess:t=>{o(t)},onError:t=>{console.error("Failed to get current user:",t),y()},onFinally:()=>{u(!1)}});a.useEffect(()=>{g()},[]);const _=async t=>{try{const e=await M(t),{token:i,user:n,needs_mfa:f,password_expired:c,mfa_token:m,mfa_type:d}=e;if(f)throw{needsMFA:!0,mfaToken:m,mfaType:d,user:n};if(c)throw{password_expired:!0,user:n,token:i};return p(i),h(i),o(n),n}catch(e){throw e&&e.needsMFA||e&&e.password_expired||v.error("Login failed, please check your username and password"),e}},T=a.useCallback(async t=>{try{const e=await S(t);let i="",n=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:f,user:c,needs_mfa:m,mfa_token:d,mfa_type:A}=e.data;if(m)throw{needsMFA:!0,mfaToken:d,mfaType:A,user:c};i=f,n=c}else{const{token:f,user:c,needs_mfa:m,mfa_token:d,mfa_type:A}=e;if(m)throw{needsMFA:!0,mfaToken:d,mfaType:A,user:c};i=f,n=c}return p(i),h(i),o(n),n}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),y=()=>{E(),p(null),h(null),o(null)},C=t=>{o(t)};return U.jsx(k.Provider,{value:{user:l,token:w,loading:r,login:_,oauthLogin:T,logout:y,updateUser:C},children:s})},$=()=>{const s=a.useContext(k);if(s===void 0)throw new Error("useAuth must be used within an AuthProvider");return s},q=()=>{const{user:s}=a.useContext(k),l=()=>!s||!s.roles?!1:s.roles.some(r=>r.name==="admin"),o=r=>!s||!s.roles?!1:l()?!0:s.roles.some(u=>u.permissions?u.permissions.some(g=>g.code===r):!1);return{hasPermission:o,hasAllPermissions:r=>r.every(u=>o(u)),hasAnyPermission:r=>r.some(u=>o(u)),isAdmin:l(),loading:!s}};export{L as A,q as a,j as b,$ as u};
