import{aB as Q,aK as Z,b5 as ee,u as te,r as o,p as d,j as e,C as ae,V as se,G as R,q as g,b6 as re,aE as oe,b7 as ne,s as B,g as ie,K as le,A as de,b8 as ce,t as ue,b9 as me}from"./vendor.DXrT3tUS.js";import{u as fe,b as ge}from"./contexts.WYgP_g0b.js";import{a as q}from"./index.Dp8xutLE.js";import{A as O}from"./client.DjvmR9_2.js";import{L as he,a as pe,e as xe}from"./components.5ga-7_By.js";import{m as we,g as je}from"./base.Bo_VGDGc.js";import"./vite.BF1G3H_w.js";import"./ai.BdAG9W8N.js";import"./authorization.iO4mAvwW.js";import"./system.tooOd5et.js";import"./oauth.B608q7tL.js";const{Title:ye}=se,ve=({transformLangConfig:$})=>{const f=Q(),U=Z(),[n]=ee(),{login:_,oauthLogin:V,user:L}=fe(),{t:r,i18n:x}=te(),[I,i]=o.useState(null),[w,k]=o.useState({}),[c,h]=o.useState("login"),[C,M]=o.useState(null),[j,D]=o.useState(null),[u,N]=o.useState(null),[p]=d.useForm(),S=o.useRef(!1),[K,A]=o.useState(!1),[T,z]=o.useState([]),[y,b]=o.useState(0),{siteConfig:s}=ge(),[G,E]=o.useState("Loading..."),P=async a=>{const l=async t=>"username"in t?await _({username:t.username,password:t.password}):"mfa_token"in t?await _({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await V({code:t.code,state:t.state,provider:t.provider});try{A(!0);const t=await l(a);if(ce(),await new Promise(m=>setTimeout(m,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&U.pathname!=="/profile")f("/profile#mfa");else{const m=n.get("redirect");m?window.location.href=m:s!=null&&s.home_page?window.location.href=s.home_page:f("/")}}catch(t){if(t.password_expired)h("password_expired"),M(t.token),i(null);else if(t.needsMFA)i(null),h("mfa"),f("/login",{replace:!0}),D(t.mfaType),N(t.user),p.setFieldValue("mfa_token",t.mfaToken);else if("username"in a||"mfa_token"in a)if(t instanceof O?i(r("login.error",{defaultValue:"Login failed: {{error}}",error:r(`login.${t}`,{defaultValue:t.message})})):i(typeof t=="string"?t:r("login.error",{defaultValue:"Login failed"})),"mfa_token"in a){b(30);const m=setInterval(()=>{b(F=>F>=1?F-1:0)},1e3);setTimeout(()=>{clearInterval(m),b(0)},3e4)}else"username"in a&&h("login");else t instanceof O?i(r("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:r(`login.${t.code}`,{defaultValue:t.message})})):i(typeof t=="string"?t:r("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),f("/login",{replace:!0}),v()}finally{A(!1)}},v=async()=>{z(await q.oauth.getProviders()||[])};o.useEffect(()=>{if(!S.current){S.current=!0;const a=n.get("code"),l=n.get("state"),t=n.get("provider");a&&l&&t?P({code:a,state:l,provider:t}):v()}},[n,V]),o.useEffect(()=>{x.language&&E((s==null?void 0:s.name_i18n[x.language])||(s==null?void 0:s.name)||"")},[s,x.language]);const W=async a=>{try{k({...w,[a]:!0});const{url:l}=await q.oauth.getLoginUrl({provider:a},{headers:{"X-Base-Path":je()}});window.location.href=l}catch(l){ue.error(r("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",l)}finally{k({...w,[a]:!1})}},X=a=>{switch(a.toLowerCase()){case"github":return e.jsx(me,{});default:return null}},Y=n.get("code"),H=n.get("state"),J=n.get("provider");if(o.useEffect(()=>{var a;s&&(E(s.name),window.document.title=s.name,(a=document.getElementById("site-icon"))==null||a.setAttribute("href",s.logo||""))},[s]),Y&&H&&J||!s)return e.jsx(he,{});if(L&&L.status==="active"){const a=n.get("redirect");a?window.location.href=a:s!=null&&s.home_page?window.location.href=s.home_page:f("/")}return e.jsx("div",{children:e.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxs(ae,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsx(pe,{transformLangConfig:$})}),e.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsx(ye,{level:2,children:G}),e.jsx("p",{children:r("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),I&&e.jsx(R,{message:I,type:"error",showIcon:!0,style:{marginBottom:20}}),j&&e.jsx(R,{message:r(`login.mfaTips.${j}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxs(d,{name:"login",initialValues:{remember:!0},onFinish:P,size:"large",form:p,hidden:c==="password_expired",children:[c==="mfa"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{hidden:!(u!=null&&u.email)||j!=="email",children:e.jsx(g,{value:we(u==null?void 0:u.email)})}),e.jsx(d.Item,{name:"mfa_token",hidden:!0,children:e.jsx(g,{})}),e.jsx(d.Item,{name:"mfa_code",hidden:c!=="mfa",children:e.jsx(g,{placeholder:r("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsx(re,{})})})]}),c==="login"&&e.jsxs(e.Fragment,{children:[e.jsx(d.Item,{name:"username",rules:[{required:!0,message:r("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsx(g,{prefix:e.jsx(oe,{}),placeholder:r("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsx(d.Item,{name:"password",rules:[{required:!0,message:r("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsx(g.Password,{prefix:e.jsx(ne,{}),placeholder:r("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsx(d.Item,{children:e.jsx(B,{disabled:y>0,type:"primary",htmlType:"submit",loading:K,block:!0,children:y>0?e.jsxs("span",{style:{marginLeft:8},children:[y,"s"]}):r("login.login",{defaultValue:"Login"})})})]}),T.length>0&&c!=="password_expired"&&e.jsxs(e.Fragment,{children:[e.jsx(ie,{children:r("login.or",{defaultValue:"Or"})}),e.jsx(le,{direction:"vertical",style:{width:"100%"},children:T.map(a=>e.jsx(B,{icon:X(a.name),onClick:()=>W(a.name),loading:w[a.name],block:!0,children:a.icon_url?e.jsx(de,{src:a.icon_url}):r("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:a.display_name})},a.name))})]}),c==="password_expired"&&e.jsx(xe,{onSuccess:()=>{h("login"),p.setFieldValue("password",""),p.setFieldValue("mfa_code","")},token:C||void 0})]})})})};export{ve as default};
