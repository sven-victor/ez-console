import{c as re,b5 as se,bj as ne,bH as ie,u as le,r as s,aH as c,j as e,au as ge,o as n,ao as de,N as ce,aL as $,ai as x,bI as me,bc as ue,bJ as fe,B as q,a0 as pe,i as he,aw as xe,bK as we,s as B,bL as je}from"./vendor.B4UNC6a-.js";import{a as be,c as ye}from"./contexts.B1iwwl_4.js";import{a as U}from"./index.Cy1JO93W.js";import{A as D}from"./client.Bx1ZQKAq.js";import{L as H,a as Pe,b as _e}from"./components.BbXPg4FP.js";import{m as Le,g as Ne}from"./base.BitSj1X2.js";import"./vite.BF1G3H_w.js";import"./lodash.B3dv3_Tr.js";import"./highlight.BslI14e2.js";import"./ai.B8y9V9Sv.js";import"./authorization.CidYPuil.js";import"./system.DL6bykak.js";import"./oauth.f57Azrzi.js";import"./ai-chat-layout.OOcMoNgS.js";const{Title:Ve}=ce,Se=re(({css:i})=>({loginPageContainer:i`
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f0f2f5;
    `,loginPageCard:i`
      width: 400px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    `,languageSwitch:i`
      position: absolute;
      top: 0;
      right: 0;
    `,loginPageTitle:i`
      text-align: center;
      margin-bottom: 20px;
    `,loginPageError:i`
      margin-bottom: 20px;
    `,loginPageMfaAlert:i`
      margin-bottom: 20px;
    `,loginPageProviders:i`
      width: 100%;
    `})),Ue=({transformLangConfig:i})=>{const{styles:m}=Se(),h=se(),z=ne(),[l]=ie(),{login:V,oauthLogin:S,user:v}=be(),{t:r,i18n:y}=le(),[k,g]=s.useState(null),[P,A]=s.useState({}),[u,w]=s.useState("login"),[J,K]=s.useState(null),[_,W]=s.useState(null),[f,X]=s.useState(null),[j]=c.useForm(),I=s.useRef(!1),[Y,T]=s.useState(!1),[E,F]=s.useState([]),[L,N]=s.useState(0),{siteConfig:o,loading:G,error:b}=ye(),[Q,R]=s.useState("Loading..."),O=async t=>{const d=async a=>"username"in a?await V({username:a.username,password:a.password}):"mfa_token"in a?await V({mfa_token:a.mfa_token,mfa_code:a.mfa_code}):await S({code:a.code,state:a.state,provider:a.provider});try{T(!0);const a=await d(t);if(we(),await new Promise(p=>setTimeout(p,100)),a&&a.mfa_enforced&&!a.mfa_enabled&&z.pathname!=="/profile")h("/profile#mfa");else{const p=l.get("redirect");p?window.location.href=p:o!=null&&o.home_page?window.location.href=o.home_page:h("/")}}catch(a){if(a.password_expired)w("password_expired"),K(a.token),g(null);else if(a.needsMFA)g(null),w("mfa"),h("/login",{replace:!0}),W(a.mfaType),X(a.user),j.setFieldValue("mfa_token",a.mfaToken);else if("username"in t||"mfa_token"in t)if(a instanceof D?g(r("login.error",{defaultValue:"Login failed: {{error}}",error:r(`login.${a}`,{defaultValue:a.message})})):g(typeof a=="string"?a:r("login.error",{defaultValue:"Login failed"})),"mfa_token"in t){N(30);const p=setInterval(()=>{N(M=>M>=1?M-1:0)},1e3);setTimeout(()=>{clearInterval(p),N(0)},3e4)}else"username"in t&&w("login");else a instanceof D?g(r("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:r(`login.${a.code}`,{defaultValue:a.message})})):g(typeof a=="string"?a:r("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:a})),h("/login",{replace:!0}),C()}finally{T(!1)}},C=async()=>{try{F(await U.oauth.getProviders()||[])}catch(t){B.error(r("login.fetchOAuthProvidersError",{defaultValue:"Failed to fetch OAuth providers: {{error}}",error:t.message||t.toString()})),F([])}};s.useEffect(()=>{if(!I.current){I.current=!0;const t=l.get("code"),d=l.get("state"),a=l.get("provider");t&&d&&a?O({code:t,state:d,provider:a}):C()}},[l,S]),s.useEffect(()=>{y.language&&R((o==null?void 0:o.name_i18n[y.language])||(o==null?void 0:o.name)||"")},[o,y.language]);const Z=async t=>{try{A({...P,[t]:!0});const{url:d}=await U.oauth.getLoginUrl({provider:t},{headers:{"X-Base-Path":Ne()}});window.location.href=d}catch(d){B.error(r("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",d)}finally{A({...P,[t]:!1})}},ee=t=>{switch(t.toLowerCase()){case"github":return e.jsx(je,{});default:return null}},ae=l.get("code"),te=l.get("state"),oe=l.get("provider");if(s.useEffect(()=>{var t;o&&(R(o.name),window.document.title=o.name,(t=document.getElementById("site-icon"))==null||t.setAttribute("href",o.logo||""))},[o]),G)return e.jsx(H,{});if(!o)return e.jsx(ge,{status:"500",title:"500",subTitle:r("login.fetchSiteConfigError",{defaultValue:"Failed to fetch site config: {{error}}",error:(b==null?void 0:b.message)||b})});if(ae&&te&&oe)return e.jsx(H,{});if(v&&v.status==="active"){const t=l.get("redirect");t?window.location.href=t:o!=null&&o.home_page?window.location.href=o.home_page:h("/")}return e.jsx("div",{className:"login-page",children:e.jsx("div",{className:n(m.loginPageContainer,"login-page-container"),children:e.jsxs(de,{className:n(m.loginPageCard,"login-page-card"),children:[e.jsx("div",{className:n(m.languageSwitch,"language-switch"),children:e.jsx(Pe,{transformLangConfig:i})}),e.jsxs("div",{className:n(m.loginPageTitle,"login-page-title"),children:[e.jsx(Ve,{className:"login-page-title-text",level:2,children:Q}),e.jsx("p",{className:"login-page-subtitle-text",children:r("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),k&&e.jsx($,{className:n(m.loginPageError,"login-page-error"),message:k,type:"error",showIcon:!0}),u==="mfa"&&_&&e.jsx($,{message:r(`login.mfaTips.${_}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,className:n(m.loginPageMfaAlert,"login-page-mfa-alert")}),e.jsxs(c,{name:"login",initialValues:{remember:!0},onFinish:O,size:"large",form:j,hidden:u==="password_expired",className:"login-page-form",children:[u==="mfa"&&e.jsxs(e.Fragment,{children:[e.jsx(c.Item,{hidden:!(f!=null&&f.email)||_!=="email",className:n("login-page-form-item","login-page-form-email"),children:e.jsx(x,{value:Le(f==null?void 0:f.email)})}),e.jsx(c.Item,{name:"mfa_token",hidden:!0,className:n("login-page-form-item","login-page-form-mfa-token"),children:e.jsx(x,{})}),e.jsx(c.Item,{name:"mfa_code",hidden:u!=="mfa",className:n("login-page-form-item","login-page-form-mfa-code"),children:e.jsx(x,{placeholder:r("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsx(me,{})})})]}),u==="login"&&e.jsxs(e.Fragment,{children:[e.jsx(c.Item,{name:"username",rules:[{required:!0,message:r("login.usernameRequired",{defaultValue:"Username is required"})}],className:n("login-page-form-item","login-page-form-username"),children:e.jsx(x,{prefix:e.jsx(ue,{}),placeholder:r("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsx(c.Item,{name:"password",rules:[{required:!0,message:r("login.passwordRequired",{defaultValue:"Password is required"})}],className:n("login-page-form-item","login-page-form-password"),children:e.jsx(x.Password,{prefix:e.jsx(fe,{}),placeholder:r("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsx(c.Item,{className:n("login-page-form-item","login-page-form-submit"),children:e.jsx(q,{disabled:L>0,type:"primary",htmlType:"submit",loading:Y,block:!0,children:L>0?e.jsxs("span",{style:{marginLeft:8},children:[L,"s"]}):r("login.login",{defaultValue:"Login"})})})]}),E.length>0&&u!=="password_expired"&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:n("login-page-divider","login-page-divider-or"),children:r("login.or",{defaultValue:"Or"})}),e.jsx(he,{direction:"vertical",className:n(m.loginPageProviders,"login-page-providers"),children:E.map(t=>e.jsx(q,{icon:ee(t.name),onClick:()=>Z(t.name),loading:P[t.name],block:!0,children:t.icon_url?e.jsx(xe,{src:t.icon_url}):r("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:t.display_name})},t.name))})]}),u==="password_expired"&&e.jsx(_e,{className:"login-page-password-expired",onSuccess:()=>{w("login"),j.setFieldValue("password",""),j.setFieldValue("mfa_code","")},token:J||void 0})]})})})};export{Ue as default};
