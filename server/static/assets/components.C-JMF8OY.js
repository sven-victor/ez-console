var ke=Object.defineProperty;var _e=(t,a,s)=>a in t?ke(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s;var re=(t,a,s)=>_e(t,typeof a!="symbol"?a+"":a,s);import{j as e,S as H,N as ie,c as J,D as Fe,d as Le,u as k,A as Ae,r as p,I as Pe,U as Te,M as W,l as ze,e as $,P as Re,R as $e,f as De,L as Me,g as he,h as Ve,k as Ee,m as Be,T as pe,F as Ne,n as qe,o as He,p as j,q as T,s as _,t as I,v as Oe,C as U,w as oe,x as Ue,y as Ke,z as Je,E as We,G as le,Q as Ge,H as ge,J as Xe,K as M,O as Ye,V as Qe,W as Ze,X as et,Y as tt,Z as K,_ as se,$ as st,a0 as ae,a1 as ce,a2 as q,a3 as V,a4 as at,a5 as nt,a6 as rt,a7 as de,a8 as it,a9 as ot,aa as lt,ab as ct,ac as dt,ad as ut,ae as mt,af as ht,ag as pt,ah as Y,ai as gt,aj as xt,ak as ft,al as yt}from"./vendor.DHCYHP4R.js";import{u as xe,a as fe,b as jt,c as vt}from"./contexts.1OoT68TW.js";import{g as bt,f as St,c as wt}from"./base.qZwdwvN1.js";import{_ as It}from"./vite.BF1G3H_w.js";import{a as C,w as Ct}from"./index.DVKqzbI3.js";import{b as Q,A as kt}from"./client.B_u0cCcp.js";const _t=()=>e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",width:"100%"},children:e.jsx(H,{size:"large"})}),es=({element:t,requiredPermission:a,requiredPermissions:s})=>{const{user:n,loading:i}=xe(),{hasPermission:r,hasAllPermissions:g}=fe();return i?e.jsx(_t,{}):n?a&&!r(a)?e.jsx(ie,{to:"/forbidden",replace:!0}):s&&!g(s)?e.jsx(ie,{to:"/forbidden",replace:!0}):t:(window.location.href=bt("/login?redirect="+encodeURIComponent(window.location.href)),null)},Ft=J(({token:t,css:a})=>({container:a`
      ${a`
        @media screen and (max-width: ${t.screenXS}px) {
          width: 100% !important;
          > * {
            border-radius: 0 !important;
          }
        }
      `}
    > *{
      background-color: ${t.colorBgElevated};
      border-radius: 4px;
      box-shadow: ${t.boxShadowTertiary};
    }
    `,iconStyle:{cursor:"pointer",padding:"12px",display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:18,verticalAlign:"middle","&:hover":{color:t.colorPrimaryTextHover}}})),ye=({overlayClassName:t,overlay:a,hidden:s,children:n,...i})=>{if(s)return e.jsx(e.Fragment,{});const{styles:r}=Ft();return e.jsx(Fe,{dropdownRender:a,overlayClassName:Le(r.container,t),...i,children:e.jsx("span",{className:r.iconStyle,children:n})})},Lt=()=>e.jsxs("svg",{viewBox:"0 0 24 24",focusable:"false",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true",children:[e.jsx("path",{d:"M0 0h24v24H0z",fill:"none"}),e.jsx("path",{d:"M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z ",className:"css-c4d79v"})]}),At=J(()=>({menuItemStyle:{minWidth:"160px"},menuItemIconStyle:{marginRight:"8px"}})),Pt=[{lang:"en-US",label:"English",icon:"ðŸ‡ºðŸ‡¸"},{lang:"sv-SE",label:"Svenska",icon:"ðŸ‡¸ðŸ‡ª"},{lang:"ar-AE",label:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",icon:"ðŸ‡¦ðŸ‡ª"},{lang:"de-DE",label:"Deutsch",icon:"ðŸ‡©ðŸ‡ª"},{lang:"es-ES",label:"EspaÃ±ol",icon:"ðŸ‡ªðŸ‡¸"},{lang:"fr-FR",label:"FranÃ§ais",icon:"ðŸ‡«ðŸ‡·"},{lang:"zh-CN",label:"ä¸­æ–‡",icon:"ðŸ‡¨ðŸ‡³"}],ts=({transformLangConfig:t=a=>a})=>{const{i18n:a}=k(),{styles:s}=At(),n=r=>{a.changeLanguage(r)},i={selectedKeys:[a.language],onClick:r=>{n(r.key)},items:t(Pt).map(r=>({key:r.lang,className:s.menuItemStyle,label:e.jsxs(e.Fragment,{children:[e.jsx("span",{role:"img","aria-label":(r==null?void 0:r.label)||"en-US",className:s.menuItemIconStyle,children:(r==null?void 0:r.icon)||"ðŸŒ"}),(r==null?void 0:r.label)||"en-US"]})}))};return e.jsx(ye,{menu:i,children:e.jsx(Lt,{})})},Tt=J(({css:t})=>({avatarItem:t`
    :hover {
      background: rgba(0, 0, 0, 0.12);
    }
    padding: 5px;
  `})),je=t=>ze.isString(t)&&t.match(/^[-_a-zA-Z0-9]+$/)?Q.endsWith("/")?Q+`files/${t}`:Q+`/files/${t}`:t,zt=({src:t,...a})=>e.jsx(Ae,{src:je(t),...a}),Rt=({onChange:t,shape:a="square"})=>{const[s,n]=p.useState([]),{styles:i}=Tt(),[r,g]=p.useState(!1),[o,h]=p.useState(!0),[u,b]=p.useState(0),{run:d,loading:m}=$(()=>C.base.listFiles({current:u+1,page_size:40,file_type:"avatar",access:"public",search:""}),{manual:!0,onSuccess:({data:l})=>{n([...s,...l]),h(l.length===40),b(u+1)}}),v=()=>{h(!0),b(0),n([])};return e.jsx(Re,{style:{zIndex:1e3},onOpenChange:l=>{g(l),l?d():v()},open:r,content:e.jsx("div",{style:{width:360,height:200},children:e.jsx("div",{id:"iconsScrollableDiv",style:{height:"100%",overflow:"auto"},children:e.jsx(De,{dataLength:s.length,next:()=>{d()},hasMore:o,loader:e.jsx(Ve,{avatar:!0,paragraph:{rows:1},active:!0}),endMessage:e.jsx(he,{plain:!0,children:"End"}),scrollableTarget:"iconsScrollableDiv",children:e.jsx(Me,{grid:{gutter:16,column:8},dataSource:s,style:{margin:"0 8px"},loading:m,renderItem:({id:l})=>e.jsx("div",{className:i.avatarItem,onClick:x=>{x.stopPropagation(),t==null||t(l),g(!1),v()},children:e.jsx(zt,{shape:a,src:l})})})})})}),placement:"bottom",trigger:"hover",children:e.jsx($e,{shape:a,style:{width:112,height:112,placeContent:"center"}})})},$t=({value:t,onChange:a,shape:s,...n})=>{const[i,r]=p.useState(void 0),[g,o]=p.useState(!1),[h,u]=p.useState(void 0),b=async d=>{o(!0),u(d.url??d.preview)};return p.useEffect(()=>{r(t?{uid:t,name:t,url:je(t)}:void 0)},[t]),e.jsxs(e.Fragment,{children:[e.jsx(Pe,{beforeCrop:async d=>{if(d.type==="image/svg+xml"){const m=await C.base.uploadFile({type:"avatar"},d);return m.length>0&&(a==null||a(m[0].id)),!1}return!0},children:e.jsx(Te,{customRequest:async d=>{var v,l;const m=await C.base.uploadFile({type:"avatar",access:"public"},d.file);m.length>0?((v=d.onSuccess)==null||v.call(d,m[0].id),a==null||a(m[0].id)):(l=d.onError)==null||l.call(d,new Error("Upload file failed"))},listType:"picture-card",onPreview:b,maxCount:1,onChange:({file:d})=>{switch(d.status){case"removed":a==null||a(void 0);break;case"done":break;default:r(d);break}},fileList:i?[i]:[],...n,children:i?void 0:e.jsx(Rt,{shape:s,onChange:a})})}),e.jsx(W,{open:g,footer:null,onCancel:()=>o(!1),children:e.jsx("img",{style:{width:"100%"},src:h})})]})},ss=()=>{const{t}=k("common"),{user:a}=xe(),{currentOrgId:s,setCurrentOrgId:n}=jt(),i=(a==null?void 0:a.organizations)||[],r=u=>{n(u),window.location.reload()};if(i.length===0)return null;const g=i.find(u=>u.id===s),o=g?g.name:t("organization.global",{defaultValue:"Global"}),h=[...i.map(u=>({key:u.id,label:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:u.name}),s===u.id&&e.jsx(Ee,{})]}),onClick:()=>r(u.id)}))];return e.jsxs(ye,{menu:{items:h,selectedKeys:s?[s]:[""]},children:[e.jsx(Be,{style:{marginRight:4}}),e.jsx("span",{style:{height:"1em",lineHeight:"1em",marginLeft:"5px"},children:o})]})},Dt=p.lazy(()=>It(()=>Promise.resolve().then(()=>Kt),void 0)),as=()=>{const{t}=k("ai"),[a,s]=p.useState(!1),n=()=>{s(!0)},i=()=>{s(!1)};return console.log(a),e.jsxs(e.Fragment,{children:[e.jsx(pe,{title:t("chat.openAssistant",{defaultValue:"Open AI Assistant"}),placement:"left",children:e.jsx(Ne,{icon:e.jsx(qe,{}),type:"primary",onClick:n,style:{right:24,bottom:24}})}),e.jsx(W,{width:1200,open:a,onCancel:i,footer:null,children:Ct(Dt)})]})},Mt=He,Vt=t=>Mt[t],ns=({iconName:t})=>{if(!t)return null;const a=Vt(t);return a?e.jsx(p.Suspense,{fallback:null,children:e.jsx(a,{})}):null},rs=({onSuccess:t,token:a})=>{const{t:s}=k("authorization"),{t:n}=k("common"),[i]=j.useForm(),{run:r,loading:g}=$(async o=>C.authorization.changePassword(o,a?{headers:{Authorization:`Bearer ${a}`}}:{}),{manual:!0,onSuccess:()=>{I.success(s("user.passwordChanged")),i.resetFields(),t==null||t()},onError:o=>{if(o instanceof kt){const h=o.code??"normal";I.error(s(`user.passwordChangeFailed.${h}`,{error:o.message,defaultValue:"Password change failed: {{error}}"}))}else I.error(s("user.passwordChangeFailed.normal",{error:o.message,defaultValue:"Password change failed: {{error}}"}));console.error("Failed to change password:",o)}});return e.jsxs(j,{form:i,layout:"vertical",onFinish:r,style:{maxWidth:500,margin:"0 auto"},children:[e.jsx(j.Item,{name:"old_password",label:s("user.oldPassword"),rules:[{required:!0,message:s("validation.oldPasswordRequired")}],children:e.jsx(T.Password,{})}),e.jsx(j.Item,{name:"new_password",label:s("user.newPassword"),rules:[{required:!0,message:s("validation.newPasswordRequired")},{min:8,message:s("validation.passwordMinLength")}],children:e.jsx(T.Password,{})}),e.jsx(j.Item,{name:"confirm_password",label:s("user.confirmPassword"),rules:[{required:!0,message:s("validation.confirmPasswordRequired")},({getFieldValue:o})=>({validator(h,u){return!u||o("new_password")===u?Promise.resolve():Promise.reject(new Error(s("validation.passwordMismatch")))}})],children:e.jsx(T.Password,{})}),e.jsx(j.Item,{children:e.jsx(_,{type:"primary",htmlType:"submit",loading:g,children:n("save")})})]})},is=({user:t,onSuccess:a})=>{const{t:s}=k("authorization"),{t:n}=k("common"),[i]=j.useForm(),[r,g]=p.useState(!1);Oe.useEffect(()=>{t&&i.setFieldsValue({username:t.username,email:t.email,full_name:t.full_name,phone:t.phone||"",avatar:t.avatar})},[t,i]);const o=async h=>{try{g(!0),await C.authorization.updateCurrentUser(h),I.success(n("updateSuccess")),a()}catch(u){I.error(n("updateFailed")),console.error("Failed to update user information:",u)}finally{g(!1)}};return e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs("div",{style:{marginBottom:24,textAlign:"center"},children:[e.jsx("h2",{children:(t==null?void 0:t.full_name)||(t==null?void 0:t.username)}),(t==null?void 0:t.roles)&&t.roles.length>0&&e.jsxs("div",{children:[s("user.roles"),": ",t.roles.map(h=>h.name).join(", ")]})]}),e.jsxs(j,{form:i,layout:"vertical",onFinish:o,style:{width:"100%",maxWidth:500},children:[e.jsx(j.Item,{style:{marginBottom:24,textAlign:"center",justifyItems:"center"},name:"avatar",children:e.jsx($t,{})}),e.jsx(j.Item,{name:"username",label:s("user.username"),children:e.jsx(T,{disabled:!0})}),e.jsx(j.Item,{name:"email",label:s("user.email"),rules:[{required:!0,message:s("validation.emailRequired")},{type:"email",message:s("validation.emailInvalid")}],children:e.jsx(T,{})}),e.jsx(j.Item,{name:"full_name",label:s("user.fullName"),rules:[{required:!0,message:s("validation.fullNameRequired")}],children:e.jsx(T,{})}),e.jsx(j.Item,{name:"phone",label:s("user.phone"),children:e.jsx(T,{})}),e.jsx(j.Item,{children:e.jsx(_,{type:"primary",htmlType:"submit",loading:r,children:n("save")})})]})]})},os=({user:t,onSuccess:a})=>{const{t:s}=k("authorization"),{t:n}=k("common"),[i,r]=p.useState(0),[g,o]=p.useState(!1),[h,u]=p.useState(!0),[b,d]=p.useState(""),[m,v]=p.useState("totp"),{run:l,data:x={secret:"",qr_code:"",token:void 0}}=$(()=>C.authorization.enableMfa(m),{manual:!0,onSuccess:()=>{r(1)},onBefore:()=>{o(!0)},onFinally:()=>{o(!1)}}),L=async()=>{if(!b){I.warning(s("mfa.enterVerificationCode"));return}const F={code:b,mfa_type:m};"token"in x&&(F.token=x.token);try{o(!0),await C.authorization.verifyAndActivateMfa(F),I.success(s("mfa.enableSuccess")),r(2),a()}catch(P){I.error(s("mfa.verificationFailed")),console.error("Failed to verify MFA:",P)}finally{o(!1)}},f=async()=>{try{o(!0),await C.authorization.disableMfa(),I.success(s("mfa.disableSuccess")),a()}catch(F){I.error(n("operationFailed")),console.error("Failed to disable MFA:",F)}finally{o(!1)}},A=()=>{if(!t)return null;if(t.mfa_enabled)return e.jsx(oe,{status:"success",title:s("mfa.enabled"),subTitle:s("mfa.enabledDescription"),extra:e.jsx(_,{danger:!0,onClick:()=>{W.confirm({title:s("mfa.confirmDisable"),content:s("mfa.disableWarning"),onOk:f,okButtonProps:{danger:!0}})},children:s("mfa.disable")})});const F=()=>{var P;switch(i){case 0:return e.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsx(le,{message:e.jsxs("div",{children:[e.jsx("p",{children:s("mfa.setupInfo")}),e.jsx("p",{children:s(m==="totp"?"mfa.totpDescription":"mfa.emailDescription")})]}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsx(_,{type:"primary",onClick:l,loading:g,children:s("mfa.startSetup")})]});case 1:return e.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsx(le,{message:s("mfa.scanQrCode"),type:"info",showIcon:!0,style:{marginBottom:20,display:m==="totp"?"block":"none"}}),e.jsx("div",{style:{display:m==="totp"?"flex":"none",justifyContent:"center",marginBottom:24},children:e.jsx(Ge,{value:x.qr_code??"",size:200})}),e.jsx("div",{style:{marginBottom:16,display:m==="email"?"block":"none"},children:e.jsxs("p",{children:[s("user.email"),": ",e.jsx("strong",{children:t==null?void 0:t.email})]})}),e.jsx("div",{style:{marginBottom:16,display:m==="totp"?"block":"none"},children:e.jsxs("p",{children:[s("mfa.secretKey"),": ",e.jsx("strong",{children:h?"*".repeat(((P=x.secret)==null?void 0:P.length)??0):x.secret}),e.jsx(_,{type:"link",onClick:()=>u(!h),icon:h?e.jsx(ge,{}):e.jsx(Xe,{})})]})}),e.jsx("div",{style:{marginBottom:24},children:e.jsx(T,{placeholder:s("mfa.enterCode"),style:{width:200},maxLength:6,value:b,onChange:z=>d(z.target.value)})}),e.jsxs(M,{children:[e.jsx(_,{onClick:()=>r(0),children:n("previous")}),e.jsx(_,{type:"primary",onClick:L,loading:g,children:n("verify")})]})]});case 2:return e.jsx(oe,{status:"success",title:s("mfa.setupSuccess"),subTitle:s("mfa.setupSuccessDescription"),extra:e.jsx(_,{type:"primary",onClick:()=>r(0),children:n("done")})});default:return null}};return e.jsxs("div",{children:[e.jsxs("div",{style:{display:i===2?"none":"unset"},children:[e.jsx(Ue,{defaultValue:"totp",onChange:P=>{v(P),r(0)},value:m,options:[{value:"totp",icon:e.jsx(Ke,{}),label:s("mfa.totp",{defaultValue:"TOTP"})},{value:"email",icon:e.jsx(Je,{}),label:s("mfa.email",{defaultValue:"E-Mail"})}]}),e.jsx(he,{})]}),e.jsx(We,{current:i,items:[{title:s(m==="totp"?"mfa.totpStep1":"mfa.emailStep1"),description:s(m==="totp"?"mfa.totpStep1Description":"mfa.emailStep1Description")},{title:s(m==="totp"?"mfa.totpStep2":"mfa.emailStep2"),description:s(m==="totp"?"mfa.totpStep2Description":"mfa.emailStep2Description")},{title:s(m==="totp"?"mfa.totpStep3":"mfa.emailStep3"),description:s(m==="totp"?"mfa.totpStep3Description":"mfa.emailStep3Description")}],style:{marginBottom:30}}),F()]})};return e.jsx(U,{title:s("mfa.title"),children:A()})},{Text:Z}=Qe,ls=()=>{const{t}=k("authorization"),{t:a}=k("common"),[s,n]=p.useState([]),[i,r]=p.useState(!1),[g,o]=p.useState(null),[h,u]=p.useState(!1),b=async()=>{try{r(!0);const l=await C.authorization.getUserSessions({});n(l)}catch(l){I.error(t("session.getSessionsFailed",{error:l,defaultValue:"Failed to get session list: {{error}}"}))}finally{r(!1)}};p.useEffect(()=>{b()},[]);const d=async l=>{try{o(l),await C.authorization.terminateSession({id:l}),n(s.filter(x=>x.id!==l)),I.success(t("session.terminateSuccess",{defaultValue:"Session terminated successfully"}))}catch(x){I.error(t("session.terminateFailed",{error:x,defaultValue:"Failed to terminate session: {{error}}"}))}finally{o(null)}},m=async()=>{try{u(!0),await C.authorization.terminateOtherSessions(),n(s.filter(l=>l.is_current)),I.success(t("session.terminateAllSuccess",{defaultValue:"All other sessions terminated successfully"}))}catch(l){I.error(t("session.terminateAllFailed",{error:l,defaultValue:"Failed to terminate all other sessions: {{error}}"}))}finally{u(!1)}},v=[{title:t("session.device"),dataIndex:"user_agent",key:"device",render:(l,x)=>e.jsxs(M,{direction:"vertical",size:0,children:[e.jsxs(M,{children:[e.jsx(Ye,{}),e.jsx(Z,{strong:!0,children:l})]}),e.jsxs(M,{children:[e.jsx(Ze,{}),e.jsx(Z,{type:"secondary",children:x.location})]})]})},{title:t("session.ipAddress"),dataIndex:"ip_address",key:"ip_address",render:l=>e.jsxs(M,{children:[e.jsx(et,{}),e.jsx("span",{children:l})]})},{title:t("session.lastActive"),dataIndex:"last_active_at",key:"last_active",render:l=>e.jsxs(M,{children:[e.jsx(tt,{}),e.jsx("span",{children:new Date(l).toLocaleString()})]})},{title:t("session.status"),key:"status",render:l=>l.is_current?e.jsx(K,{color:"green",children:t("session.current")}):e.jsx(K,{color:"blue",children:t("session.active")})},{title:a("actions"),key:"action",render:l=>l.is_current?e.jsx(Z,{type:"secondary",children:t("session.currentSession")}):e.jsx(se,{title:t("session.confirmTerminate"),onConfirm:()=>d(l.id),okText:a("confirm"),cancelText:a("cancel"),children:e.jsx(_,{type:"link",danger:!0,loading:g===l.id,children:t("session.terminate")})})}];return e.jsx(U,{title:t("session.title"),extra:s.length>1&&e.jsx(se,{title:t("session.confirmTerminateAll"),onConfirm:m,okText:a("confirm"),cancelText:a("cancel"),children:e.jsx(_,{danger:!0,loading:h,children:t("session.terminateOthers")})}),children:s.length===0?e.jsx(st,{description:t("session.noSessions")}):e.jsx(ae,{columns:v,dataSource:s,rowKey:"id",loading:i,pagination:!1})})},{RangePicker:Et}=at,{Option:E}=V,Bt=t=>t||"N/A",Nt=(t,a)=>t==="success"?e.jsx(K,{color:"success",children:a("statuses.success")}):e.jsx(K,{color:"error",children:a("statuses.failed")}),cs=({userId:t,request:a=n=>t?C.authorization.getUserLogs({id:t,...n}):C.authorization.getCurrentUserLogs(n),columnsFilter:s=n=>n})=>{const{t:n}=k("authorization"),{t:i}=k("common"),[r,g]=p.useState({current:1,pageSize:10,total:0}),[o,h]=p.useState({}),[u]=j.useForm(),{loading:b,run:d,data:{data:m}={}}=$(async(f=o,A=1,F=10)=>a({...f,current:A??1,page_size:F??10}),{onError(f){I.error(n("auditLog.fetchFailed",{error:f}))},onSuccess({total:f}){g({...r,total:f})}});p.useEffect(()=>{d(o,1,r.pageSize)},[]);const v=f=>{g({...r,current:f.current,pageSize:f.pageSize}),d({},f.current,f.pageSize)},l=f=>{var A,F,P,z;d({...f,start_time:(F=(A=f.dateRange)==null?void 0:A[0])==null?void 0:F.toISOString(),end_time:(z=(P=f.dateRange)==null?void 0:P[1])==null?void 0:z.toISOString()},1,r.pageSize)},x=()=>{u.resetFields(),h({}),g({...r,current:1}),d({},1,r.pageSize)},L=[{title:n("auditLog.timestamp"),dataIndex:"timestamp",key:"timestamp",render:f=>St(f)},{title:n("auditLog.action"),dataIndex:"action",key:"action",render:(f,A)=>f?n(`action.${f.replace(":",".")}`,{defaultValue:A.action_name}):A.action_name??A.action},{title:n("auditLog.user_agent"),dataIndex:"user_agent",key:"user_agent"},{title:n("auditLog.ip"),dataIndex:"ip",key:"ip",render:f=>Bt(f)},{title:n("auditLog.status"),dataIndex:"status",key:"status",render:f=>Nt(f,n)},{title:n("auditLog.details"),dataIndex:"details",key:"details",render:f=>e.jsx(_,{type:"link",icon:e.jsx(ge,{}),onClick:()=>{W.info({title:n("auditLog.details"),content:JSON.stringify(f)})}})}];return e.jsxs("div",{children:[e.jsx(U,{style:{marginBottom:16},children:e.jsxs(j,{form:u,layout:"horizontal",onFinish:l,initialValues:o,children:[e.jsxs(ce,{gutter:24,children:[e.jsx(q,{span:6,children:e.jsx(j.Item,{name:"search",label:n("auditLog.search"),children:e.jsx(T,{placeholder:n("auditLog.searchPlaceholder")})})}),e.jsx(q,{span:6,children:e.jsx(j.Item,{name:"action",label:n("auditLog.action"),children:e.jsxs(V,{allowClear:!0,placeholder:n("auditLog.selectAction"),children:[e.jsx(E,{value:"login",children:n("actions.login")}),e.jsx(E,{value:"logout",children:n("actions.logout")}),e.jsx(E,{value:"password_reset",children:n("actions.passwordReset")}),e.jsx(E,{value:"mfa_change",children:n("actions.mfaChange")})]})})}),e.jsx(q,{span:6,children:e.jsx(j.Item,{name:"status",label:n("auditLog.status"),children:e.jsxs(V,{allowClear:!0,placeholder:n("auditLog.selectStatus"),children:[e.jsx(E,{value:"success",children:n("statuses.success")}),e.jsx(E,{value:"failed",children:n("statuses.failed")})]})})}),e.jsx(q,{span:6,children:e.jsx(j.Item,{name:"dateRange",label:n("auditLog.dateRange"),children:e.jsx(Et,{style:{width:"100%"}})})})]}),e.jsx(ce,{children:e.jsx(q,{span:24,style:{textAlign:"right"},children:e.jsxs(M,{children:[e.jsx(_,{onClick:x,children:i("reset")}),e.jsx(_,{type:"primary",htmlType:"submit",icon:e.jsx(nt,{}),children:i("search")})]})})})]})}),e.jsxs(U,{children:[e.jsx("div",{style:{marginBottom:16},children:e.jsx(_,{type:"primary",icon:e.jsx(rt,{}),onClick:x,style:{marginRight:8},children:i("refresh")})}),e.jsx(ae,{rowKey:"id",columns:s(L),dataSource:m,pagination:{...r,showSizeChanger:!0,showTotal:f=>i("totalItems",{total:f})},loading:b,onChange:v,scroll:{x:"max-content"}})]})]})},qt=({permission:t,permissions:a=[],checkAll:s=!1,fallback:n=null,children:i})=>{const{hasPermission:r,hasAnyPermission:g,hasAllPermissions:o,isAdmin:h,loading:u}=fe();return u?null:h?e.jsx(e.Fragment,{children:i}):t?r(t)?e.jsx(e.Fragment,{children:i}):e.jsx(e.Fragment,{children:n}):a.length>0?(s?o(a):g(a))?e.jsx(e.Fragment,{children:i}):e.jsx(e.Fragment,{children:n}):e.jsx(e.Fragment,{children:i})},O=t=>{const[a,s]=p.useState(!1),{permission:n,icon:i,tooltip:r,onClick:g,confirm:o,label:h,...u}=t;if(n)return e.jsx(qt,{permission:n,children:O({icon:i,tooltip:r,onClick:g,confirm:o,label:h,...u})},t.key);if(o)return e.jsx(se,{title:o.title,onConfirm:o.onConfirm||g,okText:o.okText,cancelText:o.cancelText,children:O({icon:i,tooltip:r,label:h,...u})},t.key);if(r)return e.jsx(pe,{title:r,children:O({icon:i,onClick:g,label:h,...u})},t.key);const b=g?async()=>{console.log(new Date,"handleClick"),s(!0);try{await g()}finally{s(!1),console.log(new Date,"handleClick1")}}:void 0;return p.createElement(_,{type:"text",size:"small",loading:a,icon:i,onClick:b,...u,key:t.key},h&&e.jsx("span",{style:{position:"inherit",top:"-2px"},children:h}))},ds=({actions:t})=>t.filter(a=>!a.hidden).map(a=>O(a)),Ht=({request:t,tableRef:a,...s},n)=>{const[i,r]=p.useState({current:1,pageSize:10}),[g,o]=p.useState(0),{data:h,loading:u,refresh:b}=$(async()=>{const d=await t({current:i.current,page_size:i.pageSize});return o(d.total),d.data},{refreshDeps:[i]});return p.useImperativeHandle(n,()=>({reload:()=>{b()}})),e.jsx(ae,{rowKey:"id",loading:u,dataSource:h??[],pagination:{...i,total:g,onChange:(d,m)=>{r({current:d,pageSize:m})}},...s,ref:a})},us=({actionRef:t,...a})=>{const[s,n]=p.useState();return p.useEffect(()=>{n(p.forwardRef(Ht))},[]),s?e.jsx(s,{...a,ref:t}):null},{TextArea:ue}=T,{Option:ee}=V,ms=({field:t,selectedType:a,dependentValues:s,formValues:n={}})=>{const{t:i}=k("system"),{t:r}=k("common"),g=p.useMemo(()=>wt(t.visible_when,n),[t.visible_when,n]),{options:o,loading:h}=vt(t.data_source,t.options,s),u=p.useMemo(()=>t.data_source&&t.data_source.type!=="static"?o:t.options||[],[t.data_source,t.options,o]),b=u&&u.length>0;if(!g)return null;const d=[{required:t.required,message:i("settings.toolsets.fieldRequired",{defaultValue:`Please enter ${t.name}`,field:t.name})}],m=()=>i(`settings.toolsets.${a}.${t.name}`,{defaultValue:t.display_name||t.name}),v=()=>i(`settings.toolsets.${a}.${t.name}Placeholder`,{defaultValue:t.placeholder||`${r("enter",{defaultValue:"Enter"})} ${t.name}`}),l=()=>{if(t.description)return i(`settings.toolsets.${a}.${t.name}Tooltip`,{defaultValue:t.description})};if(!g)return null;if(t.type==="select"||t.data_source)return e.jsx(j.Item,{name:["config",t.name],label:m(),rules:d,tooltip:l(),children:e.jsx(V,{loading:h,allowClear:!0,placeholder:v(),showSearch:!0,filterOption:(x,L)=>{var f;return(f=L==null?void 0:L.children)==null?void 0:f.toLowerCase().includes(x.toLowerCase())},children:u.map(x=>e.jsx(ee,{value:x.value,children:x.label},x.value))})},t.name);switch(t.type){case"text":return e.jsx(j.Item,{name:["config",t.name],label:m(),rules:d,children:e.jsx(ue,{placeholder:v(),rows:4})},t.name);case"string":return b?e.jsx(j.Item,{name:["config",t.name],label:m(),rules:d,tooltip:l(),children:e.jsx(V,{allowClear:!0,placeholder:v(),children:u.map(x=>e.jsx(ee,{value:x.value,children:x.label},x.value))})},t.name):e.jsx(j.Item,{name:["config",t.name],label:m(),rules:d,tooltip:l(),children:e.jsx(T,{placeholder:v()})},t.name);case"password":return e.jsx(j.Item,{name:["config",t.name],label:m(),rules:d,tooltip:l(),children:e.jsx(T.Password,{placeholder:v(),autoComplete:"new-password"})},t.name);case"number":return b?e.jsx(j.Item,{name:["config",t.name],label:m(),rules:d,tooltip:l(),children:e.jsx(V,{allowClear:!0,placeholder:v(),children:u.map(x=>e.jsx(ee,{value:x.value,children:x.label},x.value))})},t.name):e.jsx(j.Item,{name:["config",t.name],label:m(),rules:d,tooltip:l(),children:e.jsx(ot,{style:{width:"100%"},placeholder:v()})},t.name);case"boolean":return e.jsx(j.Item,{name:["config",t.name],label:m(),valuePropName:"checked",tooltip:l(),children:e.jsx(it,{})},t.name);case"array":return b?e.jsx(j.Item,{name:["config",t.name],label:m(),rules:d,tooltip:l(),children:e.jsx(de.Group,{style:{width:"100%"},children:e.jsx(M,{direction:"vertical",children:u.map(x=>e.jsx(de,{value:x.value,children:x.label},x.value))})})},t.name):e.jsx(j.Item,{name:["config",t.name],label:m(),rules:d,tooltip:l(),children:e.jsx(V,{mode:"tags",style:{width:"100%"},placeholder:v(),tokenSeparators:[","]})},t.name);case"object":return e.jsx(j.Item,{name:["config",t.name],label:m(),rules:[...d,{validator:(x,L)=>{if(!L)return Promise.resolve();try{return JSON.parse(L),Promise.resolve()}catch{return Promise.reject(new Error(i("settings.toolsets.invalidJSON",{defaultValue:"Invalid JSON format"})))}}}],tooltip:l(),children:e.jsx(ue,{rows:4,placeholder:v()})},t.name);default:return null}},me=xt({html:!0,breaks:!0}),Ot=J(({token:t,css:a})=>({layout:a`
      width: 100%;
      min-width: 500px;
      height: 70vh;
      display: flex;
      background: ${t.colorBgContainer};
      font-family: AlibabaPuHuiTi, ${t.fontFamily}, sans-serif;
    `,sider:a`
      background: ${t.colorBgLayout}80;
      width: 280px;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 0 12px;
      box-sizing: border-box;
    `,logo:a`
      display: flex;
      align-items: center;
      justify-content: start;
      padding: 0 24px;
      box-sizing: border-box;
      gap: 8px;
      margin: 24px 0;

      span {
        font-weight: bold;
        color: ${t.colorText};
        font-size: 16px;
      }
    `,addBtn:a`
      background: #1677ff0f;
      border: 1px solid #1677ff34;
      height: 40px;
    `,conversationsSpin:a`
      height: 100%;
      overflow-y: auto;
    `,conversations:a`
      flex: 1;
      overflow-y: auto;
      margin-top: 12px;
      padding: 0;

      .ant-conversations-list {
        padding-inline-start: 0;
      }
    `,siderFooter:a`
      border-top: 1px solid ${t.colorBorderSecondary};
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    `,chat:a`
      height: 100%;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      padding-block: ${t.paddingLG}px;
      gap: 16px;
    `,chatPrompt:a`
      .ant-prompts-label {
        color: #000000e0 !important;
      }
      .ant-prompts-desc {
        color: #000000a6 !important;
        width: 100%;
      }
      .ant-prompts-icon {
        color: #000000a6 !important;
      }
    `,chatList:a`
      flex: 1;
      overflow: auto;
    `,loadingMessage:a`
      background-image: linear-gradient(90deg, #ff6b23 0%, #af3cb8 31%, #53b6ff 89%);
      background-size: 100% 2px;
      background-repeat: no-repeat;
      background-position: bottom;
    `,placeholder:a`
      padding-top: 32px;
    `,sender:a`
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
    `,speechButton:a`
      font-size: 18px;
      color: ${t.colorText} !important;
    `,senderPrompt:a`
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      color: ${t.colorText};
    `}));class te extends Error{constructor(s,n){super(s);re(this,"buffer");this.buffer=n}}const Ut=()=>{const{t}=k("ai"),{t:a}=k("common"),{styles:s}=Ot(),n=p.useRef(null),[i,r]=p.useState({}),[g,o]=p.useState([]),[h,u]=p.useState(),[b,d]=p.useState(""),[m]=lt({request:async({message:c,sessionId:y},{onSuccess:S,onUpdate:w,onError:B,onStream:N})=>{if(!y)return;const G=new AbortController,D={buffer:[],messageID:""};try{N==null||N(G);const X=await C.ai.streamChat({sessionId:y},{content:c.content},{signal:G.signal,requestType:"sse"});for await(const Ce of ct({readableStream:X})){const R=JSON.parse(Ce.data);if(R.event_type,R.event_type==="error"){B(new te(R.content,D.buffer));return}R.event_type==="content"&&(D.messageID===""&&(D.messageID=R.message_id),D.messageID!==R.message_id&&(D.messageID=R.message_id),D.buffer.push(R.content),w(R.content))}S(D.buffer)}catch(X){B(new te(`${X}`,D.buffer)),G.abort()}}}),v=m.isRequesting(),{loading:l}=$(async()=>{const c=await C.ai.listChatSessions({current:1,page_size:20});o(c.data)}),{run:x,loading:L}=$(async c=>await C.ai.createChatSession({title:t("chat.defaultConversationTitle"),model_id:""}),{manual:!0,onSuccess:(c,[y])=>{o(S=>[{...c,loading:!1},...S]),u(c.id),ne([]),y&&P({stream:!0,message:{role:"user",content:y},sessionId:c.id})}}),{run:f}=$(async c=>await C.ai.deleteChatSession({sessionId:c}),{manual:!0,onError(c,y){I.error(t("chat.deleteConversationFailed")),o(S=>S.map(w=>w.id===y[0]?{...w,loading:!1}:w))},onSuccess(c,y){var B;const S=g.filter(N=>N.id!==y[0]),w=(B=S==null?void 0:S[0])==null?void 0:B.id;o(S),y[0]===h&&u(w)}}),{run:A,loading:F}=$(async c=>await C.ai.getChatSession({sessionId:c}),{manual:!0,onSuccess:(c,[y])=>{r(S=>({...S,[y]:c.messages.filter(w=>w.role!=="tool").map(w=>({id:w.id,message:{content:w.content,role:w.role},status:"loading"}))}))}}),{onRequest:P,messages:z,setMessages:ne}=dt({agent:m,requestPlaceholder:()=>({content:a("loading"),role:"assistant"}),requestFallback:(c,{error:y})=>(console.log(y),y instanceof te?{content:y.buffer.join(""),role:"assistant",error:y.message}:{content:`${y}`,role:"assistant"}),resolveAbortController:c=>{n.current=c},transformMessage:c=>{const{originMessage:y,chunk:S}=c||{};return S?{role:"assistant",content:((y==null?void 0:y.content)||"")+S}:{role:"assistant",content:(y==null?void 0:y.content)||""}}});p.useEffect(()=>{if(!h)return;const c=i[h];c?ne(c):A(h)},[i,h]);const ve=c=>{if(c){if(v){I.error(t("chat.requestInProgress"));return}if(!h){x(c);return}P({stream:!0,message:{role:"user",content:c},sessionId:h})}},be=e.jsxs("div",{className:s.sider,children:[e.jsx(_,{onClick:()=>{x()},type:"link",className:s.addBtn,icon:e.jsx(ut,{}),loading:L,children:t("chat.newConversation")}),e.jsx(H,{spinning:l,wrapperClassName:s.conversationsSpin,children:e.jsx(mt,{items:g.map(c=>({key:c.id,label:c.title,group:Y(c.start_time).isSame(Y(),"day")?t("chat.today"):Y(c.start_time).format("YYYY-MM-DD")})),activeKey:h,onActiveChange:async c=>{var y;c&&((y=n.current)==null||y.abort(),u(S=>(S&&r(w=>({...w,[S]:z})),c)))},className:s.conversations,groupable:!0,styles:{item:{padding:"0 8px"}},menu:c=>({items:[{label:t("chat.renameConversation"),key:"rename",icon:e.jsx(ht,{})},{label:a("delete"),key:"delete",icon:e.jsx(pt,{}),danger:!0,onClick:()=>{o(y=>y.map(S=>S.id===c.key?{...S,loading:!0}:S)),f(c.key)}}]})})})]}),Se=({message:c})=>{if(c.error)return e.jsx("div",{children:e.jsx("div",{dangerouslySetInnerHTML:{__html:me.render(c.error)}})})},we=e.jsx("div",{className:s.chatList,children:e.jsx(H,{spinning:F,children:e.jsx(gt.List,{items:z==null?void 0:z.map(c=>({...c.message,messageRender:y=>e.jsx("div",{dangerouslySetInnerHTML:{__html:me.render(y)}}),footer:Se(c)})),style:{height:"100%",paddingInline:"calc(calc(100% - 700px) /2)"},roles:{assistant:{placement:"start",loadingRender:()=>e.jsx(H,{size:"small"})},user:{placement:"end"}}})})}),Ie=e.jsx(e.Fragment,{children:e.jsx(ft,{value:b,onSubmit:()=>{ve(b.trim()),d("")},onChange:d,onCancel:()=>{var c;(c=n.current)==null||c.abort()},loading:v,className:s.sender,allowSpeech:!0,actions:(c,y)=>{const{SendButton:S,LoadingButton:w}=y.components;return e.jsx(yt,{gap:4,children:v?e.jsx(w,{type:"default"}):e.jsx(S,{type:"primary"})})},placeholder:t("chat.inputPlaceholder")})});return e.jsxs("div",{className:s.layout,children:[be,e.jsxs("div",{className:s.chat,children:[we,Ie]})]})},Kt=Object.freeze(Object.defineProperty({__proto__:null,default:Ut},Symbol.toStringTag,{value:"Module"}));export{zt as A,ns as D,ye as H,_t as L,ss as O,es as P,us as T,cs as U,ts as a,as as b,rs as c,is as d,os as e,ls as f,qt as g,Pt as h,ds as i,ms as j,$t as k};
