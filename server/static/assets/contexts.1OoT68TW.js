import{r,e as D,j as P,t as U}from"./vendor.DHCYHP4R.js";import{a as A}from"./index.DVKqzbI3.js";import{c as O,a as T}from"./client.B_u0cCcp.js";const b=r.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),F=()=>r.useContext(b),I=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),O.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete O.defaults.headers.common.Authorization)},$=({children:e})=>{const[t,n]=r.useState(void 0),[k,l]=r.useState(localStorage.getItem("token")),[w,g]=r.useState(!0),{run:p}=D(async()=>{const a=localStorage.getItem("token");return a?(I(a,!1),A.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:a=>{n(a)},onError:a=>{console.error("Failed to get current user:",a),_()},onFinally:()=>{g(!1)}});r.useEffect(()=>{p()},[]);const o=async a=>{try{const s=await A.authorization.login(a),{token:u,user:i,needs_mfa:m,password_expired:f,mfa_token:y,mfa_type:d}=s;if(m)throw{needsMFA:!0,mfaToken:y,mfaType:d,user:i};if(f)throw{password_expired:!0,user:i,token:u};return I(u),l(u),n(i),i}catch(s){throw s&&s.needsMFA||s&&s.password_expired||U.error("Login failed, please check your username and password"),s}},c=r.useCallback(async a=>{try{const s=await A.oauth.handleCallback(a);let u="",i=null;if(s&&typeof s=="object")if("code"in s&&s.code==="0"&&"data"in s){const{token:m,user:f,needs_mfa:y,mfa_token:d,mfa_type:h}=s.data;if(y)throw{needsMFA:!0,mfaToken:d,mfaType:h,user:f};u=m,i=f}else{const{token:m,user:f,needs_mfa:y,mfa_token:d,mfa_type:h}=s;if(y)throw{needsMFA:!0,mfaToken:d,mfaType:h,user:f};u=m,i=f}return I(u),l(u),n(i),i}catch(s){throw s&&s.needsMFA||s&&s.passwordExpired,s}},[]),_=()=>{A.authorization.logout(),I(null),l(null),n(null)},v=a=>{n(a)};return P.jsx(b.Provider,{value:{user:t,token:k,loading:w,login:o,oauthLogin:c,logout:_,updateUser:v},children:e})},q=()=>{const e=r.useContext(b);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},M=r.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),K=()=>r.useContext(M),J=({children:e})=>{const{user:t}=F(),{data:n=null,loading:k,runAsync:l}=D(async()=>A.system.getSiteConfig(),{manual:!0});r.useEffect(()=>{t!==void 0&&l()},[t]);const[w,g]=r.useState(null);return r.useEffect(()=>{w?localStorage.setItem("orgID",w):localStorage.removeItem("orgID")},[w]),r.useEffect(()=>{var o,c,_;let p=localStorage.getItem("orgID");if(p){const v=(o=t==null?void 0:t.organizations)==null?void 0:o.find(a=>a.id===p);if(v){g(v.id);return}}g(((_=(c=t==null?void 0:t.organizations)==null?void 0:c[0])==null?void 0:_.id)??null)},[n,t==null?void 0:t.organizations]),P.jsx(M.Provider,{value:{siteConfig:n,loading:k,enableMultiOrg:(n==null?void 0:n.enable_multi_org)??!1,fetchSiteConfig:l,currentOrgId:w,setCurrentOrgId:p=>{g(p)},clearCurrentOrgId:()=>{g(null)}},children:e})},N=()=>{var p;const{user:e}=r.useContext(b),{currentOrgId:t}=K(),n=(p=e==null?void 0:e.roles)==null?void 0:p.filter(o=>!o.organization_id||o.organization_id===t),k=()=>n?n.some(o=>o.name==="admin"&&!o.organization_id):!1,l=o=>n?k()?!0:n.some(c=>c.permissions?c.permissions.some(_=>_.code===o):!1):!1;return{hasPermission:l,hasAllPermissions:o=>o.every(c=>l(c)),hasAnyPermission:o=>o.some(c=>l(c)),isAdmin:k(),loading:!e}},E=new Map,j=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),L=(e,t)=>{const n=E.get(e);return n?t&&t>0&&Date.now()-n.timestamp>t*1e3?(E.delete(e),null):n.data:null},S=(e,t)=>{E.set(e,{data:t,timestamp:Date.now()})},H=(e,t,n)=>{const[k,l]=r.useState(t||[]),[w,g]=r.useState(!1),[p,o]=r.useState(null),[c,_]=r.useState(0),v=()=>_(s=>s+1),a=r.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(s=>n&&n[s]!==void 0&&n[s]!==null):!0,[e,n]);return r.useEffect(()=>{if(!a){l(t||[]);return}(async()=>{try{g(!0),o(null);const u=j(e,n);if(e.cache){const m=L(u,e.cache_ttl);if(m){l(m),g(!1);return}}let i=[];switch(e.type){case"api":{const m=e.url||"",f=e.method||"GET",y={...n,...e.params};let d;f.toUpperCase()==="GET"?d=await T(m,{params:y}):d=await T(m,{params:y});const h=Array.isArray(d)?d:d.data||[],x=e.label_key||"label",z=e.value_key||"value";i=h.map(C=>({label:C[x]||C.name||C.id,value:C[z]||C.id}));break}case"toolsets":{let f=(await A.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(f=f.filter(h=>Object.entries(e.filter).every(([x,z])=>h[x]===z)));const y=e.label_key||"name",d=e.value_key||"id";i=f.map(h=>({label:h[y]||h.name,value:h[d]||h.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),i=[];break}default:i=t||[]}e.cache&&S(u,i),l(i)}catch(u){console.error("Failed to load options from data source:",u),o(u),l(t||[])}finally{g(!1)}})()},[e,t,n,a,c]),{options:k,loading:w,error:p,refresh:v}};export{$ as A,J as S,N as a,K as b,H as c,F as d,q as u};
