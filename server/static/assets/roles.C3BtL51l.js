import{u as k,aB as ae,r as s,j as e,K as P,aE as Se,Z as L,m as Re,b7 as Ee,T as Z,s as b,bb as ve,_ as Ae,af as Pe,C as B,a1 as we,a2 as Q,a6 as Te,ad as Ie,t as j,c as Ce,bc as ke,p as y,ba as Oe,q as ie,ak as G,a3 as C,bd as Fe,be as Ne,bf as De,aM as ee,S as qe,a7 as te,$ as A}from"./vendor.XZpclBr-.js";import{i as J,T as Me}from"./components.DpTwgd7F.js";import{a as z}from"./index.bU_rPqdB.js";import{b as re,u as $e}from"./contexts.DfU85HX9.js";const Le=()=>{const{t:d}=k("authorization"),{t:o}=k("common"),{siteConfig:f}=re(),_=ae(),m=s.useRef(null),p=n=>{_(`/authorization/roles/${n}/edit`)},S=async n=>{var i,r;try{await z.authorization.deleteRole({id:n}),j.success(d("role.deleteSuccess",{defaultValue:"Role deleted successfully."})),(r=(i=m.current)==null?void 0:i.reload)==null||r.call(i)}catch(R){j.error(d("role.deleteError",{defaultValue:"Failed to delete role: {{error}}",error:R}))}},O=[{title:d("role.name",{defaultValue:"Role Name"}),dataIndex:"name",key:"name",render:n=>e.jsxs(P,{children:[e.jsx(Se,{}),n]})},{title:d("role.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:d("role.organization",{defaultValue:"Organization"}),key:"organization",hidden:!(f!=null&&f.enable_multi_org),render:(n,i)=>{var r;return i.organization_id?e.jsx(L,{icon:e.jsx(Re,{}),color:"blue",children:((r=i.organization)==null?void 0:r.name)||i.organization_id}):e.jsx(L,{color:"default",children:d("role.global",{defaultValue:"Global"})})}},{title:d("role.permissionCount",{defaultValue:"Permissions"}),key:"permission_count",render:(n,i)=>{var r;return e.jsxs(L,{color:"blue",children:[e.jsx(Ee,{})," ",((r=i.permissions)==null?void 0:r.length)||0]})}},{title:d("role.createdAt",{defaultValue:"Created At"}),dataIndex:"created_at",key:"created_at",render:n=>new Date(n).toLocaleString()},{title:o("actions",{defaultValue:"Actions"}),key:"action",render:(n,i)=>e.jsxs(P,{size:"small",children:[e.jsx(J,{permission:"authorization:role:update",children:e.jsx(Z,{title:d("role.edit",{defaultValue:"Edit Role"}),children:e.jsx(b,{type:"text",size:"small",icon:e.jsx(ve,{}),onClick:()=>p(i.id)})})}),e.jsx(J,{permission:"authorization:role:delete",children:e.jsx(Z,{title:d("role.delete",{defaultValue:"Delete Role"}),children:e.jsx(Ae,{title:d("role.deleteConfirm",{defaultValue:"Are you sure you want to delete this role?"}),onConfirm:()=>S(i.id),okText:o("confirm",{defaultValue:"Confirm"}),cancelText:o("cancel",{defaultValue:"Cancel"}),children:e.jsx(b,{type:"text",size:"small",danger:!0,icon:e.jsx(Pe,{})})})})})]})}];return e.jsx("div",{children:e.jsxs(B,{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:16},children:e.jsxs(we,{justify:"space-between",align:"middle",gutter:16,children:[e.jsx(Q,{children:e.jsx(P,{children:e.jsx(b,{type:"primary",onClick:()=>{var n,i;(i=(n=m.current)==null?void 0:n.reload)==null||i.call(n)},icon:e.jsx(Te,{}),children:o("refresh",{defaultValue:"Refresh"})})})}),e.jsx(Q,{children:e.jsx(J,{permission:"authorization:role:create",children:e.jsx(b,{type:"primary",icon:e.jsx(Ie,{}),onClick:()=>_("/authorization/roles/create"),children:d("role.create",{defaultValue:"Create Role"})})})})]})}),e.jsx(Me,{request:async({page_size:n,current:i})=>z.authorization.listRoles({current:i,page_size:n}),columns:O,actionRef:m})]})})},Xe=Object.freeze(Object.defineProperty({__proto__:null,default:Le},Symbol.toStringTag,{value:"Module"})),{TextArea:le}=ie,Ge=Ce(({css:d})=>({rolePermissionExtra:d`
      float: right;
      z-index: 1001;
      position: sticky;
    `,rolePolicyExtra:d`
      position: absolute;
      right: 5px;
      top: 5px;
    `})),Je={allow_all:{policy:{Statement:[{Effect:"Allow",Action:["*"]}]}},deny_all:{Statement:[{Effect:"Deny",Action:["*"]}]},allow_with_action:{Statement:[{Effect:"Allow",Action:["authorization:user:view"]}]},allow_with_condition:{Statement:[{Effect:"Allow",Action:["authorization:user:update"],Condition:{StringEquals:{"id:":"abcdef"}}},{Effect:"Deny",Action:["*"]}]},allow_with_uri:{Statement:[{Effect:"Allow",Action:["authorization:user:view"],Condition:{StringEquals:{"http.uri":"/api/users/abcdef","http.method":"GET"}}},{Effect:"Deny",Action:["*"]}]}},oe=JSON.stringify({Statement:[]},null,2),Be=()=>{const{styles:d}=Ge(),{t:o}=k("authorization"),{t:f}=k("common"),_=ae(),{id:m}=ke(),p=!!m,{enableMultiOrg:S,currentOrgId:O}=re(),{user:n}=$e(),i=(n==null?void 0:n.organizations)||[],[r]=y.useForm(),[R,w]=s.useState([]),[T,se]=s.useState([]),[ne,F]=s.useState([]),[de,N]=s.useState(!0),[U,x]=s.useState([]),[I,g]=s.useState({}),D=s.useRef({}),[ce,W]=s.useState(!1),[h,q]=s.useState("global"),[M,ue]=s.useState(void 0),[fe,H]=s.useState(!1),[me,K]=s.useState(!1);s.useEffect(()=>{D.current=I},[I]),s.useEffect(()=>{ue(O||void 0)},[]);const X=s.useCallback(async()=>{try{const l=await z.authorization.listPermissions();se(l.map((t,a)=>{const c=(t.permissions||[]).map(u=>({key:u.id,code:u.code.replace(/:/g,"."),title:u.name,orgPermission:u.org_permission||!1}));return{key:`[group]-${a}`,title:t.name,code:t.name.replace(/ /g,"_"),children:c}}))}catch{j.error(o("role.loadError",{defaultValue:"Failed to load role list"}))}},[o]);s.useEffect(()=>{X()},[X]);const E=s.useCallback(async(l,t)=>{if(!l){x([]),g(t||{});return}W(!0);try{const c=((await z.system.listToolSets({page_size:1e3,include_tools:!0},{headers:{"X-Scope-OrgID":l}})).data||[]).filter(V=>V.status==="enabled");x(c);const u=t||D.current||{},v={};c.forEach(V=>{const $=u[V.id]||[];v[V.id]=$.filter(Ve=>(V.tools||[]).some(ze=>ze.name===Ve))}),g(v)}catch{j.error(o("role.loadAiToolsetsError",{defaultValue:"Failed to load AI toolsets."})),x([]),g(t||{})}finally{W(!1)}},[o]),pe=l=>l?l.reduce((t,a)=>(!a.toolset_id||!a.tool_name||(t[a.toolset_id]||(t[a.toolset_id]=[]),t[a.toolset_id].includes(a.tool_name)||t[a.toolset_id].push(a.tool_name)),t),{}):{},Y=s.useCallback(async l=>{var t;H(!0);try{const a=await z.authorization.getRole({id:l}),c=((t=a.permissions)==null?void 0:t.map($=>$.id))||[];w(c),r.setFieldsValue({permissions:c});const u=a.organization_id||"",v=u?"organization":"global";q(v);const V=pe(a.ai_tool_permissions);v==="organization"&&u?await E(u,V):(x([]),g({})),r.setFieldsValue({name:a.name,description:a.description,role_type:v,organization_id:u||void 0,policy_document:JSON.stringify(a.policy_document||{Statement:[]},null,2)})}catch{j.error(o("role.detailLoadError",{defaultValue:"Failed to load role details"})),_("/authorization/roles")}finally{H(!1)}},[E,r,_,o]);s.useEffect(()=>{if(p&&m){Y(m);return}const l=M||(i.length>0?i[0].id:""),t=S&&l?"organization":"global";q(t),r.setFieldsValue({role_type:t,organization_id:t==="organization"?l:void 0,policy_document:oe,permissions:[]}),w([]),g({}),t==="organization"&&l?E(l,{}):x([])},[E,r,m,p,i,M,S,Y]);const he=s.useMemo(()=>h==="global"?T:T.map(t=>{const a=(t.children||[]).filter(c=>c.orgPermission===!0);return{...t,children:a}}).filter(t=>t.children&&t.children.length>0),[T,h]),ge=l=>{F(l),N(!1)},ye=()=>{const l=T.map(t=>t.key);F(l),N(!0)},xe=()=>{F([]),N(!1)},je=s.useCallback((l,t)=>{g(a=>({...a,[l]:t}))},[]),be=(l,t)=>{if(h==="organization")return Promise.resolve();if(!t||t.trim()===""||t==="{}"||t==='{"Statement":[]}')return R.length===0?Promise.reject(new Error(o("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."}))):Promise.resolve();try{return JSON.parse(t),Promise.resolve()}catch{return Promise.reject(new Error(o("role.invalidJsonFormat",{defaultValue:"Invalid JSON format."})))}},_e=async l=>{const t={...l};try{h==="global"?t.policy_document=JSON.parse(l.policy_document??"{}"):t.policy_document={Statement:[]},t.role_type==="organization"?t.organization_id=t.organization_id||void 0:t.organization_id=void 0,delete t.role_type;const a=h==="organization"?Object.entries(I).map(([c,u])=>({toolset_id:c,tools:Array.from(new Set(u))})).filter(c=>c.tools.length>0):[];t.ai_tool_permissions=a,t.permissions=R.filter(c=>!c.startsWith("[group]-")),K(!0),p&&m?(await z.authorization.updateRole({id:m},t),j.success(o("role.updateSuccess",{defaultValue:"Role updated successfully."}))):(await z.authorization.createRole(t),j.success(o("role.createSuccess",{defaultValue:"Role created successfully."}))),_("/authorization/roles")}catch{j.error(o("role.saveError",{defaultValue:"Failed to save role.",action:p?f("update",{defaultValue:"Update"}):f("create",{defaultValue:"Create"})}))}finally{K(!1)}};return e.jsx(B,{title:p?o("role.editTitle",{defaultValue:"Edit Role"}):o("role.createTitle",{defaultValue:"Create Role"}),loading:fe,children:e.jsxs(y,{form:r,layout:"vertical",initialValues:{policy_document:oe,permissions:[]},onFinish:_e,children:[e.jsx(Oe,{items:[{key:"basic",label:o("role.basicInfo",{defaultValue:"Basic Information"}),children:e.jsxs(e.Fragment,{children:[e.jsx(y.Item,{label:o("role.name",{defaultValue:"Role Name"}),name:"name",rules:[{required:!0,message:o("role.nameRequired",{defaultValue:"Please enter the role name."})}],children:e.jsx(ie,{placeholder:o("role.namePlaceholder",{defaultValue:"Enter role name"})})}),e.jsx(y.Item,{label:o("role.description",{defaultValue:"Description"}),name:"description",children:e.jsx(le,{rows:4,placeholder:o("role.descriptionPlaceholder",{defaultValue:"Enter role description"})})}),e.jsx(y.Item,{label:o("role.roleType",{defaultValue:"Role Type"}),name:"role_type",hidden:!S,rules:[{required:!0,message:o("role.roleTypeRequired",{defaultValue:"Please select role type."})}],extra:p?o("role.roleTypeCannotChange",{defaultValue:"Role type cannot be changed after creation."}):"",children:e.jsxs(G.Group,{disabled:p,onChange:l=>{const t=l.target.value;if(q(t),t==="global")r.setFieldsValue({organization_id:void 0}),x([]),g({});else{const a=M||(i.length>0?i[0].id:"");r.setFieldsValue({organization_id:a}),a?E(a,D.current):(x([]),g({}))}w([]),r.setFieldsValue({permissions:[]})},children:[e.jsx(G,{value:"global",children:o("role.globalRole",{defaultValue:"Global Role"})}),e.jsx(G,{value:"organization",children:o("role.organizationRole",{defaultValue:"Organization Role"})})]})}),h==="organization"&&e.jsx(y.Item,{hidden:!S,label:o("role.organization",{defaultValue:"Organization"}),name:"organization_id",rules:[{required:!0,message:o("role.organizationRequired",{defaultValue:"Please select an organization."})}],extra:i.length>0?o("role.organizationHelp",{defaultValue:"Select the organization this role belongs to"}):o("role.noOrganizationsAvailable",{defaultValue:"No organizations available. Please contact your administrator."}),children:i.length>0?e.jsx(C,{placeholder:o("role.selectOrganization",{defaultValue:"Select Organization"}),onChange:l=>{w([]),r.setFieldsValue({permissions:[]});const t=l||"";t?E(t,{}):(x([]),g({}))},children:i.map(l=>e.jsx(C.Option,{value:l.id,children:l.name},l.id))}):e.jsx(C,{disabled:!0,placeholder:o("role.noOrganizationsAvailable",{defaultValue:"No organizations available"})})})]})},{key:"permissions",label:o("role.permissions",{defaultValue:"Permissions"}),children:e.jsx(y.Item,{name:"permissions",rules:[{validator(){if(R.length===0)if(h==="global"){const l=r.getFieldValue("policy_document");if(!l||l.trim()===""||l==="{}"||l==='{"Statement":[]}')return Promise.reject(new Error(o("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."})))}else return Promise.reject(new Error(o("role.permissionRequired",{defaultValue:"Please select at least one permission."})));return Promise.resolve()}}],children:e.jsx("div",{children:e.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",border:"1px solid #d9d9d9",borderRadius:"4px"},children:[e.jsxs("span",{className:d.rolePermissionExtra,children:[e.jsx(b,{type:"link",onClick:ye,icon:e.jsx(Fe,{}),children:f("expandAll",{defaultValue:"Expand All"})}),e.jsx(b,{type:"link",onClick:xe,icon:e.jsx(Ne,{}),children:f("collapseAll",{defaultValue:"Collapse All"})})]}),e.jsx(De,{treeData:he,titleRender:l=>{const t=l,a=typeof t.title=="string"?t.title:String(t.title??"");return e.jsx("span",{children:o(`permission.title.${t.code}`,{defaultValue:a})})},checkable:!0,expandedKeys:ne,autoExpandParent:de,onExpand:ge,checkedKeys:R,onCheck:l=>{let t=[];ee.isArray(l)?t=l:ee.has(l,"checked")&&(t=l.checked),w(t),r.setFieldsValue({permissions:t})}})]})})})},{key:"ai-tools",label:o("role.aiPermissions",{defaultValue:"AI Tool Permissions"}),disabled:h==="global",children:e.jsx(qe,{spinning:ce,children:h==="organization"?U.length>0?e.jsx(P,{direction:"vertical",size:"middle",style:{width:"100%"},children:U.map(l=>e.jsx(B,{size:"small",title:l.name,extra:l.description?e.jsx("span",{children:l.description}):void 0,children:(l.tools||[]).length>0?e.jsx(te.Group,{style:{width:"100%"},value:I[l.id]||[],onChange:t=>je(l.id,t),children:e.jsx(P,{direction:"vertical",style:{width:"100%"},children:(l.tools||[]).map(t=>e.jsx(te,{value:t.name,children:e.jsxs("div",{children:[e.jsx("div",{children:t.name}),t.description&&e.jsx("div",{style:{color:"rgba(0,0,0,0.45)",fontSize:12},children:t.description})]})},t.name))})}):e.jsx(A,{image:A.PRESENTED_IMAGE_SIMPLE,description:o("role.aiToolsetNoTools",{defaultValue:"No tools available in this toolset."})})},l.id))}):e.jsx(A,{image:A.PRESENTED_IMAGE_SIMPLE,description:o("role.aiToolsetsEmpty",{defaultValue:"No AI toolsets available for this organization."})}):e.jsx(A,{image:A.PRESENTED_IMAGE_SIMPLE,description:o("role.aiPermissionsGlobalInfo",{defaultValue:"AI tool permissions are only available for organization roles."})})})},{key:"policy",label:o("role.policyDocument",{defaultValue:"Policy Document"}),disabled:h==="organization",children:e.jsx(y.Item,{name:"policy_document",rules:[{validator:be}],extra:e.jsx("span",{className:d.rolePolicyExtra,children:e.jsx(C,{style:{width:160},placeholder:o("role.insertTemplate",{defaultValue:"Insert Template"}),options:[{label:o("role.allowAll",{defaultValue:"Allow All"}),value:"allow_all"},{label:o("role.denyAll",{defaultValue:"Deny All"}),value:"deny_all"},{label:o("role.allowWithAction",{defaultValue:"Allow with Action"}),value:"allow_with_action"},{label:o("role.denyWithCondition",{defaultValue:"Allow with Condition"}),value:"allow_with_condition"},{label:o("role.allowWithUri",{defaultValue:"Allow with URI"}),value:"allow_with_uri"}],onChange:l=>{if(typeof l=="string"){const t=Je[l];t&&r.setFieldValue("policy_document",JSON.stringify(t,null,2))}}})}),children:e.jsx(le,{rows:15,style:{fontFamily:"monospace"},placeholder:`{
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "account:EnableRegion",
                "account:DisableRegion"
            ],
            "Condition": {
                "StringEquals": {"id:": "abcdef"}
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "*"
            ]
        }
    ]
}`})})}]}),e.jsx(y.Item,{children:e.jsxs(P,{children:[e.jsx(b,{type:"primary",htmlType:"submit",loading:me,children:p?f("update",{defaultValue:"Update"}):f("create",{defaultValue:"Create"})}),e.jsx(b,{onClick:()=>_("/authorization/roles"),children:f("cancel",{defaultValue:"Cancel"})})]})})]})})},Ye=Object.freeze(Object.defineProperty({__proto__:null,default:Be},Symbol.toStringTag,{value:"Module"}));export{Xe as R,Ye as a};
