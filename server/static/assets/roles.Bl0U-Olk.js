import{c as H,u as C,F as d,r as i,j as e,E as b,af as Q,O as Z,aK as X,a2 as v,n as u,aN as ee,V as te,aO as le,C as ae,Y as oe,Z as k,a1 as re,aP as ie,M as se,m as z,aQ as A,aR as ne,aS as ce,aT as de,an as I,_ as ue,s as p}from"./vendor.5VlR7AZZ.js";import{f as E,T as me}from"./components.Hu8o1XqG.js";import{a as f}from"./index.Cq3ia0Rf.js";import"./vite.BF1G3H_w.js";import"./contexts.B2_ihE-j.js";import"./client.Bxbi3rzc.js";import"./base.BCJy1ny5.js";import"./authorization.BtxSOE4l.js";import"./system.BY_RKaj3.js";import"./oauth.CNxiEEVf.js";const{TextArea:T}=z,pe=H(({css:s})=>({rolePolicy:s`
       .ant-collapse-content>.ant-collapse-content-box{
        padding: 2px;
      }
      .ant-form-item-additional>#policy_document_extra{
        min-height: 0;
      }
      .ant-tree .ant-tree-node-content-wrapper{
        flex: none;
      }
    `,rolePermissionExtra:s`
      float: right;
      z-index: 1001;
      position: sticky;
    `,rolePolicyExtra:s`
      position: absolute;
      right: 5px;
      top: 5px;
    `})),ge=()=>{const{styles:s}=pe(),{t:l}=C("authorization"),{t:n}=C("common"),[c]=d.useForm(),[D,g]=i.useState(!1),[F,h]=i.useState(!1),[j,_]=i.useState(null),[m,x]=i.useState([]),y=i.useRef(null),[P,N]=i.useState([]),[O,w]=i.useState([]),[$,V]=i.useState(!0),q=t=>{w(t),V(!1)},J=()=>{const t=P.map(a=>a.key);w(t),V(!0)},M=()=>{w([]),V(!1)},W=()=>{_(null),x([]),c.resetFields(),h(!0)},L=t=>{var a,o;_(t),x(((a=t.permissions)==null?void 0:a.map(r=>r.id))||[]),c.setFieldsValue({name:t.name,description:t.description,permissions:((o=t.permissions)==null?void 0:o.map(r=>r.id))||[],policy_document:JSON.stringify(t.policy_document,null,2)}),h(!0)},B=async t=>{var a,o;try{await f.authorization.deleteRole({id:t}),p.success(l("role.deleteSuccess",{defaultValue:"Role deleted successfully."})),(o=(a=y.current)==null?void 0:a.reload)==null||o.call(a)}catch(r){p.error(l("role.deleteError",{defaultValue:"Failed to delete role: {{error}}",error:r}))}},K=(t,a)=>{if(!a)return m.length===0?Promise.reject(new Error(l("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."}))):Promise.resolve();try{return JSON.parse(a),Promise.resolve()}catch{return Promise.reject(new Error(l("role.invalidJsonFormat",{defaultValue:"Invalid JSON format."})))}},G=async t=>{var a,o;try{t.policy_document=JSON.parse(t.policy_document??{}),g(!0),j?(await f.authorization.updateRole({id:j.id},{...t,permissions:m.filter(r=>!r.startsWith("[group]-"))}),p.success(l("role.updateSuccess",{defaultValue:"Role updated successfully."}))):(await f.authorization.createRole({...t,permissions:m.filter(r=>!r.startsWith("[group]-"))}),p.success(l("role.createSuccess",{defaultValue:"Role created successfully."}))),h(!1),(o=(a=y.current)==null?void 0:a.reload)==null||o.call(a)}catch(r){console.error(l("role.saveError",{defaultValue:"Failed to save role."}),r),p.error(l("role.saveError",{defaultValue:"Failed to save role."}))}finally{g(!1)}},U=[{title:l("role.name",{defaultValue:"Role Name"}),dataIndex:"name",key:"name",render:t=>e.jsxs(b,{children:[e.jsx(Q,{}),t]})},{title:l("role.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:l("role.permissionCount",{defaultValue:"Permissions"}),key:"permission_count",render:(t,a)=>{var o;return e.jsxs(Z,{color:"blue",children:[e.jsx(X,{})," ",((o=a.permissions)==null?void 0:o.length)||0]})}},{title:l("role.createdAt",{defaultValue:"Created At"}),dataIndex:"created_at",key:"created_at",render:t=>new Date(t).toLocaleString()},{title:n("actions",{defaultValue:"Actions"}),key:"action",render:(t,a)=>e.jsxs(b,{size:"small",children:[e.jsx(E,{permission:"authorization:role:update",children:e.jsx(v,{title:l("role.edit",{defaultValue:"Edit Role"}),children:e.jsx(u,{type:"text",size:"small",icon:e.jsx(ee,{}),onClick:()=>L(a)})})}),e.jsx(E,{permission:"authorization:role:delete",children:e.jsx(v,{title:l("role.delete",{defaultValue:"Delete Role"}),children:e.jsx(te,{title:l("role.deleteConfirm",{defaultValue:"Are you sure you want to delete this role?"}),onConfirm:()=>B(a.id),okText:n("confirm",{defaultValue:"Confirm"}),cancelText:n("cancel",{defaultValue:"Cancel"}),children:e.jsx(u,{type:"text",size:"small",danger:!0,icon:e.jsx(le,{})})})})})]})}],Y={allow_all:{policy:{Statement:[{Effect:"Allow",Action:["*"]}]}},deny_all:{Statement:[{Effect:"Deny",Action:["*"]}]},allow_with_action:{Statement:[{Effect:"Allow",Action:["authorization:user:view"]}]},allow_with_condition:{Statement:[{Effect:"Allow",Action:["authorization:user:update"],Condition:{StringEquals:{"id:":"abcdef"}}},{Effect:"Deny",Action:["*"]}]},allow_with_uri:{Statement:[{Effect:"Allow",Action:["authorization:user:view"],Condition:{StringEquals:{"http.uri":"/api/users/abcdef","http.method":"GET"}}},{Effect:"Deny",Action:["*"]}]}},S=async()=>{f.authorization.listPermissions().then(t=>{N(t.map((a,o)=>{var r;return{key:`[group]-${o}`,title:a.name,code:a.name.replace(/ /g,"_"),children:(r=a.permissions)==null?void 0:r.map(R=>({key:R.id,code:R.code.replace(/:/g,"."),title:R.name}))}}))})};return i.useEffect(()=>{S()},[]),e.jsxs("div",{children:[e.jsxs(ae,{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:16},children:e.jsxs(oe,{justify:"space-between",align:"middle",children:[e.jsx(k,{children:e.jsx(u,{type:"primary",onClick:()=>{var t,a;(a=(t=y.current)==null?void 0:t.reload)==null||a.call(t),S()},icon:e.jsx(re,{}),children:n("refresh",{defaultValue:"Refresh"})})}),e.jsx(k,{children:e.jsx(E,{permission:"authorization:role:create",children:e.jsx(u,{type:"primary",icon:e.jsx(ie,{}),onClick:W,children:l("role.create",{defaultValue:"Create Role"})})})})]})}),e.jsx(me,{request:async({page_size:t,current:a})=>f.authorization.listRoles({current:a,page_size:t}),columns:U,actionRef:y})]}),e.jsx(se,{title:j?l("role.editTitle",{defaultValue:"Edit Role"}):l("role.createTitle",{defaultValue:"Create Role"}),open:F,onOk:c.submit,onCancel:()=>h(!1),confirmLoading:D,children:e.jsxs(d,{form:c,layout:"vertical",onFinish:G,children:[e.jsx(d.Item,{label:l("role.name",{defaultValue:"Role Name"}),name:"name",rules:[{required:!0,message:l("role.nameRequired",{defaultValue:"Please enter the role name."})}],children:e.jsx(z,{placeholder:l("role.namePlaceholder",{defaultValue:"Enter role name"})})}),e.jsx(d.Item,{label:l("role.description",{defaultValue:"Description"}),name:"description",children:e.jsx(T,{rows:4,placeholder:l("role.descriptionPlaceholder",{defaultValue:"Enter role description"})})}),e.jsxs(A,{accordion:!0,bordered:!1,className:s.rolePolicy,children:[e.jsx(A.Panel,{forceRender:!0,header:l("role.permissions",{defaultValue:"Permissions"}),style:{padding:0},children:e.jsx(d.Item,{name:"permissions",rules:[{validator(){return m.length===0&&!c.getFieldValue("policy_document")?Promise.reject(new Error(l("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."}))):Promise.resolve()}}],children:e.jsx("div",{children:e.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",border:"1px solid #d9d9d9",borderRadius:"4px"},children:[e.jsxs("span",{className:s.rolePermissionExtra,children:[e.jsx(u,{type:"link",onClick:J,icon:e.jsx(ne,{}),children:n("expandAll",{defaultValue:"Expand All"})}),e.jsx(u,{type:"link",onClick:M,icon:e.jsx(ce,{}),children:n("collapseAll",{defaultValue:"Collapse All"})})]}),e.jsx(de,{treeData:P,titleRender:t=>e.jsx("span",{children:l(`permission.title.${t.code}`,{defaultValue:t.title})}),checkable:!0,expandedKeys:O,autoExpandParent:$,onExpand:q,checkedKeys:m,onCheck:t=>{I.isArray(t)?x(t):I.has(t,"checked")&&x(t.checked)}})]})})})},"permissions"),e.jsx(A.Panel,{forceRender:!0,header:l("role.policyDocument",{defaultValue:"Policy Document (JSON)"}),children:e.jsx(d.Item,{name:"policy_document",rules:[{validator:K}],extra:e.jsx("span",{className:s.rolePolicyExtra,children:e.jsx(ue,{style:{width:120},placeholder:l("role.insertTemplate",{defaultValue:"Insert Template"}),value:l("role.insertTemplate",{defaultValue:"Insert Template"}),options:[{label:l("role.allowAll",{defaultValue:"Allow All"}),value:"allow_all"},{label:l("role.denyAll",{defaultValue:"Deny All"}),value:"deny_all"},{label:l("role.allowWithAction",{defaultValue:"Allow with Action"}),value:"allow_with_action"},{label:l("role.denyWithCondition",{defaultValue:"Allow with Condition"}),value:"allow_with_condition"},{label:l("role.allowWithUri",{defaultValue:"Allow with URI"}),value:"allow_with_uri"}],onChange:t=>{const a=Y[t];a&&c.setFieldValue("policy_document",JSON.stringify(a,null,2))}})}),children:e.jsx(T,{rows:15,style:{fontFamily:"monospace"},placeholder:`{
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "account:EnableRegion",
                "account:DisableRegion"
            ],
            "Condition": {
                "StringEquals": {"id:": "abcdef"}
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "*"
            ]
        }
    ]
}`})})},"policy_document")]})]})})]})};export{ge as default};
