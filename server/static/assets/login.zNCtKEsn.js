import{c as re,b5 as se,bj as ie,bH as ne,u as le,r as s,aJ as c,j as e,aw as ge,h as i,aq as de,W as ce,aN as M,ao as x,bI as me,bc as ue,bJ as fe,B as $,a6 as pe,f as he,ay as xe,bK as we,s as B,bL as je}from"./vendor.B6JBhCAY.js";import{a as be,c as ye}from"./contexts.Ca4oT16l.js";import{a as U}from"./index.Bm7X5fEY.js";import{A as D}from"./client.C_z0mq-g.js";import{L as J,a as Pe,b as _e}from"./components.CP7t-rAl.js";import{m as Ne,g as Ve}from"./base.BXKr0a0H.js";import"./vite.BF1G3H_w.js";import"./lodash.BDtH7uFP.js";import"./highlight.BslI14e2.js";import"./ai.BlO1DqPv.js";import"./authorization.B5peLd2a.js";import"./system.BGeF3M7c.js";import"./oauth.ClVdJKPp.js";import"./ai-chat-layout.BT1nS6nA.js";import"./ant-design-x.BIkQt4u4.js";import"./highlighter.06nRe2Bn.js";import"./refractor.CIIjg-xe.js";import"./mermaid.X6yIL1F5.js";const{Title:Le}=ce,Se=re(({css:n})=>({loginPageContainer:n`
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f0f2f5;
    `,loginPageCard:n`
      width: 400px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    `,languageSwitch:n`
      position: absolute;
      top: 0;
      right: 0;
    `,loginPageTitle:n`
      text-align: center;
      margin-bottom: 20px;
    `,loginPageError:n`
      margin-bottom: 20px;
    `,loginPageMfaAlert:n`
      margin-bottom: 20px;
    `,loginPageProviders:n`
      width: 100%;
    `})),ze=({transformLangConfig:n})=>{const{styles:m}=Se(),h=se(),W=ie(),[l]=ne(),{login:L,oauthLogin:S,user:v}=be(),{t:r,i18n:y}=le(),[k,g]=s.useState(null),[P,A]=s.useState({}),[u,w]=s.useState("login"),[z,H]=s.useState(null),[_,K]=s.useState(null),[f,X]=s.useState(null),[j]=c.useForm(),I=s.useRef(!1),[Y,T]=s.useState(!1),[E,F]=s.useState([]),[N,V]=s.useState(0),{siteConfig:o,loading:G,error:b}=ye(),[Q,R]=s.useState("Loading..."),O=async t=>{const d=async a=>"username"in a?await L({username:a.username,password:a.password}):"mfa_token"in a?await L({mfa_token:a.mfa_token,mfa_code:a.mfa_code}):await S({code:a.code,state:a.state,provider:a.provider});try{T(!0);const a=await d(t);if(we(),await new Promise(p=>setTimeout(p,100)),a&&a.mfa_enforced&&!a.mfa_enabled&&W.pathname!=="/profile")h("/profile#mfa");else{const p=l.get("redirect");p?window.location.href=p:o!=null&&o.home_page?window.location.href=o.home_page:h("/")}}catch(a){if(a.password_expired)w("password_expired"),H(a.token),g(null);else if(a.needsMFA)g(null),w("mfa"),h("/login",{replace:!0}),K(a.mfaType),X(a.user),j.setFieldValue("mfa_token",a.mfaToken);else if("username"in t||"mfa_token"in t)if(a instanceof D?g(r("login.error",{defaultValue:"Login failed: {{error}}",error:r(`login.${a}`,{defaultValue:a.message})})):g(typeof a=="string"?a:r("login.error",{defaultValue:"Login failed"})),"mfa_token"in t){V(30);const p=setInterval(()=>{V(q=>q>=1?q-1:0)},1e3);setTimeout(()=>{clearInterval(p),V(0)},3e4)}else"username"in t&&w("login");else a instanceof D?g(r("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:r(`login.${a.code}`,{defaultValue:a.message})})):g(typeof a=="string"?a:r("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:a})),h("/login",{replace:!0}),C()}finally{T(!1)}},C=async()=>{try{F(await U.oauth.getProviders()||[])}catch(t){B.error(r("login.fetchOAuthProvidersError",{defaultValue:"Failed to fetch OAuth providers: {{error}}",error:t.message||t.toString()})),F([])}};s.useEffect(()=>{if(!I.current){I.current=!0;const t=l.get("code"),d=l.get("state"),a=l.get("provider");t&&d&&a?O({code:t,state:d,provider:a}):C()}},[l,S]),s.useEffect(()=>{y.language&&R((o==null?void 0:o.name_i18n[y.language])||(o==null?void 0:o.name)||"")},[o,y.language]);const Z=async t=>{try{A({...P,[t]:!0});const{url:d}=await U.oauth.getLoginUrl({provider:t},{headers:{"X-Base-Path":Ve()}});window.location.href=d}catch(d){B.error(r("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",d)}finally{A({...P,[t]:!1})}},ee=t=>{switch(t.toLowerCase()){case"github":return e.jsx(je,{});default:return null}},ae=l.get("code"),te=l.get("state"),oe=l.get("provider");if(s.useEffect(()=>{var t;o&&(R(o.name),window.document.title=o.name,(t=document.getElementById("site-icon"))==null||t.setAttribute("href",o.logo||""))},[o]),G)return e.jsx(J,{});if(!o)return e.jsx(ge,{status:"500",title:"500",subTitle:r("login.fetchSiteConfigError",{defaultValue:"Failed to fetch site config: {{error}}",error:(b==null?void 0:b.message)||b})});if(ae&&te&&oe)return e.jsx(J,{});if(v&&v.status==="active"){const t=l.get("redirect");t?window.location.href=t:o!=null&&o.home_page?window.location.href=o.home_page:h("/")}return e.jsx("div",{className:"login-page",children:e.jsx("div",{className:i(m.loginPageContainer,"login-page-container"),children:e.jsxs(de,{className:i(m.loginPageCard,"login-page-card"),children:[e.jsx("div",{className:i(m.languageSwitch,"language-switch"),children:e.jsx(Pe,{transformLangConfig:n})}),e.jsxs("div",{className:i(m.loginPageTitle,"login-page-title"),children:[e.jsx(Le,{className:"login-page-title-text",level:2,children:Q}),e.jsx("p",{className:"login-page-subtitle-text",children:r("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),k&&e.jsx(M,{className:i(m.loginPageError,"login-page-error"),message:k,type:"error",showIcon:!0}),u==="mfa"&&_&&e.jsx(M,{message:r(`login.mfaTips.${_}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,className:i(m.loginPageMfaAlert,"login-page-mfa-alert")}),e.jsxs(c,{name:"login",initialValues:{remember:!0},onFinish:O,size:"large",form:j,hidden:u==="password_expired",className:"login-page-form",children:[u==="mfa"&&e.jsxs(e.Fragment,{children:[e.jsx(c.Item,{hidden:!(f!=null&&f.email)||_!=="email",className:i("login-page-form-item","login-page-form-email"),children:e.jsx(x,{value:Ne(f==null?void 0:f.email)})}),e.jsx(c.Item,{name:"mfa_token",hidden:!0,className:i("login-page-form-item","login-page-form-mfa-token"),children:e.jsx(x,{})}),e.jsx(c.Item,{name:"mfa_code",hidden:u!=="mfa",className:i("login-page-form-item","login-page-form-mfa-code"),children:e.jsx(x,{placeholder:r("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsx(me,{})})})]}),u==="login"&&e.jsxs(e.Fragment,{children:[e.jsx(c.Item,{name:"username",rules:[{required:!0,message:r("login.usernameRequired",{defaultValue:"Username is required"})}],className:i("login-page-form-item","login-page-form-username"),children:e.jsx(x,{prefix:e.jsx(ue,{}),placeholder:r("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsx(c.Item,{name:"password",rules:[{required:!0,message:r("login.passwordRequired",{defaultValue:"Password is required"})}],className:i("login-page-form-item","login-page-form-password"),children:e.jsx(x.Password,{prefix:e.jsx(fe,{}),placeholder:r("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsx(c.Item,{className:i("login-page-form-item","login-page-form-submit"),children:e.jsx($,{disabled:N>0,type:"primary",htmlType:"submit",loading:Y,block:!0,children:N>0?e.jsxs("span",{style:{marginLeft:8},children:[N,"s"]}):r("login.login",{defaultValue:"Login"})})})]}),E.length>0&&u!=="password_expired"&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:i("login-page-divider","login-page-divider-or"),children:r("login.or",{defaultValue:"Or"})}),e.jsx(he,{direction:"vertical",className:i(m.loginPageProviders,"login-page-providers"),children:E.map(t=>e.jsx($,{icon:ee(t.name),onClick:()=>Z(t.name),loading:P[t.name],block:!0,children:t.icon_url?e.jsx(xe,{src:t.icon_url}):r("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:t.display_name})},t.name))})]}),u==="password_expired"&&e.jsx(_e,{className:"login-page-password-expired",onSuccess:()=>{w("login"),j.setFieldValue("password",""),j.setFieldValue("mfa_code","")},token:z||void 0})]})})})};export{ze as default};
