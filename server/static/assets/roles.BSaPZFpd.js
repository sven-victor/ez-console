import{u as M,b5 as se,r as s,j as e,f as P,bc as we,T as C,aH as Pe,bJ as le,p as U,B as j,da as Te,aV as Ie,e as Ce,aq as K,aY as ke,aZ as oe,d as Oe,b as Ne,s as S,c as Fe,db as De,aJ as x,aN as Me,d7 as qe,ao as ne,i as W,g as D,dc as Ge,dd as Le,de as $e,S as Je,b1 as H,aW as w}from"./vendor.B6JBhCAY.js";import{f as Y,T as Be}from"./components.CP7t-rAl.js";import{a as R}from"./index.Bm7X5fEY.js";import{c as re,b as Ue,a as We}from"./contexts.Ca4oT16l.js";import{i as He,h as Ye}from"./lodash.BDtH7uFP.js";const Ke=()=>{const{t:n}=M("authorization"),{t:E}=M("common"),{siteConfig:o}=re(),h=se(),b=s.useRef(null),_=d=>{h(`/authorization/roles/${d}/edit`)},p=async d=>{var i,c;try{await R.authorization.deleteRole({id:d}),S.success(n("role.deleteSuccess",{defaultValue:"Role deleted successfully."})),(c=(i=b.current)==null?void 0:i.reload)==null||c.call(i)}catch(f){S.error(n("role.deleteError",{defaultValue:"Failed to delete role: {{error}}",error:f}))}},v=[{title:n("role.name",{defaultValue:"Role Name"}),dataIndex:"name",key:"name",render:d=>e.jsxs(P,{children:[e.jsx(we,{}),d]})},{title:n("role.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:n("role.roleType",{defaultValue:"Role Type"}),key:"role_type",render:(d,i)=>i.role_type==="system"?e.jsx(C,{color:"orange",children:n("role.typeSystem",{defaultValue:"System"})}):e.jsx(C,{color:"default",children:n("role.typeUser",{defaultValue:"User"})})},{title:n("role.organization",{defaultValue:"Organization"}),key:"organization",hidden:!(o!=null&&o.enable_multi_org),render:(d,i)=>{var c;return i.organization_id?e.jsx(C,{icon:e.jsx(Pe,{}),color:"blue",children:((c=i.organization)==null?void 0:c.name)||i.organization_id}):e.jsx(C,{color:"default",children:n("role.global",{defaultValue:"Global"})})}},{title:n("role.permissionCount",{defaultValue:"Permissions"}),key:"permission_count",render:(d,i)=>{var c;return e.jsxs(C,{color:"blue",children:[e.jsx(le,{})," ",((c=i.permissions)==null?void 0:c.length)||0]})}},{title:n("role.createdAt",{defaultValue:"Created At"}),dataIndex:"created_at",key:"created_at",render:d=>new Date(d).toLocaleString()},{title:E("actions",{defaultValue:"Actions"}),key:"action",render:(d,i)=>{const c=i.role_type==="system";return e.jsxs(P,{size:"small",children:[!c&&e.jsxs(e.Fragment,{children:[e.jsx(Y,{permission:"authorization:role:update",children:e.jsx(U,{title:n("role.edit",{defaultValue:"Edit Role"}),children:e.jsx(j,{type:"text",size:"small",icon:e.jsx(Te,{}),onClick:()=>_(i.id)})})}),e.jsx(Y,{permission:"authorization:role:delete",children:e.jsx(U,{title:n("role.delete",{defaultValue:"Delete Role"}),children:e.jsx(Ie,{title:n("role.deleteConfirm",{defaultValue:"Are you sure you want to delete this role?"}),onConfirm:()=>p(i.id),okText:E("confirm",{defaultValue:"Confirm"}),cancelText:E("cancel",{defaultValue:"Cancel"}),children:e.jsx(j,{type:"text",size:"small",danger:!0,icon:e.jsx(Ce,{})})})})})]}),c&&e.jsx(U,{title:n("role.systemRoleCannotModify",{defaultValue:"System roles cannot be modified."}),children:e.jsx("span",{children:e.jsx(j,{type:"text",size:"small",icon:e.jsx(le,{}),disabled:!0})})})]})}}];return e.jsx("div",{children:e.jsxs(K,{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:16},children:e.jsxs(ke,{justify:"space-between",align:"middle",gutter:16,children:[e.jsx(oe,{children:e.jsx(P,{children:e.jsx(j,{type:"primary",onClick:()=>{var d,i;(i=(d=b.current)==null?void 0:d.reload)==null||i.call(d)},icon:e.jsx(Oe,{}),children:E("refresh",{defaultValue:"Refresh"})})})}),e.jsx(oe,{children:e.jsx(Y,{permission:"authorization:role:create",children:e.jsx(j,{type:"primary",icon:e.jsx(Ne,{}),onClick:()=>h("/authorization/roles/create"),children:n("role.create",{defaultValue:"Create Role"})})})})]})}),e.jsx(Be,{request:async({page_size:d,current:i})=>R.authorization.listRoles({current:i,page_size:d}),columns:v,actionRef:b})]})})},it=Object.freeze(Object.defineProperty({__proto__:null,default:Ke},Symbol.toStringTag,{value:"Module"})),{TextArea:ae}=ne,Xe=Fe(({css:n})=>({rolePermissionExtra:n`
      float: right;
      z-index: 1001;
      position: sticky;
    `,rolePolicyExtra:n`
      position: absolute;
      right: 5px;
      top: 5px;
    `})),Ze={allow_all:{policy:{Statement:[{Effect:"Allow",Action:["*"]}]}},deny_all:{Statement:[{Effect:"Deny",Action:["*"]}]},allow_with_action:{Statement:[{Effect:"Allow",Action:["authorization:user:view"]}]},allow_with_condition:{Statement:[{Effect:"Allow",Action:["authorization:user:update"],Condition:{StringEquals:{"id:":"abcdef"}}},{Effect:"Deny",Action:["*"]}]},allow_with_uri:{Statement:[{Effect:"Allow",Action:["authorization:user:view"],Condition:{StringEquals:{"http.uri":"/api/users/abcdef","http.method":"GET"}}},{Effect:"Deny",Action:["*"]}]}},ie=JSON.stringify({Statement:[]},null,2),Qe=()=>{const{styles:n}=Xe(),{hasGlobalPermission:E}=Ue(),{t:o}=M("authorization"),{t:h}=M("common"),b=se(),{id:_}=De(),p=!!_,{enableMultiOrg:v,currentOrgId:d}=re(),{user:i}=We(),c=(i==null?void 0:i.organizations)||[],[f]=x.useForm(),[k,T]=s.useState([]),[O,de]=s.useState([]),[ce,q]=s.useState([]),[ue,G]=s.useState(!0),[N,V]=s.useState([]),[I,g]=s.useState({}),L=s.useRef({}),[me,X]=s.useState(!1),[y,$]=s.useState("global"),[J,fe]=s.useState(void 0),[pe,Z]=s.useState(!1),[he,Q]=s.useState(!1),[ge,ye]=s.useState(!1);s.useEffect(()=>{L.current=I},[I]),s.useEffect(()=>{fe(d||void 0)},[]);const ee=s.useCallback(async()=>{try{const l=await R.authorization.listPermissions();de(l.map((t,a)=>{const u=(t.permissions||[]).map(r=>({key:r.id,code:r.code.replace(/:/g,"."),title:r.name,orgPermission:r.org_permission||!1}));return{key:`[group]-${a}`,title:t.name,code:t.name.replace(/ /g,"_"),children:u}}))}catch{S.error(o("role.loadError",{defaultValue:"Failed to load role list"}))}},[o]);s.useEffect(()=>{ee()},[ee]);const A=s.useCallback(async(l,t)=>{if(!l){V([]),g(t||{});return}X(!0);try{const u=((await R.system.listToolSets({page_size:1e3,include_tools:!0},{headers:{"X-Scope-OrgID":l}})).data||[]).filter(z=>z.status==="enabled");V(u);const r=t||L.current||{},m={};u.forEach(z=>{const B=r[z.id]||[];m[z.id]=B.filter(ve=>(z.tools||[]).some(Ae=>Ae.name===ve))}),g(m)}catch{S.error(o("role.loadAiToolsetsError",{defaultValue:"Failed to load AI toolsets."})),V([]),g(t||{})}finally{X(!1)}},[o]),xe=l=>l?l.reduce((t,a)=>(!a.toolset_id||!a.tool_name||(t[a.toolset_id]||(t[a.toolset_id]=[]),t[a.toolset_id].includes(a.tool_name)||t[a.toolset_id].push(a.tool_name)),t),{}):{},te=s.useCallback(async l=>{var t;Z(!0);try{const a=await R.authorization.getRole({id:l});ye(a.role_type==="system");const u=((t=a.permissions)==null?void 0:t.map(B=>B.id))||[];T(u),f.setFieldsValue({permissions:u});const r=a.organization_id||"",m=r?"organization":"global";$(m);const z=xe(a.ai_tool_permissions);m==="organization"&&r?await A(r,z):(V([]),g({})),f.setFieldsValue({name:a.name,description:a.description,role_type:m,organization_id:r||void 0,policy_document:JSON.stringify(a.policy_document||{Statement:[]},null,2)})}catch{S.error(o("role.detailLoadError",{defaultValue:"Failed to load role details"})),b("/authorization/roles")}finally{Z(!1)}},[A,f,b,o]);s.useEffect(()=>{if(p&&_){te(_);return}const l=J||(c.length>0?c[0].id:""),t=v&&l?"organization":"global";$(t),f.setFieldsValue({role_type:t,organization_id:t==="organization"?l:void 0,policy_document:ie,permissions:[]}),T([]),g({}),t==="organization"&&l?A(l,{}):V([])},[A,f,_,p,c,J,v,te]);const je=s.useMemo(()=>y==="global"?O:O.map(t=>{const a=(t.children||[]).filter(u=>u.orgPermission===!0);return{...t,children:a}}).filter(t=>t.children&&t.children.length>0),[O,y]),be=l=>{q(l),G(!1)},_e=()=>{const l=O.map(t=>t.key);q(l),G(!0)},Ve=()=>{q([]),G(!1)},Se=s.useCallback((l,t)=>{g(a=>({...a,[l]:t}))},[]),ze=s.useCallback((l,t)=>{const a=N.find(r=>r.id===l);if(!a)return;const u=(a.tools||[]).map(r=>r.name);g(r=>({...r,[l]:t?u:[]}))},[N]),Re=(l,t)=>{if(y==="organization")return Promise.resolve();if(!t||t.trim()===""||t==="{}"||t==='{"Statement":[]}')return k.length===0?Promise.reject(new Error(o("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."}))):Promise.resolve();try{return JSON.parse(t),Promise.resolve()}catch{return Promise.reject(new Error(o("role.invalidJsonFormat",{defaultValue:"Invalid JSON format."})))}},Ee=async l=>{const t={...l};try{y==="global"?t.policy_document=JSON.parse(l.policy_document??"{}"):t.policy_document={Statement:[]},t.role_type==="organization"?t.organization_id=t.organization_id||void 0:t.organization_id=void 0,delete t.role_type;const a=y==="organization"?Object.entries(I).map(([u,r])=>({toolset_id:u,tools:Array.from(new Set(r))})).filter(u=>u.tools.length>0):[];t.ai_tool_permissions=a,t.permissions=k.filter(u=>!u.startsWith("[group]-")),Q(!0),p&&_?(await R.authorization.updateRole({id:_},t),S.success(o("role.updateSuccess",{defaultValue:"Role updated successfully."}))):(await R.authorization.createRole(t),S.success(o("role.createSuccess",{defaultValue:"Role created successfully."}))),b("/authorization/roles")}catch(a){S.error(o("role.saveError",{error:a instanceof Error?a.message:"Unknown error",defaultValue:"Failed to save role.",action:p?h("update",{defaultValue:"Update"}):h("create",{defaultValue:"Create"})}))}finally{Q(!1)}},F=p&&ge;return e.jsxs(K,{title:F?o("role.viewTitle",{defaultValue:"View Role"}):p?o("role.editTitle",{defaultValue:"Edit Role"}):o("role.createTitle",{defaultValue:"Create Role"}),loading:pe,children:[F&&e.jsx(Me,{type:"info",message:o("role.systemRoleCannotModify",{defaultValue:"System roles cannot be modified."}),style:{marginBottom:16},showIcon:!0}),e.jsxs(x,{form:f,layout:"vertical",disabled:F,initialValues:{policy_document:ie,permissions:[]},onFinish:Ee,children:[e.jsx(qe,{items:[{key:"basic",label:o("role.basicInfo",{defaultValue:"Basic Information"}),children:e.jsxs(e.Fragment,{children:[e.jsx(x.Item,{label:o("role.name",{defaultValue:"Role Name"}),name:"name",rules:[{required:!0,message:o("role.nameRequired",{defaultValue:"Please enter the role name."})}],children:e.jsx(ne,{placeholder:o("role.namePlaceholder",{defaultValue:"Enter role name"})})}),e.jsx(x.Item,{label:o("role.description",{defaultValue:"Description"}),name:"description",children:e.jsx(ae,{rows:4,placeholder:o("role.descriptionPlaceholder",{defaultValue:"Enter role description"})})}),e.jsx(x.Item,{label:o("role.roleType",{defaultValue:"Role Type"}),name:"role_type",hidden:!v,rules:[{required:!0,message:o("role.roleTypeRequired",{defaultValue:"Please select role type."})}],extra:p?o("role.roleTypeCannotChange",{defaultValue:"Role type cannot be changed after creation."}):"",children:e.jsxs(W.Group,{disabled:p||!E("authorization:role:create"),onChange:l=>{const t=l.target.value;if($(t),t==="global")f.setFieldsValue({organization_id:void 0}),V([]),g({});else{const a=J||(c.length>0?c[0].id:"");f.setFieldsValue({organization_id:a}),a?A(a,L.current):(V([]),g({}))}T([]),f.setFieldsValue({permissions:[]})},children:[e.jsx(W,{value:"global",children:o("role.globalRole",{defaultValue:"Global Role"})}),e.jsx(W,{value:"organization",children:o("role.organizationRole",{defaultValue:"Organization Role"})})]})}),y==="organization"&&e.jsx(x.Item,{hidden:!v,label:o("role.organization",{defaultValue:"Organization"}),name:"organization_id",rules:[{required:!0,message:o("role.organizationRequired",{defaultValue:"Please select an organization."})}],extra:c.length>0?o("role.organizationHelp",{defaultValue:"Select the organization this role belongs to"}):o("role.noOrganizationsAvailable",{defaultValue:"No organizations available. Please contact your administrator."}),children:c.length>0?e.jsx(D,{placeholder:o("role.selectOrganization",{defaultValue:"Select Organization"}),onChange:l=>{T([]),f.setFieldsValue({permissions:[]});const t=l||"";t?A(t,{}):(V([]),g({}))},children:c.map(l=>e.jsx(D.Option,{value:l.id,children:l.name},l.id))}):e.jsx(D,{disabled:!0,placeholder:o("role.noOrganizationsAvailable",{defaultValue:"No organizations available"})})})]})},{key:"permissions",label:o("role.permissions",{defaultValue:"Permissions"}),children:e.jsx(x.Item,{name:"permissions",rules:[{validator(){if(k.length===0)if(y==="global"){const l=f.getFieldValue("policy_document");if(!l||l.trim()===""||l==="{}"||l==='{"Statement":[]}')return Promise.reject(new Error(o("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."})))}else return Promise.reject(new Error(o("role.permissionRequired",{defaultValue:"Please select at least one permission."})));return Promise.resolve()}}],children:e.jsx("div",{children:e.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",border:"1px solid #d9d9d9",borderRadius:"4px"},children:[e.jsxs("span",{className:n.rolePermissionExtra,children:[e.jsx(j,{type:"link",onClick:_e,icon:e.jsx(Ge,{}),children:h("expandAll",{defaultValue:"Expand All"})}),e.jsx(j,{type:"link",onClick:Ve,icon:e.jsx(Le,{}),children:h("collapseAll",{defaultValue:"Collapse All"})})]}),e.jsx($e,{treeData:je,titleRender:l=>{const t=l,a=typeof t.title=="string"?t.title:String(t.title??"");return e.jsx("span",{children:o(`permission.title.${t.code}`,{defaultValue:a})})},checkable:!0,disabled:F,expandedKeys:ce,autoExpandParent:ue,onExpand:be,checkedKeys:k,onCheck:l=>{let t=[];He(l)?t=l:Ye(l,"checked")&&(t=l.checked),T(t),f.setFieldsValue({permissions:t})}})]})})})},{key:"ai-tools",label:o("role.aiPermissions",{defaultValue:"AI Tool Permissions"}),disabled:y==="global",children:e.jsx(Je,{spinning:me,children:y==="organization"?N.length>0?e.jsx(P,{direction:"vertical",size:"middle",style:{width:"100%"},children:N.map(l=>{const t=(l.tools||[]).map(m=>m.name),a=I[l.id]||[],u=t.length>0&&a.length===t.length,r=a.length>0&&a.length<t.length;return e.jsx(K,{size:"small",title:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx(H,{checked:u,indeterminate:r,onChange:m=>ze(l.id,m.target.checked)}),e.jsx("span",{children:l.name})]}),extra:l.description?e.jsx("span",{children:l.description}):void 0,children:(l.tools||[]).length>0?e.jsx(H.Group,{style:{width:"100%"},value:I[l.id]||[],onChange:m=>Se(l.id,m),children:e.jsx(P,{direction:"vertical",style:{width:"100%"},children:(l.tools||[]).map(m=>e.jsx(H,{value:m.name,children:e.jsxs("div",{children:[e.jsx("div",{children:m.name}),m.description&&e.jsx("div",{style:{color:"rgba(0,0,0,0.45)",fontSize:12},children:m.description})]})},m.name))})}):e.jsx(w,{image:w.PRESENTED_IMAGE_SIMPLE,description:o("role.aiToolsetNoTools",{defaultValue:"No tools available in this toolset."})})},l.id)})}):e.jsx(w,{image:w.PRESENTED_IMAGE_SIMPLE,description:o("role.aiToolsetsEmpty",{defaultValue:"No AI toolsets available for this organization."})}):e.jsx(w,{image:w.PRESENTED_IMAGE_SIMPLE,description:o("role.aiPermissionsGlobalInfo",{defaultValue:"AI tool permissions are only available for organization roles."})})})},{key:"policy",label:o("role.policyDocument",{defaultValue:"Policy Document"}),disabled:y==="organization",children:e.jsx(x.Item,{name:"policy_document",rules:[{validator:Re}],extra:e.jsx("span",{className:n.rolePolicyExtra,children:e.jsx(D,{style:{width:160},placeholder:o("role.insertTemplate",{defaultValue:"Insert Template"}),options:[{label:o("role.allowAll",{defaultValue:"Allow All"}),value:"allow_all"},{label:o("role.denyAll",{defaultValue:"Deny All"}),value:"deny_all"},{label:o("role.allowWithAction",{defaultValue:"Allow with Action"}),value:"allow_with_action"},{label:o("role.denyWithCondition",{defaultValue:"Allow with Condition"}),value:"allow_with_condition"},{label:o("role.allowWithUri",{defaultValue:"Allow with URI"}),value:"allow_with_uri"}],onChange:l=>{if(typeof l=="string"){const t=Ze[l];t&&f.setFieldValue("policy_document",JSON.stringify(t,null,2))}}})}),children:e.jsx(ae,{rows:15,style:{fontFamily:"monospace"},placeholder:`{
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "account:EnableRegion",
                "account:DisableRegion"
            ],
            "Condition": {
                "StringEquals": {"id:": "abcdef"}
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "*"
            ]
        }
    ]
}`})})}]}),e.jsx(x.Item,{children:e.jsxs(P,{children:[e.jsx(j,{type:"primary",htmlType:"submit",loading:he,children:p?h("update",{defaultValue:"Update"}):h("create",{defaultValue:"Create"})}),e.jsx(j,{onClick:()=>b("/authorization/roles"),children:h("cancel",{defaultValue:"Cancel"})})]})})]})]})},st=Object.freeze(Object.defineProperty({__proto__:null,default:Qe},Symbol.toStringTag,{value:"Module"}));export{it as R,st as a};
