import{r as n,e as D,j as z,t as S}from"./vendor.XZpclBr-.js";import{a as I}from"./index.DaUrY26v.js";import{c as P,a as T}from"./client.CQPv28OP.js";const _=n.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),U=()=>n.useContext(_),b=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),P.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete P.defaults.headers.common.Authorization)},q=({children:e})=>{const[t,o]=n.useState(void 0),[C,i]=n.useState(localStorage.getItem("token")),[A,d]=n.useState(!0),{run:u}=D(async()=>{const r=localStorage.getItem("token");return r?(b(r,!1),I.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:r=>{o(r)},onError:r=>{console.error("Failed to get current user:",r),g()},onFinally:()=>{d(!1)}});n.useEffect(()=>{u()},[]);const a=async r=>{try{const s=await I.authorization.login(r),{token:f,user:c,needs_mfa:y,password_expired:m,mfa_token:k,mfa_type:h}=s;if(y)throw{needsMFA:!0,mfaToken:k,mfaType:h,user:c};if(m)throw{password_expired:!0,user:c,token:f};return b(f),i(f),o(c),c}catch(s){throw s&&s.needsMFA||s&&s.password_expired||S.error("Login failed, please check your username and password"),s}},l=n.useCallback(async r=>{try{const s=await I.oauth.handleCallback(r);let f="",c=null;if(s&&typeof s=="object")if("code"in s&&s.code==="0"&&"data"in s){const{token:y,user:m,needs_mfa:k,mfa_token:h,mfa_type:p}=s.data;if(k)throw{needsMFA:!0,mfaToken:h,mfaType:p,user:m};f=y,c=m}else{const{token:y,user:m,needs_mfa:k,mfa_token:h,mfa_type:p}=s;if(k)throw{needsMFA:!0,mfaToken:h,mfaType:p,user:m};f=y,c=m}return b(f),i(f),o(c),c}catch(s){throw s&&s.needsMFA||s&&s.passwordExpired,s}},[]),g=()=>{I.authorization.logout(),b(null),i(null),o(null)},v=r=>{o(r)};return z.jsx(_.Provider,{value:{user:t,token:C,loading:A,login:a,oauthLogin:l,logout:g,updateUser:v},children:e})},J=()=>{const e=n.useContext(_);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},L=n.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),F=()=>n.useContext(L),N=({children:e})=>{const{user:t}=U(),{data:o=null,loading:C,runAsync:i}=D(async()=>I.system.getSiteConfig(),{manual:!0});n.useEffect(()=>{t!==void 0&&i()},[t]);const[A,d]=n.useState(null);return n.useEffect(()=>{A?localStorage.setItem("orgID",A):localStorage.removeItem("orgID")},[A]),n.useEffect(()=>{var a,l,g;let u=localStorage.getItem("orgID");if(u){const v=(a=t==null?void 0:t.organizations)==null?void 0:a.find(r=>r.id===u);if(v){d(v.id);return}}d(((g=(l=t==null?void 0:t.organizations)==null?void 0:l[0])==null?void 0:g.id)??null)},[o,t==null?void 0:t.organizations]),z.jsx(L.Provider,{value:{siteConfig:o,loading:C,enableMultiOrg:(o==null?void 0:o.enable_multi_org)??!1,fetchSiteConfig:i,currentOrgId:A,setCurrentOrgId:u=>{d(u)},clearCurrentOrgId:()=>{d(null)}},children:e})},H=()=>{var u;const{user:e}=n.useContext(_),{currentOrgId:t}=F(),o=(u=e==null?void 0:e.roles)==null?void 0:u.filter(a=>!a.organization_id||a.organization_id===t),C=()=>o?o.some(a=>a.name==="admin"&&!a.organization_id):!1,i=a=>o?C()?!0:o.some(l=>l.permissions?l.permissions.some(g=>g.code===a):!1):!1;return{hasPermission:i,hasAllPermissions:a=>a.every(l=>i(l)),hasAnyPermission:a=>a.some(l=>i(l)),isAdmin:C(),loading:!e}},M=n.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{},callAI:()=>{},onCallAI:e=>{},loaded:!1,setLoaded:()=>{}}),Q=()=>n.useContext(M),W=({children:e})=>{const[t,o]=n.useState("sidebar"),[C,i]=n.useState(!1),[A,d]=n.useState(!1),[u,a]=n.useState(),[l,g]=n.useState(null),v=n.useCallback((r,s)=>{i(!0),l?l(r,s):a([r,s])},[l,i]);return n.useEffect(()=>{l&&u&&(l(u[0],u[1]),a(void 0))},[l,u]),z.jsx(M.Provider,{value:{layout:t,setLayout:r=>{o(r)},visible:C,setVisible:r=>{i(r)},callAI:v,onCallAI:n.useCallback(r=>{g(()=>r)},[g]),loaded:A,setLoaded:r=>{d(r)}},children:e})},O=new Map,K=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),j=(e,t)=>{const o=O.get(e);return o?t&&t>0&&Date.now()-o.timestamp>t*1e3?(O.delete(e),null):o.data:null},G=(e,t)=>{O.set(e,{data:t,timestamp:Date.now()})},X=(e,t,o)=>{const[C,i]=n.useState(t||[]),[A,d]=n.useState(!1),[u,a]=n.useState(null),[l,g]=n.useState(0),v=()=>g(s=>s+1),r=n.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(s=>o&&o[s]!==void 0&&o[s]!==null):!0,[e,o]);return n.useEffect(()=>{if(!r){i(t||[]);return}(async()=>{try{d(!0),a(null);const f=K(e,o);if(e.cache){const y=j(f,e.cache_ttl);if(y){i(y),d(!1);return}}let c=[];switch(e.type){case"api":{const y=e.url||"",m=e.method||"GET",k={...o,...e.params};let h;m.toUpperCase()==="GET"?h=await T(y,{params:k}):h=await T(y,{params:k});const p=Array.isArray(h)?h:h.data||[],x=e.label_key||"label",E=e.value_key||"value";c=p.map(w=>({label:w[x]||w.name||w.id,value:w[E]||w.id}));break}case"toolsets":{let m=(await I.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(m=m.filter(p=>Object.entries(e.filter).every(([x,E])=>p[x]===E)));const k=e.label_key||"name",h=e.value_key||"id";c=m.map(p=>({label:p[k]||p.name,value:p[h]||p.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),c=[];break}default:c=t||[]}e.cache&&G(f,c),i(c)}catch(f){console.error("Failed to load options from data source:",f),a(f),i(t||[])}finally{d(!1)}})()},[e,t,o,r,l]),{options:C,loading:A,error:u,refresh:v}};export{q as A,N as S,H as a,F as b,Q as c,X as d,W as e,U as f,J as u};
