import{r,e as D,j as O,t as U}from"./vendor.XZpclBr-.js";import{a as C}from"./index.Ch-YA0Oe.js";import{c as P,a as T}from"./client.CQPv28OP.js";const I=r.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),F=()=>r.useContext(I),_=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),P.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete P.defaults.headers.common.Authorization)},q=({children:e})=>{const[t,n]=r.useState(void 0),[y,a]=r.useState(localStorage.getItem("token")),[c,p]=r.useState(!0),{run:k}=D(async()=>{const i=localStorage.getItem("token");return i?(_(i,!1),C.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:i=>{n(i)},onError:i=>{console.error("Failed to get current user:",i),w()},onFinally:()=>{p(!1)}});r.useEffect(()=>{k()},[]);const o=async i=>{try{const s=await C.authorization.login(i),{token:u,user:l,needs_mfa:h,password_expired:d,mfa_token:v,mfa_type:m}=s;if(h)throw{needsMFA:!0,mfaToken:v,mfaType:m,user:l};if(d)throw{password_expired:!0,user:l,token:u};return _(u),a(u),n(l),l}catch(s){throw s&&s.needsMFA||s&&s.password_expired||U.error("Login failed, please check your username and password"),s}},f=r.useCallback(async i=>{try{const s=await C.oauth.handleCallback(i);let u="",l=null;if(s&&typeof s=="object")if("code"in s&&s.code==="0"&&"data"in s){const{token:h,user:d,needs_mfa:v,mfa_token:m,mfa_type:g}=s.data;if(v)throw{needsMFA:!0,mfaToken:m,mfaType:g,user:d};u=h,l=d}else{const{token:h,user:d,needs_mfa:v,mfa_token:m,mfa_type:g}=s;if(v)throw{needsMFA:!0,mfaToken:m,mfaType:g,user:d};u=h,l=d}return _(u),a(u),n(l),l}catch(s){throw s&&s.needsMFA||s&&s.passwordExpired,s}},[]),w=()=>{C.authorization.logout(),_(null),a(null),n(null)},A=i=>{n(i)};return O.jsx(I.Provider,{value:{user:t,token:y,loading:c,login:o,oauthLogin:f,logout:w,updateUser:A},children:e})},J=()=>{const e=r.useContext(I);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},M=r.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),K=()=>r.useContext(M),N=({children:e})=>{const{user:t}=F(),{data:n=null,loading:y,runAsync:a}=D(async()=>C.system.getSiteConfig(),{manual:!0});r.useEffect(()=>{t!==void 0&&a()},[t]);const[c,p]=r.useState(null);return r.useEffect(()=>{c?localStorage.setItem("orgID",c):localStorage.removeItem("orgID")},[c]),r.useEffect(()=>{var o,f,w;let k=localStorage.getItem("orgID");if(k){const A=(o=t==null?void 0:t.organizations)==null?void 0:o.find(i=>i.id===k);if(A){p(A.id);return}}p(((w=(f=t==null?void 0:t.organizations)==null?void 0:f[0])==null?void 0:w.id)??null)},[n,t==null?void 0:t.organizations]),O.jsx(M.Provider,{value:{siteConfig:n,loading:y,enableMultiOrg:(n==null?void 0:n.enable_multi_org)??!1,fetchSiteConfig:a,currentOrgId:c,setCurrentOrgId:k=>{p(k)},clearCurrentOrgId:()=>{p(null)}},children:e})},H=()=>{var k;const{user:e}=r.useContext(I),{currentOrgId:t}=K(),n=(k=e==null?void 0:e.roles)==null?void 0:k.filter(o=>!o.organization_id||o.organization_id===t),y=()=>n?n.some(o=>o.name==="admin"&&!o.organization_id):!1,a=o=>n?y()?!0:n.some(f=>f.permissions?f.permissions.some(w=>w.code===o):!1):!1;return{hasPermission:a,hasAllPermissions:o=>o.every(f=>a(f)),hasAnyPermission:o=>o.some(f=>a(f)),isAdmin:y(),loading:!e}},L=r.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{}}),Q=()=>r.useContext(L),W=({children:e})=>{const[t,n]=r.useState("sidebar"),[y,a]=r.useState(!1);return O.jsx(L.Provider,{value:{layout:t,setLayout:c=>{n(c)},visible:y,setVisible:c=>{a(c)}},children:e})},E=new Map,j=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),S=(e,t)=>{const n=E.get(e);return n?t&&t>0&&Date.now()-n.timestamp>t*1e3?(E.delete(e),null):n.data:null},G=(e,t)=>{E.set(e,{data:t,timestamp:Date.now()})},X=(e,t,n)=>{const[y,a]=r.useState(t||[]),[c,p]=r.useState(!1),[k,o]=r.useState(null),[f,w]=r.useState(0),A=()=>w(s=>s+1),i=r.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(s=>n&&n[s]!==void 0&&n[s]!==null):!0,[e,n]);return r.useEffect(()=>{if(!i){a(t||[]);return}(async()=>{try{p(!0),o(null);const u=j(e,n);if(e.cache){const h=S(u,e.cache_ttl);if(h){a(h),p(!1);return}}let l=[];switch(e.type){case"api":{const h=e.url||"",d=e.method||"GET",v={...n,...e.params};let m;d.toUpperCase()==="GET"?m=await T(h,{params:v}):m=await T(h,{params:v});const g=Array.isArray(m)?m:m.data||[],x=e.label_key||"label",z=e.value_key||"value";l=g.map(b=>({label:b[x]||b.name||b.id,value:b[z]||b.id}));break}case"toolsets":{let d=(await C.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(d=d.filter(g=>Object.entries(e.filter).every(([x,z])=>g[x]===z)));const v=e.label_key||"name",m=e.value_key||"id";l=d.map(g=>({label:g[v]||g.name,value:g[m]||g.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),l=[];break}default:l=t||[]}e.cache&&G(u,l),a(l)}catch(u){console.error("Failed to load options from data source:",u),o(u),a(t||[])}finally{p(!1)}})()},[e,t,n,i,f]),{options:y,loading:c,error:k,refresh:A}};export{q as A,N as S,H as a,K as b,Q as c,X as d,W as e,F as f,J as u};
