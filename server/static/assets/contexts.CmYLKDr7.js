import{r as a,e as P,j as U,s as v}from"./vendor.Bo5zsZF4.js";import{m as F,n as S,o as E,p as x,q as M}from"./base.Dox78hP9.js";const g=a.createContext({user:null,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),j=()=>a.useContext(g),p=(s,i=!0)=>{s?(i&&localStorage.setItem("token",s),x.defaults.headers.common.Authorization=`Bearer ${s}`):(i&&localStorage.removeItem("token"),delete x.defaults.headers.common.Authorization)},L=({children:s})=>{const[i,o]=a.useState(null),[w,h]=a.useState(localStorage.getItem("token")),[r,u]=a.useState(!0),{run:k}=P(async()=>{const t=localStorage.getItem("token");return t?(p(t,!1),F()):null},{manual:!0,onBefore:()=>{},onSuccess:t=>{o(t)},onError:t=>{console.error("Failed to get current user:",t),y()},onFinally:()=>{u(!1)}});a.useEffect(()=>{k()},[]);const _=async t=>{try{const e=await M(t),{token:l,user:n,needs_mfa:f,password_expired:c,mfa_token:m,mfa_type:d}=e;if(f)throw{needsMFA:!0,mfaToken:m,mfaType:d,user:n};if(p(l),h(l),o(n),c)throw{password_expired:!0,user:n};return n}catch(e){throw e&&e.needsMFA||e&&e.password_expired||v.error("Login failed, please check your username and password"),e}},T=a.useCallback(async t=>{try{const e=await S(t);let l="",n=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:f,user:c,needs_mfa:m,mfa_token:d,mfa_type:A}=e.data;if(m)throw{needsMFA:!0,mfaToken:d,mfaType:A,user:c};l=f,n=c}else{const{token:f,user:c,needs_mfa:m,mfa_token:d,mfa_type:A}=e;if(m)throw{needsMFA:!0,mfaToken:d,mfaType:A,user:c};l=f,n=c}return p(l),h(l),o(n),n}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),y=()=>{E(),p(null),h(null),o(null)},C=t=>{o(t)};return U.jsx(g.Provider,{value:{user:i,token:w,loading:r,login:_,oauthLogin:T,logout:y,updateUser:C},children:s})},$=()=>{const s=a.useContext(g);if(s===void 0)throw new Error("useAuth must be used within an AuthProvider");return s},q=()=>{const{user:s}=a.useContext(g),i=()=>!s||!s.roles?!1:s.roles.some(r=>r.name==="admin"),o=r=>!s||!s.roles?!1:i()?!0:s.roles.some(u=>u.permissions?u.permissions.some(k=>k.code===r):!1);return{hasPermission:o,hasAllPermissions:r=>r.every(u=>o(u)),hasAnyPermission:r=>r.some(u=>o(u)),isAdmin:i(),loading:!s}};export{L as A,q as a,j as b,$ as u};
