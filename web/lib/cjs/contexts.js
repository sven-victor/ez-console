"use strict";const n=require("react"),S=require("./vendor.js"),D=require("antd"),k=require("./index.js"),b=require("./client.js"),z=require("ahooks"),q=require("react-i18next"),x=n.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),L=()=>n.useContext(x),_=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),b.client.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete b.client.defaults.headers.common.Authorization)},F=({children:e})=>{const[t,r]=n.useState(void 0),[A,l]=n.useState(localStorage.getItem("token")),[y,v]=n.useState(!0),{run:p}=z.useRequest(async()=>{const a=localStorage.getItem("token");return a?(_(a,!1),k.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:a=>{r(a)},onError:a=>{console.error("Failed to get current user:",a),h()},onFinally:()=>{v(!1)}});n.useEffect(()=>{p()},[]);const i=async a=>{try{const s=await k.api.authorization.login(a),{token:f,user:u,needs_mfa:g,password_expired:m,mfa_token:o,mfa_type:d}=s;if(g)throw{needsMFA:!0,mfaToken:o,mfaType:d,user:u};if(m)throw{password_expired:!0,user:u,token:f};return _(f),l(f),r(u),u}catch(s){throw s&&s.needsMFA||s&&s.password_expired||D.message.error("Login failed, please check your username and password"),s}},c=n.useCallback(async a=>{try{const s=await k.api.oauth.handleCallback(a);let f="",u=null;if(s&&typeof s=="object")if("code"in s&&s.code==="0"&&"data"in s){const{token:g,user:m,needs_mfa:o,mfa_token:d,mfa_type:C}=s.data;if(o)throw{needsMFA:!0,mfaToken:d,mfaType:C,user:m};f=g,u=m}else{const{token:g,user:m,needs_mfa:o,mfa_token:d,mfa_type:C}=s;if(o)throw{needsMFA:!0,mfaToken:d,mfaType:C,user:m};f=g,u=m}return _(f),l(f),r(u),u}catch(s){throw s&&s.needsMFA||s&&s.passwordExpired,s}},[]),h=()=>{k.api.authorization.logout(),_(null),l(null),r(null)},I=a=>{r(a)};return S.jsxRuntimeExports.jsx(x.Provider,{value:{user:t,token:A,loading:y,login:i,oauthLogin:c,logout:h,updateUser:I},children:e})},U=()=>{const e=n.useContext(x);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},O=n.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),T=()=>n.useContext(O),j=({children:e})=>{const{user:t}=L(),{data:r=null,loading:A,runAsync:l}=z.useRequest(async()=>k.api.system.getSiteConfig(),{manual:!0});n.useEffect(()=>{t!==void 0&&l()},[t]);const[y,v]=n.useState(null);return n.useEffect(()=>{y?localStorage.setItem("orgID",y):localStorage.removeItem("orgID")},[y]),n.useEffect(()=>{var i,c,h;let p=localStorage.getItem("orgID");if(p){const I=(i=t==null?void 0:t.organizations)==null?void 0:i.find(a=>a.id===p);if(I){v(I.id);return}}v(((h=(c=t==null?void 0:t.organizations)==null?void 0:c[0])==null?void 0:h.id)??null)},[r,t==null?void 0:t.organizations]),S.jsxRuntimeExports.jsx(O.Provider,{value:{siteConfig:r,loading:A,enableMultiOrg:(r==null?void 0:r.enable_multi_org)??!1,fetchSiteConfig:l,currentOrgId:y,setCurrentOrgId:p=>{v(p)},clearCurrentOrgId:()=>{v(null)}},children:e})},R=()=>{var p;const{user:e}=n.useContext(x),{currentOrgId:t}=T(),r=(p=e==null?void 0:e.roles)==null?void 0:p.filter(i=>!i.organization_id||i.organization_id===t),A=()=>r?r.some(i=>i.name==="admin"&&!i.organization_id):!1,l=i=>r?A()?!0:r.some(c=>c.permissions?c.permissions.some(h=>h.code===i):!1):!1;return{hasPermission:l,hasAllPermissions:i=>i.every(c=>l(c)),hasAnyPermission:i=>i.some(c=>l(c)),isAdmin:A(),loading:!e}},M=n.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{},callAI:()=>{},onCallAI:e=>{},loaded:!1,setLoaded:()=>{},fetchConversations:()=>Promise.resolve([]),fetchConversationsLoading:!1,conversations:void 0,activeConversationKey:void 0,setActiveConversationKey:()=>{}}),G=()=>n.useContext(M),$=({children:e})=>{const{t}=q.useTranslation("ai"),[r,A]=n.useState("sidebar"),[l,y]=n.useState(!1),[v,p]=n.useState(!1),[i,c]=n.useState(void 0),[h,I]=n.useState(),[a,s]=n.useState(null);n.useEffect(()=>{const o=localStorage.getItem("activeConversationKey");o&&c(o)},[]);const f=n.useCallback((o,d)=>{y(!0),a?a(o,d):I([o,d])},[a,y]);n.useEffect(()=>{a&&h&&(a(h[0],h[1]),I(void 0))},[a,h]);const{loading:u,runAsync:g,data:m}=z.useRequest(async()=>(await k.api.ai.listChatSessions({current:1,page_size:20})).data,{ready:l,onError:o=>{D.message.error(t("chat.fetchConversationsFailed",{defaultValue:"Failed to fetch conversations: {{errmsg}}",errmsg:o.message??o}))}});return S.jsxRuntimeExports.jsx(M.Provider,{value:{layout:r,setLayout:o=>{A(o)},visible:l,setVisible:o=>{y(o)},callAI:f,onCallAI:n.useCallback(o=>{s(()=>o)},[s]),loaded:v,setLoaded:o=>{p(o)},fetchConversations:g,fetchConversationsLoading:u,conversations:m,activeConversationKey:i,setActiveConversationKey:o=>{c(o),localStorage.setItem("activeConversationKey",o)}},children:e})},K=new Map,B=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),J=(e,t)=>{const r=K.get(e);return r?t&&t>0&&Date.now()-r.timestamp>t*1e3?(K.delete(e),null):r.data:null},N=(e,t)=>{K.set(e,{data:t,timestamp:Date.now()})},H=(e,t,r)=>{const[A,l]=n.useState(t||[]),[y,v]=n.useState(!1),[p,i]=n.useState(null),[c,h]=n.useState(0),I=()=>h(s=>s+1),a=n.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(s=>r&&r[s]!==void 0&&r[s]!==null):!0,[e,r]);return n.useEffect(()=>{if(!a){l(t||[]);return}(async()=>{try{v(!0),i(null);const f=B(e,r);if(e.cache){const g=J(f,e.cache_ttl);if(g){l(g),v(!1);return}}let u=[];switch(e.type){case"api":{const g=e.url||"",m=e.method||"GET",o={...r,...e.params};let d;m.toUpperCase()==="GET"?d=await b.apiGet(g,{params:o}):d=await b.apiGet(g,{params:o});const C=Array.isArray(d)?d:d.data||[],P=e.label_key||"label",E=e.value_key||"value";u=C.map(w=>({label:w[P]||w.name||w.id,value:w[E]||w.id}));break}case"toolsets":{let m=(await k.api.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(m=m.filter(C=>Object.entries(e.filter).every(([P,E])=>C[P]===E)));const o=e.label_key||"name",d=e.value_key||"id";u=m.map(C=>({label:C[o]||C.name,value:C[d]||C.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),u=[];break}default:u=t||[]}e.cache&&N(f,u),l(u)}catch(f){console.error("Failed to load options from data source:",f),i(f),l(t||[])}finally{v(!1)}})()},[e,t,r,a,c]),{options:A,loading:y,error:p,refresh:I}};exports.AIProvider=$;exports.AuthProvider=F;exports.SiteProvider=j;exports.useAI=G;exports.useAuth=U;exports.useAuth$1=L;exports.useDynamicDataSource=H;exports.usePermission=R;exports.useSite=T;
