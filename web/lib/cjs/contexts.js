"use strict";const s=require("react"),_=require("./vendor.js"),E=require("antd"),x=require("./index.js"),v=require("./client.js"),P=require("ahooks"),w=s.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),z=()=>s.useContext(w),I=(o,t=!0)=>{o?(t&&localStorage.setItem("token",o),v.client.defaults.headers.common.Authorization=`Bearer ${o}`):(t&&localStorage.removeItem("token"),delete v.client.defaults.headers.common.Authorization)},q=({children:o})=>{const[t,r]=s.useState(void 0),[p,u]=s.useState(localStorage.getItem("token")),[f,g]=s.useState(!0),{run:l}=P.useRequest(async()=>{const a=localStorage.getItem("token");return a?(I(a,!1),x.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:a=>{r(a)},onError:a=>{console.error("Failed to get current user:",a),m()},onFinally:()=>{g(!1)}});s.useEffect(()=>{l()},[]);const n=async a=>{try{const e=await x.api.authorization.login(a),{token:d,user:c,needs_mfa:k,password_expired:h,mfa_token:A,mfa_type:y}=e;if(k)throw{needsMFA:!0,mfaToken:A,mfaType:y,user:c};if(h)throw{password_expired:!0,user:c,token:d};return I(d),u(d),r(c),c}catch(e){throw e&&e.needsMFA||e&&e.password_expired||E.message.error("Login failed, please check your username and password"),e}},i=s.useCallback(async a=>{try{const e=await x.api.oauth.handleCallback(a);let d="",c=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:k,user:h,needs_mfa:A,mfa_token:y,mfa_type:S}=e.data;if(A)throw{needsMFA:!0,mfaToken:y,mfaType:S,user:h};d=k,c=h}else{const{token:k,user:h,needs_mfa:A,mfa_token:y,mfa_type:S}=e;if(A)throw{needsMFA:!0,mfaToken:y,mfaType:S,user:h};d=k,c=h}return I(d),u(d),r(c),c}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),m=()=>{x.api.authorization.logout(),I(null),u(null),r(null)},C=a=>{r(a)};return _.jsxRuntimeExports.jsx(w.Provider,{value:{user:t,token:p,loading:f,login:n,oauthLogin:i,logout:m,updateUser:C},children:o})},U=()=>{const o=s.useContext(w);if(o===void 0)throw new Error("useAuth must be used within an AuthProvider");return o},O=s.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),T=()=>s.useContext(O),b=({children:o})=>{const{user:t}=z(),{data:r=null,loading:p,runAsync:u}=P.useRequest(async()=>x.api.system.getSiteConfig(),{manual:!0});s.useEffect(()=>{t!==void 0&&u()},[t]);const[f,g]=s.useState(null);return s.useEffect(()=>{f?localStorage.setItem("orgID",f):localStorage.removeItem("orgID")},[f]),s.useEffect(()=>{var n,i,m;let l=localStorage.getItem("orgID");if(l){const C=(n=t==null?void 0:t.organizations)==null?void 0:n.find(a=>a.id===l);if(C){g(C.id);return}}g(((m=(i=t==null?void 0:t.organizations)==null?void 0:i[0])==null?void 0:m.id)??null)},[r,t==null?void 0:t.organizations]),_.jsxRuntimeExports.jsx(O.Provider,{value:{siteConfig:r,loading:p,enableMultiOrg:(r==null?void 0:r.enable_multi_org)??!1,fetchSiteConfig:u,currentOrgId:f,setCurrentOrgId:l=>{g(l)},clearCurrentOrgId:()=>{g(null)}},children:o})},F=()=>{var l;const{user:o}=s.useContext(w),{currentOrgId:t}=T(),r=(l=o==null?void 0:o.roles)==null?void 0:l.filter(n=>!n.organization_id||n.organization_id===t),p=()=>r?r.some(n=>n.name==="admin"&&!n.organization_id):!1,u=n=>r?p()?!0:r.some(i=>i.permissions?i.permissions.some(m=>m.code===n):!1):!1;return{hasPermission:u,hasAllPermissions:n=>n.every(i=>u(i)),hasAnyPermission:n=>n.some(i=>u(i)),isAdmin:p(),loading:!o}};exports.AuthProvider=q;exports.SiteProvider=b;exports.useAuth=U;exports.useAuth$1=z;exports.usePermission=F;exports.useSite=T;
