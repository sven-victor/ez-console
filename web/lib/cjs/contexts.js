"use strict";const r=require("react"),z=require("./vendor.js"),j=require("antd"),C=require("./index.js"),_=require("./client.js"),O=require("ahooks"),b=r.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),T=()=>r.useContext(b),I=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),_.client.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete _.client.defaults.headers.common.Authorization)},q=({children:e})=>{const[t,n]=r.useState(void 0),[p,a]=r.useState(localStorage.getItem("token")),[c,y]=r.useState(!0),{run:v}=O.useRequest(async()=>{const i=localStorage.getItem("token");return i?(I(i,!1),C.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:i=>{n(i)},onError:i=>{console.error("Failed to get current user:",i),A()},onFinally:()=>{y(!1)}});r.useEffect(()=>{v()},[]);const o=async i=>{try{const s=await C.api.authorization.login(i),{token:u,user:l,needs_mfa:h,password_expired:d,mfa_token:k,mfa_type:m}=s;if(h)throw{needsMFA:!0,mfaToken:k,mfaType:m,user:l};if(d)throw{password_expired:!0,user:l,token:u};return I(u),a(u),n(l),l}catch(s){throw s&&s.needsMFA||s&&s.password_expired||j.message.error("Login failed, please check your username and password"),s}},f=r.useCallback(async i=>{try{const s=await C.api.oauth.handleCallback(i);let u="",l=null;if(s&&typeof s=="object")if("code"in s&&s.code==="0"&&"data"in s){const{token:h,user:d,needs_mfa:k,mfa_token:m,mfa_type:g}=s.data;if(k)throw{needsMFA:!0,mfaToken:m,mfaType:g,user:d};u=h,l=d}else{const{token:h,user:d,needs_mfa:k,mfa_token:m,mfa_type:g}=s;if(k)throw{needsMFA:!0,mfaToken:m,mfaType:g,user:d};u=h,l=d}return I(u),a(u),n(l),l}catch(s){throw s&&s.needsMFA||s&&s.passwordExpired,s}},[]),A=()=>{C.api.authorization.logout(),I(null),a(null),n(null)},w=i=>{n(i)};return z.jsxRuntimeExports.jsx(b.Provider,{value:{user:t,token:p,loading:c,login:o,oauthLogin:f,logout:A,updateUser:w},children:e})},F=()=>{const e=r.useContext(b);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},L=r.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),M=()=>r.useContext(L),K=({children:e})=>{const{user:t}=T(),{data:n=null,loading:p,runAsync:a}=O.useRequest(async()=>C.api.system.getSiteConfig(),{manual:!0});r.useEffect(()=>{t!==void 0&&a()},[t]);const[c,y]=r.useState(null);return r.useEffect(()=>{c?localStorage.setItem("orgID",c):localStorage.removeItem("orgID")},[c]),r.useEffect(()=>{var o,f,A;let v=localStorage.getItem("orgID");if(v){const w=(o=t==null?void 0:t.organizations)==null?void 0:o.find(i=>i.id===v);if(w){y(w.id);return}}y(((A=(f=t==null?void 0:t.organizations)==null?void 0:f[0])==null?void 0:A.id)??null)},[n,t==null?void 0:t.organizations]),z.jsxRuntimeExports.jsx(L.Provider,{value:{siteConfig:n,loading:p,enableMultiOrg:(n==null?void 0:n.enable_multi_org)??!1,fetchSiteConfig:a,currentOrgId:c,setCurrentOrgId:v=>{y(v)},clearCurrentOrgId:()=>{y(null)}},children:e})},S=()=>{var v;const{user:e}=r.useContext(b),{currentOrgId:t}=M(),n=(v=e==null?void 0:e.roles)==null?void 0:v.filter(o=>!o.organization_id||o.organization_id===t),p=()=>n?n.some(o=>o.name==="admin"&&!o.organization_id):!1,a=o=>n?p()?!0:n.some(f=>f.permissions?f.permissions.some(A=>A.code===o):!1):!1;return{hasPermission:a,hasAllPermissions:o=>o.every(f=>a(f)),hasAnyPermission:o=>o.some(f=>a(f)),isAdmin:p(),loading:!e}},U=r.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{}}),R=()=>r.useContext(U),G=({children:e})=>{const[t,n]=r.useState("sidebar"),[p,a]=r.useState(!1);return z.jsxRuntimeExports.jsx(U.Provider,{value:{layout:t,setLayout:c=>{n(c)},visible:p,setVisible:c=>{a(c)}},children:e})},E=new Map,$=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),B=(e,t)=>{const n=E.get(e);return n?t&&t>0&&Date.now()-n.timestamp>t*1e3?(E.delete(e),null):n.data:null},J=(e,t)=>{E.set(e,{data:t,timestamp:Date.now()})},N=(e,t,n)=>{const[p,a]=r.useState(t||[]),[c,y]=r.useState(!1),[v,o]=r.useState(null),[f,A]=r.useState(0),w=()=>A(s=>s+1),i=r.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(s=>n&&n[s]!==void 0&&n[s]!==null):!0,[e,n]);return r.useEffect(()=>{if(!i){a(t||[]);return}(async()=>{try{y(!0),o(null);const u=$(e,n);if(e.cache){const h=B(u,e.cache_ttl);if(h){a(h),y(!1);return}}let l=[];switch(e.type){case"api":{const h=e.url||"",d=e.method||"GET",k={...n,...e.params};let m;d.toUpperCase()==="GET"?m=await _.apiGet(h,{params:k}):m=await _.apiGet(h,{params:k});const g=Array.isArray(m)?m:m.data||[],P=e.label_key||"label",D=e.value_key||"value";l=g.map(x=>({label:x[P]||x.name||x.id,value:x[D]||x.id}));break}case"toolsets":{let d=(await C.api.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(d=d.filter(g=>Object.entries(e.filter).every(([P,D])=>g[P]===D)));const k=e.label_key||"name",m=e.value_key||"id";l=d.map(g=>({label:g[k]||g.name,value:g[m]||g.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),l=[];break}default:l=t||[]}e.cache&&J(u,l),a(l)}catch(u){console.error("Failed to load options from data source:",u),o(u),a(t||[])}finally{y(!1)}})()},[e,t,n,i,f]),{options:p,loading:c,error:v,refresh:w}};exports.AIProvider=G;exports.AuthProvider=q;exports.SiteProvider=K;exports.useAI=R;exports.useAuth=F;exports.useAuth$1=T;exports.useDynamicDataSource=N;exports.usePermission=S;exports.useSite=M;
