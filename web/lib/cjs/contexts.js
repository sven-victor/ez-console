"use strict";const n=require("react"),O=require("./vendor.js"),U=require("antd"),I=require("./index.js"),_=require("./client.js"),z=require("ahooks"),x=n.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),T=()=>n.useContext(x),b=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),_.client.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete _.client.defaults.headers.common.Authorization)},j=({children:e})=>{const[t,r]=n.useState(void 0),[A,l]=n.useState(localStorage.getItem("token")),[v,d]=n.useState(!0),{run:u}=z.useRequest(async()=>{const o=localStorage.getItem("token");return o?(b(o,!1),I.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:o=>{r(o)},onError:o=>{console.error("Failed to get current user:",o),g()},onFinally:()=>{d(!1)}});n.useEffect(()=>{u()},[]);const a=async o=>{try{const s=await I.api.authorization.login(o),{token:f,user:c,needs_mfa:p,password_expired:m,mfa_token:C,mfa_type:h}=s;if(p)throw{needsMFA:!0,mfaToken:C,mfaType:h,user:c};if(m)throw{password_expired:!0,user:c,token:f};return b(f),l(f),r(c),c}catch(s){throw s&&s.needsMFA||s&&s.password_expired||U.message.error("Login failed, please check your username and password"),s}},i=n.useCallback(async o=>{try{const s=await I.api.oauth.handleCallback(o);let f="",c=null;if(s&&typeof s=="object")if("code"in s&&s.code==="0"&&"data"in s){const{token:p,user:m,needs_mfa:C,mfa_token:h,mfa_type:y}=s.data;if(C)throw{needsMFA:!0,mfaToken:h,mfaType:y,user:m};f=p,c=m}else{const{token:p,user:m,needs_mfa:C,mfa_token:h,mfa_type:y}=s;if(C)throw{needsMFA:!0,mfaToken:h,mfaType:y,user:m};f=p,c=m}return b(f),l(f),r(c),c}catch(s){throw s&&s.needsMFA||s&&s.passwordExpired,s}},[]),g=()=>{I.api.authorization.logout(),b(null),l(null),r(null)},k=o=>{r(o)};return O.jsxRuntimeExports.jsx(x.Provider,{value:{user:t,token:A,loading:v,login:a,oauthLogin:i,logout:g,updateUser:k},children:e})},q=()=>{const e=n.useContext(x);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},L=n.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),M=()=>n.useContext(L),F=({children:e})=>{const{user:t}=T(),{data:r=null,loading:A,runAsync:l}=z.useRequest(async()=>I.api.system.getSiteConfig(),{manual:!0});n.useEffect(()=>{t!==void 0&&l()},[t]);const[v,d]=n.useState(null);return n.useEffect(()=>{v?localStorage.setItem("orgID",v):localStorage.removeItem("orgID")},[v]),n.useEffect(()=>{var a,i,g;let u=localStorage.getItem("orgID");if(u){const k=(a=t==null?void 0:t.organizations)==null?void 0:a.find(o=>o.id===u);if(k){d(k.id);return}}d(((g=(i=t==null?void 0:t.organizations)==null?void 0:i[0])==null?void 0:g.id)??null)},[r,t==null?void 0:t.organizations]),O.jsxRuntimeExports.jsx(L.Provider,{value:{siteConfig:r,loading:A,enableMultiOrg:(r==null?void 0:r.enable_multi_org)??!1,fetchSiteConfig:l,currentOrgId:v,setCurrentOrgId:u=>{d(u)},clearCurrentOrgId:()=>{d(null)}},children:e})},K=()=>{var u;const{user:e}=n.useContext(x),{currentOrgId:t}=M(),r=(u=e==null?void 0:e.roles)==null?void 0:u.filter(a=>!a.organization_id||a.organization_id===t),A=()=>r?r.some(a=>a.name==="admin"&&!a.organization_id):!1,l=a=>r?A()?!0:r.some(i=>i.permissions?i.permissions.some(g=>g.code===a):!1):!1;return{hasPermission:l,hasAllPermissions:a=>a.every(i=>l(i)),hasAnyPermission:a=>a.some(i=>l(i)),isAdmin:A(),loading:!e}},S=n.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{},callAI:()=>{},onCallAI:e=>{},loaded:!1,setLoaded:()=>{}}),R=()=>n.useContext(S),G=({children:e})=>{const[t,r]=n.useState("sidebar"),[A,l]=n.useState(!1),[v,d]=n.useState(!1),[u,a]=n.useState(),[i,g]=n.useState(null),k=n.useCallback((o,s)=>{l(!0),i?i(o,s):a([o,s])},[i,l]);return n.useEffect(()=>{i&&u&&(i(u[0],u[1]),a(void 0))},[i,u]),O.jsxRuntimeExports.jsx(S.Provider,{value:{layout:t,setLayout:o=>{r(o)},visible:A,setVisible:o=>{l(o)},callAI:k,onCallAI:n.useCallback(o=>{g(()=>o)},[g]),loaded:v,setLoaded:o=>{d(o)}},children:e})},D=new Map,$=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),B=(e,t)=>{const r=D.get(e);return r?t&&t>0&&Date.now()-r.timestamp>t*1e3?(D.delete(e),null):r.data:null},J=(e,t)=>{D.set(e,{data:t,timestamp:Date.now()})},N=(e,t,r)=>{const[A,l]=n.useState(t||[]),[v,d]=n.useState(!1),[u,a]=n.useState(null),[i,g]=n.useState(0),k=()=>g(s=>s+1),o=n.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(s=>r&&r[s]!==void 0&&r[s]!==null):!0,[e,r]);return n.useEffect(()=>{if(!o){l(t||[]);return}(async()=>{try{d(!0),a(null);const f=$(e,r);if(e.cache){const p=B(f,e.cache_ttl);if(p){l(p),d(!1);return}}let c=[];switch(e.type){case"api":{const p=e.url||"",m=e.method||"GET",C={...r,...e.params};let h;m.toUpperCase()==="GET"?h=await _.apiGet(p,{params:C}):h=await _.apiGet(p,{params:C});const y=Array.isArray(h)?h:h.data||[],P=e.label_key||"label",E=e.value_key||"value";c=y.map(w=>({label:w[P]||w.name||w.id,value:w[E]||w.id}));break}case"toolsets":{let m=(await I.api.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(m=m.filter(y=>Object.entries(e.filter).every(([P,E])=>y[P]===E)));const C=e.label_key||"name",h=e.value_key||"id";c=m.map(y=>({label:y[C]||y.name,value:y[h]||y.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),c=[];break}default:c=t||[]}e.cache&&J(f,c),l(c)}catch(f){console.error("Failed to load options from data source:",f),a(f),l(t||[])}finally{d(!1)}})()},[e,t,r,o,i]),{options:A,loading:v,error:u,refresh:k}};exports.AIProvider=G;exports.AuthProvider=j;exports.SiteProvider=F;exports.useAI=R;exports.useAuth=q;exports.useAuth$1=T;exports.useDynamicDataSource=N;exports.usePermission=K;exports.useSite=M;
