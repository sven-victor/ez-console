"use strict";const o=require("react"),O=require("./vendor.js"),U=require("antd"),C=require("./index.js"),x=require("./client.js"),z=require("ahooks"),b=o.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),T=()=>o.useContext(b),_=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),x.client.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete x.client.defaults.headers.common.Authorization)},j=({children:e})=>{const[t,n]=o.useState(void 0),[A,a]=o.useState(localStorage.getItem("token")),[g,f]=o.useState(!0),{run:d}=z.useRequest(async()=>{const i=localStorage.getItem("token");return i?(_(i,!1),C.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:i=>{n(i)},onError:i=>{console.error("Failed to get current user:",i),I()},onFinally:()=>{f(!1)}});o.useEffect(()=>{d()},[]);const r=async i=>{try{const s=await C.api.authorization.login(i),{token:c,user:l,needs_mfa:p,password_expired:m,mfa_token:v,mfa_type:h}=s;if(p)throw{needsMFA:!0,mfaToken:v,mfaType:h,user:l};if(m)throw{password_expired:!0,user:l,token:c};return _(c),a(c),n(l),l}catch(s){throw s&&s.needsMFA||s&&s.password_expired||U.message.error("Login failed, please check your username and password"),s}},u=o.useCallback(async i=>{try{const s=await C.api.oauth.handleCallback(i);let c="",l=null;if(s&&typeof s=="object")if("code"in s&&s.code==="0"&&"data"in s){const{token:p,user:m,needs_mfa:v,mfa_token:h,mfa_type:y}=s.data;if(v)throw{needsMFA:!0,mfaToken:h,mfaType:y,user:m};c=p,l=m}else{const{token:p,user:m,needs_mfa:v,mfa_token:h,mfa_type:y}=s;if(v)throw{needsMFA:!0,mfaToken:h,mfaType:y,user:m};c=p,l=m}return _(c),a(c),n(l),l}catch(s){throw s&&s.needsMFA||s&&s.passwordExpired,s}},[]),I=()=>{C.api.authorization.logout(),_(null),a(null),n(null)},k=i=>{n(i)};return O.jsxRuntimeExports.jsx(b.Provider,{value:{user:t,token:A,loading:g,login:r,oauthLogin:u,logout:I,updateUser:k},children:e})},q=()=>{const e=o.useContext(b);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},L=o.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),M=()=>o.useContext(L),F=({children:e})=>{const{user:t}=T(),{data:n=null,loading:A,runAsync:a}=z.useRequest(async()=>C.api.system.getSiteConfig(),{manual:!0});o.useEffect(()=>{t!==void 0&&a()},[t]);const[g,f]=o.useState(null);return o.useEffect(()=>{g?localStorage.setItem("orgID",g):localStorage.removeItem("orgID")},[g]),o.useEffect(()=>{var r,u,I;let d=localStorage.getItem("orgID");if(d){const k=(r=t==null?void 0:t.organizations)==null?void 0:r.find(i=>i.id===d);if(k){f(k.id);return}}f(((I=(u=t==null?void 0:t.organizations)==null?void 0:u[0])==null?void 0:I.id)??null)},[n,t==null?void 0:t.organizations]),O.jsxRuntimeExports.jsx(L.Provider,{value:{siteConfig:n,loading:A,enableMultiOrg:(n==null?void 0:n.enable_multi_org)??!1,fetchSiteConfig:a,currentOrgId:g,setCurrentOrgId:d=>{f(d)},clearCurrentOrgId:()=>{f(null)}},children:e})},K=()=>{var d;const{user:e}=o.useContext(b),{currentOrgId:t}=M(),n=(d=e==null?void 0:e.roles)==null?void 0:d.filter(r=>!r.organization_id||r.organization_id===t),A=()=>n?n.some(r=>r.name==="admin"&&!r.organization_id):!1,a=r=>n?A()?!0:n.some(u=>u.permissions?u.permissions.some(I=>I.code===r):!1):!1;return{hasPermission:a,hasAllPermissions:r=>r.every(u=>a(u)),hasAnyPermission:r=>r.some(u=>a(u)),isAdmin:A(),loading:!e}},S=o.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{},callAI:()=>{},onCallAI:e=>{}}),R=()=>o.useContext(S),G=({children:e})=>{const[t,n]=o.useState("sidebar"),[A,a]=o.useState(!1),[g,f]=o.useState(null),d=(r,u)=>{g&&g(r,u)};return O.jsxRuntimeExports.jsx(S.Provider,{value:{layout:t,setLayout:r=>{n(r)},visible:A,setVisible:r=>{a(r)},callAI:d,onCallAI:r=>{f(r)}},children:e})},E=new Map,$=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),B=(e,t)=>{const n=E.get(e);return n?t&&t>0&&Date.now()-n.timestamp>t*1e3?(E.delete(e),null):n.data:null},J=(e,t)=>{E.set(e,{data:t,timestamp:Date.now()})},N=(e,t,n)=>{const[A,a]=o.useState(t||[]),[g,f]=o.useState(!1),[d,r]=o.useState(null),[u,I]=o.useState(0),k=()=>I(s=>s+1),i=o.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(s=>n&&n[s]!==void 0&&n[s]!==null):!0,[e,n]);return o.useEffect(()=>{if(!i){a(t||[]);return}(async()=>{try{f(!0),r(null);const c=$(e,n);if(e.cache){const p=B(c,e.cache_ttl);if(p){a(p),f(!1);return}}let l=[];switch(e.type){case"api":{const p=e.url||"",m=e.method||"GET",v={...n,...e.params};let h;m.toUpperCase()==="GET"?h=await x.apiGet(p,{params:v}):h=await x.apiGet(p,{params:v});const y=Array.isArray(h)?h:h.data||[],P=e.label_key||"label",D=e.value_key||"value";l=y.map(w=>({label:w[P]||w.name||w.id,value:w[D]||w.id}));break}case"toolsets":{let m=(await C.api.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(m=m.filter(y=>Object.entries(e.filter).every(([P,D])=>y[P]===D)));const v=e.label_key||"name",h=e.value_key||"id";l=m.map(y=>({label:y[v]||y.name,value:y[h]||y.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),l=[];break}default:l=t||[]}e.cache&&J(c,l),a(l)}catch(c){console.error("Failed to load options from data source:",c),r(c),a(t||[])}finally{f(!1)}})()},[e,t,n,i,u]),{options:A,loading:g,error:d,refresh:k}};exports.AIProvider=G;exports.AuthProvider=j;exports.SiteProvider=F;exports.useAI=R;exports.useAuth=q;exports.useAuth$1=T;exports.useDynamicDataSource=N;exports.usePermission=K;exports.useSite=M;
