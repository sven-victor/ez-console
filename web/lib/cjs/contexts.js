"use strict";const r=require("react"),S=require("./vendor.js"),D=require("antd"),b=require("./index.js"),x=require("./client.js"),z=require("ahooks"),M=require("./base.js"),F=require("react-i18next"),P=r.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{},error:void 0}),L=()=>r.useContext(P),_=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),x.client.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete x.client.defaults.headers.common.Authorization)},U=({children:e})=>{const[t,s]=r.useState(void 0),[C,u]=r.useState(localStorage.getItem("token")),[I,y]=r.useState(!0),{run:A,error:m}=z.useRequest(async()=>{const a=localStorage.getItem("token");return a?(_(a,!1),b.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{s(void 0)},onSuccess:a=>{s(a)},onError:a=>{console.log([a]),console.error("Failed to get current user:",a),g()},onFinally:()=>{y(!1)}});r.useEffect(()=>{A()},[]);const i=async a=>{try{const n=await b.api.authorization.login(a),{token:f,user:c,needs_mfa:p,password_expired:o,mfa_token:d,mfa_type:v}=n;if(p)throw{needsMFA:!0,mfaToken:d,mfaType:v,user:c};if(o)throw{password_expired:!0,user:c,token:f};return _(f),u(f),s(c),c}catch(n){throw n&&n.needsMFA||n&&n.password_expired||D.message.error("Login failed, please check your username and password"),n}},l=r.useCallback(async a=>{try{const n=await b.api.oauth.handleCallback(a,{headers:{"X-Base-Path":M.getURL()}});let f="",c=null;if(n&&typeof n=="object")if("code"in n&&n.code==="0"&&"data"in n){const{token:p,user:o,needs_mfa:d,mfa_token:v,mfa_type:k}=n.data;if(d)throw{needsMFA:!0,mfaToken:v,mfaType:k,user:o};f=p,c=o}else{const{token:p,user:o,needs_mfa:d,mfa_token:v,mfa_type:k}=n;if(d)throw{needsMFA:!0,mfaToken:v,mfaType:k,user:o};f=p,c=o}return _(f),u(f),s(c),c}catch(n){throw s(void 0),n&&n.needsMFA||n&&n.passwordExpired,n}},[]),g=()=>{b.api.authorization.logout(),_(null),u(null),s(null)},h=a=>{s(a)};return S.jsxRuntimeExports.jsx(P.Provider,{value:{user:t,token:C,loading:I,login:i,oauthLogin:l,logout:g,updateUser:h,error:m},children:e})},R=()=>{const e=r.useContext(P);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},O=r.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{},error:void 0}),T=()=>r.useContext(O),j=({children:e})=>{const{user:t}=L(),{data:s=null,loading:C,runAsync:u,error:I}=z.useRequest(async()=>b.api.system.getSiteConfig(),{manual:!0});r.useEffect(()=>{t!==void 0&&u()},[t]);const[y,A]=r.useState(localStorage.getItem("orgID"));return r.useEffect(()=>{y?localStorage.setItem("orgID",y):localStorage.removeItem("orgID")},[y]),r.useEffect(()=>{var m,i,l;if(t){let g=localStorage.getItem("orgID");if(g){const h=(m=t==null?void 0:t.organizations)==null?void 0:m.find(a=>a.id===g);if(h){A(h.id);return}}A(((l=(i=t==null?void 0:t.organizations)==null?void 0:i[0])==null?void 0:l.id)??null)}},[s,t==null?void 0:t.organizations]),S.jsxRuntimeExports.jsx(O.Provider,{value:{siteConfig:s,loading:C,enableMultiOrg:(s==null?void 0:s.enable_multi_org)??!1,fetchSiteConfig:u,currentOrgId:y,setCurrentOrgId:m=>{A(m)},clearCurrentOrgId:()=>{A(null)},error:I},children:e})},G=()=>{var m;const{user:e}=r.useContext(P),{currentOrgId:t}=T(),s=(m=e==null?void 0:e.roles)==null?void 0:m.filter(i=>!i.organization_id||i.organization_id===t),C=()=>s?s.some(i=>i.name==="admin"&&!i.organization_id):!1,u=i=>s?C()?!0:s.some(l=>l.permissions?l.permissions.some(g=>g.code===i):!1):!1;return{hasPermission:u,hasAllPermissions:i=>i.every(l=>u(l)),hasAnyPermission:i=>i.some(l=>u(l)),hasGlobalPermission:i=>s?C()?!0:s.some(l=>l.organization_id||!l.permissions?!1:l.permissions.some(g=>g.code===i)):!1,isAdmin:C(),loading:!e}},q=r.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{},callAI:()=>{},onCallAI:e=>{},loaded:!1,setLoaded:()=>{},fetchConversations:()=>Promise.resolve([]),fetchConversationsLoading:!1,conversations:void 0,activeConversationKey:void 0,setActiveConversationKey:()=>{}}),B=()=>r.useContext(q),$=({children:e})=>{const{t}=F.useTranslation("ai"),[s,C]=r.useState("sidebar"),[u,I]=r.useState(!1),[y,A]=r.useState(!1),[m,i]=r.useState(void 0),[l,g]=r.useState(),[h,a]=r.useState(null);r.useEffect(()=>{const o=localStorage.getItem("activeConversationKey");o&&i(o)},[]);const n=r.useCallback((o,d)=>{I(!0),h?h(o,d):g([o,d])},[h,I]);r.useEffect(()=>{h&&l&&(h(l[0],l[1]),g(void 0))},[h,l]);const{loading:f,runAsync:c,data:p}=z.useRequest(async()=>(await b.api.ai.listChatSessions({current:1,page_size:20})).data,{ready:u,onError:o=>{D.message.error(t("chat.fetchConversationsFailed",{defaultValue:"Failed to fetch conversations: {{errmsg}}",errmsg:o.message??o}))}});return S.jsxRuntimeExports.jsx(q.Provider,{value:{layout:s,setLayout:o=>{C(o)},visible:u,setVisible:o=>{I(o)},callAI:n,onCallAI:r.useCallback(o=>{a(()=>o)},[a]),loaded:y,setLoaded:o=>{A(o)},fetchConversations:c,fetchConversationsLoading:f,conversations:p,activeConversationKey:m,setActiveConversationKey:o=>{i(o),localStorage.setItem("activeConversationKey",o)}},children:e})},K=new Map,J=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),N=(e,t)=>{const s=K.get(e);return s?t&&t>0&&Date.now()-s.timestamp>t*1e3?(K.delete(e),null):s.data:null},X=(e,t)=>{K.set(e,{data:t,timestamp:Date.now()})},H=(e,t,s)=>{const[C,u]=r.useState(t||[]),[I,y]=r.useState(!1),[A,m]=r.useState(null),[i,l]=r.useState(0),g=()=>l(a=>a+1),h=r.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(a=>s&&s[a]!==void 0&&s[a]!==null):!0,[e,s]);return r.useEffect(()=>{if(!h){u(t||[]);return}(async()=>{try{y(!0),m(null);const n=J(e,s);if(e.cache){const c=N(n,e.cache_ttl);if(c){u(c),y(!1);return}}let f=[];switch(e.type){case"api":{const c=e.url||"",p=e.method||"GET",o={...s,...e.params};let d;p.toUpperCase()==="GET"?d=await x.apiGet(c,{params:o}):d=await x.apiGet(c,{params:o});const v=Array.isArray(d)?d:d.data||[],k=e.label_key||"label",E=e.value_key||"value";f=v.map(w=>({label:w[k]||w.name||w.id,value:w[E]||w.id}));break}case"toolsets":{let p=(await b.api.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(p=p.filter(v=>Object.entries(e.filter).every(([k,E])=>v[k]===E)));const o=e.label_key||"name",d=e.value_key||"id";f=p.map(v=>({label:v[o]||v.name,value:v[d]||v.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),f=[];break}default:f=t||[]}e.cache&&X(n,f),u(f)}catch(n){console.error("Failed to load options from data source:",n),m(n),u(t||[])}finally{y(!1)}})()},[e,t,s,h,i]),{options:C,loading:I,error:A,refresh:g}};exports.AIProvider=$;exports.AuthProvider=U;exports.SiteProvider=j;exports.useAI=B;exports.useAuth=R;exports.useAuth$1=L;exports.useDynamicDataSource=H;exports.usePermission=G;exports.useSite=T;
