"use strict";const a=require("react"),_=require("./vendor.js"),q=require("antd"),y=require("./index.js"),v=require("./client.js"),P=require("ahooks"),I=a.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),z=()=>a.useContext(I),w=(o,t=!0)=>{o?(t&&localStorage.setItem("token",o),v.client.defaults.headers.common.Authorization=`Bearer ${o}`):(t&&localStorage.removeItem("token"),delete v.client.defaults.headers.common.Authorization)},E=({children:o})=>{const[t,r]=a.useState(void 0),[h,u]=a.useState(localStorage.getItem("token")),[x,f]=a.useState(!0),{run:l}=P.useRequest(async()=>{const s=localStorage.getItem("token");return s?(w(s,!1),y.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:s=>{r(s)},onError:s=>{console.error("Failed to get current user:",s),m()},onFinally:()=>{f(!1)}});a.useEffect(()=>{l()},[]);const n=async s=>{try{const e=await y.api.authorization.login(s),{token:d,user:c,needs_mfa:p,password_expired:g,mfa_token:k,mfa_type:A}=e;if(p)throw{needsMFA:!0,mfaToken:k,mfaType:A,user:c};if(g)throw{password_expired:!0,user:c,token:d};return w(d),u(d),r(c),c}catch(e){throw e&&e.needsMFA||e&&e.password_expired||q.message.error("Login failed, please check your username and password"),e}},i=a.useCallback(async s=>{try{const e=await y.api.oauth.handleCallback(s);let d="",c=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:p,user:g,needs_mfa:k,mfa_token:A,mfa_type:S}=e.data;if(k)throw{needsMFA:!0,mfaToken:A,mfaType:S,user:g};d=p,c=g}else{const{token:p,user:g,needs_mfa:k,mfa_token:A,mfa_type:S}=e;if(k)throw{needsMFA:!0,mfaToken:A,mfaType:S,user:g};d=p,c=g}return w(d),u(d),r(c),c}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),m=()=>{y.api.authorization.logout(),w(null),u(null),r(null)},C=s=>{r(s)};return _.jsxRuntimeExports.jsx(I.Provider,{value:{user:t,token:h,loading:x,login:n,oauthLogin:i,logout:m,updateUser:C},children:o})},U=()=>{const o=a.useContext(I);if(o===void 0)throw new Error("useAuth must be used within an AuthProvider");return o},O=a.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),T=()=>a.useContext(O),b=({children:o})=>{const{user:t}=z(),{data:r=null,loading:h,runAsync:u}=P.useRequest(async()=>y.api.system.getSiteConfig(),{manual:!0});a.useEffect(()=>{t!==void 0&&u()},[t]);const[x,f]=a.useState(null);return a.useEffect(()=>{var n,i,m;let l=localStorage.getItem("orgID");if(l){const C=(n=t==null?void 0:t.organizations)==null?void 0:n.find(s=>s.id===l);if(C){f(C.id);return}}f(((m=(i=t==null?void 0:t.organizations)==null?void 0:i[0])==null?void 0:m.id)??null)},[r,t==null?void 0:t.organizations]),_.jsxRuntimeExports.jsx(O.Provider,{value:{siteConfig:r,loading:h,enableMultiOrg:(r==null?void 0:r.enable_multi_org)??!1,fetchSiteConfig:u,currentOrgId:x,setCurrentOrgId:l=>{f(l),localStorage.setItem("orgID",l)},clearCurrentOrgId:()=>{f(null),localStorage.removeItem("orgID")}},children:o})},F=()=>{var l;const{user:o}=a.useContext(I),{currentOrgId:t}=T(),r=(l=o==null?void 0:o.roles)==null?void 0:l.filter(n=>!n.organization_id||n.organization_id===t),h=()=>r?r.some(n=>n.name==="admin"&&!n.organization_id):!1,u=n=>r?h()?!0:r.some(i=>i.permissions?i.permissions.some(m=>m.code===n):!1):!1;return{hasPermission:u,hasAllPermissions:n=>n.every(i=>u(i)),hasAnyPermission:n=>n.some(i=>u(i)),isAdmin:h(),loading:!o}};exports.AuthProvider=E;exports.SiteProvider=b;exports.useAuth=U;exports.useAuth$1=z;exports.usePermission=F;exports.useSite=T;
