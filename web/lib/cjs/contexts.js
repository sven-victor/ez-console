"use strict";const n=require("react"),S=require("./vendor.js"),E=require("antd"),I=require("./index.js"),x=require("./client.js"),T=require("ahooks"),M=require("./base.js"),U=require("react-i18next"),D=n.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{},error:void 0}),K=()=>n.useContext(D),_=(e,s=!0)=>{e?(s&&localStorage.setItem("token",e),x.client.defaults.headers.common.Authorization=`Bearer ${e}`):(s&&localStorage.removeItem("token"),delete x.client.defaults.headers.common.Authorization)},F=({children:e})=>{const[s,r]=n.useState(void 0),[C,f]=n.useState(localStorage.getItem("token")),[A,v]=n.useState(!0),{run:k,error:h}=T.useRequest(async()=>{const a=localStorage.getItem("token");return a?(_(a,!1),I.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{r(void 0)},onSuccess:a=>{r(a)},onError:a=>{console.log([a]),console.error("Failed to get current user:",a),g()},onFinally:()=>{v(!1)}});n.useEffect(()=>{k()},[]);const i=async a=>{try{const t=await I.api.authorization.login(a),{token:c,user:u,needs_mfa:d,password_expired:o,mfa_token:m,mfa_type:p}=t;if(d)throw{needsMFA:!0,mfaToken:m,mfaType:p,user:u};if(o)throw{password_expired:!0,user:u,token:c};return _(c),f(c),r(u),u}catch(t){throw t&&t.needsMFA||t&&t.password_expired||E.message.error("Login failed, please check your username and password"),t}},l=n.useCallback(async a=>{try{const t=await I.api.oauth.handleCallback(a,{headers:{"X-Base-Path":M.getURL()}});let c="",u=null;if(t&&typeof t=="object")if("code"in t&&t.code==="0"&&"data"in t){const{token:d,user:o,needs_mfa:m,mfa_token:p,mfa_type:w}=t.data;if(m)throw{needsMFA:!0,mfaToken:p,mfaType:w,user:o};c=d,u=o}else{const{token:d,user:o,needs_mfa:m,mfa_token:p,mfa_type:w}=t;if(m)throw{needsMFA:!0,mfaToken:p,mfaType:w,user:o};c=d,u=o}return _(c),f(c),r(u),u}catch(t){throw r(void 0),t&&t.needsMFA||t&&t.passwordExpired,t}},[]),g=()=>{I.api.authorization.logout(),_(null),f(null),r(null)},y=a=>{r(a)};return S.jsxRuntimeExports.jsx(D.Provider,{value:{user:s,token:C,loading:A,login:i,oauthLogin:l,logout:g,updateUser:y,error:h},children:e})},R=()=>{const e=n.useContext(D);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},z=n.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{},error:void 0,tasks:void 0,addTask:()=>{},tasksDropdownOpen:!1,setTasksDropdownOpen:()=>{}}),L=()=>n.useContext(z),j=({children:e})=>{const{user:s}=K(),{data:r=null,loading:C,runAsync:f,error:A}=T.useRequest(async()=>I.api.system.getSiteConfig(),{manual:!0});n.useEffect(()=>{s!==void 0&&f()},[s]);const[v,k]=n.useState(localStorage.getItem("orgID"));n.useEffect(()=>{v?localStorage.setItem("orgID",v):localStorage.removeItem("orgID")},[v]),n.useEffect(()=>{var a,t,c;if(s){let u=localStorage.getItem("orgID");if(u){const d=(a=s==null?void 0:s.organizations)==null?void 0:a.find(o=>o.id===u);if(d){k(d.id);return}}k(((c=(t=s==null?void 0:s.organizations)==null?void 0:t[0])==null?void 0:c.id)??null)}},[r,s==null?void 0:s.organizations]);const[h,i]=n.useState(!1),[l,g]=n.useState([]),{run:y}=T.useRequest(async()=>I.api.userTasks.listUserTasks({}),{onSuccess:a=>{g(a)},refreshDeps:[s],pollingInterval:h?3e3:6e4});return n.useEffect(()=>{h&&y()},[h]),S.jsxRuntimeExports.jsx(z.Provider,{value:{siteConfig:r,loading:C,enableMultiOrg:(r==null?void 0:r.enable_multi_org)??!1,fetchSiteConfig:f,currentOrgId:v,setCurrentOrgId:a=>{k(a)},clearCurrentOrgId:()=>{k(null)},error:A,tasks:l,setTasksDropdownOpen:a=>{i(a)},tasksDropdownOpen:h,addTask:a=>{g(t=>[a,...t]),i(!0)}},children:e})},G=()=>{var h;const{user:e}=n.useContext(D),{currentOrgId:s}=L(),r=(h=e==null?void 0:e.roles)==null?void 0:h.filter(i=>!i.organization_id||i.organization_id===s),C=()=>r?r.some(i=>i.name==="admin"&&!i.organization_id):!1,f=i=>r?C()?!0:r.some(l=>l.permissions?l.permissions.some(g=>g.code===i):!1):!1;return{hasPermission:f,hasAllPermissions:i=>i.every(l=>f(l)),hasAnyPermission:i=>i.some(l=>f(l)),hasGlobalPermission:i=>r?C()?!0:r.some(l=>l.organization_id||!l.permissions?!1:l.permissions.some(g=>g.code===i)):!1,isAdmin:C(),loading:!e}},q=n.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{},callAI:()=>{},onCallAI:e=>{},loaded:!1,setLoaded:()=>{},fetchConversations:()=>Promise.resolve([]),fetchConversationsLoading:!1,conversations:void 0,activeConversationKey:void 0,setActiveConversationKey:()=>{}}),B=()=>n.useContext(q),$=({children:e})=>{const{t:s}=U.useTranslation("ai"),[r,C]=n.useState("sidebar"),[f,A]=n.useState(!1),[v,k]=n.useState(!1),[h,i]=n.useState(void 0),[l,g]=n.useState(),[y,a]=n.useState(null);n.useEffect(()=>{const o=localStorage.getItem("activeConversationKey");o&&i(o)},[]);const t=n.useCallback((o,m)=>{A(!0),y?y(o,m):g([o,m])},[y,A]);n.useEffect(()=>{y&&l&&(y(l[0],l[1]),g(void 0))},[y,l]);const{loading:c,runAsync:u,data:d}=T.useRequest(async()=>(await I.api.ai.listChatSessions({current:1,page_size:20})).data,{ready:f,onError:o=>{E.message.error(s("chat.fetchConversationsFailed",{defaultValue:"Failed to fetch conversations: {{errmsg}}",errmsg:o.message??o}))}});return S.jsxRuntimeExports.jsx(q.Provider,{value:{layout:r,setLayout:o=>{C(o)},visible:f,setVisible:o=>{A(o)},callAI:t,onCallAI:n.useCallback(o=>{a(()=>o)},[a]),loaded:v,setLoaded:o=>{k(o)},fetchConversations:u,fetchConversationsLoading:c,conversations:d,activeConversationKey:h,setActiveConversationKey:o=>{i(o),localStorage.setItem("activeConversationKey",o)}},children:e})},O=new Map,J=(e,s)=>JSON.stringify({dataSource:e,dependentValues:s}),N=(e,s)=>{const r=O.get(e);return r?s&&s>0&&Date.now()-r.timestamp>s*1e3?(O.delete(e),null):r.data:null},X=(e,s)=>{O.set(e,{data:s,timestamp:Date.now()})},H=(e,s,r)=>{const[C,f]=n.useState(s||[]),[A,v]=n.useState(!1),[k,h]=n.useState(null),[i,l]=n.useState(0),g=()=>l(a=>a+1),y=n.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(a=>r&&r[a]!==void 0&&r[a]!==null):!0,[e,r]);return n.useEffect(()=>{if(!y){f(s||[]);return}(async()=>{try{v(!0),h(null);const t=J(e,r);if(e.cache){const u=N(t,e.cache_ttl);if(u){f(u),v(!1);return}}let c=[];switch(e.type){case"api":{const u=e.url||"",d=e.method||"GET",o={...r,...e.params};let m;d.toUpperCase()==="GET"?m=await x.apiGet(u,{params:o}):m=await x.apiGet(u,{params:o});const p=Array.isArray(m)?m:m.data||[],w=e.label_key||"label",P=e.value_key||"value";c=p.map(b=>({label:b[w]||b.name||b.id,value:b[P]||b.id}));break}case"toolsets":{let d=(await I.api.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(d=d.filter(p=>Object.entries(e.filter).every(([w,P])=>p[w]===P)));const o=e.label_key||"name",m=e.value_key||"id";c=d.map(p=>({label:p[o]||p.name,value:p[m]||p.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),c=[];break}default:c=s||[]}e.cache&&X(t,c),f(c)}catch(t){console.error("Failed to load options from data source:",t),h(t),f(s||[])}finally{v(!1)}})()},[e,s,r,y,i]),{options:C,loading:A,error:k,refresh:g}};exports.AIProvider=$;exports.AuthProvider=F;exports.SiteProvider=j;exports.useAI=B;exports.useAuth=R;exports.useAuth$1=K;exports.useDynamicDataSource=H;exports.usePermission=G;exports.useSite=L;
