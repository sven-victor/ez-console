"use strict";const r=require("react"),E=require("./vendor.js"),q=require("antd"),_=require("./index.js"),x=require("./client.js"),O=require("ahooks"),b=r.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),T=()=>r.useContext(b),I=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),x.client.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete x.client.defaults.headers.common.Authorization)},F=({children:e})=>{const[t,s]=r.useState(void 0),[k,l]=r.useState(localStorage.getItem("token")),[w,g]=r.useState(!0),{run:p}=O.useRequest(async()=>{const a=localStorage.getItem("token");return a?(I(a,!1),_.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:a=>{s(a)},onError:a=>{console.error("Failed to get current user:",a),v()},onFinally:()=>{g(!1)}});r.useEffect(()=>{p()},[]);const o=async a=>{try{const n=await _.api.authorization.login(a),{token:u,user:i,needs_mfa:m,password_expired:f,mfa_token:y,mfa_type:d}=n;if(m)throw{needsMFA:!0,mfaToken:y,mfaType:d,user:i};if(f)throw{password_expired:!0,user:i,token:u};return I(u),l(u),s(i),i}catch(n){throw n&&n.needsMFA||n&&n.password_expired||q.message.error("Login failed, please check your username and password"),n}},c=r.useCallback(async a=>{try{const n=await _.api.oauth.handleCallback(a);let u="",i=null;if(n&&typeof n=="object")if("code"in n&&n.code==="0"&&"data"in n){const{token:m,user:f,needs_mfa:y,mfa_token:d,mfa_type:h}=n.data;if(y)throw{needsMFA:!0,mfaToken:d,mfaType:h,user:f};u=m,i=f}else{const{token:m,user:f,needs_mfa:y,mfa_token:d,mfa_type:h}=n;if(y)throw{needsMFA:!0,mfaToken:d,mfaType:h,user:f};u=m,i=f}return I(u),l(u),s(i),i}catch(n){throw n&&n.needsMFA||n&&n.passwordExpired,n}},[]),v=()=>{_.api.authorization.logout(),I(null),l(null),s(null)},A=a=>{s(a)};return E.jsxRuntimeExports.jsx(b.Provider,{value:{user:t,token:k,loading:w,login:o,oauthLogin:c,logout:v,updateUser:A},children:e})},K=()=>{const e=r.useContext(b);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},M=r.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{}}),U=()=>r.useContext(M),j=({children:e})=>{const{user:t}=T(),{data:s=null,loading:k,runAsync:l}=O.useRequest(async()=>_.api.system.getSiteConfig(),{manual:!0});r.useEffect(()=>{t!==void 0&&l()},[t]);const[w,g]=r.useState(null);return r.useEffect(()=>{w?localStorage.setItem("orgID",w):localStorage.removeItem("orgID")},[w]),r.useEffect(()=>{var o,c,v;let p=localStorage.getItem("orgID");if(p){const A=(o=t==null?void 0:t.organizations)==null?void 0:o.find(a=>a.id===p);if(A){g(A.id);return}}g(((v=(c=t==null?void 0:t.organizations)==null?void 0:c[0])==null?void 0:v.id)??null)},[s,t==null?void 0:t.organizations]),E.jsxRuntimeExports.jsx(M.Provider,{value:{siteConfig:s,loading:k,enableMultiOrg:(s==null?void 0:s.enable_multi_org)??!1,fetchSiteConfig:l,currentOrgId:w,setCurrentOrgId:p=>{g(p)},clearCurrentOrgId:()=>{g(null)}},children:e})},L=()=>{var p;const{user:e}=r.useContext(b),{currentOrgId:t}=U(),s=(p=e==null?void 0:e.roles)==null?void 0:p.filter(o=>!o.organization_id||o.organization_id===t),k=()=>s?s.some(o=>o.name==="admin"&&!o.organization_id):!1,l=o=>s?k()?!0:s.some(c=>c.permissions?c.permissions.some(v=>v.code===o):!1):!1;return{hasPermission:l,hasAllPermissions:o=>o.every(c=>l(c)),hasAnyPermission:o=>o.some(c=>l(c)),isAdmin:k(),loading:!e}},z=new Map,R=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),S=(e,t)=>{const s=z.get(e);return s?t&&t>0&&Date.now()-s.timestamp>t*1e3?(z.delete(e),null):s.data:null},G=(e,t)=>{z.set(e,{data:t,timestamp:Date.now()})},$=(e,t,s)=>{const[k,l]=r.useState(t||[]),[w,g]=r.useState(!1),[p,o]=r.useState(null),[c,v]=r.useState(0),A=()=>v(n=>n+1),a=r.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(n=>s&&s[n]!==void 0&&s[n]!==null):!0,[e,s]);return r.useEffect(()=>{if(!a){l(t||[]);return}(async()=>{try{g(!0),o(null);const u=R(e,s);if(e.cache){const m=S(u,e.cache_ttl);if(m){l(m),g(!1);return}}let i=[];switch(e.type){case"api":{const m=e.url||"",f=e.method||"GET",y={...s,...e.params};let d;f.toUpperCase()==="GET"?d=await x.apiGet(m,{params:y}):d=await x.apiGet(m,{params:y});const h=Array.isArray(d)?d:d.data||[],D=e.label_key||"label",P=e.value_key||"value";i=h.map(C=>({label:C[D]||C.name||C.id,value:C[P]||C.id}));break}case"toolsets":{let f=(await _.api.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(f=f.filter(h=>Object.entries(e.filter).every(([D,P])=>h[D]===P)));const y=e.label_key||"name",d=e.value_key||"id";i=f.map(h=>({label:h[y]||h.name,value:h[d]||h.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),i=[];break}default:i=t||[]}e.cache&&G(u,i),l(i)}catch(u){console.error("Failed to load options from data source:",u),o(u),l(t||[])}finally{g(!1)}})()},[e,t,s,a,c]),{options:k,loading:w,error:p,refresh:A}};exports.AuthProvider=F;exports.SiteProvider=j;exports.useAuth=K;exports.useAuth$1=T;exports.useDynamicDataSource=$;exports.usePermission=L;exports.useSite=U;
