"use strict";const a=require("react"),y=require("./vendor.js"),p=require("./index.js"),P=require("./client.js"),A=a.createContext({user:null,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),U=()=>a.useContext(A),k=(t,l=!0)=>{t?(l&&localStorage.setItem("token",t),P.client.defaults.headers.common.Authorization=`Bearer ${t}`):(l&&localStorage.removeItem("token"),delete P.client.defaults.headers.common.Authorization)},F=({children:t})=>{const[l,r]=a.useState(null),[x,h]=a.useState(localStorage.getItem("token")),[o,u]=a.useState(!0),{run:g}=y.useRequest(async()=>{const s=localStorage.getItem("token");return s?(k(s,!1),p.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:s=>{r(s)},onError:s=>{console.error("Failed to get current user:",s),_()},onFinally:()=>{u(!1)}});a.useEffect(()=>{g()},[]);const T=async s=>{try{const e=await p.api.authorization.login(s),{token:i,user:n,needs_mfa:d,password_expired:c,mfa_token:f,mfa_type:m}=e;if(d)throw{needsMFA:!0,mfaToken:f,mfaType:m,user:n};if(c)throw{password_expired:!0,user:n,token:i};return k(i),h(i),r(n),n}catch(e){throw e&&e.needsMFA||e&&e.password_expired||y.staticMethods.error("Login failed, please check your username and password"),e}},v=a.useCallback(async s=>{try{const e=await p.api.oauth.handleCallback(s);let i="",n=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:d,user:c,needs_mfa:f,mfa_token:m,mfa_type:w}=e.data;if(f)throw{needsMFA:!0,mfaToken:m,mfaType:w,user:c};i=d,n=c}else{const{token:d,user:c,needs_mfa:f,mfa_token:m,mfa_type:w}=e;if(f)throw{needsMFA:!0,mfaToken:m,mfaType:w,user:c};i=d,n=c}return k(i),h(i),r(n),n}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),_=()=>{p.api.authorization.logout(),k(null),h(null),r(null)},C=s=>{r(s)};return y.jsxRuntimeExports.jsx(A.Provider,{value:{user:l,token:x,loading:o,login:T,oauthLogin:v,logout:_,updateUser:C},children:t})},S=()=>{const t=a.useContext(A);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t},M=()=>{const{user:t}=a.useContext(A),l=()=>!t||!t.roles?!1:t.roles.some(o=>o.name==="admin"),r=o=>!t||!t.roles?!1:l()?!0:t.roles.some(u=>u.permissions?u.permissions.some(g=>g.code===o):!1);return{hasPermission:r,hasAllPermissions:o=>o.every(u=>r(u)),hasAnyPermission:o=>o.some(u=>r(u)),isAdmin:l(),loading:!t}};exports.AuthProvider=F;exports.useAuth=S;exports.useAuth$1=U;exports.usePermission=M;
