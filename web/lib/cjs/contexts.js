"use strict";const a=require("react"),C=require("./vendor.js"),U=require("antd"),p=require("./index.js"),_=require("./client.js"),q=require("ahooks"),A=a.createContext({user:null,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),F=()=>a.useContext(A),k=(t,l=!0)=>{t?(l&&localStorage.setItem("token",t),_.client.defaults.headers.common.Authorization=`Bearer ${t}`):(l&&localStorage.removeItem("token"),delete _.client.defaults.headers.common.Authorization)},S=({children:t})=>{const[l,r]=a.useState(null),[y,h]=a.useState(localStorage.getItem("token")),[o,u]=a.useState(!0),{run:g}=q.useRequest(async()=>{const s=localStorage.getItem("token");return s?(k(s,!1),p.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:s=>{r(s)},onError:s=>{console.error("Failed to get current user:",s),x()},onFinally:()=>{u(!1)}});a.useEffect(()=>{g()},[]);const P=async s=>{try{const e=await p.api.authorization.login(s),{token:i,user:n,needs_mfa:d,password_expired:c,mfa_token:f,mfa_type:m}=e;if(d)throw{needsMFA:!0,mfaToken:f,mfaType:m,user:n};if(c)throw{password_expired:!0,user:n,token:i};return k(i),h(i),r(n),n}catch(e){throw e&&e.needsMFA||e&&e.password_expired||U.message.error("Login failed, please check your username and password"),e}},T=a.useCallback(async s=>{try{const e=await p.api.oauth.handleCallback(s);let i="",n=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:d,user:c,needs_mfa:f,mfa_token:m,mfa_type:w}=e.data;if(f)throw{needsMFA:!0,mfaToken:m,mfaType:w,user:c};i=d,n=c}else{const{token:d,user:c,needs_mfa:f,mfa_token:m,mfa_type:w}=e;if(f)throw{needsMFA:!0,mfaToken:m,mfaType:w,user:c};i=d,n=c}return k(i),h(i),r(n),n}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),x=()=>{p.api.authorization.logout(),k(null),h(null),r(null)},v=s=>{r(s)};return C.jsxRuntimeExports.jsx(A.Provider,{value:{user:l,token:y,loading:o,login:P,oauthLogin:T,logout:x,updateUser:v},children:t})},z=()=>{const t=a.useContext(A);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t},E=()=>{const{user:t}=a.useContext(A),l=()=>!t||!t.roles?!1:t.roles.some(o=>o.name==="admin"),r=o=>!t||!t.roles?!1:l()?!0:t.roles.some(u=>u.permissions?u.permissions.some(g=>g.code===o):!1);return{hasPermission:r,hasAllPermissions:o=>o.every(u=>r(u)),hasAnyPermission:o=>o.some(u=>r(u)),isAdmin:l(),loading:!t}};exports.AuthProvider=S;exports.useAuth=z;exports.useAuth$1=F;exports.usePermission=E;
