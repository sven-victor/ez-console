"use strict";const r=require("react"),P=require("./vendor.js"),p=require("./index.js"),v=require("ahooks"),U=require("antd"),C=require("./client.js"),x=r.createContext({user:null,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{}}),z=()=>r.useContext(x),y=(t,u=!0)=>{t?(u&&localStorage.setItem("token",t),C.client.defaults.headers.common.Authorization=`Bearer ${t}`):(u&&localStorage.removeItem("token"),delete C.client.defaults.headers.common.Authorization)},b=({children:t})=>{const[u,n]=r.useState(null),[f,a]=r.useState(localStorage.getItem("token")),[_,S]=r.useState(!0),{run:k}=v.useRequest(async()=>{const o=localStorage.getItem("token");return o?(y(o,!1),p.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{},onSuccess:o=>{n(o)},onError:o=>{console.error("Failed to get current user:",o),A()},onFinally:()=>{S(!1)}});r.useEffect(()=>{k()},[]);const s=async o=>{try{const e=await p.api.authorization.login(o),{token:c,user:i,needs_mfa:m,password_expired:d,mfa_token:h,mfa_type:g}=e;if(m)throw{needsMFA:!0,mfaToken:h,mfaType:g,user:i};if(d)throw{password_expired:!0,user:i,token:c};return y(c),a(c),n(i),i}catch(e){throw e&&e.needsMFA||e&&e.password_expired||U.message.error("Login failed, please check your username and password"),e}},l=r.useCallback(async o=>{try{const e=await p.api.oauth.handleCallback(o);let c="",i=null;if(e&&typeof e=="object")if("code"in e&&e.code==="0"&&"data"in e){const{token:m,user:d,needs_mfa:h,mfa_token:g,mfa_type:w}=e.data;if(h)throw{needsMFA:!0,mfaToken:g,mfaType:w,user:d};c=m,i=d}else{const{token:m,user:d,needs_mfa:h,mfa_token:g,mfa_type:w}=e;if(h)throw{needsMFA:!0,mfaToken:g,mfaType:w,user:d};c=m,i=d}return y(c),a(c),n(i),i}catch(e){throw e&&e.needsMFA||e&&e.passwordExpired,e}},[]),A=()=>{p.api.authorization.logout(),y(null),a(null),n(null)},q=o=>{n(o)};return P.jsxRuntimeExports.jsx(x.Provider,{value:{user:u,token:f,loading:_,login:s,oauthLogin:l,logout:A,updateUser:q},children:t})},E=()=>{const t=r.useContext(x);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t},F=()=>{var k;const{user:t}=r.useContext(x),u=localStorage.getItem("organization_id"),n=(k=t==null?void 0:t.roles)==null?void 0:k.filter(s=>!s.organization_id||s.organization_id===u),f=()=>n?n.some(s=>s.name==="admin"&&!s.organization_id):!1,a=s=>n?f()?!0:n.some(l=>l.permissions?l.permissions.some(A=>A.code===s):!1):!1;return{hasPermission:a,hasAllPermissions:s=>s.every(l=>a(l)),hasAnyPermission:s=>s.some(l=>a(l)),isAdmin:f(),loading:!t}},T=r.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null}),I=()=>r.useContext(T),M=({children:t})=>{const{user:u}=z(),{data:n=null,loading:f,runAsync:a}=v.useRequest(async()=>p.api.system.getSiteConfig(),{manual:!0});return r.useEffect(()=>{a()},[u]),P.jsxRuntimeExports.jsx(T.Provider,{value:{siteConfig:n,loading:f,enableMultiOrg:(n==null?void 0:n.enable_multi_org)??!1,fetchSiteConfig:a},children:t})};exports.AuthProvider=b;exports.SiteProvider=M;exports.useAuth=E;exports.useAuth$1=z;exports.usePermission=F;exports.useSite=I;
