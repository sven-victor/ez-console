"use strict";const o=require("react"),S=require("./vendor.js"),L=require("antd"),w=require("./index.js"),x=require("./client.js"),D=require("ahooks"),M=require("./base.js"),F=require("react-i18next"),P=o.createContext({user:void 0,token:null,loading:!1,login:async()=>{},oauthLogin:async()=>{},logout:()=>{},updateUser:()=>{},error:void 0}),z=()=>o.useContext(P),_=(e,t=!0)=>{e?(t&&localStorage.setItem("token",e),x.client.defaults.headers.common.Authorization=`Bearer ${e}`):(t&&localStorage.removeItem("token"),delete x.client.defaults.headers.common.Authorization)},U=({children:e})=>{const[t,r]=o.useState(void 0),[C,l]=o.useState(localStorage.getItem("token")),[A,h]=o.useState(!0),{run:v,error:i}=D.useRequest(async()=>{const a=localStorage.getItem("token");return a?(_(a,!1),w.api.authorization.getCurrentUser()):null},{manual:!0,onBefore:()=>{r(void 0)},onSuccess:a=>{r(a)},onError:a=>{console.log([a]),console.error("Failed to get current user:",a),I()},onFinally:()=>{h(!1)}});o.useEffect(()=>{v()},[]);const f=async a=>{try{const s=await w.api.authorization.login(a),{token:u,user:c,needs_mfa:p,password_expired:n,mfa_token:d,mfa_type:m}=s;if(p)throw{needsMFA:!0,mfaToken:d,mfaType:m,user:c};if(n)throw{password_expired:!0,user:c,token:u};return _(u),l(u),r(c),c}catch(s){throw s&&s.needsMFA||s&&s.password_expired||L.message.error("Login failed, please check your username and password"),s}},y=o.useCallback(async a=>{try{const s=await w.api.oauth.handleCallback(a,{headers:{"X-Base-Path":M.getURL()}});let u="",c=null;if(s&&typeof s=="object")if("code"in s&&s.code==="0"&&"data"in s){const{token:p,user:n,needs_mfa:d,mfa_token:m,mfa_type:k}=s.data;if(d)throw{needsMFA:!0,mfaToken:m,mfaType:k,user:n};u=p,c=n}else{const{token:p,user:n,needs_mfa:d,mfa_token:m,mfa_type:k}=s;if(d)throw{needsMFA:!0,mfaToken:m,mfaType:k,user:n};u=p,c=n}return _(u),l(u),r(c),c}catch(s){throw r(void 0),s&&s.needsMFA||s&&s.passwordExpired,s}},[]),I=()=>{w.api.authorization.logout(),_(null),l(null),r(null)},g=a=>{r(a)};return S.jsxRuntimeExports.jsx(P.Provider,{value:{user:t,token:C,loading:A,login:f,oauthLogin:y,logout:I,updateUser:g,error:i},children:e})},R=()=>{const e=o.useContext(P);if(e===void 0)throw new Error("useAuth must be used within an AuthProvider");return e},O=o.createContext({siteConfig:null,enableMultiOrg:!1,loading:!1,fetchSiteConfig:async()=>null,currentOrgId:null,setCurrentOrgId:()=>{},clearCurrentOrgId:()=>{},error:void 0}),T=()=>o.useContext(O),j=({children:e})=>{const{user:t}=z(),{data:r=null,loading:C,runAsync:l,error:A}=D.useRequest(async()=>w.api.system.getSiteConfig(),{manual:!0});o.useEffect(()=>{t!==void 0&&l()},[t]);const[h,v]=o.useState(localStorage.getItem("orgID"));return o.useEffect(()=>{h?localStorage.setItem("orgID",h):localStorage.removeItem("orgID")},[h]),o.useEffect(()=>{var i,f,y;if(t){let I=localStorage.getItem("orgID");if(I){const g=(i=t==null?void 0:t.organizations)==null?void 0:i.find(a=>a.id===I);if(g){v(g.id);return}}v(((y=(f=t==null?void 0:t.organizations)==null?void 0:f[0])==null?void 0:y.id)??null)}},[r,t==null?void 0:t.organizations]),S.jsxRuntimeExports.jsx(O.Provider,{value:{siteConfig:r,loading:C,enableMultiOrg:(r==null?void 0:r.enable_multi_org)??!1,fetchSiteConfig:l,currentOrgId:h,setCurrentOrgId:i=>{v(i)},clearCurrentOrgId:()=>{v(null)},error:A},children:e})},G=()=>{var v;const{user:e}=o.useContext(P),{currentOrgId:t}=T(),r=(v=e==null?void 0:e.roles)==null?void 0:v.filter(i=>!i.organization_id||i.organization_id===t),C=()=>r?r.some(i=>i.name==="admin"&&!i.organization_id):!1,l=i=>r?C()?!0:r.some(f=>f.permissions?f.permissions.some(y=>y.code===i):!1):!1;return{hasPermission:l,hasAllPermissions:i=>i.every(f=>l(f)),hasAnyPermission:i=>i.some(f=>l(f)),isAdmin:C(),loading:!e}},q=o.createContext({layout:"sidebar",setLayout:()=>{},visible:!1,setVisible:()=>{},callAI:()=>{},onCallAI:e=>{},loaded:!1,setLoaded:()=>{},fetchConversations:()=>Promise.resolve([]),fetchConversationsLoading:!1,conversations:void 0,activeConversationKey:void 0,setActiveConversationKey:()=>{}}),B=()=>o.useContext(q),$=({children:e})=>{const{t}=F.useTranslation("ai"),[r,C]=o.useState("sidebar"),[l,A]=o.useState(!1),[h,v]=o.useState(!1),[i,f]=o.useState(void 0),[y,I]=o.useState(),[g,a]=o.useState(null);o.useEffect(()=>{const n=localStorage.getItem("activeConversationKey");n&&f(n)},[]);const s=o.useCallback((n,d)=>{A(!0),g?g(n,d):I([n,d])},[g,A]);o.useEffect(()=>{g&&y&&(g(y[0],y[1]),I(void 0))},[g,y]);const{loading:u,runAsync:c,data:p}=D.useRequest(async()=>(await w.api.ai.listChatSessions({current:1,page_size:20})).data,{ready:l,onError:n=>{L.message.error(t("chat.fetchConversationsFailed",{defaultValue:"Failed to fetch conversations: {{errmsg}}",errmsg:n.message??n}))}});return S.jsxRuntimeExports.jsx(q.Provider,{value:{layout:r,setLayout:n=>{C(n)},visible:l,setVisible:n=>{A(n)},callAI:s,onCallAI:o.useCallback(n=>{a(()=>n)},[a]),loaded:h,setLoaded:n=>{v(n)},fetchConversations:c,fetchConversationsLoading:u,conversations:p,activeConversationKey:i,setActiveConversationKey:n=>{f(n),localStorage.setItem("activeConversationKey",n)}},children:e})},K=new Map,J=(e,t)=>JSON.stringify({dataSource:e,dependentValues:t}),N=(e,t)=>{const r=K.get(e);return r?t&&t>0&&Date.now()-r.timestamp>t*1e3?(K.delete(e),null):r.data:null},X=(e,t)=>{K.set(e,{data:t,timestamp:Date.now()})},H=(e,t,r)=>{const[C,l]=o.useState(t||[]),[A,h]=o.useState(!1),[v,i]=o.useState(null),[f,y]=o.useState(0),I=()=>y(a=>a+1),g=o.useMemo(()=>!e||e.type==="static"?!1:e.depends_on&&e.depends_on.length>0?e.depends_on.every(a=>r&&r[a]!==void 0&&r[a]!==null):!0,[e,r]);return o.useEffect(()=>{if(!g){l(t||[]);return}(async()=>{try{h(!0),i(null);const s=J(e,r);if(e.cache){const c=N(s,e.cache_ttl);if(c){l(c),h(!1);return}}let u=[];switch(e.type){case"api":{const c=e.url||"",p=e.method||"GET",n={...r,...e.params};let d;p.toUpperCase()==="GET"?d=await x.apiGet(c,{params:n}):d=await x.apiGet(c,{params:n});const m=Array.isArray(d)?d:d.data||[],k=e.label_key||"label",E=e.value_key||"value";u=m.map(b=>({label:b[k]||b.name||b.id,value:b[E]||b.id}));break}case"toolsets":{let p=(await w.api.system.listToolSets({current:1,page_size:1e3,...e.params})).data||[];e.filter&&(p=p.filter(m=>Object.entries(e.filter).every(([k,E])=>m[k]===E)));const n=e.label_key||"name",d=e.value_key||"id";u=p.map(m=>({label:m[n]||m.name,value:m[d]||m.id}));break}case"internal":{console.warn("Internal data source not yet implemented"),u=[];break}default:u=t||[]}e.cache&&X(s,u),l(u)}catch(s){console.error("Failed to load options from data source:",s),i(s),l(t||[])}finally{h(!1)}})()},[e,t,r,g,f]),{options:C,loading:A,error:v,refresh:I}};exports.AIProvider=$;exports.AuthProvider=U;exports.SiteProvider=j;exports.useAI=B;exports.useAuth=R;exports.useAuth$1=z;exports.useDynamicDataSource=H;exports.usePermission=G;exports.useSite=T;
