"use strict";var de=Object.defineProperty;var me=(t,r,n)=>r in t?de(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n;var X=(t,r,n)=>me(t,typeof r!="symbol"?r+"":r,n);const e=require("./vendor.js"),Y=require("react-router-dom"),z=require("./contexts.js"),Q=require("./base.js"),s=require("antd"),C=require("react-i18next"),N=require("antd-style"),y=require("@ant-design/icons"),pe=require("classnames"),c=require("react"),v=require("./index.js"),L=require("ahooks"),M=require("./client.js"),je=require("antd-img-crop"),he=require("lodash"),U=require("dayjs");function ge(t){const r=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(t){for(const n in t)if(n!=="default"){const i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(r,n,i.get?i:{enumerable:!0,get:()=>t[n]})}}return r.default=t,Object.freeze(r)}const fe=ge(y),Z=()=>e.jsxRuntimeExports.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",width:"100%"},children:e.jsxRuntimeExports.jsx(s.Spin,{size:"large"})}),Re=({element:t,requiredPermission:r,requiredPermissions:n})=>{const{user:i,loading:a}=z.useAuth(),{hasPermission:o,hasAllPermissions:p}=z.usePermission();return a?e.jsxRuntimeExports.jsx(Z,{}):i?r&&!o(r)?e.jsxRuntimeExports.jsx(Y.Navigate,{to:"/forbidden",replace:!0}):n&&!p(n)?e.jsxRuntimeExports.jsx(Y.Navigate,{to:"/forbidden",replace:!0}):t:(window.location.href=Q.getURL("/login?redirect="+encodeURIComponent(window.location.href)),null)},Ee=N.createStyles(({token:t,css:r})=>({container:r`
      ${r`
        @media screen and (max-width: ${t.screenXS}px) {
          width: 100% !important;
          > * {
            border-radius: 0 !important;
          }
        }
      `}
    > *{
      background-color: ${t.colorBgElevated};
      border-radius: 4px;
      box-shadow: ${t.boxShadowTertiary};
    }
    `,iconStyle:{cursor:"pointer",padding:"12px",display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:18,verticalAlign:"middle","&:hover":{color:t.colorPrimaryTextHover}}})),G=({overlayClassName:t,overlay:r,hidden:n,children:i,...a})=>{if(n)return e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{});const{styles:o}=Ee();return e.jsxRuntimeExports.jsx(s.Dropdown,{dropdownRender:r,overlayClassName:pe(o.container,t),...a,children:e.jsxRuntimeExports.jsx("span",{className:o.iconStyle,children:i})})},ye=()=>e.jsxRuntimeExports.jsxs("svg",{viewBox:"0 0 24 24",focusable:"false",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true",children:[e.jsxRuntimeExports.jsx("path",{d:"M0 0h24v24H0z",fill:"none"}),e.jsxRuntimeExports.jsx("path",{d:"M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z ",className:"css-c4d79v"})]}),Se=N.createStyles(()=>({menuItemStyle:{minWidth:"160px"},menuItemIconStyle:{marginRight:"8px"}})),ee=[{lang:"en-US",label:"English",icon:"ðŸ‡ºðŸ‡¸"},{lang:"sv-SE",label:"Svenska",icon:"ðŸ‡¸ðŸ‡ª"},{lang:"ar-AE",label:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",icon:"ðŸ‡¦ðŸ‡ª"},{lang:"de-DE",label:"Deutsch",icon:"ðŸ‡©ðŸ‡ª"},{lang:"es-ES",label:"EspaÃ±ol",icon:"ðŸ‡ªðŸ‡¸"},{lang:"fr-FR",label:"FranÃ§ais",icon:"ðŸ‡«ðŸ‡·"},{lang:"zh-CN",label:"ä¸­æ–‡",icon:"ðŸ‡¨ðŸ‡³"}],ve=({transformLangConfig:t=r=>r})=>{const{i18n:r}=C.useTranslation(),{styles:n}=Se(),i=o=>{r.changeLanguage(o)},a={selectedKeys:[r.language],onClick:o=>{i(o.key)},items:t(ee).map(o=>({key:o.lang,className:n.menuItemStyle,label:e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx("span",{role:"img","aria-label":(o==null?void 0:o.label)||"en-US",className:n.menuItemIconStyle,children:(o==null?void 0:o.icon)||"ðŸŒ"}),(o==null?void 0:o.label)||"en-US"]})}))};return e.jsxRuntimeExports.jsx(G,{menu:a,children:e.jsxRuntimeExports.jsx(ye,{})})},be=N.createStyles(({css:t})=>({avatarItem:t`
    :hover {
      background: rgba(0, 0, 0, 0.12);
    }
    padding: 5px;
  `})),te=t=>he.isString(t)&&t.match(/^[-_a-zA-Z0-9]+$/)?M.baseURL.endsWith("/")?M.baseURL+`files/${t}`:M.baseURL+`/files/${t}`:t,se=({src:t,...r})=>e.jsxRuntimeExports.jsx(s.Avatar,{src:te(t),...r}),we=({onChange:t,shape:r="square"})=>{const[n,i]=c.useState([]),{styles:a}=be(),[o,p]=c.useState(!1),[l,d]=c.useState(!0),[m,E]=c.useState(0),{run:j,loading:g}=L.useRequest(()=>v.api.base.listFiles({current:m+1,page_size:40,file_type:"avatar",access:"public",search:""}),{manual:!0,onSuccess:({data:x})=>{i([...n,...x]),d(x.length===40),E(m+1)}}),w=()=>{d(!0),E(0),i([])};return e.jsxRuntimeExports.jsx(s.Popover,{style:{zIndex:1e3},onOpenChange:x=>{p(x),x?j():w()},open:o,content:e.jsxRuntimeExports.jsx("div",{style:{width:360,height:200},children:e.jsxRuntimeExports.jsx("div",{id:"iconsScrollableDiv",style:{height:"100%",overflow:"auto"},children:e.jsxRuntimeExports.jsx(e.InfiniteScroll,{dataLength:n.length,next:()=>{j()},hasMore:l,loader:e.jsxRuntimeExports.jsx(s.Skeleton,{avatar:!0,paragraph:{rows:1},active:!0}),endMessage:e.jsxRuntimeExports.jsx(s.Divider,{plain:!0,children:"End"}),scrollableTarget:"iconsScrollableDiv",children:e.jsxRuntimeExports.jsx(s.List,{grid:{gutter:16,column:8},dataSource:n,style:{margin:"0 8px"},loading:g,renderItem:({id:x})=>e.jsxRuntimeExports.jsx("div",{className:a.avatarItem,onClick:S=>{S.stopPropagation(),t==null||t(x),p(!1),w()},children:e.jsxRuntimeExports.jsx(se,{shape:r,src:x})})})})})}),placement:"bottom",trigger:"hover",children:e.jsxRuntimeExports.jsx(y.UploadOutlined,{shape:r,style:{width:112,height:112,placeContent:"center"}})})},ne=({value:t,onChange:r,shape:n,...i})=>{const[a,o]=c.useState(void 0),[p,l]=c.useState(!1),[d,m]=c.useState(void 0),E=async j=>{l(!0),m(j.url??j.preview)};return c.useEffect(()=>{o(t?{uid:t,name:t,url:te(t)}:void 0)},[t]),e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(je,{beforeCrop:async j=>{if(j.type==="image/svg+xml"){const g=await v.api.base.uploadFile({type:"avatar"},j);return g.length>0&&(r==null||r(g[0].id)),!1}return!0},children:e.jsxRuntimeExports.jsx(s.Upload,{customRequest:async j=>{var w,x;const g=await v.api.base.uploadFile({type:"avatar",access:"public"},j.file);g.length>0?((w=j.onSuccess)==null||w.call(j,g[0].id),r==null||r(g[0].id)):(x=j.onError)==null||x.call(j,new Error("Upload file failed"))},listType:"picture-card",onPreview:E,maxCount:1,onChange:({file:j})=>{switch(j.status){case"removed":r==null||r(void 0);break;case"done":break;default:o(j);break}},fileList:a?[a]:[],...i,children:a?void 0:e.jsxRuntimeExports.jsx(we,{shape:n,onChange:r})})}),e.jsxRuntimeExports.jsx(s.Modal,{open:p,footer:null,onCancel:()=>l(!1),children:e.jsxRuntimeExports.jsx("img",{style:{width:"100%"},src:d})})]})},Ce=()=>{const{t}=C.useTranslation("common"),{user:r}=z.useAuth(),{currentOrgId:n,setCurrentOrgId:i}=z.useSite(),a=(r==null?void 0:r.organizations)||[],o=m=>{i(m),window.location.reload()};if(a.length===0)return null;const p=a.find(m=>m.id===n),l=p?p.name:t("organization.global",{defaultValue:"Global"}),d=[...a.map(m=>({key:m.id,label:e.jsxRuntimeExports.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxRuntimeExports.jsx("span",{children:m.name}),n===m.id&&e.jsxRuntimeExports.jsx(y.CheckOutlined,{})]}),onClick:()=>o(m.id)}))];return e.jsxRuntimeExports.jsxs(G,{menu:{items:d,selectedKeys:n?[n]:[""]},children:[e.jsxRuntimeExports.jsx(y.TeamOutlined,{style:{marginRight:4}}),e.jsxRuntimeExports.jsx("span",{style:{height:"1em",lineHeight:"1em",marginLeft:"5px"},children:l})]})},Ie=c.lazy(()=>Promise.resolve().then(()=>Ke)),Fe=()=>{const{t}=C.useTranslation("ai"),[r,n]=c.useState(!1),i=()=>{n(!0)},a=()=>{n(!1)};return console.log(r),e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(s.Tooltip,{title:t("chat.openAssistant",{defaultValue:"Open AI Assistant"}),placement:"left",children:e.jsxRuntimeExports.jsx(s.FloatButton,{icon:e.jsxRuntimeExports.jsx(y.RobotOutlined,{}),type:"primary",onClick:i,style:{right:24,bottom:24}})}),e.jsxRuntimeExports.jsx(s.Modal,{width:1200,open:r,onCancel:a,footer:null,children:v.withSuspense(Ie)})]})},re=({permission:t,permissions:r=[],checkAll:n=!1,fallback:i=null,children:a})=>{const{hasPermission:o,hasAnyPermission:p,hasAllPermissions:l,isAdmin:d,loading:m}=z.usePermission();return m?null:d?e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:a}):t?o(t)?e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:a}):e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:i}):r.length>0?(n?l(r):p(r))?e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:a}):e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:i}):e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:a})},ke=({fallback:t=null,children:r})=>{const{isAdmin:n,loading:i}=z.usePermission();return i?null:n?e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:r}):e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:t})},O=t=>{const[r,n]=c.useState(!1),{permission:i,icon:a,tooltip:o,onClick:p,confirm:l,label:d,...m}=t;if(i)return e.jsxRuntimeExports.jsx(re,{permission:i,children:O({icon:a,tooltip:o,onClick:p,confirm:l,label:d,...m})},t.key);if(l)return e.jsxRuntimeExports.jsx(s.Popconfirm,{title:l.title,onConfirm:l.onConfirm||p,okText:l.okText,cancelText:l.cancelText,children:O({icon:a,tooltip:o,label:d,...m})},t.key);if(o)return e.jsxRuntimeExports.jsx(s.Tooltip,{title:o,children:O({icon:a,onClick:p,label:d,...m})},t.key);const E=p?async()=>{console.log(new Date,"handleClick"),n(!0);try{await p()}finally{n(!1),console.log(new Date,"handleClick1")}}:void 0;return c.createElement(s.Button,{type:"text",size:"small",loading:r,icon:a,onClick:E,...m,key:t.key},d&&e.jsxRuntimeExports.jsx("span",{style:{position:"inherit",top:"-2px"},children:d}))},Te=({actions:t})=>t.filter(r=>!r.hidden).map(r=>O(r)),Ae=fe,ie=t=>Ae[t],Le=({iconName:t})=>{if(!t)return null;const r=ie(t);return r?e.jsxRuntimeExports.jsx(c.Suspense,{fallback:null,children:e.jsxRuntimeExports.jsx(r,{})}):null},_e=({onChange:t})=>{const[r,n]=c.useState(""),[i,a]=c.useState("");return e.jsxRuntimeExports.jsxs(s.Space.Compact,{children:[e.jsxRuntimeExports.jsx(s.Input,{style:{width:"calc(100% - 80px)"},value:r,onChange:o=>n(o.target.value)}),e.jsxRuntimeExports.jsx(s.Input,{style:{width:"40px"},readOnly:!0,value:"=",tabIndex:-1}),e.jsxRuntimeExports.jsx(s.Input,{style:{width:"calc(100% - 80px)"},value:i,onChange:o=>a(o.target.value)}),e.jsxRuntimeExports.jsx(s.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(y.PlusOutlined,{}),onClick:()=>{t(r,i)}})]})},Pe=({request:t,tableRef:r,...n},i)=>{const[a,o]=c.useState({current:1,pageSize:10}),[p,l]=c.useState(0),{data:d,loading:m,refresh:E}=L.useRequest(async()=>{const j=await t({current:a.current,page_size:a.pageSize});return l(j.total),j.data},{refreshDeps:[a]});return c.useImperativeHandle(i,()=>({reload:()=>{E()}})),e.jsxRuntimeExports.jsx(s.Table,{rowKey:"id",loading:m,dataSource:d??[],pagination:{...a,total:p,onChange:(j,g)=>{o({current:j,pageSize:g})}},...n,ref:r})},ze=({actionRef:t,...r})=>{const[n,i]=c.useState();return c.useEffect(()=>{i(c.forwardRef(Pe))},[]),n?e.jsxRuntimeExports.jsx(n,{...r,ref:t}):null},Be=({onSuccess:t,token:r})=>{const{t:n}=C.useTranslation("authorization"),{t:i}=C.useTranslation("common"),[a]=s.Form.useForm(),{run:o,loading:p}=L.useRequest(async l=>v.api.authorization.changePassword(l,r?{headers:{Authorization:`Bearer ${r}`}}:{}),{manual:!0,onSuccess:()=>{s.message.success(n("user.passwordChanged")),a.resetFields(),t==null||t()},onError:l=>{if(l instanceof M.ApiError){const d=l.code??"normal";s.message.error(n(`user.passwordChangeFailed.${d}`,{error:l.message,defaultValue:"Password change failed: {{error}}"}))}else s.message.error(n("user.passwordChangeFailed.normal",{error:l.message,defaultValue:"Password change failed: {{error}}"}));console.error("Failed to change password:",l)}});return e.jsxRuntimeExports.jsxs(s.Form,{form:a,layout:"vertical",onFinish:o,style:{maxWidth:500,margin:"0 auto"},children:[e.jsxRuntimeExports.jsx(s.Form.Item,{name:"old_password",label:n("user.oldPassword"),rules:[{required:!0,message:n("validation.oldPasswordRequired")}],children:e.jsxRuntimeExports.jsx(s.Input.Password,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"new_password",label:n("user.newPassword"),rules:[{required:!0,message:n("validation.newPasswordRequired")},{min:8,message:n("validation.passwordMinLength")}],children:e.jsxRuntimeExports.jsx(s.Input.Password,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"confirm_password",label:n("user.confirmPassword"),rules:[{required:!0,message:n("validation.confirmPasswordRequired")},({getFieldValue:l})=>({validator(d,m){return!m||l("new_password")===m?Promise.resolve():Promise.reject(new Error(n("validation.passwordMismatch")))}})],children:e.jsxRuntimeExports.jsx(s.Input.Password,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{children:e.jsxRuntimeExports.jsx(s.Button,{type:"primary",htmlType:"submit",loading:p,children:i("save")})})]})},De=({user:t,onSuccess:r})=>{const{t:n}=C.useTranslation("authorization"),{t:i}=C.useTranslation("common"),[a]=s.Form.useForm(),[o,p]=c.useState(!1);c.useEffect(()=>{t&&a.setFieldsValue({username:t.username,email:t.email,full_name:t.full_name,phone:t.phone||"",avatar:t.avatar})},[t,a]);const l=async d=>{try{p(!0),await v.api.authorization.updateCurrentUser(d),s.message.success(i("updateSuccess")),r()}catch(m){s.message.error(i("updateFailed")),console.error("Failed to update user information:",m)}finally{p(!1)}};return e.jsxRuntimeExports.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxRuntimeExports.jsxs("div",{style:{marginBottom:24,textAlign:"center"},children:[e.jsxRuntimeExports.jsx("h2",{children:(t==null?void 0:t.full_name)||(t==null?void 0:t.username)}),(t==null?void 0:t.roles)&&t.roles.length>0&&e.jsxRuntimeExports.jsxs("div",{children:[n("user.roles"),": ",t.roles.map(d=>d.name).join(", ")]})]}),e.jsxRuntimeExports.jsxs(s.Form,{form:a,layout:"vertical",onFinish:l,style:{width:"100%",maxWidth:500},children:[e.jsxRuntimeExports.jsx(s.Form.Item,{style:{marginBottom:24,textAlign:"center",justifyItems:"center"},name:"avatar",children:e.jsxRuntimeExports.jsx(ne,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"username",label:n("user.username"),children:e.jsxRuntimeExports.jsx(s.Input,{disabled:!0})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"email",label:n("user.email"),rules:[{required:!0,message:n("validation.emailRequired")},{type:"email",message:n("validation.emailInvalid")}],children:e.jsxRuntimeExports.jsx(s.Input,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"full_name",label:n("user.fullName"),rules:[{required:!0,message:n("validation.fullNameRequired")}],children:e.jsxRuntimeExports.jsx(s.Input,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"phone",label:n("user.phone"),children:e.jsxRuntimeExports.jsx(s.Input,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{children:e.jsxRuntimeExports.jsx(s.Button,{type:"primary",htmlType:"submit",loading:o,children:i("save")})})]})]})},qe=({user:t,onSuccess:r})=>{const{t:n}=C.useTranslation("authorization"),{t:i}=C.useTranslation("common"),[a,o]=c.useState(0),[p,l]=c.useState(!1),[d,m]=c.useState(!0),[E,j]=c.useState(""),[g,w]=c.useState("totp"),{run:x,data:S={secret:"",qr_code:"",token:void 0}}=L.useRequest(()=>v.api.authorization.enableMfa(g),{manual:!0,onSuccess:()=>{o(1)},onBefore:()=>{l(!0)},onFinally:()=>{l(!1)}}),B=async()=>{if(!E){s.message.warning(n("mfa.enterVerificationCode"));return}const I={code:E,mfa_type:g};"token"in S&&(I.token=S.token);try{l(!0),await v.api.authorization.verifyAndActivateMfa(I),s.message.success(n("mfa.enableSuccess")),o(2),r()}catch(k){s.message.error(n("mfa.verificationFailed")),console.error("Failed to verify MFA:",k)}finally{l(!1)}},f=async()=>{try{l(!0),await v.api.authorization.disableMfa(),s.message.success(n("mfa.disableSuccess")),r()}catch(I){s.message.error(i("operationFailed")),console.error("Failed to disable MFA:",I)}finally{l(!1)}},F=()=>{if(!t)return null;if(t.mfa_enabled)return e.jsxRuntimeExports.jsx(s.Result,{status:"success",title:n("mfa.enabled"),subTitle:n("mfa.enabledDescription"),extra:e.jsxRuntimeExports.jsx(s.Button,{danger:!0,onClick:()=>{s.Modal.confirm({title:n("mfa.confirmDisable"),content:n("mfa.disableWarning"),onOk:f,okButtonProps:{danger:!0}})},children:n("mfa.disable")})});const I=()=>{var k;switch(a){case 0:return e.jsxRuntimeExports.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsxRuntimeExports.jsx(s.Alert,{message:e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx("p",{children:n("mfa.setupInfo")}),e.jsxRuntimeExports.jsx("p",{children:n(g==="totp"?"mfa.totpDescription":"mfa.emailDescription")})]}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxRuntimeExports.jsx(s.Button,{type:"primary",onClick:x,loading:p,children:n("mfa.startSetup")})]});case 1:return e.jsxRuntimeExports.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsxRuntimeExports.jsx(s.Alert,{message:n("mfa.scanQrCode"),type:"info",showIcon:!0,style:{marginBottom:20,display:g==="totp"?"block":"none"}}),e.jsxRuntimeExports.jsx("div",{style:{display:g==="totp"?"flex":"none",justifyContent:"center",marginBottom:24},children:e.jsxRuntimeExports.jsx(s.QRCode,{value:S.qr_code??"",size:200})}),e.jsxRuntimeExports.jsx("div",{style:{marginBottom:16,display:g==="email"?"block":"none"},children:e.jsxRuntimeExports.jsxs("p",{children:[n("user.email"),": ",e.jsxRuntimeExports.jsx("strong",{children:t==null?void 0:t.email})]})}),e.jsxRuntimeExports.jsx("div",{style:{marginBottom:16,display:g==="totp"?"block":"none"},children:e.jsxRuntimeExports.jsxs("p",{children:[n("mfa.secretKey"),": ",e.jsxRuntimeExports.jsx("strong",{children:d?"*".repeat(((k=S.secret)==null?void 0:k.length)??0):S.secret}),e.jsxRuntimeExports.jsx(s.Button,{type:"link",onClick:()=>m(!d),icon:d?e.jsxRuntimeExports.jsx(y.EyeOutlined,{}):e.jsxRuntimeExports.jsx(y.EyeInvisibleOutlined,{})})]})}),e.jsxRuntimeExports.jsx("div",{style:{marginBottom:24},children:e.jsxRuntimeExports.jsx(s.Input,{placeholder:n("mfa.enterCode"),style:{width:200},maxLength:6,value:E,onChange:T=>j(T.target.value)})}),e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(s.Button,{onClick:()=>o(0),children:i("previous")}),e.jsxRuntimeExports.jsx(s.Button,{type:"primary",onClick:B,loading:p,children:i("verify")})]})]});case 2:return e.jsxRuntimeExports.jsx(s.Result,{status:"success",title:n("mfa.setupSuccess"),subTitle:n("mfa.setupSuccessDescription"),extra:e.jsxRuntimeExports.jsx(s.Button,{type:"primary",onClick:()=>o(0),children:i("done")})});default:return null}};return e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsxs("div",{style:{display:a===2?"none":"unset"},children:[e.jsxRuntimeExports.jsx(s.Segmented,{defaultValue:"totp",onChange:k=>{w(k),o(0)},value:g,options:[{value:"totp",icon:e.jsxRuntimeExports.jsx(y.ClockCircleFilled,{}),label:n("mfa.totp",{defaultValue:"TOTP"})},{value:"email",icon:e.jsxRuntimeExports.jsx(y.MailOutlined,{}),label:n("mfa.email",{defaultValue:"E-Mail"})}]}),e.jsxRuntimeExports.jsx(s.Divider,{})]}),e.jsxRuntimeExports.jsx(s.Steps,{current:a,items:[{title:n(g==="totp"?"mfa.totpStep1":"mfa.emailStep1"),description:n(g==="totp"?"mfa.totpStep1Description":"mfa.emailStep1Description")},{title:n(g==="totp"?"mfa.totpStep2":"mfa.emailStep2"),description:n(g==="totp"?"mfa.totpStep2Description":"mfa.emailStep2Description")},{title:n(g==="totp"?"mfa.totpStep3":"mfa.emailStep3"),description:n(g==="totp"?"mfa.totpStep3Description":"mfa.emailStep3Description")}],style:{marginBottom:30}}),I()]})};return e.jsxRuntimeExports.jsx(s.Card,{title:n("mfa.title"),children:F()})},{Text:H}=s.Typography,Me=()=>{const{t}=C.useTranslation("authorization"),{t:r}=C.useTranslation("common"),[n,i]=c.useState([]),[a,o]=c.useState(!1),[p,l]=c.useState(null),[d,m]=c.useState(!1),E=async()=>{try{o(!0);const x=await v.api.authorization.getUserSessions({});i(x)}catch(x){s.message.error(t("session.getSessionsFailed",{error:x,defaultValue:"Failed to get session list: {{error}}"}))}finally{o(!1)}};c.useEffect(()=>{E()},[]);const j=async x=>{try{l(x),await v.api.authorization.terminateSession({id:x}),i(n.filter(S=>S.id!==x)),s.message.success(t("session.terminateSuccess",{defaultValue:"Session terminated successfully"}))}catch(S){s.message.error(t("session.terminateFailed",{error:S,defaultValue:"Failed to terminate session: {{error}}"}))}finally{l(null)}},g=async()=>{try{m(!0),await v.api.authorization.terminateOtherSessions(),i(n.filter(x=>x.is_current)),s.message.success(t("session.terminateAllSuccess",{defaultValue:"All other sessions terminated successfully"}))}catch(x){s.message.error(t("session.terminateAllFailed",{error:x,defaultValue:"Failed to terminate all other sessions: {{error}}"}))}finally{m(!1)}},w=[{title:t("session.device"),dataIndex:"user_agent",key:"device",render:(x,S)=>e.jsxRuntimeExports.jsxs(s.Space,{direction:"vertical",size:0,children:[e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(y.LaptopOutlined,{}),e.jsxRuntimeExports.jsx(H,{strong:!0,children:x})]}),e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(y.EnvironmentOutlined,{}),e.jsxRuntimeExports.jsx(H,{type:"secondary",children:S.location})]})]})},{title:t("session.ipAddress"),dataIndex:"ip_address",key:"ip_address",render:x=>e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(y.GlobalOutlined,{}),e.jsxRuntimeExports.jsx("span",{children:x})]})},{title:t("session.lastActive"),dataIndex:"last_active_at",key:"last_active",render:x=>e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(y.ClockCircleOutlined,{}),e.jsxRuntimeExports.jsx("span",{children:new Date(x).toLocaleString()})]})},{title:t("session.status"),key:"status",render:x=>x.is_current?e.jsxRuntimeExports.jsx(s.Tag,{color:"green",children:t("session.current")}):e.jsxRuntimeExports.jsx(s.Tag,{color:"blue",children:t("session.active")})},{title:r("actions"),key:"action",render:x=>x.is_current?e.jsxRuntimeExports.jsx(H,{type:"secondary",children:t("session.currentSession")}):e.jsxRuntimeExports.jsx(s.Popconfirm,{title:t("session.confirmTerminate"),onConfirm:()=>j(x.id),okText:r("confirm"),cancelText:r("cancel"),children:e.jsxRuntimeExports.jsx(s.Button,{type:"link",danger:!0,loading:p===x.id,children:t("session.terminate")})})}];return e.jsxRuntimeExports.jsx(s.Card,{title:t("session.title"),extra:n.length>1&&e.jsxRuntimeExports.jsx(s.Popconfirm,{title:t("session.confirmTerminateAll"),onConfirm:g,okText:r("confirm"),cancelText:r("cancel"),children:e.jsxRuntimeExports.jsx(s.Button,{danger:!0,loading:d,children:t("session.terminateOthers")})}),children:n.length===0?e.jsxRuntimeExports.jsx(s.Empty,{description:t("session.noSessions")}):e.jsxRuntimeExports.jsx(s.Table,{columns:w,dataSource:n,rowKey:"id",loading:a,pagination:!1})})},{RangePicker:Oe}=s.DatePicker,{Option:P}=s.Select,Ne=t=>t||"N/A",Ve=(t,r)=>t==="success"?e.jsxRuntimeExports.jsx(s.Tag,{color:"success",children:r("statuses.success")}):e.jsxRuntimeExports.jsx(s.Tag,{color:"error",children:r("statuses.failed")}),$e=({userId:t,request:r=i=>t?v.api.authorization.getUserLogs({id:t,...i}):v.api.authorization.getCurrentUserLogs(i),columnsFilter:n=i=>i})=>{const{t:i}=C.useTranslation("authorization"),{t:a}=C.useTranslation("common"),[o,p]=c.useState({current:1,pageSize:10,total:0}),[l,d]=c.useState({}),[m]=s.Form.useForm(),{loading:E,run:j,data:{data:g}={}}=L.useRequest(async(f=l,F=1,I=10)=>r({...f,current:F??1,page_size:I??10}),{onError(f){s.message.error(i("auditLog.fetchFailed",{error:f}))},onSuccess({total:f}){p({...o,total:f})}});c.useEffect(()=>{j(l,1,o.pageSize)},[]);const w=f=>{p({...o,current:f.current,pageSize:f.pageSize}),j({},f.current,f.pageSize)},x=f=>{var F,I,k,T;j({...f,start_time:(I=(F=f.dateRange)==null?void 0:F[0])==null?void 0:I.toISOString(),end_time:(T=(k=f.dateRange)==null?void 0:k[1])==null?void 0:T.toISOString()},1,o.pageSize)},S=()=>{m.resetFields(),d({}),p({...o,current:1}),j({},1,o.pageSize)},B=[{title:i("auditLog.timestamp"),dataIndex:"timestamp",key:"timestamp",render:f=>Q.formatDate(f)},{title:i("auditLog.action"),dataIndex:"action",key:"action",render:(f,F)=>f?i(`action.${f.replace(":",".")}`,{defaultValue:F.action_name}):F.action_name??F.action},{title:i("auditLog.user_agent"),dataIndex:"user_agent",key:"user_agent"},{title:i("auditLog.ip"),dataIndex:"ip",key:"ip",render:f=>Ne(f)},{title:i("auditLog.status"),dataIndex:"status",key:"status",render:f=>Ve(f,i)},{title:i("auditLog.details"),dataIndex:"details",key:"details",render:f=>e.jsxRuntimeExports.jsx(s.Button,{type:"link",icon:e.jsxRuntimeExports.jsx(y.EyeOutlined,{}),onClick:()=>{s.Modal.info({title:i("auditLog.details"),content:JSON.stringify(f)})}})}];return e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx(s.Card,{style:{marginBottom:16},children:e.jsxRuntimeExports.jsxs(s.Form,{form:m,layout:"horizontal",onFinish:x,initialValues:l,children:[e.jsxRuntimeExports.jsxs(s.Row,{gutter:24,children:[e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsx(s.Form.Item,{name:"search",label:i("auditLog.search"),children:e.jsxRuntimeExports.jsx(s.Input,{placeholder:i("auditLog.searchPlaceholder")})})}),e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsx(s.Form.Item,{name:"action",label:i("auditLog.action"),children:e.jsxRuntimeExports.jsxs(s.Select,{allowClear:!0,placeholder:i("auditLog.selectAction"),children:[e.jsxRuntimeExports.jsx(P,{value:"login",children:i("actions.login")}),e.jsxRuntimeExports.jsx(P,{value:"logout",children:i("actions.logout")}),e.jsxRuntimeExports.jsx(P,{value:"password_reset",children:i("actions.passwordReset")}),e.jsxRuntimeExports.jsx(P,{value:"mfa_change",children:i("actions.mfaChange")})]})})}),e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsx(s.Form.Item,{name:"status",label:i("auditLog.status"),children:e.jsxRuntimeExports.jsxs(s.Select,{allowClear:!0,placeholder:i("auditLog.selectStatus"),children:[e.jsxRuntimeExports.jsx(P,{value:"success",children:i("statuses.success")}),e.jsxRuntimeExports.jsx(P,{value:"failed",children:i("statuses.failed")})]})})}),e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsx(s.Form.Item,{name:"dateRange",label:i("auditLog.dateRange"),children:e.jsxRuntimeExports.jsx(Oe,{style:{width:"100%"}})})})]}),e.jsxRuntimeExports.jsx(s.Row,{children:e.jsxRuntimeExports.jsx(s.Col,{span:24,style:{textAlign:"right"},children:e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(s.Button,{onClick:S,children:a("reset")}),e.jsxRuntimeExports.jsx(s.Button,{type:"primary",htmlType:"submit",icon:e.jsxRuntimeExports.jsx(y.SearchOutlined,{}),children:a("search")})]})})})]})}),e.jsxRuntimeExports.jsxs(s.Card,{children:[e.jsxRuntimeExports.jsx("div",{style:{marginBottom:16},children:e.jsxRuntimeExports.jsx(s.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(y.ReloadOutlined,{}),onClick:S,style:{marginRight:8},children:a("refresh")})}),e.jsxRuntimeExports.jsx(s.Table,{rowKey:"id",columns:n(B),dataSource:g,pagination:{...o,showSizeChanger:!0,showTotal:f=>a("totalItems",{total:f})},loading:E,onChange:w,scroll:{x:"max-content"}})]})]})},J=e.MarkdownIt({html:!0,breaks:!0}),Ue=N.createStyles(({token:t,css:r})=>({layout:r`
      width: 100%;
      min-width: 500px;
      height: 70vh;
      display: flex;
      background: ${t.colorBgContainer};
      font-family: AlibabaPuHuiTi, ${t.fontFamily}, sans-serif;
    `,sider:r`
      background: ${t.colorBgLayout}80;
      width: 280px;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 0 12px;
      box-sizing: border-box;
    `,logo:r`
      display: flex;
      align-items: center;
      justify-content: start;
      padding: 0 24px;
      box-sizing: border-box;
      gap: 8px;
      margin: 24px 0;

      span {
        font-weight: bold;
        color: ${t.colorText};
        font-size: 16px;
      }
    `,addBtn:r`
      background: #1677ff0f;
      border: 1px solid #1677ff34;
      height: 40px;
    `,conversationsSpin:r`
      height: 100%;
      overflow-y: auto;
    `,conversations:r`
      flex: 1;
      overflow-y: auto;
      margin-top: 12px;
      padding: 0;

      .ant-conversations-list {
        padding-inline-start: 0;
      }
    `,siderFooter:r`
      border-top: 1px solid ${t.colorBorderSecondary};
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    `,chat:r`
      height: 100%;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      padding-block: ${t.paddingLG}px;
      gap: 16px;
    `,chatPrompt:r`
      .ant-prompts-label {
        color: #000000e0 !important;
      }
      .ant-prompts-desc {
        color: #000000a6 !important;
        width: 100%;
      }
      .ant-prompts-icon {
        color: #000000a6 !important;
      }
    `,chatList:r`
      flex: 1;
      overflow: auto;
    `,loadingMessage:r`
      background-image: linear-gradient(90deg, #ff6b23 0%, #af3cb8 31%, #53b6ff 89%);
      background-size: 100% 2px;
      background-repeat: no-repeat;
      background-position: bottom;
    `,placeholder:r`
      padding-top: 32px;
    `,sender:r`
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
    `,speechButton:r`
      font-size: 18px;
      color: ${t.colorText} !important;
    `,senderPrompt:r`
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      color: ${t.colorText};
    `}));class K extends Error{constructor(n,i){super(n);X(this,"buffer");this.buffer=i}}const He=()=>{const{t}=C.useTranslation("ai"),{t:r}=C.useTranslation("common"),{styles:n}=Ue(),i=c.useRef(null),[a,o]=c.useState({}),[p,l]=c.useState([]),[d,m]=c.useState(),[E,j]=c.useState(""),[g]=e.useXAgent({request:async({message:u,sessionId:h},{onSuccess:R,onUpdate:b,onError:D,onStream:q})=>{if(!h)return;const V=new AbortController,_={buffer:[],messageID:""};try{q==null||q(V);const $=await v.api.ai.streamChat({sessionId:h},{content:u.content},{signal:V.signal,requestType:"sse"});for await(const xe of e.XStream({readableStream:$})){const A=JSON.parse(xe.data);if(A.event_type,A.event_type==="error"){D(new K(A.content,_.buffer));return}A.event_type==="content"&&(_.messageID===""&&(_.messageID=A.message_id),_.messageID!==A.message_id&&(_.messageID=A.message_id),_.buffer.push(A.content),b(A.content))}R(_.buffer)}catch($){D(new K(`${$}`,_.buffer)),V.abort()}}}),w=g.isRequesting(),{loading:x}=L.useRequest(async()=>{const u=await v.api.ai.listChatSessions({current:1,page_size:20});l(u.data)}),{run:S,loading:B}=L.useRequest(async u=>await v.api.ai.createChatSession({title:t("chat.defaultConversationTitle"),model_id:""}),{manual:!0,onSuccess:(u,[h])=>{l(R=>[{...u,loading:!1},...R]),m(u.id),W([]),h&&k({stream:!0,message:{role:"user",content:h},sessionId:u.id})}}),{run:f}=L.useRequest(async u=>await v.api.ai.deleteChatSession({sessionId:u}),{manual:!0,onError(u,h){s.message.error(t("chat.deleteConversationFailed")),l(R=>R.map(b=>b.id===h[0]?{...b,loading:!1}:b))},onSuccess(u,h){var D;const R=p.filter(q=>q.id!==h[0]),b=(D=R==null?void 0:R[0])==null?void 0:D.id;l(R),h[0]===d&&m(b)}}),{run:F,loading:I}=L.useRequest(async u=>await v.api.ai.getChatSession({sessionId:u}),{manual:!0,onSuccess:(u,[h])=>{o(R=>({...R,[h]:u.messages.filter(b=>b.role!=="tool").map(b=>({id:b.id,message:{content:b.content,role:b.role},status:"loading"}))}))}}),{onRequest:k,messages:T,setMessages:W}=e.useXChat({agent:g,requestPlaceholder:()=>({content:r("loading"),role:"assistant"}),requestFallback:(u,{error:h})=>(console.log(h),h instanceof K?{content:h.buffer.join(""),role:"assistant",error:h.message}:{content:`${h}`,role:"assistant"}),resolveAbortController:u=>{i.current=u},transformMessage:u=>{const{originMessage:h,chunk:R}=u||{};return R?{role:"assistant",content:((h==null?void 0:h.content)||"")+R}:{role:"assistant",content:(h==null?void 0:h.content)||""}}});c.useEffect(()=>{if(!d)return;const u=a[d];u?W(u):F(d)},[a,d]);const oe=u=>{if(u){if(w){s.message.error(t("chat.requestInProgress"));return}if(!d){S(u);return}k({stream:!0,message:{role:"user",content:u},sessionId:d})}},ae=e.jsxRuntimeExports.jsxs("div",{className:n.sider,children:[e.jsxRuntimeExports.jsx(s.Button,{onClick:()=>{S()},type:"link",className:n.addBtn,icon:e.jsxRuntimeExports.jsx(y.PlusOutlined,{}),loading:B,children:t("chat.newConversation")}),e.jsxRuntimeExports.jsx(s.Spin,{spinning:x,wrapperClassName:n.conversationsSpin,children:e.jsxRuntimeExports.jsx(e.Conversations,{items:p.map(u=>({key:u.id,label:u.title,group:U(u.start_time).isSame(U(),"day")?t("chat.today"):U(u.start_time).format("YYYY-MM-DD")})),activeKey:d,onActiveChange:async u=>{var h;u&&((h=i.current)==null||h.abort(),m(R=>(R&&o(b=>({...b,[R]:T})),u)))},className:n.conversations,groupable:!0,styles:{item:{padding:"0 8px"}},menu:u=>({items:[{label:t("chat.renameConversation"),key:"rename",icon:e.jsxRuntimeExports.jsx(y.EditOutlined,{})},{label:r("delete"),key:"delete",icon:e.jsxRuntimeExports.jsx(y.DeleteOutlined,{}),danger:!0,onClick:()=>{l(h=>h.map(R=>R.id===u.key?{...R,loading:!0}:R)),f(u.key)}}]})})})]}),le=({message:u})=>{if(u.error)return e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsx("div",{dangerouslySetInnerHTML:{__html:J.render(u.error)}})})},ue=e.jsxRuntimeExports.jsx("div",{className:n.chatList,children:e.jsxRuntimeExports.jsx(s.Spin,{spinning:I,children:e.jsxRuntimeExports.jsx(e.ForwardBubble.List,{items:T==null?void 0:T.map(u=>({...u.message,messageRender:h=>e.jsxRuntimeExports.jsx("div",{dangerouslySetInnerHTML:{__html:J.render(h)}}),footer:le(u)})),style:{height:"100%",paddingInline:"calc(calc(100% - 700px) /2)"},roles:{assistant:{placement:"start",loadingRender:()=>e.jsxRuntimeExports.jsx(s.Spin,{size:"small"})},user:{placement:"end"}}})})}),ce=e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:e.jsxRuntimeExports.jsx(e.Sender,{value:E,onSubmit:()=>{oe(E.trim()),j("")},onChange:j,onCancel:()=>{var u;(u=i.current)==null||u.abort()},loading:w,className:n.sender,allowSpeech:!0,actions:(u,h)=>{const{SendButton:R,LoadingButton:b}=h.components;return e.jsxRuntimeExports.jsx(s.Flex,{gap:4,children:w?e.jsxRuntimeExports.jsx(b,{type:"default"}):e.jsxRuntimeExports.jsx(R,{type:"primary"})})},placeholder:t("chat.inputPlaceholder")})});return e.jsxRuntimeExports.jsxs("div",{className:n.layout,children:[ae,e.jsxRuntimeExports.jsxs("div",{className:n.chat,children:[ue,ce]})]})},Ke=Object.freeze(Object.defineProperty({__proto__:null,default:He},Symbol.toStringTag,{value:"Module"}));exports.AIChatButton=Fe;exports.Actions=Te;exports.AdminGuard=ke;exports.AllLangUIConfig=ee;exports.Avatar=se;exports.AvatarUpload=ne;exports.DynamicIcon=Le;exports.HeaderDropdown=G;exports.LabelCreater=_e;exports.LanguageSwitch=ve;exports.Loading=Z;exports.OrganizationSwitcher=Ce;exports.PermissionGuard=re;exports.PrivateRoute=Re;exports.ProfileBasic=De;exports.ProfileMFA=qe;exports.ProfilePassword=Be;exports.ProfileSessions=Me;exports.Table=ze;exports.UserAuditLogs=$e;exports.getIconByName=ie;
