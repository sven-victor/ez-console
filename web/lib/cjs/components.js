"use strict";const e=require("./vendor.js"),M=require("react-router-dom"),F=require("./contexts.js"),B=require("./base.js"),s=require("antd"),y=require("react-i18next"),q=require("antd-style"),E=require("@ant-design/icons"),T=require("classnames"),v=require("./index.js"),j=require("react"),C=require("ahooks"),X=require("@ant-design/x-markdown"),V=require("@ant-design/x"),A=require("./client.js"),Q=require("lodash-es");function Z(t){const i=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(t){for(const r in t)if(r!=="default"){const n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(i,r,n.get?n:{enumerable:!0,get:()=>t[r]})}}return i.default=t,Object.freeze(i)}const Y=Z(E),D=()=>e.jsxRuntimeExports.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",width:"100%"},children:e.jsxRuntimeExports.jsx(s.Spin,{size:"large"})}),ee=({element:t,requiredPermission:i,requiredPermissions:r})=>{const{t:n}=y.useTranslation(),{user:u,loading:c,error:a}=F.useAuth(),{hasPermission:m,hasAllPermissions:l}=F.usePermission();return c?e.jsxRuntimeExports.jsx(D,{}):a?a.code==="E4011"?e.jsxRuntimeExports.jsx(D,{}):e.jsxRuntimeExports.jsx(s.Result,{status:"500",title:"500",subTitle:n("login.fetchCurrentUserError",{defaultValue:"Failed to fetch current user: {{error}}",error:(a==null?void 0:a.message)||a})}):u?i&&!m(i)?e.jsxRuntimeExports.jsx(M.Navigate,{to:"/forbidden",replace:!0}):r&&!l(r)?e.jsxRuntimeExports.jsx(M.Navigate,{to:"/forbidden",replace:!0}):t:(window.location.href=B.getURL("/login?redirect="+encodeURIComponent(window.location.href)),null)},te=q.createStyles(({token:t,css:i})=>({container:i`
      ${i`
        @media screen and (max-width: ${t.screenXS}px) {
          width: 100% !important;
          > * {
            border-radius: 0 !important;
          }
        }
      `}
    > *{
      background-color: ${t.colorBgElevated};
      border-radius: 4px;
      box-shadow: ${t.boxShadowTertiary};
    }
    `,iconStyle:{cursor:"pointer",padding:"12px",display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:18,verticalAlign:"middle","&:hover":{color:t.colorPrimaryTextHover}}})),P=({overlayClassName:t,overlay:i,hidden:r,children:n,...u})=>{if(r)return e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{});const{styles:c}=te();return e.jsxRuntimeExports.jsx(s.Dropdown,{dropdownRender:i,overlayClassName:T(c.container,t),...u,children:e.jsxRuntimeExports.jsx("span",{className:c.iconStyle,children:n})})},se=()=>e.jsxRuntimeExports.jsxs("svg",{viewBox:"0 0 24 24",focusable:"false",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true",children:[e.jsxRuntimeExports.jsx("path",{d:"M0 0h24v24H0z",fill:"none"}),e.jsxRuntimeExports.jsx("path",{d:"M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z ",className:"css-c4d79v"})]}),ne=q.createStyles(()=>({menuItemStyle:{minWidth:"160px"},menuItemIconStyle:{marginRight:"8px"}})),U=[{lang:"en-US",label:"English",icon:"ðŸ‡ºðŸ‡¸"},{lang:"sv-SE",label:"Svenska",icon:"ðŸ‡¸ðŸ‡ª"},{lang:"ar-AE",label:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",icon:"ðŸ‡¦ðŸ‡ª"},{lang:"de-DE",label:"Deutsch",icon:"ðŸ‡©ðŸ‡ª"},{lang:"es-ES",label:"EspaÃ±ol",icon:"ðŸ‡ªðŸ‡¸"},{lang:"fr-FR",label:"FranÃ§ais",icon:"ðŸ‡«ðŸ‡·"},{lang:"zh-CN",label:"ä¸­æ–‡",icon:"ðŸ‡¨ðŸ‡³"}],re=({transformLangConfig:t=r=>r,className:i})=>{const{i18n:r}=y.useTranslation(),{styles:n}=ne(),u=a=>{r.changeLanguage(a)},c={selectedKeys:[r.language],onClick:a=>{u(a.key)},items:t(U).map(a=>({key:a.lang,className:n.menuItemStyle,label:e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx("span",{role:"img","aria-label":(a==null?void 0:a.label)||"en-US",className:n.menuItemIconStyle,children:(a==null?void 0:a.icon)||"ðŸŒ"}),(a==null?void 0:a.label)||"en-US"]})}))};return e.jsxRuntimeExports.jsx(P,{className:i,menu:c,children:e.jsxRuntimeExports.jsx(se,{})})},ie=q.createStyles(({css:t})=>({avatarItem:t`
    :hover {
      background: rgba(0, 0, 0, 0.12);
    }
    padding: 5px;
  `})),H=t=>Q.isString(t)&&t.match(/^[-_a-zA-Z0-9]+$/)?A.baseURL.endsWith("/")?A.baseURL+`files/${t}`:A.baseURL+`/files/${t}`:t,G=({src:t,fallback:i,...r})=>e.jsxRuntimeExports.jsx(s.Avatar,{src:H(t),icon:i,...r}),oe=({onChange:t,shape:i="square"})=>{const[r,n]=j.useState([]),{styles:u}=ie(),[c,a]=j.useState(!1),[m,l]=j.useState(!0),[p,d]=j.useState(0),{run:x,loading:o}=C.useRequest(()=>v.api.base.listFiles({current:p+1,page_size:40,file_type:"avatar",access:"public",search:""}),{manual:!0,onSuccess:({data:R})=>{n([...r,...R]),l(R.length===40),d(p+1)}}),f=()=>{l(!0),d(0),n([])};return e.jsxRuntimeExports.jsx(s.Popover,{style:{zIndex:1e3},onOpenChange:R=>{a(R),R?x():f()},open:c,content:e.jsxRuntimeExports.jsx("div",{style:{width:360,height:200},children:e.jsxRuntimeExports.jsx("div",{id:"iconsScrollableDiv",style:{height:"100%",overflow:"auto"},children:e.jsxRuntimeExports.jsx(e.InfiniteScroll,{dataLength:r.length,next:()=>{x()},hasMore:m,loader:e.jsxRuntimeExports.jsx(s.Skeleton,{avatar:!0,paragraph:{rows:1},active:!0}),endMessage:e.jsxRuntimeExports.jsx(s.Divider,{plain:!0,children:"End"}),scrollableTarget:"iconsScrollableDiv",children:e.jsxRuntimeExports.jsx(s.List,{grid:{gutter:16,column:8},dataSource:r,style:{margin:"0 8px"},loading:o,renderItem:({id:R})=>e.jsxRuntimeExports.jsx("div",{className:u.avatarItem,onClick:g=>{g.stopPropagation(),t==null||t(R),a(!1),f()},children:e.jsxRuntimeExports.jsx(G,{shape:i,src:R})})})})})}),placement:"bottom",trigger:"hover",children:e.jsxRuntimeExports.jsx(E.UploadOutlined,{shape:i,style:{width:112,height:112,placeContent:"center"}})})},W=({value:t,onChange:i,shape:r,...n})=>{const[u,c]=j.useState(void 0),[a,m]=j.useState(!1),[l,p]=j.useState(void 0),d=async x=>{m(!0),p(x.url??x.preview)};return j.useEffect(()=>{c(t?{uid:t,name:t,url:H(t)}:void 0)},[t]),e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(e.ImgCrop,{beforeCrop:async x=>{if(x.type==="image/svg+xml"){const o=await v.api.base.uploadFile({type:"avatar"},x);return o.length>0&&(i==null||i(o[0].id)),!1}return!0},children:e.jsxRuntimeExports.jsx(s.Upload,{customRequest:async x=>{var f,R;const o=await v.api.base.uploadFile({type:"avatar",access:"public"},x.file);o.length>0?((f=x.onSuccess)==null||f.call(x,o[0].id),i==null||i(o[0].id)):(R=x.onError)==null||R.call(x,new Error("Upload file failed"))},listType:"picture-card",onPreview:d,maxCount:1,onChange:({file:x})=>{switch(x.status){case"removed":i==null||i(void 0);break;case"done":break;default:c(x);break}},fileList:u?[u]:[],...n,children:u?void 0:e.jsxRuntimeExports.jsx(oe,{shape:r,onChange:i})})}),e.jsxRuntimeExports.jsx(s.Modal,{open:a,footer:null,onCancel:()=>m(!1),children:e.jsxRuntimeExports.jsx("img",{style:{width:"100%"},src:l})})]})},ae=({className:t})=>{const{t:i}=y.useTranslation("common"),{user:r}=F.useAuth(),{currentOrgId:n,setCurrentOrgId:u}=F.useSite(),c=(r==null?void 0:r.organizations)||[],a=d=>{u(d),window.location.reload()};if(c.length===0)return null;const m=c.find(d=>d.id===n),l=m?m.name:i("organization.global",{defaultValue:"Global"}),p=[...c.map(d=>({key:d.id,label:e.jsxRuntimeExports.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxRuntimeExports.jsx("span",{children:d.name}),n===d.id&&e.jsxRuntimeExports.jsx(E.CheckOutlined,{})]}),onClick:()=>a(d.id)}))];return e.jsxRuntimeExports.jsxs(P,{className:t,menu:{items:p,selectedKeys:n?[n]:[""]},children:[e.jsxRuntimeExports.jsx(E.TeamOutlined,{style:{marginRight:4}}),e.jsxRuntimeExports.jsx("span",{style:{height:"1em",lineHeight:"1em",marginLeft:"5px"},children:l})]})},le={pending:"default",running:"processing",success:"success",failed:"error",cancelled:"default"},ue=({className:t})=>{const{t:i}=y.useTranslation("task"),r=M.useNavigate(),{tasks:n,tasksDropdownOpen:u,setTasksDropdownOpen:c}=F.useSite(),a=async l=>{const p=await v.api.base.downloadFile({fileKey:l},{params:{method:"sign"}}),d=`/api/files/${l}?signature=${p.signature}&expires=${p.expires}`;window.open(d,"_blank")},m=()=>e.jsxRuntimeExports.jsxs("div",{style:{width:520,maxHeight:500,overflow:"auto",padding:8},children:[e.jsxRuntimeExports.jsx(s.List,{size:"small",dataSource:n,renderItem:l=>e.jsxRuntimeExports.jsx(s.List.Item,{extra:e.jsxRuntimeExports.jsx(s.Tag,{color:le[l.status],style:{marginLeft:6},children:i(`status.${l.status}`,{defaultValue:l.status})}),actions:[l.artifact_file_key&&e.jsxRuntimeExports.jsx(s.Button,{type:"text",size:"small",icon:e.jsxRuntimeExports.jsx(E.DownloadOutlined,{}),onClick:()=>a(l.artifact_file_key)})].filter(Boolean),children:e.jsxRuntimeExports.jsx(s.List.Item.Meta,{title:e.jsxRuntimeExports.jsx("span",{style:{fontSize:13},children:e.jsxRuntimeExports.jsxs(s.Typography.Text,{ellipsis:{tooltip:!0},children:[i(`type.${l.type}`,{defaultValue:l.type})," ",l.artifact_file_name&&`- ${l.artifact_file_name}`]})}),description:(l.status==="running"||l.status==="pending")&&e.jsxRuntimeExports.jsx(s.Progress,{percent:l.progress??0,size:"small",style:{marginTop:4}})})},l.id)}),e.jsxRuntimeExports.jsx("div",{style:{borderTop:"1px solid #f0f0f0",paddingTop:8,marginTop:8,textAlign:"center"},children:e.jsxRuntimeExports.jsx(s.Button,{type:"link",size:"small",onClick:()=>r("/tasks"),children:i("more",{defaultValue:"More"})})})]});return!n||n.length===0?null:e.jsxRuntimeExports.jsxs(P,{className:t,overlay:m,placement:"bottomRight",open:u,onOpenChange:c,children:[e.jsxRuntimeExports.jsx(E.UnorderedListOutlined,{style:{marginRight:4}}),e.jsxRuntimeExports.jsx("span",{style:{height:"1em",lineHeight:"1em",marginLeft:2},children:i("tasks",{defaultValue:"Tasks"})})]})},ce=({onResize:t,minWidth:i=300,maxWidth:r=window.innerWidth*.5})=>{const[n,u]=j.useState(!1),[c,a]=j.useState(!1),m=j.useCallback(d=>{d.preventDefault(),u(!0)},[]),l=j.useCallback(d=>{if(!n)return;const x=window.innerWidth-d.clientX,o=Math.max(i,Math.min(r,x));t(o)},[n,i,r,t]),p=j.useCallback(()=>{u(!1)},[]);return j.useEffect(()=>{if(n)return document.addEventListener("mousemove",l),document.addEventListener("mouseup",p),document.body.style.cursor="col-resize",document.body.style.userSelect="none",()=>{document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",p),document.body.style.cursor="",document.body.style.userSelect=""}},[n,l,p]),e.jsxRuntimeExports.jsx("div",{onMouseDown:m,onMouseEnter:()=>a(!0),onMouseLeave:()=>a(!1),style:{width:"8px",height:"100vh",cursor:"col-resize",position:"relative",flexShrink:0,transition:n?"none":"background-color 0.2s ease",backgroundColor:n?"#1890ff":c?"#bfbfbf":"#e8e8e8",zIndex:100,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxRuntimeExports.jsx("div",{style:{width:"3px",height:"40px",borderRadius:"2px",backgroundColor:n||c?"#fff":"#999",opacity:n||c?1:.5,transition:"opacity 0.2s ease",pointerEvents:"none"}})})},O=({permission:t,permissions:i=[],checkAll:r=!1,fallback:n=null,children:u})=>{const{hasPermission:c,hasAnyPermission:a,hasAllPermissions:m,isAdmin:l,loading:p}=F.usePermission();return p?null:l?e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:u}):t?c(t)?e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:u}):e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:n}):i.length>0?(r?m(i):a(i))?e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:u}):e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:n}):e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:u})},xe=({fallback:t=null,children:i})=>{const{isAdmin:r,loading:n}=F.usePermission();return n?null:r?e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:i}):e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:t})},N=t=>{const[i,r]=j.useState(!1),{permission:n,icon:u,tooltip:c,onClick:a,confirm:m,label:l,...p}=t,d=a?async()=>{r(!0);try{await a()}finally{r(!1)}}:void 0;let x=e.jsxRuntimeExports.jsx(s.Button,{type:"text",size:"small",loading:i,icon:u,onClick:m?void 0:d,...p,children:l&&e.jsxRuntimeExports.jsx("span",{style:{position:"inherit",top:"-2px"},children:l})});if(c&&(x=e.jsxRuntimeExports.jsx(s.Tooltip,{title:c,children:x})),m){const o=async()=>{m.onConfirm?m.onConfirm():d&&await d()};x=e.jsxRuntimeExports.jsx(s.Popconfirm,{title:m.title,description:m.description,onConfirm:o,okText:m.okText,cancelText:m.cancelText,children:x})}return n&&(x=e.jsxRuntimeExports.jsx(O,{permission:n,children:x})),x},me=({actions:t,maxVisibleItems:i})=>{const r=t.filter(a=>!a.hidden);if(!i||r.length<=i)return e.jsxRuntimeExports.jsx(e.jsxRuntimeExports.Fragment,{children:r.map(({key:a,...m})=>e.jsxRuntimeExports.jsx(N,{...m},a))});const n=r.slice(0,i-1),c=r.slice(i-1).map(a=>{const{key:m,label:l,icon:p,permission:d,onClick:x,confirm:o,disabled:f,tooltip:R}=a,S={key:m,label:l,icon:p,disabled:f,onClick:async()=>{o?s.Modal.confirm({title:o.title,content:o.description,onOk:o.onConfirm,okText:o.okText,cancelText:o.cancelText}):x&&await x()}};return d?{...S,label:e.jsxRuntimeExports.jsx(O,{permission:d,children:e.jsxRuntimeExports.jsx("span",{children:l??R})})}:S});return e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[n.map(({key:a,...m})=>e.jsxRuntimeExports.jsx(N,{...m},a)),e.jsxRuntimeExports.jsx(s.Dropdown,{menu:{items:c},trigger:["click"],children:e.jsxRuntimeExports.jsx(s.Button,{type:"text",size:"small",icon:e.jsxRuntimeExports.jsx(E.MoreOutlined,{})})})]})},de=Y,K=t=>de[t],pe=({iconName:t})=>{if(!t)return null;const i=K(t);return i?e.jsxRuntimeExports.jsx(j.Suspense,{fallback:null,children:e.jsxRuntimeExports.jsx(i,{})}):null},je=({onChange:t})=>{const[i,r]=j.useState(""),[n,u]=j.useState("");return e.jsxRuntimeExports.jsxs(s.Space.Compact,{children:[e.jsxRuntimeExports.jsx(s.Input,{style:{width:"calc(100% - 80px)"},value:i,onChange:c=>r(c.target.value)}),e.jsxRuntimeExports.jsx(s.Input,{style:{width:"40px"},readOnly:!0,value:"=",tabIndex:-1}),e.jsxRuntimeExports.jsx(s.Input,{style:{width:"calc(100% - 80px)"},value:n,onChange:c=>u(c.target.value)}),e.jsxRuntimeExports.jsx(s.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(E.PlusOutlined,{}),onClick:()=>{t(i,n)}})]})},he=({request:t,tableRef:i,...r},n)=>{const[u,c]=j.useState({current:1,pageSize:10}),[a,m]=j.useState(0),{data:l,loading:p,refresh:d}=C.useRequest(async()=>{const x=await t({current:u.current,page_size:u.pageSize});return m(x.total),x.data},{refreshDeps:[u]});return j.useImperativeHandle(n,()=>({reload:()=>{d()}})),e.jsxRuntimeExports.jsx(s.Table,{rowKey:"id",loading:p,dataSource:l??[],pagination:{...u,total:a,onChange:(x,o)=>{c({current:x,pageSize:o})}},...r,ref:i})},ge=({actionRef:t,...i})=>{const[r,n]=j.useState();return j.useEffect(()=>{n(j.forwardRef(he))},[]),r?e.jsxRuntimeExports.jsx(r,{...i,ref:t}):null},J=t=>{var u;const{className:i,children:r}=t,n=((u=i==null?void 0:i.match(/language-(\w+)/))==null?void 0:u[1])||"";return typeof r!="string"?null:n==="mermaid"?e.jsxRuntimeExports.jsx(V.Mermaid,{children:r}):e.jsxRuntimeExports.jsx(V.CodeHighlighter,{lang:n,children:r})},Re=({content:t,className:i,style:r,paragraphTag:n="div",rootClassName:u,components:c={code:J}})=>e.jsxRuntimeExports.jsx(X.XMarkdown,{content:t,className:i,style:r,components:c,paragraphTag:n,rootClassName:u}),fe=({className:t,onSuccess:i,token:r})=>{const{t:n}=y.useTranslation("authorization"),{t:u}=y.useTranslation("common"),[c]=s.Form.useForm(),{run:a,loading:m}=C.useRequest(async l=>v.api.authorization.changePassword(l,r?{headers:{Authorization:`Bearer ${r}`}}:{}),{manual:!0,onSuccess:()=>{s.message.success(n("user.passwordChanged")),c.resetFields(),i==null||i()},onError:l=>{if(l instanceof A.ApiError){const p=l.code??"normal";s.message.error(n(`user.passwordChangeFailed.${p}`,{error:l.message,defaultValue:"Password change failed: {{error}}"}))}else s.message.error(n("user.passwordChangeFailed.normal",{error:l.message,defaultValue:"Password change failed: {{error}}"}));console.error("Failed to change password:",l)}});return e.jsxRuntimeExports.jsxs(s.Form,{form:c,layout:"vertical",onFinish:a,style:{maxWidth:500,margin:"0 auto"},className:T("profile-password",t),children:[e.jsxRuntimeExports.jsx(s.Form.Item,{name:"old_password",label:n("user.oldPassword"),rules:[{required:!0,message:n("validation.oldPasswordRequired")}],className:T("profile-password-item","profile-password-item-old-password"),children:e.jsxRuntimeExports.jsx(s.Input.Password,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"new_password",label:n("user.newPassword"),rules:[{required:!0,message:n("validation.newPasswordRequired")},{min:8,message:n("validation.passwordMinLength")}],className:T("profile-password-item","profile-password-item-new-password"),children:e.jsxRuntimeExports.jsx(s.Input.Password,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"confirm_password",label:n("user.confirmPassword"),className:T("profile-password-item","profile-password-item-confirm-password"),rules:[{required:!0,message:n("validation.confirmPasswordRequired")},({getFieldValue:l})=>({validator(p,d){return!d||l("new_password")===d?Promise.resolve():Promise.reject(new Error(n("validation.passwordMismatch")))}})],children:e.jsxRuntimeExports.jsx(s.Input.Password,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{className:T("profile-password-item","profile-password-item-submit"),children:e.jsxRuntimeExports.jsx(s.Button,{type:"primary",htmlType:"submit",loading:m,children:u("save")})})]})},Ee=({user:t,onSuccess:i})=>{const{t:r}=y.useTranslation("authorization"),{t:n}=y.useTranslation("common"),[u]=s.Form.useForm(),[c,a]=j.useState(!1);j.useEffect(()=>{t&&u.setFieldsValue({username:t.username,email:t.email,full_name:t.full_name,phone:t.phone||"",avatar:t.avatar})},[t,u]);const m=async l=>{try{a(!0),await v.api.authorization.updateCurrentUser(l),s.message.success(n("updateSuccess")),i()}catch(p){s.message.error(n("updateFailed")),console.error("Failed to update user information:",p)}finally{a(!1)}};return e.jsxRuntimeExports.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxRuntimeExports.jsxs("div",{style:{marginBottom:24,textAlign:"center"},children:[e.jsxRuntimeExports.jsx("h2",{children:(t==null?void 0:t.full_name)||(t==null?void 0:t.username)}),(t==null?void 0:t.roles)&&t.roles.length>0&&e.jsxRuntimeExports.jsxs("div",{children:[r("user.roles"),": ",t.roles.map(l=>l.name).join(", ")]})]}),e.jsxRuntimeExports.jsxs(s.Form,{form:u,layout:"vertical",onFinish:m,style:{width:"100%",maxWidth:500},children:[e.jsxRuntimeExports.jsx(s.Form.Item,{style:{marginBottom:24,textAlign:"center",justifyItems:"center"},name:"avatar",children:e.jsxRuntimeExports.jsx(W,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"username",label:r("user.username"),children:e.jsxRuntimeExports.jsx(s.Input,{disabled:!0})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"email",label:r("user.email"),rules:[{required:!0,message:r("validation.emailRequired")},{type:"email",message:r("validation.emailInvalid")}],children:e.jsxRuntimeExports.jsx(s.Input,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"full_name",label:r("user.fullName"),rules:[{required:!0,message:r("validation.fullNameRequired")}],children:e.jsxRuntimeExports.jsx(s.Input,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"phone",label:r("user.phone"),children:e.jsxRuntimeExports.jsx(s.Input,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{children:e.jsxRuntimeExports.jsx(s.Button,{type:"primary",htmlType:"submit",loading:c,children:n("save")})})]})]})},ye=({user:t,onSuccess:i})=>{const{t:r}=y.useTranslation("authorization"),{t:n}=y.useTranslation("common"),[u,c]=j.useState(0),[a,m]=j.useState(!1),[l,p]=j.useState(!0),[d,x]=j.useState(""),[o,f]=j.useState("totp"),{run:R,data:g={secret:"",qr_code:"",token:void 0}}=C.useRequest(()=>v.api.authorization.enableMfa(o),{manual:!0,onSuccess:()=>{c(1)},onBefore:()=>{m(!0)},onFinally:()=>{m(!1)}}),S=async()=>{if(!d){s.message.warning(r("mfa.enterVerificationCode"));return}const w={code:d,mfa_type:o};"token"in g&&(w.token=g.token);try{m(!0),await v.api.authorization.verifyAndActivateMfa(w),s.message.success(r("mfa.enableSuccess")),c(2),i()}catch(I){s.message.error(r("mfa.verificationFailed")),console.error("Failed to verify MFA:",I)}finally{m(!1)}},h=async()=>{try{m(!0),await v.api.authorization.disableMfa(),s.message.success(r("mfa.disableSuccess")),i()}catch(w){s.message.error(n("operationFailed")),console.error("Failed to disable MFA:",w)}finally{m(!1)}},b=()=>{if(!t)return null;if(t.mfa_enabled)return e.jsxRuntimeExports.jsx(s.Result,{status:"success",title:r("mfa.enabled"),subTitle:r("mfa.enabledDescription"),extra:e.jsxRuntimeExports.jsx(s.Button,{danger:!0,onClick:()=>{s.Modal.confirm({title:r("mfa.confirmDisable"),content:r("mfa.disableWarning"),onOk:h,okButtonProps:{danger:!0}})},children:r("mfa.disable")})});const w=()=>{var I;switch(u){case 0:return e.jsxRuntimeExports.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsxRuntimeExports.jsx(s.Alert,{message:e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx("p",{children:r("mfa.setupInfo")}),e.jsxRuntimeExports.jsx("p",{children:r(o==="totp"?"mfa.totpDescription":"mfa.emailDescription")})]}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxRuntimeExports.jsx(s.Button,{type:"primary",onClick:R,loading:a,children:r("mfa.startSetup")})]});case 1:return e.jsxRuntimeExports.jsxs("div",{style:{textAlign:"center",marginTop:20},children:[e.jsxRuntimeExports.jsx(s.Alert,{message:r("mfa.scanQrCode"),type:"info",showIcon:!0,style:{marginBottom:20,display:o==="totp"?"block":"none"}}),e.jsxRuntimeExports.jsx("div",{style:{display:o==="totp"?"flex":"none",justifyContent:"center",marginBottom:24},children:e.jsxRuntimeExports.jsx(s.QRCode,{value:g.qr_code??"",size:200})}),e.jsxRuntimeExports.jsx("div",{style:{marginBottom:16,display:o==="email"?"block":"none"},children:e.jsxRuntimeExports.jsxs("p",{children:[r("user.email"),": ",e.jsxRuntimeExports.jsx("strong",{children:t==null?void 0:t.email})]})}),e.jsxRuntimeExports.jsx("div",{style:{marginBottom:16,display:o==="totp"?"block":"none"},children:e.jsxRuntimeExports.jsxs("p",{children:[r("mfa.secretKey"),": ",e.jsxRuntimeExports.jsx("strong",{children:l?"*".repeat(((I=g.secret)==null?void 0:I.length)??0):g.secret}),e.jsxRuntimeExports.jsx(s.Button,{type:"link",onClick:()=>p(!l),icon:l?e.jsxRuntimeExports.jsx(E.EyeOutlined,{}):e.jsxRuntimeExports.jsx(E.EyeInvisibleOutlined,{})})]})}),e.jsxRuntimeExports.jsx("div",{style:{marginBottom:24},children:e.jsxRuntimeExports.jsx(s.Input,{placeholder:r("mfa.enterCode"),style:{width:200},maxLength:6,value:d,onChange:L=>x(L.target.value)})}),e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(s.Button,{onClick:()=>c(0),children:n("previous")}),e.jsxRuntimeExports.jsx(s.Button,{type:"primary",onClick:S,loading:a,children:n("verify")})]})]});case 2:return e.jsxRuntimeExports.jsx(s.Result,{status:"success",title:r("mfa.setupSuccess"),subTitle:r("mfa.setupSuccessDescription"),extra:e.jsxRuntimeExports.jsx(s.Button,{type:"primary",onClick:()=>c(0),children:n("done")})});default:return null}};return e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsxs("div",{style:{display:u===2?"none":"unset"},children:[e.jsxRuntimeExports.jsx(s.Segmented,{defaultValue:"totp",onChange:I=>{f(I),c(0)},value:o,options:[{value:"totp",icon:e.jsxRuntimeExports.jsx(E.ClockCircleFilled,{}),label:r("mfa.totp",{defaultValue:"TOTP"})},{value:"email",icon:e.jsxRuntimeExports.jsx(E.MailOutlined,{}),label:r("mfa.email",{defaultValue:"E-Mail"})}]}),e.jsxRuntimeExports.jsx(s.Divider,{})]}),e.jsxRuntimeExports.jsx(s.Steps,{current:u,items:[{title:r(o==="totp"?"mfa.totpStep1":"mfa.emailStep1"),description:r(o==="totp"?"mfa.totpStep1Description":"mfa.emailStep1Description")},{title:r(o==="totp"?"mfa.totpStep2":"mfa.emailStep2"),description:r(o==="totp"?"mfa.totpStep2Description":"mfa.emailStep2Description")},{title:r(o==="totp"?"mfa.totpStep3":"mfa.emailStep3"),description:r(o==="totp"?"mfa.totpStep3Description":"mfa.emailStep3Description")}],style:{marginBottom:30}}),w()]})};return e.jsxRuntimeExports.jsx(s.Card,{title:r("mfa.title"),children:b()})},{Text:z}=s.Typography,ve=()=>{const{t}=y.useTranslation("authorization"),{t:i}=y.useTranslation("common"),[r,n]=j.useState(null),[u,c]=j.useState(!1),{data:a=[],loading:m,run:l}=C.useRequest(()=>v.api.authorization.getUserSessions({}),{onError:o=>{s.message.error(t("session.getSessionsFailed",{error:o,defaultValue:"Failed to get session list: {{error}}"}))}}),{run:p}=C.useRequest(o=>v.api.authorization.terminateSession({id:o}),{onSuccess:()=>{s.message.success(t("session.terminateSuccess",{defaultValue:"Session terminated successfully"})),l()},onError:o=>{s.message.error(t("session.terminateFailed",{error:o,defaultValue:"Failed to terminate session: {{error}}"}))},onFinally:()=>{n(null)},onBefore:([o])=>{n(o)},manual:!0}),{run:d}=C.useRequest(()=>v.api.authorization.terminateOtherSessions(),{onSuccess:()=>{s.message.success(t("session.terminateAllSuccess",{defaultValue:"All other sessions terminated successfully"})),l()},onError:o=>{s.message.error(t("session.terminateAllFailed",{error:o,defaultValue:"Failed to terminate all other sessions: {{error}}"}))},onFinally:()=>{c(!1)},onBefore:()=>{c(!0)},manual:!0}),x=[{title:t("session.device"),dataIndex:"user_agent",key:"device",render:(o,f)=>e.jsxRuntimeExports.jsxs(s.Space,{direction:"vertical",size:0,children:[e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(E.LaptopOutlined,{}),e.jsxRuntimeExports.jsx(z,{strong:!0,children:o})]}),e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(E.EnvironmentOutlined,{}),e.jsxRuntimeExports.jsx(z,{type:"secondary",children:f.location})]})]})},{title:t("session.ipAddress"),dataIndex:"ip_address",key:"ip_address",render:o=>e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(E.GlobalOutlined,{}),e.jsxRuntimeExports.jsx("span",{children:o})]})},{title:t("session.lastActive"),dataIndex:"last_active_at",key:"last_active",render:o=>e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(E.ClockCircleOutlined,{}),e.jsxRuntimeExports.jsx("span",{children:new Date(o).toLocaleString()})]})},{title:t("session.status"),key:"status",render:o=>o.is_current?e.jsxRuntimeExports.jsx(s.Tag,{color:"green",children:t("session.current")}):e.jsxRuntimeExports.jsx(s.Tag,{color:"blue",children:t("session.active")})},{title:i("actions"),key:"action",render:o=>o.is_current?e.jsxRuntimeExports.jsx(z,{type:"secondary",children:t("session.currentSession")}):e.jsxRuntimeExports.jsx(s.Popconfirm,{title:t("session.confirmTerminate"),onConfirm:()=>p(o.id),okText:i("confirm"),cancelText:i("cancel"),children:e.jsxRuntimeExports.jsx(s.Button,{type:"link",danger:!0,loading:r===o.id,children:t("session.terminate")})})}];return e.jsxRuntimeExports.jsx(s.Card,{title:t("session.title"),loading:m,extra:e.jsxRuntimeExports.jsxs(s.Space,{children:[a.length>1&&e.jsxRuntimeExports.jsx(s.Popconfirm,{title:t("session.confirmTerminateAll"),onConfirm:d,okText:i("confirm"),cancelText:i("cancel"),children:e.jsxRuntimeExports.jsx(s.Button,{danger:!0,loading:u,children:t("session.terminateOthers")})}),e.jsxRuntimeExports.jsx(s.Button,{onClick:()=>l(),loading:m,children:i("refresh")})]}),children:!m&&a.length===0?e.jsxRuntimeExports.jsx(s.Empty,{description:t("session.noSessions")}):e.jsxRuntimeExports.jsx(s.Table,{columns:x,dataSource:a,rowKey:"id",loading:m,pagination:!1})})},{RangePicker:Se}=s.DatePicker,{Option:k}=s.Select,we=t=>t||"N/A",be=(t,i)=>t==="success"?e.jsxRuntimeExports.jsx(s.Tag,{color:"success",children:i("statuses.success")}):e.jsxRuntimeExports.jsx(s.Tag,{color:"error",children:i("statuses.failed")}),Ie=({userId:t,request:i=n=>t?v.api.authorization.getUserLogs({id:t,...n}):v.api.authorization.getCurrentUserLogs(n),columnsFilter:r=n=>n})=>{const{t:n}=y.useTranslation("authorization"),{t:u}=y.useTranslation("common"),[c,a]=j.useState({current:1,pageSize:10,total:0}),[m,l]=j.useState({}),[p]=s.Form.useForm(),{loading:d,run:x,data:{data:o}={}}=C.useRequest(async(h=m,b=1,w=10)=>i({...h,current:b??1,page_size:w??10}),{onError(h){s.message.error(n("auditLog.fetchFailed",{error:h}))},onSuccess({total:h}){a({...c,total:h})}});j.useEffect(()=>{x(m,1,c.pageSize)},[]);const f=h=>{a({...c,current:h.current,pageSize:h.pageSize}),x({},h.current,h.pageSize)},R=h=>{var b,w,I,L;x({...h,start_time:(w=(b=h.dateRange)==null?void 0:b[0])==null?void 0:w.toISOString(),end_time:(L=(I=h.dateRange)==null?void 0:I[1])==null?void 0:L.toISOString()},1,c.pageSize)},g=()=>{p.resetFields(),l({}),a({...c,current:1}),x({},1,c.pageSize)},S=[{title:n("auditLog.timestamp"),dataIndex:"timestamp",key:"timestamp",render:h=>B.formatDate(h)},{title:n("auditLog.action"),dataIndex:"action",key:"action",render:(h,b)=>h?n(`action.${h.replace(":",".")}`,{defaultValue:b.action_name}):b.action_name??b.action},{title:n("auditLog.user_agent"),dataIndex:"user_agent",key:"user_agent"},{title:n("auditLog.ip"),dataIndex:"ip",key:"ip",render:h=>we(h)},{title:n("auditLog.status"),dataIndex:"status",key:"status",render:h=>be(h,n)},{title:n("auditLog.details"),dataIndex:"details",key:"details",render:h=>e.jsxRuntimeExports.jsx(s.Button,{type:"link",icon:e.jsxRuntimeExports.jsx(E.EyeOutlined,{}),onClick:()=>{s.Modal.info({title:n("auditLog.details"),content:JSON.stringify(h)})}})}];return e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx(s.Card,{style:{marginBottom:16},children:e.jsxRuntimeExports.jsxs(s.Form,{form:p,layout:"horizontal",onFinish:R,initialValues:m,children:[e.jsxRuntimeExports.jsxs(s.Row,{gutter:24,children:[e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsx(s.Form.Item,{name:"search",label:n("auditLog.search"),children:e.jsxRuntimeExports.jsx(s.Input,{placeholder:n("auditLog.searchPlaceholder")})})}),e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsx(s.Form.Item,{name:"action",label:n("auditLog.action"),children:e.jsxRuntimeExports.jsxs(s.Select,{allowClear:!0,placeholder:n("auditLog.selectAction"),children:[e.jsxRuntimeExports.jsx(k,{value:"login",children:n("actions.login")}),e.jsxRuntimeExports.jsx(k,{value:"logout",children:n("actions.logout")}),e.jsxRuntimeExports.jsx(k,{value:"password_reset",children:n("actions.passwordReset")}),e.jsxRuntimeExports.jsx(k,{value:"mfa_change",children:n("actions.mfaChange")})]})})}),e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsx(s.Form.Item,{name:"status",label:n("auditLog.status"),children:e.jsxRuntimeExports.jsxs(s.Select,{allowClear:!0,placeholder:n("auditLog.selectStatus"),children:[e.jsxRuntimeExports.jsx(k,{value:"success",children:n("statuses.success")}),e.jsxRuntimeExports.jsx(k,{value:"failed",children:n("statuses.failed")})]})})}),e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsx(s.Form.Item,{name:"dateRange",label:n("auditLog.dateRange"),children:e.jsxRuntimeExports.jsx(Se,{style:{width:"100%"}})})})]}),e.jsxRuntimeExports.jsx(s.Row,{children:e.jsxRuntimeExports.jsx(s.Col,{span:24,style:{textAlign:"right"},children:e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(s.Button,{onClick:g,children:u("reset")}),e.jsxRuntimeExports.jsx(s.Button,{type:"primary",htmlType:"submit",icon:e.jsxRuntimeExports.jsx(E.SearchOutlined,{}),children:u("search")})]})})})]})}),e.jsxRuntimeExports.jsxs(s.Card,{children:[e.jsxRuntimeExports.jsx("div",{style:{marginBottom:16},children:e.jsxRuntimeExports.jsx(s.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(E.ReloadOutlined,{}),onClick:g,style:{marginRight:8},children:u("refresh")})}),e.jsxRuntimeExports.jsx(s.Table,{rowKey:"id",columns:r(S),dataSource:o,pagination:{...c,showSizeChanger:!0,showTotal:h=>u("totalItems",{total:h})},loading:d,onChange:f,scroll:{x:"max-content"}})]})]})},{TextArea:$}=s.Input,{Option:_}=s.Select,Ce=({field:t,selectedType:i,dependentValues:r,formValues:n={}})=>{const{t:u}=y.useTranslation("system"),{t:c}=y.useTranslation("common"),a=j.useMemo(()=>B.checkVisibilityCondition(t.visible_when,n),[t.visible_when,n]),{options:m,loading:l}=F.useDynamicDataSource(t.data_source,t.options,r),p=j.useMemo(()=>t.data_source&&t.data_source.type!=="static"?m:t.options||[],[t.data_source,t.options,m]),d=p&&p.length>0;if(!a)return null;const x=[{required:t.required,message:u("settings.toolsets.fieldRequired",{defaultValue:`Please enter ${t.name}`,field:t.name})}],o=()=>u(`settings.toolsets.${i}.${t.name}`,{defaultValue:t.display_name||t.name}),f=()=>u(`settings.toolsets.${i}.${t.name}Placeholder`,{defaultValue:t.placeholder||`${c("enter",{defaultValue:"Enter"})} ${t.name}`}),R=()=>{if(t.description)return u(`settings.toolsets.${i}.${t.name}Tooltip`,{defaultValue:t.description})};if(!a)return null;if(t.type==="select"||t.data_source)return e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),rules:x,tooltip:R(),children:e.jsxRuntimeExports.jsx(s.Select,{loading:l,allowClear:!0,placeholder:f(),showSearch:!0,filterOption:(g,S)=>{var h;return(h=S==null?void 0:S.children)==null?void 0:h.toLowerCase().includes(g.toLowerCase())},children:p.map(g=>e.jsxRuntimeExports.jsx(_,{value:g.value,children:g.label},g.value))})},t.name);switch(t.type){case"text":return e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),rules:x,children:e.jsxRuntimeExports.jsx($,{placeholder:f(),rows:4})},t.name);case"string":return d?e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),rules:x,tooltip:R(),children:e.jsxRuntimeExports.jsx(s.Select,{allowClear:!0,placeholder:f(),children:p.map(g=>e.jsxRuntimeExports.jsx(_,{value:g.value,children:g.label},g.value))})},t.name):e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),rules:x,tooltip:R(),children:e.jsxRuntimeExports.jsx(s.Input,{placeholder:f()})},t.name);case"password":return e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),rules:x,tooltip:R(),children:e.jsxRuntimeExports.jsx(s.Input.Password,{placeholder:f(),autoComplete:"new-password"})},t.name);case"number":return d?e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),rules:x,tooltip:R(),children:e.jsxRuntimeExports.jsx(s.Select,{allowClear:!0,placeholder:f(),children:p.map(g=>e.jsxRuntimeExports.jsx(_,{value:g.value,children:g.label},g.value))})},t.name):e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),rules:x,tooltip:R(),children:e.jsxRuntimeExports.jsx(s.InputNumber,{style:{width:"100%"},placeholder:f()})},t.name);case"boolean":return e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),valuePropName:"checked",tooltip:R(),children:e.jsxRuntimeExports.jsx(s.Switch,{})},t.name);case"array":return d?e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),rules:x,tooltip:R(),children:e.jsxRuntimeExports.jsx(s.Checkbox.Group,{style:{width:"100%"},children:e.jsxRuntimeExports.jsx(s.Space,{direction:"vertical",children:p.map(g=>e.jsxRuntimeExports.jsx(s.Checkbox,{value:g.value,children:g.label},g.value))})})},t.name):e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),rules:x,tooltip:R(),children:e.jsxRuntimeExports.jsx(s.Select,{mode:"tags",style:{width:"100%"},placeholder:f(),tokenSeparators:[","]})},t.name);case"object":return e.jsxRuntimeExports.jsx(s.Form.Item,{name:["config",t.name],label:o(),rules:[...x,{validator:(g,S)=>{if(!S)return Promise.resolve();try{return JSON.parse(S),Promise.resolve()}catch{return Promise.reject(new Error(u("settings.toolsets.invalidJSON",{defaultValue:"Invalid JSON format"})))}}}],tooltip:R(),children:e.jsxRuntimeExports.jsx($,{rows:4,placeholder:f()})},t.name);default:return null}};exports.Actions=me;exports.AdminGuard=xe;exports.AllLangUIConfig=U;exports.Avatar=G;exports.AvatarUpload=W;exports.Code=J;exports.DynamicConfigField=Ce;exports.DynamicIcon=pe;exports.HeaderDropdown=P;exports.LabelCreater=je;exports.LanguageSwitch=re;exports.Loading=D;exports.MarkdownViewer=Re;exports.OrganizationSwitcher=ae;exports.PermissionGuard=O;exports.PrivateRoute=ee;exports.ProfileBasic=Ee;exports.ProfileMFA=ye;exports.ProfilePassword=fe;exports.ProfileSessions=ve;exports.ResizeDivider=ce;exports.Table=ge;exports.TaskListDropdown=ue;exports.UserAuditLogs=Ie;exports.getIconByName=K;
