"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./vendor.js"),i=require("react"),r=require("antd"),g=require("@ant-design/icons"),y=require("react-router-dom"),ee=require("./contexts.js"),te=require("react-i18next"),_=require("./index.js"),B=require("./client.js"),b=require("./components.js"),C=require("./base.js"),{Title:se}=r.Typography,re=({transformLangConfig:U})=>{const x=y.useNavigate(),M=y.useLocation(),[l]=y.useSearchParams(),{login:S,oauthLogin:I,user:V}=ee.useAuth(),{t:n,i18n:h}=te.useTranslation(),[L,u]=i.useState(null),[j,k]=i.useState({}),[d,p]=i.useState("login"),[D,$]=i.useState(null),[E,N]=i.useState(null),[c,z]=i.useState(null),[f]=r.Form.useForm(),F=i.useRef(!1),[G,q]=i.useState(!1),[A,K]=i.useState([]),[w,R]=i.useState(0),[W,T]=i.useState("Loading..."),[o,X]=i.useState(null),v=async s=>{const a=async t=>"username"in t?await S({username:t.username,password:t.password}):"mfa_token"in t?await S({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await I({code:t.code,state:t.state,provider:t.provider});try{q(!0);const t=await a(s);if(await new Promise(m=>setTimeout(m,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&M.pathname!=="/profile")x("/profile#mfa");else{const m=l.get("redirect");m?window.location.href=m:o!=null&&o.home_page?window.location.href=o.home_page:x("/")}}catch(t){if(t.password_expired)p("password_expired"),$(t.token),u(null);else if(t.needsMFA)u(null),p("mfa"),x("/login",{replace:!0}),N(t.mfaType),z(t.user),f.setFieldValue("mfa_token",t.mfaToken);else if("username"in s||"mfa_token"in s)if(t instanceof B.ApiError?u(n("login.error",{defaultValue:"Login failed: {{error}}",error:n(`login.${t}`,{defaultValue:t.message})})):u(typeof t=="string"?t:n("login.error",{defaultValue:"Login failed"})),"mfa_token"in s){R(30);const m=setInterval(()=>{R(O=>O>=1?O-1:0)},1e3);setTimeout(()=>{clearInterval(m),R(0)},3e4)}else"username"in s&&p("login");else t instanceof B.ApiError?u(n("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:n(`login.${t.code}`,{defaultValue:t.message})})):u(typeof t=="string"?t:n("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),x("/login",{replace:!0}),P()}finally{q(!1)}},P=async()=>{K(await _.api.oauth.getProviders()||[])};i.useEffect(()=>{if(!F.current){F.current=!0;const s=l.get("code"),a=l.get("state"),t=l.get("provider");s&&a&&t?v({code:s,state:a,provider:t}):P()}},[l,I]),i.useEffect(()=>{h.language&&T((o==null?void 0:o.name_i18n[h.language])||(o==null?void 0:o.name)||"")},[o,h.language]);const Y=async s=>{try{k({...j,[s]:!0});const{url:a}=await _.api.oauth.getLoginUrl({provider:s},{headers:{"X-Base-Path":C.getURL()}});window.location.href=a}catch(a){r.message.error(n("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",a)}finally{k({...j,[s]:!1})}},H=s=>{switch(s.toLowerCase()){case"github":return e.jsxRuntimeExports.jsx(g.GithubOutlined,{});default:return null}},J=l.get("code"),Q=l.get("state"),Z=l.get("provider");if(i.useEffect(()=>{(async()=>{var t;const a=await _.api.system.getSiteConfig();T(a.name),X(a),window.document.title=a.name,(t=document.getElementById("site-icon"))==null||t.setAttribute("href",a.logo)})()},[]),J&&Q&&Z||!o)return e.jsxRuntimeExports.jsx(b.Loading,{});if(V&&V.status==="active"){const s=l.get("redirect");s?window.location.href=s:o!=null&&o.home_page?window.location.href=o.home_page:x("/")}return e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxRuntimeExports.jsxs(r.Card,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsxRuntimeExports.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsxRuntimeExports.jsx(b.LanguageSwitch,{transformLangConfig:U})}),e.jsxRuntimeExports.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsxRuntimeExports.jsx(se,{level:2,children:W}),e.jsxRuntimeExports.jsx("p",{children:n("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),L&&e.jsxRuntimeExports.jsx(r.Alert,{message:L,type:"error",showIcon:!0,style:{marginBottom:20}}),E&&e.jsxRuntimeExports.jsx(r.Alert,{message:n(`login.mfaTips.${E}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxRuntimeExports.jsxs(r.Form,{name:"login",initialValues:{remember:!0},onFinish:v,size:"large",form:f,hidden:d==="password_expired",children:[d==="mfa"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(r.Form.Item,{hidden:!(c!=null&&c.email)||E!=="email",children:e.jsxRuntimeExports.jsx(r.Input,{value:C.maskEmail(c==null?void 0:c.email)})}),e.jsxRuntimeExports.jsx(r.Form.Item,{name:"mfa_token",hidden:!0,children:e.jsxRuntimeExports.jsx(r.Input,{})}),e.jsxRuntimeExports.jsx(r.Form.Item,{name:"mfa_code",hidden:d!=="mfa",children:e.jsxRuntimeExports.jsx(r.Input,{placeholder:n("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsxRuntimeExports.jsx(g.KeyOutlined,{})})})]}),d==="login"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(r.Form.Item,{name:"username",rules:[{required:!0,message:n("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsxRuntimeExports.jsx(r.Input,{prefix:e.jsxRuntimeExports.jsx(g.UserOutlined,{}),placeholder:n("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsxRuntimeExports.jsx(r.Form.Item,{name:"password",rules:[{required:!0,message:n("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsxRuntimeExports.jsx(r.Input.Password,{prefix:e.jsxRuntimeExports.jsx(g.LockOutlined,{}),placeholder:n("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsxRuntimeExports.jsx(r.Form.Item,{children:e.jsxRuntimeExports.jsx(r.Button,{disabled:w>0,type:"primary",htmlType:"submit",loading:G,block:!0,children:w>0?e.jsxRuntimeExports.jsxs("span",{style:{marginLeft:8},children:[w,"s"]}):n("login.login",{defaultValue:"Login"})})})]}),A.length>0&&d!=="password_expired"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(r.Divider,{children:n("login.or",{defaultValue:"Or"})}),e.jsxRuntimeExports.jsx(r.Space,{direction:"vertical",style:{width:"100%"},children:A.map(s=>e.jsxRuntimeExports.jsx(r.Button,{icon:H(s.name),onClick:()=>Y(s.name),loading:j[s.name],block:!0,children:s.icon_url?e.jsxRuntimeExports.jsx(r.Avatar,{src:s.icon_url}):n("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:s.display_name})},s.name))})]}),d==="password_expired"&&e.jsxRuntimeExports.jsx(b.ProfilePassword,{onSuccess:()=>{p("login"),f.setFieldValue("password",""),f.setFieldValue("mfa_code","")},token:D||void 0})]})})})};exports.default=re;
