"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./vendor.js"),a=require("react"),o=require("antd"),w=require("@ant-design/icons"),N=require("react-router-dom"),B=require("./contexts.js"),se=require("react-i18next"),D=require("./index.js"),$=require("./client.js"),R=require("./components.js"),z=require("./base.js"),ne=require("ahooks"),i=require("classnames"),ae=require("antd-style"),{Title:ie}=o.Typography,le=ae.createStyles(({css:l})=>({loginPageContainer:l`
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f0f2f5;
    `,loginPageCard:l`
      width: 400px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    `,languageSwitch:l`
      position: absolute;
      top: 0;
      right: 0;
    `,loginPageTitle:l`
      text-align: center;
      margin-bottom: 20px;
    `,loginPageError:l`
      margin-bottom: 20px;
    `,loginPageMfaAlert:l`
      margin-bottom: 20px;
    `,loginPageProviders:l`
      width: 100%;
    `})),ue=({transformLangConfig:l})=>{const{styles:d}=le(),f=N.useNavigate(),G=N.useLocation(),[u]=N.useSearchParams(),{login:V,oauthLogin:v,user:L}=B.useAuth(),{t:n,i18n:y}=se.useTranslation(),[k,m]=a.useState(null),[b,F]=a.useState({}),[g,h]=a.useState("login"),[K,W]=a.useState(null),[P,X]=a.useState(null),[p,Y]=a.useState(null),[j]=o.Form.useForm(),q=a.useRef(!1),[H,A]=a.useState(!1),[I,T]=a.useState([]),[_,S]=a.useState(0),{siteConfig:s,loading:J,error:E}=B.useSite(),[Q,O]=a.useState("Loading..."),C=async r=>{const c=async t=>"username"in t?await V({username:t.username,password:t.password}):"mfa_token"in t?await V({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await v({code:t.code,state:t.state,provider:t.provider});try{A(!0);const t=await c(r);if(ne.clearCache(),await new Promise(x=>setTimeout(x,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&G.pathname!=="/profile")f("/profile#mfa");else{const x=u.get("redirect");x?window.location.href=x:s!=null&&s.home_page?window.location.href=s.home_page:f("/")}}catch(t){if(t.password_expired)h("password_expired"),W(t.token),m(null);else if(t.needsMFA)m(null),h("mfa"),f("/login",{replace:!0}),X(t.mfaType),Y(t.user),j.setFieldValue("mfa_token",t.mfaToken);else if("username"in r||"mfa_token"in r)if(t instanceof $.ApiError?m(n("login.error",{defaultValue:"Login failed: {{error}}",error:n(`login.${t}`,{defaultValue:t.message})})):m(typeof t=="string"?t:n("login.error",{defaultValue:"Login failed"})),"mfa_token"in r){S(30);const x=setInterval(()=>{S(U=>U>=1?U-1:0)},1e3);setTimeout(()=>{clearInterval(x),S(0)},3e4)}else"username"in r&&h("login");else t instanceof $.ApiError?m(n("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:n(`login.${t.code}`,{defaultValue:t.message})})):m(typeof t=="string"?t:n("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),f("/login",{replace:!0}),M()}finally{A(!1)}},M=async()=>{try{T(await D.api.oauth.getProviders()||[])}catch(r){o.message.error(n("login.fetchOAuthProvidersError",{defaultValue:"Failed to fetch OAuth providers: {{error}}",error:r.message||r.toString()})),T([])}};a.useEffect(()=>{if(!q.current){q.current=!0;const r=u.get("code"),c=u.get("state"),t=u.get("provider");r&&c&&t?C({code:r,state:c,provider:t}):M()}},[u,v]),a.useEffect(()=>{y.language&&O((s==null?void 0:s.name_i18n[y.language])||(s==null?void 0:s.name)||"")},[s,y.language]);const Z=async r=>{try{F({...b,[r]:!0});const{url:c}=await D.api.oauth.getLoginUrl({provider:r},{headers:{"X-Base-Path":z.getURL()}});window.location.href=c}catch(c){o.message.error(n("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",c)}finally{F({...b,[r]:!1})}},ee=r=>{switch(r.toLowerCase()){case"github":return e.jsxRuntimeExports.jsx(w.GithubOutlined,{});default:return null}},te=u.get("code"),re=u.get("state"),oe=u.get("provider");if(a.useEffect(()=>{var r;s&&(O(s.name),window.document.title=s.name,(r=document.getElementById("site-icon"))==null||r.setAttribute("href",s.logo||""))},[s]),J)return e.jsxRuntimeExports.jsx(R.Loading,{});if(!s)return e.jsxRuntimeExports.jsx(o.Result,{status:"500",title:"500",subTitle:n("login.fetchSiteConfigError",{defaultValue:"Failed to fetch site config: {{error}}",error:(E==null?void 0:E.message)||E})});if(te&&re&&oe)return e.jsxRuntimeExports.jsx(R.Loading,{});if(L&&L.status==="active"){const r=u.get("redirect");r?window.location.href=r:s!=null&&s.home_page?window.location.href=s.home_page:f("/")}return e.jsxRuntimeExports.jsx("div",{className:"login-page",children:e.jsxRuntimeExports.jsx("div",{className:i(d.loginPageContainer,"login-page-container"),children:e.jsxRuntimeExports.jsxs(o.Card,{className:i(d.loginPageCard,"login-page-card"),children:[e.jsxRuntimeExports.jsx("div",{className:i(d.languageSwitch,"language-switch"),children:e.jsxRuntimeExports.jsx(R.LanguageSwitch,{transformLangConfig:l})}),e.jsxRuntimeExports.jsxs("div",{className:i(d.loginPageTitle,"login-page-title"),children:[e.jsxRuntimeExports.jsx(ie,{className:"login-page-title-text",level:2,children:Q}),e.jsxRuntimeExports.jsx("p",{className:"login-page-subtitle-text",children:n("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),k&&e.jsxRuntimeExports.jsx(o.Alert,{className:i(d.loginPageError,"login-page-error"),message:k,type:"error",showIcon:!0}),g==="mfa"&&P&&e.jsxRuntimeExports.jsx(o.Alert,{message:n(`login.mfaTips.${P}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,className:i(d.loginPageMfaAlert,"login-page-mfa-alert")}),e.jsxRuntimeExports.jsxs(o.Form,{name:"login",initialValues:{remember:!0},onFinish:C,size:"large",form:j,hidden:g==="password_expired",className:"login-page-form",children:[g==="mfa"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(o.Form.Item,{hidden:!(p!=null&&p.email)||P!=="email",className:i("login-page-form-item","login-page-form-email"),children:e.jsxRuntimeExports.jsx(o.Input,{value:z.maskEmail(p==null?void 0:p.email)})}),e.jsxRuntimeExports.jsx(o.Form.Item,{name:"mfa_token",hidden:!0,className:i("login-page-form-item","login-page-form-mfa-token"),children:e.jsxRuntimeExports.jsx(o.Input,{})}),e.jsxRuntimeExports.jsx(o.Form.Item,{name:"mfa_code",hidden:g!=="mfa",className:i("login-page-form-item","login-page-form-mfa-code"),children:e.jsxRuntimeExports.jsx(o.Input,{placeholder:n("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsxRuntimeExports.jsx(w.KeyOutlined,{})})})]}),g==="login"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(o.Form.Item,{name:"username",rules:[{required:!0,message:n("login.usernameRequired",{defaultValue:"Username is required"})}],className:i("login-page-form-item","login-page-form-username"),children:e.jsxRuntimeExports.jsx(o.Input,{prefix:e.jsxRuntimeExports.jsx(w.UserOutlined,{}),placeholder:n("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsxRuntimeExports.jsx(o.Form.Item,{name:"password",rules:[{required:!0,message:n("login.passwordRequired",{defaultValue:"Password is required"})}],className:i("login-page-form-item","login-page-form-password"),children:e.jsxRuntimeExports.jsx(o.Input.Password,{prefix:e.jsxRuntimeExports.jsx(w.LockOutlined,{}),placeholder:n("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsxRuntimeExports.jsx(o.Form.Item,{className:i("login-page-form-item","login-page-form-submit"),children:e.jsxRuntimeExports.jsx(o.Button,{disabled:_>0,type:"primary",htmlType:"submit",loading:H,block:!0,children:_>0?e.jsxRuntimeExports.jsxs("span",{style:{marginLeft:8},children:[_,"s"]}):n("login.login",{defaultValue:"Login"})})})]}),I.length>0&&g!=="password_expired"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(o.Divider,{className:i("login-page-divider","login-page-divider-or"),children:n("login.or",{defaultValue:"Or"})}),e.jsxRuntimeExports.jsx(o.Space,{direction:"vertical",className:i(d.loginPageProviders,"login-page-providers"),children:I.map(r=>e.jsxRuntimeExports.jsx(o.Button,{icon:ee(r.name),onClick:()=>Z(r.name),loading:b[r.name],block:!0,children:r.icon_url?e.jsxRuntimeExports.jsx(o.Avatar,{src:r.icon_url}):n("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:r.display_name})},r.name))})]}),g==="password_expired"&&e.jsxRuntimeExports.jsx(R.ProfilePassword,{className:"login-page-password-expired",onSuccess:()=>{h("login"),j.setFieldValue("password",""),j.setFieldValue("mfa_code","")},token:K||void 0})]})})})};exports.default=ue;
