"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./vendor.js"),i=require("react"),s=require("antd"),h=require("@ant-design/icons"),_=require("react-router-dom"),U=require("./contexts.js"),re=require("react-i18next"),C=require("./index.js"),M=require("./client.js"),j=require("./components.js"),D=require("./base.js"),se=require("ahooks"),{Title:oe}=s.Typography,ne=({transformLangConfig:$})=>{const x=_.useNavigate(),N=_.useLocation(),[a]=_.useSearchParams(),{login:V,oauthLogin:L,user:F}=U.useAuth(),{t:n,i18n:E}=re.useTranslation(),[I,l]=i.useState(null),[R,S]=i.useState({}),[d,p]=i.useState("login"),[z,G]=i.useState(null),[w,K]=i.useState(null),[c,W]=i.useState(null),[f]=s.Form.useForm(),k=i.useRef(!1),[X,A]=i.useState(!1),[q,v]=i.useState([]),[y,b]=i.useState(0),{siteConfig:o,loading:Y,error:g}=U.useSite(),[H,T]=i.useState("Loading..."),P=async r=>{const u=async t=>"username"in t?await V({username:t.username,password:t.password}):"mfa_token"in t?await V({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await L({code:t.code,state:t.state,provider:t.provider});try{A(!0);const t=await u(r);if(se.clearCache(),await new Promise(m=>setTimeout(m,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&N.pathname!=="/profile")x("/profile#mfa");else{const m=a.get("redirect");m?window.location.href=m:o!=null&&o.home_page?window.location.href=o.home_page:x("/")}}catch(t){if(t.password_expired)p("password_expired"),G(t.token),l(null);else if(t.needsMFA)l(null),p("mfa"),x("/login",{replace:!0}),K(t.mfaType),W(t.user),f.setFieldValue("mfa_token",t.mfaToken);else if("username"in r||"mfa_token"in r)if(t instanceof M.ApiError?l(n("login.error",{defaultValue:"Login failed: {{error}}",error:n(`login.${t}`,{defaultValue:t.message})})):l(typeof t=="string"?t:n("login.error",{defaultValue:"Login failed"})),"mfa_token"in r){b(30);const m=setInterval(()=>{b(B=>B>=1?B-1:0)},1e3);setTimeout(()=>{clearInterval(m),b(0)},3e4)}else"username"in r&&p("login");else t instanceof M.ApiError?l(n("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:n(`login.${t.code}`,{defaultValue:t.message})})):l(typeof t=="string"?t:n("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),x("/login",{replace:!0}),O()}finally{A(!1)}},O=async()=>{try{v(await C.api.oauth.getProviders()||[])}catch(r){s.message.error(n("login.fetchOAuthProvidersError",{defaultValue:"Failed to fetch OAuth providers: {{error}}",error:r.message||r.toString()})),v([])}};i.useEffect(()=>{if(!k.current){k.current=!0;const r=a.get("code"),u=a.get("state"),t=a.get("provider");r&&u&&t?P({code:r,state:u,provider:t}):O()}},[a,L]),i.useEffect(()=>{E.language&&T((o==null?void 0:o.name_i18n[E.language])||(o==null?void 0:o.name)||"")},[o,E.language]);const J=async r=>{try{S({...R,[r]:!0});const{url:u}=await C.api.oauth.getLoginUrl({provider:r},{headers:{"X-Base-Path":D.getURL()}});window.location.href=u}catch(u){s.message.error(n("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",u)}finally{S({...R,[r]:!1})}},Q=r=>{switch(r.toLowerCase()){case"github":return e.jsxRuntimeExports.jsx(h.GithubOutlined,{});default:return null}},Z=a.get("code"),ee=a.get("state"),te=a.get("provider");if(i.useEffect(()=>{var r;o&&(T(o.name),window.document.title=o.name,(r=document.getElementById("site-icon"))==null||r.setAttribute("href",o.logo||""))},[o]),Y)return e.jsxRuntimeExports.jsx(j.Loading,{});if(!o)return e.jsxRuntimeExports.jsx(s.Result,{status:"500",title:"500",subTitle:n("login.fetchSiteConfigError",{defaultValue:"Failed to fetch site config: {{error}}",error:(g==null?void 0:g.message)||g})});if(Z&&ee&&te)return e.jsxRuntimeExports.jsx(j.Loading,{});if(F&&F.status==="active"){const r=a.get("redirect");r?window.location.href=r:o!=null&&o.home_page?window.location.href=o.home_page:x("/")}return e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxRuntimeExports.jsxs(s.Card,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsxRuntimeExports.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsxRuntimeExports.jsx(j.LanguageSwitch,{transformLangConfig:$})}),e.jsxRuntimeExports.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsxRuntimeExports.jsx(oe,{level:2,children:H}),e.jsxRuntimeExports.jsx("p",{children:n("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),I&&e.jsxRuntimeExports.jsx(s.Alert,{message:I,type:"error",showIcon:!0,style:{marginBottom:20}}),d==="mfa"&&w&&e.jsxRuntimeExports.jsx(s.Alert,{message:n(`login.mfaTips.${w}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxRuntimeExports.jsxs(s.Form,{name:"login",initialValues:{remember:!0},onFinish:P,size:"large",form:f,hidden:d==="password_expired",children:[d==="mfa"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(s.Form.Item,{hidden:!(c!=null&&c.email)||w!=="email",children:e.jsxRuntimeExports.jsx(s.Input,{value:D.maskEmail(c==null?void 0:c.email)})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"mfa_token",hidden:!0,children:e.jsxRuntimeExports.jsx(s.Input,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"mfa_code",hidden:d!=="mfa",children:e.jsxRuntimeExports.jsx(s.Input,{placeholder:n("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsxRuntimeExports.jsx(h.KeyOutlined,{})})})]}),d==="login"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(s.Form.Item,{name:"username",rules:[{required:!0,message:n("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsxRuntimeExports.jsx(s.Input,{prefix:e.jsxRuntimeExports.jsx(h.UserOutlined,{}),placeholder:n("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"password",rules:[{required:!0,message:n("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsxRuntimeExports.jsx(s.Input.Password,{prefix:e.jsxRuntimeExports.jsx(h.LockOutlined,{}),placeholder:n("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsxRuntimeExports.jsx(s.Form.Item,{children:e.jsxRuntimeExports.jsx(s.Button,{disabled:y>0,type:"primary",htmlType:"submit",loading:X,block:!0,children:y>0?e.jsxRuntimeExports.jsxs("span",{style:{marginLeft:8},children:[y,"s"]}):n("login.login",{defaultValue:"Login"})})})]}),q.length>0&&d!=="password_expired"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(s.Divider,{children:n("login.or",{defaultValue:"Or"})}),e.jsxRuntimeExports.jsx(s.Space,{direction:"vertical",style:{width:"100%"},children:q.map(r=>e.jsxRuntimeExports.jsx(s.Button,{icon:Q(r.name),onClick:()=>J(r.name),loading:R[r.name],block:!0,children:r.icon_url?e.jsxRuntimeExports.jsx(s.Avatar,{src:r.icon_url}):n("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:r.display_name})},r.name))})]}),d==="password_expired"&&e.jsxRuntimeExports.jsx(j.ProfilePassword,{onSuccess:()=>{p("login"),f.setFieldValue("password",""),f.setFieldValue("mfa_code","")},token:z||void 0})]})})})};exports.default=ne;
