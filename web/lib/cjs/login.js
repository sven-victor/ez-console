"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("./vendor.js"),o=require("react"),R=require("react-router-dom"),K=require("./contexts.js"),w=require("./index.js"),q=require("./client.js"),y=require("./components.js"),B=require("./base.js"),{Title:Q}=e.Typography,Z=()=>{const m=R.useNavigate(),C=R.useLocation(),[a]=R.useSearchParams(),{login:_,oauthLogin:b,user:S}=K.useAuth(),{t:n,i18n:f}=e.useTranslation(),[I,l]=o.useState(null),[g,V]=o.useState({}),[u,x]=o.useState("login"),[O,$]=o.useState(null),[h,M]=o.useState(null),[c,U]=o.useState(null),[p]=e.Form.useForm(),F=o.useRef(!1),[D,L]=o.useState(!1),[k,N]=o.useState([]),[j,E]=o.useState(0),[z,A]=o.useState("Loading..."),[r,W]=o.useState(null),T=async s=>{const i=async t=>"username"in t?await _({username:t.username,password:t.password}):"mfa_token"in t?await _({mfa_token:t.mfa_token,mfa_code:t.mfa_code}):await b({code:t.code,state:t.state,provider:t.provider});try{L(!0);const t=await i(s);if(await new Promise(d=>setTimeout(d,100)),t&&t.mfa_enforced&&!t.mfa_enabled&&C.pathname!=="/profile")m("/profile#mfa");else{const d=a.get("redirect");d?window.location.href=d:r!=null&&r.home_page?window.location.href=r.home_page:m("/")}}catch(t){if(t.password_expired)x("password_expired"),$(t.token),l(null);else if(t.needsMFA)l(null),x("mfa"),m("/login",{replace:!0}),M(t.mfaType),U(t.user),p.setFieldValue("mfa_token",t.mfaToken);else if("username"in s||"mfa_token"in s)if(t instanceof q.ApiError?l(n("login.error",{defaultValue:"Login failed: {{error}}",error:n(`login.${t}`,{defaultValue:t.message})})):l(typeof t=="string"?t:n("login.error",{defaultValue:"Login failed"})),"mfa_token"in s){E(30);const d=setInterval(()=>{E(P=>P>=1?P-1:0)},1e3);setTimeout(()=>{clearInterval(d),E(0)},3e4)}else"username"in s&&x("login");else t instanceof q.ApiError?l(n("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:n(`login.${t.code}`,{defaultValue:t.message})})):l(typeof t=="string"?t:n("login.oauthError",{defaultValue:"OAuth login failed: {{error}}",error:t})),m("/login",{replace:!0}),v()}finally{L(!1)}},v=async()=>{N(await w.api.oauth.getProviders()||[])};o.useEffect(()=>{if(!F.current){F.current=!0;const s=a.get("code"),i=a.get("state"),t=a.get("provider");s&&i&&t?T({code:s,state:i,provider:t}):v()}},[a,b]),o.useEffect(()=>{f.language&&A((r==null?void 0:r.name_i18n[f.language])||(r==null?void 0:r.name)||"")},[r,f.language]);const X=async s=>{try{V({...g,[s]:!0});const{url:i}=await w.api.oauth.getLoginUrl({provider:s},{headers:{"X-Base-Path":B.getURL()}});window.location.href=i}catch(i){e.staticMethods.error(n("login.oauthError",{defaultValue:"OAuth login failed"})),console.error("OAuth login error:",i)}finally{V({...g,[s]:!1})}},Y=s=>{switch(s.toLowerCase()){case"github":return e.jsxRuntimeExports.jsx(e.RefIcon$23,{});default:return null}},G=a.get("code"),H=a.get("state"),J=a.get("provider");if(o.useEffect(()=>{(async()=>{var t;const i=await w.api.system.getSiteConfig();A(i.name),W(i),window.document.title=i.name,(t=document.getElementById("site-icon"))==null||t.setAttribute("href",i.logo)})()},[]),G&&H&&J||!r)return e.jsxRuntimeExports.jsx(y.Loading,{});if(S&&S.status==="active"){const s=a.get("redirect");s?window.location.href=s:r!=null&&r.home_page?window.location.href=r.home_page:m("/")}return e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx("div",{style:{position:"absolute",top:0,right:0},children:e.jsxRuntimeExports.jsx(y.LanguageSwitch,{})}),e.jsxRuntimeExports.jsx("div",{style:{height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#f0f2f5"},children:e.jsxRuntimeExports.jsxs(e.Card,{style:{width:400,borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:[e.jsxRuntimeExports.jsxs("div",{style:{textAlign:"center",marginBottom:20},children:[e.jsxRuntimeExports.jsx(Q,{level:2,children:z}),e.jsxRuntimeExports.jsx("p",{children:n("login.subtitle",{defaultValue:"Enter your credentials to continue"})})]}),I&&e.jsxRuntimeExports.jsx(e.Alert,{message:I,type:"error",showIcon:!0,style:{marginBottom:20}}),h&&e.jsxRuntimeExports.jsx(e.Alert,{message:n(`login.mfaTips.${h}`,{defaultValue:"You have enabled MFA based on ${mfaType}, please enter the corresponding one-time password."}),type:"info",showIcon:!0,style:{marginBottom:20}}),e.jsxRuntimeExports.jsxs(e.Form,{name:"login",initialValues:{remember:!0},onFinish:T,size:"large",form:p,hidden:u==="password_expired",children:[u==="mfa"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(e.Form.Item,{hidden:!(c!=null&&c.email)||h!=="email",children:e.jsxRuntimeExports.jsx(e.Input,{value:B.maskEmail(c==null?void 0:c.email)})}),e.jsxRuntimeExports.jsx(e.Form.Item,{name:"mfa_token",hidden:!0,children:e.jsxRuntimeExports.jsx(e.Input,{})}),e.jsxRuntimeExports.jsx(e.Form.Item,{name:"mfa_code",hidden:u!=="mfa",children:e.jsxRuntimeExports.jsx(e.Input,{placeholder:n("login.mfa-code",{defaultValue:"MFA Code"}),prefix:e.jsxRuntimeExports.jsx(e.RefIcon$21,{})})})]}),u==="login"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(e.Form.Item,{name:"username",rules:[{required:!0,message:n("login.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsxRuntimeExports.jsx(e.Input,{prefix:e.jsxRuntimeExports.jsx(e.RefIcon$14,{}),placeholder:n("login.username",{defaultValue:"Username"}),autoComplete:"username"})}),e.jsxRuntimeExports.jsx(e.Form.Item,{name:"password",rules:[{required:!0,message:n("login.passwordRequired",{defaultValue:"Password is required"})}],children:e.jsxRuntimeExports.jsx(e.Input.Password,{prefix:e.jsxRuntimeExports.jsx(e.RefIcon$22,{}),placeholder:n("login.password",{defaultValue:"Password"}),autoComplete:"current-password"})})]}),e.jsxRuntimeExports.jsx(e.Form.Item,{children:e.jsxRuntimeExports.jsx(e.Button,{disabled:j>0,type:"primary",htmlType:"submit",loading:D,block:!0,children:j>0?e.jsxRuntimeExports.jsxs("span",{style:{marginLeft:8},children:[j,"s"]}):n("login.login",{defaultValue:"Login"})})})]}),k.length>0&&u!=="password_expired"&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(e.Divider,{children:n("login.or",{defaultValue:"Or"})}),e.jsxRuntimeExports.jsx(e.Space,{direction:"vertical",style:{width:"100%"},children:k.map(s=>e.jsxRuntimeExports.jsx(e.Button,{icon:Y(s.name),onClick:()=>X(s.name),loading:g[s.name],block:!0,children:s.icon_url?e.jsxRuntimeExports.jsx(e.Avatar,{src:s.icon_url}):n("login.continueWith",{defaultValue:"Continue with {{provider}}",provider:s.display_name})},s.name))})]}),u==="password_expired"&&e.jsxRuntimeExports.jsx(y.ProfilePassword,{onSuccess:()=>{x("login"),p.setFieldValue("password",""),p.setFieldValue("mfa_code","")},token:O||void 0})]})})]})};exports.default=Z;
