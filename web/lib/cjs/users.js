"use strict";const e=require("./vendor.js"),g=require("react"),s=require("antd"),f=require("@ant-design/icons"),T=require("react-router-dom"),S=require("./components.js"),j=require("./index.js"),k=require("./base.js"),P=require("react-i18next"),R=require("ahooks"),A=require("./contexts.js"),Q=require("./client.js"),{Option:F}=s.Select,W=({user:n,onClose:h,onSuccess:t})=>{const{t:i}=P.useTranslation("authorization"),[p,c]=g.useState(null),[o,V]=g.useState(null),{run:b,loading:_}=R.useRequest(j.api.authorization.updateUser,{onSuccess:()=>{s.message.success(i("user.updateUserSuccess",{defaultValue:"User updated successfully"})),t()},onError:l=>{s.message.error(i("user.updateUserError",{defaultValue:"Failed to update user",error:l.message}))},manual:!0}),{data:E,loading:w}=R.useRequest(async()=>p==="bind"?j.api.authorization.getLdapUsers({skip_existing:!0}).then(l=>{const y=[],x=[];for(const m of l)m.username===(n==null?void 0:n.username)||m.email===(n==null?void 0:n.email)||m.full_name===(n==null?void 0:n.full_name)?y.push({recommend:!0,...m}):x.push({recommend:!1,...m});return[...y,...x]}):Promise.resolve([]),{refreshDeps:[n==null?void 0:n.id,p]});return g.useEffect(()=>{n&&(c(null),V(null))},[n]),e.jsxRuntimeExports.jsx(s.Modal,{open:n!==null,onCancel:h,onOk:()=>{if(n){if(p==="local")return b({id:n.id},{source:"local"});if(p==="bind"){if(!o){s.message.error(i("user.ldapUserDNRequired",{defaultValue:"LDAP User DN is required"}));return}return b({id:n.id},{source:"ldap",ldap_dn:o})}else{s.message.error(i("user.unknownFixMethod",{defaultValue:"Unknown fix method"}));return}}s.message.error(i("user.unknownUserId",{defaultValue:"Unknown user id"}))},title:i("user.fixUserTitle",{defaultValue:"Fix User"}),children:e.jsxRuntimeExports.jsxs(s.Space,{direction:"vertical",style:{width:"100%"},children:[e.jsxRuntimeExports.jsx(s.Button,{loading:_,style:{width:"100%",height:40},type:"default",variant:"outlined",color:p==="local"?"primary":"default",onClick:()=>c("local"),children:i("user.fixUserConvertToLocal",{defaultValue:"Convert to Local"})}),e.jsxRuntimeExports.jsx(s.Button,{loading:_,style:{width:"100%",height:40},type:"default",variant:"outlined",color:p==="bind"?"primary":"default",onClick:()=>c("bind"),children:i("user.fixUserBindLDAPUser",{defaultValue:"Bind LDAP User"})}),e.jsxRuntimeExports.jsx(s.Select,{loading:w,style:{display:p==="bind"?"block":"none"},onSelect:l=>V(l),options:E==null?void 0:E.map(l=>({label:e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx(s.Tag,{color:l.recommend?"blue":"default",children:l.full_name})," ",l.username," - ",l.email," - ",l.ldap_dn]}),value:l.ldap_dn})),showSearch:!0})]})})},Z=()=>{const{addTask:n}=A.useSite(),h=T.useNavigate(),{t}=P.useTranslation("authorization"),{t:i}=P.useTranslation("common"),[p]=s.Form.useForm(),[c,o]=g.useState([]),[V,b]=g.useState(0),{enableMultiOrg:_}=A.useSite(),[E,w]=g.useState(null),[l,y]=g.useState({current:k.PAGINATION.DEFAULT_CURRENT,page_size:k.PAGINATION.DEFAULT_PAGE_SIZE,keywords:void 0,status:void 0}),{data:x,loading:m}=R.useRequest(async()=>(await j.api.system.listOrganizations({current:1,page_size:1e3})).data||[],{refreshDeps:[_],onError:a=>{s.message.error(t("organizations.loadError",{defaultValue:"Failed to load organizations",error:a.message}))},cacheKey:"fetchAllOrganizations",cacheTime:1e3*60*10}),v=g.useCallback((a,r)=>{if(m)return e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(s.Spin,{size:"small"}),":",r.name]});const U=x==null?void 0:x.find(z=>z.id===a);return U?`${U.name}:${r.name}`:r.name},[x,m]),{run:u,loading:d}=R.useRequest(()=>{const a={status:l.status,keywords:l.keywords};return j.api.authorization.listUsers({current:l.current,page_size:l.page_size,...a})},{onSuccess:a=>{o(a.data||[]),b(a.total||0)},onError:a=>{s.message.error(t("user.loadError",{defaultValue:"Failed to load users",error:a.message}))},refreshDeps:[l]}),C=a=>{y({...l,current:k.PAGINATION.DEFAULT_CURRENT,keywords:a.keywords,status:a.status})},I=()=>{p.resetFields(),y({current:k.PAGINATION.DEFAULT_CURRENT,page_size:k.PAGINATION.DEFAULT_PAGE_SIZE,keywords:void 0,status:void 0})},O=(a,r)=>{y(U=>({...U,current:a,page_size:r}))},{run:q}=R.useRequest(j.api.authorization.restoreUser,{onSuccess:()=>{s.message.success(t("user.restoreSuccess",{defaultValue:"User restored successfully"})),u()},onError:a=>{s.message.error(t("user.restoreError",{defaultValue:"Failed to restore user",error:a.message}))},manual:!0}),{run:B}=R.useRequest(j.api.authorization.deleteUser,{onSuccess:()=>{s.message.success(t("user.deleteSuccess",{defaultValue:"User deleted successfully"})),u()},onError:a=>{s.message.error(t("user.deleteError",{defaultValue:"Failed to delete user",error:a.message}))},manual:!0}),N=(a,r,U)=>{s.Modal.confirm({title:t("user.resetPasswordTitle",{defaultValue:"Reset Password"}),content:t("user.resetPasswordConfirm",{defaultValue:`Are you sure you want to reset the password for ${r}?`,username:r}),okText:i("confirm",{defaultValue:"Confirm"}),cancelText:i("cancel",{defaultValue:"Cancel"}),onOk:async()=>{try{const z=await j.api.authorization.resetUserPassword({id:a},{password:""});s.message.success(t("user.resetPasswordSuccess",{defaultValue:"Password reset successfully"})),z.new_password?s.Modal.info({title:t("user.resetPasswordSuccess",{defaultValue:"Password Reset Successfully"}),content:e.jsxRuntimeExports.jsx(s.Typography.Text,{copyable:{text:z.new_password},children:t("user.resetPasswordSuccessContent",{defaultValue:`New password: ${z.new_password}`,password:z.new_password})})}):s.Modal.info({title:t("user.resetPasswordSuccess",{defaultValue:"Password Reset Successfully"}),content:t("user.resetPasswordSuccessSendByEmail",{defaultValue:"The new password has been sent to the user email: {{email}}",email:U})})}catch(z){console.error("Reset password error:",z),s.message.error(t("user.resetPasswordError",{defaultValue:"Failed to reset password"}))}}})},{run:$,loading:M}=R.useRequest(()=>j.api.authorization.createUserExportTask({keywords:l.keywords,status:l.status}),{onSuccess:a=>{a.id?s.message.success(t("user.exportTaskCreated",{defaultValue:"Export task created. You can view progress and download the file from the task list."})):s.message.success(t("user.exportTaskCreatedShort",{defaultValue:"Export task created."})),n(a)},onError:a=>{s.message.error(t("user.exportError",{defaultValue:"Failed to create export task",error:(a==null?void 0:a.message)??String(a)}))},manual:!0}),G=a=>{s.Modal.confirm({title:t("user.unlockTitle",{defaultValue:"Unlock User"}),content:t("user.unlockConfirm",{defaultValue:"Are you sure you want to unlock this user?",username:a.username}),onOk:async()=>{try{await j.api.authorization.unlockUser({id:a.id}),s.message.success(t("user.unlockSuccess",{defaultValue:"User unlocked successfully"})),u()}catch(r){s.message.error(t("user.unlockError",{defaultValue:"Failed to unlock user: {{error}}",error:r.message??String(r)}))}}})},K=[{title:t("user.username",{defaultValue:"Username"}),key:"user",render:(a,r)=>e.jsxRuntimeExports.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[e.jsxRuntimeExports.jsx(S.Avatar,{size:"small",icon:e.jsxRuntimeExports.jsx(f.UserOutlined,{}),src:r.avatar,style:{marginRight:8}}),e.jsxRuntimeExports.jsx(T.Link,{to:`/authorization/users/${r.id}`,children:r.username})]})},{title:t("user.fullName",{defaultValue:"Full Name"}),dataIndex:"full_name",key:"full_name"},{title:t("user.email",{defaultValue:"Email"}),dataIndex:"email",key:"email"},{title:t("user.source",{defaultValue:"Source"}),dataIndex:"source",key:"source",render:(a,r)=>{switch(a){case"ldap":return r.ldap_dn?e.jsxRuntimeExports.jsx(s.Tag,{color:"blue",children:t("user.sourceLdap",{defaultValue:"LDAP"})}):e.jsxRuntimeExports.jsx(s.Tooltip,{title:t("user.ldapUserNotBound",{defaultValue:"LDAP User is not bound to any local user, please bind it."}),children:e.jsxRuntimeExports.jsx(s.Tag,{color:"red",children:t("user.sourceLdap",{defaultValue:"LDAP"})})});case"oauth2":return e.jsxRuntimeExports.jsx(s.Tag,{color:"green",children:t("user.sourceOauth2",{defaultValue:"OAuth2"})});default:return e.jsxRuntimeExports.jsx(s.Tag,{color:"default",children:t("user.sourceLocal",{defaultValue:"Local"})})}}},{title:t("user.status",{defaultValue:"Status"}),dataIndex:"status",key:"status",render:a=>{switch(a){case"disabled":return e.jsxRuntimeExports.jsx(s.Badge,{status:"default",text:t("user.statusEnum.disabled",{defaultValue:"Disabled"})});case"password_expired":return e.jsxRuntimeExports.jsx(s.Badge,{status:"warning",text:t("user.statusEnum.password_expired",{defaultValue:"Password Expired"})});case"active":return e.jsxRuntimeExports.jsx(s.Badge,{status:"success",text:t("user.statusEnum.active",{defaultValue:"Active"})});case"locked":return e.jsxRuntimeExports.jsx(s.Badge,{status:"warning",text:t("user.statusEnum.locked",{defaultValue:"Locked"})});case"deleted":return e.jsxRuntimeExports.jsx(s.Badge,{status:"error",text:t("user.statusEnum.deleted",{defaultValue:"Deleted"})});default:return e.jsxRuntimeExports.jsx(s.Badge,{status:"default",text:t(`user.statusEnum.${a}`,{defaultValue:a.charAt(0).toUpperCase()+a.slice(1)})})}}},{title:t("user.roles",{defaultValue:"Roles"}),dataIndex:"roles",key:"roles",render:a=>e.jsxRuntimeExports.jsx("span",{children:a&&a.length>0?a.map(r=>e.jsxRuntimeExports.jsx(s.Tag,{color:"blue",children:r.organization_id?v(r.organization_id,r):r.name},r.id)):e.jsxRuntimeExports.jsx(s.Tag,{children:t("user.noRole",{defaultValue:"No Role"})})})},{title:t("user.mfa",{defaultValue:"MFA"}),dataIndex:"mfa_enabled",key:"mfa_enabled",render:a=>a?e.jsxRuntimeExports.jsx(s.Badge,{status:"success",text:t("user.mfaEnabled",{defaultValue:"Enabled"})}):e.jsxRuntimeExports.jsx(s.Badge,{status:"default",text:t("user.mfaDisabled",{defaultValue:"Disabled"})})},{title:t("user.lastLogin",{defaultValue:"Last Login"}),dataIndex:"last_login",key:"last_login",render:a=>a?k.formatDate(a):t("user.neverLogin",{defaultValue:"Never"})},{title:i("actions",{defaultValue:"Actions"}),key:"action",width:150,render:(a,r)=>{const U=[{key:"view",permission:"authorization:user:view",icon:e.jsxRuntimeExports.jsx(f.EyeOutlined,{}),tooltip:t("user.viewDetail",{defaultValue:"View Detail"}),onClick:async()=>h(`/authorization/users/${r.id}`)},{key:"edit",permission:"authorization:user:update",icon:e.jsxRuntimeExports.jsx(f.EditOutlined,{}),tooltip:t("user.edit",{defaultValue:"Edit"}),hidden:r.status==="locked"||r.status==="deleted",onClick:async()=>h(`/authorization/users/${r.id}/edit`)},{key:"unlock",permission:"authorization:user:update",icon:e.jsxRuntimeExports.jsx(f.UnlockOutlined,{}),tooltip:t("user.unlock",{defaultValue:"Unlock"}),hidden:r.status!=="locked",onClick:async()=>G(r)},{key:"resetPassword",permission:"authorization:user:resetPassword",icon:e.jsxRuntimeExports.jsx(f.KeyOutlined,{}),disabled:r.disable_change_password,tooltip:r.disable_change_password?t("user.resetPasswordDisabled",{defaultValue:"The current system prohibits modifying the password of this user."}):t("user.resetPassword",{defaultValue:"Reset Password"}),hidden:!((r.source==="local"||r.source==="ldap"&&r.ldap_dn)&&r.status!=="deleted"),onClick:async()=>N(r.id,r.username,r.email)},{key:"fixUser",permission:"authorization:user:update",icon:e.jsxRuntimeExports.jsx(f.ToolOutlined,{}),tooltip:t("user.fixUser",{defaultValue:"Fix User"}),hidden:!(r.source==="ldap"&&!r.ldap_dn&&r.status!=="deleted"),onClick:async()=>w(r)},{key:"restore",permission:"authorization:user:update",icon:e.jsxRuntimeExports.jsx(f.UndoOutlined,{}),tooltip:t("user.restore",{defaultValue:"Restore"}),hidden:r.status!=="deleted",confirm:{title:t("user.restoreConfirm",{defaultValue:"Are you sure you want to restore this user?"}),onConfirm:async()=>q({id:r.id})}},{key:"delete",permission:"authorization:user:delete",icon:e.jsxRuntimeExports.jsx(f.DeleteOutlined,{}),tooltip:t("user.delete",{defaultValue:"Delete"}),danger:!0,confirm:{title:t("user.deleteConfirm",{defaultValue:"Are you sure you want to delete this user?"}),onConfirm:()=>B({id:r.id}),okText:i("confirm",{defaultValue:"Confirm"}),cancelText:i("cancel",{defaultValue:"Cancel"})}}];return e.jsxRuntimeExports.jsx(S.Actions,{actions:U},"actions")}}];return e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx(s.Card,{style:{marginBottom:16},children:e.jsxRuntimeExports.jsx(s.Form,{form:p,layout:"inline",onFinish:C,children:e.jsxRuntimeExports.jsxs(s.Row,{gutter:16,style:{width:"100%"},children:[e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsx(s.Form.Item,{name:"keywords",children:e.jsxRuntimeExports.jsx(s.Input,{prefix:e.jsxRuntimeExports.jsx(f.SearchOutlined,{}),placeholder:t("user.keywords",{defaultValue:"Search by username, full name, or email"}),allowClear:!0})})}),e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsx(s.Form.Item,{name:"status",children:e.jsxRuntimeExports.jsxs(s.Select,{placeholder:t("user.status",{defaultValue:"Status"}),allowClear:!0,style:{width:"100%"},children:[e.jsxRuntimeExports.jsx(F,{value:"active",children:t("user.statusEnum.active",{defaultValue:"Active"})}),e.jsxRuntimeExports.jsx(F,{value:"disabled",children:t("user.statusEnum.disabled",{defaultValue:"Disabled"})}),e.jsxRuntimeExports.jsx(F,{value:"deleted",children:t("user.statusEnum.deleted",{defaultValue:"Deleted"})}),e.jsxRuntimeExports.jsx(F,{value:"locked",children:t("user.statusEnum.locked",{defaultValue:"Locked"})}),e.jsxRuntimeExports.jsx(F,{value:"password_expired",children:t("user.statusEnum.password_expired",{defaultValue:"Password Expired"})})]})})}),e.jsxRuntimeExports.jsx(s.Col,{span:6,children:e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(s.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(f.SearchOutlined,{}),htmlType:"submit",children:i("search",{defaultValue:"Search"})}),e.jsxRuntimeExports.jsx(s.Button,{icon:e.jsxRuntimeExports.jsx(f.ReloadOutlined,{}),onClick:I,children:i("reset",{defaultValue:"Reset"})})]})})]})})}),e.jsxRuntimeExports.jsxs(s.Card,{children:[e.jsxRuntimeExports.jsxs(s.Row,{justify:"space-between",align:"middle",gutter:[0,16],children:[e.jsxRuntimeExports.jsx(s.Col,{children:e.jsxRuntimeExports.jsx(s.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(f.ReloadOutlined,{}),onClick:u,children:i("refresh",{defaultValue:"Refresh"})})}),e.jsxRuntimeExports.jsx(s.Col,{children:e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(S.PermissionGuard,{permission:"authorization:user:export",children:e.jsxRuntimeExports.jsx(s.Button,{icon:e.jsxRuntimeExports.jsx(f.ExportOutlined,{}),loading:M,style:{marginBottom:16},onClick:()=>$(),children:t("user.export",{defaultValue:"Export"})})}),e.jsxRuntimeExports.jsx(S.PermissionGuard,{permission:"authorization:user:create",children:e.jsxRuntimeExports.jsx(s.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(f.UserAddOutlined,{}),style:{marginBottom:16},onClick:()=>h("/authorization/users/create"),children:t("user.create",{defaultValue:"Create User"})})})]})})]}),e.jsxRuntimeExports.jsx(s.Table,{columns:K,dataSource:c,rowKey:"id",loading:d,pagination:{current:l.current,pageSize:l.page_size,total:V,showSizeChanger:!0,showQuickJumper:!0,showTotal:a=>i("totalItems",{defaultValue:`Total ${a} items`,total:a}),onChange:O}})]}),e.jsxRuntimeExports.jsx(W,{user:E,onClose:()=>w(null),onSuccess:()=>{w(null),u()}})]})},J=Object.freeze(Object.defineProperty({__proto__:null,default:Z},Symbol.toStringTag,{value:"Module"})),{Title:Y}=s.Typography,{TabPane:L}=s.Tabs,H=()=>{const{id:n}=T.useParams(),h=T.useNavigate(),{t}=P.useTranslation("authorization"),{t:i}=P.useTranslation("common"),[p,c]=g.useState(!1),[o,V]=g.useState(null),{hasPermission:b}=A.usePermission(),{enableMultiOrg:_}=A.useSite(),{data:E,loading:w}=R.useRequest(async()=>(await j.api.system.listOrganizations({current:1,page_size:1e3})).data||[],{refreshDeps:[_],onError:x=>{s.message.error(t("organizations.loadError",{defaultValue:"Failed to load organizations",error:x.message}))},cacheKey:"fetchAllOrganizations",cacheTime:1e3*60*10}),l=g.useCallback((x,m)=>{if(w)return e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(s.Spin,{size:"small"}),":",m.name]});const v=E==null?void 0:E.find(u=>u.id===x);return v?`${v.name}:${m.name}`:m.name},[E,w]);if(g.useEffect(()=>{(async()=>{if(n){c(!0);try{const m=await j.api.authorization.getUser({id:n});V(m)}catch(m){m instanceof Q.ApiError&&m.code==="E4041"||(console.error("Failed to get user details:",m),s.message.error(t("user.detailLoadError",{defaultValue:"Failed to load user details"})))}finally{c(!1)}}})()},[n,t]),p)return e.jsxRuntimeExports.jsx("div",{style:{textAlign:"center",padding:"50px"},children:e.jsxRuntimeExports.jsx(s.Spin,{size:"large"})});if(!o)return e.jsxRuntimeExports.jsxs("div",{style:{textAlign:"center",padding:"50px"},children:[e.jsxRuntimeExports.jsx(Y,{level:4,children:t("user.notFound",{defaultValue:"User not found"})}),e.jsxRuntimeExports.jsx(s.Button,{type:"primary",onClick:()=>h("/authorization/users"),children:t("user.backToList",{defaultValue:"Back to User List"})})]});const y=()=>o.mfa_enabled?e.jsxRuntimeExports.jsx(s.Badge,{status:"success",text:t("user.mfaEnabled",{defaultValue:"Enabled"})}):o.mfa_enforced?e.jsxRuntimeExports.jsx(s.Badge,{status:"warning",text:t("user.mfaEnforced",{defaultValue:"Enforced"})}):e.jsxRuntimeExports.jsx(s.Badge,{status:"default",text:t("user.mfaDisabled",{defaultValue:"Disabled"})});return e.jsxRuntimeExports.jsx(s.Card,{title:e.jsxRuntimeExports.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[e.jsxRuntimeExports.jsx(S.Avatar,{size:64,icon:e.jsxRuntimeExports.jsx(f.UserOutlined,{}),src:o.avatar,style:{marginRight:16}}),e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx("div",{style:{fontSize:20,fontWeight:"bold"},children:o.username}),e.jsxRuntimeExports.jsx("div",{style:{color:"#888"},children:o.email})]})]}),extra:e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(s.Button,{icon:e.jsxRuntimeExports.jsx(f.ArrowLeftOutlined,{}),onClick:()=>h("/authorization/users"),children:i("back",{defaultValue:"Back"})}),e.jsxRuntimeExports.jsx(s.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(f.EditOutlined,{}),onClick:()=>h(`/authorization/users/${n}/edit`),children:i("edit",{defaultValue:"Edit"})})]}),children:e.jsxRuntimeExports.jsxs(s.Tabs,{defaultActiveKey:"basic",children:[e.jsxRuntimeExports.jsx(L,{tab:t("user.basicInfo",{defaultValue:"Basic Information"}),children:e.jsxRuntimeExports.jsxs(s.Descriptions,{bordered:!0,column:2,style:{marginTop:16},children:[e.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:t("user.username",{defaultValue:"Username"}),children:o.username}),e.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:t("user.fullName",{defaultValue:"Full Name"}),children:o.full_name}),e.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:t("user.email",{defaultValue:"Email"}),children:o.email}),e.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:t("user.status",{defaultValue:"Status"}),children:o.status==="active"?e.jsxRuntimeExports.jsx(s.Badge,{status:"success",text:t("user.statusActive",{defaultValue:"Active"})}):e.jsxRuntimeExports.jsx(s.Badge,{status:"error",text:t(`user.statusEnum.${o.status}`,{defaultValue:o.status.charAt(0).toUpperCase()+o.status.slice(1)})})}),e.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:t("user.roles",{defaultValue:"Roles"}),span:2,children:o.roles&&o.roles.length>0?o.roles.map(x=>e.jsxRuntimeExports.jsx(s.Tag,{color:"blue",children:_?l(x.organization_id,x):x.name},x.id)):e.jsxRuntimeExports.jsx(s.Tag,{children:t("user.noRole",{defaultValue:"No Role"})})}),e.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:t("user.mfa",{defaultValue:"MFA"}),children:y()}),e.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:t("user.lastLogin",{defaultValue:"Last Login"}),children:o.last_login?k.formatDate(o.last_login):t("user.neverLogin",{defaultValue:"Never"})}),e.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:t("user.createdAt",{defaultValue:"Created At"}),children:k.formatDate(o.created_at)}),e.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:t("user.updatedAt",{defaultValue:"Updated At"}),children:k.formatDate(o.updated_at)})]})},"basic"),e.jsxRuntimeExports.jsx(L,{disabled:!b("authorization:user:view_audit_logs"),tab:t("user.auditLogs",{defaultValue:"Audit Logs"}),children:e.jsxRuntimeExports.jsx(S.UserAuditLogs,{userId:n||""})},"logs")]})})},X=Object.freeze(Object.defineProperty({__proto__:null,default:H},Symbol.toStringTag,{value:"Module"})),{Option:D}=s.Select,ee=()=>{const{id:n=""}=T.useParams(),h=T.useNavigate(),{t}=P.useTranslation("authorization"),{t:i}=P.useTranslation("common"),[p]=s.Form.useForm(),c=!!n,{enableMultiOrg:o}=A.useSite(),{data:V,loading:b}=R.useRequest(async()=>(await j.api.system.listOrganizations({current:1,page_size:1e3})).data||[],{refreshDeps:[o],onError:u=>{s.message.error(t("organizations.loadError",{defaultValue:"Failed to load organizations",error:u.message}))},cacheKey:"fetchAllOrganizations",cacheTime:1e3*60*10}),_=g.useCallback((u,d)=>{if(b)return e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(s.Spin,{size:"small"}),":",d.name]});const C=V==null?void 0:V.find(I=>I.id===u);return C?`${C.name}:${d.name}`:d.name},[V,b]),{data:E,loading:w}=R.useRequest(async()=>(await j.api.authorization.listRoles({})).data.map(d=>({...d,label:d.name,value:d.id}))),{loading:l}=R.useRequest(async()=>{if(!(!c||!p))try{const u=await j.api.authorization.getUser({id:n});return p.setFieldsValue({username:u.username,email:u.email,full_name:u.full_name,status:u.status,role_ids:u.roles?u.roles.map(d=>d.id):[],mfa_enforced:u.mfa_enforced}),u}catch{s.message.error(t("user.loadError",{defaultValue:"Failed to load user data"}))}},{refreshDeps:[n,p]}),{run:y,loading:x}=R.useRequest(async u=>{try{if(c)await j.api.authorization.updateUser({id:n},{email:u.email,avatar:u.avatar,full_name:u.full_name,status:u.status,mfa_enforced:u.mfa_enforced,role_ids:u.role_ids}),s.message.success(t("user.updateSuccess",{defaultValue:"User updated successfully"})),h(`/authorization/users/${n}`);else{const d={username:u.username,avatar:u.avatar,password:u.password,email:u.email,full_name:u.full_name,mfa_enforced:u.mfa_enforced,role_ids:u.role_ids},C=await j.api.authorization.createUser(d);s.message.success(t("user.createSuccess",{defaultValue:"User created successfully"})),h(`/authorization/users/${C.id}`)}}catch(d){s.message.error(c?t("user.updateError",{defaultValue:"Failed to update user",error:d}):t("user.createError",{defaultValue:"Failed to create user",error:d}))}},{manual:!0}),m=(u,d)=>c?Promise.resolve():d?d.length<8?Promise.reject(new Error(t("user.passwordTooShort",{defaultValue:"Password must be at least 8 characters long"}))):Promise.resolve():Promise.reject(new Error(t("user.passwordRequired",{defaultValue:"Password is required"}))),v=(u,d)=>c?Promise.resolve():d?d!==p.getFieldValue("password")?Promise.reject(new Error(t("user.passwordMismatch",{defaultValue:"Passwords do not match"}))):Promise.resolve():Promise.reject(new Error(t("user.confirmPasswordRequired",{defaultValue:"Please confirm your password"})));return e.jsxRuntimeExports.jsx(s.Card,{title:c?t("user.editTitle",{defaultValue:"Edit User"}):t("user.createTitle",{defaultValue:"Create User"}),loading:l||w,children:e.jsxRuntimeExports.jsxs(s.Form,{form:p,layout:"horizontal",onFinish:y,labelCol:{sm:{span:24},md:{span:6}},wrapperCol:{sm:{span:24},md:{span:18}},size:"middle",style:{maxWidth:"500px",margin:"0 auto"},initialValues:{status:"active",role_ids:[]},children:[e.jsxRuntimeExports.jsx(s.Form.Item,{name:"avatar",label:t("user.avatar",{defaultValue:"Avatar"}),children:e.jsxRuntimeExports.jsx(S.AvatarUpload,{})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"username",label:t("user.username",{defaultValue:"Username"}),rules:[{required:!c,message:t("user.usernameRequired",{defaultValue:"Username is required"})}],children:e.jsxRuntimeExports.jsx(s.Input,{disabled:c,placeholder:t("user.usernamePlaceholder",{defaultValue:"Enter username"})})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"email",label:t("user.email",{defaultValue:"Email"}),rules:[{required:!0,message:t("user.emailRequired",{defaultValue:"Email is required"})},{type:"email",message:t("user.emailInvalid",{defaultValue:"Invalid email format"})}],children:e.jsxRuntimeExports.jsx(s.Input,{placeholder:t("user.emailPlaceholder",{defaultValue:"Enter email address"})})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"full_name",label:t("user.fullName",{defaultValue:"Full Name"}),rules:[{required:!0,message:t("user.fullNameRequired",{defaultValue:"Full name is required"})}],children:e.jsxRuntimeExports.jsx(s.Input,{placeholder:t("user.fullNamePlaceholder",{defaultValue:"Enter full name"})})}),c&&e.jsxRuntimeExports.jsx(s.Form.Item,{name:"status",label:t("user.status",{defaultValue:"Status"}),rules:[{required:!0,message:t("user.statusRequired",{defaultValue:"Status is required"})}],children:e.jsxRuntimeExports.jsxs(s.Select,{placeholder:t("user.statusPlaceholder",{defaultValue:"Select status"}),children:[e.jsxRuntimeExports.jsx(D,{value:"active",children:t("user.statusActive",{defaultValue:"Active"})}),e.jsxRuntimeExports.jsx(D,{value:"disabled",children:t("user.statusDisabled",{defaultValue:"Disabled"})}),e.jsxRuntimeExports.jsx(D,{value:"password_expired",children:t("user.statusEnum.password_expired",{defaultValue:"Password Expired"})})]})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"mfa_enforced",label:t("user.mfaEnforced",{defaultValue:"MFA Enforced"}),children:e.jsxRuntimeExports.jsx(s.Switch,{})}),!c&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(s.Form.Item,{name:"password",label:t("user.password",{defaultValue:"Password"}),rules:[{validator:m}],children:e.jsxRuntimeExports.jsx(s.Input.Password,{autoComplete:"new-password",placeholder:t("user.passwordPlaceholder",{defaultValue:"Enter password"})})}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"confirm_password",label:t("user.confirmPassword",{defaultValue:"Confirm Password"}),rules:[{validator:v}],dependencies:["password"],children:e.jsxRuntimeExports.jsx(s.Input.Password,{autoComplete:"new-password",placeholder:t("user.confirmPasswordPlaceholder",{defaultValue:"Confirm password"})})})]}),e.jsxRuntimeExports.jsx(s.Form.Item,{name:"role_ids",label:t("user.roles",{defaultValue:"Roles"}),children:e.jsxRuntimeExports.jsx(s.Select,{mode:"multiple",placeholder:t("user.selectRoles",{defaultValue:"Select roles"}),options:E==null?void 0:E.map(u=>({...u,label:o?_(u.organization_id,u):u.name})),optionFilterProp:"label",loading:w})}),e.jsxRuntimeExports.jsx(s.Form.Item,{wrapperCol:{offset:9},children:e.jsxRuntimeExports.jsxs(s.Space,{children:[e.jsxRuntimeExports.jsx(s.Button,{type:"primary",htmlType:"submit",loading:x,children:c?i("update",{defaultValue:"Update"}):i("create",{defaultValue:"Create"})}),e.jsxRuntimeExports.jsx(s.Button,{onClick:()=>h(c?`/authorization/users/${n}`:"/authorization/users"),children:i("cancel",{defaultValue:"Cancel"})})]})})]})})},se=Object.freeze(Object.defineProperty({__proto__:null,default:ee},Symbol.toStringTag,{value:"Module"}));exports.UserDetail=X;exports.UserForm=se;exports.UserList=J;
