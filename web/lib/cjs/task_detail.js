"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("./vendor.js"),y=require("react"),s=require("antd"),n=require("@ant-design/icons"),d=require("react-router-dom"),x=require("react-i18next"),g=require("ahooks"),o=require("./index.js"),i=require("./components.js"),V={pending:"default",running:"processing",success:"success",failed:"error",cancelled:"default"},D=()=>{const{id:a}=d.useParams(),u=d.useNavigate(),{t:r}=x.useTranslation("task"),{t:p}=x.useTranslation("common"),{data:e,loading:m,refresh:l}=g.useRequest(()=>a?o.api.tasks.getTask({id:a}):Promise.reject(new Error("No id")),{refreshDeps:[a],ready:!!a});y.useEffect(()=>{if(!a||!e||e.status!=="running"&&e.status!=="pending")return;const c=setInterval(l,2e3);return()=>clearInterval(c)},[a,e==null?void 0:e.status,l]);const j=async()=>{if(a)try{await o.api.tasks.cancelTask({id:a}),s.message.success(r("cancelSuccess",{defaultValue:"Task cancelled."})),l()}catch{s.message.error(r("cancelFailed",{defaultValue:"Failed to cancel task."}))}},f=async()=>{if(a)try{await o.api.tasks.retryTask({id:a}),s.message.success(r("retrySuccess",{defaultValue:"Task retry requested."})),l()}catch{s.message.error(r("retryFailed",{defaultValue:"Failed to retry task."}))}},h=async()=>{if(a)try{await o.api.tasks.deleteTask({id:a}),s.message.success(r("deleteSuccess",{defaultValue:"Task deleted."})),u("/tasks")}catch{s.message.error(r("deleteFailed",{defaultValue:"Failed to delete task."}))}},R=()=>{if(!(e!=null&&e.artifact_file_key))return;window.open(`/api/files/${e.artifact_file_key}`,"_blank")};if(m&&!e)return t.jsxRuntimeExports.jsx(s.Card,{children:t.jsxRuntimeExports.jsx(s.Spin,{spinning:!0})});if(!e)return t.jsxRuntimeExports.jsxs(s.Card,{children:[t.jsxRuntimeExports.jsx("p",{children:r("notFound",{defaultValue:"Task not found."})}),t.jsxRuntimeExports.jsx(s.Button,{type:"primary",onClick:()=>u("/tasks"),children:r("backToList",{defaultValue:"Back to list"})})]});const E=e.status==="running"||e.status==="pending",k=e.status==="failed"||e.status==="cancelled";return t.jsxRuntimeExports.jsx(s.Card,{title:r("detailTitle",{defaultValue:"Task Detail"}),extra:t.jsxRuntimeExports.jsx(s.Button,{type:"text",icon:t.jsxRuntimeExports.jsx(n.ArrowLeftOutlined,{}),onClick:()=>u("/tasks"),children:p("back",{defaultValue:"Back"})}),children:t.jsxRuntimeExports.jsxs(s.Space,{direction:"vertical",style:{width:"100%"},size:"middle",children:[t.jsxRuntimeExports.jsxs(s.Descriptions,{bordered:!0,column:1,size:"small",children:[t.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:r("typeLabel",{defaultValue:"Type"}),children:r(`type.${e.type}`,{defaultValue:e.type})}),t.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:r("statusLabel",{defaultValue:"Status"}),children:t.jsxRuntimeExports.jsx(s.Tag,{color:V[e.status]||"default",children:r(`status.${e.status}`,{defaultValue:e.status})})}),t.jsxRuntimeExports.jsxs(s.Descriptions.Item,{label:r("progress",{defaultValue:"Progress"}),children:[(e.status==="running"||e.status==="pending")&&t.jsxRuntimeExports.jsx(s.Progress,{percent:e.progress??0,size:"small",style:{maxWidth:200}}),e.status!=="running"&&e.status!=="pending"&&"-"]}),t.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:r("creatorId",{defaultValue:"Creator"}),children:e.creator_id}),t.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:r("createdAt",{defaultValue:"Created At"}),children:e.created_at?new Date(e.created_at).toLocaleString():"-"}),t.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:r("startedAt",{defaultValue:"Started At"}),children:e.started_at?new Date(e.started_at).toLocaleString():"-"}),t.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:r("finishedAt",{defaultValue:"Finished At"}),children:e.finished_at?new Date(e.finished_at).toLocaleString():"-"}),e.error&&t.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:r("error",{defaultValue:"Error"}),children:t.jsxRuntimeExports.jsx("pre",{style:{margin:0,whiteSpace:"pre-wrap",color:"var(--ant-color-error)"},children:e.error})}),e.result&&t.jsxRuntimeExports.jsx(s.Descriptions.Item,{label:r("result",{defaultValue:"Result"}),children:t.jsxRuntimeExports.jsx("pre",{style:{margin:0,whiteSpace:"pre-wrap",maxHeight:200,overflow:"auto"},children:e.result})})]}),e.artifact_file_key&&t.jsxRuntimeExports.jsx(s.Space,{children:t.jsxRuntimeExports.jsx(i.PermissionGuard,{permission:"task:view",children:t.jsxRuntimeExports.jsx(s.Button,{type:"primary",icon:t.jsxRuntimeExports.jsx(n.DownloadOutlined,{}),onClick:R,children:r("downloadArtifact",{defaultValue:"Download artifact"})})})}),t.jsxRuntimeExports.jsxs(s.Space,{wrap:!0,children:[E&&t.jsxRuntimeExports.jsx(i.PermissionGuard,{permission:"task:cancel",children:t.jsxRuntimeExports.jsx(s.Button,{icon:t.jsxRuntimeExports.jsx(n.StopOutlined,{}),onClick:j,children:r("cancel",{defaultValue:"Cancel"})})}),k&&t.jsxRuntimeExports.jsx(i.PermissionGuard,{permission:"task:retry",children:t.jsxRuntimeExports.jsx(s.Button,{icon:t.jsxRuntimeExports.jsx(n.RedoOutlined,{}),onClick:f,children:r("retry",{defaultValue:"Retry"})})}),t.jsxRuntimeExports.jsx(i.PermissionGuard,{permission:"task:delete",children:t.jsxRuntimeExports.jsx(i.Actions,{actions:[{key:"delete",label:r("delete",{defaultValue:"Delete"}),icon:t.jsxRuntimeExports.jsx(n.DeleteOutlined,{}),danger:!0,confirm:{title:r("deleteConfirm",{defaultValue:"Delete this task?"}),onConfirm:h}}]})})]})]})})};exports.default=D;
