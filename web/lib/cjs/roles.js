"use strict";const e=require("./vendor.js"),n=require("react"),l=require("antd"),E=require("@ant-design/icons"),w=require("./components.js"),b=require("./index.js"),C=require("react-i18next"),L=require("./contexts.js"),G=require("react-router-dom"),W=require("lodash"),pe=require("antd-style"),fe=()=>{const{t:m}=C.useTranslation("authorization"),{t:i}=C.useTranslation("common"),{siteConfig:p}=L.useSite(),y=G.useNavigate(),f=n.useRef(null),h=u=>{y(`/authorization/roles/${u}/edit`)},S=async u=>{var a,r;try{await b.api.authorization.deleteRole({id:u}),l.message.success(m("role.deleteSuccess",{defaultValue:"Role deleted successfully."})),(r=(a=f.current)==null?void 0:a.reload)==null||r.call(a)}catch(V){l.message.error(m("role.deleteError",{defaultValue:"Failed to delete role: {{error}}",error:V}))}},k=[{title:m("role.name",{defaultValue:"Role Name"}),dataIndex:"name",key:"name",render:u=>e.jsxRuntimeExports.jsxs(l.Space,{children:[e.jsxRuntimeExports.jsx(E.UserOutlined,{}),u]})},{title:m("role.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:m("role.organization",{defaultValue:"Organization"}),key:"organization",hidden:!(p!=null&&p.enable_multi_org),render:(u,a)=>{var r;return a.organization_id?e.jsxRuntimeExports.jsx(l.Tag,{icon:e.jsxRuntimeExports.jsx(E.TeamOutlined,{}),color:"blue",children:((r=a.organization)==null?void 0:r.name)||a.organization_id}):e.jsxRuntimeExports.jsx(l.Tag,{color:"default",children:m("role.global",{defaultValue:"Global"})})}},{title:m("role.permissionCount",{defaultValue:"Permissions"}),key:"permission_count",render:(u,a)=>{var r;return e.jsxRuntimeExports.jsxs(l.Tag,{color:"blue",children:[e.jsxRuntimeExports.jsx(E.LockOutlined,{})," ",((r=a.permissions)==null?void 0:r.length)||0]})}},{title:m("role.createdAt",{defaultValue:"Created At"}),dataIndex:"created_at",key:"created_at",render:u=>new Date(u).toLocaleString()},{title:i("actions",{defaultValue:"Actions"}),key:"action",render:(u,a)=>e.jsxRuntimeExports.jsxs(l.Space,{size:"small",children:[e.jsxRuntimeExports.jsx(w.PermissionGuard,{permission:"authorization:role:update",children:e.jsxRuntimeExports.jsx(l.Tooltip,{title:m("role.edit",{defaultValue:"Edit Role"}),children:e.jsxRuntimeExports.jsx(l.Button,{type:"text",size:"small",icon:e.jsxRuntimeExports.jsx(E.EditOutlined,{}),onClick:()=>h(a.id)})})}),e.jsxRuntimeExports.jsx(w.PermissionGuard,{permission:"authorization:role:delete",children:e.jsxRuntimeExports.jsx(l.Tooltip,{title:m("role.delete",{defaultValue:"Delete Role"}),children:e.jsxRuntimeExports.jsx(l.Popconfirm,{title:m("role.deleteConfirm",{defaultValue:"Are you sure you want to delete this role?"}),onConfirm:()=>S(a.id),okText:i("confirm",{defaultValue:"Confirm"}),cancelText:i("cancel",{defaultValue:"Cancel"}),children:e.jsxRuntimeExports.jsx(l.Button,{type:"text",size:"small",danger:!0,icon:e.jsxRuntimeExports.jsx(E.DeleteOutlined,{})})})})})]})}];return e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsxs(l.Card,{style:{marginBottom:16},children:[e.jsxRuntimeExports.jsx("div",{style:{marginBottom:16},children:e.jsxRuntimeExports.jsxs(l.Row,{justify:"space-between",align:"middle",gutter:16,children:[e.jsxRuntimeExports.jsx(l.Col,{children:e.jsxRuntimeExports.jsx(l.Space,{children:e.jsxRuntimeExports.jsx(l.Button,{type:"primary",onClick:()=>{var u,a;(a=(u=f.current)==null?void 0:u.reload)==null||a.call(u)},icon:e.jsxRuntimeExports.jsx(E.ReloadOutlined,{}),children:i("refresh",{defaultValue:"Refresh"})})})}),e.jsxRuntimeExports.jsx(l.Col,{children:e.jsxRuntimeExports.jsx(w.PermissionGuard,{permission:"authorization:role:create",children:e.jsxRuntimeExports.jsx(l.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(E.PlusOutlined,{}),onClick:()=>y("/authorization/roles/create"),children:m("role.create",{defaultValue:"Create Role"})})})})]})}),e.jsxRuntimeExports.jsx(w.Table,{request:async({page_size:u,current:a})=>b.api.authorization.listRoles({current:a,page_size:u}),columns:k,actionRef:f})]})})},he=Object.freeze(Object.defineProperty({__proto__:null,default:fe},Symbol.toStringTag,{value:"Module"})),{TextArea:H}=l.Input,je=pe.createStyles(({css:m})=>({rolePermissionExtra:m`
      float: right;
      z-index: 1001;
      position: sticky;
    `,rolePolicyExtra:m`
      position: absolute;
      right: 5px;
      top: 5px;
    `})),ge={allow_all:{policy:{Statement:[{Effect:"Allow",Action:["*"]}]}},deny_all:{Statement:[{Effect:"Deny",Action:["*"]}]},allow_with_action:{Statement:[{Effect:"Allow",Action:["authorization:user:view"]}]},allow_with_condition:{Statement:[{Effect:"Allow",Action:["authorization:user:update"],Condition:{StringEquals:{"id:":"abcdef"}}},{Effect:"Deny",Action:["*"]}]},allow_with_uri:{Statement:[{Effect:"Allow",Action:["authorization:user:view"],Condition:{StringEquals:{"http.uri":"/api/users/abcdef","http.method":"GET"}}},{Effect:"Deny",Action:["*"]}]}},K=JSON.stringify({Statement:[]},null,2),Ee=()=>{const{styles:m}=je(),{t:i}=C.useTranslation("authorization"),{t:p}=C.useTranslation("common"),y=G.useNavigate(),{id:f}=G.useParams(),h=!!f,{enableMultiOrg:S,currentOrgId:k}=L.useSite(),{user:u}=L.useAuth(),a=(u==null?void 0:u.organizations)||[],[r]=l.Form.useForm(),[V,v]=n.useState([]),[P,X]=n.useState([]),[Y,I]=n.useState([]),[Q,O]=n.useState(!0),[T,R]=n.useState([]),[A,j]=n.useState({}),F=n.useRef({}),[Z,B]=n.useState(!1),[g,N]=n.useState("global"),[q,ee]=n.useState(void 0),[te,M]=n.useState(!1),[oe,J]=n.useState(!1);n.useEffect(()=>{F.current=A},[A]),n.useEffect(()=>{ee(k||void 0)},[]);const U=n.useCallback(async()=>{try{const o=await b.api.authorization.listPermissions();X(o.map((t,s)=>{const c=(t.permissions||[]).map(d=>({key:d.id,code:d.code.replace(/:/g,"."),title:d.name,orgPermission:d.org_permission||!1}));return{key:`[group]-${s}`,title:t.name,code:t.name.replace(/ /g,"_"),children:c}}))}catch{l.message.error(i("role.loadError",{defaultValue:"Failed to load role list"}))}},[i]);n.useEffect(()=>{U()},[U]);const z=n.useCallback(async(o,t)=>{if(!o){R([]),j(t||{});return}B(!0);try{const c=((await b.api.system.listToolSets({page_size:1e3,include_tools:!0},{headers:{"X-Scope-OrgID":o}})).data||[]).filter(_=>_.status==="enabled");R(c);const d=t||F.current||{},x={};c.forEach(_=>{const D=d[_.id]||[];x[_.id]=D.filter(me=>(_.tools||[]).some(xe=>xe.name===me))}),j(x)}catch{l.message.error(i("role.loadAiToolsetsError",{defaultValue:"Failed to load AI toolsets."})),R([]),j(t||{})}finally{B(!1)}},[i]),le=o=>o?o.reduce((t,s)=>(!s.toolset_id||!s.tool_name||(t[s.toolset_id]||(t[s.toolset_id]=[]),t[s.toolset_id].includes(s.tool_name)||t[s.toolset_id].push(s.tool_name)),t),{}):{},$=n.useCallback(async o=>{var t;M(!0);try{const s=await b.api.authorization.getRole({id:o}),c=((t=s.permissions)==null?void 0:t.map(D=>D.id))||[];v(c),r.setFieldsValue({permissions:c});const d=s.organization_id||"",x=d?"organization":"global";N(x);const _=le(s.ai_tool_permissions);x==="organization"&&d?await z(d,_):(R([]),j({})),r.setFieldsValue({name:s.name,description:s.description,role_type:x,organization_id:d||void 0,policy_document:JSON.stringify(s.policy_document||{Statement:[]},null,2)})}catch{l.message.error(i("role.detailLoadError",{defaultValue:"Failed to load role details"})),y("/authorization/roles")}finally{M(!1)}},[z,r,y,i]);n.useEffect(()=>{if(h&&f){$(f);return}const o=q||(a.length>0?a[0].id:""),t=S&&o?"organization":"global";N(t),r.setFieldsValue({role_type:t,organization_id:t==="organization"?o:void 0,policy_document:K,permissions:[]}),v([]),j({}),t==="organization"&&o?z(o,{}):R([])},[z,r,f,h,a,q,S,$]);const ie=n.useMemo(()=>g==="global"?P:P.map(t=>{const s=(t.children||[]).filter(c=>c.orgPermission===!0);return{...t,children:s}}).filter(t=>t.children&&t.children.length>0),[P,g]),se=o=>{I(o),O(!1)},ae=()=>{const o=P.map(t=>t.key);I(o),O(!0)},ne=()=>{I([]),O(!1)},re=n.useCallback((o,t)=>{j(s=>({...s,[o]:t}))},[]),ue=n.useCallback((o,t)=>{const s=T.find(d=>d.id===o);if(!s)return;const c=(s.tools||[]).map(d=>d.name);j(d=>({...d,[o]:t?c:[]}))},[T]),de=(o,t)=>{if(g==="organization")return Promise.resolve();if(!t||t.trim()===""||t==="{}"||t==='{"Statement":[]}')return V.length===0?Promise.reject(new Error(i("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."}))):Promise.resolve();try{return JSON.parse(t),Promise.resolve()}catch{return Promise.reject(new Error(i("role.invalidJsonFormat",{defaultValue:"Invalid JSON format."})))}},ce=async o=>{const t={...o};try{g==="global"?t.policy_document=JSON.parse(o.policy_document??"{}"):t.policy_document={Statement:[]},t.role_type==="organization"?t.organization_id=t.organization_id||void 0:t.organization_id=void 0,delete t.role_type;const s=g==="organization"?Object.entries(A).map(([c,d])=>({toolset_id:c,tools:Array.from(new Set(d))})).filter(c=>c.tools.length>0):[];t.ai_tool_permissions=s,t.permissions=V.filter(c=>!c.startsWith("[group]-")),J(!0),h&&f?(await b.api.authorization.updateRole({id:f},t),l.message.success(i("role.updateSuccess",{defaultValue:"Role updated successfully."}))):(await b.api.authorization.createRole(t),l.message.success(i("role.createSuccess",{defaultValue:"Role created successfully."}))),y("/authorization/roles")}catch{l.message.error(i("role.saveError",{defaultValue:"Failed to save role.",action:h?p("update",{defaultValue:"Update"}):p("create",{defaultValue:"Create"})}))}finally{J(!1)}};return e.jsxRuntimeExports.jsx(l.Card,{title:h?i("role.editTitle",{defaultValue:"Edit Role"}):i("role.createTitle",{defaultValue:"Create Role"}),loading:te,children:e.jsxRuntimeExports.jsxs(l.Form,{form:r,layout:"vertical",initialValues:{policy_document:K,permissions:[]},onFinish:ce,children:[e.jsxRuntimeExports.jsx(l.Tabs,{items:[{key:"basic",label:i("role.basicInfo",{defaultValue:"Basic Information"}),children:e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(l.Form.Item,{label:i("role.name",{defaultValue:"Role Name"}),name:"name",rules:[{required:!0,message:i("role.nameRequired",{defaultValue:"Please enter the role name."})}],children:e.jsxRuntimeExports.jsx(l.Input,{placeholder:i("role.namePlaceholder",{defaultValue:"Enter role name"})})}),e.jsxRuntimeExports.jsx(l.Form.Item,{label:i("role.description",{defaultValue:"Description"}),name:"description",children:e.jsxRuntimeExports.jsx(H,{rows:4,placeholder:i("role.descriptionPlaceholder",{defaultValue:"Enter role description"})})}),e.jsxRuntimeExports.jsx(l.Form.Item,{label:i("role.roleType",{defaultValue:"Role Type"}),name:"role_type",hidden:!S,rules:[{required:!0,message:i("role.roleTypeRequired",{defaultValue:"Please select role type."})}],extra:h?i("role.roleTypeCannotChange",{defaultValue:"Role type cannot be changed after creation."}):"",children:e.jsxRuntimeExports.jsxs(l.Radio.Group,{disabled:h,onChange:o=>{const t=o.target.value;if(N(t),t==="global")r.setFieldsValue({organization_id:void 0}),R([]),j({});else{const s=q||(a.length>0?a[0].id:"");r.setFieldsValue({organization_id:s}),s?z(s,F.current):(R([]),j({}))}v([]),r.setFieldsValue({permissions:[]})},children:[e.jsxRuntimeExports.jsx(l.Radio,{value:"global",children:i("role.globalRole",{defaultValue:"Global Role"})}),e.jsxRuntimeExports.jsx(l.Radio,{value:"organization",children:i("role.organizationRole",{defaultValue:"Organization Role"})})]})}),g==="organization"&&e.jsxRuntimeExports.jsx(l.Form.Item,{hidden:!S,label:i("role.organization",{defaultValue:"Organization"}),name:"organization_id",rules:[{required:!0,message:i("role.organizationRequired",{defaultValue:"Please select an organization."})}],extra:a.length>0?i("role.organizationHelp",{defaultValue:"Select the organization this role belongs to"}):i("role.noOrganizationsAvailable",{defaultValue:"No organizations available. Please contact your administrator."}),children:a.length>0?e.jsxRuntimeExports.jsx(l.Select,{placeholder:i("role.selectOrganization",{defaultValue:"Select Organization"}),onChange:o=>{v([]),r.setFieldsValue({permissions:[]});const t=o||"";t?z(t,{}):(R([]),j({}))},children:a.map(o=>e.jsxRuntimeExports.jsx(l.Select.Option,{value:o.id,children:o.name},o.id))}):e.jsxRuntimeExports.jsx(l.Select,{disabled:!0,placeholder:i("role.noOrganizationsAvailable",{defaultValue:"No organizations available"})})})]})},{key:"permissions",label:i("role.permissions",{defaultValue:"Permissions"}),children:e.jsxRuntimeExports.jsx(l.Form.Item,{name:"permissions",rules:[{validator(){if(V.length===0)if(g==="global"){const o=r.getFieldValue("policy_document");if(!o||o.trim()===""||o==="{}"||o==='{"Statement":[]}')return Promise.reject(new Error(i("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."})))}else return Promise.reject(new Error(i("role.permissionRequired",{defaultValue:"Please select at least one permission."})));return Promise.resolve()}}],children:e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",border:"1px solid #d9d9d9",borderRadius:"4px"},children:[e.jsxRuntimeExports.jsxs("span",{className:m.rolePermissionExtra,children:[e.jsxRuntimeExports.jsx(l.Button,{type:"link",onClick:ae,icon:e.jsxRuntimeExports.jsx(E.DownOutlined,{}),children:p("expandAll",{defaultValue:"Expand All"})}),e.jsxRuntimeExports.jsx(l.Button,{type:"link",onClick:ne,icon:e.jsxRuntimeExports.jsx(E.UpOutlined,{}),children:p("collapseAll",{defaultValue:"Collapse All"})})]}),e.jsxRuntimeExports.jsx(l.Tree,{treeData:ie,titleRender:o=>{const t=o,s=typeof t.title=="string"?t.title:String(t.title??"");return e.jsxRuntimeExports.jsx("span",{children:i(`permission.title.${t.code}`,{defaultValue:s})})},checkable:!0,expandedKeys:Y,autoExpandParent:Q,onExpand:se,checkedKeys:V,onCheck:o=>{let t=[];W.isArray(o)?t=o:W.has(o,"checked")&&(t=o.checked),v(t),r.setFieldsValue({permissions:t})}})]})})})},{key:"ai-tools",label:i("role.aiPermissions",{defaultValue:"AI Tool Permissions"}),disabled:g==="global",children:e.jsxRuntimeExports.jsx(l.Spin,{spinning:Z,children:g==="organization"?T.length>0?e.jsxRuntimeExports.jsx(l.Space,{direction:"vertical",size:"middle",style:{width:"100%"},children:T.map(o=>{const t=(o.tools||[]).map(x=>x.name),s=A[o.id]||[],c=t.length>0&&s.length===t.length,d=s.length>0&&s.length<t.length;return e.jsxRuntimeExports.jsx(l.Card,{size:"small",title:e.jsxRuntimeExports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsxRuntimeExports.jsx(l.Checkbox,{checked:c,indeterminate:d,onChange:x=>ue(o.id,x.target.checked)}),e.jsxRuntimeExports.jsx("span",{children:o.name})]}),extra:o.description?e.jsxRuntimeExports.jsx("span",{children:o.description}):void 0,children:(o.tools||[]).length>0?e.jsxRuntimeExports.jsx(l.Checkbox.Group,{style:{width:"100%"},value:A[o.id]||[],onChange:x=>re(o.id,x),children:e.jsxRuntimeExports.jsx(l.Space,{direction:"vertical",style:{width:"100%"},children:(o.tools||[]).map(x=>e.jsxRuntimeExports.jsx(l.Checkbox,{value:x.name,children:e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx("div",{children:x.name}),x.description&&e.jsxRuntimeExports.jsx("div",{style:{color:"rgba(0,0,0,0.45)",fontSize:12},children:x.description})]})},x.name))})}):e.jsxRuntimeExports.jsx(l.Empty,{image:l.Empty.PRESENTED_IMAGE_SIMPLE,description:i("role.aiToolsetNoTools",{defaultValue:"No tools available in this toolset."})})},o.id)})}):e.jsxRuntimeExports.jsx(l.Empty,{image:l.Empty.PRESENTED_IMAGE_SIMPLE,description:i("role.aiToolsetsEmpty",{defaultValue:"No AI toolsets available for this organization."})}):e.jsxRuntimeExports.jsx(l.Empty,{image:l.Empty.PRESENTED_IMAGE_SIMPLE,description:i("role.aiPermissionsGlobalInfo",{defaultValue:"AI tool permissions are only available for organization roles."})})})},{key:"policy",label:i("role.policyDocument",{defaultValue:"Policy Document"}),disabled:g==="organization",children:e.jsxRuntimeExports.jsx(l.Form.Item,{name:"policy_document",rules:[{validator:de}],extra:e.jsxRuntimeExports.jsx("span",{className:m.rolePolicyExtra,children:e.jsxRuntimeExports.jsx(l.Select,{style:{width:160},placeholder:i("role.insertTemplate",{defaultValue:"Insert Template"}),options:[{label:i("role.allowAll",{defaultValue:"Allow All"}),value:"allow_all"},{label:i("role.denyAll",{defaultValue:"Deny All"}),value:"deny_all"},{label:i("role.allowWithAction",{defaultValue:"Allow with Action"}),value:"allow_with_action"},{label:i("role.denyWithCondition",{defaultValue:"Allow with Condition"}),value:"allow_with_condition"},{label:i("role.allowWithUri",{defaultValue:"Allow with URI"}),value:"allow_with_uri"}],onChange:o=>{if(typeof o=="string"){const t=ge[o];t&&r.setFieldValue("policy_document",JSON.stringify(t,null,2))}}})}),children:e.jsxRuntimeExports.jsx(H,{rows:15,style:{fontFamily:"monospace"},placeholder:`{
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "account:EnableRegion",
                "account:DisableRegion"
            ],
            "Condition": {
                "StringEquals": {"id:": "abcdef"}
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "*"
            ]
        }
    ]
}`})})}]}),e.jsxRuntimeExports.jsx(l.Form.Item,{children:e.jsxRuntimeExports.jsxs(l.Space,{children:[e.jsxRuntimeExports.jsx(l.Button,{type:"primary",htmlType:"submit",loading:oe,children:h?p("update",{defaultValue:"Update"}):p("create",{defaultValue:"Create"})}),e.jsxRuntimeExports.jsx(l.Button,{onClick:()=>y("/authorization/roles"),children:p("cancel",{defaultValue:"Cancel"})})]})})]})})},Re=Object.freeze(Object.defineProperty({__proto__:null,default:Ee},Symbol.toStringTag,{value:"Module"}));exports.RoleForm=Re;exports.RoleList=he;
