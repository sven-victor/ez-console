"use strict";const e=require("./vendor.js"),n=require("react"),o=require("antd"),E=require("@ant-design/icons"),w=require("./components.js"),S=require("./index.js"),T=require("react-i18next"),D=require("./contexts.js"),N=require("react-router-dom"),$=require("lodash"),me=require("antd-style"),xe=()=>{const{t:u}=T.useTranslation("authorization"),{t:i}=T.useTranslation("common"),{siteConfig:p}=D.useSite(),y=N.useNavigate(),f=n.useRef(null),h=r=>{y(`/authorization/roles/${r}/edit`)},c=async r=>{var a,m;try{await S.api.authorization.deleteRole({id:r}),o.message.success(u("role.deleteSuccess",{defaultValue:"Role deleted successfully."})),(m=(a=f.current)==null?void 0:a.reload)==null||m.call(a)}catch(_){o.message.error(u("role.deleteError",{defaultValue:"Failed to delete role: {{error}}",error:_}))}},v=[{title:u("role.name",{defaultValue:"Role Name"}),dataIndex:"name",key:"name",render:r=>e.jsxRuntimeExports.jsxs(o.Space,{children:[e.jsxRuntimeExports.jsx(E.UserOutlined,{}),r]})},{title:u("role.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:u("role.organization",{defaultValue:"Organization"}),key:"organization",hidden:!(p!=null&&p.enable_multi_org),render:(r,a)=>{var m;return a.organization_id?e.jsxRuntimeExports.jsx(o.Tag,{icon:e.jsxRuntimeExports.jsx(E.TeamOutlined,{}),color:"blue",children:((m=a.organization)==null?void 0:m.name)||a.organization_id}):e.jsxRuntimeExports.jsx(o.Tag,{color:"default",children:u("role.global",{defaultValue:"Global"})})}},{title:u("role.permissionCount",{defaultValue:"Permissions"}),key:"permission_count",render:(r,a)=>{var m;return e.jsxRuntimeExports.jsxs(o.Tag,{color:"blue",children:[e.jsxRuntimeExports.jsx(E.LockOutlined,{})," ",((m=a.permissions)==null?void 0:m.length)||0]})}},{title:u("role.createdAt",{defaultValue:"Created At"}),dataIndex:"created_at",key:"created_at",render:r=>new Date(r).toLocaleString()},{title:i("actions",{defaultValue:"Actions"}),key:"action",render:(r,a)=>e.jsxRuntimeExports.jsxs(o.Space,{size:"small",children:[e.jsxRuntimeExports.jsx(w.PermissionGuard,{permission:"authorization:role:update",children:e.jsxRuntimeExports.jsx(o.Tooltip,{title:u("role.edit",{defaultValue:"Edit Role"}),children:e.jsxRuntimeExports.jsx(o.Button,{type:"text",size:"small",icon:e.jsxRuntimeExports.jsx(E.EditOutlined,{}),onClick:()=>h(a.id)})})}),e.jsxRuntimeExports.jsx(w.PermissionGuard,{permission:"authorization:role:delete",children:e.jsxRuntimeExports.jsx(o.Tooltip,{title:u("role.delete",{defaultValue:"Delete Role"}),children:e.jsxRuntimeExports.jsx(o.Popconfirm,{title:u("role.deleteConfirm",{defaultValue:"Are you sure you want to delete this role?"}),onConfirm:()=>c(a.id),okText:i("confirm",{defaultValue:"Confirm"}),cancelText:i("cancel",{defaultValue:"Cancel"}),children:e.jsxRuntimeExports.jsx(o.Button,{type:"text",size:"small",danger:!0,icon:e.jsxRuntimeExports.jsx(E.DeleteOutlined,{})})})})})]})}];return e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsxs(o.Card,{style:{marginBottom:16},children:[e.jsxRuntimeExports.jsx("div",{style:{marginBottom:16},children:e.jsxRuntimeExports.jsxs(o.Row,{justify:"space-between",align:"middle",gutter:16,children:[e.jsxRuntimeExports.jsx(o.Col,{children:e.jsxRuntimeExports.jsx(o.Space,{children:e.jsxRuntimeExports.jsx(o.Button,{type:"primary",onClick:()=>{var r,a;(a=(r=f.current)==null?void 0:r.reload)==null||a.call(r)},icon:e.jsxRuntimeExports.jsx(E.ReloadOutlined,{}),children:i("refresh",{defaultValue:"Refresh"})})})}),e.jsxRuntimeExports.jsx(o.Col,{children:e.jsxRuntimeExports.jsx(w.PermissionGuard,{permission:"authorization:role:create",children:e.jsxRuntimeExports.jsx(o.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(E.PlusOutlined,{}),onClick:()=>y("/authorization/roles/create"),children:u("role.create",{defaultValue:"Create Role"})})})})]})}),e.jsxRuntimeExports.jsx(w.Table,{request:async({page_size:r,current:a})=>S.api.authorization.listRoles({current:a,page_size:r}),columns:v,actionRef:f})]})})},pe=Object.freeze(Object.defineProperty({__proto__:null,default:xe},Symbol.toStringTag,{value:"Module"})),{TextArea:W}=o.Input,fe=me.createStyles(({css:u})=>({rolePermissionExtra:u`
      float: right;
      z-index: 1001;
      position: sticky;
    `,rolePolicyExtra:u`
      position: absolute;
      right: 5px;
      top: 5px;
    `})),he={allow_all:{policy:{Statement:[{Effect:"Allow",Action:["*"]}]}},deny_all:{Statement:[{Effect:"Deny",Action:["*"]}]},allow_with_action:{Statement:[{Effect:"Allow",Action:["authorization:user:view"]}]},allow_with_condition:{Statement:[{Effect:"Allow",Action:["authorization:user:update"],Condition:{StringEquals:{"id:":"abcdef"}}},{Effect:"Deny",Action:["*"]}]},allow_with_uri:{Statement:[{Effect:"Allow",Action:["authorization:user:view"],Condition:{StringEquals:{"http.uri":"/api/users/abcdef","http.method":"GET"}}},{Effect:"Deny",Action:["*"]}]}},H=JSON.stringify({Statement:[]},null,2),je=()=>{const{styles:u}=fe(),{t:i}=T.useTranslation("authorization"),{t:p}=T.useTranslation("common"),y=N.useNavigate(),{id:f}=N.useParams(),h=!!f,{siteConfig:c}=D.useSite(),{user:v}=D.useAuth(),r=(v==null?void 0:v.organizations)||[],[a]=o.Form.useForm(),[m,_]=n.useState([]),[A,K]=n.useState([]),[X,I]=n.useState([]),[Y,O]=n.useState(!0),[L,R]=n.useState([]),[P,g]=n.useState({}),C=n.useRef({}),[Q,G]=n.useState(!1),[j,k]=n.useState("global"),[F,Z]=n.useState(void 0),[ee,B]=n.useState(!1),[te,M]=n.useState(!1);n.useEffect(()=>{C.current=P},[P]),n.useEffect(()=>{Z(localStorage.getItem("orgID")||void 0)},[]);const J=n.useCallback(async()=>{try{const l=await S.api.authorization.listPermissions();K(l.map((t,s)=>{const d=(t.permissions||[]).map(x=>({key:x.id,code:x.code.replace(/:/g,"."),title:x.name,orgPermission:x.org_permission||!1}));return{key:`[group]-${s}`,title:t.name,code:t.name.replace(/ /g,"_"),children:d}}))}catch{o.message.error(i("role.loadError",{defaultValue:"Failed to load role list"}))}},[i]);n.useEffect(()=>{J()},[J]);const V=n.useCallback(async(l,t)=>{if(!l){R([]),g(t||{});return}G(!0);try{const d=((await S.api.system.listToolSets({page_size:1e3,include_tools:!0},{headers:{"X-Scope-OrgID":l}})).data||[]).filter(b=>b.status==="enabled");R(d);const x=t||C.current||{},z={};d.forEach(b=>{const q=x[b.id]||[];z[b.id]=q.filter(de=>(b.tools||[]).some(ce=>ce.name===de))}),g(z)}catch{o.message.error(i("role.loadAiToolsetsError",{defaultValue:"Failed to load AI toolsets."})),R([]),g(t||{})}finally{G(!1)}},[i]),oe=l=>l?l.reduce((t,s)=>(!s.toolset_id||!s.tool_name||(t[s.toolset_id]||(t[s.toolset_id]=[]),t[s.toolset_id].includes(s.tool_name)||t[s.toolset_id].push(s.tool_name)),t),{}):{},U=n.useCallback(async l=>{var t;B(!0);try{const s=await S.api.authorization.getRole({id:l}),d=((t=s.permissions)==null?void 0:t.map(q=>q.id))||[];_(d),a.setFieldsValue({permissions:d});const x=s.organization_id||"",z=x?"organization":"global";k(z);const b=oe(s.ai_tool_permissions);z==="organization"&&x?await V(x,b):(R([]),g({})),a.setFieldsValue({name:s.name,description:s.description,role_type:z,organization_id:x||void 0,policy_document:JSON.stringify(s.policy_document||{Statement:[]},null,2)})}catch{o.message.error(i("role.detailLoadError",{defaultValue:"Failed to load role details"})),y("/authorization/roles")}finally{B(!1)}},[V,a,y,i]);n.useEffect(()=>{if(h&&f){U(f);return}const l=F||(r.length>0?r[0].id:""),t=c!=null&&c.enable_multi_org&&l?"organization":"global";k(t),a.setFieldsValue({role_type:t,organization_id:t==="organization"?l:void 0,policy_document:H,permissions:[]}),_([]),g({}),t==="organization"&&l?V(l,{}):R([])},[V,a,f,h,r,F,c==null?void 0:c.enable_multi_org,U]);const le=n.useMemo(()=>j==="global"?A:A.map(t=>{const s=(t.children||[]).filter(d=>d.orgPermission===!0);return{...t,children:s}}).filter(t=>t.children&&t.children.length>0),[A,j]),ie=l=>{I(l),O(!1)},se=()=>{const l=A.map(t=>t.key);I(l),O(!0)},ae=()=>{I([]),O(!1)},re=n.useCallback((l,t)=>{g(s=>({...s,[l]:t}))},[]),ne=(l,t)=>{if(j==="organization")return Promise.resolve();if(!t||t.trim()===""||t==="{}"||t==='{"Statement":[]}')return m.length===0?Promise.reject(new Error(i("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."}))):Promise.resolve();try{return JSON.parse(t),Promise.resolve()}catch{return Promise.reject(new Error(i("role.invalidJsonFormat",{defaultValue:"Invalid JSON format."})))}},ue=async l=>{const t={...l};try{j==="global"?t.policy_document=JSON.parse(l.policy_document??"{}"):t.policy_document={Statement:[]},t.role_type==="organization"?t.organization_id=t.organization_id||void 0:t.organization_id=void 0,delete t.role_type;const s=j==="organization"?Object.entries(P).map(([d,x])=>({toolset_id:d,tools:Array.from(new Set(x))})).filter(d=>d.tools.length>0):[];t.ai_tool_permissions=s,t.permissions=m.filter(d=>!d.startsWith("[group]-")),M(!0),h&&f?(await S.api.authorization.updateRole({id:f},t),o.message.success(i("role.updateSuccess",{defaultValue:"Role updated successfully."}))):(await S.api.authorization.createRole(t),o.message.success(i("role.createSuccess",{defaultValue:"Role created successfully."}))),y("/authorization/roles")}catch{o.message.error(i("role.saveError",{defaultValue:"Failed to save role.",action:h?p("update",{defaultValue:"Update"}):p("create",{defaultValue:"Create"})}))}finally{M(!1)}};return e.jsxRuntimeExports.jsx(o.Card,{title:h?i("role.editTitle",{defaultValue:"Edit Role"}):i("role.createTitle",{defaultValue:"Create Role"}),loading:ee,children:e.jsxRuntimeExports.jsxs(o.Form,{form:a,layout:"vertical",initialValues:{policy_document:H,permissions:[]},onFinish:ue,children:[e.jsxRuntimeExports.jsx(o.Tabs,{items:[{key:"basic",label:i("role.basicInfo",{defaultValue:"Basic Information"}),children:e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(o.Form.Item,{label:i("role.name",{defaultValue:"Role Name"}),name:"name",rules:[{required:!0,message:i("role.nameRequired",{defaultValue:"Please enter the role name."})}],children:e.jsxRuntimeExports.jsx(o.Input,{placeholder:i("role.namePlaceholder",{defaultValue:"Enter role name"})})}),e.jsxRuntimeExports.jsx(o.Form.Item,{label:i("role.description",{defaultValue:"Description"}),name:"description",children:e.jsxRuntimeExports.jsx(W,{rows:4,placeholder:i("role.descriptionPlaceholder",{defaultValue:"Enter role description"})})}),e.jsxRuntimeExports.jsx(o.Form.Item,{label:i("role.roleType",{defaultValue:"Role Type"}),name:"role_type",hidden:!(c!=null&&c.enable_multi_org),rules:[{required:!0,message:i("role.roleTypeRequired",{defaultValue:"Please select role type."})}],extra:h?i("role.roleTypeCannotChange",{defaultValue:"Role type cannot be changed after creation."}):"",children:e.jsxRuntimeExports.jsxs(o.Radio.Group,{disabled:h,onChange:l=>{const t=l.target.value;if(k(t),t==="global")a.setFieldsValue({organization_id:void 0}),R([]),g({});else{const s=F||(r.length>0?r[0].id:"");a.setFieldsValue({organization_id:s}),s?V(s,C.current):(R([]),g({}))}_([]),a.setFieldsValue({permissions:[]})},children:[e.jsxRuntimeExports.jsx(o.Radio,{value:"global",children:i("role.globalRole",{defaultValue:"Global Role"})}),e.jsxRuntimeExports.jsx(o.Radio,{value:"organization",children:i("role.organizationRole",{defaultValue:"Organization Role"})})]})}),j==="organization"&&e.jsxRuntimeExports.jsx(o.Form.Item,{hidden:!(c!=null&&c.enable_multi_org),label:i("role.organization",{defaultValue:"Organization"}),name:"organization_id",rules:[{required:!0,message:i("role.organizationRequired",{defaultValue:"Please select an organization."})}],extra:r.length>0?i("role.organizationHelp",{defaultValue:"Select the organization this role belongs to"}):i("role.noOrganizationsAvailable",{defaultValue:"No organizations available. Please contact your administrator."}),children:r.length>0?e.jsxRuntimeExports.jsx(o.Select,{placeholder:i("role.selectOrganization",{defaultValue:"Select Organization"}),onChange:l=>{_([]),a.setFieldsValue({permissions:[]});const t=l||"";t?V(t,{}):(R([]),g({}))},children:r.map(l=>e.jsxRuntimeExports.jsx(o.Select.Option,{value:l.id,children:l.name},l.id))}):e.jsxRuntimeExports.jsx(o.Select,{disabled:!0,placeholder:i("role.noOrganizationsAvailable",{defaultValue:"No organizations available"})})})]})},{key:"permissions",label:i("role.permissions",{defaultValue:"Permissions"}),children:e.jsxRuntimeExports.jsx(o.Form.Item,{name:"permissions",rules:[{validator(){if(m.length===0)if(j==="global"){const l=a.getFieldValue("policy_document");if(!l||l.trim()===""||l==="{}"||l==='{"Statement":[]}')return Promise.reject(new Error(i("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."})))}else return Promise.reject(new Error(i("role.permissionRequired",{defaultValue:"Please select at least one permission."})));return Promise.resolve()}}],children:e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",border:"1px solid #d9d9d9",borderRadius:"4px"},children:[e.jsxRuntimeExports.jsxs("span",{className:u.rolePermissionExtra,children:[e.jsxRuntimeExports.jsx(o.Button,{type:"link",onClick:se,icon:e.jsxRuntimeExports.jsx(E.DownOutlined,{}),children:p("expandAll",{defaultValue:"Expand All"})}),e.jsxRuntimeExports.jsx(o.Button,{type:"link",onClick:ae,icon:e.jsxRuntimeExports.jsx(E.UpOutlined,{}),children:p("collapseAll",{defaultValue:"Collapse All"})})]}),e.jsxRuntimeExports.jsx(o.Tree,{treeData:le,titleRender:l=>{const t=l,s=typeof t.title=="string"?t.title:String(t.title??"");return e.jsxRuntimeExports.jsx("span",{children:i(`permission.title.${t.code}`,{defaultValue:s})})},checkable:!0,expandedKeys:X,autoExpandParent:Y,onExpand:ie,checkedKeys:m,onCheck:l=>{let t=[];$.isArray(l)?t=l:$.has(l,"checked")&&(t=l.checked),_(t),a.setFieldsValue({permissions:t})}})]})})})},{key:"ai-tools",label:i("role.aiPermissions",{defaultValue:"AI Tool Permissions"}),disabled:j==="global",children:e.jsxRuntimeExports.jsx(o.Spin,{spinning:Q,children:j==="organization"?L.length>0?e.jsxRuntimeExports.jsx(o.Space,{direction:"vertical",size:"middle",style:{width:"100%"},children:L.map(l=>e.jsxRuntimeExports.jsx(o.Card,{size:"small",title:l.name,extra:l.description?e.jsxRuntimeExports.jsx("span",{children:l.description}):void 0,children:(l.tools||[]).length>0?e.jsxRuntimeExports.jsx(o.Checkbox.Group,{style:{width:"100%"},value:P[l.id]||[],onChange:t=>re(l.id,t),children:e.jsxRuntimeExports.jsx(o.Space,{direction:"vertical",style:{width:"100%"},children:(l.tools||[]).map(t=>e.jsxRuntimeExports.jsx(o.Checkbox,{value:t.name,children:e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx("div",{children:t.name}),t.description&&e.jsxRuntimeExports.jsx("div",{style:{color:"rgba(0,0,0,0.45)",fontSize:12},children:t.description})]})},t.name))})}):e.jsxRuntimeExports.jsx(o.Empty,{image:o.Empty.PRESENTED_IMAGE_SIMPLE,description:i("role.aiToolsetNoTools",{defaultValue:"No tools available in this toolset."})})},l.id))}):e.jsxRuntimeExports.jsx(o.Empty,{image:o.Empty.PRESENTED_IMAGE_SIMPLE,description:i("role.aiToolsetsEmpty",{defaultValue:"No AI toolsets available for this organization."})}):e.jsxRuntimeExports.jsx(o.Empty,{image:o.Empty.PRESENTED_IMAGE_SIMPLE,description:i("role.aiPermissionsGlobalInfo",{defaultValue:"AI tool permissions are only available for organization roles."})})})},{key:"policy",label:i("role.policyDocument",{defaultValue:"Policy Document"}),disabled:j==="organization",children:e.jsxRuntimeExports.jsx(o.Form.Item,{name:"policy_document",rules:[{validator:ne}],extra:e.jsxRuntimeExports.jsx("span",{className:u.rolePolicyExtra,children:e.jsxRuntimeExports.jsx(o.Select,{style:{width:160},placeholder:i("role.insertTemplate",{defaultValue:"Insert Template"}),options:[{label:i("role.allowAll",{defaultValue:"Allow All"}),value:"allow_all"},{label:i("role.denyAll",{defaultValue:"Deny All"}),value:"deny_all"},{label:i("role.allowWithAction",{defaultValue:"Allow with Action"}),value:"allow_with_action"},{label:i("role.denyWithCondition",{defaultValue:"Allow with Condition"}),value:"allow_with_condition"},{label:i("role.allowWithUri",{defaultValue:"Allow with URI"}),value:"allow_with_uri"}],onChange:l=>{if(typeof l=="string"){const t=he[l];t&&a.setFieldValue("policy_document",JSON.stringify(t,null,2))}}})}),children:e.jsxRuntimeExports.jsx(W,{rows:15,style:{fontFamily:"monospace"},placeholder:`{
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "account:EnableRegion",
                "account:DisableRegion"
            ],
            "Condition": {
                "StringEquals": {"id:": "abcdef"}
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "*"
            ]
        }
    ]
}`})})}]}),e.jsxRuntimeExports.jsx(o.Form.Item,{children:e.jsxRuntimeExports.jsxs(o.Space,{children:[e.jsxRuntimeExports.jsx(o.Button,{type:"primary",htmlType:"submit",loading:te,children:h?p("update",{defaultValue:"Update"}):p("create",{defaultValue:"Create"})}),e.jsxRuntimeExports.jsx(o.Button,{onClick:()=>y("/authorization/roles"),children:p("cancel",{defaultValue:"Cancel"})})]})})]})})},ge=Object.freeze(Object.defineProperty({__proto__:null,default:je},Symbol.toStringTag,{value:"Module"}));exports.RoleForm=ge;exports.RoleList=pe;
