"use strict";const e=require("./vendor.js"),a=require("react"),o=require("antd"),y=require("@ant-design/icons"),I=require("./components.js"),_=require("./index.js"),F=require("react-i18next"),O=require("./contexts.js"),M=require("react-router-dom"),K=require("lodash-es"),ge=require("antd-style"),ye=()=>{const{t:r}=F.useTranslation("authorization"),{t:V}=F.useTranslation("common"),{siteConfig:s}=O.useSite(),h=M.useNavigate(),R=a.useRef(null),E=d=>{h(`/authorization/roles/${d}/edit`)},f=async d=>{var n,c;try{await _.api.authorization.deleteRole({id:d}),o.message.success(r("role.deleteSuccess",{defaultValue:"Role deleted successfully."})),(c=(n=R.current)==null?void 0:n.reload)==null||c.call(n)}catch(p){o.message.error(r("role.deleteError",{defaultValue:"Failed to delete role: {{error}}",error:p}))}},z=[{title:r("role.name",{defaultValue:"Role Name"}),dataIndex:"name",key:"name",render:d=>e.jsxRuntimeExports.jsxs(o.Space,{children:[e.jsxRuntimeExports.jsx(y.UserOutlined,{}),d]})},{title:r("role.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:r("role.roleType",{defaultValue:"Role Type"}),key:"role_type",render:(d,n)=>n.role_type==="system"?e.jsxRuntimeExports.jsx(o.Tag,{color:"orange",children:r("role.typeSystem",{defaultValue:"System"})}):e.jsxRuntimeExports.jsx(o.Tag,{color:"default",children:r("role.typeUser",{defaultValue:"User"})})},{title:r("role.organization",{defaultValue:"Organization"}),key:"organization",hidden:!(s!=null&&s.enable_multi_org),render:(d,n)=>{var c;return n.organization_id?e.jsxRuntimeExports.jsx(o.Tag,{icon:e.jsxRuntimeExports.jsx(y.TeamOutlined,{}),color:"blue",children:((c=n.organization)==null?void 0:c.name)||n.organization_id}):e.jsxRuntimeExports.jsx(o.Tag,{color:"default",children:r("role.global",{defaultValue:"Global"})})}},{title:r("role.permissionCount",{defaultValue:"Permissions"}),key:"permission_count",render:(d,n)=>{var c;return e.jsxRuntimeExports.jsxs(o.Tag,{color:"blue",children:[e.jsxRuntimeExports.jsx(y.LockOutlined,{})," ",((c=n.permissions)==null?void 0:c.length)||0]})}},{title:r("role.createdAt",{defaultValue:"Created At"}),dataIndex:"created_at",key:"created_at",render:d=>new Date(d).toLocaleString()},{title:V("actions",{defaultValue:"Actions"}),key:"action",render:(d,n)=>{const c=n.role_type==="system";return e.jsxRuntimeExports.jsxs(o.Space,{size:"small",children:[!c&&e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(I.PermissionGuard,{permission:"authorization:role:update",children:e.jsxRuntimeExports.jsx(o.Tooltip,{title:r("role.edit",{defaultValue:"Edit Role"}),children:e.jsxRuntimeExports.jsx(o.Button,{type:"text",size:"small",icon:e.jsxRuntimeExports.jsx(y.EditOutlined,{}),onClick:()=>E(n.id)})})}),e.jsxRuntimeExports.jsx(I.PermissionGuard,{permission:"authorization:role:delete",children:e.jsxRuntimeExports.jsx(o.Tooltip,{title:r("role.delete",{defaultValue:"Delete Role"}),children:e.jsxRuntimeExports.jsx(o.Popconfirm,{title:r("role.deleteConfirm",{defaultValue:"Are you sure you want to delete this role?"}),onConfirm:()=>f(n.id),okText:V("confirm",{defaultValue:"Confirm"}),cancelText:V("cancel",{defaultValue:"Cancel"}),children:e.jsxRuntimeExports.jsx(o.Button,{type:"text",size:"small",danger:!0,icon:e.jsxRuntimeExports.jsx(y.DeleteOutlined,{})})})})})]}),c&&e.jsxRuntimeExports.jsx(o.Tooltip,{title:r("role.systemRoleCannotModify",{defaultValue:"System roles cannot be modified."}),children:e.jsxRuntimeExports.jsx("span",{children:e.jsxRuntimeExports.jsx(o.Button,{type:"text",size:"small",icon:e.jsxRuntimeExports.jsx(y.LockOutlined,{}),disabled:!0})})})]})}}];return e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsxs(o.Card,{style:{marginBottom:16},children:[e.jsxRuntimeExports.jsx("div",{style:{marginBottom:16},children:e.jsxRuntimeExports.jsxs(o.Row,{justify:"space-between",align:"middle",gutter:16,children:[e.jsxRuntimeExports.jsx(o.Col,{children:e.jsxRuntimeExports.jsx(o.Space,{children:e.jsxRuntimeExports.jsx(o.Button,{type:"primary",onClick:()=>{var d,n;(n=(d=R.current)==null?void 0:d.reload)==null||n.call(d)},icon:e.jsxRuntimeExports.jsx(y.ReloadOutlined,{}),children:V("refresh",{defaultValue:"Refresh"})})})}),e.jsxRuntimeExports.jsx(o.Col,{children:e.jsxRuntimeExports.jsx(I.PermissionGuard,{permission:"authorization:role:create",children:e.jsxRuntimeExports.jsx(o.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(y.PlusOutlined,{}),onClick:()=>h("/authorization/roles/create"),children:r("role.create",{defaultValue:"Create Role"})})})})]})}),e.jsxRuntimeExports.jsx(I.Table,{request:async({page_size:d,current:n})=>_.api.authorization.listRoles({current:n,page_size:d}),columns:z,actionRef:R})]})})},Re=Object.freeze(Object.defineProperty({__proto__:null,default:ye},Symbol.toStringTag,{value:"Module"})),{TextArea:X}=o.Input,Ee=ge.createStyles(({css:r})=>({rolePermissionExtra:r`
      float: right;
      z-index: 1001;
      position: sticky;
    `,rolePolicyExtra:r`
      position: absolute;
      right: 5px;
      top: 5px;
    `})),be={allow_all:{policy:{Statement:[{Effect:"Allow",Action:["*"]}]}},deny_all:{Statement:[{Effect:"Deny",Action:["*"]}]},allow_with_action:{Statement:[{Effect:"Allow",Action:["authorization:user:view"]}]},allow_with_condition:{Statement:[{Effect:"Allow",Action:["authorization:user:update"],Condition:{StringEquals:{"id:":"abcdef"}}},{Effect:"Deny",Action:["*"]}]},allow_with_uri:{Statement:[{Effect:"Allow",Action:["authorization:user:view"],Condition:{StringEquals:{"http.uri":"/api/users/abcdef","http.method":"GET"}}},{Effect:"Deny",Action:["*"]}]}},Y=JSON.stringify({Statement:[]},null,2),Se=()=>{const{styles:r}=Ee(),{hasGlobalPermission:V}=O.usePermission(),{t:s}=F.useTranslation("authorization"),{t:h}=F.useTranslation("common"),R=M.useNavigate(),{id:E}=M.useParams(),f=!!E,{enableMultiOrg:z,currentOrgId:d}=O.useSite(),{user:n}=O.useAuth(),c=(n==null?void 0:n.organizations)||[],[p]=o.Form.useForm(),[P,T]=a.useState([]),[w,Q]=a.useState([]),[Z,N]=a.useState([]),[ee,q]=a.useState(!0),[C,b]=a.useState([]),[A,j]=a.useState({}),D=a.useRef({}),[te,U]=a.useState(!1),[g,L]=a.useState("global"),[G,oe]=a.useState(void 0),[le,J]=a.useState(!1),[se,$]=a.useState(!1),[ie,ne]=a.useState(!1);a.useEffect(()=>{D.current=A},[A]),a.useEffect(()=>{oe(d||void 0)},[]);const W=a.useCallback(async()=>{try{const l=await _.api.authorization.listPermissions();Q(l.map((t,i)=>{const m=(t.permissions||[]).map(u=>({key:u.id,code:u.code.replace(/:/g,"."),title:u.name,orgPermission:u.org_permission||!1}));return{key:`[group]-${i}`,title:t.name,code:t.name.replace(/ /g,"_"),children:m}}))}catch{o.message.error(s("role.loadError",{defaultValue:"Failed to load role list"}))}},[s]);a.useEffect(()=>{W()},[W]);const v=a.useCallback(async(l,t)=>{if(!l){b([]),j(t||{});return}U(!0);try{const m=((await _.api.system.listToolSets({page_size:1e3,include_tools:!0},{headers:{"X-Scope-OrgID":l}})).data||[]).filter(S=>S.status==="enabled");b(m);const u=t||D.current||{},x={};m.forEach(S=>{const B=u[S.id]||[];x[S.id]=B.filter(he=>(S.tools||[]).some(je=>je.name===he))}),j(x)}catch{o.message.error(s("role.loadAiToolsetsError",{defaultValue:"Failed to load AI toolsets."})),b([]),j(t||{})}finally{U(!1)}},[s]),ae=l=>l?l.reduce((t,i)=>(!i.toolset_id||!i.tool_name||(t[i.toolset_id]||(t[i.toolset_id]=[]),t[i.toolset_id].includes(i.tool_name)||t[i.toolset_id].push(i.tool_name)),t),{}):{},H=a.useCallback(async l=>{var t;J(!0);try{const i=await _.api.authorization.getRole({id:l});ne(i.role_type==="system");const m=((t=i.permissions)==null?void 0:t.map(B=>B.id))||[];T(m),p.setFieldsValue({permissions:m});const u=i.organization_id||"",x=u?"organization":"global";L(x);const S=ae(i.ai_tool_permissions);x==="organization"&&u?await v(u,S):(b([]),j({})),p.setFieldsValue({name:i.name,description:i.description,role_type:x,organization_id:u||void 0,policy_document:JSON.stringify(i.policy_document||{Statement:[]},null,2)})}catch{o.message.error(s("role.detailLoadError",{defaultValue:"Failed to load role details"})),R("/authorization/roles")}finally{J(!1)}},[v,p,R,s]);a.useEffect(()=>{if(f&&E){H(E);return}const l=G||(c.length>0?c[0].id:""),t=z&&l?"organization":"global";L(t),p.setFieldsValue({role_type:t,organization_id:t==="organization"?l:void 0,policy_document:Y,permissions:[]}),T([]),j({}),t==="organization"&&l?v(l,{}):b([])},[v,p,E,f,c,G,z,H]);const re=a.useMemo(()=>g==="global"?w:w.map(t=>{const i=(t.children||[]).filter(m=>m.orgPermission===!0);return{...t,children:i}}).filter(t=>t.children&&t.children.length>0),[w,g]),ue=l=>{N(l),q(!1)},de=()=>{const l=w.map(t=>t.key);N(l),q(!0)},ce=()=>{N([]),q(!1)},me=a.useCallback((l,t)=>{j(i=>({...i,[l]:t}))},[]),xe=a.useCallback((l,t)=>{const i=C.find(u=>u.id===l);if(!i)return;const m=(i.tools||[]).map(u=>u.name);j(u=>({...u,[l]:t?m:[]}))},[C]),pe=(l,t)=>{if(g==="organization")return Promise.resolve();if(!t||t.trim()===""||t==="{}"||t==='{"Statement":[]}')return P.length===0?Promise.reject(new Error(s("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."}))):Promise.resolve();try{return JSON.parse(t),Promise.resolve()}catch{return Promise.reject(new Error(s("role.invalidJsonFormat",{defaultValue:"Invalid JSON format."})))}},fe=async l=>{const t={...l};try{g==="global"?t.policy_document=JSON.parse(l.policy_document??"{}"):t.policy_document={Statement:[]},t.role_type==="organization"?t.organization_id=t.organization_id||void 0:t.organization_id=void 0,delete t.role_type;const i=g==="organization"?Object.entries(A).map(([m,u])=>({toolset_id:m,tools:Array.from(new Set(u))})).filter(m=>m.tools.length>0):[];t.ai_tool_permissions=i,t.permissions=P.filter(m=>!m.startsWith("[group]-")),$(!0),f&&E?(await _.api.authorization.updateRole({id:E},t),o.message.success(s("role.updateSuccess",{defaultValue:"Role updated successfully."}))):(await _.api.authorization.createRole(t),o.message.success(s("role.createSuccess",{defaultValue:"Role created successfully."}))),R("/authorization/roles")}catch(i){o.message.error(s("role.saveError",{error:i instanceof Error?i.message:"Unknown error",defaultValue:"Failed to save role.",action:f?h("update",{defaultValue:"Update"}):h("create",{defaultValue:"Create"})}))}finally{$(!1)}},k=f&&ie;return e.jsxRuntimeExports.jsxs(o.Card,{title:k?s("role.viewTitle",{defaultValue:"View Role"}):f?s("role.editTitle",{defaultValue:"Edit Role"}):s("role.createTitle",{defaultValue:"Create Role"}),loading:le,children:[k&&e.jsxRuntimeExports.jsx(o.Alert,{type:"info",message:s("role.systemRoleCannotModify",{defaultValue:"System roles cannot be modified."}),style:{marginBottom:16},showIcon:!0}),e.jsxRuntimeExports.jsxs(o.Form,{form:p,layout:"vertical",disabled:k,initialValues:{policy_document:Y,permissions:[]},onFinish:fe,children:[e.jsxRuntimeExports.jsx(o.Tabs,{items:[{key:"basic",label:s("role.basicInfo",{defaultValue:"Basic Information"}),children:e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(o.Form.Item,{label:s("role.name",{defaultValue:"Role Name"}),name:"name",rules:[{required:!0,message:s("role.nameRequired",{defaultValue:"Please enter the role name."})}],children:e.jsxRuntimeExports.jsx(o.Input,{placeholder:s("role.namePlaceholder",{defaultValue:"Enter role name"})})}),e.jsxRuntimeExports.jsx(o.Form.Item,{label:s("role.description",{defaultValue:"Description"}),name:"description",children:e.jsxRuntimeExports.jsx(X,{rows:4,placeholder:s("role.descriptionPlaceholder",{defaultValue:"Enter role description"})})}),e.jsxRuntimeExports.jsx(o.Form.Item,{label:s("role.roleType",{defaultValue:"Role Type"}),name:"role_type",hidden:!z,rules:[{required:!0,message:s("role.roleTypeRequired",{defaultValue:"Please select role type."})}],extra:f?s("role.roleTypeCannotChange",{defaultValue:"Role type cannot be changed after creation."}):"",children:e.jsxRuntimeExports.jsxs(o.Radio.Group,{disabled:f||!V("authorization:role:create"),onChange:l=>{const t=l.target.value;if(L(t),t==="global")p.setFieldsValue({organization_id:void 0}),b([]),j({});else{const i=G||(c.length>0?c[0].id:"");p.setFieldsValue({organization_id:i}),i?v(i,D.current):(b([]),j({}))}T([]),p.setFieldsValue({permissions:[]})},children:[e.jsxRuntimeExports.jsx(o.Radio,{value:"global",children:s("role.globalRole",{defaultValue:"Global Role"})}),e.jsxRuntimeExports.jsx(o.Radio,{value:"organization",children:s("role.organizationRole",{defaultValue:"Organization Role"})})]})}),g==="organization"&&e.jsxRuntimeExports.jsx(o.Form.Item,{hidden:!z,label:s("role.organization",{defaultValue:"Organization"}),name:"organization_id",rules:[{required:!0,message:s("role.organizationRequired",{defaultValue:"Please select an organization."})}],extra:c.length>0?s("role.organizationHelp",{defaultValue:"Select the organization this role belongs to"}):s("role.noOrganizationsAvailable",{defaultValue:"No organizations available. Please contact your administrator."}),children:c.length>0?e.jsxRuntimeExports.jsx(o.Select,{placeholder:s("role.selectOrganization",{defaultValue:"Select Organization"}),onChange:l=>{T([]),p.setFieldsValue({permissions:[]});const t=l||"";t?v(t,{}):(b([]),j({}))},children:c.map(l=>e.jsxRuntimeExports.jsx(o.Select.Option,{value:l.id,children:l.name},l.id))}):e.jsxRuntimeExports.jsx(o.Select,{disabled:!0,placeholder:s("role.noOrganizationsAvailable",{defaultValue:"No organizations available"})})})]})},{key:"permissions",label:s("role.permissions",{defaultValue:"Permissions"}),children:e.jsxRuntimeExports.jsx(o.Form.Item,{name:"permissions",rules:[{validator(){if(P.length===0)if(g==="global"){const l=p.getFieldValue("policy_document");if(!l||l.trim()===""||l==="{}"||l==='{"Statement":[]}')return Promise.reject(new Error(s("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."})))}else return Promise.reject(new Error(s("role.permissionRequired",{defaultValue:"Please select at least one permission."})));return Promise.resolve()}}],children:e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",border:"1px solid #d9d9d9",borderRadius:"4px"},children:[e.jsxRuntimeExports.jsxs("span",{className:r.rolePermissionExtra,children:[e.jsxRuntimeExports.jsx(o.Button,{type:"link",onClick:de,icon:e.jsxRuntimeExports.jsx(y.DownOutlined,{}),children:h("expandAll",{defaultValue:"Expand All"})}),e.jsxRuntimeExports.jsx(o.Button,{type:"link",onClick:ce,icon:e.jsxRuntimeExports.jsx(y.UpOutlined,{}),children:h("collapseAll",{defaultValue:"Collapse All"})})]}),e.jsxRuntimeExports.jsx(o.Tree,{treeData:re,titleRender:l=>{const t=l,i=typeof t.title=="string"?t.title:String(t.title??"");return e.jsxRuntimeExports.jsx("span",{children:s(`permission.title.${t.code}`,{defaultValue:i})})},checkable:!0,disabled:k,expandedKeys:Z,autoExpandParent:ee,onExpand:ue,checkedKeys:P,onCheck:l=>{let t=[];K.isArray(l)?t=l:K.has(l,"checked")&&(t=l.checked),T(t),p.setFieldsValue({permissions:t})}})]})})})},{key:"ai-tools",label:s("role.aiPermissions",{defaultValue:"AI Tool Permissions"}),disabled:g==="global",children:e.jsxRuntimeExports.jsx(o.Spin,{spinning:te,children:g==="organization"?C.length>0?e.jsxRuntimeExports.jsx(o.Space,{direction:"vertical",size:"middle",style:{width:"100%"},children:C.map(l=>{const t=(l.tools||[]).map(x=>x.name),i=A[l.id]||[],m=t.length>0&&i.length===t.length,u=i.length>0&&i.length<t.length;return e.jsxRuntimeExports.jsx(o.Card,{size:"small",title:e.jsxRuntimeExports.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsxRuntimeExports.jsx(o.Checkbox,{checked:m,indeterminate:u,onChange:x=>xe(l.id,x.target.checked)}),e.jsxRuntimeExports.jsx("span",{children:l.name})]}),extra:l.description?e.jsxRuntimeExports.jsx("span",{children:l.description}):void 0,children:(l.tools||[]).length>0?e.jsxRuntimeExports.jsx(o.Checkbox.Group,{style:{width:"100%"},value:A[l.id]||[],onChange:x=>me(l.id,x),children:e.jsxRuntimeExports.jsx(o.Space,{direction:"vertical",style:{width:"100%"},children:(l.tools||[]).map(x=>e.jsxRuntimeExports.jsx(o.Checkbox,{value:x.name,children:e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx("div",{children:x.name}),x.description&&e.jsxRuntimeExports.jsx("div",{style:{color:"rgba(0,0,0,0.45)",fontSize:12},children:x.description})]})},x.name))})}):e.jsxRuntimeExports.jsx(o.Empty,{image:o.Empty.PRESENTED_IMAGE_SIMPLE,description:s("role.aiToolsetNoTools",{defaultValue:"No tools available in this toolset."})})},l.id)})}):e.jsxRuntimeExports.jsx(o.Empty,{image:o.Empty.PRESENTED_IMAGE_SIMPLE,description:s("role.aiToolsetsEmpty",{defaultValue:"No AI toolsets available for this organization."})}):e.jsxRuntimeExports.jsx(o.Empty,{image:o.Empty.PRESENTED_IMAGE_SIMPLE,description:s("role.aiPermissionsGlobalInfo",{defaultValue:"AI tool permissions are only available for organization roles."})})})},{key:"policy",label:s("role.policyDocument",{defaultValue:"Policy Document"}),disabled:g==="organization",children:e.jsxRuntimeExports.jsx(o.Form.Item,{name:"policy_document",rules:[{validator:pe}],extra:e.jsxRuntimeExports.jsx("span",{className:r.rolePolicyExtra,children:e.jsxRuntimeExports.jsx(o.Select,{style:{width:160},placeholder:s("role.insertTemplate",{defaultValue:"Insert Template"}),options:[{label:s("role.allowAll",{defaultValue:"Allow All"}),value:"allow_all"},{label:s("role.denyAll",{defaultValue:"Deny All"}),value:"deny_all"},{label:s("role.allowWithAction",{defaultValue:"Allow with Action"}),value:"allow_with_action"},{label:s("role.denyWithCondition",{defaultValue:"Allow with Condition"}),value:"allow_with_condition"},{label:s("role.allowWithUri",{defaultValue:"Allow with URI"}),value:"allow_with_uri"}],onChange:l=>{if(typeof l=="string"){const t=be[l];t&&p.setFieldValue("policy_document",JSON.stringify(t,null,2))}}})}),children:e.jsxRuntimeExports.jsx(X,{rows:15,style:{fontFamily:"monospace"},placeholder:`{
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "account:EnableRegion",
                "account:DisableRegion"
            ],
            "Condition": {
                "StringEquals": {"id:": "abcdef"}
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "*"
            ]
        }
    ]
}`})})}]}),e.jsxRuntimeExports.jsx(o.Form.Item,{children:e.jsxRuntimeExports.jsxs(o.Space,{children:[e.jsxRuntimeExports.jsx(o.Button,{type:"primary",htmlType:"submit",loading:se,children:f?h("update",{defaultValue:"Update"}):h("create",{defaultValue:"Create"})}),e.jsxRuntimeExports.jsx(o.Button,{onClick:()=>R("/authorization/roles"),children:h("cancel",{defaultValue:"Cancel"})})]})})]})]})},_e=Object.freeze(Object.defineProperty({__proto__:null,default:Se},Symbol.toStringTag,{value:"Module"}));exports.RoleForm=_e;exports.RoleList=Re;
