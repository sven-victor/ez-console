"use strict";const e=require("./vendor.js"),r=require("react"),o=require("antd"),g=require("@ant-design/icons"),w=require("./components.js"),_=require("./index.js"),T=require("react-i18next"),N=require("./contexts.js"),L=require("react-router-dom"),W=require("lodash"),xe=require("antd-style"),pe=()=>{const{t:d}=T.useTranslation("authorization"),{t:i}=T.useTranslation("common"),{siteConfig:x}=N.useSite(),R=L.useNavigate(),p=r.useRef(null),f=u=>{R(`/authorization/roles/${u}/edit`)},b=async u=>{var a,n;try{await _.api.authorization.deleteRole({id:u}),o.message.success(d("role.deleteSuccess",{defaultValue:"Role deleted successfully."})),(n=(a=p.current)==null?void 0:a.reload)==null||n.call(a)}catch(S){o.message.error(d("role.deleteError",{defaultValue:"Failed to delete role: {{error}}",error:S}))}},C=[{title:d("role.name",{defaultValue:"Role Name"}),dataIndex:"name",key:"name",render:u=>e.jsxRuntimeExports.jsxs(o.Space,{children:[e.jsxRuntimeExports.jsx(g.UserOutlined,{}),u]})},{title:d("role.description",{defaultValue:"Description"}),dataIndex:"description",key:"description"},{title:d("role.organization",{defaultValue:"Organization"}),key:"organization",hidden:!(x!=null&&x.enable_multi_org),render:(u,a)=>{var n;return a.organization_id?e.jsxRuntimeExports.jsx(o.Tag,{icon:e.jsxRuntimeExports.jsx(g.TeamOutlined,{}),color:"blue",children:((n=a.organization)==null?void 0:n.name)||a.organization_id}):e.jsxRuntimeExports.jsx(o.Tag,{color:"default",children:d("role.global",{defaultValue:"Global"})})}},{title:d("role.permissionCount",{defaultValue:"Permissions"}),key:"permission_count",render:(u,a)=>{var n;return e.jsxRuntimeExports.jsxs(o.Tag,{color:"blue",children:[e.jsxRuntimeExports.jsx(g.LockOutlined,{})," ",((n=a.permissions)==null?void 0:n.length)||0]})}},{title:d("role.createdAt",{defaultValue:"Created At"}),dataIndex:"created_at",key:"created_at",render:u=>new Date(u).toLocaleString()},{title:i("actions",{defaultValue:"Actions"}),key:"action",render:(u,a)=>e.jsxRuntimeExports.jsxs(o.Space,{size:"small",children:[e.jsxRuntimeExports.jsx(w.PermissionGuard,{permission:"authorization:role:update",children:e.jsxRuntimeExports.jsx(o.Tooltip,{title:d("role.edit",{defaultValue:"Edit Role"}),children:e.jsxRuntimeExports.jsx(o.Button,{type:"text",size:"small",icon:e.jsxRuntimeExports.jsx(g.EditOutlined,{}),onClick:()=>f(a.id)})})}),e.jsxRuntimeExports.jsx(w.PermissionGuard,{permission:"authorization:role:delete",children:e.jsxRuntimeExports.jsx(o.Tooltip,{title:d("role.delete",{defaultValue:"Delete Role"}),children:e.jsxRuntimeExports.jsx(o.Popconfirm,{title:d("role.deleteConfirm",{defaultValue:"Are you sure you want to delete this role?"}),onConfirm:()=>b(a.id),okText:i("confirm",{defaultValue:"Confirm"}),cancelText:i("cancel",{defaultValue:"Cancel"}),children:e.jsxRuntimeExports.jsx(o.Button,{type:"text",size:"small",danger:!0,icon:e.jsxRuntimeExports.jsx(g.DeleteOutlined,{})})})})})]})}];return e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsxs(o.Card,{style:{marginBottom:16},children:[e.jsxRuntimeExports.jsx("div",{style:{marginBottom:16},children:e.jsxRuntimeExports.jsxs(o.Row,{justify:"space-between",align:"middle",gutter:16,children:[e.jsxRuntimeExports.jsx(o.Col,{children:e.jsxRuntimeExports.jsx(o.Space,{children:e.jsxRuntimeExports.jsx(o.Button,{type:"primary",onClick:()=>{var u,a;(a=(u=p.current)==null?void 0:u.reload)==null||a.call(u)},icon:e.jsxRuntimeExports.jsx(g.ReloadOutlined,{}),children:i("refresh",{defaultValue:"Refresh"})})})}),e.jsxRuntimeExports.jsx(o.Col,{children:e.jsxRuntimeExports.jsx(w.PermissionGuard,{permission:"authorization:role:create",children:e.jsxRuntimeExports.jsx(o.Button,{type:"primary",icon:e.jsxRuntimeExports.jsx(g.PlusOutlined,{}),onClick:()=>R("/authorization/roles/create"),children:d("role.create",{defaultValue:"Create Role"})})})})]})}),e.jsxRuntimeExports.jsx(w.Table,{request:async({page_size:u,current:a})=>_.api.authorization.listRoles({current:a,page_size:u}),columns:C,actionRef:p})]})})},fe=Object.freeze(Object.defineProperty({__proto__:null,default:pe},Symbol.toStringTag,{value:"Module"})),{TextArea:H}=o.Input,he=xe.createStyles(({css:d})=>({rolePermissionExtra:d`
      float: right;
      z-index: 1001;
      position: sticky;
    `,rolePolicyExtra:d`
      position: absolute;
      right: 5px;
      top: 5px;
    `})),je={allow_all:{policy:{Statement:[{Effect:"Allow",Action:["*"]}]}},deny_all:{Statement:[{Effect:"Deny",Action:["*"]}]},allow_with_action:{Statement:[{Effect:"Allow",Action:["authorization:user:view"]}]},allow_with_condition:{Statement:[{Effect:"Allow",Action:["authorization:user:update"],Condition:{StringEquals:{"id:":"abcdef"}}},{Effect:"Deny",Action:["*"]}]},allow_with_uri:{Statement:[{Effect:"Allow",Action:["authorization:user:view"],Condition:{StringEquals:{"http.uri":"/api/users/abcdef","http.method":"GET"}}},{Effect:"Deny",Action:["*"]}]}},K=JSON.stringify({Statement:[]},null,2),ge=()=>{const{styles:d}=he(),{t:i}=T.useTranslation("authorization"),{t:x}=T.useTranslation("common"),R=L.useNavigate(),{id:p}=L.useParams(),f=!!p,{enableMultiOrg:b,currentOrgId:C}=N.useSite(),{user:u}=N.useAuth(),a=(u==null?void 0:u.organizations)||[],[n]=o.Form.useForm(),[S,v]=r.useState([]),[A,X]=r.useState([]),[Y,I]=r.useState([]),[Q,O]=r.useState(!0),[G,E]=r.useState([]),[P,j]=r.useState({}),k=r.useRef({}),[Z,B]=r.useState(!1),[h,F]=r.useState("global"),[q,ee]=r.useState(void 0),[te,M]=r.useState(!1),[oe,J]=r.useState(!1);r.useEffect(()=>{k.current=P},[P]),r.useEffect(()=>{ee(C||void 0)},[]);const U=r.useCallback(async()=>{try{const l=await _.api.authorization.listPermissions();X(l.map((t,s)=>{const c=(t.permissions||[]).map(m=>({key:m.id,code:m.code.replace(/:/g,"."),title:m.name,orgPermission:m.org_permission||!1}));return{key:`[group]-${s}`,title:t.name,code:t.name.replace(/ /g,"_"),children:c}}))}catch{o.message.error(i("role.loadError",{defaultValue:"Failed to load role list"}))}},[i]);r.useEffect(()=>{U()},[U]);const V=r.useCallback(async(l,t)=>{if(!l){E([]),j(t||{});return}B(!0);try{const c=((await _.api.system.listToolSets({page_size:1e3,include_tools:!0},{headers:{"X-Scope-OrgID":l}})).data||[]).filter(y=>y.status==="enabled");E(c);const m=t||k.current||{},z={};c.forEach(y=>{const D=m[y.id]||[];z[y.id]=D.filter(ce=>(y.tools||[]).some(me=>me.name===ce))}),j(z)}catch{o.message.error(i("role.loadAiToolsetsError",{defaultValue:"Failed to load AI toolsets."})),E([]),j(t||{})}finally{B(!1)}},[i]),le=l=>l?l.reduce((t,s)=>(!s.toolset_id||!s.tool_name||(t[s.toolset_id]||(t[s.toolset_id]=[]),t[s.toolset_id].includes(s.tool_name)||t[s.toolset_id].push(s.tool_name)),t),{}):{},$=r.useCallback(async l=>{var t;M(!0);try{const s=await _.api.authorization.getRole({id:l}),c=((t=s.permissions)==null?void 0:t.map(D=>D.id))||[];v(c),n.setFieldsValue({permissions:c});const m=s.organization_id||"",z=m?"organization":"global";F(z);const y=le(s.ai_tool_permissions);z==="organization"&&m?await V(m,y):(E([]),j({})),n.setFieldsValue({name:s.name,description:s.description,role_type:z,organization_id:m||void 0,policy_document:JSON.stringify(s.policy_document||{Statement:[]},null,2)})}catch{o.message.error(i("role.detailLoadError",{defaultValue:"Failed to load role details"})),R("/authorization/roles")}finally{M(!1)}},[V,n,R,i]);r.useEffect(()=>{if(f&&p){$(p);return}const l=q||(a.length>0?a[0].id:""),t=b&&l?"organization":"global";F(t),n.setFieldsValue({role_type:t,organization_id:t==="organization"?l:void 0,policy_document:K,permissions:[]}),v([]),j({}),t==="organization"&&l?V(l,{}):E([])},[V,n,p,f,a,q,b,$]);const ie=r.useMemo(()=>h==="global"?A:A.map(t=>{const s=(t.children||[]).filter(c=>c.orgPermission===!0);return{...t,children:s}}).filter(t=>t.children&&t.children.length>0),[A,h]),se=l=>{I(l),O(!1)},ae=()=>{const l=A.map(t=>t.key);I(l),O(!0)},ne=()=>{I([]),O(!1)},re=r.useCallback((l,t)=>{j(s=>({...s,[l]:t}))},[]),ue=(l,t)=>{if(h==="organization")return Promise.resolve();if(!t||t.trim()===""||t==="{}"||t==='{"Statement":[]}')return S.length===0?Promise.reject(new Error(i("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."}))):Promise.resolve();try{return JSON.parse(t),Promise.resolve()}catch{return Promise.reject(new Error(i("role.invalidJsonFormat",{defaultValue:"Invalid JSON format."})))}},de=async l=>{const t={...l};try{h==="global"?t.policy_document=JSON.parse(l.policy_document??"{}"):t.policy_document={Statement:[]},t.role_type==="organization"?t.organization_id=t.organization_id||void 0:t.organization_id=void 0,delete t.role_type;const s=h==="organization"?Object.entries(P).map(([c,m])=>({toolset_id:c,tools:Array.from(new Set(m))})).filter(c=>c.tools.length>0):[];t.ai_tool_permissions=s,t.permissions=S.filter(c=>!c.startsWith("[group]-")),J(!0),f&&p?(await _.api.authorization.updateRole({id:p},t),o.message.success(i("role.updateSuccess",{defaultValue:"Role updated successfully."}))):(await _.api.authorization.createRole(t),o.message.success(i("role.createSuccess",{defaultValue:"Role created successfully."}))),R("/authorization/roles")}catch{o.message.error(i("role.saveError",{defaultValue:"Failed to save role.",action:f?x("update",{defaultValue:"Update"}):x("create",{defaultValue:"Create"})}))}finally{J(!1)}};return e.jsxRuntimeExports.jsx(o.Card,{title:f?i("role.editTitle",{defaultValue:"Edit Role"}):i("role.createTitle",{defaultValue:"Create Role"}),loading:te,children:e.jsxRuntimeExports.jsxs(o.Form,{form:n,layout:"vertical",initialValues:{policy_document:K,permissions:[]},onFinish:de,children:[e.jsxRuntimeExports.jsx(o.Tabs,{items:[{key:"basic",label:i("role.basicInfo",{defaultValue:"Basic Information"}),children:e.jsxRuntimeExports.jsxs(e.jsxRuntimeExports.Fragment,{children:[e.jsxRuntimeExports.jsx(o.Form.Item,{label:i("role.name",{defaultValue:"Role Name"}),name:"name",rules:[{required:!0,message:i("role.nameRequired",{defaultValue:"Please enter the role name."})}],children:e.jsxRuntimeExports.jsx(o.Input,{placeholder:i("role.namePlaceholder",{defaultValue:"Enter role name"})})}),e.jsxRuntimeExports.jsx(o.Form.Item,{label:i("role.description",{defaultValue:"Description"}),name:"description",children:e.jsxRuntimeExports.jsx(H,{rows:4,placeholder:i("role.descriptionPlaceholder",{defaultValue:"Enter role description"})})}),e.jsxRuntimeExports.jsx(o.Form.Item,{label:i("role.roleType",{defaultValue:"Role Type"}),name:"role_type",hidden:!b,rules:[{required:!0,message:i("role.roleTypeRequired",{defaultValue:"Please select role type."})}],extra:f?i("role.roleTypeCannotChange",{defaultValue:"Role type cannot be changed after creation."}):"",children:e.jsxRuntimeExports.jsxs(o.Radio.Group,{disabled:f,onChange:l=>{const t=l.target.value;if(F(t),t==="global")n.setFieldsValue({organization_id:void 0}),E([]),j({});else{const s=q||(a.length>0?a[0].id:"");n.setFieldsValue({organization_id:s}),s?V(s,k.current):(E([]),j({}))}v([]),n.setFieldsValue({permissions:[]})},children:[e.jsxRuntimeExports.jsx(o.Radio,{value:"global",children:i("role.globalRole",{defaultValue:"Global Role"})}),e.jsxRuntimeExports.jsx(o.Radio,{value:"organization",children:i("role.organizationRole",{defaultValue:"Organization Role"})})]})}),h==="organization"&&e.jsxRuntimeExports.jsx(o.Form.Item,{hidden:!b,label:i("role.organization",{defaultValue:"Organization"}),name:"organization_id",rules:[{required:!0,message:i("role.organizationRequired",{defaultValue:"Please select an organization."})}],extra:a.length>0?i("role.organizationHelp",{defaultValue:"Select the organization this role belongs to"}):i("role.noOrganizationsAvailable",{defaultValue:"No organizations available. Please contact your administrator."}),children:a.length>0?e.jsxRuntimeExports.jsx(o.Select,{placeholder:i("role.selectOrganization",{defaultValue:"Select Organization"}),onChange:l=>{v([]),n.setFieldsValue({permissions:[]});const t=l||"";t?V(t,{}):(E([]),j({}))},children:a.map(l=>e.jsxRuntimeExports.jsx(o.Select.Option,{value:l.id,children:l.name},l.id))}):e.jsxRuntimeExports.jsx(o.Select,{disabled:!0,placeholder:i("role.noOrganizationsAvailable",{defaultValue:"No organizations available"})})})]})},{key:"permissions",label:i("role.permissions",{defaultValue:"Permissions"}),children:e.jsxRuntimeExports.jsx(o.Form.Item,{name:"permissions",rules:[{validator(){if(S.length===0)if(h==="global"){const l=n.getFieldValue("policy_document");if(!l||l.trim()===""||l==="{}"||l==='{"Statement":[]}')return Promise.reject(new Error(i("role.permissionOrPolicyRequired",{defaultValue:"Please select at least one permission or provide a policy document."})))}else return Promise.reject(new Error(i("role.permissionRequired",{defaultValue:"Please select at least one permission."})));return Promise.resolve()}}],children:e.jsxRuntimeExports.jsx("div",{children:e.jsxRuntimeExports.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",border:"1px solid #d9d9d9",borderRadius:"4px"},children:[e.jsxRuntimeExports.jsxs("span",{className:d.rolePermissionExtra,children:[e.jsxRuntimeExports.jsx(o.Button,{type:"link",onClick:ae,icon:e.jsxRuntimeExports.jsx(g.DownOutlined,{}),children:x("expandAll",{defaultValue:"Expand All"})}),e.jsxRuntimeExports.jsx(o.Button,{type:"link",onClick:ne,icon:e.jsxRuntimeExports.jsx(g.UpOutlined,{}),children:x("collapseAll",{defaultValue:"Collapse All"})})]}),e.jsxRuntimeExports.jsx(o.Tree,{treeData:ie,titleRender:l=>{const t=l,s=typeof t.title=="string"?t.title:String(t.title??"");return e.jsxRuntimeExports.jsx("span",{children:i(`permission.title.${t.code}`,{defaultValue:s})})},checkable:!0,expandedKeys:Y,autoExpandParent:Q,onExpand:se,checkedKeys:S,onCheck:l=>{let t=[];W.isArray(l)?t=l:W.has(l,"checked")&&(t=l.checked),v(t),n.setFieldsValue({permissions:t})}})]})})})},{key:"ai-tools",label:i("role.aiPermissions",{defaultValue:"AI Tool Permissions"}),disabled:h==="global",children:e.jsxRuntimeExports.jsx(o.Spin,{spinning:Z,children:h==="organization"?G.length>0?e.jsxRuntimeExports.jsx(o.Space,{direction:"vertical",size:"middle",style:{width:"100%"},children:G.map(l=>e.jsxRuntimeExports.jsx(o.Card,{size:"small",title:l.name,extra:l.description?e.jsxRuntimeExports.jsx("span",{children:l.description}):void 0,children:(l.tools||[]).length>0?e.jsxRuntimeExports.jsx(o.Checkbox.Group,{style:{width:"100%"},value:P[l.id]||[],onChange:t=>re(l.id,t),children:e.jsxRuntimeExports.jsx(o.Space,{direction:"vertical",style:{width:"100%"},children:(l.tools||[]).map(t=>e.jsxRuntimeExports.jsx(o.Checkbox,{value:t.name,children:e.jsxRuntimeExports.jsxs("div",{children:[e.jsxRuntimeExports.jsx("div",{children:t.name}),t.description&&e.jsxRuntimeExports.jsx("div",{style:{color:"rgba(0,0,0,0.45)",fontSize:12},children:t.description})]})},t.name))})}):e.jsxRuntimeExports.jsx(o.Empty,{image:o.Empty.PRESENTED_IMAGE_SIMPLE,description:i("role.aiToolsetNoTools",{defaultValue:"No tools available in this toolset."})})},l.id))}):e.jsxRuntimeExports.jsx(o.Empty,{image:o.Empty.PRESENTED_IMAGE_SIMPLE,description:i("role.aiToolsetsEmpty",{defaultValue:"No AI toolsets available for this organization."})}):e.jsxRuntimeExports.jsx(o.Empty,{image:o.Empty.PRESENTED_IMAGE_SIMPLE,description:i("role.aiPermissionsGlobalInfo",{defaultValue:"AI tool permissions are only available for organization roles."})})})},{key:"policy",label:i("role.policyDocument",{defaultValue:"Policy Document"}),disabled:h==="organization",children:e.jsxRuntimeExports.jsx(o.Form.Item,{name:"policy_document",rules:[{validator:ue}],extra:e.jsxRuntimeExports.jsx("span",{className:d.rolePolicyExtra,children:e.jsxRuntimeExports.jsx(o.Select,{style:{width:160},placeholder:i("role.insertTemplate",{defaultValue:"Insert Template"}),options:[{label:i("role.allowAll",{defaultValue:"Allow All"}),value:"allow_all"},{label:i("role.denyAll",{defaultValue:"Deny All"}),value:"deny_all"},{label:i("role.allowWithAction",{defaultValue:"Allow with Action"}),value:"allow_with_action"},{label:i("role.denyWithCondition",{defaultValue:"Allow with Condition"}),value:"allow_with_condition"},{label:i("role.allowWithUri",{defaultValue:"Allow with URI"}),value:"allow_with_uri"}],onChange:l=>{if(typeof l=="string"){const t=je[l];t&&n.setFieldValue("policy_document",JSON.stringify(t,null,2))}}})}),children:e.jsxRuntimeExports.jsx(H,{rows:15,style:{fontFamily:"monospace"},placeholder:`{
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "account:EnableRegion",
                "account:DisableRegion"
            ],
            "Condition": {
                "StringEquals": {"id:": "abcdef"}
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "*"
            ]
        }
    ]
}`})})}]}),e.jsxRuntimeExports.jsx(o.Form.Item,{children:e.jsxRuntimeExports.jsxs(o.Space,{children:[e.jsxRuntimeExports.jsx(o.Button,{type:"primary",htmlType:"submit",loading:oe,children:f?x("update",{defaultValue:"Update"}):x("create",{defaultValue:"Create"})}),e.jsxRuntimeExports.jsx(o.Button,{onClick:()=>R("/authorization/roles"),children:x("cancel",{defaultValue:"Cancel"})})]})})]})})},Ee=Object.freeze(Object.defineProperty({__proto__:null,default:ge},Symbol.toStringTag,{value:"Module"}));exports.RoleForm=Ee;exports.RoleList=fe;
